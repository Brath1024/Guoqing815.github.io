<!doctype html>
<html lang="zh"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta><title>Brath-Blog</title><link rel="manifest" href="/manifest.json"><meta name="application-name" content="Brath-Blog"><meta name="msapplication-TileImage" content="https://brath.cloud/me.png"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="Brath-Blog"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta property="og:type" content="blog"><meta property="og:title" content="Brath-Blog"><meta property="og:url" content="http://example.com/"><meta property="og:site_name" content="Brath-Blog"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="http://example.com/img/og_image.png"><meta property="article:author" content="Brath"><meta property="twitter:card" content="summary"><meta property="twitter:image:src" content="http://example.com/img/og_image.png"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"http://example.com"},"headline":"Brath-Blog","image":["http://example.com/img/og_image.png"],"author":{"@type":"Person","name":"Brath"},"publisher":{"@type":"Organization","name":"Brath-Blog","logo":{"@type":"ImageObject","url":"https://brath.cloud/me.png"}},"description":""}</script><link rel="icon" href="https://brath.cloud/me.png"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v6.0.0/css/all.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/atom-one-light.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><!--!--><!--!--><script src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" defer></script><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/css/justifiedGallery.min.css"><!--!--><!--!--><style>.pace{-webkit-pointer-events:none;pointer-events:none;-webkit-user-select:none;-moz-user-select:none;user-select:none}.pace-inactive{display:none}.pace .pace-progress{background:#3273dc;position:fixed;z-index:2000;top:0;right:100%;width:100%;height:2px}</style><script src="https://cdn.jsdelivr.net/npm/pace-js@1.2.4/pace.min.js"></script><!--!--><!--!--><!-- hexo injector head_end start --><script>
  (function () {
      function switchTab() {
          if (!location.hash) {
            return;
          }

          const id = '#' + CSS.escape(location.hash.substring(1));
          const $tabMenu = document.querySelector(`.tabs a[href="${id}"]`);
          if (!$tabMenu) {
            return;
          }

          const $tabMenuContainer = $tabMenu.parentElement.parentElement;
          Array.from($tabMenuContainer.children).forEach($menu => $menu.classList.remove('is-active'));
          Array.from($tabMenuContainer.querySelectorAll('a'))
              .map($menu => document.getElementById($menu.getAttribute("href").substring(1)))
              .forEach($content => $content.classList.add('is-hidden'));

          if ($tabMenu) {
              $tabMenu.parentElement.classList.add('is-active');
          }
          const $activeTab = document.querySelector(id);
          if ($activeTab) {
              $activeTab.classList.remove('is-hidden');
          }
      }
      switchTab();
      window.addEventListener('hashchange', switchTab, false);
  })();
  </script><!-- hexo injector head_end end --><meta name="generator" content="Hexo 6.3.0"></head><body class="is-3-column"><nav class="navbar navbar-main"><div class="container navbar-container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="https://brath.cloud/me.png" alt="Brath-Blog" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">主页</a><a class="navbar-item" href="/archives">文章列表</a><a class="navbar-item" href="/tags">标签</a><a class="navbar-item" href="/about">更多</a></div><div class="navbar-end"><a class="navbar-item" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/Guoqing815"><i class="fab fa-github"></i></a><a class="navbar-item search" title="搜索" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-6-widescreen"><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2020-12-18T23:25:31.000Z" title="2020/12/19 07:25:31">2020-12-19</time>发表</span><span class="level-item"><time dateTime="2023-03-06T00:33:09.000Z" title="2023/3/6 08:33:09">2023-03-06</time>更新</span><span class="level-item">12 分钟读完 (大约1779个字)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2020/12/19/%E3%80%90Nginx%E3%80%91Nginx%E4%BB%A5%E5%8F%8Akeepalived%E5%AE%89%E8%A3%85%E4%BB%A5%E5%8F%8A%E9%83%A8%E7%BD%B2/">Nginx以及Keepalived安装以及部署</a></p><div class="content"><p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/%E6%89%AB%E7%A0%81_%E6%90%9C%E7%B4%A2%E8%81%94%E5%90%88%E4%BC%A0%E6%92%AD%E6%A0%B7%E5%BC%8F-%E6%A0%87%E5%87%86%E8%89%B2%E7%89%88.png" alt="InterviewCoder"></p>
<p>​		反向代理：指的是用户要访问 youtube, 但是 youtube 悄悄地把这个请求交给后台 N 台服务器中的其中一台来做，这种方式就是反向代理了。</p>
<p>​		负载均衡：</p>
<p>1) 使用硬件负载均衡策略，如使用 F5,Array 等负载均衡器.</p>
<p>2) 使用软件进行负载均衡<br>
 3) 如使用阿里云服务器均衡 SLB<br>
4) 使用我们今天所学习的 Nginx+Keepalived<br>
5) 其他软件负载均衡如 LVS (Linux Virtual Server),haproxy 等技术</p>
<h3 id="环境搭建"><a class="markdownIt-Anchor" href="#环境搭建">#</a> 环境搭建：</h3>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">步骤:</span><br><span class="line"><span class="number">1.</span>进行安装:tar -zxvf /root/software/nginx-<span class="number">1.6</span><span class="number">.2</span>.tar.gz -C /usr/local/</span><br><span class="line"><span class="number">2.</span>下载所需要的依赖库文件:</span><br><span class="line">   yum install pcre -y</span><br><span class="line">   yum install pcre-devel -y</span><br><span class="line">   yum install zlib -y</span><br><span class="line">   yum install zlib-devel -y</span><br><span class="line"><span class="number">3.</span>进行configure配置,查看是否报错</span><br><span class="line">   cd nginx-<span class="number">1.6</span><span class="number">.2</span></span><br><span class="line">   ./configure --prefix=/usr/local/nginx</span><br><span class="line"><span class="number">4.</span>编译安装:make &amp;&amp; make install</span><br><span class="line"><span class="number">5.</span>在 /usr/local/nginx目录下,可以看到如下<span class="number">4</span>个目录</span><br><span class="line">   conf配置文件,html网页文件,logs日志文件,sbin主要二进制程序</span><br><span class="line"><span class="number">6.</span>启动命令:/usr/local/nginx/sbin/nginx</span><br><span class="line">  关闭命令:/usr/local/nginx/sbin/nginx -s stop</span><br><span class="line">  重启命令:/usr/local/nginx/sbin/nginx -s reload</span><br><span class="line"><span class="number">7.</span>访问浏览器:http:<span class="comment">//192.168.122.133(看到欢迎页面说明没问题)</span></span><br><span class="line"></span><br><span class="line">注意:如果出现这个错误:./configure: error: C compiler cc is not found</span><br><span class="line">执行这个命令:yum -y install gcc gcc-c++ autoconf automake make</span><br></pre></td></tr></table></figure>
<p>Keepalived：</p>
<p>首先介绍一下 Keepalived, 它是一个高性能的服务器高可用或热备解决方案，Keepalived 主要防止服务器单点故障的问题，可以通过其与 Nginx 的配合实现 web 服务器端的高可用.<br>
Keepalived 以 VRRP 协议为实现基础，使用 VRRP 协议来实现高可用性 (HA).VRRP (Virtual Router Redundacy Protocol) 协议用于实现路由器冗余的协议，VRRP 协议将两台或多台路由器设备虚拟成一个设备，向外提供虚拟路由 IP (一个或多个)。</p>
<p>安装以及部署：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">第一步：安装keepalived依赖的包</span><br><span class="line">	yum install -y gcc</span><br><span class="line">    yum install -y openssl-devel</span><br><span class="line">	yum install -y libnl3-devel</span><br><span class="line">	yum install -y popt-devel</span><br><span class="line">	yum install -y iptables-devel</span><br><span class="line">	yum install -y libnfnetlink-devel</span><br><span class="line">	yum install -y psmisc</span><br><span class="line">第二步：编译安装keepalived</span><br><span class="line">	将keepalived的安装包 上传到/usr/local/software 目录下  </span><br><span class="line">	cd /usr/local/software</span><br><span class="line">	tar -zxvf keepalived-<span class="number">1.2</span><span class="number">.19</span>.tar.gz -C /usr/local  </span><br><span class="line">	cd /usr/local/keepalived-<span class="number">1.2</span><span class="number">.19</span>  </span><br><span class="line">	./configure --prefix=/usr/local/keepalived  </span><br><span class="line">	make &amp;&amp; make install </span><br><span class="line">第三步：将 keepalived 安装成 Linux 系统服务</span><br><span class="line">	安装完成之后， 需要做一些工作复制默认配置文件到 默认路径  </span><br><span class="line">	mkdir /etc/keepalived  </span><br><span class="line">	cp /usr/local/keepalived/etc/keepalived/keepalived.conf /etc/keepalived/  </span><br><span class="line">	cp /usr/local/keepalived/sbin/keepalived /usr/sbin/  </span><br><span class="line">	cp /usr/local/keepalived/etc/sysconfig/keepalived /etc/sysconfig/  </span><br><span class="line">	cd /usr/local/keepalived-<span class="number">1.2</span><span class="number">.19</span>  </span><br><span class="line">	cp ./keepalived/etc/init.d/keepalived.init /etc/init.d/</span><br><span class="line">	chmod <span class="number">755</span> /etc/init.d/keepalived.init </span><br><span class="line">第四步：编写nginx检测脚本:</span><br><span class="line">vi /etc/keepalived/nginx_check.sh</span><br><span class="line">内容如下：  </span><br><span class="line">#!/bin/bash  </span><br><span class="line">A=`ps -C nginx –no-header |wc -l`  </span><br><span class="line"><span class="keyword">if</span> [ $A -eq <span class="number">0</span> ];then  </span><br><span class="line">    /usr/local/nginx/sbin/nginx  </span><br><span class="line">    sleep <span class="number">2</span>  </span><br><span class="line">    <span class="keyword">if</span> [ `ps -C nginx --no-header |wc -l` -eq <span class="number">0</span> ];then  </span><br><span class="line">        killall keepalived  </span><br><span class="line">    fi  </span><br><span class="line">fi  </span><br><span class="line">赋予执行权限  </span><br><span class="line">chmod +x /etc/keepalived/nginx_check.sh </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">启动命令:</span><br><span class="line">  keepalived</span><br></pre></td></tr></table></figure>
<p>修改 Master 配置</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">修改keepalived的Master配置文件:vi /etc/keepalived/keepalived.conf </span><br><span class="line">! Configuration File <span class="keyword">for</span> keepalived       </span><br><span class="line">global_defs &#123;      </span><br><span class="line">   router_id wolfcode                           ##路由器标志    </span><br><span class="line">&#125;    </span><br><span class="line"># 集群资源监控，组合track_script进行    </span><br><span class="line">vrrp_script check_haproxy &#123;    </span><br><span class="line">	script <span class="string">&quot;/etc/keepalived/nginx_check.sh&quot;</span>  #检测 nginx 状态的脚本路径  </span><br><span class="line">	interval <span class="number">2</span>  #检测时间间隔  </span><br><span class="line">	weight -<span class="number">20</span>  #条件成立 权重减<span class="number">20</span>  </span><br><span class="line">&#125;    </span><br><span class="line">vrrp_instance PROXY &#123;    </span><br><span class="line">	# 设置当前主机为主节点，如果是备用节点，则设置为BACKUP   </span><br><span class="line">	state MASTER</span><br><span class="line">	# 指定HA监测网络接口，可以用ifconfig查看来决定设置哪一个    </span><br><span class="line">	<span class="keyword">interface</span> <span class="title class_">ens32</span></span><br><span class="line">	# 虚拟路由标识，同一个VRRP实例要使用同一个标识，主备机    </span><br><span class="line">	virtual_router_id <span class="number">80</span>    </span><br><span class="line">	# 因为当前环境中VRRP组播有问题，改为使用单播发送VRRP报文  如果VRRP组播没问题，以下这块的内容可以注释掉。  </span><br><span class="line">	# 这个地方需要关注，之前未做此设置，结果主备节点互相不能发现，因此主备节点都升级成了MASTER，并且绑定了VIP    </span><br><span class="line">	# 主节点时，内容为：    </span><br><span class="line">	unicast_src_ip <span class="number">192.168</span><span class="number">.122</span><span class="number">.133</span></span><br><span class="line">	# 设置优先级，确保主节点的优先级高过备用节点  </span><br><span class="line">	priority <span class="number">100</span>    </span><br><span class="line">	# 用于设定主备节点间同步检查时间间隔    </span><br><span class="line">	advert_int <span class="number">2</span>    </span><br><span class="line">	# 设置主备节点间的通信验证类型及密码，同一个VRRP实例中需一致    </span><br><span class="line">	authentication &#123;    </span><br><span class="line">		auth_type PASS    </span><br><span class="line">		auth_pass wolfcode</span><br><span class="line">	&#125;    </span><br><span class="line">	# 集群资源监控，组合vrrp_script进行    </span><br><span class="line">	track_script &#123;    </span><br><span class="line">		check_haproxy    </span><br><span class="line">	&#125;    </span><br><span class="line">	# 设置虚拟IP地址，当keepalived状态切换为MASTER时，此IP会自动添加到系统中    </span><br><span class="line">	# 当状态切换到BACKUP时，此IP会自动从系统中删除    </span><br><span class="line">	# 可以通过命令ip add查看切换后的状态    </span><br><span class="line">	virtual_ipaddress &#123;    </span><br><span class="line">		<span class="number">192.168</span><span class="number">.122</span><span class="number">.110</span>  #虚拟ip配置完之后就用它访问    </span><br><span class="line">	&#125;    </span><br><span class="line">&#125;  </span><br></pre></td></tr></table></figure>
<p>修改 Slave 配置：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">修改keepalived的Slave配置文件:vi /etc/keepalived/keepalived.conf </span><br><span class="line">! Configuration File <span class="keyword">for</span> keepalived       </span><br><span class="line">global_defs &#123;      </span><br><span class="line">   router_id wolfcode                           ##路由器标志    </span><br><span class="line">&#125;    </span><br><span class="line"># 集群资源监控，组合track_script进行    </span><br><span class="line">vrrp_script check_haproxy &#123;    </span><br><span class="line">	script <span class="string">&quot;/etc/keepalived/nginx_check.sh&quot;</span>  #检测 nginx 状态的脚本路径  </span><br><span class="line">	interval <span class="number">2</span>  #检测时间间隔  </span><br><span class="line">	weight -<span class="number">20</span>  #条件成立 权重减<span class="number">20</span>  </span><br><span class="line">&#125;    </span><br><span class="line">vrrp_instance PROXY &#123;    </span><br><span class="line">	# 设置当前主机为主节点，如果是备用节点，则设置为BACKUP   </span><br><span class="line">	state BACKUP</span><br><span class="line">	# 指定HA监测网络接口，可以用ifconfig查看来决定设置哪一个    </span><br><span class="line">	<span class="keyword">interface</span> <span class="title class_">ens32</span></span><br><span class="line">	# 虚拟路由标识，同一个VRRP实例要使用同一个标识，主备机    </span><br><span class="line">	virtual_router_id <span class="number">80</span>    </span><br><span class="line">	# 因为当前环境中VRRP组播有问题，改为使用单播发送VRRP报文  如果VRRP组播没问题，以下这块的内容可以注释掉。  </span><br><span class="line">	# 这个地方需要关注，之前未做此设置，结果主备节点互相不能发现，因此主备节点都升级成了MASTER，并且绑定了VIP    </span><br><span class="line">	# 主节点时，内容为：    </span><br><span class="line">	unicast_src_ip <span class="number">192.168</span><span class="number">.122</span><span class="number">.134</span>  </span><br><span class="line">	# 设置优先级，确保主节点的优先级高过备用节点  </span><br><span class="line">	priority <span class="number">90</span>    </span><br><span class="line">	# 用于设定主备节点间同步检查时间间隔    </span><br><span class="line">	advert_int <span class="number">2</span>    </span><br><span class="line">	# 设置主备节点间的通信验证类型及密码，同一个VRRP实例中需一致    </span><br><span class="line">	authentication &#123;    </span><br><span class="line">		auth_type PASS    </span><br><span class="line">		auth_pass wolfcode</span><br><span class="line">	&#125;    </span><br><span class="line">	# 集群资源监控，组合vrrp_script进行    </span><br><span class="line">	track_script &#123;    </span><br><span class="line">		check_haproxy    </span><br><span class="line">	&#125;    </span><br><span class="line">	# 设置虚拟IP地址，当keepalived状态切换为MASTER时，此IP会自动添加到系统中    </span><br><span class="line">	# 当状态切换到BACKUP时，此IP会自动从系统中删除    </span><br><span class="line">	# 可以通过命令ip add查看切换后的状态    </span><br><span class="line">	virtual_ipaddress &#123;    </span><br><span class="line">		<span class="number">192.168</span><span class="number">.122</span><span class="number">.110</span>  #虚拟ip配置完之后就用它访问    </span><br><span class="line">	&#125;    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="关于我"><a class="markdownIt-Anchor" href="#关于我">#</a> 关于我</h2>
<p>Brath 是一个热爱技术的 Java 程序猿，公众号「InterviewCoder」定期分享有趣有料的精品原创文章！</p>
<p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/%E4%BA%8C%E7%BB%B4%E7%A0%81plus.png" alt="InterviewCoder"></p>
<p>非常感谢各位人才能看到这里，原创不易，文章如果有帮助可以关注、点赞、分享或评论，这都是对我的莫大支持！</p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2020-12-16T11:20:47.000Z" title="2020/12/16 19:20:47">2020-12-16</time>发表</span><span class="level-item"><time dateTime="2019-10-28T12:16:44.000Z" title="2019/10/28 20:16:44">2019-10-28</time>更新</span><span class="level-item">3 分钟读完 (大约493个字)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2020/12/16/%E3%80%90RocketMQ%E3%80%91Docker%E7%8E%AF%E5%A2%83%E4%B8%8B%E9%83%A8%E7%BD%B2RocketMQ%E4%BB%A5%E5%8F%8AConsole/">Docker环境下部署RocketMQ以及Console</a></p><div class="content"><p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/%E6%89%AB%E7%A0%81_%E6%90%9C%E7%B4%A2%E8%81%94%E5%90%88%E4%BC%A0%E6%92%AD%E6%A0%B7%E5%BC%8F-%E6%A0%87%E5%87%86%E8%89%B2%E7%89%88.png" alt="InterviewCoder"></p>
<h1 id="docker环境下部署rocketmq以及console"><a class="markdownIt-Anchor" href="#docker环境下部署rocketmq以及console">#</a> Docker 环境下部署 RocketMQ 以及 Console</h1>
<h2 id="1docker-安装rocketmq镜像"><a class="markdownIt-Anchor" href="#1docker-安装rocketmq镜像">#</a> 1.docker 安装 rocketmq 镜像</h2>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">#拉取镜像 </span><br><span class="line">docker pull foxiswho/rocketmq:server-4.7.0</span><br><span class="line">docker pull foxiswho/rocketmq:broker-4.7.0</span><br></pre></td></tr></table></figure>
<h2 id="2创建server和broker目录并在目录opt下创建brokerconf"><a class="markdownIt-Anchor" href="#2创建server和broker目录并在目录opt下创建brokerconf">#</a> 2. 创建 server 和 broker 目录，并在目录 /opt 下创建 broker.conf</h2>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">创建目录</span></span><br><span class="line">mkdir /opt/rocketmq-server</span><br><span class="line">mkdir /opt/rocketmq-broker/conf -p</span><br><span class="line">[root@localhost opt]# cat /opt/rocketmq-broker/conf/broker.conf </span><br><span class="line">namesrvAddr=【你的IP地址】:9876</span><br><span class="line">brokerClusterName = DefaultCluster</span><br><span class="line">brokerName = broker-a</span><br><span class="line">brokerId = 0</span><br><span class="line">deleteWhen = 04</span><br><span class="line">fileReservedTime = 48</span><br><span class="line">brokerRole = ASYNC_MASTER</span><br><span class="line">flushDiskType = ASYNC_FLUSH</span><br><span class="line">brokerIP1 = 【你的IP地址】</span><br><span class="line">listenPort=10911</span><br></pre></td></tr></table></figure>
<h2 id="3启动容器并在防火墙放行端口-9876-10911-11011"><a class="markdownIt-Anchor" href="#3启动容器并在防火墙放行端口-9876-10911-11011">#</a> 3. 启动容器并在防火墙放行端口 9876 、10911 、11011</h2>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">RocketMQ默认使用3个端口：9876 、10911 、11011</span><br><span class="line">如果防火墙没有关闭的话，那么防火墙就必须开放这些端口：</span><br><span class="line">nameserver 默认使用 9876 端口</span><br><span class="line">master 默认使用 10911 端口</span><br><span class="line">slave 默认使用11011 端口</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">启动rocketmq-server</span></span><br><span class="line">docker run -d \</span><br><span class="line">--restart=always \</span><br><span class="line">--name rmqnamesrv \</span><br><span class="line">-p 9876:9876 \</span><br><span class="line">-v /opt/rocketmq-server/logs:/root/logs \</span><br><span class="line">-v /opt/rocketmq-server/store:/root/store \</span><br><span class="line">-e &quot;MAX_POSSIBLE_HEAP=100000000&quot; \</span><br><span class="line">foxiswho/rocketmq:4.7.0 \</span><br><span class="line">sh mqnamesrv</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">启动rocketmq-broker</span></span><br><span class="line">docker run -d  \</span><br><span class="line">--restart=always \</span><br><span class="line">--name rmqbroker \</span><br><span class="line">--link rmqnamesrv:namesrv \</span><br><span class="line">-p 10911:10911 \</span><br><span class="line">-p 10909:10909 \</span><br><span class="line">-v  /opt/rocketmq-broker/logs:/root/logs \</span><br><span class="line">-v  /opt/rocketmq-broker/store:/root/store \</span><br><span class="line">-v /opt/rocketmq-broker/conf/broker.conf:/opt/rocketmq-broker/conf/broker.conf \</span><br><span class="line">-e &quot;NAMESRV_ADDR=【你的IP地址】:9876&quot; \</span><br><span class="line">-e &quot;MAX_POSSIBLE_HEAP=200000000&quot; \</span><br><span class="line">-e &quot;autoCreateTopicEnable=true&quot; \</span><br><span class="line">foxiswho/rocketmq:4.7.0 \</span><br><span class="line">sh mqbroker -c /opt/rocketmq-broker/conf/broker.conf</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">启动RocketMQ的管理工具rocketmq-console</span></span><br><span class="line">docker run -itd -e &quot;JAVA_OPTS=-Drocketmq.namesrv.addr=【你的IP地址】:9876 -Dcom.rocketmq.sendMessageWithVIPChannel=false&quot; -p 9877:8080 -t styletang/rocketmq-console-ng:latest</span><br></pre></td></tr></table></figure>
<h2 id="4测试访问console控制台"><a class="markdownIt-Anchor" href="#4测试访问console控制台">#</a> 4. 测试访问 console 控制台</h2>
<p>浏览器输入：192.168.1.200:9877</p>
<p><img src="https://brath.oss-cn-shanghai.aliyuncs.com/pigo/image-20230104082814121.png" alt="image-20230104082814121"></p>
<h2 id="关于我"><a class="markdownIt-Anchor" href="#关于我">#</a> 关于我</h2>
<p>Brath 是一个热爱技术的 Java 程序猿，公众号「InterviewCoder」定期分享有趣有料的精品原创文章！</p>
<p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/%E4%BA%8C%E7%BB%B4%E7%A0%81plus.png" alt="InterviewCoder"></p>
<p>非常感谢各位人才能看到这里，原创不易，文章如果有帮助可以关注、点赞、分享或评论，这都是对我的莫大支持！</p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2020-12-13T19:48:47.000Z" title="2020/12/14 03:48:47">2020-12-14</time>发表</span><span class="level-item"><time dateTime="2021-05-24T00:33:19.000Z" title="2021/5/24 08:33:19">2021-05-24</time>更新</span><span class="level-item">10 分钟读完 (大约1450个字)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2020/12/14/%E3%80%90Java%E3%80%91Graalvm%E5%AE%89%E8%A3%85%E9%85%8D%E7%BD%AE%E4%B8%8Espringboot3.0%E5%B0%9D%E9%B2%9C/">【Java】Graalvm安装配置与springboot3.0尝鲜</a></p><div class="content"><p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/%E6%89%AB%E7%A0%81_%E6%90%9C%E7%B4%A2%E8%81%94%E5%90%88%E4%BC%A0%E6%92%AD%E6%A0%B7%E5%BC%8F-%E6%A0%87%E5%87%86%E8%89%B2%E7%89%88.png" alt="InterviewCoder"></p>
<h1 id="javagraalvm安装配置与springboot30尝鲜"><a class="markdownIt-Anchor" href="#javagraalvm安装配置与springboot30尝鲜">#</a> 【Java】Graalvm 安装配置与 springboot3.0 尝鲜</h1>
<h1 id="graalvm安装配置与springboot30尝鲜"><a class="markdownIt-Anchor" href="#graalvm安装配置与springboot30尝鲜">#</a> Graalvm 安装配置与 springboot3.0 尝鲜</h1>
<p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/86f178bacbb241fbb89957a4ec07dc4c.png" alt="在这里插入图片描述"></p>
<p>Spring 团队一直致力于 Spring 应用程序的原生映像支持已有一段时间了。经过 3 + 年的孵化春季原生 Spring Boot 2 的实验性项目，原生支持将在 Spring Framework 6 和 Spring Boot 3 中正式发布！</p>
<h2 id="安装graalvm"><a class="markdownIt-Anchor" href="#安装graalvm">#</a> 安装 Graalvm</h2>
<p>由于 spring-boot3.0 仅支持 22.3 版本，此处我们选择这个版本作为演示</p>
<p><a target="_blank" rel="noopener" href="https://github.com/graalvm/graalvm-ce-builds/releases/tag/vm-22.3.0">Release GraalVM Community Edition 22.3.0 · graalvm/graalvm-ce-builds (github.com)</a></p>
<p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/116216a0cb89f2e8d4d8cd93614085c8.png" alt="image-20221130150340996"></p>
<p>选择对应版本下载即可，此处我选择的是 windows 的 java 17 版本</p>
<p>解压之后我们可以得到这样的目录结构</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">前置路径\graalvm-ce-java17-22.3.0</span><br></pre></td></tr></table></figure>
<p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/f225ca202a944dae1dd06a3a563b1fea.png" alt="image-20221130150524482"></p>
<h3 id="配置graalvm环境变量"><a class="markdownIt-Anchor" href="#配置graalvm环境变量">#</a> 配置 Graalvm 环境变量</h3>
<p>配置变量到 <code>GRAALVM_HOME``你的解压路径</code></p>
<p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/ccf60d657a19858f117ee7a8b0e26e14.png" alt="image-20221130150648155"></p>
<p>在中添加 <code>Path``%GRAALVM_HOME%\bin</code></p>
<p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/29f6283edc68019a2c2f636b6c386f55.png" alt="image-20221130150848751"></p>
<p>确定保存</p>
<h3 id="安装成功"><a class="markdownIt-Anchor" href="#安装成功">#</a> 安装成功</h3>
<p>打开控制面板输入命令 <code>Java -version</code></p>
<p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/df38d21d0c27961cbf6614398c132fb0.png" alt="image-20221130151006878"></p>
<p>可以看到显示了我们刚刚安装的 GraalVM 的信息</p>
<p>输入命令 <code>gu</code></p>
<p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/fbe1fb9e9f76f77443a70f5b5549c938.png" alt="image-20221130151120759"></p>
<p>可以看见命令也能正常使用 <code>gu</code></p>
<h2 id="安装native-image"><a class="markdownIt-Anchor" href="#安装native-image">#</a> 安装 native-image</h2>
<p>控制台输入命令即可 <code>gu install native-image</code></p>
<p>但是可能会出现以下错误</p>
<p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/7eb4811880054f31d3f0790532fbe1ef.png" alt="image-20221130151315638"></p>
<p>解决方案</p>
<p>在 github 上下载对应版本的 native-image 安装包进行本地安装</p>
<p>还是熟悉的地址:</p>
<p><a target="_blank" rel="noopener" href="https://github.com/graalvm/graalvm-ce-builds/releases/tag/vm-22.3.0">Release GraalVM Community Edition 22.3.0 · graalvm/graalvm-ce-builds (github.com)</a></p>
<p>下拉，找到与你版本对应的安装包 <code>native-image</code></p>
<p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/96c58414392622bdd809119771dcab5e.png" alt="image-20221130151500003"></p>
<p>控制台输入命令如图所示 <code>gu install -L 你的下载位置</code></p>
<p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/9126351a5c945baeb19d939758c2edf3.png" alt="image-20221130151626018"></p>
<h3 id="安装成功-2"><a class="markdownIt-Anchor" href="#安装成功-2">#</a> 安装成功</h3>
<p>控制台输入如图所示 <code>gu list</code></p>
<p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/4c3e2b3452ad8ddfe4e21f8e6ff6b4f3.png" alt="image-20221130151715833"></p>
<p>可以看见 native-image 的版本信息，说明安装成功</p>
<h2 id="配置msvc环境"><a class="markdownIt-Anchor" href="#配置msvc环境">#</a> 配置 msvc 环境</h2>
<p>安装<a target="_blank" rel="noopener" href="https://so.csdn.net/so/search?q=vs2019&amp;spm=1001.2101.3001.7020"> vs2019</a> 及以上版本</p>
<p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/2b952909c1da82f0ba1e2b7d855a9e0a.png" alt="image-20221130152533185"></p>
<p>安装时确保勾选了以上两个选项</p>
<h3 id="环境变量"><a class="markdownIt-Anchor" href="#环境变量">#</a> 环境变量</h3>
<p>在 Path 中配置 <code>D:\vs2022\VC\Tools\MSVC\14.29.30133\bin\HostX64\x64D:\vs2022\VC\Tools\MSVC\14.29.30133\bin\HostX64\x64</code></p>
<p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/12176a3ba33ba9c41d39e3287154d27f.png" alt="image-20221130160020916"></p>
<p>配置环境变量 <code>INCLUDE</code></p>
<p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/fe59d4cf1f0c49b86d33e1772a7663ba.png" alt="image-20221130160604371"></p>
<blockquote>
<p>C:\Program Files (x86)\Windows Kits\10\Include\10.0.18362.0\ucrt;</p>
<p>C:\Program Files (x86)\Windows Kits\10\Include\10.0.18362.0\um;</p>
<p>C:\Program Files (x86)\Windows Kits\10\Include\10.0.18362.0\shared;</p>
<p>D:\vs2022\VC\Tools\MSVC\14.29.30133\include;</p>
</blockquote>
<p>(vs2022 是我的安装路径)</p>
<p>配置环境变量 <code>LIB</code></p>
<p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/0788873945abfe68181d41739e6351ea.png" alt="image-20221130161557414"></p>
<blockquote>
<p>D:\vs2022\VC\Tools\MSVC\14.29.30133\lib\x64;</p>
<p>C:\Program Files (x86)\Windows Kits\10\Lib\10.0.18362.0\um\x64;</p>
<p>C:\Program Files (x86)\Windows Kits\10\Lib\10.0.18362.0\ucrt\x64;</p>
</blockquote>
<h2 id="运行spring-boot30测试项目"><a class="markdownIt-Anchor" href="#运行spring-boot30测试项目">#</a> 运行 spring-boot3.0 测试项目</h2>
<h3 id="构建项目"><a class="markdownIt-Anchor" href="#构建项目">#</a> 构建项目</h3>
<p>引入 GraalVM Native 依赖，此次我们引入 Web 依赖用于测试</p>
<p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/c43b798d6c0c094edb5dcf686e364adb.png" alt="image-20221130190451952"></p>
<p>pom 文件如下</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span> <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.0.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">relativePath</span>/&gt;</span> <span class="comment">&lt;!-- lookup parent from repository --&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.fate<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>boot3<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.0.1-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>boot3<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">description</span>&gt;</span>boot3<span class="tag">&lt;/<span class="name">description</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">java.version</span>&gt;</span>17<span class="tag">&lt;/<span class="name">java.version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.graalvm.buildtools<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>native-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">extensions</span>&gt;</span>true<span class="tag">&lt;/<span class="name">extensions</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">executions</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">execution</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">id</span>&gt;</span>build-native<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">goals</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">goal</span>&gt;</span>compile-no-fork<span class="tag">&lt;/<span class="name">goal</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">goals</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">phase</span>&gt;</span>package<span class="tag">&lt;/<span class="name">phase</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">execution</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">execution</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">id</span>&gt;</span>test-native<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">goals</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">goal</span>&gt;</span>test<span class="tag">&lt;/<span class="name">goal</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">goals</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">phase</span>&gt;</span>test<span class="tag">&lt;/<span class="name">phase</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">execution</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">executions</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--                    此处是入口类,必须与实际代码一致,否则无法打包成功--&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">mainClass</span>&gt;</span>com.fate.boot3.Boot3Application<span class="tag">&lt;/<span class="name">mainClass</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--                    生成的exe文件名--&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">imageName</span>&gt;</span>boot-test<span class="tag">&lt;/<span class="name">imageName</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">buildArgs</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">buildArg</span>&gt;</span>--verbose<span class="tag">&lt;/<span class="name">buildArg</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">buildArgs</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">excludes</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">exclude</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">exclude</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">excludes</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h3 id="测试代码"><a class="markdownIt-Anchor" href="#测试代码">#</a> 测试代码</h3>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.fate.boot3.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> fate</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2022/11/30</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;test&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestController</span> &#123;</span><br><span class="line">    <span class="meta">@GetMapping</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">test</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;test boot3.0&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="测试运行"><a class="markdownIt-Anchor" href="#测试运行">#</a> 测试运行</h3>
<p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/96434a0202f521ec03261bdd8639fa47.png" alt="image-20221130190851328"></p>
<h3 id="打包编译"><a class="markdownIt-Anchor" href="#打包编译">#</a> 打包编译</h3>
<p>点击 maven 侧边栏插件，如图所示</p>
<p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/af4a56844461e7eafcae3f2a7dc4454b.png" alt="image-20221130191339227"></p>
<p>或者直接运行 maven 命令 <code>mvn -Pnative package</code></p>
<p>开始漫长的编译打包，即使是这样简单的项目也需要好几分钟，并且期间你的电脑也会很卡，</p>
<p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/5eae08313dc451657aefefe528b2ae06.png" alt="image-20221130191604020"></p>
<p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/76f867095d399da66dfe2483d46c2eaf.png" alt="image-20221130191900654"></p>
<p>可以看见，耗时近三分钟，编译之后我们发现，target 目录下变得不一样了，生成了 exe 可执行文件，当然你也可能注意到了 spring-aot 这个文件夹，虽然我还不是很了解 aot, 但是很明显，大的来了</p>
<p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/faf46922b0ba3218bde339d62810d27d.png" alt="image-20221130193829658"></p>
<p>直接在 cmd 中运行</p>
<p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/0739d467ae2c5f370874bfa40ddfed6c.png" alt="image-20221130193741304"></p>
<p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/a777d81bb6de25ed99c134372e03e00e.png" alt="image-20221130193757182"></p>
<h1 id="大功告成"><a class="markdownIt-Anchor" href="#大功告成">#</a> 大功告成</h1>
<h2 id="关于我"><a class="markdownIt-Anchor" href="#关于我">#</a> 关于我</h2>
<p>Brath 是一个热爱技术的 Java 程序猿，公众号「InterviewCoder」定期分享有趣有料的精品原创文章！</p>
<p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/%E4%BA%8C%E7%BB%B4%E7%A0%81plus.png" alt="InterviewCoder"></p>
<p>非常感谢各位人才能看到这里，原创不易，文章如果有帮助可以关注、点赞、分享或评论，这都是对我的莫大支持！</p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2020-12-10T19:36:11.000Z" title="2020/12/11 03:36:11">2020-12-11</time>发表</span><span class="level-item"><time dateTime="2022-10-27T19:44:36.000Z" title="2022/10/28 03:44:36">2022-10-28</time>更新</span><span class="level-item">35 分钟读完 (大约5295个字)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2020/12/11/%E3%80%90Java%E3%80%91Elastic%20canal%E6%95%B0%E6%8D%AE%E5%90%8C%E6%AD%A5%E5%88%B0ES%E9%85%8D%E7%BD%AE%E5%B8%B8%E8%A7%81%E6%8A%A5%E9%94%99/">【Java】Elastic canal数据同步到ES配置常见报错</a></p><div class="content"><p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/%E6%89%AB%E7%A0%81_%E6%90%9C%E7%B4%A2%E8%81%94%E5%90%88%E4%BC%A0%E6%92%AD%E6%A0%B7%E5%BC%8F-%E6%A0%87%E5%87%86%E8%89%B2%E7%89%88.png" alt="InterviewCoder"></p>
<h1 id="javaelastic-canal数据同步到es配置常见报错"><a class="markdownIt-Anchor" href="#javaelastic-canal数据同步到es配置常见报错">#</a> 【Java】Elastic canal 数据同步到 ES 配置常见报错</h1>
<h1 id="0-引言"><a class="markdownIt-Anchor" href="#0-引言">#</a> 0. 引言</h1>
<p>所有报错均为博主在实操过程中遇到的错误和解决办法，如果有其他报错或者不同的解决办法，请留言告诉我</p>
<p>安装<a target="_blank" rel="noopener" href="https://so.csdn.net/so/search?q=canal&amp;spm=1001.2101.3001.7020"> canal</a> 过程中遇到问题，先在本文中查询是否有相同报错，将会为你节约大量排错时间</p>
<h2 id="环境"><a class="markdownIt-Anchor" href="#环境">#</a> 环境</h2>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">jdk1.8</span><br><span class="line">canal 1.1.5</span><br><span class="line">mysql8.0</span><br><span class="line">es7.13.0</span><br></pre></td></tr></table></figure>
<h1 id="1-unknown-system-variable-query_cache_size"><a class="markdownIt-Anchor" href="#1-unknown-system-variable-query_cache_size">#</a> 1. Unknown system variable ‘query_cache_size’</h1>
<p>这是因为<a target="_blank" rel="noopener" href="https://so.csdn.net/so/search?q=mysql%E9%A9%B1%E5%8A%A8&amp;spm=1001.2101.3001.7020"> mysql 驱动</a>包的版本过低导致的，query cache 在 MySQL5.7.20 就已经过时了，而在 MySQL8.0 之后就已经被移除了</p>
<p>1、只需要将 lib 中的驱动器替换成 mysql-connector-java-8.0.22.jar</p>
<p>2、修改驱动器权限</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">chmod 777 lib/mysql-connector-java-8.0.22.jar</span><br><span class="line">chmod +st lib/mysql-connector-java-8.0.22.jar</span><br></pre></td></tr></table></figure>
<p>查看权限如图所示</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ll lib</span><br></pre></td></tr></table></figure>
<p><img src="https://img-blog.csdnimg.cn/fb4993202deb4227a295dc8ffcfffafb.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAd3VfNTU1NTU=,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"></p>
<h1 id="2-reason-no-converter-found-capable-of-converting-from-type-javalangstring-to-type-javautilmapjavalangstring-javalangstring"><a class="markdownIt-Anchor" href="#2-reason-no-converter-found-capable-of-converting-from-type-javalangstring-to-type-javautilmapjavalangstring-javalangstring">#</a> 2. Reason: No converter found capable of converting from type [java.lang.String] to type [java.util.Map&lt;java.lang.String, java.lang.String&gt;]</h1>
<p>启动 canal-adapter 报错：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Failed to bind properties under &#x27;canal.conf.canal-adapters[0].groups[0].outer-adapters[1].properties&#x27; to java.util.Map&lt;java.lang.String, java.lang.String&gt;:</span><br><span class="line"></span><br><span class="line">    Reason: No converter found capable of converting from type [java.lang.String] to type [java.util.Map&lt;java.lang.String, java.lang.String&gt;]</span><br></pre></td></tr></table></figure>
<p>解决：<br>
观察报错信息可以得知是配置文件中的 outer2（0 基，所以 outer-adapter [1] 实际指的是 2）的 properties 配置有问题，我们观察配置文件，发现是 properties 下的 mode,cluster.name 等属性与 properties 同级了，将其如下图所示后退两字符即可。<br>
<img src="https://img-blog.csdnimg.cn/f5384eaf97234881bba9b3c8bcd663da.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAd3VfNTU1NTU=,size_20,color_FFFFFF,t_70,g_se,x_16" alt="配置"></p>
<h1 id="3-runtimeexception-javalangruntimeexception-no-data-source-found-xxxx"><a class="markdownIt-Anchor" href="#3-runtimeexception-javalangruntimeexception-no-data-source-found-xxxx">#</a> 3. RuntimeException: java.lang.RuntimeException: No data source found: xxxx</h1>
<p>这个因为在 conf/es/xxx.yml 中配置的 dataSourceKey 并没有在 conf/application.yml 中的 srcDataSources 中维护</p>
<p>如下图所示，es 中的 dataSourceKey 需要在 applicaiton.yml 中设置，默认是 defaultDS<br>
<img src="https://img-blog.csdnimg.cn/14dacccf628d44e7b6f67c52bccdb93e.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAd3VfNTU1NTU=,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"><br>
<img src="https://img-blog.csdnimg.cn/5e57dd86bcb8417e9e7eda2a6d014956.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAd3VfNTU1NTU=,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"></p>
<h1 id="4-reason-unable-to-set-value-for-property-src-data-sources"><a class="markdownIt-Anchor" href="#4-reason-unable-to-set-value-for-property-src-data-sources">#</a> 4. Reason: Unable to set value for property src-data-sources</h1>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Failed to bind properties under &#x27;canal.conf&#x27; to com.alibaba.otter.canal.adapter.launcher.config.AdapterCanalConfig:</span><br><span class="line"></span><br><span class="line">    Reason: Unable to set value for property src-data-sources</span><br></pre></td></tr></table></figure>
<p>原因一：<br>
mysql 驱动器导致的问题，使用的数据库是 8.x。驱动器是 5.x 的，将 mysql 驱动替换为 8.0.x 版本的。如上所示报错 1</p>
<p>原因二：<br>
检查该报错前的日志，是否有其他相关报错信息，比如无相关数据库，如下所示，根据其报错内容来检查配置项并且调整即可<br>
<img src="https://img-blog.csdnimg.cn/fbf719ab834648f9adfa37c65e402d71.png" alt="在这里插入图片描述"></p>
<h1 id="5-javasqlsqlexception-null-message-from-server-host-172161882-is-blocked-because-of-many-connection-errors-unblock-with-mysqladmin-flush-hosts"><a class="markdownIt-Anchor" href="#5-javasqlsqlexception-null-message-from-server-host-172161882-is-blocked-because-of-many-connection-errors-unblock-with-mysqladmin-flush-hosts">#</a> 5. java.sql.SQLException: null, message from server: “Host ‘172.16.188.2’ is blocked because of many connection errors; unblock with ‘mysqladmin flush-hosts’”</h1>
<p>同一个 ip 在短时间内产生太多中断的数据库连接而导致的阻塞</p>
<p>登录对应的 mysql，执行如下指令</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">flush hosts;</span><br></pre></td></tr></table></figure>
<h1 id="6-illegalstateexception-extension-instancename-es7-class-interface-comalibabaottercanalclientadapterouteradapter-could-not-be-instantiated-class-could-not-be-found"><a class="markdownIt-Anchor" href="#6-illegalstateexception-extension-instancename-es7-class-interface-comalibabaottercanalclientadapterouteradapter-could-not-be-instantiated-class-could-not-be-found">#</a> 6. IllegalStateException: Extension instance(name: es7, class: interface com.alibaba.otter.canal.client.adapter.OuterAdapter) could not be instantiated: class could not be found</h1>
<p>一般 <code> could not be instantiated: class could not be found</code>  这样的报错是配置文件的问题，如上的报错可以看到是 name: es7 中的错误，在官方的示例文档中使用的是 <code>name: es6 # or es7</code> 。</p>
<p>在 canal1.1.5 + 版本中设置的是 name: es6 # 或者 es7</p>
<p>但在 1.1.4 版本中直接使用 <code>name: es</code>  即可</p>
<h1 id="7-illegalargumentexception-not-found-the-mapping-info-of-index-user"><a class="markdownIt-Anchor" href="#7-illegalargumentexception-not-found-the-mapping-info-of-index-user">#</a> 7. IllegalArgumentException: Not found the mapping info of index: user</h1>
<p>1、这个报错是 ES 的 mapping 设置的问题，确保 es 中有该索引，并且确认是否有部分字段没有在 es 中设置 mapping, 这个要对应之前设置的 sql，以及 es 中的 mappings 来解决</p>
<p>2、使用了 elasticsearch 7.x，但 adapter1.1.4 默认支持 es6.x<br>
 解决方案：<br>
（1）修改 adapter 源码，将 es 依赖调整为 7.x；参考博客<a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/355162399"> adapter1.1.4 修改源码支持 es7.x</a><br>
（2）换成 adapter1.1.5</p>
<h1 id="8-illegalargumentexception-illegal-character-in-scheme-name-at-index-0-1721618879200"><a class="markdownIt-Anchor" href="#8-illegalargumentexception-illegal-character-in-scheme-name-at-index-0-1721618879200">#</a> 8. IllegalArgumentException: Illegal character in scheme name at index 0: 172.16.188.7:9200</h1>
<p>如果连接 es 使用的是 rest 方式，那么 hosts 中的 ip 前要添加 <code>http://</code> ，如</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hosts: http://172.16.188.7:9200</span><br></pre></td></tr></table></figure>
<h1 id="9-comalibabadruidpooldruiddatasource-cannot-be-cast-to-comalibabadruidpooldruiddatasource"><a class="markdownIt-Anchor" href="#9-comalibabadruidpooldruiddatasource-cannot-be-cast-to-comalibabadruidpooldruiddatasource">#</a> 9. com.alibaba.druid.pool.DruidDataSource cannot be cast to com.alibaba.druid.pool.DruidDataSource</h1>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">java.lang.RuntimeException: java.lang.RuntimeException: java.lang.ClassCastException: com.alibaba.druid.pool.DruidDataSource cannot be cast to com.alibaba.druid.pool.DruidDataSource</span><br><span class="line">	at com.alibaba.otter.canal.client.adapter.es7x.ES7xAdapter.init(ES7xAdapter.java:54) ~[client-adapter.es7x-1.1.5-jar-with-dependencies.jar:na]</span><br><span class="line">	at com.alibaba.otter.canal.adapter.launcher.loader.CanalAdapterLoader.loadAdapter(CanalAdapterLoader.java:225) [client-adapter.launcher-1.1.5.jar:na]</span><br><span class="line">	at com.alibaba.otter.canal.adapter.launcher.loader.CanalAdapterLoader.init(CanalAdapterLoader.java:56) [client-adapter.launcher-1.1.5.jar:na]</span><br><span class="line">	at com.alibaba.otter.canal.adapter.launcher.loader.CanalAdapterService.init(CanalAdapterService.java:60) [client-adapter.launcher-1.1.5.jar:na]</span><br><span class="line">	at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method) ~[na:1.8.0_271]</span><br><span class="line">	at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62) ~[na:1.8.0_271]</span><br><span class="line">	at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43) ~[na:1.8.0_271]</span><br><span class="line">	at java.lang.reflect.Method.invoke(Method.java:498) ~[na:1.8.0_271]</span><br></pre></td></tr></table></figure>
<p>原因：<br>
druid 包冲突<br>
解决：<br>
1、修改 client-adapter/escore/pom.xml</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;com.alibaba&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;druid&lt;/artifactId&gt;</span><br><span class="line">            &lt;!--add by whx 20220112--&gt;</span><br><span class="line">            &lt;scope&gt;provided&lt;/scope&gt;</span><br><span class="line"> &lt;/dependency&gt;</span><br></pre></td></tr></table></figure>
<p>2、重新打包<br>
<img src="https://img-blog.csdnimg.cn/dfe52cef447444469af1020bf5328ef5.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAd3VfNTU1NTU=,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"><br>
 3、将 client-adapter/es7x/target/client-adapter.es7x-1.1.5-jar-with-dependencies.jar 上传到服务器，替换 adataper/plugin 下的同名 jar 文件<br>
<img src="https://img-blog.csdnimg.cn/eb3b4b46f8ab47d391244904ecb6e89e.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAd3VfNTU1NTU=,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">scp client-adapter.es7x-1.1.5-jar-with-dependencies.jar root@172.16.188.2:/var/local</span><br></pre></td></tr></table></figure>
<p>4、给该文件赋权</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chmod 777 /var/local/client-adapter.es7x-1.1.5-jar-with-dependencies.jar </span><br></pre></td></tr></table></figure>
<p>5、重启服务</p>
<h4 id="10-canalparseexception-javaioioexception-eof-encountered"><a class="markdownIt-Anchor" href="#10-canalparseexception-javaioioexception-eof-encountered">#</a> 10 CanalParseException: java.io.IOException: EOF encountered</h4>
<p>将 lib 目录下的 mysql 驱动器替换为<a target="_blank" rel="noopener" href="https://so.csdn.net/so/search?q=mysql8&amp;spm=1001.2101.3001.7020"> mysql8</a>.0，并附权。参考上述</p>
<h1 id="11-canalclientexception-javaioioexception-broken-pipe-error-sync-but-ack"><a class="markdownIt-Anchor" href="#11-canalclientexception-javaioioexception-broken-pipe-error-sync-but-ack">#</a> 11. CanalClientException: java.io.IOException: Broken pipe Error sync but ACK</h1>
<p>服务连接断开了，将 deployer 和 adapter 都关闭，先启动 deployer 再启动 adapter</p>
<h1 id="12-documentmissingexception_doc1413298413755211778-document-missing"><a class="markdownIt-Anchor" href="#12-documentmissingexception_doc1413298413755211778-document-missing">#</a> 12. DocumentMissingException[[_doc][1413298413755211778]: document missing]</h1>
<p>1、es 集群出现问题，导致 doc 无法分配。常见的是分片数的问题，可能是副本分片过多，导致集群报黄<br>
解决：<br>
因为我的是 es 单节点，所以将主分片数设置为 1，副本分片设置为 0。不申明的话默认创建副本分片数为 1</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">PUT user</span><br><span class="line">&#123;</span><br><span class="line">  &quot;mappings&quot;: &#123;</span><br><span class="line">    &quot;properties&quot;: &#123;</span><br><span class="line">      &quot;code&quot;: &#123;</span><br><span class="line">        &quot;type&quot;: &quot;keyword&quot;</span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;email&quot;: &#123;</span><br><span class="line">        &quot;type&quot;: &quot;text&quot;,</span><br><span class="line">        &quot;fields&quot;: &#123;</span><br><span class="line">          &quot;keyword&quot;: &#123;</span><br><span class="line">            &quot;type&quot;: &quot;keyword&quot;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;realName&quot;: &#123;</span><br><span class="line">        &quot;type&quot;: &quot;text&quot;,</span><br><span class="line">        &quot;analyzer&quot;: &quot;ik_smart&quot;,</span><br><span class="line">        &quot;fields&quot;: &#123;</span><br><span class="line">          &quot;keyword&quot;: &#123;</span><br><span class="line">            &quot;type&quot;: &quot;keyword&quot;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;roleId&quot;: &#123;</span><br><span class="line">        &quot;type&quot;: &quot;text&quot;,</span><br><span class="line">        &quot;fields&quot;: &#123;</span><br><span class="line">          &quot;keyword&quot;: &#123;</span><br><span class="line">            &quot;type&quot;: &quot;keyword&quot;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;postId&quot;: &#123;</span><br><span class="line">        &quot;type&quot;: &quot;text&quot;,</span><br><span class="line">        &quot;fields&quot;: &#123;</span><br><span class="line">          &quot;keyword&quot;: &#123;</span><br><span class="line">            &quot;type&quot;: &quot;keyword&quot;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;deptId&quot;: &#123;</span><br><span class="line">        &quot;type&quot;: &quot;text&quot;,</span><br><span class="line">        &quot;fields&quot;: &#123;</span><br><span class="line">          &quot;keyword&quot;: &#123;</span><br><span class="line">            &quot;type&quot;: &quot;keyword&quot;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;settings&quot;: &#123;</span><br><span class="line">    &quot;number_of_replicas&quot;: 0,</span><br><span class="line">    &quot;number_of_shards&quot;: 1</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>2、修改的 mysql 数据库数据，在 es 中不存在。先进行全量同步，再进行增量同步</p>
<p>在 conf/example/instance.properties 中修改</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># 全量同步</span><br><span class="line">canal.instance.master.journal.name=mysql-bin.000001</span><br><span class="line">canal.instance.master.position=0</span><br><span class="line">#2019-01-01 00:00:00 上一次更新的时间</span><br><span class="line">canal.instance.master.timestamp=1546272000000</span><br></pre></td></tr></table></figure>
<h1 id="13-error-caottercanalservernettyhandlersessionhandler-something-goes-wrong-with-channelid-0x23d9cad9-12700146472-12700111111-exceptionjavaniochannelsclosedchannelexception"><a class="markdownIt-Anchor" href="#13-error-caottercanalservernettyhandlersessionhandler-something-goes-wrong-with-channelid-0x23d9cad9-12700146472-12700111111-exceptionjavaniochannelsclosedchannelexception">#</a> 13. ERROR c.a.otter.canal.server.netty.handler.SessionHandler - something goes wrong with channel:[id: 0x23d9cad9, /127.0.0.1:46472 :&gt; /127.0.0.1:11111], exception=java.nio.channels.ClosedChannelException</h1>
<p>这是由于 deployer 中的 conf/example/meta.dat 与 instance.properties 文件中的 journalName,position,timestamp 不一致导致的</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"># 查询bin log位置</span><br><span class="line">show master status;</span><br><span class="line"># 如果显示的binlog不为000001可以执行以下语句重置binlog（轻易别操作，最好让专业的运维人员操作）</span><br><span class="line"># 该操作会重新生成binlog，之前的binlog就会清空，之前的数据就不会再同步</span><br><span class="line">reset master;</span><br><span class="line"># 刷新log日志，自此刻开始产生一个新编号的binlog日志文件</span><br><span class="line">flush logs;</span><br></pre></td></tr></table></figure>
<p><img src="https://img-blog.csdnimg.cn/849d7b41b8c348dead0670db96717068.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAd3VfNTU1NTU=,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"><br>
将 meta.dat 删除或者修改一致即可。删除后将会按照 instance.properties 中设置的起点同步，生产环境考虑好需要后再删除。</p>
<p>如果想要将之前的数据也同步的话，可以将数据库先导出，再重新导入一遍，即可重新生成 binlog，实现数据的全量同步</p>
<h1 id="14-received-error-packet-errno-1236-sqlstate-hy000-errmsg-could-not-find-first-log-file-name-in-binary-log-index-file"><a class="markdownIt-Anchor" href="#14-received-error-packet-errno-1236-sqlstate-hy000-errmsg-could-not-find-first-log-file-name-in-binary-log-index-file">#</a> 14. Received error packet: errno = 1236, sqlstate = HY000 errmsg = Could not find first log file name in binary log index file</h1>
<p>mysql bin log 数据不同步，刷新一下即可</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">flush logs;</span><br></pre></td></tr></table></figure>
<h1 id="15-binlog也设置为000001了timestamp也设置了但就是无法实现全量同步"><a class="markdownIt-Anchor" href="#15-binlog也设置为000001了timestamp也设置了但就是无法实现全量同步">#</a> 15. binlog 也设置为 000001 了，timestamp 也设置了，但就是无法实现全量同步</h1>
<p>1、删除 conf/example/meta.dat<br>
2、调整 conf/example/instance.properties</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">canal.instance.master.journal.name=mysql-bin.000001</span><br><span class="line">canal.instance.master.position=0</span><br><span class="line">#2019-01-01 00:00:00 上一次更新的时间</span><br><span class="line">canal.instance.master.timestamp=1546272000000</span><br></pre></td></tr></table></figure>
<p>3、重启 deployer</p>
<p>另外需要注意的是如果 bin log 是只会记录增量操作的，也就是说开启 bin log 之前的历史数据是不会记录的，如果需要同步者之前的数据，解决这个问题有三个办法：<br>
（1）<a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_24950043/article/details/122483061">通过 logstash-input-jdbc 来实现</a><br>
（2）通过业务代码来实现（后续会详细讲解这两种方式，可以关注我后续的博客）<br>
（3）复制原数据库数据到开启了 binlog 的从数据库，然后从从数据库同步</p>
<h1 id="16-adapter启动报错something-goes-wrong-when-starting-up-the-canal-client-adapters-javalangnullpointerexception-null"><a class="markdownIt-Anchor" href="#16-adapter启动报错something-goes-wrong-when-starting-up-the-canal-client-adapters-javalangnullpointerexception-null">#</a> 16. adapter 启动报错：something goes wrong when starting up the canal client adapters: java.lang.NullPointerException: null</h1>
<p>这个报错是空指针报错，很明显是哪里获取为空的，这种错误没有固定的原因，但大概率上可以锁定配置文件的问题</p>
<p>1、adapter 的配置文件中是有包含了 mysql、es、mq、zk 等配置，如果不需要的配置项，就将其注释掉，不要打开</p>
<p>比如我这里的报错原因就是因为打开了 zookeeperHosts，但是没有配置具体值，所以导致了空指针，因为我不需要 zk，将其注释掉即可</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># flatMessage: true</span><br><span class="line"># zookeeperHosts:</span><br></pre></td></tr></table></figure>
<p>2、某些必要的配置没有设置，快速排查的方式就是根据官方文档中给出的配置文件对比排错<br>
可以参考如下配置文件</p>
<p>3、配置文件中配置项排版错位</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line">server:</span><br><span class="line">  port: 8081</span><br><span class="line">spring:</span><br><span class="line">  jackson:</span><br><span class="line">    date-format: yyyy-MM-dd HH:mm:ss</span><br><span class="line">    time-zone: GMT+8</span><br><span class="line">    default-property-inclusion: non_null</span><br><span class="line"></span><br><span class="line">canal.conf:</span><br><span class="line">  mode: tcp #tcp kafka rocketMQ rabbitMQ</span><br><span class="line">  flatMessage: true</span><br><span class="line">  zookeeperHosts:</span><br><span class="line">  syncBatchSize: 1000</span><br><span class="line">  retries: 0</span><br><span class="line">  timeout:</span><br><span class="line">  accessKey:</span><br><span class="line">  secretKey:</span><br><span class="line">  consumerProperties:</span><br><span class="line">    # canal tcp consumer</span><br><span class="line">    canal.tcp.server.host: 127.0.0.1:11111</span><br><span class="line">    canal.tcp.zookeeper.hosts:</span><br><span class="line">    canal.tcp.batch.size: 500</span><br><span class="line">    canal.tcp.username:</span><br><span class="line">    canal.tcp.password:</span><br><span class="line">    # kafka consumer</span><br><span class="line">    kafka.bootstrap.servers: 127.0.0.1:9092</span><br><span class="line">    kafka.enable.auto.commit: false</span><br><span class="line">    kafka.auto.commit.interval.ms: 1000</span><br><span class="line">    kafka.auto.offset.reset: latest</span><br><span class="line">    kafka.request.timeout.ms: 40000</span><br><span class="line">    kafka.session.timeout.ms: 30000</span><br><span class="line">    kafka.isolation.level: read_committed</span><br><span class="line">    kafka.max.poll.records: 1000</span><br><span class="line">    # rocketMQ consumer</span><br><span class="line">    rocketmq.namespace:</span><br><span class="line">    rocketmq.namesrv.addr: 127.0.0.1:9876</span><br><span class="line">    rocketmq.batch.size: 1000</span><br><span class="line">    rocketmq.enable.message.trace: false</span><br><span class="line">    rocketmq.customized.trace.topic:</span><br><span class="line">    rocketmq.access.channel:</span><br><span class="line">    rocketmq.subscribe.filter:</span><br><span class="line">    # rabbitMQ consumer</span><br><span class="line">    rabbitmq.host:</span><br><span class="line">    rabbitmq.virtual.host:</span><br><span class="line">    rabbitmq.username:</span><br><span class="line">    rabbitmq.password:</span><br><span class="line">    rabbitmq.resource.ownerId:</span><br><span class="line">  srcDataSources:</span><br><span class="line">    defaultDS:</span><br><span class="line">      url: jdbc:mysql://172.16.188.1:3306/bladex?useUnicode=true</span><br><span class="line">      #driverClassName: com.mysql.cj.jdbc.Driver</span><br><span class="line">      username: root</span><br><span class="line">      password: 123456</span><br><span class="line">  canalAdapters:</span><br><span class="line">  - instance: example # canal instance Name or mq topic name</span><br><span class="line">    groups:</span><br><span class="line">    - groupId: g1</span><br><span class="line">      outerAdapters:</span><br><span class="line">      - name: logger</span><br><span class="line">      - </span><br><span class="line">        key: esKey</span><br><span class="line">        name: es7 # es6 or es7</span><br><span class="line">        hosts: http://172.16.188.7:9200 # 集群地址，逗号隔开. 127.0.0.1:9200 for rest mode or 127.0.0.1:9300 for transport mode</span><br><span class="line">        properties:</span><br><span class="line">          mode: rest #  rest or transport </span><br><span class="line">          # security.auth: test:123456 #  only used for rest mode</span><br><span class="line">          cluster.name: cluster1</span><br></pre></td></tr></table></figure>
<h1 id="17-field-error-in-object-target-on-field-esmapping-rejected-value"><a class="markdownIt-Anchor" href="#17-field-error-in-object-target-on-field-esmapping-rejected-value">#</a> 17 Field error in object ‘target’ on field ‘esMapping’: rejected value [];</h1>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Field error in object &#x27;target&#x27; on field &#x27;esMapping&#x27;: rejected value []; codes </span><br><span class="line">[typeMismatch.target.esMapping,typeMismatch.esMapping,typeMismatch.com.alibaba.otter.canal.client.adapter.es.core.config.ESSyncConfig$ESMapping,typeMismatch]; </span><br><span class="line">arguments [org.springframework.context.support.DefaultMessageSourceResolvable: codes [target.esMapping,esMapping]; arguments []; default message [esMapping]]; default message [Failed to convert property value of type &#x27;java.lang.String&#x27; to required type </span><br><span class="line">&#x27;com.alibaba.otter.canal.client.adapter.es.core.config.ESSyncConfig$ESMapping&#x27; for property &#x27;esMapping&#x27;; nested </span><br><span class="line">exception is java.lang.IllegalStateException: Cannot convert value of type &#x27;java.lang.String&#x27; to required type</span><br><span class="line"> &#x27;com.alibaba.otter.canal.client.adapter.es.core.config.ESSyncConfig$ESMapping&#x27; for property &#x27;esMapping&#x27;: no </span><br><span class="line"> matching editors or conversion strategy found]</span><br></pre></td></tr></table></figure>
<p>这是配置文件问题，检查 es 下的配置 yml 文件，特别是 sql 语句的语法是否有问题</p>
<h1 id="18-javautilnosuchelementexception"><a class="markdownIt-Anchor" href="#18-javautilnosuchelementexception">#</a> 18 java.util.NoSuchElementException</h1>
<p>没有找到对应字段导致</p>
<p>检查下 canal 配置文件中的字段是否在 es mapping 中有对应的，大小写是否一致，是否有遗漏</p>
<p>因为我的操作是 mysql 同步至 es，所以这里说明几项容易出错的地方：<br>
1、canal 配置文件中的 sql 中是否大小写一致，canal 是区分大小写的<br>
 2、sql 中设置的别名是否与 es mappings 中的名称一致，允许 es 中的部分字段为空，但是不允许 sql 中查询出来的字段在 es mappings 中找不到对应的字段<br>
 3、canal 配置文件中的 dataSourceKey 是否正确，其对应到 canal application.yml 配置文件中的数据库是否正确</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dataSourceKey: aaa</span><br></pre></td></tr></table></figure>
<p>application.yml</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">srcDataSources:</span><br><span class="line">    aaa: # 与之对应</span><br><span class="line">      url: jdbc:mysql://192.168.244.1:3306/aaa?useUnicode=true</span><br><span class="line">      #driverClassName: com.mysql.cj.jdbc.Driver</span><br><span class="line">      username: root</span><br><span class="line">      password: 123456</span><br><span class="line">    xxx:</span><br><span class="line">      url: jdbc:mysql://192.168.244.1:3306/xxx?useUnicode=true</span><br><span class="line">      username: root</span><br><span class="line">      password: 123456</span><br><span class="line">    yyy:</span><br><span class="line">      url: jdbc:mysql://192.168.244.1:3306/yyy?useUnicode=true</span><br><span class="line">      username: root</span><br><span class="line">      password: 123456</span><br></pre></td></tr></table></figure>
<p>4、canal 配置文件中的排版是否正确，特别注意_index,_type 等属性要放在 esMappings 下</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">dataSourceKey: aaa # 这里的key与上述application.yml中配置的数据源保持一致</span><br><span class="line">outerAdapterKey: esKey # 与上述application.yml中配置的outerAdapters.key一直</span><br><span class="line">destination: example # 默认为example,与application.yml中配置的instance保持一致</span><br><span class="line">groupId:</span><br><span class="line">esMapping:</span><br><span class="line">  _index: dept </span><br><span class="line">  _type: _doc</span><br><span class="line">  _id: _id</span><br><span class="line">  sql: &quot;select</span><br><span class="line">        t.id,</span><br><span class="line">        t.id as _id,</span><br><span class="line">        t.dept_name as deptName,</span><br><span class="line">        t.dept_category as deptCategory,</span><br><span class="line">        t.parent_id as parentId,</span><br><span class="line">        t.ancestors as ancestors,</span><br><span class="line">        t.third_party_id as thirdPartyId,</span><br><span class="line">        t.phone as phone,</span><br><span class="line">        t.address as address,</span><br><span class="line">        t.is_deleted as isDeleted</span><br><span class="line">      from</span><br><span class="line">         dept t&quot;</span><br><span class="line">  #etlCondition: &quot;where t.update_time&gt;=&#x27;&#123;0&#125;&#x27;&quot;</span><br><span class="line">  commitBatch: 3000</span><br></pre></td></tr></table></figure>
<p>5、sql 查询出来的字段类型与 es mappings 中的字段数据类型是否一致</p>
<p>6、多表同步到同一个索引时，如果都有同一个常量列且值不同时会报错。<br>
如下所示的两个配置文件都有 userSource 常量列用于区分不同的数据来源，但是如下的配置会报错。<br>
xxx.yml</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">dataSourceKey: aaa # 这里的key与上述application.yml中配置的数据源保持一致</span><br><span class="line">outerAdapterKey: esKey # 与上述application.yml中配置的outerAdapters.key一直</span><br><span class="line">destination: example # 默认为example,与application.yml中配置的instance保持一致</span><br><span class="line">groupId:</span><br><span class="line">esMapping:</span><br><span class="line">  _index: user</span><br><span class="line">  _type: _doc</span><br><span class="line">  _id: _id</span><br><span class="line">  sql: &quot;select</span><br><span class="line">        t.id, </span><br><span class="line">        0 as userSource, </span><br><span class="line">      from</span><br><span class="line">         user t&quot; </span><br><span class="line">  commitBatch: 3000</span><br></pre></td></tr></table></figure>
<p>yyy.yml</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">dataSourceKey: aaa # 这里的key与上述application.yml中配置的数据源保持一致</span><br><span class="line">outerAdapterKey: esKey # 与上述application.yml中配置的outerAdapters.key一直</span><br><span class="line">destination: example # 默认为example,与application.yml中配置的instance保持一致</span><br><span class="line">groupId:</span><br><span class="line">esMapping:</span><br><span class="line">  _index: user</span><br><span class="line">  _type: _doc</span><br><span class="line">  _id: _id</span><br><span class="line">  sql: &quot;select</span><br><span class="line">        t.id, </span><br><span class="line">        1 as userSource, </span><br><span class="line">      from</span><br><span class="line">         user_wx t&quot; </span><br><span class="line">  commitBatch: 3000</span><br></pre></td></tr></table></figure>
<h1 id="19-adapter日志中没有报错但是没有读取binlog-could-not-find-first-log-file-name-in-binary-log-index-file"><a class="markdownIt-Anchor" href="#19-adapter日志中没有报错但是没有读取binlog-could-not-find-first-log-file-name-in-binary-log-index-file">#</a> 19. adapter 日志中没有报错，但是没有读取 binlog ｜ Could not find first log file name in binary log index file</h1>
<p>adapter 日志中没有报错信息，于是去查看 deployer 日志，这里的 example 是你配置的实例</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat logs/example/example.log</span><br></pre></td></tr></table></figure>
<p>会发现报错：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Could not find first log file name in binary log index file</span><br></pre></td></tr></table></figure>
<p>解决：<br>
1、既然问题是没有找到数据库的 binglog 文件位置，那么就查看一下现在的 binlog 文件位置，登陆 mysql 执行</p>
<p>2.1 如果你是做增量同步，那么查询当前 binlog 位置</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">show master status;</span><br></pre></td></tr></table></figure>
<p><img src="https://img-blog.csdnimg.cn/5a1f009e008d4b4281589f580bef9192.png" alt="在这里插入图片描述"><br>
修改 conf/example/instance.properties 文件</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">canal.instance.master.address=192.168.244.17:3306</span><br><span class="line"># 这里的文件名要与上面的保持一致，我这里就是文件名不一致，写成了mysql-bin.000001</span><br><span class="line">canal.instance.master.journal.name=binlog.000003 </span><br><span class="line">canal.instance.master.position=5921</span><br><span class="line">canal.instance.master.timestamp=</span><br><span class="line">canal.instance.master.gtid=</span><br></pre></td></tr></table></figure>
<p>2.2 如果你要做全量同步，查询 binlog 文件</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">show binary logs;</span><br></pre></td></tr></table></figure>
<p><img src="https://img-blog.csdnimg.cn/b4736c68b0f64b80bb509d395a627fb1.png" alt="在这里插入图片描述"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">canal.instance.master.address=192.168.244.17:3306</span><br><span class="line"># 这里的文件名要与上面的保持一致，我这里就是文件名不一致，写成了mysql-bin.000001</span><br><span class="line">canal.instance.master.journal.name=binlog.000001</span><br><span class="line"># 位置从0开始</span><br><span class="line">canal.instance.master.position=0</span><br><span class="line">canal.instance.master.timestamp=</span><br><span class="line">canal.instance.master.gtid=</span><br></pre></td></tr></table></figure>
<p>3、重启 deployer 和 adapter</p>
<h1 id="20-error-caottercanaladapterlauncherloaderadapterprocessor-javalangnullpointerexception"><a class="markdownIt-Anchor" href="#20-error-caottercanaladapterlauncherloaderadapterprocessor-javalangnullpointerexception">#</a> 20. ERROR c.a.otter.canal.adapter.launcher.loader.AdapterProcessor - java.lang.NullPointerException</h1>
<p>启动 adapter 报错：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">2022-05-21 06:28:44.444 [pool-2-thread-1] ERROR c.a.otter.canal.adapter.launcher.loader.AdapterProcessor - java.lang.NullPointerException</span><br><span class="line">java.lang.RuntimeException: java.lang.NullPointerException</span><br><span class="line">        at com.alibaba.otter.canal.client.adapter.es.core.service.ESSyncService.sync(ESSyncService.java:116) ~[na:na]</span><br><span class="line">        at com.alibaba.otter.canal.client.adapter.es.core.service.ESSyncService.sync(ESSyncService.java:64) ~[na:na]</span><br><span class="line">        at com.alibaba.otter.canal.client.adapter.es.core.ESAdapter.sync(ESAdapter.java:115) ~[na:na]</span><br><span class="line">        at com.alibaba.otter.canal.client.adapter.es.core.ESAdapter.sync(ESAdapter.java:94) ~[na:na]</span><br><span class="line">        at com.alibaba.otter.canal.adapter.launcher.loader.AdapterProcessor.batchSync(AdapterProcessor.java:139) ~[client-adapter.launcher-1.1.5.jar:na]</span><br><span class="line">        at com.alibaba.otter.canal.adapter.launcher.loader.AdapterProcessor.lambda$null$1(AdapterProcessor.java:97) ~[client-adapter.launcher-1.1.5.jar:na]</span><br><span class="line">        at java.util.concurrent.CopyOnWriteArrayList.forEach(CopyOnWriteArrayList.java:895) ~[na:1.8.0_312]</span><br><span class="line">        at com.alibaba.otter.canal.adapter.launcher.loader.AdapterProcessor.lambda$null$2(AdapterProcessor.java:94) ~[client-adapter.launcher-1.1.5.jar:na]</span><br><span class="line">        at java.util.concurrent.FutureTask.run(FutureTask.java:266) ~[na:1.8.0_312]</span><br><span class="line">        at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149) ~[na:1.8.0_312]</span><br><span class="line">        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624) ~[na:1.8.0_312]</span><br><span class="line">        at java.lang.Thread.run(Thread.java:748) ~[na:1.8.0_312]</span><br><span class="line">Caused by: java.lang.NullPointerException: null</span><br><span class="line">        at com.alibaba.otter.canal.client.adapter.es7x.support.ES7xTemplate.insert(ES7xTemplate.java:79) ~[na:na]</span><br><span class="line">        at com.alibaba.otter.canal.client.adapter.es.core.service.ESSyncService.singleTableSimpleFiledInsert(ESSyncService.java:448) ~[na:na]</span><br><span class="line">        at com.alibaba.otter.canal.client.adapter.es.core.service.ESSyncService.insert(ESSyncService.java:139) ~[na:na]</span><br><span class="line">        at com.alibaba.otter.canal.client.adapter.es.core.service.ESSyncService.sync(ESSyncService.java:99) ~[na:na]</span><br><span class="line">        ... 11 common frames omitted</span><br><span class="line">2022-05-21 06:28:44.449 [Thread-4] ERROR c.a.otter.canal.adapter.launcher.loader.AdapterProcessor - Outer adapter sync failed!  Error sync but ACK!</span><br></pre></td></tr></table></figure>
<p>解决：<br>
1、修改 adapter/application.yml，给 outerAdapters 配置一个 key，注意这里如果有多个 adapter 实例，那么就配置不同的 key</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">canalAdapters:</span><br><span class="line">  - instance: test # canal instance Name or mq topic name</span><br><span class="line">    groups:</span><br><span class="line">    - groupId: g2</span><br><span class="line">      outerAdapters:</span><br><span class="line">#      - name: logger</span><br><span class="line">      - </span><br><span class="line">        key: esKey3 # 配置key</span><br><span class="line">        name: es7 # es6 or es7</span><br><span class="line">        #hosts: http://192.168.101.11:9200 # 集群地址，逗号隔开. 127.0.0.1:9200 for rest mode or 127.0.0.1:9300 for transport mode</span><br><span class="line">        hosts: http://192.168.244.11:9200 # 集群地址，逗号隔开. 127.0.0.1:9200 for rest mode or 127.0.0.1:9300 for transport mode</span><br><span class="line">        properties:</span><br><span class="line">          mode: rest #  rest or transport </span><br><span class="line">          security.auth: elastic:elastic #  only used for rest mode</span><br><span class="line">          cluster.name: blade-cluster</span><br></pre></td></tr></table></figure>
<h1 id="21-canalparseexception-parse-row-data-failed-column-size-is-not-match-for-table"><a class="markdownIt-Anchor" href="#21-canalparseexception-parse-row-data-failed-column-size-is-not-match-for-table">#</a> 21. CanalParseException: parse row data failed. | column size is not match for table</h1>
<p>deployser 日志报错：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">2022-05-21 07:45:15.651 [MultiStageCoprocessor-Parser-fleet-0] ERROR com.alibaba.otter.canal.common.utils.NamedThreadFactory - from MultiStageCoprocessor-Parser-fleet-0</span><br><span class="line">com.alibaba.otter.canal.parse.exception.CanalParseException: com.alibaba.otter.canal.parse.exception.CanalParseException: com.alibaba.otter.canal.parse.exception.CanalParseException: parse row data failed.</span><br><span class="line">Caused by: com.alibaba.otter.canal.parse.exception.CanalParseException: com.alibaba.otter.canal.parse.exception.CanalParseException: parse row data failed.</span><br><span class="line">Caused by: com.alibaba.otter.canal.parse.exception.CanalParseException: parse row data failed.</span><br><span class="line">Caused by: com.alibaba.otter.canal.parse.exception.CanalParseException: column size is not match for table:fleet.source_project_cargo,9 vs 8</span><br></pre></td></tr></table></figure>
<p>解决：<br>
1、可以看到报错中已经给出明确提示了</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">column size is not match for table:fleet.source_project_cargo,9 vs 8</span><br></pre></td></tr></table></figure>
<p>2、该错误官方中有解释<br>
<a target="_blank" rel="noopener" href="https://github.com/alibaba/canal/wiki/TableMetaTSDB">官方文档 TableMetaTSDB</a><br>
 在 instance.properties 中设置</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">canal.instance.tsdb.spring.xml=classpath:spring/tsdb/h2-tsdb.xml</span><br><span class="line"># table meta tsdb info</span><br><span class="line">canal.instance.tsdb.enable=true</span><br><span class="line"># 以下配置不用开启，因为在canal.properties中已经设置过了，只要没有手动关闭过就不用再配置了</span><br><span class="line">#canal.instance.tsdb.dir=$&#123;canal.file.data.dir:../conf&#125;/$&#123;canal.instance.destination:&#125;</span><br><span class="line">#canal.instance.tsdb.url=jdbc:h2:$&#123;canal.instance.tsdb.dir&#125;/h2;CACHE_SIZE=1000;MODE=MYSQL;</span><br><span class="line">#canal.instance.tsdb.url=jdbc:mysql://127.0.0.1:3306/canal_tsdb</span><br><span class="line">#canal.instance.tsdb.dbUsername=canal</span><br><span class="line">#canal.instance.tsdb.dbPassword=canal</span><br></pre></td></tr></table></figure>
<p>3、一般将这个开启就解决了，但是我这里即时将其开启还是报错，查阅相关资料有说将 <code>canal.instance.tsdb.enable</code>  设置为 false 后重启解决的，但是我这里将其设置为 false 后依旧没有解决</p>
<p>实在没有其他办法了，查阅官方 github，导致这个问题发生的原因是因为表结构发生过变化，但是 binlog 中读取到的与现在的表结构不一致导致。</p>
<p>于是直接跳过该 binlog checkpoint，也就是将 binlog 的读取位置设置为当前的最新 binlog 位置</p>
<p>（1）查阅当前 binlog 最新位置，mysql 中执行</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">show master status;</span><br></pre></td></tr></table></figure>
<p><img src="https://img-blog.csdnimg.cn/5a1f009e008d4b4281589f580bef9192.png" alt="在这里插入图片描述"><br>
（2）将读取位置该为最新，修改 deployer conf/example/instance.properties</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">canal.instance.master.address=162.14.99.4:3306</span><br><span class="line">canal.instance.master.journal.name=mysql-bin.000002</span><br><span class="line">canal.instance.master.position=226586328</span><br><span class="line"># 当前时间的时间戳形式</span><br><span class="line">canal.instance.master.timestamp=1653140932</span><br><span class="line">canal.instance.master.gtid=</span><br></pre></td></tr></table></figure>
<p>（3）重启 deployer , adapter<br>
（4）因为读取的是最新的 binlog。为了把当前的数据同步进来，将需要同步的表或库导出，然后再导入一遍。问题解决（注意：这里的解决方案要谨慎，生产环境因为时时刻刻在产生数据，可行性很低，所以看要么设置一个停机维护来进行实操）</p>
<h1 id="22-use-gtid-and-tablemeta-tsdb-should-be-config-timestamp-0"><a class="markdownIt-Anchor" href="#22-use-gtid-and-tablemeta-tsdb-should-be-config-timestamp-0">#</a> 22. use gtid and TableMeta TSDB should be config timestamp &gt; 0</h1>
<p>在 instance.properties 中设置时间戳</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">canal.instance.master.timestamp=1546272000000</span><br></pre></td></tr></table></figure>
<h1 id="23-runtimeexception-comalibabafastjsonjsonexception-unclosed-string"><a class="markdownIt-Anchor" href="#23-runtimeexception-comalibabafastjsonjsonexception-unclosed-string">#</a> 23. RuntimeException: com.alibaba.fastjson.JSONException: unclosed string</h1>
<p>该错误是因为 sql 中使用了 <code>group_concat</code>  函数，但是该函数默认长度是 1024，超过的会被截取，导致出现了 json 格式的数据格式不正确，没有正确的关闭 json</p>
<p>解决：<br>
1、修改 my.cnf，扩大 group_concat_max_len</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">group_concat_max_len = 102400</span><br></pre></td></tr></table></figure>
<p>2、重启 mysql</p>
<h1 id="24-mysqlsyntaxerrorexception-unknown-column-_v_id-in-where-clause"><a class="markdownIt-Anchor" href="#24-mysqlsyntaxerrorexception-unknown-column-_v_id-in-where-clause">#</a> 24. MySQLSyntaxErrorException: Unknown column ‘_v._id’ in ‘where clause’</h1>
<p>sql 中没有 <code>_id</code>  字段导致，使用 as 将 id 命名别名： <code>select id as _id</code></p>
<h1 id="25-adapter中有同步日志打印但es中数据未同步"><a class="markdownIt-Anchor" href="#25-adapter中有同步日志打印但es中数据未同步">#</a> 25. adapter 中有同步日志打印，但 es 中数据未同步</h1>
<p>我这里出现这个问题是在 canal1.1.6 版本中，原因是 es7 文件夹中的 <code>.yml</code>  文件中书写的 sql 里使用了 `` 将表名括起来，导致未识别，如下所示</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> id,name,age <span class="keyword">from</span> `<span class="keyword">user</span>`</span><br></pre></td></tr></table></figure>
<p>解决：<br>
将 `` 去掉即可</p>
<h2 id="关于我"><a class="markdownIt-Anchor" href="#关于我">#</a> 关于我</h2>
<p>Brath 是一个热爱技术的 Java 程序猿，公众号「InterviewCoder」定期分享有趣有料的精品原创文章！</p>
<p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/%E4%BA%8C%E7%BB%B4%E7%A0%81plus.png" alt="InterviewCoder"></p>
<p>非常感谢各位人才能看到这里，原创不易，文章如果有帮助可以关注、点赞、分享或评论，这都是对我的莫大支持！</p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2020-12-06T10:46:26.000Z" title="2020/12/6 18:46:26">2020-12-06</time>发表</span><span class="level-item"><time dateTime="2023-09-09T23:01:52.000Z" title="2023/9/10 07:01:52">2023-09-10</time>更新</span><span class="level-item">19 分钟读完 (大约2868个字)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2020/12/06/%E3%80%90MYSQL%E3%80%91%E6%B0%B4%E5%B9%B3%E5%88%86%E8%A1%A8%E3%80%81%E5%88%86%E5%BA%93%E5%92%8C%E5%9E%82%E7%9B%B4%E5%88%86%E8%A1%A8%E3%80%81%E5%88%86%E5%BA%93%E5%92%8C%E5%85%AC%E5%85%B1%E8%A1%A8%E7%9A%84%E4%BB%A3%E7%A0%81%E5%AE%9E%E7%8E%B0%E5%92%8C%E8%AE%B2%E8%A7%A3/">【MYSQL】水平分表、分库和垂直分表、分库和公共表的代码实现和讲解</a></p><div class="content"><p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/%E6%89%AB%E7%A0%81_%E6%90%9C%E7%B4%A2%E8%81%94%E5%90%88%E4%BC%A0%E6%92%AD%E6%A0%B7%E5%BC%8F-%E6%A0%87%E5%87%86%E8%89%B2%E7%89%88.png" alt="InterviewCoder"></p>
<h3 id="文章目录"><a class="markdownIt-Anchor" href="#文章目录">#</a> 文章目录</h3>
<ul>
<li><a href="#_1">一、教学讲解视频</a></li>
<li><a href="#_3">二、环境准备</a></li>
<li><a href="#_99">三、水平分表</a></li>
<li>
<ul>
<li><a href="#1_100">1. 概念</a></li>
<li><a href="#2_114">2. 代码</a></li>
</ul>
</li>
<li><a href="#_221">四、水平分库</a></li>
<li>
<ul>
<li><a href="#1_223">1. 概念</a></li>
<li><a href="#2_229">2. 代码</a></li>
</ul>
</li>
<li><a href="#_351">五、垂直分表</a></li>
<li>
<ul>
<li><a href="#1_352">1. 概念</a></li>
<li><a href="#2_356">2. 代码</a></li>
</ul>
</li>
<li><a href="#_358">六、垂直分库</a></li>
<li>
<ul>
<li><a href="#1_359">1. 概念</a></li>
<li><a href="#2_362">2. 代码</a></li>
</ul>
</li>
<li><a href="#_364">七、公共表</a></li>
<li>
<ul>
<li><a href="#1_365">1. 概念</a></li>
<li><a href="#2_367">2. 代码</a></li>
</ul>
</li>
</ul>
<h1 id="一-教学讲解视频"><a class="markdownIt-Anchor" href="#一-教学讲解视频">#</a> 一、教学讲解视频</h1>
<p>教学讲解视频地址：<a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1tx4y1371w">视频地址</a></p>
<h1 id="二-环境准备"><a class="markdownIt-Anchor" href="#二-环境准备">#</a> 二、环境准备</h1>
<ul>
<li>
<p>操作系统：Win10</p>
</li>
<li>
<p>数据库：MySQL5.7</p>
</li>
<li>
<p>JDK：64 位 jdk1.8.0_202</p>
</li>
<li>
<p>应用框架：spring-boot-2.1.3.RELEASE</p>
</li>
<li>
<p>Sharding-JDBC：sharding-jdbc-spring-boot-starter-4.0.0-RC1</p>
</li>
</ul>
<p>对应的 pom.xml 依赖代码</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span> <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">  <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.1.3.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">relativePath</span>/&gt;</span> <span class="comment">&lt;!-- lookup parent from repository --&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.yjq.programmer<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>ShardingJDBC<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">name</span>&gt;</span>ShardingJDBC<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">project.build.sourceEncoding</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">project.build.sourceEncoding</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">maven.compiler.source</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">maven.compiler.source</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">maven.compiler.target</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">maven.compiler.target</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 引入mysql连接依赖 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>mysql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mysql-connector-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.1.6<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">scope</span>&gt;</span>runtime<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 引入sharding-jdbc连接依赖 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.shardingsphere<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>sharding-jdbc-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.0.0-RC1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--引入阿里巴巴druid连接池--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>druid<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.1.19<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 引入测试依赖 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 集成mybatis --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.mybatis.spring.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.3.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 集成junit测试 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.12<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">pluginManagement</span>&gt;</span><span class="comment">&lt;!-- lock down plugins versions to avoid using Maven defaults (may be moved to parent pom) --&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line"></span><br><span class="line">      <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">pluginManagement</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h1 id="三-水平分表"><a class="markdownIt-Anchor" href="#三-水平分表">#</a> 三、水平分表</h1>
<h2 id="1概念"><a class="markdownIt-Anchor" href="#1概念">#</a> 1. 概念</h2>
<p>水平分表是在 <code>同一个</code> 数据库内，把同一个表的数据 <code>按一定规则</code> 拆分到多个 <code>表</code> 中。<br>
因此，目前我在一个数据库中准备了两个表， <code>t_user_1</code>  和 <code>t_user_2</code> ，如下图。<br>
<img src="https://brath.oss-cn-shanghai.aliyuncs.com/pigo/b9b8ccb2a36e4028bb013590fc3e84ea.png" alt="在这里插入图片描述"><br>
表结构：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE `t_user_1` (</span><br><span class="line">  `<span class="built_in">id</span>` bigint(20) NOT NULL,</span><br><span class="line">  `name` varchar(100) DEFAULT NULL,</span><br><span class="line">  `sex` int(2) DEFAULT NULL,</span><br><span class="line">  PRIMARY KEY (`<span class="built_in">id</span>`)</span><br><span class="line">) ENGINE=InnoDB DEFAULT CHARSET=utf8;</span><br></pre></td></tr></table></figure>
<h2 id="2代码"><a class="markdownIt-Anchor" href="#2代码">#</a> 2. 代码</h2>
<p>①我们先来看下我们的 SpringBoot 的 <code>配置文件</code> 代码。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">server.port=8081</span><br><span class="line"><span class="comment">#1800s</span></span><br><span class="line">server.servlet.session.timeout=1800</span><br><span class="line">spring.jackson.time-zone=GMT+8</span><br><span class="line">spring.jackson.date-format=yyyy-MM-<span class="built_in">dd</span> HH:mm:ss</span><br><span class="line"></span><br><span class="line"><span class="comment">#定义数据源</span></span><br><span class="line">spring.shardingsphere.datasource.names=m1</span><br><span class="line"></span><br><span class="line">spring.shardingsphere.datasource.m1.url=jdbc:mysql://127.0.0.1:3306/db_user1?serverTimezone=GMT%2b8&amp;useUnicode=<span class="literal">true</span>&amp;characterEncoding=utf8</span><br><span class="line">spring.shardingsphere.datasource.m1.username=root</span><br><span class="line">spring.shardingsphere.datasource.m1.password=</span><br><span class="line">spring.shardingsphere.datasource.m1.driver‐class‐name=com.mysql.jdbc.Driver</span><br><span class="line">spring.shardingsphere.datasource.m1.type=com.alibaba.druid.pool.DruidDataSource</span><br><span class="line"></span><br><span class="line"><span class="comment"># 指定t_user表的数据分布情况，配置数据节点</span></span><br><span class="line">spring.shardingsphere.sharding.tables.t_user.actual‐data‐nodes=m1.t_user_$-&gt;&#123;1..2&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 指定t_user表的主键生成策略为SNOWFLAKE</span></span><br><span class="line">spring.shardingsphere.sharding.tables.t_user.key‐generator.column=<span class="built_in">id</span></span><br><span class="line">spring.shardingsphere.sharding.tables.t_user.key‐generator.type=SNOWFLAKE</span><br><span class="line"></span><br><span class="line"><span class="comment"># 指定t_user表的分表策略，分表策略包括分片键和分片算法</span></span><br><span class="line">spring.shardingsphere.sharding.tables.t_user.table‐strategy.inline.sharding‐column=<span class="built_in">id</span></span><br><span class="line">spring.shardingsphere.sharding.tables.t_user.table‐strategy.inline.algorithm‐expression=t_user_$-&gt;&#123;<span class="built_in">id</span> % 2 + 1&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 控制台日志配置</span></span><br><span class="line">logging.level.root=info</span><br><span class="line">logging.level.com.yjq.programmer.dao=debug</span><br><span class="line"></span><br><span class="line"><span class="comment"># 打开sql输出日志</span></span><br><span class="line">spring.shardingsphere.props.sql.show=<span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#mapper文件扫描路径</span></span><br><span class="line">mybatis.mapper-locations=classpath*:mappers/**/*.xml</span><br></pre></td></tr></table></figure>
<ul>
<li>首先定义数据源 m1，并对 m1 进行实际的参数配置。</li>
<li>指定 t_user 表的数据分布情况，他分布在 m1.t_user_1，m1.t_user_2。</li>
<li>指定 t_user 表的主键生成策略为 SNOWFLAKE，SNOWFLAKE 是一种分布式自增算法，保证 id 全局唯一。</li>
<li>定义 t_user 分表策略，id 为偶数的数据落在 t_user_1，为奇数的落在 t_user_2，所以分表策略的表达式为 t_user_$-&gt;{id% 2 + 1}。</li>
</ul>
<p><strong>踩坑注意！</strong> 如果启动项目有如下报错，可能是配置文件中的 <code>-&gt;</code>  没有用英文类型的。<br>
<img src="https://brath.oss-cn-shanghai.aliyuncs.com/pigo/1b3e0aca06df43c4bb2671eabc7a2e9d.png" alt="在这里插入图片描述"><br>
<img src="https://brath.oss-cn-shanghai.aliyuncs.com/pigo/9a9e406ab2bd4e3db3c55aac18a9b178.png" alt="在这里插入图片描述"></p>
<p>②然后接下来就写我们的 <code>dao</code>  层、 <code>mapper</code>  层和 <code>单元测试</code> 的代码，去测试我们的水平分表情况下 <code>插入</code> 和 <code>查询</code> 的结果。</p>
<p><code>dao</code>  层</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">public interface UserDao &#123;</span><br><span class="line"></span><br><span class="line">    int insertUser(User user);</span><br><span class="line"></span><br><span class="line">    List&lt;User&gt; selectUser();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>mapper</code>  层</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span><br><span class="line">&lt;!DOCTYPE mapper PUBLIC <span class="string">&quot;-//mybatis.org//DTD Mapper 3.0//EN&quot;</span> <span class="string">&quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;</span>&gt;</span><br><span class="line">&lt;mapper namespace=<span class="string">&quot;com.yjq.programmer.dao.UserDao&quot;</span>&gt;</span><br><span class="line"></span><br><span class="line">    &lt;insert <span class="built_in">id</span>=<span class="string">&quot;insertUser&quot;</span> parameterType=<span class="string">&quot;com.yjq.programmer.entity.User&quot;</span>&gt;</span><br><span class="line">        insert into t_user(name) values (<span class="comment">#&#123;name&#125;)</span></span><br><span class="line">    &lt;/insert&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &lt;select <span class="built_in">id</span>=<span class="string">&quot;selectUser&quot;</span> resultType=<span class="string">&quot;com.yjq.programmer.entity.User&quot;</span>&gt;</span><br><span class="line">        select * from t_user</span><br><span class="line">    &lt;/select&gt;</span><br><span class="line">&lt;/mapper&gt;</span><br><span class="line">12345678910111213</span><br><span class="line">单元测试</span><br><span class="line">@Test</span><br><span class="line">public void <span class="function"><span class="title">testShardingJDBCInsert</span></span>() &#123;</span><br><span class="line">    User user = new User();</span><br><span class="line">    <span class="keyword">for</span>(int i=0; i&lt;10; i++) &#123;</span><br><span class="line">        user.setName(<span class="string">&quot;小明&quot;</span> + i);</span><br><span class="line">        <span class="keyword">if</span>(userDao.insertUser(user) == 1) &#123;</span><br><span class="line">            logger.info(<span class="string">&quot;插入成功！&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            logger.info(<span class="string">&quot;插入失败！&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">@Test</span><br><span class="line">public void <span class="function"><span class="title">testShardingJDBCSelect</span></span>() &#123;</span><br><span class="line">    List&lt;User&gt; userList = userDao.selectUser();</span><br><span class="line">    logger.info(<span class="string">&quot;查询结果：&#123;&#125;&quot;</span>, JSONObject.toJSONString(userList));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>③结果说明<br>
 <code>插入</code> <br>
 id 为奇数的被插入到 t_user_2 表，为偶数的被插入到 t_user_1 表，达到预期目标。<br>
 <code>查询</code> <br>
<a target="_blank" rel="noopener" href="https://so.csdn.net/so/search?q=sharding-jdbc&amp;spm=1001.2101.3001.7020"> sharding-jdbc</a> 分别去不同的表检索数据，达到预期目标；<strong>如果有传入 id 进行查询，sharding-jdbc 也会根据 t_user 的分表策略去不同的表检索数据</strong>。</p>
<h1 id="四-水平分库"><a class="markdownIt-Anchor" href="#四-水平分库">#</a> 四、水平分库</h1>
<h2 id="1概念-2"><a class="markdownIt-Anchor" href="#1概念-2">#</a> 1. 概念</h2>
<p>水平分库是把同一个表的数据按 <code>一定规则</code> 拆分到不同的 <code>数据库</code> 中，每个库可以放在不同的服务器上。<br>
现在，我在 <code>水平分表</code> 的基础上多加了一个 db_user2 的数据库。<br>
<img src="https://brath.oss-cn-shanghai.aliyuncs.com/pigo/80d1a3af2700414b9a0850ae9172034a.png" alt="在这里插入图片描述"><br>
然后两个数据库中的表结构是一致的，表结构和上面水平分表用的保持一样。<br>
<img src="https://brath.oss-cn-shanghai.aliyuncs.com/pigo/9354ea1b1af043238412581e0769b3dd.png" alt="在这里插入图片描述"></p>
<h2 id="2代码-2"><a class="markdownIt-Anchor" href="#2代码-2">#</a> 2. 代码</h2>
<p>①我们先来看下我们的 SpringBoot 的 <code>配置文件</code> 代码。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">server.port=8081</span><br><span class="line"><span class="comment">#1800s</span></span><br><span class="line">server.servlet.session.timeout=1800</span><br><span class="line">spring.jackson.time-zone=GMT+8</span><br><span class="line">spring.jackson.date-format=yyyy-MM-<span class="built_in">dd</span> HH:mm:ss</span><br><span class="line"></span><br><span class="line"><span class="comment">#定义数据源</span></span><br><span class="line">spring.shardingsphere.datasource.names=m1,m2</span><br><span class="line"></span><br><span class="line">spring.shardingsphere.datasource.m1.url=jdbc:mysql://127.0.0.1:3306/db_user1?serverTimezone=GMT%2b8&amp;useUnicode=<span class="literal">true</span>&amp;characterEncoding=utf8</span><br><span class="line">spring.shardingsphere.datasource.m1.username=root</span><br><span class="line">spring.shardingsphere.datasource.m1.password=</span><br><span class="line">spring.shardingsphere.datasource.m1.driver‐class‐name=com.mysql.jdbc.Driver</span><br><span class="line">spring.shardingsphere.datasource.m1.type=com.alibaba.druid.pool.DruidDataSource</span><br><span class="line"></span><br><span class="line">spring.shardingsphere.datasource.m2.url=jdbc:mysql://127.0.0.1:3306/db_user2?serverTimezone=GMT%2b8&amp;useUnicode=<span class="literal">true</span>&amp;characterEncoding=utf8</span><br><span class="line">spring.shardingsphere.datasource.m2.username=root</span><br><span class="line">spring.shardingsphere.datasource.m2.password=</span><br><span class="line">spring.shardingsphere.datasource.m2.driver‐class‐name=com.mysql.jdbc.Driver</span><br><span class="line">spring.shardingsphere.datasource.m2.type=com.alibaba.druid.pool.DruidDataSource</span><br><span class="line"></span><br><span class="line"><span class="comment"># 分库策略</span></span><br><span class="line">spring.shardingsphere.sharding.tables.t_user.database‐strategy.inline.sharding‐column=sex</span><br><span class="line">spring.shardingsphere.sharding.tables.t_user.database‐strategy.inline.algorithm‐expression=m$-&gt;&#123;sex % 2 + 1&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 指定t_user表的数据分布情况，配置数据节点</span></span><br><span class="line">spring.shardingsphere.sharding.tables.t_user.actual‐data‐nodes=m$-&gt;&#123;1..2&#125;.t_user_$-&gt;&#123;1..2&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 指定t_user表的主键生成策略为SNOWFLAKE</span></span><br><span class="line">spring.shardingsphere.sharding.tables.t_user.key‐generator.column=<span class="built_in">id</span></span><br><span class="line">spring.shardingsphere.sharding.tables.t_user.key‐generator.type=SNOWFLAKE</span><br><span class="line"></span><br><span class="line"><span class="comment"># 指定t_user表的分表策略，分表策略包括分片键和分片算法</span></span><br><span class="line">spring.shardingsphere.sharding.tables.t_user.table‐strategy.inline.sharding‐column=<span class="built_in">id</span></span><br><span class="line">spring.shardingsphere.sharding.tables.t_user.table‐strategy.inline.algorithm‐expression=t_user_$-&gt;&#123;<span class="built_in">id</span> % 2 + 1&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 控制台日志配置</span></span><br><span class="line">logging.level.root=info</span><br><span class="line">logging.level.com.yjq.programmer.dao=debug</span><br><span class="line"></span><br><span class="line"><span class="comment"># 打开sql输出日志</span></span><br><span class="line">spring.shardingsphere.props.sql.show=<span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#mapper文件扫描路径</span></span><br><span class="line">mybatis.mapper-locations=classpath*:mappers/**/*.xml</span><br></pre></td></tr></table></figure>
<ul>
<li>配置了两个数据源，分配指向两个不同的数据库 db_user1 和 db_user2。</li>
<li>配置分库策略，sex 字段为偶数的数据落在 m1 数据源，为奇数的落在 m2 数据源，所以分库策略的表达式为 m$-&gt;{sex % 2 + 1}。</li>
<li>配置分表策略，分表策略和上面水平分表保持一致。</li>
<li>也就是当有数据来时，先根据 sex 字段判断落入哪个数据源，然后再根据 id 字段来判断落入哪个表中。</li>
</ul>
<p>②然后接下来就写我们的 <code>dao</code>  层、 <code>mapper</code>  层和 <code>单元测试</code> 的代码，去测试我们的水平分表情况下 <code>插入</code> 和 <code>查询</code> 的结果。</p>
<p><code>dao</code>  层</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">public interface UserDao &#123;</span><br><span class="line"></span><br><span class="line">    int insertUser(User user);</span><br><span class="line"></span><br><span class="line">    List&lt;User&gt; selectUser(User user);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>mapper</code>  层</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span><br><span class="line">&lt;!DOCTYPE mapper PUBLIC <span class="string">&quot;-//mybatis.org//DTD Mapper 3.0//EN&quot;</span> <span class="string">&quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;</span>&gt;</span><br><span class="line">&lt;mapper namespace=<span class="string">&quot;com.yjq.programmer.dao.UserDao&quot;</span>&gt;</span><br><span class="line"></span><br><span class="line">    &lt;insert <span class="built_in">id</span>=<span class="string">&quot;insertUser&quot;</span> parameterType=<span class="string">&quot;com.yjq.programmer.entity.User&quot;</span>&gt;</span><br><span class="line">        insert into t_user(name, sex) values (<span class="comment">#&#123;name&#125;, #&#123;sex&#125;)</span></span><br><span class="line">    &lt;/insert&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &lt;select <span class="built_in">id</span>=<span class="string">&quot;selectUser&quot;</span> parameterType=<span class="string">&quot;com.yjq.programmer.entity.User&quot;</span> resultType=<span class="string">&quot;com.yjq.programmer.entity.User&quot;</span>&gt;</span><br><span class="line">        select * from t_user t <span class="built_in">where</span> t.sex = <span class="comment">#&#123;sex&#125; and t.id = #&#123;id&#125;</span></span><br><span class="line">    &lt;/select&gt;</span><br><span class="line">&lt;/mapper&gt;</span><br><span class="line">12345678910111213</span><br><span class="line">单元测试</span><br><span class="line">@Test</span><br><span class="line">public void <span class="function"><span class="title">testShardingJDBCInsert</span></span>() &#123;</span><br><span class="line">    User user = new User();</span><br><span class="line">    <span class="keyword">for</span>(int i=0; i&lt;10; i++) &#123;</span><br><span class="line">        user.setName(<span class="string">&quot;小明&quot;</span> + i);</span><br><span class="line">        user.setSex(1);</span><br><span class="line">        <span class="keyword">if</span>(userDao.insertUser(user) == 1) &#123;</span><br><span class="line">            logger.info(<span class="string">&quot;插入成功！&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            logger.info(<span class="string">&quot;插入失败！&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">@Test</span><br><span class="line">public void <span class="function"><span class="title">testShardingJDBCSelect</span></span>() &#123;</span><br><span class="line">    User user = new User();</span><br><span class="line">    user.setSex(1);</span><br><span class="line">    user.setId(821357967667363840L);</span><br><span class="line">    List&lt;User&gt; userList = userDao.selectUser(user);</span><br><span class="line">    logger.info(<span class="string">&quot;查询结果：&#123;&#125;&quot;</span>, JSONObject.toJSONString(userList));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>③结果说明<br>
 <code>插入</code> <br>
 sex 字段为奇数的数据落入 m2 数据源，为偶数的落入 m1 数据源。同时 id 字段值为奇数的，插入 t_user_2 表中，为偶数的插入 t_user_1 表中，达到预期目标。<br>
 <code>查询</code> <br>
 sharding-jdbc 分别去不同的表检索数据，达到预期目标；<strong>如果有传入 sex 进行查询，sharding-jdbc 会根据 t_user 的分库策略去锁定查哪个库，如果有传入 id 进行查询，sharding-jdbc 会根据 t_user 的分表策略去锁定查哪个表</strong>。</p>
<h1 id="五-垂直分表"><a class="markdownIt-Anchor" href="#五-垂直分表">#</a> 五、垂直分表</h1>
<h2 id="1概念-3"><a class="markdownIt-Anchor" href="#1概念-3">#</a> 1. 概念</h2>
<p>垂直分表一般就是把表的结构进行改造，关于如何改造，可以浏览我的另一篇博客：<br>
<a target="_blank" rel="noopener" href="https://blog.csdn.net/dgfdhgghd/article/details/128426013">分库分表：垂直分库、垂直分表、水平分库、水平分表四个概念</a><br>
<strong>大致的思路就是：将一个表按照字段分成多表，每个表存储其中一部分字段。</strong></p>
<h2 id="2代码-3"><a class="markdownIt-Anchor" href="#2代码-3">#</a> 2. 代码</h2>
<p>无代码，垂直分表属于表结构设计层面。</p>
<h1 id="六-垂直分库"><a class="markdownIt-Anchor" href="#六-垂直分库">#</a> 六、垂直分库</h1>
<h2 id="1概念-4"><a class="markdownIt-Anchor" href="#1概念-4">#</a> 1. 概念</h2>
<p>垂直分库就是在 <code>垂直分表</code> 把表进行分类后，放到 <code>不同的数据库</code> 中。每个库可以放在不同的服务器上，它的核心理念是 <code>专库专用</code> 。关于如何改造，同样可以浏览我的另一篇博客：<br>
<a target="_blank" rel="noopener" href="https://blog.csdn.net/dgfdhgghd/article/details/128426013">分库分表：垂直分库、垂直分表、水平分库、水平分表四个概念</a></p>
<h2 id="2代码-4"><a class="markdownIt-Anchor" href="#2代码-4">#</a> 2. 代码</h2>
<p>无代码，垂直分库属于数据库设计层面。</p>
<h1 id="七-公共表"><a class="markdownIt-Anchor" href="#七-公共表">#</a> 七、公共表</h1>
<h2 id="1概念-5"><a class="markdownIt-Anchor" href="#1概念-5">#</a> 1. 概念</h2>
<p>公共表属于系统中数据量较小，变动少，而且属于高频联合查询的依赖表。参数表、数据字典表等属于此类型。 <code>可以将这类表在每个数据库都保存一份</code> ，所有更新操作都同时发送到所有分库执行。</p>
<h2 id="2代码-5"><a class="markdownIt-Anchor" href="#2代码-5">#</a> 2. 代码</h2>
<p>①只需要在 SpringBoot 的 <code>配置文件</code> 中加入下面这行来指明公共表就行。<br>
 <code>如果有多个公共表，用逗号拼接就行</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#公共表设置</span></span><br><span class="line">spring.shardingsphere.sharding.broadcast‐tables=t_dict</span><br><span class="line">12</span><br></pre></td></tr></table></figure>
<p>②然后接下来就写我们的 <code>dao</code>  层、 <code>mapper</code>  层和 <code>单元测试</code> 的代码，去测试我们的公共表的 <code>插入</code> 的结果。<br>
 <code>dao</code>  层</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">public interface DictDao &#123;</span><br><span class="line"></span><br><span class="line">    int insertDict(Dict dict);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>mapper</code>  层</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span><br><span class="line">&lt;!DOCTYPE mapper PUBLIC <span class="string">&quot;-//mybatis.org//DTD Mapper 3.0//EN&quot;</span> <span class="string">&quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;</span>&gt;</span><br><span class="line">&lt;mapper namespace=<span class="string">&quot;com.yjq.programmer.dao.DictDao&quot;</span>&gt;</span><br><span class="line"></span><br><span class="line">    &lt;insert <span class="built_in">id</span>=<span class="string">&quot;insertDict&quot;</span> parameterType=<span class="string">&quot;com.yjq.programmer.entity.Dict&quot;</span>&gt;</span><br><span class="line">        insert into t_dict(<span class="built_in">id</span>, name) values (<span class="comment">#&#123;id&#125;, #&#123;name&#125;)</span></span><br><span class="line">    &lt;/insert&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&lt;/mapper&gt;</span><br><span class="line">12345678910</span><br><span class="line">单元测试</span><br><span class="line">@Test</span><br><span class="line">public void <span class="function"><span class="title">testShardingJDBCInsertDict</span></span>() &#123;</span><br><span class="line">    Dict dict = new Dict();</span><br><span class="line">    dict.setId(1);</span><br><span class="line">    dict.setName(<span class="string">&quot;字典名称&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span>(dictDao.insertDict(dict) == 1) &#123;</span><br><span class="line">        logger.info(<span class="string">&quot;插入成功！&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        logger.info(<span class="string">&quot;插入失败！&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>③结果说明<br>
 <code>插入</code> <br>
插入的数据在 <code>每个库中的对应的公共表</code> 中都能看到，达到预期目标。</p>
<h2 id="关于我"><a class="markdownIt-Anchor" href="#关于我">#</a> 关于我</h2>
<p>Brath 是一个热爱技术的 Java 程序猿，公众号「InterviewCoder」定期分享有趣有料的精品原创文章！</p>
<p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/%E4%BA%8C%E7%BB%B4%E7%A0%81plus.png" alt="InterviewCoder"></p>
<p>非常感谢各位人才能看到这里，原创不易，文章如果有帮助可以关注、点赞、分享或评论，这都是对我的莫大支持！</p>
</div></article></div><nav class="pagination" role="navigation" aria-label="pagination"><div class="pagination-previous"><a href="/page/13/">上一页</a></div><div class="pagination-next is-invisible is-hidden-mobile"><a href="/page/15/">下一页</a></div><ul class="pagination-list is-hidden-mobile"><li><a class="pagination-link" href="/">1</a></li><li><span class="pagination-ellipsis">&hellip;</span></li><li><a class="pagination-link" href="/page/13/">13</a></li><li><a class="pagination-link is-current" href="/page/14/">14</a></li></ul></nav></div><div class="column column-left is-4-tablet is-4-desktop is-3-widescreen  order-1"><!--!--><div class="card widget" data-type="recent-posts"><div class="card-content"><h3 class="menu-label">最新文章</h3><article class="media"><div class="media-content"><p class="date"><time dateTime="2023-05-05T01:57:09.000Z">2023-05-05</time></p><p class="title"><a href="/2023/05/05/%E3%80%90IDEA%E3%80%91IDEA%E7%9A%84debug%E8%B0%83%E8%AF%95%E6%8A%80%E5%B7%A7%E8%AF%A6%E8%A7%A3/">【IDEA】IDEA的debug调试技巧详解</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2023-04-29T11:42:37.000Z">2023-04-29</time></p><p class="title"><a href="/2023/04/29/%E3%80%90%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F%E3%80%9123%20%E7%A7%8D%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F%E8%AF%A6%E8%A7%A3%EF%BC%88%E5%85%A823%E7%A7%8D%EF%BC%89/">【设计模式】23 种设计模式详解（全23种）</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2023-04-27T09:20:49.000Z">2023-04-27</time></p><p class="title"><a href="/2023/04/27/%E3%80%90Dubbo%E3%80%91Dubbo%E8%AF%A6%E8%A7%A3%EF%BC%8C%E7%94%A8%E5%BF%83%E7%9C%8B%E8%BF%99%E4%B8%80%E7%AF%87%E6%96%87%E7%AB%A0%E5%B0%B1%E5%A4%9F%E4%BA%86%E3%80%90%E9%87%8D%E7%82%B9%E3%80%91/">【Dubbo】Dubbo详解，用心看这一篇文章就够了【重点】</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2023-04-27T09:20:49.000Z">2023-04-27</time></p><p class="title"><a href="/2023/04/27/%E3%80%90MySql%E3%80%9121%E4%B8%AAMySQL%E8%A1%A8%E8%AE%BE%E8%AE%A1%E7%9A%84%E7%BB%8F%E9%AA%8C%E5%87%86%E5%88%99/">【MySql】21个MySQL表设计的经验准则</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2023-04-27T09:20:49.000Z">2023-04-27</time></p><p class="title"><a href="/2023/04/27/%E3%80%90Zookeeper%E3%80%91Zookeeper%E5%85%A5%E9%97%A8%E7%9C%8B%E8%BF%99%E7%AF%87%E5%B0%B1%E5%A4%9F%E4%BA%86/">【Zookeeper】Zookeeper入门看这篇就够了</a></p></div></article></div></div><div class="card widget" data-type="archives"><div class="card-content"><div class="menu"><h3 class="menu-label">归档</h3><ul class="menu-list"><li><a class="level is-mobile" href="/archives/2023/"><span class="level-start"><span class="level-item">2023</span></span><span class="level-end"><span class="level-item tag">32</span></span></a></li><li><a class="level is-mobile" href="/archives/2022/"><span class="level-start"><span class="level-item">2022</span></span><span class="level-end"><span class="level-item tag">52</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/"><span class="level-start"><span class="level-item">2021</span></span><span class="level-end"><span class="level-item tag">44</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/"><span class="level-start"><span class="level-item">2020</span></span><span class="level-end"><span class="level-item tag">7</span></span></a></li></ul></div></div></div><!--!--><div class="card widget" data-type="profile"><div class="card-content"><nav class="level"><div class="level-item has-text-centered flex-shrink-1"><div><figure class="image is-128x128 mx-auto mb-2"><img class="avatar" src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/%E4%BA%8C%E7%BB%B4%E7%A0%81plus.png" alt="InterviewCoder"></figure><p class="title is-size-4 is-block" style="line-height:inherit;">InterviewCoder</p><p class="is-size-6 is-block">面试记官方公众号</p></div></div></nav><nav class="level is-mobile"><div class="level-item has-text-centered is-marginless"><div><p class="heading">文章</p><a href="/archives"><p class="title">135</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">分类</p><a href="/categories"><p class="title">0</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">标签</p><a href="/tags"><p class="title">0</p></a></div></div></nav><div class="level"><a class="level-item button is-primary is-rounded" href="https://mp.weixin.qq.com/s/jWs6lLHl5L-atXJhHc4YvA" target="_blank" rel="noopener">关注我</a></div></div></div><div class="column-right-shadow is-hidden-widescreen"></div></div><div class="column column-right is-4-tablet is-4-desktop is-3-widescreen is-hidden-touch is-hidden-desktop-only order-3"><div class="card widget" data-type="profile"><div class="card-content"><nav class="level"><div class="level-item has-text-centered flex-shrink-1"><div><figure class="image is-128x128 mx-auto mb-2"><img class="avatar is-rounded" src="https://brath.cloud/me.png" alt="Brath"></figure><p class="title is-size-4 is-block" style="line-height:inherit;">Brath</p><p class="is-size-6 is-block">技能改变人生，知识改变命运。</p><p class="is-size-6 is-flex justify-content-center"><i class="fas fa-map-marker-alt mr-1"></i><span>中国·江苏·无锡</span></p></div></div></nav><nav class="level is-mobile"><div class="level-item has-text-centered is-marginless"><div><p class="heading">文章</p><a href="/archives"><p class="title">135</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">分类</p><a href="/categories"><p class="title">0</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">标签</p><a href="/tags"><p class="title">0</p></a></div></div></nav><div class="level"><a class="level-item button is-primary is-rounded" href="https://github.com/Guoqing815" target="_blank" rel="noopener">关注我</a></div><div class="level is-mobile is-multiline"><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Github" href="https://github.com/Guoqing815"><i class="fab fa-github"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Gitee" href="https://gitee.com/Guoqing-Li"><i class="fab fa-gitee"></i></a></div></div></div><!--!--><div class="card widget" data-type="links"><div class="card-content"><div class="menu"><h3 class="menu-label">链接</h3><ul class="menu-list"><li><a class="level is-mobile" href="https://schokolade.cn/" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">泠灵(特别呜谢)</span></span><span class="level-right"><span class="level-item tag">schokolade.cn</span></span></a></li><li><a class="level is-mobile" href="https://gitee.com/Guoqing-Li" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">Gitee(码云)</span></span><span class="level-right"><span class="level-item tag">gitee.com</span></span></a></li><li><a class="level is-mobile" href="https://blog.csdn.net/Brath?type=blog" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">CSDN</span></span><span class="level-right"><span class="level-item tag">blog.csdn.net</span></span></a></li><li><a class="level is-mobile" href="https://juejin.cn/user/settings/profile" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">掘金</span></span><span class="level-right"><span class="level-item tag">juejin.cn</span></span></a></li><li><a class="level is-mobile" href="https://oss.console.aliyun.com/" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">AliCloud(阿里云)</span></span><span class="level-right"><span class="level-item tag">oss.console.aliyun.com</span></span></a></li><li><a class="level is-mobile" href="https://cloud.tencent.com/" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">TencentCloud(腾讯云)</span></span><span class="level-right"><span class="level-item tag">cloud.tencent.com</span></span></a></li><li><a class="level is-mobile" href="https://www.zhipin.com/web/user/" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">BOSS</span></span><span class="level-right"><span class="level-item tag">www.zhipin.com</span></span></a></li><li><a class="level is-mobile" href="https://www.bilibili.com/" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">Bilibili(B站)</span></span><span class="level-right"><span class="level-item tag">www.bilibili.com</span></span></a></li></ul></div></div></div></div></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/"><img src="https://brath.cloud/me.png" alt="Brath-Blog" height="28"></a><p class="is-size-7"><span>&copy; 2023 Brath</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a><br><span id="busuanzi_container_site_uv">共<span id="busuanzi_value_site_uv">0</span>个访客</span></p><p class="is-size-7">© 2029</p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Attribution 4.0 International" href="https://creativecommons.org/licenses/by/4.0/"><i class="fab fa-creative-commons-by"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/ppoffice/hexo-theme-icarus"><i class="fab fa-github"></i></a></p></div></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script><script>moment.locale("zh-cn");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="/js/column.js"></script><script src="/js/animation.js"></script><a id="back-to-top" title="回到顶端" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><!--!--><!--!--><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.js" defer></script><script>window.addEventListener("load", () => {
      window.cookieconsent.initialise({
        type: "info",
        theme: "edgeless",
        static: false,
        position: "bottom-left",
        content: {
          message: "此网站使用Cookie来改善您的体验。",
          dismiss: "知道了！",
          allow: "允许使用Cookie",
          deny: "拒绝",
          link: "了解更多",
          policy: "Cookie政策",
          href: "https://www.cookiesandyou.com/",
        },
        palette: {
          popup: {
            background: "#edeff5",
            text: "#838391"
          },
          button: {
            background: "#4b81e8"
          },
        },
      });
    });</script><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><!--!--><!--!--><!--!--><script src="/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="想要查找什么..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"想要查找什么...","untitled":"(无标题)","posts":"文章","pages":"页面","categories":"分类","tags":"标签"});
        });</script></body></html>