<!doctype html>
<html lang="zh"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta><title>Brath-Blog</title><link rel="manifest" href="/manifest.json"><meta name="application-name" content="Brath-Blog"><meta name="msapplication-TileImage" content="https://brath.cloud/avatar.png"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="Brath-Blog"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta property="og:type" content="blog"><meta property="og:title" content="Brath-Blog"><meta property="og:url" content="http://example.com/"><meta property="og:site_name" content="Brath-Blog"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="http://example.com/img/og_image.png"><meta property="article:author" content="Brath"><meta property="twitter:card" content="summary"><meta property="twitter:image:src" content="http://example.com/img/og_image.png"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"http://example.com"},"headline":"Brath-Blog","image":["http://example.com/img/og_image.png"],"author":{"@type":"Person","name":"Brath"},"publisher":{"@type":"Organization","name":"Brath-Blog","logo":{"@type":"ImageObject","url":"https://brath.cloud/avatar.png"}},"description":""}</script><link rel="icon" href="https://brath.cloud/avatar.png"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v6.0.0/css/all.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/atom-one-light.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><!--!--><!--!--><script src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" defer></script><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/css/justifiedGallery.min.css"><!--!--><!--!--><style>.pace{-webkit-pointer-events:none;pointer-events:none;-webkit-user-select:none;-moz-user-select:none;user-select:none}.pace-inactive{display:none}.pace .pace-progress{background:#3273dc;position:fixed;z-index:2000;top:0;right:100%;width:100%;height:2px}</style><script src="https://cdn.jsdelivr.net/npm/pace-js@1.2.4/pace.min.js"></script><!--!--><!--!--><!-- hexo injector head_end start --><script>
  (function () {
      function switchTab() {
          if (!location.hash) {
            return;
          }

          const id = '#' + CSS.escape(location.hash.substring(1));
          const $tabMenu = document.querySelector(`.tabs a[href="${id}"]`);
          if (!$tabMenu) {
            return;
          }

          const $tabMenuContainer = $tabMenu.parentElement.parentElement;
          Array.from($tabMenuContainer.children).forEach($menu => $menu.classList.remove('is-active'));
          Array.from($tabMenuContainer.querySelectorAll('a'))
              .map($menu => document.getElementById($menu.getAttribute("href").substring(1)))
              .forEach($content => $content.classList.add('is-hidden'));

          if ($tabMenu) {
              $tabMenu.parentElement.classList.add('is-active');
          }
          const $activeTab = document.querySelector(id);
          if ($activeTab) {
              $activeTab.classList.remove('is-hidden');
          }
      }
      switchTab();
      window.addEventListener('hashchange', switchTab, false);
  })();
  </script><!-- hexo injector head_end end --><meta name="generator" content="Hexo 6.3.0"></head><body class="is-3-column"><nav class="navbar navbar-main"><div class="container navbar-container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="https://brath.cloud/avatar.png" alt="Brath-Blog" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">主页</a><a class="navbar-item" href="/archives">文章列表</a><a class="navbar-item" href="/tags">标签</a><a class="navbar-item" href="/about">更多</a></div><div class="navbar-end"><a class="navbar-item" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/Guoqing815"><i class="fab fa-github"></i></a><a class="navbar-item search" title="搜索" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-6-widescreen"><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2021-08-15T04:38:35.000Z" title="2021-8-15 12:38:35">2021-08-15</time>发表</span><span class="level-item"><time dateTime="2019-10-07T04:13:52.000Z" title="2019-10-7 12:13:52">2019-10-07</time>更新</span><span class="level-item">8 分钟读完 (大约1260个字)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2021/08/15/%E3%80%90Mysql%E3%80%91Mysql%E5%88%A0%E9%99%A4%E9%87%8D%E5%A4%8D%E6%95%B0%E6%8D%AE%E5%8F%AA%E4%BF%9D%E7%95%99%E4%B8%80%E6%9D%A1/">【Mysql】Mysql删除重复数据只保留一条</a></p><div class="content"><p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/%E6%89%AB%E7%A0%81_%E6%90%9C%E7%B4%A2%E8%81%94%E5%90%88%E4%BC%A0%E6%92%AD%E6%A0%B7%E5%BC%8F-%E6%A0%87%E5%87%86%E8%89%B2%E7%89%88.png" alt="InterviewCoder"></p>
<h1 id="mysqlmysql删除重复数据只保留一条"><a class="markdownIt-Anchor" href="#mysqlmysql删除重复数据只保留一条">#</a> 【Mysql】Mysql 删除重复数据只保留一条</h1>
<p><strong>（1）以这张表为例：</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `test`  (</span><br><span class="line">  `id` <span class="type">varchar</span>(<span class="number">32</span>) <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8 <span class="keyword">COLLATE</span> utf8_general_ci <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;注解id&#x27;</span>,</span><br><span class="line">  `name` <span class="type">varchar</span>(<span class="number">255</span>) <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8 <span class="keyword">COLLATE</span> utf8_general_ci <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;名字&#x27;</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> KEY (`id`) <span class="keyword">USING</span> BTREE</span><br><span class="line">) ENGINE <span class="operator">=</span> InnoDB <span class="type">CHARACTER</span> <span class="keyword">SET</span> <span class="operator">=</span> utf8 <span class="keyword">COLLATE</span> <span class="operator">=</span> utf8_general_ci ROW_FORMAT <span class="operator">=</span> Compact;</span><br><span class="line"></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> test (id,`name`) <span class="keyword">VALUES</span> (replace(uuid(),<span class="string">&#x27;-&#x27;</span>,<span class="string">&#x27;&#x27;</span>),<span class="string">&#x27;张三&#x27;</span>),(replace(uuid(),<span class="string">&#x27;-&#x27;</span>,<span class="string">&#x27;&#x27;</span>),<span class="string">&#x27;张三&#x27;</span>);</span><br></pre></td></tr></table></figure>
<p>表里有两条数据，然后名字是相同的，但是 id 是不同的，现在要求是只留一条数据：</p>
<p><img src="https://img-blog.csdnimg.cn/888323c3cc9c4871ac5eeaf2aa7b55a1.png" alt="在这里插入图片描述"></p>
<p><strong>（2）查询 name 值重复的数据：</strong></p>
<blockquote>
<p>现实开发当中可能一个字段无法锁定重复值，可以采取 group by 多个值！利用多个值来锁定重复的行数据！</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> name <span class="keyword">FROM</span> test <span class="keyword">GROUP</span> <span class="keyword">BY</span> `name` <span class="keyword">HAVING</span> <span class="built_in">count</span>( name ) <span class="operator">&gt;</span> <span class="number">1</span></span><br></pre></td></tr></table></figure>
<p><strong>（3）查询重复数据里面每个最小的 id：</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span>  <span class="built_in">min</span>(id) <span class="keyword">as</span> id <span class="keyword">FROM</span> test <span class="keyword">GROUP</span> <span class="keyword">BY</span> `name` <span class="keyword">HAVING</span> <span class="built_in">count</span>( name ) <span class="operator">&gt;</span> <span class="number">1</span></span><br></pre></td></tr></table></figure>
<p><strong>（4）查询去掉重复数据最小 id 的其他数据：也就是要删除的数据！</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> test </span><br><span class="line"><span class="keyword">WHERE</span> name <span class="keyword">IN</span> ( <span class="keyword">SELECT</span> name <span class="keyword">FROM</span> test <span class="keyword">GROUP</span> <span class="keyword">BY</span> `name` <span class="keyword">HAVING</span> <span class="built_in">count</span>( name ) <span class="operator">&gt;</span> <span class="number">1</span> ) </span><br><span class="line"><span class="keyword">AND</span> </span><br><span class="line">id <span class="keyword">NOT</span> <span class="keyword">IN</span> (<span class="keyword">SELECT</span> <span class="built_in">min</span>( id ) <span class="keyword">FROM</span> test <span class="keyword">GROUP</span> <span class="keyword">BY</span> `name` <span class="keyword">HAVING</span> <span class="built_in">count</span>( NAME ) <span class="operator">&gt;</span> <span class="number">1</span>)</span><br></pre></td></tr></table></figure>
<p><strong>（5）删除去掉重复数据最小 id 的其他数据：</strong></p>
<blockquote>
<p>可能这时候有人该说了，有了查询，直接改成 delete 不就可以了，真的是这样吗？其实不是的，如下运行报错：</p>
</blockquote>
<p><img src="https://img-blog.csdnimg.cn/917867c90bfc49fdacf3a1f5e45de26d.png" alt="在这里插入图片描述"></p>
<p>首先明确一点这个错误只会发生在 <code>delete</code>  语句或者 <code>update</code>  语句，拿 update 来举例 :  <code>update A表 set A列 = (select B列 from A表)；</code>  这种写法就会报这个错误，原因：你又要修改 A 表，然后又要从 A 表查数据，而且还是同层级。Mysql 就会认为是语法错误！</p>
<p>嵌套一层就可以解决， <code>update A表 set A列 = (select a.B列 from (select * from A表) a);</code>  当然这个只是个示例，这个示例也存在一定的问题，比如 <code>(select a.B列 from (select * from A表) a)</code>  他会查出来多条，然后赋值的时候会报  <code>1242 - Subquery returns more than 1 row</code> 。</p>
<p>嵌套一层他就可以和 update 撇清关系，会优先查括号里面的内容，查询结果出来过后会给存起来，类似临时表，可能有的人该好奇了， <code>update A表 set A列 = (select B列 from A表)；</code>  我明明加括号了呀，难道不算嵌套吗，当然不算，那个括号根本没有解决他们之间的层次关系！</p>
<p>详解看这篇文章：<a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_43888891/article/details/127000534">https://blog.csdn.net/weixin_43888891/article/details/127000534</a></p>
<p><strong>（6）正确的写法：</strong></p>
<p>方式一：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">DELETE</span> <span class="keyword">FROM</span> test </span><br><span class="line"><span class="keyword">WHERE</span> name <span class="keyword">IN</span> ( <span class="keyword">select</span> a.name <span class="keyword">from</span> (<span class="keyword">SELECT</span> name <span class="keyword">FROM</span> test <span class="keyword">GROUP</span> <span class="keyword">BY</span> `name` <span class="keyword">HAVING</span> <span class="built_in">count</span>( name ) <span class="operator">&gt;</span> <span class="number">1</span>) a) </span><br><span class="line"><span class="keyword">AND</span> </span><br><span class="line">id <span class="keyword">NOT</span> <span class="keyword">IN</span> (<span class="keyword">select</span> a.id <span class="keyword">from</span> (<span class="keyword">SELECT</span>  <span class="built_in">min</span>(id) <span class="keyword">as</span> id <span class="keyword">FROM</span> test <span class="keyword">GROUP</span> <span class="keyword">BY</span> `name` <span class="keyword">HAVING</span> <span class="built_in">count</span>( name ) <span class="operator">&gt;</span> <span class="number">1</span>) a)</span><br></pre></td></tr></table></figure>
<blockquote>
<p><strong> <code>注意：删除之前一定要先查询，然后再删除，否则一旦语法有问题导致删了不想删除的数据，想要恢复很麻烦！或者删除前备份好数据，不要嫌麻烦，一旦出问题，才是真正的大麻烦！</code> </strong></p>
</blockquote>
<p>方式二：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">DELETE</span> <span class="keyword">FROM</span> test </span><br><span class="line"><span class="keyword">WHERE</span></span><br><span class="line">	id <span class="keyword">NOT</span> <span class="keyword">IN</span> (</span><br><span class="line">	<span class="keyword">SELECT</span></span><br><span class="line">		t.id </span><br><span class="line"><span class="keyword">FROM</span></span><br><span class="line">	( <span class="keyword">SELECT</span> <span class="built_in">MIN</span>(id) <span class="keyword">as</span> id <span class="keyword">FROM</span> test <span class="keyword">GROUP</span> <span class="keyword">BY</span> NAME ) t)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><strong>（7）错误的写法：</strong> 这块我吃过一次亏，所以专门写出来，避免踩坑！</p>
<blockquote>
<p>千万千万不能这么搞，下面这个语法相当于是先按 name 分组，然后查出来大于 1 的，这时候假如大于 1 的有很多，然后外面嵌套的那一层，只取了最小的一条数据，然后再加上使用的是 <code>NOT IN</code> ，最终会导致数据全部被删除！！！</p>
</blockquote>
<p><img src="https://img-blog.csdnimg.cn/6c67f02195ef4b69b3f896f39f9d8b84.png" alt="在这里插入图片描述"></p>
<p>执行前有四条数据，实际上我们要的是张三留下来一条，然后李四留下来一条</p>
<p><img src="https://img-blog.csdnimg.cn/9f86345b6b9c4e009a0b596ddbb1c83e.png" alt="在这里插入图片描述"></p>
<p>执行结果：只留下了一条！</p>
<p><img src="https://img-blog.csdnimg.cn/be5a73336f5e4a26b93314e10231d998.png" alt="在这里插入图片描述"></p>
<h2 id="关于我"><a class="markdownIt-Anchor" href="#关于我">#</a> 关于我</h2>
<p>Brath 是一个热爱技术的 Java 程序猿，公众号「InterviewCoder」定期分享有趣有料的精品原创文章！</p>
<p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/%E4%BA%8C%E7%BB%B4%E7%A0%81plus.png" alt="InterviewCoder"></p>
<p>非常感谢各位人才能看到这里，原创不易，文章如果有帮助可以关注、点赞、分享或评论，这都是对我的莫大支持！</p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2021-08-09T13:55:59.000Z" title="2021-8-9 21:55:59">2021-08-09</time>发表</span><span class="level-item"><time dateTime="2023-12-21T22:54:49.000Z" title="2023-12-22 6:54:49">2023-12-22</time>更新</span><span class="level-item">4 分钟读完 (大约592个字)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2021/08/09/%E3%80%90Flutter%E3%80%91%E8%A7%A3%E5%86%B3%E5%8D%87%E7%BA%A7Flutter3.0%E5%90%8E%E5%87%BA%E7%8E%B0%E8%AD%A6%E5%91%8AOperand%20of%20null-aware%20operation%20%E2%80%98!%E2%80%98%20has%20type%20%E2%80%98WidgetsBinding%E2%80%98%20which%20excludes%20null/">【Flutter】解决升级Flutter3.0后出现警告Operand of null-aware operation ‘!‘ has type ‘WidgetsBinding‘ which excludes null</a></p><div class="content"><p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/%E6%89%AB%E7%A0%81_%E6%90%9C%E7%B4%A2%E8%81%94%E5%90%88%E4%BC%A0%E6%92%AD%E6%A0%B7%E5%BC%8F-%E6%A0%87%E5%87%86%E8%89%B2%E7%89%88.png" alt="InterviewCoder"></p>
<h1 id="flutter解决升级flutter30后出现警告operand-of-null-aware-operation-has-type-widgetsbinding-which-excludes-null"><a class="markdownIt-Anchor" href="#flutter解决升级flutter30后出现警告operand-of-null-aware-operation-has-type-widgetsbinding-which-excludes-null">#</a> 【Flutter】解决升级 Flutter3.0 后出现警告 Operand of null-aware operation ‘!‘ has type ‘WidgetsBinding‘ which excludes null</h1>
<h1 id="出现场景"><a class="markdownIt-Anchor" href="#出现场景">#</a> 出现场景</h1>
<p>将<a target="_blank" rel="noopener" href="https://so.csdn.net/so/search?q=Flutter&amp;spm=1001.2101.3001.7020"> Flutter</a> SDK 升级到 3.0，运行时报以下警告。<br>
虽然不影响程序的运行，但是看着很烦。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">lib/stress_test/stress_test_page.dart:120:22: Warning: Operand of null-aware operation <span class="string">&#x27;!&#x27;</span> has <span class="built_in">type</span> <span class="string">&#x27;WidgetsBinding&#x27;</span> <span class="built_in">which</span> excludes null.</span><br><span class="line"> - <span class="string">&#x27;WidgetsBinding&#x27;</span> is from <span class="string">&#x27;package:flutter/src/widgets/binding.dart&#x27;</span> (<span class="string">&#x27;../../develop_env/flutter_3.0/packages/flutter/lib/src/widgets/binding.dart&#x27;</span>).</span><br><span class="line">      WidgetsBinding.instance!.addPostFrameCallback((timeStamp) &#123;</span><br><span class="line">                     ^</span><br></pre></td></tr></table></figure>
<h1 id="解决方案"><a class="markdownIt-Anchor" href="#解决方案">#</a> 解决方案</h1>
<p>这是因为在 Flutter 3.0 中，binding 的 instance 是不可为空的，所以不需要使用 <code>!</code> 。</p>
<p>下面有 2 种情况。</p>
<h2 id="三方依赖库"><a class="markdownIt-Anchor" href="#三方依赖库">#</a> 三方依赖库</h2>
<p>如果是依赖的库要使用到了 Binding.instance，去 pub 上看看库的新版本有没有兼容 3.0。如果有就升级库的版本。</p>
<p>比如我的项目用到了 getx 4.6.1，是 Flutter 3.0 出来之前的版本。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">../../develop_env/flutter_3.0/.pub-cache/hosted/pub.flutter-io.cn/get-4.6.1/lib/get_state_manager/src/simple/get_controllers.dart:96:20: Warning: Operand of null-aware operation <span class="string">&#x27;!&#x27;</span> has <span class="built_in">type</span> <span class="string">&#x27;WidgetsBinding&#x27;</span> <span class="built_in">which</span> excludes null.</span><br><span class="line"> - <span class="string">&#x27;WidgetsBinding&#x27;</span> is from <span class="string">&#x27;package:flutter/src/widgets/binding.dart&#x27;</span> (<span class="string">&#x27;../../develop_env/flutter_3.0/packages/flutter/lib/src/widgets/binding.dart&#x27;</span>).</span><br><span class="line">    WidgetsBinding.instance!.removeObserver(this);</span><br><span class="line">                   ^</span><br></pre></td></tr></table></figure>
<p>去 pub 上查看更新记录 (changelog)，可以看到 4.6.2 兼容了 Flutter 3.0。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[4.6.5] #</span><br><span class="line">Fix pub dev score</span><br><span class="line"></span><br><span class="line">[4.6.4] </span><br><span class="line">Added backward compatibility with flutter 2.</span><br><span class="line"></span><br><span class="line">[4.6.3] </span><br><span class="line">Fix SDK constraints</span><br><span class="line"></span><br><span class="line">[4.6.2] </span><br><span class="line">Added compatibility with flutter 3.0</span><br><span class="line"></span><br><span class="line">[4.6.1] </span><br><span class="line">Fix GetConnect on Flutter web</span><br></pre></td></tr></table></figure>
<p>所以我们只需要将 get 的版本更改为 4.6.2 或以上即可。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">dependencies:</span></span><br><span class="line">  <span class="comment"># get: ^4.6.1</span></span><br><span class="line">  <span class="attr">get:</span> <span class="string">^4.6.2</span></span><br></pre></td></tr></table></figure>
<h2 id="本地代码"><a class="markdownIt-Anchor" href="#本地代码">#</a> 本地代码</h2>
<p>如果是项目中有用到 Binding.instance，可以使用<a target="_blank" rel="noopener" href="https://so.csdn.net/so/search?q=dart&amp;spm=1001.2101.3001.7020"> dart</a> 命令 <code>dart fix --apply</code>  自动修复，这样就会自动把 instance 后面的 <code>!</code>  去掉。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">adodeMacBook-Pro:fusion_pro wangyang$ dart fix --apply</span><br><span class="line">Computing fixes <span class="keyword">in</span> fusion_pro... 105.4s</span><br><span class="line">Applying fixes...                      0.0s</span><br><span class="line"></span><br><span class="line">lib/pages/splash_page.dart</span><br><span class="line">  UNNECESSARY_NON_NULL_ASSERTION • 1 fix</span><br><span class="line"></span><br><span class="line">lib/stress_test/stress_test_page.dart</span><br><span class="line">  UNNECESSARY_NON_NULL_ASSERTION • 1 fix</span><br><span class="line"></span><br><span class="line">2 fixes made <span class="keyword">in</span> 2 files.</span><br></pre></td></tr></table></figure>
<h2 id="关于我"><a class="markdownIt-Anchor" href="#关于我">#</a> 关于我</h2>
<p>Brath 是一个热爱技术的 Java 程序猿，公众号「InterviewCoder」定期分享有趣有料的精品原创文章！</p>
<p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/%E4%BA%8C%E7%BB%B4%E7%A0%81plus.png" alt="InterviewCoder"></p>
<p>非常感谢各位人才能看到这里，原创不易，文章如果有帮助可以关注、点赞、分享或评论，这都是对我的莫大支持！</p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2021-07-26T21:18:48.000Z" title="2021-7-27 5:18:48">2021-07-27</time>发表</span><span class="level-item"><time dateTime="2020-11-24T01:35:24.000Z" title="2020-11-24 9:35:24">2020-11-24</time>更新</span><span class="level-item">29 分钟读完 (大约4390个字)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2021/07/27/%E3%80%90SpringBoot%E3%80%91SpringBoot%E8%87%AA%E5%8A%A8%E8%A3%85%E9%85%8D%E5%8E%9F%E7%90%86/">SpringBoot自动装配原理</a></p><div class="content"><p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/%E6%89%AB%E7%A0%81_%E6%90%9C%E7%B4%A2%E8%81%94%E5%90%88%E4%BC%A0%E6%92%AD%E6%A0%B7%E5%BC%8F-%E6%A0%87%E5%87%86%E8%89%B2%E7%89%88.png" alt="InterviewCoder"></p>
<p>自动装配原理：</p>
<p>要学会 SpringBoot 自动装配原理，首先要来看装配了什么？或者说是装配有什么用？</p>
<p>1 . 自动装配了什么？</p>
<p>​		Pom 文件：SpringBoot 帮我们配置好了所有 web 开发常见场景、组件、比如 tomcat、mutipart 文件上传。</p>
<p>​		配置文件：SpringBoot 帮我们装配好了所有组件或者类需要的配置，这些类都有默认的配置，可以通过 application.ymal 或者 application.properties 来修改：比如 server.port=80 修改端口号，默认为 80</p>
<p>2 . 自动装配有什么用？</p>
<p>​		简化 SpringMVC 复杂的配置流程、复杂的依赖引入。SpringBoot 旨在：简化开发，约定大于配置。</p>
<p><strong>总结：</strong></p>
<ul>
<li>
<p><strong>SpringBoot 先加载所有的自动配置类  xxxAutoConfiguration</strong></p>
</li>
<li>
<p><strong>每个自动配置类按照条件进行生效，默认都会绑定配置文件指定的值。xxxProperties 里面拿。xxxProperties 和配置文件进行了绑定</strong></p>
</li>
<li>
<p><strong>生效的配置类就会给容器中装配很多组件</strong></p>
</li>
<li>
<p><strong>只要容器中有这些组件，相当于这些功能就有了</strong></p>
</li>
<li>
<p><strong>定制化配置</strong></p>
</li>
<li>
<ul>
<li><strong>用户直接自己 @Bean 替换底层的组件</strong></li>
<li><strong>用户去看这个组件是获取的配置文件什么值就去修改。</strong></li>
</ul>
</li>
</ul>
<p><strong>xxxAutoConfiguration —&gt; 组件  —&gt;</strong> <strong>xxxProperties 里面拿值  ----&gt; application.properties</strong></p>
<h1 id="1-springboot特点"><a class="markdownIt-Anchor" href="#1-springboot特点">#</a> 1、SpringBoot 特点</h1>
<h2 id="11-依赖管理"><a class="markdownIt-Anchor" href="#11-依赖管理">#</a> 1.1、依赖管理</h2>
<ul>
<li>父项目做依赖管理</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">依赖管理    </span><br><span class="line"><span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.3.4.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line"></span><br><span class="line">他的父项目</span><br><span class="line"> <span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-dependencies<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.3.4.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line"></span><br><span class="line">几乎声明了所有开发中常用的依赖的版本号,自动版本仲裁机制</span><br></pre></td></tr></table></figure>
<ul>
<li>开发导入 starter 场景启动器</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">1、见到很多 spring-boot-starter-* ： *就某种场景</span><br><span class="line">2、只要引入starter，这个场景的所有常规需要的依赖我们都自动引入</span><br><span class="line">3、SpringBoot所有支持的场景</span><br><span class="line">https://docs.spring.io/spring-boot/docs/current/reference/html/using-spring-boot.html#using-boot-starter</span><br><span class="line">4、见到的  *-spring-boot-starter： 第三方为我们提供的简化开发的场景启动器。</span><br><span class="line">5、所有场景启动器最底层的依赖</span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.3.4.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">scope</span>&gt;</span>compile<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<ul>
<li>无需关注版本号，自动版本仲裁</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">1、引入依赖默认都可以不写版本</span><br><span class="line">2、引入非版本仲裁的jar，要写版本号。</span><br></pre></td></tr></table></figure>
<ul>
<li>可以修改默认版本号</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">1、查看spring-boot-dependencies里面规定当前依赖的版本 用的 key。</span><br><span class="line">2、在当前项目里面重写配置</span><br><span class="line">    <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">mysql.version</span>&gt;</span>5.1.43<span class="tag">&lt;/<span class="name">mysql.version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h2 id="12-自动配置"><a class="markdownIt-Anchor" href="#12-自动配置">#</a> 1.2、自动配置</h2>
<ul>
<li>
<p>自动配好 Tomcat</p>
</li>
<li>
<ul>
<li>引入 Tomcat 依赖。</li>
<li>配置 Tomcat</li>
</ul>
</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-tomcat<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.3.4.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">scope</span>&gt;</span>compile<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<ul>
<li>
<p>自动配好 SpringMVC</p>
</li>
<li>
<ul>
<li>引入 SpringMVC 全套组件</li>
<li>自动配好 SpringMVC 常用组件（功能）</li>
</ul>
</li>
<li>
<p>自动配好 Web 常见功能，如：字符编码问题</p>
</li>
<li>
<ul>
<li>SpringBoot 帮我们配置好了所有 web 开发的常见场景</li>
</ul>
</li>
<li>
<p>默认的包结构</p>
</li>
<li>
<ul>
<li>主程序所在包及其下面的所有子包里面的组件都会被默认扫描进来</li>
<li>无需以前的包扫描配置</li>
</ul>
</li>
<li>
<ul>
<li>想要改变扫描路径，@SpringBootApplication (scanBasePackages=<strong>“com.atguigu”</strong>)</li>
</ul>
</li>
<li>
<ul>
<li>
<ul>
<li>或者 @ComponentScan 指定扫描路径</li>
</ul>
</li>
</ul>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line">等同于</span><br><span class="line"><span class="meta">@SpringBootConfiguration</span></span><br><span class="line"><span class="meta">@EnableAutoConfiguration</span></span><br><span class="line"><span class="meta">@ComponentScan(&quot;com.atguigu.boot&quot;)</span></span><br></pre></td></tr></table></figure>
<ul>
<li>
<p>各种配置拥有默认值</p>
</li>
<li>
<ul>
<li>默认配置最终都是映射到某个类上，如：MultipartProperties</li>
<li>配置文件的值最终会绑定每个类上，这个类会在容器中创建对象</li>
</ul>
</li>
<li>
<p>按需加载所有自动配置项</p>
</li>
<li>
<ul>
<li>非常多的 starter</li>
<li>引入了哪些场景这个场景的自动配置才会开启</li>
</ul>
</li>
<li>
<ul>
<li>SpringBoot 所有的自动配置功能都在 spring-boot-autoconfigure 包里面</li>
<li></li>
</ul>
</li>
<li>
<p>…</p>
</li>
</ul>
<h1 id="2-容器功能"><a class="markdownIt-Anchor" href="#2-容器功能">#</a> 2、容器功能</h1>
<h2 id="21-组件添加"><a class="markdownIt-Anchor" href="#21-组件添加">#</a> 2.1、组件添加</h2>
<h3 id="1-configuration"><a class="markdownIt-Anchor" href="#1-configuration">#</a> 1、@Configuration</h3>
<ul>
<li>
<p>基本使用</p>
</li>
<li>
<p><strong>Full 模式与 Lite 模式</strong></p>
</li>
<li>
<ul>
<li>示例</li>
<li>最佳实战</li>
</ul>
</li>
<li>
<ul>
<li>
<ul>
<li>配置 类组件之间无依赖关系用 Lite 模式加速容器启动过程，减少判断</li>
<li>配置类组件之间有依赖关系，方法会被调用得到之前单实例组件，用 Full 模式</li>
</ul>
</li>
</ul>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line">#############################Configuration使用示例######################################################</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 1、配置类里面使用<span class="doctag">@Bean</span>标注在方法上给容器注册组件，默认也是单实例的</span></span><br><span class="line"><span class="comment"> * 2、配置类本身也是组件</span></span><br><span class="line"><span class="comment"> * 3、proxyBeanMethods：代理bean的方法</span></span><br><span class="line"><span class="comment"> *      Full(proxyBeanMethods = true)、【保证每个<span class="doctag">@Bean</span>方法被调用多少次返回的组件都是单实例的】</span></span><br><span class="line"><span class="comment"> *      Lite(proxyBeanMethods = false)【每个<span class="doctag">@Bean</span>方法被调用多少次返回的组件都是新创建的】</span></span><br><span class="line"><span class="comment"> *      组件依赖必须使用Full模式默认。其他默认是否Lite模式</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Configuration(proxyBeanMethods = false)</span> <span class="comment">//告诉SpringBoot这是一个配置类 == 配置文件</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Full:外部无论对配置类中的这个组件注册方法调用多少次获取的都是之前注册容器中的单实例对象</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span> <span class="comment">//给容器中添加组件。以方法名作为组件的id。返回类型就是组件类型。返回的值，就是组件在容器中的实例</span></span><br><span class="line">    <span class="keyword">public</span> User <span class="title function_">user01</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="type">User</span> <span class="variable">zhangsan</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">User</span>(<span class="string">&quot;zhangsan&quot;</span>, <span class="number">18</span>);</span><br><span class="line">        <span class="comment">//user组件依赖了Pet组件</span></span><br><span class="line">        zhangsan.setPet(tomcatPet());</span><br><span class="line">        <span class="keyword">return</span> zhangsan;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean(&quot;tom&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Pet <span class="title function_">tomcatPet</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Pet</span>(<span class="string">&quot;tomcat&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">################################<span class="meta">@Configuration</span>测试代码如下########################################</span><br><span class="line"><span class="meta">@SpringBootConfiguration</span></span><br><span class="line"><span class="meta">@EnableAutoConfiguration</span></span><br><span class="line"><span class="meta">@ComponentScan(&quot;com.atguigu.boot&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MainApplication</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="comment">//1、返回我们IOC容器</span></span><br><span class="line">        <span class="type">ConfigurableApplicationContext</span> <span class="variable">run</span> <span class="operator">=</span> SpringApplication.run(MainApplication.class, args);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//2、查看容器里面的组件</span></span><br><span class="line">        String[] names = run.getBeanDefinitionNames();</span><br><span class="line">        <span class="keyword">for</span> (String name : names) &#123;</span><br><span class="line">            System.out.println(name);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//3、从容器中获取组件</span></span><br><span class="line"></span><br><span class="line">        <span class="type">Pet</span> <span class="variable">tom01</span> <span class="operator">=</span> run.getBean(<span class="string">&quot;tom&quot;</span>, Pet.class);</span><br><span class="line"></span><br><span class="line">        <span class="type">Pet</span> <span class="variable">tom02</span> <span class="operator">=</span> run.getBean(<span class="string">&quot;tom&quot;</span>, Pet.class);</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;组件：&quot;</span>+(tom01 == tom02));</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">//4、com.atguigu.boot.config.MyConfig$$EnhancerBySpringCGLIB$$51f1e1ca@1654a892</span></span><br><span class="line">        <span class="type">MyConfig</span> <span class="variable">bean</span> <span class="operator">=</span> run.getBean(MyConfig.class);</span><br><span class="line">        System.out.println(bean);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//如果@Configuration(proxyBeanMethods = true)代理对象调用方法。SpringBoot总会检查这个组件是否在容器中有。</span></span><br><span class="line">        <span class="comment">//保持组件单实例</span></span><br><span class="line">        <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> bean.user01();</span><br><span class="line">        <span class="type">User</span> <span class="variable">user1</span> <span class="operator">=</span> bean.user01();</span><br><span class="line">        System.out.println(user == user1);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="type">User</span> <span class="variable">user01</span> <span class="operator">=</span> run.getBean(<span class="string">&quot;user01&quot;</span>, User.class);</span><br><span class="line">        <span class="type">Pet</span> <span class="variable">tom</span> <span class="operator">=</span> run.getBean(<span class="string">&quot;tom&quot;</span>, Pet.class);</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;用户的宠物：&quot;</span>+(user01.getPet() == tom));</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="2-bean-component-controller-service-repository"><a class="markdownIt-Anchor" href="#2-bean-component-controller-service-repository">#</a> 2、@Bean、@Component、@Controller、@Service、@Repository</h3>
<h3 id="3-componentscan-import"><a class="markdownIt-Anchor" href="#3-componentscan-import">#</a> 3、@ComponentScan、@Import</h3>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"> * <span class="number">4</span>、<span class="meta">@Import(&#123;User.class, DBHelper.class&#125;)</span></span><br><span class="line"> *      给容器中自动创建出这两个类型的组件、默认组件的名字就是全类名</span><br><span class="line"> *</span><br><span class="line"> *</span><br><span class="line"> *</span><br><span class="line"> */</span><br><span class="line"></span><br><span class="line"><span class="meta">@Import(&#123;User.class, DBHelper.class&#125;)</span></span><br><span class="line"><span class="meta">@Configuration(proxyBeanMethods = false)</span> <span class="comment">//告诉SpringBoot这是一个配置类 == 配置文件</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyConfig</span> &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>@Import 高级用法： <a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1gW411W7wy?p=8">https://www.bilibili.com/video/BV1gW411W7wy?p=8</a></p>
<h3 id="4-conditional"><a class="markdownIt-Anchor" href="#4-conditional">#</a> 4、@Conditional</h3>
<p>条件装配：满足 Conditional 指定的条件，则进行组件注入</p>
<p><img src="https://cdn.nlark.com/yuque/0/2020/png/1354552/1602835786727-28b6f936-62f5-4fd6-a6c5-ae690bd1e31d.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_17%2Ctext_YXRndWlndS5jb20g5bCa56GF6LC3%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10" alt="img"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">=====================测试条件装配==========================</span><br><span class="line"><span class="meta">@Configuration(proxyBeanMethods = false)</span> <span class="comment">//告诉SpringBoot这是一个配置类 == 配置文件</span></span><br><span class="line"><span class="comment">//@ConditionalOnBean(name = &quot;tom&quot;)</span></span><br><span class="line"><span class="meta">@ConditionalOnMissingBean(name = &quot;tom&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyConfig</span> &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Full:外部无论对配置类中的这个组件注册方法调用多少次获取的都是之前注册容器中的单实例对象</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span> <span class="comment">//给容器中添加组件。以方法名作为组件的id。返回类型就是组件类型。返回的值，就是组件在容器中的实例</span></span><br><span class="line">    <span class="keyword">public</span> User <span class="title function_">user01</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="type">User</span> <span class="variable">zhangsan</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">User</span>(<span class="string">&quot;zhangsan&quot;</span>, <span class="number">18</span>);</span><br><span class="line">        <span class="comment">//user组件依赖了Pet组件</span></span><br><span class="line">        zhangsan.setPet(tomcatPet());</span><br><span class="line">        <span class="keyword">return</span> zhangsan;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean(&quot;tom22&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Pet <span class="title function_">tomcatPet</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Pet</span>(<span class="string">&quot;tomcat&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="comment">//1、返回我们IOC容器</span></span><br><span class="line">        <span class="type">ConfigurableApplicationContext</span> <span class="variable">run</span> <span class="operator">=</span> SpringApplication.run(MainApplication.class, args);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//2、查看容器里面的组件</span></span><br><span class="line">        String[] names = run.getBeanDefinitionNames();</span><br><span class="line">        <span class="keyword">for</span> (String name : names) &#123;</span><br><span class="line">            System.out.println(name);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">boolean</span> <span class="variable">tom</span> <span class="operator">=</span> run.containsBean(<span class="string">&quot;tom&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;容器中Tom组件：&quot;</span>+tom);</span><br><span class="line"></span><br><span class="line">        <span class="type">boolean</span> <span class="variable">user01</span> <span class="operator">=</span> run.containsBean(<span class="string">&quot;user01&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;容器中user01组件：&quot;</span>+user01);</span><br><span class="line"></span><br><span class="line">        <span class="type">boolean</span> <span class="variable">tom22</span> <span class="operator">=</span> run.containsBean(<span class="string">&quot;tom22&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;容器中tom22组件：&quot;</span>+tom22);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h2 id="22-原生配置文件引入"><a class="markdownIt-Anchor" href="#22-原生配置文件引入">#</a> 2.2、原生配置文件引入</h2>
<h3 id="1-importresource"><a class="markdownIt-Anchor" href="#1-importresource">#</a> 1、@ImportResource</h3>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">======================beans.xml=========================</span><br><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.springframework.org/schema/beans&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:context</span>=<span class="string">&quot;http://www.springframework.org/schema/context&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd http://www.springframework.org/schema/context https://www.springframework.org/schema/context/spring-context.xsd&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;haha&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.atguigu.boot.bean.User&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;name&quot;</span> <span class="attr">value</span>=<span class="string">&quot;zhangsan&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;age&quot;</span> <span class="attr">value</span>=<span class="string">&quot;18&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;hehe&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.atguigu.boot.bean.Pet&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;name&quot;</span> <span class="attr">value</span>=<span class="string">&quot;tomcat&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br><span class="line">@ImportResource(&quot;classpath:beans.xml&quot;)</span><br><span class="line">public class MyConfig &#123;&#125;</span><br><span class="line"></span><br><span class="line">======================测试=================</span><br><span class="line">        boolean haha = run.containsBean(&quot;haha&quot;);</span><br><span class="line">        boolean hehe = run.containsBean(&quot;hehe&quot;);</span><br><span class="line">        System.out.println(&quot;haha：&quot;+haha);//true</span><br><span class="line">        System.out.println(&quot;hehe：&quot;+hehe);//true</span><br></pre></td></tr></table></figure>
<h2 id="23-配置绑定"><a class="markdownIt-Anchor" href="#23-配置绑定">#</a> 2.3、配置绑定</h2>
<p>如何使用 Java 读取到 properties 文件中的内容，并且把它封装到 JavaBean 中，以供随时使用；</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">getProperties</span> &#123;</span><br><span class="line">     <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> FileNotFoundException, IOException &#123;</span><br><span class="line">         <span class="type">Properties</span> <span class="variable">pps</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Properties</span>();</span><br><span class="line">         pps.load(<span class="keyword">new</span> <span class="title class_">FileInputStream</span>(<span class="string">&quot;a.properties&quot;</span>));</span><br><span class="line">         <span class="type">Enumeration</span> <span class="variable">enum1</span> <span class="operator">=</span> pps.propertyNames();<span class="comment">//得到配置文件的名字</span></span><br><span class="line">         <span class="keyword">while</span>(enum1.hasMoreElements()) &#123;</span><br><span class="line">             <span class="type">String</span> <span class="variable">strKey</span> <span class="operator">=</span> (String) enum1.nextElement();</span><br><span class="line">             <span class="type">String</span> <span class="variable">strValue</span> <span class="operator">=</span> pps.getProperty(strKey);</span><br><span class="line">             System.out.println(strKey + <span class="string">&quot;=&quot;</span> + strValue);</span><br><span class="line">             <span class="comment">//封装到JavaBean。</span></span><br><span class="line">         &#125;</span><br><span class="line">     &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<h3 id="1-configurationproperties"><a class="markdownIt-Anchor" href="#1-configurationproperties">#</a> 1、@ConfigurationProperties</h3>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 只有在容器中的组件，才会拥有SpringBoot提供的强大功能</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@ConfigurationProperties(prefix = &quot;mycar&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Car</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String brand;</span><br><span class="line">    <span class="keyword">private</span> Integer price;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getBrand</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> brand;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setBrand</span><span class="params">(String brand)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.brand = brand;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Integer <span class="title function_">getPrice</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> price;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setPrice</span><span class="params">(Integer price)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.price = price;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">toString</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Car&#123;&quot;</span> +</span><br><span class="line">                <span class="string">&quot;brand=&#x27;&quot;</span> + brand + <span class="string">&#x27;\&#x27;&#x27;</span> +</span><br><span class="line">                <span class="string">&quot;, price=&quot;</span> + price +</span><br><span class="line">                <span class="string">&#x27;&#125;&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="2-enableconfigurationproperties-configurationproperties"><a class="markdownIt-Anchor" href="#2-enableconfigurationproperties-configurationproperties">#</a> 2、@EnableConfigurationProperties + @ConfigurationProperties</h3>
<h3 id="3-component-configurationproperties"><a class="markdownIt-Anchor" href="#3-component-configurationproperties">#</a> 3、@Component + @ConfigurationProperties</h3>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableConfigurationProperties(Car.class)</span></span><br><span class="line"><span class="comment">//1、开启Car配置绑定功能</span></span><br><span class="line"><span class="comment">//2、把这个Car这个组件自动注册到容器中</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyConfig</span> &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="3-自动配置原理入门"><a class="markdownIt-Anchor" href="#3-自动配置原理入门">#</a> 3、自动配置原理入门</h1>
<h2 id="31-引导加载自动配置类"><a class="markdownIt-Anchor" href="#31-引导加载自动配置类">#</a> 3.1、引导加载自动配置类</h2>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootConfiguration</span></span><br><span class="line"><span class="meta">@EnableAutoConfiguration</span></span><br><span class="line"><span class="meta">@ComponentScan(excludeFilters = &#123; @Filter(type = FilterType.CUSTOM, classes = TypeExcludeFilter.class),</span></span><br><span class="line"><span class="meta">		@Filter(type = FilterType.CUSTOM, classes = AutoConfigurationExcludeFilter.class) &#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> SpringBootApplication&#123;&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">======================</span><br><span class="line">    </span><br></pre></td></tr></table></figure>
<h3 id="1-springbootconfiguration"><a class="markdownIt-Anchor" href="#1-springbootconfiguration">#</a> 1、@SpringBootConfiguration</h3>
<p>@Configuration。代表当前是一个配置类</p>
<h3 id="2-componentscan"><a class="markdownIt-Anchor" href="#2-componentscan">#</a> 2、@ComponentScan</h3>
<p>指定扫描哪些，Spring 注解；</p>
<h3 id="3-enableautoconfiguration"><a class="markdownIt-Anchor" href="#3-enableautoconfiguration">#</a> 3、@EnableAutoConfiguration</h3>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@AutoConfigurationPackage</span></span><br><span class="line"><span class="meta">@Import(AutoConfigurationImportSelector.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> EnableAutoConfiguration &#123;&#125;</span><br></pre></td></tr></table></figure>
<h4 id="1-autoconfigurationpackage"><a class="markdownIt-Anchor" href="#1-autoconfigurationpackage">#</a> 1、@AutoConfigurationPackage</h4>
<p>自动配置包？指定了默认的包规则</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Import(AutoConfigurationPackages.Registrar.class)</span>  <span class="comment">//给容器中导入一个组件</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> AutoConfigurationPackage &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//利用Registrar给容器中导入一系列组件</span></span><br><span class="line"><span class="comment">//将指定的一个包下的所有组件导入进来？MainApplication 所在包下。</span></span><br></pre></td></tr></table></figure>
<h4 id="2-importautoconfigurationimportselectorclass"><a class="markdownIt-Anchor" href="#2-importautoconfigurationimportselectorclass">#</a> 2、@Import(AutoConfigurationImportSelector.class)</h4>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span>、利用getAutoConfigurationEntry(annotationMetadata);给容器中批量导入一些组件</span><br><span class="line"><span class="number">2</span>、调用List&lt;String&gt; configurations = getCandidateConfigurations(annotationMetadata, attributes)获取到所有需要导入到容器中的配置类</span><br><span class="line"><span class="number">3</span>、利用工厂加载 Map&lt;String, List&lt;String&gt;&gt; <span class="title function_">loadSpringFactories</span><span class="params">(<span class="meta">@Nullable</span> ClassLoader classLoader)</span>；得到所有的组件</span><br><span class="line"><span class="number">4</span>、从META-INF/spring.factories位置来加载一个文件。</span><br><span class="line">	默认扫描我们当前系统里面所有META-INF/spring.factories位置的文件</span><br><span class="line">    spring-boot-autoconfigure-<span class="number">2.3</span><span class="number">.4</span>.RELEASE.jar包里面也有META-INF/spring.factories</span><br><span class="line">    </span><br></pre></td></tr></table></figure>
<h2 id="img"><a class="markdownIt-Anchor" href="#img">#</a> <img src="https://cdn.nlark.com/yuque/0/2020/png/1354552/1602845382065-5c41abf5-ee10-4c93-89e4-2a9b831c3ceb.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_29%2Ctext_YXRndWlndS5jb20g5bCa56GF6LC3%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10" alt="img"></h2>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br></pre></td><td class="code"><pre><span class="line">文件里面写死了spring-boot一启动就要给容器中加载的所有配置类</span><br><span class="line">spring-boot-autoconfigure-2.3.4.RELEASE.jar/META-INF/spring.factories</span><br><span class="line"># Auto Configure</span><br><span class="line">org.springframework.boot.autoconfigure.EnableAutoConfiguration=\</span><br><span class="line">org.springframework.boot.autoconfigure.admin.SpringApplicationAdminJmxAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.aop.AopAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.amqp.RabbitAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.batch.BatchAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.cache.CacheAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.cassandra.CassandraAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.context.ConfigurationPropertiesAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.context.LifecycleAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.context.MessageSourceAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.context.PropertyPlaceholderAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.couchbase.CouchbaseAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.dao.PersistenceExceptionTranslationAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.data.cassandra.CassandraDataAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.data.cassandra.CassandraReactiveDataAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.data.cassandra.CassandraReactiveRepositoriesAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.data.cassandra.CassandraRepositoriesAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.data.couchbase.CouchbaseDataAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.data.couchbase.CouchbaseReactiveDataAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.data.couchbase.CouchbaseReactiveRepositoriesAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.data.couchbase.CouchbaseRepositoriesAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.data.elasticsearch.ElasticsearchDataAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.data.elasticsearch.ElasticsearchRepositoriesAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.data.elasticsearch.ReactiveElasticsearchRepositoriesAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.data.elasticsearch.ReactiveElasticsearchRestClientAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.data.jdbc.JdbcRepositoriesAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.data.jpa.JpaRepositoriesAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.data.ldap.LdapRepositoriesAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.data.mongo.MongoDataAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.data.mongo.MongoReactiveDataAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.data.mongo.MongoReactiveRepositoriesAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.data.mongo.MongoRepositoriesAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.data.neo4j.Neo4jDataAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.data.neo4j.Neo4jRepositoriesAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.data.solr.SolrRepositoriesAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.data.r2dbc.R2dbcDataAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.data.r2dbc.R2dbcRepositoriesAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.data.r2dbc.R2dbcTransactionManagerAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.data.redis.RedisAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.data.redis.RedisReactiveAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.data.redis.RedisRepositoriesAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.data.rest.RepositoryRestMvcAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.data.web.SpringDataWebAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.elasticsearch.ElasticsearchRestClientAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.flyway.FlywayAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.freemarker.FreeMarkerAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.groovy.template.GroovyTemplateAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.gson.GsonAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.h2.H2ConsoleAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.hateoas.HypermediaAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.hazelcast.HazelcastAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.hazelcast.HazelcastJpaDependencyAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.http.HttpMessageConvertersAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.http.codec.CodecsAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.influx.InfluxDbAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.info.ProjectInfoAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.integration.IntegrationAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.jackson.JacksonAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.jdbc.DataSourceAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.jdbc.JdbcTemplateAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.jdbc.JndiDataSourceAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.jdbc.XADataSourceAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.jdbc.DataSourceTransactionManagerAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.jms.JmsAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.jmx.JmxAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.jms.JndiConnectionFactoryAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.jms.activemq.ActiveMQAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.jms.artemis.ArtemisAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.jersey.JerseyAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.jooq.JooqAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.jsonb.JsonbAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.kafka.KafkaAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.availability.ApplicationAvailabilityAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.ldap.embedded.EmbeddedLdapAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.ldap.LdapAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.liquibase.LiquibaseAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.mail.MailSenderAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.mail.MailSenderValidatorAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.mongo.embedded.EmbeddedMongoAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.mongo.MongoAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.mongo.MongoReactiveAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.mustache.MustacheAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.orm.jpa.HibernateJpaAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.quartz.QuartzAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.r2dbc.R2dbcAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.rsocket.RSocketMessagingAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.rsocket.RSocketRequesterAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.rsocket.RSocketServerAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.rsocket.RSocketStrategiesAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.security.servlet.SecurityAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.security.servlet.UserDetailsServiceAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.security.servlet.SecurityFilterAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.security.reactive.ReactiveSecurityAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.security.reactive.ReactiveUserDetailsServiceAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.security.rsocket.RSocketSecurityAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.security.saml2.Saml2RelyingPartyAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.sendgrid.SendGridAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.session.SessionAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.security.oauth2.client.servlet.OAuth2ClientAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.security.oauth2.client.reactive.ReactiveOAuth2ClientAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.security.oauth2.resource.servlet.OAuth2ResourceServerAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.security.oauth2.resource.reactive.ReactiveOAuth2ResourceServerAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.solr.SolrAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.task.TaskExecutionAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.task.TaskSchedulingAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.thymeleaf.ThymeleafAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.transaction.TransactionAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.transaction.jta.JtaAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.validation.ValidationAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.web.client.RestTemplateAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.web.embedded.EmbeddedWebServerFactoryCustomizerAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.web.reactive.HttpHandlerAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.web.reactive.ReactiveWebServerFactoryAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.web.reactive.WebFluxAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.web.reactive.error.ErrorWebFluxAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.web.reactive.function.client.ClientHttpConnectorAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.web.reactive.function.client.WebClientAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.web.servlet.DispatcherServletAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.web.servlet.ServletWebServerFactoryAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.web.servlet.error.ErrorMvcAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.web.servlet.HttpEncodingAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.web.servlet.MultipartAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.web.servlet.WebMvcAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.websocket.reactive.WebSocketReactiveAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.websocket.servlet.WebSocketServletAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.websocket.servlet.WebSocketMessagingAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.webservices.WebServicesAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.webservices.client.WebServiceTemplateAutoConfiguration</span><br></pre></td></tr></table></figure>
<h2 id="32-按需开启自动配置项"><a class="markdownIt-Anchor" href="#32-按需开启自动配置项">#</a> 3.2、按需开启自动配置项</h2>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">虽然我们<span class="number">127</span>个场景的所有自动配置启动的时候默认全部加载。xxxxAutoConfiguration</span><br><span class="line">按照条件装配规则（<span class="meta">@Conditional</span>），最终会按需配置。</span><br></pre></td></tr></table></figure>
<h2 id="33-修改默认配置"><a class="markdownIt-Anchor" href="#33-修改默认配置">#</a> 3.3、修改默认配置</h2>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">        <span class="meta">@Bean</span></span><br><span class="line">		<span class="meta">@ConditionalOnBean(MultipartResolver.class)</span>  <span class="comment">//容器中有这个类型组件</span></span><br><span class="line">		<span class="meta">@ConditionalOnMissingBean(name = DispatcherServlet.MULTIPART_RESOLVER_BEAN_NAME)</span> <span class="comment">//容器中没有这个名字 multipartResolver 的组件</span></span><br><span class="line">		<span class="keyword">public</span> MultipartResolver <span class="title function_">multipartResolver</span><span class="params">(MultipartResolver resolver)</span> &#123;</span><br><span class="line">            <span class="comment">//给@Bean标注的方法传入了对象参数，这个参数的值就会从容器中找。</span></span><br><span class="line">            <span class="comment">//SpringMVC multipartResolver。防止有些用户配置的文件上传解析器不符合规范</span></span><br><span class="line">			<span class="comment">// Detect if the user has created a MultipartResolver but named it incorrectly</span></span><br><span class="line">			<span class="keyword">return</span> resolver;</span><br><span class="line">		&#125;</span><br><span class="line">给容器中加入了文件上传解析器；</span><br></pre></td></tr></table></figure>
<h2 id=""><a class="markdownIt-Anchor" href="#">#</a> </h2>
<h3 id="springboot默认会在底层配好所有的组件-但是如果用户自己配置了以用户的优先"><a class="markdownIt-Anchor" href="#springboot默认会在底层配好所有的组件-但是如果用户自己配置了以用户的优先">#</a> SpringBoot 默认会在底层配好所有的组件。但是如果用户自己配置了以用户的优先</h3>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line">	<span class="meta">@ConditionalOnMissingBean</span></span><br><span class="line">	<span class="keyword">public</span> CharacterEncodingFilter <span class="title function_">characterEncodingFilter</span><span class="params">()</span> &#123;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h2 id="-2"><a class="markdownIt-Anchor" href="#-2">#</a> </h2>
<p>总结：</p>
<ul>
<li>
<p>SpringBoot 先加载所有的自动配置类  xxxxxAutoConfiguration</p>
</li>
<li>
<p>每个自动配置类按照条件进行生效，默认都会绑定配置文件指定的值。xxxxProperties 里面拿。xxxProperties 和配置文件进行了绑定</p>
</li>
<li>
<p>生效的配置类就会给容器中装配很多组件</p>
</li>
<li>
<p>只要容器中有这些组件，相当于这些功能就有了</p>
</li>
<li>
<p>定制化配置</p>
</li>
<li>
<ul>
<li>用户直接自己 @Bean 替换底层的组件</li>
<li>用户去看这个组件是获取的配置文件什么值就去修改。</li>
</ul>
</li>
</ul>
<p><strong>xxxxxAutoConfiguration —&gt; 组件  —&gt;</strong> <strong>xxxxProperties 里面拿值  ----&gt; application.properties</strong></p>
<h2 id="34-最佳实践"><a class="markdownIt-Anchor" href="#34-最佳实践">#</a> 3.4、最佳实践</h2>
<ul>
<li>
<p>引入场景依赖</p>
</li>
<li>
<ul>
<li><a target="_blank" rel="noopener" href="https://docs.spring.io/spring-boot/docs/current/reference/html/using-spring-boot.html#using-boot-starter">https://docs.spring.io/spring-boot/docs/current/reference/html/using-spring-boot.html#using-boot-starter</a></li>
</ul>
</li>
<li>
<p>查看自动配置了哪些（选做）</p>
</li>
<li>
<ul>
<li>自己分析，引入场景对应的自动配置一般都生效了</li>
<li>配置文件中 debug=true 开启自动配置报告。Negative（不生效）\Positive（生效）</li>
</ul>
</li>
<li>
<p>是否需要修改</p>
</li>
<li>
<ul>
<li>参照文档修改配置项</li>
</ul>
</li>
<li>
<ul>
<li>
<ul>
<li><a target="_blank" rel="noopener" href="https://docs.spring.io/spring-boot/docs/current/reference/html/appendix-application-properties.html#common-application-properties">https://docs.spring.io/spring-boot/docs/current/reference/html/appendix-application-properties.html#common-application-properties</a></li>
<li>自己分析。xxxxProperties 绑定了配置文件的哪些。</li>
</ul>
</li>
</ul>
</li>
<li>
<ul>
<li>自定义加入或者替换组件</li>
</ul>
</li>
<li>
<ul>
<li>
<ul>
<li>@Bean、@Component。。。</li>
</ul>
</li>
</ul>
</li>
<li>
<ul>
<li>自定义器  <strong>XXXXXCustomizer</strong>；</li>
<li>…</li>
</ul>
</li>
</ul>
<h1 id="4-开发小技巧"><a class="markdownIt-Anchor" href="#4-开发小技巧">#</a> 4、开发小技巧</h1>
<h2 id="41-lombok"><a class="markdownIt-Anchor" href="#41-lombok">#</a> 4.1、Lombok</h2>
<p>简化 JavaBean 开发</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">idea中搜索安装lombok插件</span><br><span class="line">===============================简化JavaBean开发===================================</span><br><span class="line">@NoArgsConstructor</span><br><span class="line">//@AllArgsConstructor</span><br><span class="line">@Data</span><br><span class="line">@ToString</span><br><span class="line">@EqualsAndHashCode</span><br><span class="line">public class User &#123;</span><br><span class="line"></span><br><span class="line">    private String name;</span><br><span class="line">    private Integer age;</span><br><span class="line"></span><br><span class="line">    private Pet pet;</span><br><span class="line"></span><br><span class="line">    public User(String name,Integer age)&#123;</span><br><span class="line">        this.name = name;</span><br><span class="line">        this.age = age;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">================================简化日志开发===================================</span><br><span class="line">@Slf4j</span><br><span class="line">@RestController</span><br><span class="line">public class HelloController &#123;</span><br><span class="line">    @RequestMapping(&quot;/hello&quot;)</span><br><span class="line">    public String handle01(@RequestParam(&quot;name&quot;) String name)&#123;</span><br><span class="line">        </span><br><span class="line">        log.info(&quot;请求进来了....&quot;);</span><br><span class="line">        </span><br><span class="line">        return &quot;Hello, Spring Boot 2!&quot;+&quot;你好：&quot;+name;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="42-dev-tools"><a class="markdownIt-Anchor" href="#42-dev-tools">#</a> 4.2、dev-tools</h2>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-devtools<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>项目或者页面修改以后：Ctrl+F9；</p>
<h2 id="43-spring-initailizr项目初始化向导"><a class="markdownIt-Anchor" href="#43-spring-initailizr项目初始化向导">#</a> 4.3、Spring Initailizr（项目初始化向导）</h2>
<h3 id="0-选择我们需要的开发场景"><a class="markdownIt-Anchor" href="#0-选择我们需要的开发场景">#</a> 0、选择我们需要的开发场景</h3>
<p><img src="https://cdn.nlark.com/yuque/0/2020/png/1354552/1602922147241-73fb2496-e795-4b5a-b909-a18c6011a028.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_37%2Ctext_YXRndWlndS5jb20g5bCa56GF6LC3%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10" alt="img"></p>
<h3 id="1-自动依赖引入"><a class="markdownIt-Anchor" href="#1-自动依赖引入">#</a> 1、自动依赖引入</h3>
<p><img src="https://cdn.nlark.com/yuque/0/2020/png/1354552/1602921777330-8fc5c198-75da-4ff9-b82c-71ee3fe18af8.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_28%2Ctext_YXRndWlndS5jb20g5bCa56GF6LC3%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10" alt="img"></p>
<h3 id="2-自动创建项目结构"><a class="markdownIt-Anchor" href="#2-自动创建项目结构">#</a> 2、自动创建项目结构</h3>
<p><img src="https://cdn.nlark.com/yuque/0/2020/png/1354552/1602921758313-5099fe18-4c7b-4417-bf6f-2f40b9028296.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_18%2Ctext_YXRndWlndS5jb20g5bCa56GF6LC3%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10" alt="img"></p>
<h3 id="3-自动编写好主配置类"><a class="markdownIt-Anchor" href="#3-自动编写好主配置类">#</a> 3、自动编写好主配置类</h3>
<p><img src="https://cdn.nlark.com/yuque/0/2020/png/1354552/1602922039074-79e98aad-8158-4113-a7e7-305b57b0a6bf.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_29%2Ctext_YXRndWlndS5jb20g5bCa56GF6LC3%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10" alt="img"></p>
<h2 id="关于我"><a class="markdownIt-Anchor" href="#关于我">#</a> 关于我</h2>
<p>Brath 是一个热爱技术的 Java 程序猿，公众号「InterviewCoder」定期分享有趣有料的精品原创文章！</p>
<p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/%E4%BA%8C%E7%BB%B4%E7%A0%81plus.png" alt="InterviewCoder"></p>
<p>非常感谢各位人才能看到这里，原创不易，文章如果有帮助可以关注、点赞、分享或评论，这都是对我的莫大支持！</p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2021-07-17T15:49:58.000Z" title="2021-7-17 23:49:58">2021-07-17</time>发表</span><span class="level-item"><time dateTime="2020-07-07T05:33:57.000Z" title="2020-7-7 13:33:57">2020-07-07</time>更新</span><span class="level-item">3 分钟读完 (大约431个字)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2021/07/17/%E3%80%90MYSQL%E3%80%91%E4%B8%BB%E4%BB%8E%E5%90%8C%E6%AD%A5%E5%BC%82%E5%B8%B8%E8%AE%B0%E5%BD%95/">主从同步遇到 Got fatal error 1236 from master when reading data from binary log</a></p><div class="content"><p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/%E6%89%AB%E7%A0%81_%E6%90%9C%E7%B4%A2%E8%81%94%E5%90%88%E4%BC%A0%E6%92%AD%E6%A0%B7%E5%BC%8F-%E6%A0%87%E5%87%86%E8%89%B2%E7%89%88.png" alt="InterviewCoder"></p>
<h1 id=""><a class="markdownIt-Anchor" href="#">#</a> </h1>
<p>首先遇到这个是因为 binlog 位置索引处的问题，不要<a target="_blank" rel="noopener" href="https://so.csdn.net/so/search?q=reset&amp;spm=1001.2101.3001.7020"> reset</a> slave；</p>
<p>reset slave 会将主从同步的文件以及位置恢复到初始状态，一开始没有数据还好，有数据的话，相当于重新开始同步，可能会出现一些问题；</p>
<p>一般做主从同步，都是要求以后的数据实现主从同步，而对于旧的数据完全可以使用数据库同步工具先将数据库同步，完了再进行主从同步；</p>
<p>好了遇到上面的问题，正确做法是：</p>
<p>1. 打开主服务器，进入 mysql</p>
<p>2. 执行 flush logs；// 这时主服务器会重新创建一个 binlog 文件；</p>
<p>3. 在主服务上执行 show master status;  显示如下：</p>
<p><img src="https://brath.cloud/blogImg/1620811-20190720113929965-58969472.png" alt="img"></p>
<p>4. 来到从服务器的 mysql；</p>
<p>5.stop slave;</p>
<p>6.change master to master_log_file=‘mysql-bin.000012’,master_log_pos=154;// 这里的 file 和 pos 都是上面主服务器 master 显示的。</p>
<p>7.start slave;// 这时候就应可以了</p>
<p>8.show slave status \G;</p>
<p><img src="https://brath.cloud/blogImg/1620811-20190720114247073-1479221471.png" alt="img"></p>
<h2 id="关于我"><a class="markdownIt-Anchor" href="#关于我">#</a> 关于我</h2>
<p>Brath 是一个热爱技术的 Java 程序猿，公众号「InterviewCoder」定期分享有趣有料的精品原创文章！</p>
<p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/%E4%BA%8C%E7%BB%B4%E7%A0%81plus.png" alt="InterviewCoder"></p>
<p>非常感谢各位人才能看到这里，原创不易，文章如果有帮助可以关注、点赞、分享或评论，这都是对我的莫大支持！</p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2021-07-09T13:56:08.000Z" title="2021-7-9 21:56:08">2021-07-09</time>发表</span><span class="level-item"><time dateTime="2022-03-20T02:21:26.000Z" title="2022-3-20 10:21:26">2022-03-20</time>更新</span><span class="level-item">33 分钟读完 (大约4929个字)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2021/07/09/%E3%80%90Java%E3%80%91TheadLocal/">ThreadLocal</a></p><div class="content"><p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/%E6%89%AB%E7%A0%81_%E6%90%9C%E7%B4%A2%E8%81%94%E5%90%88%E4%BC%A0%E6%92%AD%E6%A0%B7%E5%BC%8F-%E6%A0%87%E5%87%86%E8%89%B2%E7%89%88.png" alt="InterviewCoder"></p>
<h1 id="threadlocal-详解"><a class="markdownIt-Anchor" href="#threadlocal-详解">#</a> ThreadLocal 详解</h1>
<p>ThreadLocal 概述<br>
 ThreadLocal 类用来提供线程内部的局部变量，不同的线程之间不会相互干扰<br>
这种变量在多线程环境下访问（通过 get 和 set 方法访问）时能保证各个线程的变量相对独立于其他线程内的变量<br>
在线程的生命周期内起作用，可以减少同一个线程内多个函数或组件之间一些公共变量传递的复杂度<br>
使用<br>
常用方法</p>
<table>
<thead>
<tr>
<th><strong>方法名</strong></th>
<th><strong>描述</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>ThreadLocal()</td>
<td>创建 ThreadLocal 对象</td>
</tr>
<tr>
<td>public void set( T value)</td>
<td>设置当前线程绑定的局部变量</td>
</tr>
<tr>
<td>public T get()</td>
<td>获取当前线程绑定的局部变量</td>
</tr>
<tr>
<td>public T remove()</td>
<td>移除当前线程绑定的局部变量，该方法可以帮助 JVM 进行 GC</td>
</tr>
<tr>
<td>protected T initialValue()</td>
<td>返回当前线程局部变量的初始值</td>
</tr>
</tbody>
</table>
<p>案例<br>
场景：让每个线程获取其设置的对应的共享变量值<br>
共享变量访问问题案例</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 线程间访问共享变量之间问题</span></span><br><span class="line"><span class="comment"> * */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DemoQuestion</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> age;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">DemoQuestion</span> <span class="variable">demoQuestion</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DemoQuestion</span>();</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">5</span>; i++) &#123;</span><br><span class="line">            <span class="comment">// int j = i;</span></span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt;&#123;</span><br><span class="line">                <span class="comment">// demoQuestion.setAge(j);</span></span><br><span class="line">                demoQuestion.setName(Thread.currentThread().getName() + <span class="string">&quot;的数据&quot;</span>);</span><br><span class="line">                System.out.println(<span class="string">&quot;=================&quot;</span>);</span><br><span class="line">                System.out.println(Thread.currentThread().getName() + <span class="string">&quot;---&gt;&quot;</span> + demoQuestion.getName());</span><br><span class="line">                <span class="comment">// System.out.println(Thread.currentThread().getName() + &quot;---&gt;&quot; + demoQuestion.getAge());</span></span><br><span class="line">            &#125;,<span class="string">&quot;t&quot;</span> + i).start();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getName</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setName</span><span class="params">(String name)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getAge</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> age;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setAge</span><span class="params">(<span class="type">int</span> age)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.age = age;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>使用关键字 Synchronized 关键字加锁解决方案</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 使用加锁的方式解决：线程间访问共享变量之间问题</span></span><br><span class="line"><span class="comment"> * 将对共享变量的操作进行加锁，保证其原子性</span></span><br><span class="line"><span class="comment"> * */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SolveDemoQuestionBySynchronized</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> age;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">SolveDemoQuestionBySynchronized</span> <span class="variable">demoQuestion</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SolveDemoQuestionBySynchronized</span>();</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">5</span>; i++) &#123;</span><br><span class="line">            <span class="comment">// int j = i;</span></span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt;&#123;</span><br><span class="line">                <span class="keyword">synchronized</span> (SolveDemoQuestionBySynchronized.class)&#123;</span><br><span class="line">                    demoQuestion.setName(Thread.currentThread().getName() + <span class="string">&quot;的数据&quot;</span>);</span><br><span class="line">                    System.out.println(<span class="string">&quot;=================&quot;</span>);</span><br><span class="line">                    System.out.println(Thread.currentThread().getName() + <span class="string">&quot;---&gt;&quot;</span> + demoQuestion.getName());</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;,<span class="string">&quot;t&quot;</span> + i).start();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getName</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setName</span><span class="params">(String name)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getAge</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> age;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setAge</span><span class="params">(<span class="type">int</span> age)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.age = age;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>使用 ThreadLocal 方式解决</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SolveDemoQuestionByThreadLocal</span> &#123;</span><br><span class="line">    <span class="keyword">private</span>  ThreadLocal&lt;String&gt; name = <span class="keyword">new</span> <span class="title class_">ThreadLocal</span>&lt;&gt;();</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> age;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">SolveDemoQuestionByThreadLocal</span> <span class="variable">demoQuestion</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SolveDemoQuestionByThreadLocal</span>();</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">5</span>; i++) &#123;</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt;&#123;</span><br><span class="line">                demoQuestion.setName(Thread.currentThread().getName() + <span class="string">&quot;的数据&quot;</span>);</span><br><span class="line">                System.out.println(<span class="string">&quot;=================&quot;</span>);</span><br><span class="line">                System.out.println(Thread.currentThread().getName() + <span class="string">&quot;---&gt;&quot;</span> + demoQuestion.getName());</span><br><span class="line">            &#125;,<span class="string">&quot;t&quot;</span> + i).start();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getName</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> name.get();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">setName</span><span class="params">(String content)</span> &#123;</span><br><span class="line">        name.set(content);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getAge</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> age;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setAge</span><span class="params">(<span class="type">int</span> age)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.age = age;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="threadlocalmap-内部结果"><a class="markdownIt-Anchor" href="#threadlocalmap-内部结果">#</a> ThreadLocalMap 内部结果</h2>
<blockquote>
<p>JDK8 之前的设计<br>
每个 ThreadLocal 都创建一个 ThreadLocalMap，用线程作为 ThreadLocalMap 的 key，要存储的局部变量作为 ThreadLocalMap 的 value，这样就能达到各个线程的局部变量隔离的效果</p>
</blockquote>
<p><img src="https://brath.oss-cn-shanghai.aliyuncs.com/pigo/baa00cdb33a14aaeab7b453c1bb1469b.png" alt="在这里插入图片描述"></p>
<p>JDK8 之后的设计<br>
每个 Thread 维护一个 ThreadLocalMap，这个 ThreadLocalMap 的 key 是 ThreadLocal 实例本身，value 才是真正要存储的值 Object<br>
 每个 Thread 线程内部都有一个 ThreadLocalMap<br>
Map 里面存储 ThreadLocal 对象（key）和线程的变量副本（value）<br>
Thread 内部的 Map 是由 ThreadLocal 维护的，由 ThreadLocal 负责向 map 获取和设置线程的变量值<br>
对于不同的线程，每次获取副本值时，别的线程并不能获取到当前线程的副本值，形成了副本的隔离，互不干扰</p>
<p><img src="https://brath.oss-cn-shanghai.aliyuncs.com/pigo/5633b9ff01d84aaeb06b799d825e289e.png" alt="在这里插入图片描述"></p>
<p>JDK 对 ThreadLocal 这样改造的好处<br>
减少 ThreadLocalMap 存储的 Entry 数量：因为之前的存储数量由 Thread 的数量决定，现在是由 ThreadLocal 的数量决定。在实际运用当中，往往 ThreadLocal 的数量要少于 Thread 的数量<br>
当 Thread 销毁之后，对应的 ThreadLocalMap 也会随之销毁，能减少内存的使用（但是不能避免内存泄漏问题，解决内存泄漏问题应该在使用完后及时调用 remove () 对 ThreadMap 里的 Entry 对象进行移除，由于 Entry 继承了弱引用类，会在下次 GC 时被 JVM 回收）</p>
<h2 id="threadlocal相关方法源码解析"><a class="markdownIt-Anchor" href="#threadlocal相关方法源码解析">#</a> ThreadLocal 相关方法源码解析</h2>
<h3 id="set方法"><a class="markdownIt-Anchor" href="#set方法">#</a> set 方法</h3>
<ul>
<li>源码及相关注释</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 设置当前线程对应的ThreadLocal的值</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> value 将要保存在当前线程对应的ThreadLocal的值</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">set</span><span class="params">(T value)</span> &#123;</span><br><span class="line">       <span class="comment">// 获取当前线程对象</span></span><br><span class="line">       <span class="type">Thread</span> <span class="variable">t</span> <span class="operator">=</span> Thread.currentThread();</span><br><span class="line">       <span class="comment">// 获取此线程对象中维护的ThreadLocalMap对象</span></span><br><span class="line">       <span class="type">ThreadLocalMap</span> <span class="variable">map</span> <span class="operator">=</span> getMap(t);</span><br><span class="line">       <span class="comment">// 判断map是否存在</span></span><br><span class="line">       <span class="keyword">if</span> (map != <span class="literal">null</span>)</span><br><span class="line">           <span class="comment">// 存在则调用map.set设置此实体entry,this这里指调用此方法的ThreadLocal对象</span></span><br><span class="line">           map.set(<span class="built_in">this</span>, value);</span><br><span class="line">       <span class="keyword">else</span></span><br><span class="line">           <span class="comment">// 1）当前线程Thread 不存在ThreadLocalMap对象</span></span><br><span class="line">           <span class="comment">// 2）则调用createMap进行ThreadLocalMap对象的初始化</span></span><br><span class="line">           <span class="comment">// 3）并将 t(当前线程)和value(t对应的值)作为第一个entry存放至ThreadLocalMap中</span></span><br><span class="line">           createMap(t, value);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 获取当前线程Thread对应维护的ThreadLocalMap </span></span><br><span class="line"><span class="comment">    * </span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span>  t the current thread 当前线程</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span> the map 对应维护的ThreadLocalMap </span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   ThreadLocalMap <span class="title function_">getMap</span><span class="params">(Thread t)</span> &#123;</span><br><span class="line">       <span class="keyword">return</span> t.threadLocals;</span><br><span class="line">   &#125;</span><br><span class="line">   </span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    *创建当前线程Thread对应维护的ThreadLocalMap </span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> t 当前线程</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> firstValue 存放到map中第一个entry的值</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">createMap</span><span class="params">(Thread t, T firstValue)</span> &#123;</span><br><span class="line">       <span class="comment">//这里的this是调用此方法的threadLocal</span></span><br><span class="line">       t.threadLocals = <span class="keyword">new</span> <span class="title class_">ThreadLocalMap</span>(<span class="built_in">this</span>, firstValue);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>相关流程图</li>
</ul>
<p><img src="https://brath.oss-cn-shanghai.aliyuncs.com/pigo/2430f09d315e40769a63720f84a8a06c.png" alt="在这里插入图片描述"></p>
<ul>
<li>执行流程</li>
</ul>
<ol>
<li>获取当前线程，并根据当前线程获取一个 Map</li>
<li>如果获取的 Map 不为空，则将参数设置到 Map 中（当前 ThreadLocal 的引用作为 key）</li>
<li>如果 Map 为空，则给该线程创建 Map，并设置初始值</li>
</ol>
<h3 id="get方法"><a class="markdownIt-Anchor" href="#get方法">#</a> get () 方法</h3>
<ul>
<li>源码及相关注释</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 返回当前线程中保存ThreadLocal的值</span></span><br><span class="line"><span class="comment">    * 如果当前线程没有此ThreadLocal变量，</span></span><br><span class="line"><span class="comment">    * 则它会通过调用&#123;<span class="doctag">@link</span> #initialValue&#125; 方法进行初始化值</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span> 返回当前线程对应此ThreadLocal的值</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="keyword">public</span> T <span class="title function_">get</span><span class="params">()</span> &#123;</span><br><span class="line">       <span class="comment">// 获取当前线程对象</span></span><br><span class="line">       <span class="type">Thread</span> <span class="variable">t</span> <span class="operator">=</span> Thread.currentThread();</span><br><span class="line">       <span class="comment">// 获取此线程对象中维护的ThreadLocalMap对象</span></span><br><span class="line">       <span class="type">ThreadLocalMap</span> <span class="variable">map</span> <span class="operator">=</span> getMap(t);</span><br><span class="line">       <span class="comment">// 如果此map存在</span></span><br><span class="line">       <span class="keyword">if</span> (map != <span class="literal">null</span>) &#123;</span><br><span class="line">           <span class="comment">// 以当前的ThreadLocal 为 key，调用getEntry获取对应的存储实体e</span></span><br><span class="line">           ThreadLocalMap.<span class="type">Entry</span> <span class="variable">e</span> <span class="operator">=</span> map.getEntry(<span class="built_in">this</span>);</span><br><span class="line">           <span class="comment">// 对e进行判空 </span></span><br><span class="line">           <span class="keyword">if</span> (e != <span class="literal">null</span>) &#123;</span><br><span class="line">               <span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line">               <span class="comment">// 获取存储实体 e 对应的 value值,即为我们想要的当前线程对应此ThreadLocal的值</span></span><br><span class="line">               <span class="type">T</span> <span class="variable">result</span> <span class="operator">=</span> (T)e.value;</span><br><span class="line">               <span class="keyword">return</span> result;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="comment">/*</span></span><br><span class="line"><span class="comment">       	初始化 : 有两种情况有执行当前代码</span></span><br><span class="line"><span class="comment">       	第一种情况: map不存在，表示此线程没有维护的ThreadLocalMap对象</span></span><br><span class="line"><span class="comment">       	第二种情况: map存在, 但是没有与当前ThreadLocal关联的entry</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">       <span class="keyword">return</span> setInitialValue();</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 初始化</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span> the initial value 初始化后的值</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="keyword">private</span> T <span class="title function_">setInitialValue</span><span class="params">()</span> &#123;</span><br><span class="line">       <span class="comment">// 调用initialValue获取初始化的值</span></span><br><span class="line">       <span class="comment">// 此方法可以被子类重写, 如果不重写默认返回null</span></span><br><span class="line">       <span class="type">T</span> <span class="variable">value</span> <span class="operator">=</span> initialValue();</span><br><span class="line">       <span class="comment">// 获取当前线程对象</span></span><br><span class="line">       <span class="type">Thread</span> <span class="variable">t</span> <span class="operator">=</span> Thread.currentThread();</span><br><span class="line">       <span class="comment">// 获取此线程对象中维护的ThreadLocalMap对象</span></span><br><span class="line">       <span class="type">ThreadLocalMap</span> <span class="variable">map</span> <span class="operator">=</span> getMap(t);</span><br><span class="line">       <span class="comment">// 判断map是否存在</span></span><br><span class="line">       <span class="keyword">if</span> (map != <span class="literal">null</span>)</span><br><span class="line">           <span class="comment">// 存在则调用map.set设置此实体entry</span></span><br><span class="line">           map.set(<span class="built_in">this</span>, value);</span><br><span class="line">       <span class="keyword">else</span></span><br><span class="line">           <span class="comment">// 1）当前线程Thread 不存在ThreadLocalMap对象</span></span><br><span class="line">           <span class="comment">// 2）则调用createMap进行ThreadLocalMap对象的初始化</span></span><br><span class="line">           <span class="comment">// 3）并将 t(当前线程)和value(t对应的值)作为第一个entry存放至ThreadLocalMap中</span></span><br><span class="line">           createMap(t, value);</span><br><span class="line">       <span class="comment">// 返回设置的值value</span></span><br><span class="line">       <span class="keyword">return</span> value;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>流程图</li>
</ul>
<p><img src="https://brath.oss-cn-shanghai.aliyuncs.com/pigo/a7e417b2719348729b4229071e4d3f4f.png" alt="在这里插入图片描述"></p>
<p>执行流程<br>
获取当前线程，根据当前线程获取一个 Map<br>
 如果获取的 Map 不为空，则在 Map 中以 ThreadLocal 的引用作为 key 来在 Map 中获取对应的 Entrye，否则转到 4<br>
 如果 e 不为 null，则返回 e.value，否则转到 4<br>
Map 为空或者 e 为空，则通过 initialValue 函数获取初始值 value，然后用 ThreadLocal 的引用和 value 作为 firstKey 和 firstValue 创建一个新的 Map</p>
<h2 id="remove方法"><a class="markdownIt-Anchor" href="#remove方法">#</a> remove 方法</h2>
<ul>
<li>源码及相关注释</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 删除当前线程中保存的ThreadLocal对应的实体entry</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">     <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">remove</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// 获取当前线程对象中维护的ThreadLocalMap对象</span></span><br><span class="line">         <span class="type">ThreadLocalMap</span> <span class="variable">m</span> <span class="operator">=</span> getMap(Thread.currentThread());</span><br><span class="line">        <span class="comment">// 如果此map存在</span></span><br><span class="line">         <span class="keyword">if</span> (m != <span class="literal">null</span>)</span><br><span class="line">            <span class="comment">// 存在则调用map.remove</span></span><br><span class="line">            <span class="comment">// 以当前ThreadLocal为key删除对应的实体entry</span></span><br><span class="line">             m.remove(<span class="built_in">this</span>);</span><br><span class="line">     &#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>执行流程</li>
</ul>
<ol>
<li>首先获取当前线程，并根据当前线程获取一个 Map</li>
<li>如果获取的 Map 不为空，则移除当前 ThreadLocal 对象对应的 entry</li>
</ol>
<p>initialValue 方法<br>
此方法的作用是返回该线程局部变量的初始值<br>
这个方法是一个延迟调用方法，从上面的代码我们得知，在 set 方法还未调用而先调用了 get 方法时才执行，并且仅执行 1 次<br>
这个方法缺省实现直接返回一个 null<br>
 如果想要一个除 null 之外的初始值，可以重写此方法。（备注： 该方法是一个 protected 的方法，显然是为了让子类覆盖而设计的）<br>
源码及相关注释</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  * 返回当前线程对应的ThreadLocal的初始值</span></span><br><span class="line"><span class="comment">  * 此方法的第一次调用发生在，当线程通过get方法访问此线程的ThreadLocal值时</span></span><br><span class="line"><span class="comment">  * 除非线程先调用了set方法，在这种情况下，initialValue 才不会被这个线程调用。</span></span><br><span class="line"><span class="comment">  * 通常情况下，每个线程最多调用一次这个方法。</span></span><br><span class="line"><span class="comment">  *</span></span><br><span class="line"><span class="comment">  * &lt;p&gt;这个方法仅仅简单的返回null &#123;<span class="doctag">@code</span> null&#125;;</span></span><br><span class="line"><span class="comment">  * 如果想ThreadLocal线程局部变量有一个除null以外的初始值，</span></span><br><span class="line"><span class="comment">  * 必须通过子类继承&#123;<span class="doctag">@code</span> ThreadLocal&#125; 的方式去重写此方法</span></span><br><span class="line"><span class="comment">  * 通常, 可以通过匿名内部类的方式实现</span></span><br><span class="line"><span class="comment">  *</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@return</span> 当前ThreadLocal的初始值</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"><span class="keyword">protected</span> T <span class="title function_">initialValue</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ThreadLocalMap 解析</p>
<h2 id="内部结构"><a class="markdownIt-Anchor" href="#内部结构">#</a> 内部结构</h2>
<p>ThreadLocalMap 是 ThreadLocal 的内部类，没有实现 Map 接口，用独立的方式实现了 Map 的功能，其内部的 Entry 也是独立实现的，而 Entry 又是 ThreadLocalMap 的内部类，且集成弱引用 (WeakReference) 类。</p>
<h2 id="成员变量"><a class="markdownIt-Anchor" href="#成员变量">#</a> 成员变量</h2>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">		<span class="comment">/**</span></span><br><span class="line"><span class="comment">        * The entries in this hash map extend WeakReference, using</span></span><br><span class="line"><span class="comment">        * its main ref field as the key (which is always a</span></span><br><span class="line"><span class="comment">        * ThreadLocal object).  Note that null keys (i.e. entry.get()</span></span><br><span class="line"><span class="comment">        * == null) mean that the key is no longer referenced, so the</span></span><br><span class="line"><span class="comment">        * entry can be expunged from table.  Such entries are referred to</span></span><br><span class="line"><span class="comment">        * as &quot;stale entries&quot; in the code that follows.</span></span><br><span class="line"><span class="comment">        * </span></span><br><span class="line"><span class="comment">			* Entry继承WeakReference，并且用ThreadLocal作为key.</span></span><br><span class="line"><span class="comment">				* 如果key为null(entry.get() == null)，意味着key不再被引用，</span></span><br><span class="line"><span class="comment">				* 因此这时候entry也可以从table中清除。</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">       <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Entry</span> <span class="keyword">extends</span> <span class="title class_">WeakReference</span>&lt;ThreadLocal&lt;?&gt;&gt; &#123;</span><br><span class="line">           <span class="comment">/** The value associated with this ThreadLocal. */</span></span><br><span class="line">           Object value;</span><br><span class="line"></span><br><span class="line">           Entry(ThreadLocal&lt;?&gt; k, Object v) &#123;</span><br><span class="line">               <span class="built_in">super</span>(k);</span><br><span class="line">               value = v;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 初始容量 —— 必须是2的整次幂</span></span><br><span class="line"><span class="comment">    *  The initial capacity -- MUST be a power of two.  </span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">INITIAL_CAPACITY</span> <span class="operator">=</span> <span class="number">16</span>;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 存放数据的table，Entry类的定义在下面分析</span></span><br><span class="line"><span class="comment">    * 同样，数组长度必须是2的整次幂。</span></span><br><span class="line"><span class="comment">    * The table, resized as necessary.</span></span><br><span class="line"><span class="comment">    * table.length MUST always be a power of two.</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="keyword">private</span> Entry[] table;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 数组里面entrys的个数，可以用于判断table当前使用量是否超过阈值。</span></span><br><span class="line"><span class="comment">    * The number of entries in the table</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="keyword">private</span> <span class="type">int</span> <span class="variable">size</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 进行扩容的阈值，表使用量大于它的时候进行扩容。</span></span><br><span class="line"><span class="comment">    * The next size value at which to resize</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="keyword">private</span> <span class="type">int</span> threshold; <span class="comment">// Default to 0</span></span><br></pre></td></tr></table></figure>
<h2 id="弱引用和内存泄漏"><a class="markdownIt-Anchor" href="#弱引用和内存泄漏">#</a> 弱引用和内存泄漏</h2>
<p>弱引用相关概念<br>
强引用（“Strong” Reference），就是我们最常见的普通对象引用，只要还有强引用指向一个对象，就能表明对象还 “活着”，垃圾回收器就不会回收这种对象<br>
弱引用（WeakReference），垃圾回收器一旦发现了只具有弱引用的对象，不管当前内存空间足够与否，都会回收它的内存</p>
<h2 id="内存泄漏相关概念"><a class="markdownIt-Anchor" href="#内存泄漏相关概念">#</a> 内存泄漏相关概念</h2>
<p>Memory overflow: 内存溢出，没有足够的内存提供申请者使用<br>
 Memory leak: 内存泄漏是指程序中己动态分配的堆内存由于某种原因程序未释放或无法释放，造成系统内存的浪费，导致程序运行速度减慢甚至系统崩溃等严重后果。内存泄漏的堆积终将导致内存溢出</p>
<h2 id="内存泄漏与强弱引用关系"><a class="markdownIt-Anchor" href="#内存泄漏与强弱引用关系">#</a> 内存泄漏与强弱引用关系</h2>
<p>ThreadLocal 内存结构</p>
<p><img src="https://brath.oss-cn-shanghai.aliyuncs.com/pigo/7476f5b3aec44f20b884e118880925b1.png" alt="在这里插入图片描述"></p>
<p>如果 key 使用强引用，也就是上图中的红色背景框部分<br>
业务代码中使用完 ThreadLocal ，threadLocal Ref 被回收了<br>
因为 threadLocalMap 的 Entry 强引用了 threadLocal，造成 threadLocal 无法被回收<br>
在没有手动删除这个 Entry 以及 CurrentThread 依然运行的前提下，始终有强引用链 threadRef-&gt;currentThread-&gt;threadLocalMap-&gt;entry，Entry 就不会被回收（Entry 中包括了 ThreadLocal 实例和 value），导致 Entry 内存泄漏<br>
如果 key 使用弱引用，也就是上图中的红色背景框部分<br>
业务代码中使用完 ThreadLocal ，threadLocal Ref 被回收了<br>
由于 ThreadLocalMap 只持有 ThreadLocal 的弱引用，没有任何强引用指向 threadlocal 实例，所以 threadlocal 就可以顺利被 gc 回收，此时 Entry 中的 key=null<br>
 但是在没有手动删除这个 Entry 以及 CurrentThread 依然运行的前提下，也存在有强引用链 threadRef-&gt;currentThread-&gt;threadLocalMap-&gt;entry -&gt; value ，value 不会被回收， 而这块 value 永远不会被访问到了，导致 value 内存泄漏</p>
<h2 id="出现内存泄漏的真实原因"><a class="markdownIt-Anchor" href="#出现内存泄漏的真实原因">#</a> 出现内存泄漏的真实原因</h2>
<p>没有手动删除对应的 Entry 节点信息<br>
 ThreadLocal 对象使用完后，对应线程仍然在运行</p>
<h2 id="避免内存泄漏的的两种方式"><a class="markdownIt-Anchor" href="#避免内存泄漏的的两种方式">#</a> 避免内存泄漏的的两种方式</h2>
<p>使用完 ThreadLocal，调用其 remove 方法删除对应的 Entry<br>
 使用完 ThreadLocal，当前 Thread 也随之运行结束<br>
对于第一种方式很好控制，调用对应 remove () 方法即可，但是对于第二种方式，我们是很难控制的，正因为不好控制，这也是为什么 ThreadLocalMap 里对应的 Entry 对象继承弱引用的原因，因为使用了弱引用，当 ThreadLocal 使用完后，key 的引用就会为 null，而在调用 ThreadLocal 中的 get ()/set () 方法时，当判断 key 为 null 时会将 value 置为 null，这就就会在 jvm 下次 GC 时将对应的 Entry 对象回收，从而避免内存泄漏问题的出现。</p>
<h2 id="hash冲突问题及解决方法"><a class="markdownIt-Anchor" href="#hash冲突问题及解决方法">#</a> hash 冲突问题及解决方法</h2>
<p>首先从 ThreadLocal 的 set () 方法入手</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">public void set(T value) &#123;</span><br><span class="line">        Thread t = Thread.currentThread();</span><br><span class="line">        ThreadLocal.ThreadLocalMap map = getMap(t);</span><br><span class="line">        if (map != null)</span><br><span class="line">            //调用了ThreadLocalMap的set方法</span><br><span class="line">            map.set(this, value);</span><br><span class="line">        else</span><br><span class="line">            createMap(t, value);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    ThreadLocal.ThreadLocalMap getMap(Thread t) &#123;</span><br><span class="line">        return t.threadLocals;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    void createMap(Thread t, T firstValue) &#123;</span><br><span class="line">        	//调用了ThreadLocalMap的构造方法</span><br><span class="line">        t.threadLocals = new ThreadLocal.ThreadLocalMap(this, firstValue);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>
<p>构造方法 <code>ThreadLocalMap(ThreadLocal&lt;?&gt; firstKey, Object firstValue)</code></p>
</li>
<li>
<pre><code> /*
  * firstKey : 本ThreadLocal实例(this)
  * firstValue ： 要保存的线程本地变量
  */
ThreadLocalMap(ThreadLocal&lt;?&gt; firstKey, Object firstValue) &#123;
        //初始化table
        table = new ThreadLocal.ThreadLocalMap.Entry[INITIAL_CAPACITY];
        //计算索引(重点代码）
        int i = firstKey.threadLocalHashCode &amp; (INITIAL_CAPACITY - 1);
        //设置值
        table[i] = new ThreadLocal.ThreadLocalMap.Entry(firstKey, firstValue);
        size = 1;
        //设置阈值
        setThreshold(INITIAL_CAPACITY);
    &#125;
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">构造函数首先创建一个长度为16的Entry数组，然后计算出firstKey对应的索引，然后存储到table中，并设置size和threshold</span><br><span class="line"></span><br><span class="line">分析：int i = firstKey.threadLocalHashCode &amp; (INITIAL_CAPACITY - 1)</span><br><span class="line">关于：firstKey.threadLocalHashCode</span><br><span class="line"></span><br></pre></td></tr></table></figure>
private final int threadLocalHashCode = nextHashCode();
    
    private static int nextHashCode() &#123;
        return nextHashCode.getAndAdd(HASH_INCREMENT);
    &#125;
//AtomicInteger是一个提供原子操作的Integer类，通过线程安全的方式操作加减,适合高并发情况下的使用
    private static AtomicInteger nextHashCode =  new AtomicInteger();
     //特殊的hash值
    private static final int HASH_INCREMENT = 0x61c88647;
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">这里定义了一个AtomicInteger类型，每次获取当前值并加上HASH_INCREMENT，HASH_INCREMENT = 0x61c88647,这个值跟斐波那契数列（黄金分割数）有关，其主要目的就是为了让哈希码能均匀的分布在2的n次方的数组里, 也就是Entry[] table中，这样做可以尽量避免hash冲突</span><br><span class="line"></span><br><span class="line">关于：&amp; (INITIAL_CAPACITY - 1)</span><br><span class="line">计算hash的时候里面采用了hashCode &amp; (size - 1)的算法，这相当于取模运算hashCode % size的一个更高效的实现。正是因为这种算法，我们要求size必须是2的整次幂，这也能保证在索引不越界的前提下，使得hash发生冲突的次数减小</span><br><span class="line">ThreadLocalMap中的set方法</span><br><span class="line"></span><br></pre></td></tr></table></figure>
private void set(ThreadLocal&lt;?&gt; key, Object value) &#123;
        ThreadLocal.ThreadLocalMap.Entry[] tab = table;
        int len = tab.length;
        //计算索引(重点代码，刚才分析过了）
        int i = key.threadLocalHashCode &amp; (len-1);
        /**
         * 使用线性探测法查找元素（重点代码）
         */
        for (ThreadLocal.ThreadLocalMap.Entry e = tab[i];
             e != null;
             e = tab[i = nextIndex(i, len)]) &#123;
            ThreadLocal&lt;?&gt; k = e.get();
            //ThreadLocal 对应的 key 存在，直接覆盖之前的值
            if (k == key) &#123;
                e.value = value;
                return;
            &#125;
            // key为 null，但是值不为 null，说明之前的 ThreadLocal 对象已经被回收了，
           // 当前数组中的 Entry 是一个陈旧（stale）的元素
            if (k == null) &#123;
                //用新元素替换陈旧的元素，这个方法进行了不少的垃圾清理动作，防止内存泄漏
                replaceStaleEntry(key, value, i);
                return;
            &#125;
        &#125;
    
    	//ThreadLocal对应的key不存在并且没有找到陈旧的元素，则在空元素的位置创建一个新的Entry。
            tab[i] = new Entry(key, value);
            int sz = ++size;
            /**
             * cleanSomeSlots用于清除那些e.get()==null的元素，
             * 这种数据key关联的对象已经被回收，所以这个Entry(table[index])可以被置null。
             * 如果没有清除任何entry,并且当前使用量达到了负载因子所定义(长度的2/3)，那么进行				 * rehash（执行一次全表的扫描清理工作）
             */
            if (!cleanSomeSlots(i, sz) &amp;&amp; sz &gt;= threshold)
                rehash();
&#125;

 /**
     * 获取环形数组的下一个索引
     */
    private static int nextIndex(int i, int len) &#123;
        return ((i + 1 &lt; len) ? i + 1 : 0);
    &#125;
</code></pre>
<h2 id="代码执行流程"><a class="markdownIt-Anchor" href="#代码执行流程">#</a> 代码执行流程：</h2>
<p>1. 首先还是根据 key 计算出索引 i，然后查找 i 位置上的 Entry</p>
<p>2. 若是 Entry 已经存在并且 key 等于传入的 key，那么这时候直接给这个 Entry 赋新的 value 值</p>
<p>3. 若是 Entry 存在，但是 key 为 null，则调用 replaceStaleEntry 来更换这个 key 为空的 Entry</p>
<p>4. 不断循环检测，直到遇到为 null 的地方，这时候要是还没在循环过程中 return，那么就在这个 null 的位置新建一个 Entry，并且插入，同时 size 增加 1</p>
<p>5. 最后调用 cleanSomeSlots，清理 key 为 null 的 Entry，最后返回是否清理了 Entry，接下来再判断 sz 是否 &gt;= thresgold 达到了 rehash 的条件，达到的话就会调用 rehash 函数执行一次全表的扫描清理</p>
<ul>
<li>分析 ： ThreadLocalMap 使用线性探测法来解决哈希冲突的</li>
</ul>
<p>1. 该方法一次探测下一个地址，直到有空的地址后插入，若整个空间都找不到空余的地址，则产生溢出<br>
 2. 假设当前 table 长度为 16，也就是说如果计算出来 key 的 hash 值为 14，如果 table [14] 上已经有值，并且其 key 与当前 key 不一致，那么就发生了 hash 冲突，这个时候将 14 加 1 得到 15，取 table [15] 进行判断，这个时候如果还是冲突会回到 0，取 table [0], 以此类推，直到可以插入</p>
<p>3. 可以把 Entry [] table 看成一个环形数组</p>
</li>
</ul>
<h2 id="关于我"><a class="markdownIt-Anchor" href="#关于我">#</a> 关于我</h2>
<p>Brath 是一个热爱技术的 Java 程序猿，公众号「InterviewCoder」定期分享有趣有料的精品原创文章！</p>
<p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/%E4%BA%8C%E7%BB%B4%E7%A0%81plus.png" alt="InterviewCoder"></p>
<p>非常感谢各位人才能看到这里，原创不易，文章如果有帮助可以关注、点赞、分享或评论，这都是对我的莫大支持！</p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2021-07-08T18:53:41.000Z" title="2021-7-9 2:53:41">2021-07-09</time>发表</span><span class="level-item"><time dateTime="2021-09-25T08:55:37.000Z" title="2021-9-25 16:55:37">2021-09-25</time>更新</span><span class="level-item">17 分钟读完 (大约2507个字)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2021/07/09/%E3%80%90Flutter%E3%80%91Flutter%E4%BF%AE%E5%A4%8DAndroid%2012%E6%97%A0%E6%B3%95%E6%9E%84%E5%BB%BA%E7%9A%84%E9%97%AE%E9%A2%98%EF%BC%8C%E8%87%AA%E5%8A%A8%E9%80%82%E9%85%8D%20exported%20%E6%B7%B1%E5%85%A5%E8%A7%A3%E6%9E%90%E9%81%BF%E5%9D%91/">【Flutter】Flutter修复Android 12无法构建的问题，自动适配 exported 深入解析避坑.md</a></p><div class="content"><p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/%E6%89%AB%E7%A0%81_%E6%90%9C%E7%B4%A2%E8%81%94%E5%90%88%E4%BC%A0%E6%92%AD%E6%A0%B7%E5%BC%8F-%E6%A0%87%E5%87%86%E8%89%B2%E7%89%88.png" alt="InterviewCoder"></p>
<h1 id="flutterflutter修复android-12无法构建的问题自动适配-exported-深入解析避坑"><a class="markdownIt-Anchor" href="#flutterflutter修复android-12无法构建的问题自动适配-exported-深入解析避坑">#</a> 【Flutter】Flutter 修复 Android 12 无法构建的问题，自动适配 exported 深入解析避坑</h1>
<blockquote>
<p><em>【摘要】 众所周知，从 Android 12 开始，使用了 TargetSDK 31 之后，四大组件如果使用了 intent-filter， 但是没显性质配置 exported App 将会无法安装，甚至编译不通过…</em></p>
</blockquote>
<blockquote>
<p>比如启动的  <code>Activity</code>  就需要设置  <code>exported</code>  为  <code>true</code>  ，至于其他组件是否设置为  <code>true</code>  则看它是否需要被其它应用调用。</p>
</blockquote>
<h4 id="然而这个事情的状态是这样的"><a class="markdownIt-Anchor" href="#然而这个事情的状态是这样的">#</a> 然而这个事情的状态是这样的:</h4>
<ul>
<li>如果出现问题的  <code>AndroidManifest</code>  文件是你本地的，那手动修改即可；</li>
<li>但如果出现问题的是第三方远程依赖，并且对方并没有提供源码和更新，你就无法直接修改；</li>
<li>如果第三方依赖太多，查找哪些出了问题十分费时费力。</li>
</ul>
<h2 id="脚本"><a class="markdownIt-Anchor" href="#脚本">#</a> 脚本</h2>
<p>所以在之前的 《Android 12 快速适配要点》 一文中提供了一套脚本，专门用于适配 Android 12 下缺少  <code>android:exported</code>  无法编译或者安装的问题，但是在这期间收到了不少问题反馈：</p>
<h3 id="comandroidtoolsbuildgradle400-以及其下版本"><a class="markdownIt-Anchor" href="#comandroidtoolsbuildgradle400-以及其下版本">#</a> com.android.tools.build:gradle:4.0.0 以及其下版本</h3>
<p>一下脚本经过测试最高可到支持的版本： <strong>gradle:4.0.0 &amp; gradle-6.1.1-all.zip</strong></p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 修改 Android 12 因为 exported 的构建问题</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">android.applicationVariants.all &#123; variant -&gt;</span><br><span class="line">    variant.outputs.all &#123; output -&gt;</span><br><span class="line">        output.processResources.<span class="keyword">doFirst</span> &#123; pm -&gt;</span><br><span class="line">            String manifestPath = output.processResources.manifestFile</span><br><span class="line">            <span class="keyword">def</span> manifestFile = <span class="keyword">new</span> <span class="keyword">File</span>(manifestPath)</span><br><span class="line">            <span class="keyword">def</span> xml = <span class="keyword">new</span> XmlParser(<span class="keyword">false</span>, <span class="keyword">true</span>).parse(manifestFile)</span><br><span class="line">            <span class="keyword">def</span> exportedTag = <span class="string">&quot;android:exported&quot;</span></span><br><span class="line">            <span class="comment">///指定 space</span></span><br><span class="line">            <span class="keyword">def</span> androidSpace = <span class="keyword">new</span> groovy.xml.Namespace(<span class="string">&#x27;http://schemas.android.com/apk/res/android&#x27;</span>, <span class="string">&#x27;android&#x27;</span>)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">def</span> nodes = xml.application[<span class="number">0</span>].<span class="string">&#x27;*&#x27;</span>.<span class="keyword">findAll</span> &#123;</span><br><span class="line">                <span class="comment">//挑选要修改的节点，没有指定的 exported 的才需要增加</span></span><br><span class="line">                (it.name() == <span class="string">&#x27;activity&#x27;</span> || it.name() == <span class="string">&#x27;receiver&#x27;</span> || it.name() == <span class="string">&#x27;service&#x27;</span>) &amp;&amp; it.attribute(androidSpace.exported) == <span class="keyword">null</span></span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">///添加 exported，默认 false</span></span><br><span class="line">            nodes.<span class="keyword">each</span> &#123;</span><br><span class="line">                <span class="keyword">def</span> isMain = <span class="keyword">false</span></span><br><span class="line">                it.<span class="keyword">each</span> &#123;</span><br><span class="line">                    <span class="keyword">if</span> (it.name() == <span class="string">&quot;intent-filter&quot;</span>) &#123;</span><br><span class="line">                        it.<span class="keyword">each</span> &#123;</span><br><span class="line">                            <span class="keyword">if</span> (it.name() == <span class="string">&quot;action&quot;</span>) &#123;</span><br><span class="line">                                <span class="keyword">if</span> (it.attributes().get(androidSpace.name) == <span class="string">&quot;android.intent.action.MAIN&quot;</span>) &#123;</span><br><span class="line">                                    isMain = <span class="keyword">true</span></span><br><span class="line">                                    <span class="keyword">println</span>(<span class="string">&quot;......................MAIN FOUND......................&quot;</span>)</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                it.attributes().put(exportedTag, <span class="string">&quot;$&#123;isMain&#125;&quot;</span>)</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            PrintWriter pw = <span class="keyword">new</span> PrintWriter(manifestFile)</span><br><span class="line">            pw.<span class="keyword">write</span>(groovy.xml.XmlUtil.serialize(xml))</span><br><span class="line">            pw.close()</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="comandroidtoolsbuildgradle400-以上版本"><a class="markdownIt-Anchor" href="#comandroidtoolsbuildgradle400-以上版本">#</a> com.android.tools.build:gradle:4.0.0 以上版本</h3>
<p>以下脚本经过测试支持的版本： <strong>gradle:4.1.0 &amp; gradle-6.5.1-all.zip</strong></p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 修改 Android 12 因为 exported 的构建问题</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line">android.applicationVariants.all &#123; variant -&gt;</span><br><span class="line">    variant.outputs.<span class="keyword">each</span> &#123; output -&gt;</span><br><span class="line">        <span class="keyword">def</span> processManifest = output.getProcessManifestProvider().get()</span><br><span class="line">        processManifest.<span class="keyword">doLast</span> &#123; <span class="keyword">task</span> -&gt;</span><br><span class="line">            <span class="keyword">def</span> outputDir = <span class="keyword">task</span>.multiApkManifestOutputDirectory</span><br><span class="line">            <span class="keyword">File</span> outputDirectory</span><br><span class="line">            <span class="keyword">if</span> (outputDir <span class="keyword">instanceof</span> <span class="keyword">File</span>) &#123;</span><br><span class="line">                outputDirectory = outputDir</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                outputDirectory = outputDir.get().asFile</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">File</span> manifestOutFile = <span class="keyword">file</span>(<span class="string">&quot;$outputDirectory/AndroidManifest.xml&quot;</span>)</span><br><span class="line">            <span class="keyword">println</span>(<span class="string">&quot;----------- $&#123;manifestOutFile&#125; ----------- &quot;</span>)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (manifestOutFile.exists() &amp;&amp; manifestOutFile.canRead() &amp;&amp; manifestOutFile.canWrite()) &#123;</span><br><span class="line">                <span class="keyword">def</span> manifestFile = manifestOutFile</span><br><span class="line">                <span class="comment">///这里第二个参数是 false ，所以 namespace 是展开的，所以下面不能用 androidSpace，而是用 nameTag</span></span><br><span class="line">                <span class="keyword">def</span> xml = <span class="keyword">new</span> XmlParser(<span class="keyword">false</span>, <span class="keyword">false</span>).parse(manifestFile)</span><br><span class="line">                <span class="keyword">def</span> exportedTag = <span class="string">&quot;android:exported&quot;</span></span><br><span class="line">                <span class="keyword">def</span> nameTag = <span class="string">&quot;android:name&quot;</span></span><br><span class="line">                <span class="comment">///指定 space</span></span><br><span class="line">                <span class="comment">//def androidSpace = new groovy.xml.Namespace(&#x27;http://schemas.android.com/apk/res/android&#x27;, &#x27;android&#x27;)</span></span><br><span class="line"></span><br><span class="line">                <span class="keyword">def</span> nodes = xml.application[<span class="number">0</span>].<span class="string">&#x27;*&#x27;</span>.<span class="keyword">findAll</span> &#123;</span><br><span class="line">                    <span class="comment">//挑选要修改的节点，没有指定的 exported 的才需要增加</span></span><br><span class="line">                    <span class="comment">//如果 exportedTag 拿不到可以尝试 it.attribute(androidSpace.exported)</span></span><br><span class="line">                    (it.name() == <span class="string">&#x27;activity&#x27;</span> || it.name() == <span class="string">&#x27;receiver&#x27;</span> || it.name() == <span class="string">&#x27;service&#x27;</span>) &amp;&amp; it.attribute(exportedTag) == <span class="keyword">null</span></span><br><span class="line"></span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">///添加 exported，默认 false</span></span><br><span class="line">                nodes.<span class="keyword">each</span> &#123;</span><br><span class="line">                    <span class="keyword">def</span> isMain = <span class="keyword">false</span></span><br><span class="line">                    it.<span class="keyword">each</span> &#123;</span><br><span class="line">                        <span class="keyword">if</span> (it.name() == <span class="string">&quot;intent-filter&quot;</span>) &#123;</span><br><span class="line">                            it.<span class="keyword">each</span> &#123;</span><br><span class="line">                                <span class="keyword">if</span> (it.name() == <span class="string">&quot;action&quot;</span>) &#123;</span><br><span class="line">                                    <span class="comment">//如果 nameTag 拿不到可以尝试 it.attribute(androidSpace.name)</span></span><br><span class="line">                                    <span class="keyword">if</span> (it.attributes().get(nameTag) == <span class="string">&quot;android.intent.action.MAIN&quot;</span>) &#123;</span><br><span class="line">                                        isMain = <span class="keyword">true</span></span><br><span class="line">                                        <span class="keyword">println</span>(<span class="string">&quot;......................MAIN FOUND......................&quot;</span>)</span><br><span class="line">                                    &#125;</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    it.attributes().put(exportedTag, <span class="string">&quot;$&#123;isMain&#125;&quot;</span>)</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                PrintWriter pw = <span class="keyword">new</span> PrintWriter(manifestFile)</span><br><span class="line">                pw.<span class="keyword">write</span>(groovy.xml.XmlUtil.serialize(xml))</span><br><span class="line">                pw.close()</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这段脚本你可以直接放到  <code>app/build.gradle</code>  下执行，也可以单独放到一个 gradle 文件之后  <code>apply</code>  引入，它的作用就是：</p>
<blockquote>
<p>在打包过程中检索所有没有设置  <code>exported</code>  的组件，给他们动态配置上  <code>exported</code> ，这里有个特殊需要注意的是，因为启动  <code>Activity</code>  默认就是需要被 Launcher 打开的，所以  <code>&quot;android.intent.action.MAIN&quot;</code>  需要  <code>exported</code>  设置为  <code>true</code>  。（<strong>PS：更正规应该是用 LAUNCHER 类别，这里故意用 MAIN</strong>）</p>
</blockquote>
<p>而后综合问题，具体反馈的问题有 ：</p>
<ul>
<li><code>label</code>  直接写死中文，不是引用  <code>@string</code>  导致的在 3.x 的版本可以正常运行，但不能打包 ；</li>
<li><code>XmlParser</code>  类找不到，这个首先确定 AGP 版本和 Gradle 版本是否匹配，具体可见 gradle-plugin，另外可以通过 <strong> <code>groovy.util.XmlParser</code> </strong> 或者 <strong> <code>groovy.xml.XmlParser</code> </strong> 全路径指定使用 ，如果是 gradle 文件里显示红色并不会影响运行；</li>
<li><strong>运行报错提示  <code>android:exported needs</code> ，这个就是今天需要输入聊的</strong>；</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Error</span>: <span class="attr">android</span>:exported needs to be explicitly specified <span class="keyword">for</span> &lt;xxxx&gt;. <span class="title class_">Apps</span> targeting <span class="title class_">Android</span> <span class="number">12</span> and higher are required to specify an explicit value <span class="keyword">for</span> <span class="string">`android:exported`</span> when the corresponding component has an intent filter defined.</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"> </span><br></pre></td></tr></table></figure>
<p>基于上述脚本测试和反馈，目前的结论是：</p>
<blockquote>
<p><strong>从  <code>gradle:4.2.0 &amp; gradle-6.7.1-all.zip</code>  开始，TargetSDK 31 下脚本会有异常，因为在  <code>processDebugMainManifest</code>  （带有 Main） 的阶段，会直接扫描依赖库的  <code>AndroidManifest.xml</code>  然后抛出直接报错，从而进不去  <code>processDebugManifest</code>  任务阶段就编译停止，所以实际上脚本并没有成功运行</strong>。</p>
</blockquote>
<p>所以此时拿不到  <code>mergerd_manifest</code>  下的文件，因为  <code>mergerd_manifest</code>  下  <code>AndroidManifest.xml</code>  也还没创建成功，没办法进入 task ，也就是该脚本目前只能针对  <code>gradle:4.1.0</code>  以及其下版本安装 apk 到 Android12 的机器上， 有  <code>intent-filter</code>  但没有 exoprted 的适配问题，<strong>基于这个问题，不知道各位是否有什么好的建议？</strong></p>
<h2 id="新脚本"><a class="markdownIt-Anchor" href="#新脚本">#</a> 新脚本</h2>
<p>而目前基于这个问题，这里提供了如下脚本，在  <code>gradle:4.2.0 &amp; gradle-6.7.1-all.zip</code>  以及  <code>7.0</code>  的版本上，<strong>该脚本的作用是在运行时自动帮你打印出现问题的 aar 包依赖路径和组建名称</strong>：</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">android.applicationVariants.all &#123; variant -&gt;</span><br><span class="line">    variant.outputs.<span class="keyword">each</span> &#123; output -&gt;</span><br><span class="line">        <span class="comment">//println(&quot;=============== $&#123;variant.getBuildType().name.toUpperCase()&#125; ===============&quot;)</span></span><br><span class="line">        <span class="comment">//println(&quot;=============== $&#123;variant.getFlavorName()&#125; ===============&quot;)</span></span><br><span class="line">        <span class="keyword">def</span> vn</span><br><span class="line">        <span class="keyword">if</span> (variant.getFlavorName() != <span class="keyword">null</span> &amp;&amp; variant.getFlavorName() != <span class="string">&quot;&quot;</span>) &#123;</span><br><span class="line">            vn = variant.name;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (variant.getBuildType().name == <span class="string">&quot;release&quot;</span>) &#123;</span><br><span class="line">                vn = <span class="string">&quot;Release&quot;</span></span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                vn = <span class="string">&quot;Debug&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">def</span> taskName = <span class="string">&quot;process$&#123;vn&#125;MainManifest&quot;</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">println</span>(<span class="string">&quot;=============== taskName $&#123;taskName&#125; ===============&quot;</span>)</span><br><span class="line">            <span class="keyword">project</span>.getTasks().getByName(taskName)</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">///你的自定义名字</span></span><br><span class="line">        <span class="keyword">project</span>.getTasks().getByName(taskName).<span class="keyword">doFirst</span> &#123;</span><br><span class="line">            <span class="comment">//def method = it.getClass().getMethods()</span></span><br><span class="line">            it.getManifests().getFiles().<span class="keyword">each</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (it.exists() &amp;&amp; it.canRead()) &#123;</span><br><span class="line">                    <span class="keyword">def</span> manifestFile = it</span><br><span class="line">                    <span class="keyword">def</span> exportedTag = <span class="string">&quot;android:exported&quot;</span></span><br><span class="line">                    <span class="keyword">def</span> nameTag = <span class="string">&quot;android:name&quot;</span></span><br><span class="line">                    <span class="comment">///这里第二个参数是 false ，所以 namespace 是展开的，所以下面不能用 androidSpace，而是用 nameTag</span></span><br><span class="line">                    <span class="keyword">def</span> xml = <span class="keyword">new</span> XmlParser(<span class="keyword">false</span>, <span class="keyword">false</span>).parse(manifestFile)</span><br><span class="line">                    <span class="keyword">if</span> (xml.application != <span class="keyword">null</span> &amp;&amp; xml.application.<span class="keyword">size</span>() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                        <span class="keyword">def</span> nodes = xml.application[<span class="number">0</span>].<span class="string">&#x27;*&#x27;</span>.<span class="keyword">findAll</span> &#123;</span><br><span class="line">                            <span class="comment">//挑选要修改的节点，没有指定的 exported 的才需要增加</span></span><br><span class="line">                            <span class="comment">//如果 exportedTag 拿不到可以尝试 it.attribute(androidSpace.exported)</span></span><br><span class="line">                            (it.name() == <span class="string">&#x27;activity&#x27;</span> || it.name() == <span class="string">&#x27;receiver&#x27;</span> || it.name() == <span class="string">&#x27;service&#x27;</span>) &amp;&amp; it.attribute(exportedTag) == <span class="keyword">null</span></span><br><span class="line"></span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">if</span> (nodes.application != <span class="keyword">null</span> &amp;&amp; nodes.application.<span class="keyword">size</span>() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                            nodes.<span class="keyword">each</span> &#123;</span><br><span class="line">                                <span class="keyword">def</span> t = it</span><br><span class="line">                                it.<span class="keyword">each</span> &#123;</span><br><span class="line">                                    <span class="keyword">if</span> (it.name() == <span class="string">&quot;intent-filter&quot;</span>) &#123;</span><br><span class="line">                                        <span class="keyword">println</span>(<span class="string">&quot;$manifestFile \n .....................$&#123;t.attributes().get(nameTag)&#125;......................&quot;</span>)</span><br><span class="line">                                    &#125;</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"> </span><br></pre></td></tr></table></figure>
<p>如下图所示，<strong>因为目前官方如红色信息内容其实指向并不正确，容易误导问题方向，所以通过上述脚本打印，可以快速查找到问题所在的点，然后通过  <code>tool:replace</code>  临时解决</strong>。</p>
<p><img src="https://img-blog.csdnimg.cn/img_convert/95c73f26b50f1880f6e8a6548ecbdd7a.png" alt="img"></p>
<p>具体为什么之前的脚本在高版本 AGP 下无法使用，原因在于新版本在  <code>processDebugMainManifest</code>  ，或者说  <code>processXXXXXXMainManifest</code>  的处理逻辑发生了变化，通过找到  <code>processDebugMainManifest</code>  的实现类，可以看到问题出现就是在于  <code>Merging library manifest</code>  。</p>
<blockquote>
<p><code>processDebugMainManifest</code>  的实现在 ProcessApplicationManifest 里，对应路径是 ProcessApplicationManifest -&gt; MainfestHelper mergeManifestsForApplication -&gt; MainfestMerger2</p>
</blockquote>
<p>错误是在  <code>Merging library manifest</code>  的阶段出现异常，但是这个阶段的 task 里对于第三方依赖路径的输入，主要是从  <code>private fun computeFullProviderList</code>  方法开始，所以输入到  <code>mergeManifestsForApplication</code>  里的第三方路径是通过这个私有方法生成。</p>
<p><img src="https://img-blog.csdnimg.cn/img_convert/5e0802f3e6ebb8d98de0b09c9603bbe4.png" alt="img"></p>
<p>感觉唯一可以考虑操作的就是内部的  <code>manifests</code>  对象去变换路径，但是它是  <code>private</code>  ，并且内部并不能很好复写其内容。</p>
<p><img src="https://img-blog.csdnimg.cn/img_convert/1b2cad1e51fd633a56c64c106219d76a.png" alt="img"></p>
<p><strong>另外因为 aar 文件里的  <code>AndroidManifset</code>  是 readOnly ，所以如果真的要修改，感觉只能在输入之前读取到对应  <code>AndroidManifset</code> ， 并生成临时文件，在  <code>manifests</code>  对象中更改其路径来完成</strong>，不知道大家有没有什么比较好的思路 。</p>
<blockquote>
<p>如果有好的解决办法，后续再更新。</p>
</blockquote>
<h2 id="最后"><a class="markdownIt-Anchor" href="#最后">#</a> 最后</h2>
<p>最后再说一个坑 ，如果你是低版本 Gradle 可以打包成功，但是运行到 Android12 机器的时候，可能会因为没有 exported 遇到安装失败的问题：</p>
<p>1、如果是模拟器 12，你可能会看到如下所示的错误提示 ，提示上显示还是很直观的， 直接告诉你是  <code>android:exported</code>  的问题：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">* <span class="title class_">What</span> went <span class="attr">wrong</span>:</span><br><span class="line"><span class="title class_">Execution</span> failed <span class="keyword">for</span> task <span class="string">&#x27;:app:installDebug&#x27;</span>.</span><br><span class="line">&gt; java.<span class="property">util</span>.<span class="property">concurrent</span>.<span class="property">ExecutionException</span>: com.<span class="property">android</span>.<span class="property">builder</span>.<span class="property">testing</span>.<span class="property">api</span>.<span class="property">DeviceException</span>: com.<span class="property">android</span>.<span class="property">ddmlib</span>.<span class="property">InstallException</span>: <span class="attr">INSTALL_PARSE_FAILED_MANIFEST_MALFORMED</span>: <span class="title class_">Failed</span> parse during <span class="attr">installPackageLI</span>: <span class="regexp">/data/</span>app/vmdl487461761.<span class="property">tmp</span>/base.<span class="property">apk</span> (at <span class="title class_">Binary</span> <span class="variable constant_">XML</span> file line #<span class="number">358</span>): xxxxx.<span class="property">Activity</span>: <span class="title class_">Targeting</span> S+ (version <span class="number">31</span> and above) requires that an explicit value <span class="keyword">for</span> <span class="attr">android</span>:exported be defined when intent filters are present</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"> </span><br></pre></td></tr></table></figure>
<p>2、如果你是真机 12，那可能就是这样的提示，提示然是  <code>INSTALL_FAILED_USER_RESTRICTED</code>  ，<strong>不得不说小米系统这个安装失败很具误导性，比如 minSDK 太高导致无法安装，在小米上也会是  <code>INSTALL_FAILED_USER_RESTRICTED</code> </strong>：</p>
<p><img src="https://img-blog.csdnimg.cn/img_convert/30ac3d45bb59a0a966036244d82bfc56.png" alt="img"></p>
<p>基本上内容就这些，具体如何进一步优化还待后续测试， <strong>所以针对脚本实现，你还有什么问题或者想法，欢迎评论交流 ～</strong></p>
<p>文章来源: <a target="_blank" rel="noopener" href="http://carguo.blog.csdn.net">carguo.blog.csdn.net</a>，作者：恋猫 de 小郭，版权归原作者所有，如需转载，请联系作者。</p>
<p>原文链接：<a target="_blank" rel="noopener" href="http://carguo.blog.csdn.net/article/details/123438734">carguo.blog.csdn.net/article/details/123438734</a></p>
<h2 id="关于我"><a class="markdownIt-Anchor" href="#关于我">#</a> 关于我</h2>
<p>Brath 是一个热爱技术的 Java 程序猿，公众号「InterviewCoder」定期分享有趣有料的精品原创文章！</p>
<p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/%E4%BA%8C%E7%BB%B4%E7%A0%81plus.png" alt="InterviewCoder"></p>
<p>非常感谢各位人才能看到这里，原创不易，文章如果有帮助可以关注、点赞、分享或评论，这都是对我的莫大支持！</p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2021-06-24T11:49:33.000Z" title="2021-6-24 19:49:33">2021-06-24</time>发表</span><span class="level-item"><time dateTime="2021-10-25T19:47:40.000Z" title="2021-10-26 3:47:40">2021-10-26</time>更新</span><span class="level-item">26 分钟读完 (大约3850个字)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2021/06/24/%E3%80%90%E6%9E%B6%E6%9E%84%E3%80%91DDD%E5%88%86%E5%B1%82%E6%9E%B6%E6%9E%84%E6%A8%A1%E5%9E%8B/">【架构】DDD分层架构模型</a></p><div class="content"><p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/%E6%89%AB%E7%A0%81_%E6%90%9C%E7%B4%A2%E8%81%94%E5%90%88%E4%BC%A0%E6%92%AD%E6%A0%B7%E5%BC%8F-%E6%A0%87%E5%87%86%E8%89%B2%E7%89%88.png" alt="InterviewCoder"></p>
<h1 id="架构ddd分层架构模型"><a class="markdownIt-Anchor" href="#架构ddd分层架构模型">#</a> 【架构】DDD 分层架构模型</h1>
<p>还在单体应用的时候就是分层架构一说，我们用得最多的就是<a target="_blank" rel="noopener" href="https://so.csdn.net/so/search?q=%E4%B8%89%E5%B1%82%E6%9E%B6%E6%9E%84&amp;spm=1001.2101.3001.7020">三层架构</a>。而现在已经是微服务时代，在微服务架构模型比较常用的有几个，例如：整洁架构，CQRS（命令查询分离）以及六边形架构。每种架构模型都有自己的应用场景，但其核心都是 “<strong>高内聚低耦合</strong>” 原则。而运用领域驱动设计（DDD）理念以应对日常加速的业务变化对架构的影响，架构的边界越来越清晰，各司其职，这也符合<a target="_blank" rel="noopener" href="https://so.csdn.net/so/search?q=%E5%BE%AE%E6%9C%8D%E5%8A%A1&amp;spm=1001.2101.3001.7020">微服务</a>架构的设计思想。以领域驱动设计（DDD）为理念的分层架构已经成为微服务架构实践的最佳实践方法。</p>
<h1 id="一-什么是ddd分层架构"><a class="markdownIt-Anchor" href="#一-什么是ddd分层架构">#</a> 一、什么是 DDD 分层架构</h1>
<h1 id="1-传统三层架构"><a class="markdownIt-Anchor" href="#1-传统三层架构">#</a> 1. 传统三层架构</h1>
<p>要了解 DDD 分层架构，首先先了解传统的三层架构。</p>
<p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/bc95fd968f658441bac8dde830d82d39.png" alt="DDD分层架构最佳实践"></p>
<p>传统三层架构流程：</p>
<ul>
<li>第一步考虑的是数据库设计，数据表如何建，表之间的关系如何设计</li>
<li>第二步就是搭建数据访问层，如选一个 ORM 框架或者拼接 SQL 操作</li>
<li>第三步就是业务逻辑的实现，由于我们先设计了数据库，我们整个的思考都会围绕着数据库，想着怎么写才能把数据正确地写入数据库中，这时 CRUD 的标准作法就出现了，也就没有太多考虑面向对象，解耦的事情了，这样的代码对日常的维护自然是越来越困难的</li>
<li>第四步表示层主要面向用户的输出</li>
</ul>
<h1 id="2-ddd分层架构"><a class="markdownIt-Anchor" href="#2-ddd分层架构">#</a> 2. DDD 分层架构</h1>
<p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/0688f3781f073a93538b05557b6dbe22.png" alt="DDD分层架构最佳实践"></p>
<p>为了解决高耦合问题并轻松应对以后的系统变化，我们提出了运用领域驱动设计的理念来设计架构。</p>
<blockquote>
<p>此段落部分总结来源于欧创新《DDD 实践课》的《07 | DDD 分层架构：有效降低层与层之间的依赖》读后感</p>
</blockquote>
<h1 id="1领域层"><a class="markdownIt-Anchor" href="#1领域层">#</a> 1）领域层</h1>
<p>首先我们抛开数据库的困扰，<strong>先从业务逻辑入手开始</strong>，设计时不再考虑数据库的实现。将以前的业务逻辑层（BLL）拆分成了领域层和应用层。</p>
<p>领域层聚焦业务对象的业务逻辑实现，体现现实世界业务的逻辑变化。它用来表达业务概念、业务状态和业务规则，对于业务分析可参照：《使用领域驱动设计分析业务》</p>
<h1 id="2应用层"><a class="markdownIt-Anchor" href="#2应用层">#</a> 2）应用层</h1>
<p>应用层是领域层的上层，依赖领域层，是各聚合的协调和编排，原则上是不包括任何业务逻辑。它以较粗粒度的封闭为前端接口提供支持。除了提供上层调用外，还可以包括事件和消息的订阅。</p>
<h1 id="3-用户接口层"><a class="markdownIt-Anchor" href="#3-用户接口层">#</a> 3） 用户接口层</h1>
<p>用户接口层面向用户访问的数据入向接口，可按不同场景提供不一样的用户接口实现。面向 Web 的可使用 http restful 的方式提供服务，可增加安全认证、权限校验，日志记录等功能；面向微服务的可使用 RPC 方式提供服务，可增加限流、熔断等功能。</p>
<h1 id="4-基础设施层"><a class="markdownIt-Anchor" href="#4-基础设施层">#</a> 4） 基础设施层</h1>
<p>基础设施层是数据的出向接口，封装数据调用的技术细节。可为其它任意层提供服务，但为了解决耦合的问题采用了依赖倒置原则。其它层只依赖基础设施的接口，于具体实现进行分离。</p>
<h1 id="二-ddd分层代码实现"><a class="markdownIt-Anchor" href="#二-ddd分层代码实现">#</a> 二、DDD 分层代码实现</h1>
<h1 id="1-结构模型"><a class="markdownIt-Anchor" href="#1-结构模型">#</a> 1. 结构模型</h1>
<p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/7ba92eeaedb20c360874015795e57354.png" alt="DDD分层架构最佳实践"></p>
<h1 id="2-目录结构"><a class="markdownIt-Anchor" href="#2-目录结构">#</a> 2. 目录结构</h1>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">.</span><br><span class="line">├── pom.xml</span><br><span class="line">└── src</span><br><span class="line">    ├── main</span><br><span class="line">    │   ├── java</span><br><span class="line">    │   │   └── fun</span><br><span class="line">    │   │       └── barryhome</span><br><span class="line">    │   │           └── ddd</span><br><span class="line">    │   │               ├── WalletApplication.java</span><br><span class="line">    │   │               ├── application</span><br><span class="line">    │   │               │   ├── TradeEventProcessor.java</span><br><span class="line">    │   │               │   ├── TradeMQReceiver.java</span><br><span class="line">    │   │               │   └── TradeManager.java</span><br><span class="line">    │   │               ├── constant</span><br><span class="line">    │   │               │   └── MessageConstant.java</span><br><span class="line">    │   │               ├── controller</span><br><span class="line">    │   │               │   ├── TradeController.java</span><br><span class="line">    │   │               │   ├── WalletController.java</span><br><span class="line">    │   │               │   └── dto</span><br><span class="line">    │   │               │       └── TradeDTO.java</span><br><span class="line">    │   │               ├── domain</span><br><span class="line">    │   │               │   ├── TradeService.java</span><br><span class="line">    │   │               │   ├── TradeServiceImpl.java</span><br><span class="line">    │   │               │   ├── enums</span><br><span class="line">    │   │               │   │   ├── InOutFlag.java</span><br><span class="line">    │   │               │   │   ├── TradeStatus.java</span><br><span class="line">    │   │               │   │   ├── TradeType.java</span><br><span class="line">    │   │               │   │   └── WalletStatus.java</span><br><span class="line">    │   │               │   ├── event</span><br><span class="line">    │   │               │   │   └── TradeEvent.java</span><br><span class="line">    │   │               │   ├── model</span><br><span class="line">    │   │               │   │   ├── BaseEntity.java</span><br><span class="line">    │   │               │   │   ├── TradeRecord.java</span><br><span class="line">    │   │               │   │   └── Wallet.java</span><br><span class="line">    │   │               │   └── repository</span><br><span class="line">    │   │               │       ├── TradeRepository.java</span><br><span class="line">    │   │               │       └── WalletRepository.java</span><br><span class="line">    │   │               └── infrastructure</span><br><span class="line">    │   │                   ├── TradeRepositoryImpl.java</span><br><span class="line">    │   │                   ├── WalletRepositoryImpl.java</span><br><span class="line">    │   │                   ├── cache</span><br><span class="line">    │   │                   │   └── Redis.java</span><br><span class="line">    │   │                   ├── client</span><br><span class="line">    │   │                   │   ├── AuthFeignClient.java</span><br><span class="line">    │   │                   │   └── LocalAuthClient.java</span><br><span class="line">    │   │                   ├── jpa</span><br><span class="line">    │   │                   │   ├── JpaTradeRepository.java</span><br><span class="line">    │   │                   │   └── JpaWalletRepository.java</span><br><span class="line">    │   │                   └── mq</span><br><span class="line">    │   │                       └── RabbitMQSender.java</span><br><span class="line">    │   └── resources</span><br><span class="line">    │       ├── application.properties</span><br><span class="line">    │       └── rabbitmq-spring.xml</span><br><span class="line">    └── test</span><br><span class="line">        └── java</span><br></pre></td></tr></table></figure>
<p>此结构为单一微服务的简单结构，各层在同一个模块中。</p>
<p>在大型项目开发过程中，为了达到核心模块的权限控制或更好的灵活性可适当调整结构，可参考《 数字钱包系统》系统结构</p>
<h1 id="3-领域层实现domain"><a class="markdownIt-Anchor" href="#3-领域层实现domain">#</a> 3. 领域层实现（domain）</h1>
<p>在业务分析（《使用领域驱动设计分析业务》）之后，开始编写代码，首先就是写领域层，创建领域对象和领域服务接口</p>
<h1 id="1领域对象"><a class="markdownIt-Anchor" href="#1领域对象">#</a> 1）领域对象</h1>
<p>这里的领域对象包括实体对象、值对象。</p>
<p><strong>实体对象</strong>：具有唯一标识，能单独存在且可变化的对象</p>
<p><strong>值对象</strong>：不能单独存在或在逻辑层面单独存在无意义，且不可变化的对象</p>
<p><strong>聚合</strong>：多个对象的集合，对外是一个整体</p>
<p><strong>聚合根</strong>：聚合中可代表整个业务操作的实体对象，通过它提供对外访问操作，它维护聚合内部的数据一致性，它是聚合中对象的管理者</p>
<p>代码示例：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line">// 交易</span><br><span class="line">public class TradeRecord extends BaseEntity &#123;</span><br><span class="line">    /**</span><br><span class="line">     * 交易号</span><br><span class="line">     */</span><br><span class="line">    @Column(unique = true)</span><br><span class="line">    private String tradeNumber;</span><br><span class="line">    /**</span><br><span class="line">     * 交易金额</span><br><span class="line">     */</span><br><span class="line">    private BigDecimal tradeAmount;</span><br><span class="line">    /**</span><br><span class="line">     * 交易类型</span><br><span class="line">     */</span><br><span class="line">    @Enumerated(EnumType.STRING)</span><br><span class="line">    private TradeType tradeType;</span><br><span class="line">    /**</span><br><span class="line">     * 交易余额</span><br><span class="line">     */</span><br><span class="line">    private BigDecimal balance;</span><br><span class="line">    /**</span><br><span class="line">     * 钱包</span><br><span class="line">     */</span><br><span class="line">    @ManyToOne</span><br><span class="line">    private Wallet wallet;</span><br><span class="line"> </span><br><span class="line">    /**</span><br><span class="line">     * 交易状态</span><br><span class="line">     */</span><br><span class="line">    @Enumerated(EnumType.STRING)</span><br><span class="line">    private TradeStatus tradeStatus;</span><br><span class="line"> </span><br><span class="line">  	@DomainEvents</span><br><span class="line">    public List&lt;Object&gt; domainEvents() &#123;</span><br><span class="line">        return Collections.singletonList(new TradeEvent(this));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">// 钱包</span><br><span class="line">public class Wallet extends BaseEntity &#123;</span><br><span class="line"> </span><br><span class="line">    /**</span><br><span class="line">     * 钱包ID</span><br><span class="line">     */</span><br><span class="line">    @Id</span><br><span class="line">    private String walletId;</span><br><span class="line">    /**</span><br><span class="line">     * 密码</span><br><span class="line">     */</span><br><span class="line">    private String password;</span><br><span class="line">    /**</span><br><span class="line">     * 状态</span><br><span class="line">     */</span><br><span class="line">    @Enumerated(EnumType.STRING)</span><br><span class="line">    private WalletStatus walletStatus = WalletStatus.AVAILABLE;</span><br><span class="line">    /**</span><br><span class="line">     * 用户Id</span><br><span class="line">     */</span><br><span class="line">    private Integer userId;</span><br><span class="line">    /**</span><br><span class="line">     * 余额</span><br><span class="line">     */</span><br><span class="line">    private BigDecimal balance = BigDecimal.ZERO;</span><br><span class="line"> </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>从<strong>钱包交易</strong>例子的系统设计中，钱包的任何操作如：充值、消息等都是通过交易对象驱动钱包余额的变化</li>
<li><strong>交易对象</strong>和<strong>钱包对象</strong>均为实体对象且组成聚合关系，<strong>交易对象</strong>是钱包交易业务模型的聚合根，代表聚合向外提供调用服务</li>
<li>经过分析<strong>交易对象</strong>与<strong>钱包对象</strong>为 1 对多关系（@ManyToOne），这里采用了 JPA 做<strong> ORM</strong> 架构，更多 JPA 实践请参考 &gt;&gt;</li>
<li>这里的领域建模使用的是贫血模型，结构简单，职责单一，相互隔离性好但缺乏面向对象设计思想，关于领域建模可参考《领域建模的贫血模型与充血模型》</li>
<li>domainEvents () 为领域事件发布的一种实现，作用是<strong>交易对象</strong>任何的数据操作都将触发事件的发布，再配合<strong>事件订阅</strong>实现<strong>事件驱动设计</strong>模型，当然也可以有别的实现方式</li>
</ul>
<h1 id="2领域服务"><a class="markdownIt-Anchor" href="#2领域服务">#</a> 2）领域服务</h1>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * Created on 2020/9/7 11:40 上午</span><br><span class="line"> *</span><br><span class="line"> * @author barry</span><br><span class="line"> * Description: 交易服务</span><br><span class="line"> */</span><br><span class="line">public interface TradeService &#123;</span><br><span class="line"> </span><br><span class="line">    /**</span><br><span class="line">     * 充值</span><br><span class="line">     *</span><br><span class="line">     * @param tradeRecord</span><br><span class="line">     * @return</span><br><span class="line">     */</span><br><span class="line">    TradeRecord recharge(TradeRecord tradeRecord);</span><br><span class="line"> </span><br><span class="line">    /**</span><br><span class="line">     * 消费</span><br><span class="line">     *</span><br><span class="line">     * @param tradeRecord</span><br><span class="line">     * @return</span><br><span class="line">     */</span><br><span class="line">    TradeRecord consume(TradeRecord tradeRecord);</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"> </span><br></pre></td></tr></table></figure>
<p>先定义服务接口，接口的定义需要遵循<strong>现实业务的操作</strong>，切勿以程序逻辑或数据库逻辑来设计定义出增删改查</p>
<ul>
<li>主要的思考方向是交易对象对外可提供哪些服务，这种服务的定义是<strong>粗粒度</strong>且<strong>高内聚</strong>的，切勿将某些具体代码实现层面的方法定义出来</li>
<li>接口的输入输出参数尽量考虑以对象的形式，充分兼容各种场景变化</li>
<li>关于前端需要的复杂查询方法可不在此定义，一般情况下查询并非是一种领域服务且没有数据变化，可单独处理</li>
<li>领域服务的实现主要关注逻辑实现，切勿包含技术基础类代码，比如缓存实现，数据库实现，远程调用等</li>
</ul>
<h1 id="3基础设施接口"><a class="markdownIt-Anchor" href="#3基础设施接口">#</a> 3）基础设施接口</h1>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">public interface TradeRepository &#123;</span><br><span class="line">    /**</span><br><span class="line">     * 保存</span><br><span class="line">     * @param tradeRecord</span><br><span class="line">     * @return</span><br><span class="line">     */</span><br><span class="line">    TradeRecord save(TradeRecord tradeRecord);</span><br><span class="line"> </span><br><span class="line">    /**</span><br><span class="line">     * 查询订单</span><br><span class="line">     * @param tradeNumber</span><br><span class="line">     * @return</span><br><span class="line">     */</span><br><span class="line">    TradeRecord findByTradeNumber(String tradeNumber);</span><br><span class="line"> </span><br><span class="line">    /**</span><br><span class="line">     * 发送MQ事件消息</span><br><span class="line">     * @param tradeEvent</span><br><span class="line">     */</span><br><span class="line">    void sendMQEvent(TradeEvent tradeEvent);</span><br><span class="line"> </span><br><span class="line">    /**</span><br><span class="line">     * 获取所有</span><br><span class="line">     * @return</span><br><span class="line">     */</span><br><span class="line">    List&lt;TradeRecord&gt; findAll();</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"> </span><br></pre></td></tr></table></figure>
<ul>
<li>基础设施接口放在领域层主要的目的是减少领域层对基础设施层的依赖</li>
<li>接口的设计是不可暴露实现的技术细节，如不能将拼装的 SQL 作为参数</li>
</ul>
<h1 id="4-应用层实现application"><a class="markdownIt-Anchor" href="#4-应用层实现application">#</a> 4. 应用层实现（application）</h1>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">// 交易服务</span><br><span class="line">@Component</span><br><span class="line">public class TradeManager &#123;</span><br><span class="line"> </span><br><span class="line">    private final TradeService tradeService;</span><br><span class="line">    public TradeManager(TradeService tradeService) &#123;</span><br><span class="line">        this.tradeService = tradeService;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">    // 充值</span><br><span class="line">    @Transactional(rollbackFor = Exception.class)</span><br><span class="line">    public TradeRecord recharge(TradeRecord tradeRecord) &#123;</span><br><span class="line">        return tradeService.recharge(tradeRecord);</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">     // 消费</span><br><span class="line">    @Transactional(rollbackFor = Exception.class)</span><br><span class="line">    public TradeRecord consume(TradeRecord tradeRecord) &#123;</span><br><span class="line">        return tradeService.consume(tradeRecord);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">// 交易事件订阅</span><br><span class="line">@Component</span><br><span class="line">public class TradeEventProcessor &#123;</span><br><span class="line"> </span><br><span class="line">    @Autowired</span><br><span class="line">    private TradeRepository tradeRepository;</span><br><span class="line"> </span><br><span class="line">    @TransactionalEventListener(phase = TransactionPhase.AFTER_COMMIT, condition = &quot;# tradeEvent.tradeStatus.name() == &#x27;SUCCEED&#x27;&quot;)</span><br><span class="line">    public void TradeSucceed(TradeEvent tradeEvent) &#123;</span><br><span class="line">        tradeRepository.sendMQEvent(tradeEvent);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">// 交易消息订阅</span><br><span class="line">@Component</span><br><span class="line">public class TradeMQReceiver &#123;</span><br><span class="line"> </span><br><span class="line">    @RabbitListener(queues = &quot;ddd-trade-succeed&quot;)</span><br><span class="line">    public void receiveTradeMessage(TradeEvent tradeEvent)&#123;</span><br><span class="line">        System.err.println(&quot;========MQ Receiver============&quot;);</span><br><span class="line">        System.err.println(tradeEvent);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"> </span><br></pre></td></tr></table></figure>
<p><strong>应用服务</strong>：</p>
<ul>
<li>应用层是很薄的一层，主要用于调用和组合领域服务，切勿包含任何业务逻辑</li>
<li>可包括少量的流程参数判断</li>
<li>由于可能是多个领域服务组合操作调用，如果存在原子性要求可以增加 **@Transactional** 事务控制</li>
</ul>
<p><strong>事件订阅</strong>：</p>
<ul>
<li>事件订阅是进程内多个领域操作协作解耦的一种实现方式，它也是进程内所有后续操作的接入口</li>
<li>它与应用服务的组合操作用途不一样，组合是根据场景需求可增可减，但事件订阅后的操作是相对固化的，主要是满足逻辑的一致性要求</li>
</ul>
<p><strong>TransactionPhase.AFTER_COMMIT</strong> 配置是在前一操作事务完成后再调用，从而减少后续操作对前操作的影响</p>
<ul>
<li>事件订阅可能会有多个消息主体，为了方便管理最好统一在一个类里处理</li>
<li>MQ 消息发布一般放在事件订阅中</li>
</ul>
<p><strong>消息订阅</strong>：</p>
<ul>
<li>消息订阅是多个微服务间协作解耦的一步实现方式</li>
<li>消息体尽量以统一的对象包装进行传递，降低对象异构带来的处理难度</li>
</ul>
<h1 id="5-基础设施层infrastructure"><a class="markdownIt-Anchor" href="#5-基础设施层infrastructure">#</a> 5. 基础设施层（infrastructure）</h1>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">@Repository</span><br><span class="line">public class TradeRepositoryImpl implements TradeRepository &#123;</span><br><span class="line"> </span><br><span class="line">    private final JpaTradeRepository jpaTradeRepository;</span><br><span class="line">    private final RabbitMQSender rabbitMQSender;</span><br><span class="line">    private final Redis redis;</span><br><span class="line"> </span><br><span class="line">    public TradeRepositoryImpl(JpaTradeRepository jpaTradeRepository, RabbitMQSender rabbitMQSender, Redis redis) &#123;</span><br><span class="line">        this.jpaTradeRepository = jpaTradeRepository;</span><br><span class="line">        this.rabbitMQSender = rabbitMQSender;</span><br><span class="line">        this.redis = redis;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    @Override</span><br><span class="line">    public TradeRecord save(TradeRecord tradeRecord) &#123;</span><br><span class="line">        return jpaTradeRepository.save(tradeRecord);</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    /**</span><br><span class="line">     * 查询订单</span><br><span class="line">     */</span><br><span class="line">    @Override</span><br><span class="line">    public TradeRecord findByTradeNumber(String tradeNumber) &#123;</span><br><span class="line">        TradeRecord tradeRecord = redis.getTrade(tradeNumber);</span><br><span class="line">        if (tradeRecord == null)&#123;</span><br><span class="line">            tradeRecord = jpaTradeRepository.findFirstByTradeNumber(tradeNumber);</span><br><span class="line">            // 缓存</span><br><span class="line">            redis.cacheTrade(tradeRecord);</span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line">        return tradeRecord;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    /**</span><br><span class="line">     * 发送事件消息</span><br><span class="line">     * @param tradeEvent</span><br><span class="line">     */</span><br><span class="line">    @Override</span><br><span class="line">    public void sendMQEvent(TradeEvent tradeEvent) &#123;</span><br><span class="line">        // 发送消息</span><br><span class="line">        rabbitMQSender.sendMQTradeEvent(tradeEvent);</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    /**</span><br><span class="line">     * 获取所有</span><br><span class="line">     */</span><br><span class="line">    @Override</span><br><span class="line">    public List&lt;TradeRecord&gt; findAll() &#123;</span><br><span class="line">        return jpaTradeRepository.findAll();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"> </span><br></pre></td></tr></table></figure>
<ul>
<li>基础设施层是数据的输出向，主要包含数据库、缓存、消息队列、远程访问等的技术实现</li>
<li>基础设计层对外隐藏技术实现细节，提供粗粒度的数据输出服务</li>
<li>数据库操作：领域层传递的是数据对象，在这里可以按数据表的实现方式进行拆分实现</li>
</ul>
<h1 id="6-用户接口层controller"><a class="markdownIt-Anchor" href="#6-用户接口层controller">#</a> 6. 用户接口层（controller）</h1>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">@RequestMapping</span>(<span class="string">&quot;/trade&quot;</span>)</span><br><span class="line"><span class="variable">@RestController</span></span><br><span class="line">public class TradeController &#123;</span><br><span class="line"> </span><br><span class="line">    <span class="variable">@Autowired</span></span><br><span class="line">    private TradeManager tradeManager;</span><br><span class="line"> </span><br><span class="line">    <span class="variable">@Autowired</span></span><br><span class="line">    private TradeRepository tradeRepository;</span><br><span class="line"> </span><br><span class="line">    <span class="variable">@PostMapping</span>(path = <span class="string">&quot;/recharge&quot;</span>)</span><br><span class="line">    public TradeDTO <span class="built_in">recharge</span>(<span class="variable">@RequestBody</span> TradeDTO tradeDTO) &#123;</span><br><span class="line">        <span class="selector-tag">return</span> <span class="selector-tag">TradeDTO</span><span class="selector-class">.toDto</span>(tradeManager.<span class="built_in">recharge</span>(tradeDTO.<span class="built_in">toEntity</span>()));</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    @<span class="selector-tag">PostMapping</span>(path = <span class="string">&quot;/consume&quot;</span>)</span><br><span class="line">    <span class="selector-tag">public</span> <span class="selector-tag">TradeDTO</span> <span class="selector-tag">consume</span>(<span class="variable">@RequestBody</span> TradeDTO tradeDTO) &#123;</span><br><span class="line">        <span class="selector-tag">return</span> <span class="selector-tag">TradeDTO</span><span class="selector-class">.toDto</span>(tradeManager.<span class="built_in">consume</span>(tradeDTO.<span class="built_in">toEntity</span>()));</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    @<span class="selector-tag">GetMapping</span>(path = <span class="string">&quot;/&#123;tradeNumber&#125;&quot;</span>)</span><br><span class="line">    <span class="selector-tag">public</span> <span class="selector-tag">TradeDTO</span> <span class="selector-tag">findByTradeNumber</span>(<span class="variable">@PathVariable</span>(<span class="string">&quot;tradeNumber&quot;</span>) String tradeNumber)&#123;</span><br><span class="line">        <span class="selector-tag">return</span> <span class="selector-tag">TradeDTO</span><span class="selector-class">.toDto</span>(tradeRepository.<span class="built_in">findByTradeNumber</span>(tradeNumber));</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"> </span><br></pre></td></tr></table></figure>
<ul>
<li>用户接口层面向终端提供服务支持</li>
<li>可根据不同的场景单独一个模块，面向 Web 提供 http restful，面向服务间 API 调用提供 RPG 支持</li>
<li>为 Web 端提供身份认证和权限验证服务，VO 数据转换</li>
<li>为 API 端提供限流和熔断服务，DTO 数据转换</li>
<li>将数据转换从应用层提到用户接口层更方便不同场景之前的需求变化，同时也保证应用层数据格式的统一性</li>
</ul>
<h1 id="7-复杂数据查询"><a class="markdownIt-Anchor" href="#7-复杂数据查询">#</a> 7. 复杂数据查询</h1>
<p>以上可见并没有涉及复杂数据查询问题，此问题不涉及业务逻辑处理所以不应该放在领域层处理。</p>
<p>如果复杂数据查询需求较多可采用 CQRS 模式，将查询单独一个模块处理。如果较少可由基础设施层做数据查询，应用层做数据封装，用户接口层做数据调用</p>
<ul>
<li>JPA 不太适合做多表关联的数据库查询操作，可使用其它的灵活性较高的 ORM 架构</li>
</ul>
<p>在大数据大并发情况下，多表关联会严重影响数据库性能，可以考虑做<strong>宽表查询</strong></p>
<h1 id="三-综述"><a class="markdownIt-Anchor" href="#三-综述">#</a> 三、综述</h1>
<p>DDD 分层主要解决各层之间耦合度问题，做到各层各施其职互不影响。各层中领域层的设计是整个系统的中枢，最能体现领域驱动设计的核心思想。它的良好设计是保证往后架构的可持续性，可维护性。</p>
<h2 id="关于我"><a class="markdownIt-Anchor" href="#关于我">#</a> 关于我</h2>
<p>Brath 是一个热爱技术的 Java 程序猿，公众号「InterviewCoder」定期分享有趣有料的精品原创文章！</p>
<p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/%E4%BA%8C%E7%BB%B4%E7%A0%81plus.png" alt="InterviewCoder"></p>
<p>非常感谢各位人才能看到这里，原创不易，文章如果有帮助可以关注、点赞、分享或评论，这都是对我的莫大支持！</p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2021-06-20T01:05:20.000Z" title="2021-6-20 9:05:20">2021-06-20</time>发表</span><span class="level-item"><time dateTime="2020-01-16T23:30:43.000Z" title="2020-1-17 7:30:43">2020-01-17</time>更新</span><span class="level-item">1 分钟读完 (大约206个字)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2021/06/20/%E3%80%90Java%E3%80%91%E7%AB%AF%E5%8F%A3%E5%8F%B7%E8%A2%AB%E5%8D%A0%E7%94%A8%E7%9A%84%E6%83%85%E5%86%B5%E5%A6%82%E4%BD%95%E8%A7%A3%E5%86%B3/">端口占用问题</a></p><div class="content"><p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/%E6%89%AB%E7%A0%81_%E6%90%9C%E7%B4%A2%E8%81%94%E5%90%88%E4%BC%A0%E6%92%AD%E6%A0%B7%E5%BC%8F-%E6%A0%87%E5%87%86%E8%89%B2%E7%89%88.png" alt="InterviewCoder"></p>
<p>安装好 Maven 之后配置环境变量：</p>
<p>netstat -ano：查询全部活动连接</p>
<p>tasklist ：查询全部的进程和 PID</p>
<p>tasklist | findstr “占用端口的进程 PID”</p>
<p>taskkill /f/t /im 占用端口的进程名字.exe</p>
<h2 id="关于我"><a class="markdownIt-Anchor" href="#关于我">#</a> 关于我</h2>
<p>Brath 是一个热爱技术的 Java 程序猿，公众号「InterviewCoder」定期分享有趣有料的精品原创文章！</p>
<p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/%E4%BA%8C%E7%BB%B4%E7%A0%81plus.png" alt="InterviewCoder"></p>
<p>非常感谢各位人才能看到这里，原创不易，文章如果有帮助可以关注、点赞、分享或评论，这都是对我的莫大支持！</p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2021-06-17T00:05:58.000Z" title="2021-6-17 8:05:58">2021-06-17</time>发表</span><span class="level-item"><time dateTime="2020-08-05T19:29:14.000Z" title="2020-8-6 3:29:14">2020-08-06</time>更新</span><span class="level-item">3 分钟读完 (大约497个字)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2021/06/17/%E3%80%90Maven%E3%80%91MVN%E5%BC%95%E5%85%A5Jar%E5%8C%85%E6%B5%81%E7%A8%8B/">Maven通过命令提示符引入jar包的流程</a></p><div class="content"><p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/%E6%89%AB%E7%A0%81_%E6%90%9C%E7%B4%A2%E8%81%94%E5%90%88%E4%BC%A0%E6%92%AD%E6%A0%B7%E5%BC%8F-%E6%A0%87%E5%87%86%E8%89%B2%E7%89%88.png" alt="InterviewCoder"></p>
<p>安装好 Maven 之后配置环境变量：</p>
<p>​		在系统变量新建 “MAVEN_HOME” 值为：Maven 的安装路径：<strong>E:\Maven\apache-maven-3.5.3</strong>，接着在 Path 变量中，添加：% MAVEN_HOME%\bin，指定 maven 的 bin 路径。</p>
<p>​		现在在 CMD 中就可以用 mvn -v 的命令查看是否安装成功：</p>
<p><img src="f:%5Cmd%E5%9B%BE%E7%89%87%5Cmaven%E7%8E%AF%E5%A2%83.png" alt="maven环境"></p>
<h3 id="引入流程"><a class="markdownIt-Anchor" href="#引入流程">#</a> 引入流程：</h3>
<p>​		接下来找到你要引入的 jar 包的根路径，指定路径 + jar 包名，指定 groupId、artifactId、version 名，就可以引入了。</p>
<h4 id="举例"><a class="markdownIt-Anchor" href="#举例">#</a> 举例:</h4>
<p>​		mvn install:install-file -Dfile=D:\jar\WxQyhPrj\0.0.1-SNAPSHOT\WxQyhPrj-0.0.1-SNAPSHOT.jar -DgroupId=com.chis.wx -DartifactId=WxQyhPrj -Dversion=0.0.1-SNAPSHOT -Dpackaging=jar</p>
<p>​		mvn install:install-file -Dfile：Jar 包的绝对路径</p>
<p>​		-DgroupId：Jar 包的 groupId 分组 id</p>
<p>​		-DartiactId：Jar 包的 artifactId 版本 id</p>
<p>​		-Dversion：Jar 包的 version 版本</p>
<p>其中<br>
– DgroupId 和 DartifactId 构成了该 jar 包在 pom.xml 的坐标， 对应依赖的 DgroupId 和 DartifactId</p>
<p>– Dfile 表示需要上传的 jar 包的绝对路径</p>
<p>– Dpackaging 为安装文件的种类</p>
<p>– DgroupId 和 DartifactId 构成了该 jar 包在 pom.xml 的坐标， 对应依赖的 DgroupId 和 DartifactId</p>
<p>– Dfile 表示需要上传的 jar 包的绝对路径</p>
<p>– Durl 私服上仓库的 url 精确地址 (打开 nexus 左侧 repositories 菜单，可以看到该路径)</p>
<p>– DrepositoryId 服务器的表示 id，在 nexus 的 configuration 可以看到</p>
<h2 id="关于我"><a class="markdownIt-Anchor" href="#关于我">#</a> 关于我</h2>
<p>Brath 是一个热爱技术的 Java 程序猿，公众号「InterviewCoder」定期分享有趣有料的精品原创文章！</p>
<p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/%E4%BA%8C%E7%BB%B4%E7%A0%81plus.png" alt="InterviewCoder"></p>
<p>非常感谢各位人才能看到这里，原创不易，文章如果有帮助可以关注、点赞、分享或评论，这都是对我的莫大支持！</p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2021-06-15T23:57:34.000Z" title="2021-6-16 7:57:34">2021-06-16</time>发表</span><span class="level-item"><time dateTime="2022-10-16T08:39:22.000Z" title="2022-10-16 16:39:22">2022-10-16</time>更新</span><span class="level-item">4 分钟读完 (大约611个字)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2021/06/16/%E3%80%90SpringCloudAlibaba%E3%80%91Seata%E9%83%A8%E7%BD%B2Linux%E6%96%87%E6%A1%A3/">Linux以及Windows部署Seata服务</a></p><div class="content"><p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/%E6%89%AB%E7%A0%81_%E6%90%9C%E7%B4%A2%E8%81%94%E5%90%88%E4%BC%A0%E6%92%AD%E6%A0%B7%E5%BC%8F-%E6%A0%87%E5%87%86%E8%89%B2%E7%89%88.png" alt="InterviewCoder"></p>
<p>1. 确保 linux 有 Nacos 正常启动，并知晓正确的端口 用户名 密码</p>
<ol start="2">
<li><a target="_blank" rel="noopener" href="https://github.com/seata/seata.git">https://github.com/seata/seata.git</a> 克隆 seata 项目到本地</li>
<li>在 Github 下载对应你项目 SpringCloudAlibaba 建议版本的 Seata，我的版本是 2.5.5，建议 Seata 版本 1.3.0</li>
<li>下载好后进入 seata/conf 配置目录，修改 file.conf</li>
</ol>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">## transaction log store<span class="punctuation">,</span> only used in seata-server</span><br><span class="line">store <span class="punctuation">&#123;</span></span><br><span class="line">  ## store mode<span class="punctuation">:</span> file、db、redis</span><br><span class="line">  mode = <span class="string">&quot;db&quot;</span> #如果单机：file 如果是集群：db  并在下方配置你的Mysql数据源</span><br><span class="line"></span><br><span class="line">  ## file store property</span><br><span class="line">  file <span class="punctuation">&#123;</span></span><br><span class="line">    ## store location dir</span><br><span class="line">    dir = <span class="string">&quot;sessionStore&quot;</span></span><br><span class="line">    # branch session size <span class="punctuation">,</span> if exceeded first try compress lockkey<span class="punctuation">,</span> still exceeded throws exceptions</span><br><span class="line">    maxBranchSessionSize = <span class="number">16384</span></span><br><span class="line">    # globe session size <span class="punctuation">,</span> if exceeded throws exceptions</span><br><span class="line">    maxGlobalSessionSize = <span class="number">512</span></span><br><span class="line">    # file buffer size <span class="punctuation">,</span> if exceeded allocate new buffer</span><br><span class="line">    fileWriteBufferCacheSize = <span class="number">16384</span></span><br><span class="line">    # when recover batch read size</span><br><span class="line">    sessionReloadReadSize = <span class="number">100</span></span><br><span class="line">    # async<span class="punctuation">,</span> sync</span><br><span class="line">    flushDiskMode = async</span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"></span><br><span class="line">  ## database store property</span><br><span class="line">  db <span class="punctuation">&#123;</span></span><br><span class="line">    ## the implement of javax.sql.DataSource<span class="punctuation">,</span> such as DruidDataSource(druid)/BasicDataSource(dbcp)/HikariDataSource(hikari) etc.</span><br><span class="line">    datasource = <span class="string">&quot;druid&quot;</span></span><br><span class="line">    ## mysql/oracle/postgresql/h2/oceanbase etc.</span><br><span class="line">    dbType = <span class="string">&quot;mysql&quot;</span></span><br><span class="line">    driverClassName = <span class="string">&quot;com.mysql.jdbc.Driver&quot;</span></span><br><span class="line">    url = <span class="string">&quot;jdbc:mysql://sh-cynosdbmysql-grp-o5n8fbw2.sql.tencentcdb.com:20345/seata_server&quot;</span></span><br><span class="line">    user = <span class="string">&quot;brath&quot;</span></span><br><span class="line">    password = <span class="string">&quot;Lgq081538&quot;</span></span><br><span class="line">    minConn = <span class="number">5</span></span><br><span class="line">    maxConn = <span class="number">30</span></span><br><span class="line">    globalTable = <span class="string">&quot;global_table&quot;</span></span><br><span class="line">    branchTable = <span class="string">&quot;branch_table&quot;</span></span><br><span class="line">    lockTable = <span class="string">&quot;lock_table&quot;</span></span><br><span class="line">    queryLimit = <span class="number">100</span></span><br><span class="line">    maxWait = <span class="number">5000</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<p>5. 修改 registry.conf</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">registry <span class="punctuation">&#123;</span></span><br><span class="line">  type = <span class="string">&quot;nacos&quot;</span>  <span class="comment">//配置nacos</span></span><br><span class="line"></span><br><span class="line">  nacos <span class="punctuation">&#123;</span></span><br><span class="line">    application = <span class="string">&quot;seata-server&quot;</span></span><br><span class="line">    serverAddr = <span class="string">&quot;nacosip+端口&quot;</span> <span class="comment">//nacosip+端口</span></span><br><span class="line">    group = <span class="string">&quot;SEATA_GROUP&quot;</span></span><br><span class="line">    namespace = <span class="string">&quot;命名空间&quot;</span> <span class="comment">//如果默认可以不填</span></span><br><span class="line">    cluster = <span class="string">&quot;default&quot;</span> <span class="comment">//如果是集群请填写集群名</span></span><br><span class="line">    username = <span class="string">&quot;账号&quot;</span></span><br><span class="line">    password = <span class="string">&quot;密码&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line">  file <span class="punctuation">&#123;</span></span><br><span class="line">    name = <span class="string">&quot;file.conf&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"></span><br><span class="line">config <span class="punctuation">&#123;</span></span><br><span class="line">  type = <span class="string">&quot;nacos&quot;</span></span><br><span class="line"></span><br><span class="line">  nacos <span class="punctuation">&#123;</span></span><br><span class="line">    serverAddr = <span class="string">&quot;nacosip+端口&quot;</span> <span class="comment">//nacosip+端口</span></span><br><span class="line">    namespace = <span class="string">&quot;命名空间&quot;</span> <span class="comment">//如果默认可以不填</span></span><br><span class="line">    group = <span class="string">&quot;SEATA_GROUP&quot;</span></span><br><span class="line">    username = <span class="string">&quot;账号&quot;</span></span><br><span class="line">    password = <span class="string">&quot;密码&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line">  </span><br><span class="line">  file <span class="punctuation">&#123;</span></span><br><span class="line">    name = <span class="string">&quot;file.conf&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>6. 在克隆好的项目中找到 script/confing-center 找到 config.txt 文件</p>
<p>修改</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">store.mode=db</span><br></pre></td></tr></table></figure>
<p>修改数据源</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">store.db.url=localhost:3306/seata_server?useUnicode=true&amp;rewriteBatchedStatements=true</span><br><span class="line">store.db.user=****</span><br><span class="line">store.db.password=****</span><br></pre></td></tr></table></figure>
<p>进入 script\config-center\nacos</p>
<p>如果是 windows 系统请确保安装了 GIT 以及 GIT bash</p>
<p><a target="_blank" rel="noopener" href="http://xn--nacos-config-wm5t9655a.sh">点击 nacos-config.sh</a> 会自动把 config.txt 配置文件，配置到你的 Nacos 客户端中指定命名空间的配置中心供你的 Seata 使用</p>
<p>7. 进入 Seata/bin</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sh seata-server.sh #启动seata服务</span><br></pre></td></tr></table></figure>
<h2 id="关于我"><a class="markdownIt-Anchor" href="#关于我">#</a> 关于我</h2>
<p>Brath 是一个热爱技术的 Java 程序猿，公众号「InterviewCoder」定期分享有趣有料的精品原创文章！</p>
<p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/%E4%BA%8C%E7%BB%B4%E7%A0%81plus.png" alt="InterviewCoder"></p>
<p>非常感谢各位人才能看到这里，原创不易，文章如果有帮助可以关注、点赞、分享或评论，这都是对我的莫大支持！</p>
</div></article></div><nav class="pagination" role="navigation" aria-label="pagination"><div class="pagination-previous"><a href="/page/11/">上一页</a></div><div class="pagination-next"><a href="/page/13/">下一页</a></div><ul class="pagination-list is-hidden-mobile"><li><a class="pagination-link" href="/">1</a></li><li><span class="pagination-ellipsis">&hellip;</span></li><li><a class="pagination-link" href="/page/11/">11</a></li><li><a class="pagination-link is-current" href="/page/12/">12</a></li><li><a class="pagination-link" href="/page/13/">13</a></li><li><a class="pagination-link" href="/page/14/">14</a></li><li><a class="pagination-link" href="/page/15/">15</a></li></ul></nav></div><div class="column column-left is-4-tablet is-4-desktop is-3-widescreen  order-1"><!--!--><div class="card widget" data-type="recent-posts"><div class="card-content"><h3 class="menu-label">最新文章</h3><article class="media"><div class="media-content"><p class="date"><time dateTime="2023-05-17T08:20:40.000Z">2023-05-17</time></p><p class="title"><a href="/2023/05/17/%E3%80%90Java%E3%80%91%E8%AE%B0%E4%B8%80%E6%AC%A1%E7%BA%BF%E4%B8%8A%E6%95%85%E9%9A%9C%EF%BC%9A%E6%9C%8D%E5%8A%A1%E6%8E%A5%E5%8F%A3%E6%97%A0%E5%93%8D%E5%BA%94/">【Java】记一次线上故障：服务接口无响应</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2023-05-17T05:23:03.000Z">2023-05-17</time></p><p class="title"><a href="/2023/05/17/%E3%80%90Java%E3%80%91%E4%BD%BF%E7%94%A8%20Java%208%20%E4%B8%AD%E7%9A%84%20Stream%20%EF%BC%8C%E5%8F%AF%E4%BB%A5%E8%AE%A9%E4%BD%A0%E5%86%99%E4%BB%A3%E7%A0%81%E4%BA%8B%E5%8D%8A%E5%8A%9F%E5%80%8D/">【Java】使用 Java 8 中的 Stream ，可以让你写代码事半功倍</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2023-05-08T14:20:55.000Z">2023-05-08</time></p><p class="title"><a href="/2023/05/08/%E3%80%90Java%E3%80%91volatile%E5%85%B3%E9%94%AE%E5%AD%97/">【Java】volatile关键字</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2023-05-08T14:14:55.000Z">2023-05-08</time></p><p class="title"><a href="/2023/05/08/%E3%80%90Java%E3%80%91%E5%A4%9A%E7%A7%8D%E4%BB%A3%E7%90%86%E7%9A%84%E5%AE%9E%E7%8E%B0%E6%96%B9%E5%BC%8F/">【Java】多种代理的实现方式</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2023-05-08T14:04:55.000Z">2023-05-08</time></p><p class="title"><a href="/2023/05/08/%E3%80%90Java%E3%80%91HashMap%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E8%A7%A3%E8%AF%BB/">【Java】HashMap核心原理解读</a></p></div></article></div></div><div class="card widget" data-type="archives"><div class="card-content"><div class="menu"><h3 class="menu-label">归档</h3><ul class="menu-list"><li><a class="level is-mobile" href="/archives/2023/"><span class="level-start"><span class="level-item">2023</span></span><span class="level-end"><span class="level-item tag">42</span></span></a></li><li><a class="level is-mobile" href="/archives/2022/"><span class="level-start"><span class="level-item">2022</span></span><span class="level-end"><span class="level-item tag">52</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/"><span class="level-start"><span class="level-item">2021</span></span><span class="level-end"><span class="level-item tag">44</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/"><span class="level-start"><span class="level-item">2020</span></span><span class="level-end"><span class="level-item tag">5</span></span></a></li></ul></div></div></div><!--!--><div class="card widget" data-type="profile"><div class="card-content"><nav class="level"><div class="level-item has-text-centered flex-shrink-1"><div><figure class="image is-128x128 mx-auto mb-2"><img class="avatar" src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/%E4%BA%8C%E7%BB%B4%E7%A0%81plus.png" alt="InterviewCoder"></figure><p class="title is-size-4 is-block" style="line-height:inherit;">InterviewCoder</p><p class="is-size-6 is-block">面试记官方公众号</p></div></div></nav><nav class="level is-mobile"><div class="level-item has-text-centered is-marginless"><div><p class="heading">文章</p><a href="/archives"><p class="title">143</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">分类</p><a href="/categories"><p class="title">0</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">标签</p><a href="/tags"><p class="title">0</p></a></div></div></nav><div class="level"><a class="level-item button is-primary is-rounded" href="https://mp.weixin.qq.com/s/jWs6lLHl5L-atXJhHc4YvA" target="_blank" rel="noopener">关注我</a></div></div></div><div class="column-right-shadow is-hidden-widescreen"></div></div><div class="column column-right is-4-tablet is-4-desktop is-3-widescreen is-hidden-touch is-hidden-desktop-only order-3"><div class="card widget" data-type="profile"><div class="card-content"><nav class="level"><div class="level-item has-text-centered flex-shrink-1"><div><figure class="image is-128x128 mx-auto mb-2"><img class="avatar is-rounded" src="https://brath.cloud/me.png" alt="Brath"></figure><p class="title is-size-4 is-block" style="line-height:inherit;">Brath</p><p class="is-size-6 is-block">技能改变人生，知识改变命运。</p><p class="is-size-6 is-flex justify-content-center"><i class="fas fa-map-marker-alt mr-1"></i><span>中国·江苏·无锡</span></p></div></div></nav><nav class="level is-mobile"><div class="level-item has-text-centered is-marginless"><div><p class="heading">文章</p><a href="/archives"><p class="title">143</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">分类</p><a href="/categories"><p class="title">0</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">标签</p><a href="/tags"><p class="title">0</p></a></div></div></nav><div class="level"><a class="level-item button is-primary is-rounded" href="https://github.com/Guoqing815" target="_blank" rel="noopener">关注我</a></div><div class="level is-mobile is-multiline"><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Github" href="https://github.com/Guoqing815"><i class="fab fa-github"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Gitee" href="https://gitee.com/Guoqing-Li"><i class="fab fa-gitee"></i></a></div></div></div><!--!--><div class="card widget" data-type="links"><div class="card-content"><div class="menu"><h3 class="menu-label">链接</h3><ul class="menu-list"><li><a class="level is-mobile" href="https://schokolade.cn/" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">泠灵(特别呜谢)</span></span><span class="level-right"><span class="level-item tag">schokolade.cn</span></span></a></li><li><a class="level is-mobile" href="https://gitee.com/Guoqing-Li" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">Gitee(码云)</span></span><span class="level-right"><span class="level-item tag">gitee.com</span></span></a></li><li><a class="level is-mobile" href="https://blog.csdn.net/Brath?type=blog" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">CSDN</span></span><span class="level-right"><span class="level-item tag">blog.csdn.net</span></span></a></li><li><a class="level is-mobile" href="https://juejin.cn/user/settings/profile" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">掘金</span></span><span class="level-right"><span class="level-item tag">juejin.cn</span></span></a></li><li><a class="level is-mobile" href="https://oss.console.aliyun.com/" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">AliCloud(阿里云)</span></span><span class="level-right"><span class="level-item tag">oss.console.aliyun.com</span></span></a></li><li><a class="level is-mobile" href="https://cloud.tencent.com/" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">TencentCloud(腾讯云)</span></span><span class="level-right"><span class="level-item tag">cloud.tencent.com</span></span></a></li><li><a class="level is-mobile" href="https://www.zhipin.com/web/user/" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">BOSS</span></span><span class="level-right"><span class="level-item tag">www.zhipin.com</span></span></a></li><li><a class="level is-mobile" href="https://www.bilibili.com/" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">Bilibili(B站)</span></span><span class="level-right"><span class="level-item tag">www.bilibili.com</span></span></a></li></ul></div></div></div></div></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/"><img src="https://brath.cloud/avatar.png" alt="Brath-Blog" height="28"></a><p class="is-size-7"><span>&copy; 2023 Brath</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a><br><span id="busuanzi_container_site_uv">共<span id="busuanzi_value_site_uv">0</span>个访客</span></p><p class="is-size-7">© 2029</p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Attribution 4.0 International" href="https://creativecommons.org/licenses/by/4.0/"><i class="fab fa-creative-commons-by"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/ppoffice/hexo-theme-icarus"><i class="fab fa-github"></i></a></p></div></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script><script>moment.locale("zh-cn");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="/js/column.js"></script><script src="/js/animation.js"></script><a id="back-to-top" title="回到顶端" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><!--!--><!--!--><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.js" defer></script><script>window.addEventListener("load", () => {
      window.cookieconsent.initialise({
        type: "info",
        theme: "edgeless",
        static: false,
        position: "bottom-left",
        content: {
          message: "此网站使用Cookie来改善您的体验。",
          dismiss: "知道了！",
          allow: "允许使用Cookie",
          deny: "拒绝",
          link: "了解更多",
          policy: "Cookie政策",
          href: "https://www.cookiesandyou.com/",
        },
        palette: {
          popup: {
            background: "#edeff5",
            text: "#838391"
          },
          button: {
            background: "#4b81e8"
          },
        },
      });
    });</script><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><!--!--><!--!--><!--!--><script src="/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="想要查找什么..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"想要查找什么...","untitled":"(无标题)","posts":"文章","pages":"页面","categories":"分类","tags":"标签"});
        });</script></body></html>