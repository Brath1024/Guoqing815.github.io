<!doctype html>
<html lang="zh"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta><title>Brath-Blog</title><link rel="manifest" href="/manifest.json"><meta name="application-name" content="Brath-Blog"><meta name="msapplication-TileImage" content="https://brath.cloud/me.png"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="Brath-Blog"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta property="og:type" content="blog"><meta property="og:title" content="Brath-Blog"><meta property="og:url" content="http://example.com/"><meta property="og:site_name" content="Brath-Blog"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="http://example.com/img/og_image.png"><meta property="article:author" content="Brath"><meta property="twitter:card" content="summary"><meta property="twitter:image:src" content="http://example.com/img/og_image.png"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"http://example.com"},"headline":"Brath-Blog","image":["http://example.com/img/og_image.png"],"author":{"@type":"Person","name":"Brath"},"publisher":{"@type":"Organization","name":"Brath-Blog","logo":{"@type":"ImageObject","url":"https://brath.cloud/me.png"}},"description":""}</script><link rel="icon" href="https://brath.cloud/me.png"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v6.0.0/css/all.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/atom-one-light.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><!--!--><!--!--><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/css/justifiedGallery.min.css"><!--!--><!--!--><style>.pace{-webkit-pointer-events:none;pointer-events:none;-webkit-user-select:none;-moz-user-select:none;user-select:none}.pace-inactive{display:none}.pace .pace-progress{background:#3273dc;position:fixed;z-index:2000;top:0;right:100%;width:100%;height:2px}</style><script src="https://cdn.jsdelivr.net/npm/pace-js@1.2.4/pace.min.js"></script><!--!--><!--!--><!-- hexo injector head_end start --><script>
  (function () {
      function switchTab() {
          if (!location.hash) {
            return;
          }

          const id = '#' + CSS.escape(location.hash.substring(1));
          const $tabMenu = document.querySelector(`.tabs a[href="${id}"]`);
          if (!$tabMenu) {
            return;
          }

          const $tabMenuContainer = $tabMenu.parentElement.parentElement;
          Array.from($tabMenuContainer.children).forEach($menu => $menu.classList.remove('is-active'));
          Array.from($tabMenuContainer.querySelectorAll('a'))
              .map($menu => document.getElementById($menu.getAttribute("href").substring(1)))
              .forEach($content => $content.classList.add('is-hidden'));

          if ($tabMenu) {
              $tabMenu.parentElement.classList.add('is-active');
          }
          const $activeTab = document.querySelector(id);
          if ($activeTab) {
              $activeTab.classList.remove('is-hidden');
          }
      }
      switchTab();
      window.addEventListener('hashchange', switchTab, false);
  })();
  </script><!-- hexo injector head_end end --><meta name="generator" content="Hexo 6.3.0"></head><body class="is-3-column"><nav class="navbar navbar-main"><div class="container navbar-container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="https://brath.cloud/me.png" alt="Brath-Blog" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">主页</a><a class="navbar-item" href="/archives">文章列表</a><a class="navbar-item" href="/tags">标签</a><a class="navbar-item" href="/about">更多</a></div><div class="navbar-end"><a class="navbar-item" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/Guoqing815"><i class="fab fa-github"></i></a><a class="navbar-item search" title="搜索" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-6-widescreen"><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2022-12-27T08:18:48.559Z" title="2022-12-27 16:18:48">2022-12-27</time>发表</span><span class="level-item"><time dateTime="2022-05-23T04:53:15.592Z" title="2022-5-23 12:53:15">2022-05-23</time>更新</span><span class="level-item">18 分钟读完 (大约2628个字)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2022/12/27/%E3%80%90Flutter%E3%80%91Flutter_GetX%E6%96%87%E6%A1%A3/">Flutter GETX框架</a></p><div class="content"><p>​		GetX 是 Flutter 上的一个轻量且强大的解决方案：高性能的状态管理、智能的依赖注入和便捷的路由管理。</p>
<p>​		与其说是一个状态管理库，倒不如是是一个简化 Flutter 开发的百宝箱。它提供了很多工具来简化我们的开发，本篇我们先对 GetX 有一个大概的认识，然后接下来的篇章再将 GetX 的具体应用。</p>
<h2 id="getx-工具介绍"><a class="markdownIt-Anchor" href="#getx-工具介绍">#</a> <strong>GetX 工具介绍</strong></h2>
<p>官方文档给出关于 GetX 的介绍如下：</p>
<blockquote>
<p>GetX is an extra-light and powerful solution for Flutter. It combines high-performance state management, intelligent dependency injection, and route management quickly and practically. GetX 是一个超轻量且强大的 Flutter 应用解决方案。它组合了高性能的状态管理、智能的依赖注入以及快速可用的路由管理。</p>
</blockquote>
<p>而实际上，GetX 还有更多的小工具，示例如下：</p>
<h4 id="状态管理"><a class="markdownIt-Anchor" href="#状态管理">#</a> 状态管理</h4>
<ul>
<li>Obx 是配合 Rx 响应式变量使用、GetBuilder 是配合 update 使用：请注意，这完全是俩套定点刷新控件的方案。<br>
区别：前者响应式变量变化，Obx 自动刷新；后者需要使用 update 手动调用刷新</li>
<li>每一个响应式变量，都需要生成对应的 GetStream，占用资源大于基本数据类型，会对内存造成一定压力</li>
<li>GetBuilder 内部实际上是对 StatefulWidget 的封装，所以占用资源极小（推荐使用）</li>
</ul>
<h4 id="控制器的注入"><a class="markdownIt-Anchor" href="#控制器的注入">#</a> 控制器的注入</h4>
<ul>
<li>静态路由绑定</li>
</ul>
<figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">AsWorkStatisticsBinding</span> <span class="keyword">implements</span> <span class="title class_">Bindings</span> &#123;</span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  <span class="built_in">void</span> <span class="title function_">dependencies</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="title class_">Get</span>.<span class="property">lazyPut</span>&lt;<span class="title class_">AsWorkStatisticsController</span>&gt;(<span class="function">() =&gt;</span> <span class="title class_">AsWorkStatisticsController</span>());</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> final <span class="title class_">List</span>&lt;<span class="title class_">GetPage</span>&gt; routes = [</span><br><span class="line">    <span class="title class_">GetPage</span>(</span><br><span class="line">      <span class="attr">name</span>: workStatisticsPage,</span><br><span class="line">      <span class="attr">page</span>: <span class="function">() =&gt;</span> <span class="keyword">const</span> <span class="title class_">AsWorkStatisticsPage</span>(),</span><br><span class="line">      <span class="attr">binding</span>: <span class="title class_">AsWorkStatisticsBinding</span>(),</span><br><span class="line">    ),</span><br><span class="line">];</span><br><span class="line"><span class="title class_">Get</span>.<span class="title function_">toNamed</span>(<span class="title class_">ASRouteConfig</span>.<span class="property">workPlanDetailPage</span>);</span><br></pre></td></tr></table></figure>
<ul>
<li>动态路由绑定</li>
</ul>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Get<span class="selector-class">.to</span>(AsWorkStatisticsPage(),binding: <span class="built_in">AsWorkStatisticsBinding</span>());</span><br></pre></td></tr></table></figure>
<ul>
<li>页面注入</li>
</ul>
<figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Get</span>.<span class="property">lazyPut</span>&lt;<span class="title class_">AsWorkStatisticsController</span>&gt;(<span class="function">() =&gt;</span> <span class="title class_">AsWorkStatisticsController</span>());</span><br></pre></td></tr></table></figure>
<h4 id="动态简单路由和静态命名路由"><a class="markdownIt-Anchor" href="#动态简单路由和静态命名路由">#</a> 动态 / 简单路由和静态 / 命名路由</h4>
<p>请注意命名路由，只需要在 api 结尾加上 Named 即可，举例：</p>
<ul>
<li>默认：<a target="_blank" rel="noopener" href="http://Get.to">Get.to</a>(SomePage());</li>
<li>命名路由：Get.toNamed (“/somePage”);</li>
<li>导航到新的页面</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Get.to(NextScreen());</span><br><span class="line">Get.toNamed(<span class="string">&quot;/NextScreen&quot;</span>);</span><br></pre></td></tr></table></figure>
<ul>
<li>关闭 SnackBars、Dialogs、BottomSheets 或任何你通常会用 Navigator.pop (context) 关闭的东西</li>
</ul>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Get<span class="selector-class">.back</span>();</span><br></pre></td></tr></table></figure>
<ul>
<li>进入下一个页面，但没有返回上一个页面的选项（用于 SplashScreens，登录页面等）</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Get.off(NextScreen());</span><br><span class="line">Get.offNamed(<span class="string">&quot;/NextScreen&quot;</span>);</span><br></pre></td></tr></table></figure>
<ul>
<li>进入下一个界面并取消之前的所有路由（在购物车、投票和测试中很有用）</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Get.offAll(NextScreen());</span><br><span class="line">Get.offAllNamed(<span class="string">&quot;/NextScreen&quot;</span>);</span><br></pre></td></tr></table></figure>
<ul>
<li>发送数据到其它页面</li>
</ul>
<p>只要发送你想要的参数即可。Get 在这里接受任何东西，无论是一个字符串，一个 Map，一个 List，甚至一个类的实例。</p>
<figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Get</span>.<span class="title function_">to</span>(<span class="title class_">NextScreen</span>(), <span class="attr">arguments</span>: <span class="string">&#x27;Get is the best&#x27;</span>);</span><br><span class="line"><span class="title class_">Get</span>.<span class="title function_">toNamed</span>(<span class="string">&quot;/NextScreen&quot;</span>, <span class="attr">arguments</span>: <span class="string">&#x27;Get is the best&#x27;</span>);</span><br></pre></td></tr></table></figure>
<p>在你的类或控制器上。</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">print</span>(Get.arguments);</span><br><span class="line"><span class="comment">//print out: Get is the best</span></span><br></pre></td></tr></table></figure>
<ul>
<li>要导航到下一条路由，并在返回后立即接收或更新数据</li>
</ul>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> data = <span class="keyword">await</span> Get.to(Payment());</span><br><span class="line"><span class="keyword">var</span> data = <span class="keyword">await</span> Get.toNamed(<span class="string">&quot;/payment&quot;</span>);</span><br></pre></td></tr></table></figure>
<ul>
<li>在另一个页面上，发送前一个路由的数据</li>
</ul>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Get.back(result: <span class="string">&#x27;success&#x27;</span>);</span><br><span class="line"><span class="comment">// 并使用它，例：</span></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">data</span> == <span class="string">&#x27;success&#x27;</span>) madeAnything();</span><br></pre></td></tr></table></figure>
<ul>
<li>跳转重复页面，可以这样写</li>
</ul>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Get.to(XxxxPage(), preventDuplicates: <span class="literal">false</span>);</span><br><span class="line"><span class="comment">// 或者</span></span><br><span class="line">Get.toNamed(<span class="string">&#x27;xxx&#x27;</span>,  preventDuplicates: <span class="literal">false</span>);</span><br></pre></td></tr></table></figure>
<ul>
<li>如果你不想使用 GetX 语法，只要把 Navigator（大写）改成 navigator（小写），你就可以拥有标准导航的所有功能，而不需要使用 context，例如：</li>
</ul>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 默认的Flutter导航</span></span><br><span class="line">Navigator.of(context).push(</span><br><span class="line">  context,</span><br><span class="line">  MaterialPageRoute(</span><br><span class="line">    builder: (BuildContext context) &#123;</span><br><span class="line">      <span class="keyword">return</span> HomePage();</span><br><span class="line">    &#125;,</span><br><span class="line">  ),</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用Flutter语法获得，而不需要context。</span></span><br><span class="line">navigator.push(</span><br><span class="line">  MaterialPageRoute(</span><br><span class="line">    builder: (_) &#123;</span><br><span class="line">      <span class="keyword">return</span> HomePage();</span><br><span class="line">    &#125;,</span><br><span class="line">  ),</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">// get语法</span></span><br><span class="line">Get.to(HomePage());</span><br></pre></td></tr></table></figure>
<h4 id="getview的使用"><a class="markdownIt-Anchor" href="#getview的使用">#</a> GetView 的使用</h4>
<p>GetView 只是对已注册的 Controller 有一个名为 controller 的 getter 的 const Stateless 的 Widget，如果我们只有单个控制器作为依赖项，那我们就可以使用 GetView，而不是使用 StatelessWidget，并且避免了写 Get.Find ()。</p>
<p>GetView 的使用方法非常简单，只是要将你的视图层继承自 GetView 并传入需要注册的控制器并 Get.put () 即可：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">GetViewAndGetWidgetExample</span> <span class="keyword">extends</span> <span class="title class_">GetView</span>&lt;GetViewCountController&gt; &#123;</span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  Widget <span class="title function_">build</span><span class="params">(BuildContext context)</span> &#123;</span><br><span class="line"></span><br><span class="line">    Get.put(GetViewCountController());</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> Container();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="路由"><a class="markdownIt-Anchor" href="#路由">#</a> <strong>路由</strong></h3>
<p>路由支持命名路由和匿名路由：</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">Get.to(() =&gt; Home());</span><br><span class="line">Get.toNamed(&#x27;/home&#x27;);</span><br><span class="line">// 返回上一个页面</span><br><span class="line">Get.back();</span><br><span class="line">// 使用下一个页面替换</span><br><span class="line">Get.off(NextScreen());</span><br><span class="line">// 清空导航堆栈全部页面</span><br><span class="line">Get.offAll(NextScreen());</span><br><span class="line">// 获取命名路由参数</span><br><span class="line">print(Get.parameters[&#x27;id&#x27;]);</span><br><span class="line">print(Get.parameters[&#x27;name&#x27;]);</span><br></pre></td></tr></table></figure>
<p>GetX 的路由好处是不依赖于  <code>context</code> ，十分简洁，更多路由介绍可以参考：<strong><a href="https://link.zhihu.com/?target=https%3A//github.com/jonataslaw/getx/blob/master/documentation/en_US/route_management.md">GetX 路由介绍官方文档</a></strong>。</p>
<h2 id="snackbar"><a class="markdownIt-Anchor" href="#snackbar">#</a> <strong>SnackBar</strong></h2>
<p>Flutter 自身携带的 SnackBar 有很多限制，而 GetX 的非常简单，当然也有更多的样式配置和位置配置参数。</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Get.snackbar(&#x27;SnackBar&#x27;, &#x27;这是GetX的SnackBar&#x27;);</span><br></pre></td></tr></table></figure>
<h2 id="对话框"><a class="markdownIt-Anchor" href="#对话框">#</a> <strong>对话框</strong></h2>
<p>对话框也一样，默认的对话框开箱即用。</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">Get.defaultDialog(</span><br><span class="line">  title: &#x27;对话框&#x27;,</span><br><span class="line">  content: Text(&#x27;对话框内容&#x27;),</span><br><span class="line">  onConfirm: () &#123;</span><br><span class="line">    print(&#x27;Confirm&#x27;);</span><br><span class="line">    Get.back();</span><br><span class="line">  &#125;,</span><br><span class="line">  onCancel: () &#123;</span><br><span class="line">    print(&#x27;Cancel&#x27;);</span><br><span class="line">  &#125;,</span><br><span class="line">);</span><br></pre></td></tr></table></figure>
<h2 id="内存缓存"><a class="markdownIt-Anchor" href="#内存缓存">#</a> <strong>内存缓存</strong></h2>
<p>GetX 可以缓存内容对象，以便在不同页面共享数据。使用的时候需要注意，需要先  <code>put</code>  操作再  <code>find</code>  操作，否则会抛异常。</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Get.put(CacheData(name: &#x27;这是缓存数据&#x27;));</span><br><span class="line">CacheData cache = Get.find();</span><br></pre></td></tr></table></figure>
<h2 id="离线存储"><a class="markdownIt-Anchor" href="#离线存储">#</a> <strong>离线存储</strong></h2>
<p>GetX 提供了一个 <strong><a href="https://link.zhihu.com/?target=https%3A//pub.flutter-io.cn/packages/get_storage">get_storage</a></strong> 插件用于离线存储，与  <code>shared_preferences</code>  相比，其优点是纯 Dart 编写，不依赖于原生，因此可以在安卓、iOS、Web、Linux、Mac 等多个平台使用。 <code>GetStorage</code>  是基于内存和文件存储的，当内存容器中有数据时优先从内存读取。同时在构建 GetStorage 对象到时候指定存储的文件名以及存储数据的容器。</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">GetStorage storage = GetStorage();</span><br><span class="line">storage.write(&#x27;name&#x27;, &#x27;岛上码农&#x27;);</span><br><span class="line">storage.read(&#x27;name&#x27;);</span><br></pre></td></tr></table></figure>
<h2 id="更改主题"><a class="markdownIt-Anchor" href="#更改主题">#</a> <strong>更改主题</strong></h2>
<p>可以说是一行代码搞定深色和浅色模式，也可以更改为自定义主题 —— <strong>老板让你根据手机壳改主体颜色的需求</strong>已经搞定了一大半了！</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Get.changeTheme(</span><br><span class="line">  Get.isDarkMode ? ThemeData.light() : ThemeData.dark());</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>
<p><img src="https://brath.cloud/blogImg/v2-196c01dbae06a8e68132fcd94e3983a6_b.jpg" alt="img"></p>
<h2 id="多语言支持"><a class="markdownIt-Anchor" href="#多语言支持">#</a> <strong>多语言支持</strong></h2>
<p>多语言支持使用数据字典完成，在  <code>GetMaterialApp</code>  指定字典对象（继承自  <code>Translations</code> ），使用字符串的时候假设 <code>.tr</code>  后缀，就可以在切换语言的时候自动切换字符串对应语言的翻译了。</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">class GetXDemo extends StatelessWidget &#123;</span><br><span class="line">  // 省略其他代码</span><br><span class="line">  TextButton(</span><br><span class="line">    onPressed: () &#123;</span><br><span class="line">      var locale = Locale(&#x27;en&#x27;, &#x27;US&#x27;);</span><br><span class="line">      Get.updateLocale(locale);</span><br><span class="line">    &#125;,</span><br><span class="line">    child: Text(&#x27;name&#x27;.tr),</span><br><span class="line">  ),</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">class Messages extends Translations &#123;</span><br><span class="line">  @override</span><br><span class="line">  Map&lt;String, Map&lt;String, String&gt;&gt; get keys =&gt; &#123;</span><br><span class="line">        &#x27;en_US&#x27;: &#123;</span><br><span class="line">          &#x27;name&#x27;: &#x27;Island Coder&#x27;,</span><br><span class="line">        &#125;,</span><br><span class="line">        &#x27;zh_CN&#x27;: &#123;</span><br><span class="line">          &#x27;name&#x27;: &#x27;岛上码农&#x27;,</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">class MyApp extends StatelessWidget &#123;</span><br><span class="line">  // This widget is the root of your application.</span><br><span class="line">  @override</span><br><span class="line">  Widget build(BuildContext context) &#123;</span><br><span class="line">    return GetMaterialApp(</span><br><span class="line">      translations: Messages(),</span><br><span class="line">      locale: Locale(&#x27;zh&#x27;, &#x27;CN&#x27;),</span><br><span class="line">      color: Colors.white,</span><br><span class="line">      navigatorKey: Get.key,</span><br><span class="line">      title: &#x27;Flutter Demo&#x27;,</span><br><span class="line">      theme: ThemeData(</span><br><span class="line">        primarySwatch: Colors.blue,</span><br><span class="line">        brightness: Brightness.light,</span><br><span class="line">      ),</span><br><span class="line">      home: GetXDemo(),</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="getx-的理念"><a class="markdownIt-Anchor" href="#getx-的理念">#</a> <strong>GetX 的理念</strong></h2>
<p>GetX 有三个基本的理念，分别是性能、生产力和组织性（Organization）。</p>
<ul>
<li>性能（Performance）：GetX 关注性能并最小化资源消耗。GetX 不使用  <code>Stream</code>  或  <code>ChangeNotifier</code> 。</li>
<li>生产力（Productivity）：GetX 使用简洁愉悦的语法。不管你要做什么，使用 GetX 都会觉得简便。这使得开发的时间大大节省，并且保证应用性能的最大化。通常来说，开发者需要关注从内存中移除控制器。而使用 GetX 的时候，则无需这么做。当控制器不被使用的时候，资源会自动从内存中释放。如果确实需要常住内存，那就需要在依赖中声明  <code>permanent:true</code> 。通过这种方式，可以降低内存中有过多不必要依赖对象的风险。同时，依赖默认也是懒加载。</li>
<li>组织性（Organization）：GetX 可以将视图、展示逻辑、业务逻辑、依赖注入和导航完全解耦。路由之间跳转无需  <code>context</code> ，因此我们的导航不会依赖组件树。也不需要使用通过  <code>InheritedWidget</code>  的  <code>context</code>  访问控制器或 BLOC 对象，因此可以将展示逻辑和业务逻辑从虚拟的组件层分离。我们也不需要像 MultiProvider 那样往组件树中注入 Controller/Model/Bloc 等类对象。因此可以将依赖注入和视图分离。</li>
</ul>
<h2 id="getx-生态"><a class="markdownIt-Anchor" href="#getx-生态">#</a> <strong>GetX 生态</strong></h2>
<p>GetX 有很多特性，使得编码变得容易。每个特性之间是相互独立的，并且只会在使用的时候才启动。例如，如果仅仅是使用状态管理，那么只有状态管理会被编译。而如果只使用路由，那么状态管理的部分就不会编译。</p>
<p>GetX 有一个很大的生态，包括了大型的社区维护，大量的协作者（GitHub 上看有 132 位），并且承诺只要 Flutter 存在就会继续维护下去。而且 GetX 兼容 Android, iOS, Web, Mac, Linux, Windows 多个平台。GetX 甚至还有服务端版本 <strong><a href="https://link.zhihu.com/?target=https%3A//github.com/jonataslaw/get_server">Get_Server</a></strong>（感觉 Flutter 要一统程序员界啊，啥时候支持鸿蒙？）。</p>
<p>为了简化开发，GetX 还提供了脚手架工具 **<a href="https://link.zhihu.com/?target=https%3A//pub.flutter-io.cn/packages/get_cli">GET_CLI</a>** 和 VSCode 插件 <code>GetX Snippets</code> （也有 Android Studio 和 Intellij 插件）。提供了如下快速代码模板：</p>
<ul>
<li>
<p>getmain：GetX 的 main.dart 代码；</p>
</li>
<li>
<p>getmodel：Model 类代码，包括了 fromJson 和 toJson 方法</p>
</li>
<li>
<p>其他，输入 getxxxx 根据提示生成即可，具体参考：<strong><a href="https://link.zhihu.com/?target=https%3A//marketplace.visualstudio.com/items%3FitemName%3Dget-snippets.get-snippets">GetX Snippets 介绍</a></strong>。</p>
</li>
</ul>
<h2 id="总结"><a class="markdownIt-Anchor" href="#总结">#</a> <strong>总结</strong></h2>
<p>本篇对 GetX 插件做了简单的介绍，可以看到 GetX 的生态确实很丰富，感觉是一个集大成者，GetX 基本上涵盖了 Flutter 应用开发的很大一部分，如路由、主题、多语言、弹层、状态管理、依赖注入、网络请求封装等等。GetX 看着像一个框架， 但实际上它的各个模块是独立的，其实是一个工具箱。对于开发的时候，可以用它的全家桶，也可以从中任取所需的模块到我们的应用中使用。</p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2022-12-27T08:18:48.558Z" title="2022-12-27 16:18:48">2022-12-27</time>发表</span><span class="level-item"><time dateTime="2022-07-29T03:03:21.670Z" title="2022-7-29 11:03:21">2022-07-29</time>更新</span><span class="level-item">14 分钟读完 (大约2083个字)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2022/12/27/%E3%80%90Flutter%E3%80%91Flutter%20%E6%B5%81%E7%95%85%E5%BA%A6%E4%BC%98%E5%8C%96%E7%BB%84%E4%BB%B6%20Keframe/">Flutter 流畅度优化组件 Keframe</a></p><div class="content"><p>最近在开发一款 APP，核心场景类似于帖子这类的，所以下拉加载页面的流畅度成为最棘手的问题，在掘金上看见了这篇文章： <a target="_blank" rel="noopener" href="https://juejin.cn/post/6979781997568884766">https://juejin.cn/post/6979781997568884766</a></p>
<p>Nayuta 的 Keframe 组件正好可以满足帧率优化的问题</p>
<h3 id="项目依赖"><a class="markdownIt-Anchor" href="#项目依赖">#</a> 项目依赖：</h3>
<p>在  <code>pubspec.yaml</code>  中添加  <code>keframe</code>  依赖</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">dependencies:</span></span><br><span class="line">  <span class="attr">keframe:</span> <span class="string">version</span></span><br></pre></td></tr></table></figure>
<p>组件仅区分非空安全与空安全版本</p>
<p>非空安全使用：  <code>1.0.2</code></p>
<p>空安全版本使用：  <code>2.0.2</code></p>
<p>github 地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FLianjiaTech%2Fkeframe">github.com/LianjiaTech…</a></p>
<p>pub 查看：<a href="https://link.juejin.cn?target=https%3A%2F%2Fpub.dev%2Fpackages%2Fkeframe">pub.dev/packages/ke…</a></p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">#SizeCacheWidget用来包裹最外层的list</span><br><span class="line">#FrameSeparateWidget用来包裹list的子集即可    </span><br><span class="line">example:</span><br><span class="line">SizeCacheWidget(</span><br><span class="line">	child：ListView || CustomScrollView(</span><br><span class="line">    	slivers[</span><br><span class="line">            SliverList(</span><br><span class="line">            	delegate: SliverChildBuilderDelegate</span><br><span class="line">                (BuildContext context, <span class="built_in">int</span> index)&#123;</span><br><span class="line">                    <span class="keyword">return</span> FrameSeparateWidget(</span><br><span class="line">                    	child: ···</span><br><span class="line">                    )</span><br><span class="line">                &#125;</span><br><span class="line">            )</span><br><span class="line">        ]</span><br><span class="line">    )</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<h3 id="快速上手"><a class="markdownIt-Anchor" href="#快速上手">#</a> 快速上手：</h3>
<p>如下图所示</p>
<p><img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/83d16f3b2a3e45b79fc73d7a52774696~tplv-k3u1fbpfcp-zoom-in-crop-mark:3024:0:0:0.awebp" alt="image.png"></p>
<p>假如现在页面由 A、B、C、D 四部分组成，每部分耗时 10ms，在页面时构建为 40ms。使用分帧组件   <code>FrameSeparateWidget</code>  嵌套每一个部分。页面构建时会在第一帧渲染简单的占位，在后续四帧内分别渲染 A、B、C、D。</p>
<p>对于列表，在每一个 item 中嵌套  <code>FrameSeparateWidget</code> ，并将  <code>ListView</code>  嵌套在  <code>SizeCacheWidget</code>  内即可。</p>
<p><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/ffecd49bf9ba4379984a22ef79663104~tplv-k3u1fbpfcp-zoom-in-crop-mark:3024:0:0:0.awebp" alt="image.png"></p>
<hr>
<h2 id="构造函数说明"><a class="markdownIt-Anchor" href="#构造函数说明">#</a> 构造函数说明</h2>
<p>FrameSeparateWidget ：分帧组件，将嵌套的 widget 单独一帧渲染</p>
<table>
<thead>
<tr>
<th>类型</th>
<th>参数名</th>
<th>是否必填</th>
<th>含义</th>
</tr>
</thead>
<tbody>
<tr>
<td>Key</td>
<td>key</td>
<td>否</td>
<td></td>
</tr>
<tr>
<td>int</td>
<td>index</td>
<td>否</td>
<td>分帧组件 id，<strong>使用 SizeCacheWidget 的场景必传</strong>，SizeCacheWidget 中维护了 index 对应的 Size 信息</td>
</tr>
<tr>
<td>Widget</td>
<td>child</td>
<td>是</td>
<td>实际需要渲染的 widget</td>
</tr>
<tr>
<td>Widget</td>
<td>placeHolder</td>
<td>否</td>
<td>占位 widget，尽量设置简单的占位，不传默认是 Container ()</td>
</tr>
</tbody>
</table>
<p>SizeCacheWidget：缓存子节点中，分帧组件嵌套的<strong>实际 widget 的尺寸信息</strong></p>
<table>
<thead>
<tr>
<th>类型</th>
<th>参数名</th>
<th>是否必填</th>
<th>含义</th>
</tr>
</thead>
<tbody>
<tr>
<td>Key</td>
<td>key</td>
<td>否</td>
<td></td>
</tr>
<tr>
<td>Widget</td>
<td>child</td>
<td>是</td>
<td>子节点中如果包含分帧组件，则缓存<strong>实际的 widget 尺寸</strong></td>
</tr>
<tr>
<td>int</td>
<td>estimateCount</td>
<td>否</td>
<td>预估屏幕上子节点的数量，提高快速滚动时的响应速度</td>
</tr>
</tbody>
</table>
<hr>
<h2 id="方案设计与分析"><a class="markdownIt-Anchor" href="#方案设计与分析">#</a> 方案设计与分析：</h2>
<p>卡顿的本质，就是 <strong>单帧的绘制时间过长</strong>。基于此自然衍生出两种思路解决：</p>
<p>1、减少一帧的绘制耗时，因为导致耗时过长的原因有很多，比如不合理的刷新，或者绘制时间过长，都有可能，需要具体问题具体分析，后面我会分享一些我的优化经验。</p>
<p><strong>2、在不对耗时优化下，将一帧的任务拆分到多帧内，保证每一帧都不超时。这也是本组件的设计思路，分帧渲染。</strong></p>
<p>如下图所示:</p>
<p><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/eb09c9aadc5d45c9b966661c8d73e4c1~tplv-k3u1fbpfcp-zoom-in-crop-mark:3024:0:0:0.awebp" alt="image.png"></p>
<p>原理并不复杂，问题在于如何在 Flutter 中实践这一机制。</p>
<p>因为涉及到帧与系统的调度，自然联想到看  <code>SchedulerBinding</code>  中有无现成的 API。</p>
<p>发现了  <code>scheduleTask</code>  方法，这是系统提供的一个执行任务的方法，但这个方法存在两个问题：</p>
<ul>
<li>1、其中的渲染任务是优先级进行堆排序，而堆排序是<strong>不稳定</strong>排序，这会导致任务的执行顺序并非 FIFO。从效果上来看，就是列表不会按照顺序渲染，而是会出现跳动渲染的情况</li>
<li>2、这个方法本身存在调度问题，我已经提交 issue 与 pr，不过一直卡在单元测试上，如果感兴趣可以以在这里交流谈论。</li>
</ul>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fflutter%2Fflutter%2Fpull%2F82781">fix: Tasks scheduled through ‘SchedulerBinding.instance.scheduleTask’… #82781 </a></p>
<p>最终，参考这个设计结合  <code>endOfFrame</code>  方法的使用，完成了分帧队列。整个渲染流程变为下图所示：</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/cb9d177b4b0847339eaf952a7ef67cca~tplv-k3u1fbpfcp-zoom-in-crop-mark:3024:0:0:0.awebp" alt="image.png"></p>
<p>对于列表构建场景来说，假设屏幕上能显示五个 item。首先在第一帧的时候，列表会渲染 5 个占位的 Widget，同时添加 5 个高优先级任务到队列中，这里的任务可以是简单的将占位 Widget 和实际 item 进行替换，也可通过渐变等动画提升体验。在后续的五帧中占位 Widget 依次被替换成实际的列表 item。</p>
<p>在  <a target="_blank" rel="noopener" href="https://juejin.cn/post/6940134891606507534">ListView 流畅度翻倍！！Flutter 卡顿分析和通用优化方案</a>  这篇文章中有更加详细的分析。</p>
<h2 id="一些展示效果example-说明请查看-github"><a class="markdownIt-Anchor" href="#一些展示效果example-说明请查看-github">#</a> 一些展示效果（Example 说明请查看 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FLianjiaTech%2Fkeframe%2Fblob%2Fmaster%2FREADME-ZH.md">Github</a>）</h2>
<p>卡顿的页面往往都是由多个复杂 widget 同时渲染导致。通过为复杂的 widget 嵌套分帧组件  <code>FrameSeparateWidget</code> 。渲染时，分帧组件会在第一帧同时渲染多个  <code>palceHolder</code> ，之后连续的多帧内依次渲染复杂子项，以此提升页面流畅度。</p>
<p>例如 example 中的优化前示例：</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">ListView.builder(</span><br><span class="line">              itemCount: childCount,</span><br><span class="line">              itemBuilder: (c, i) =&gt; CellWidget(</span><br><span class="line">                color: i % <span class="number">2</span> == <span class="number">0</span> ? Colors.red : Colors.blue,</span><br><span class="line">                index: i,</span><br><span class="line">              ),</span><br><span class="line">            )</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>
<p>其中  <code>CellWidget</code>  高度为 60，内部嵌套了三个  <code>TextField</code>  的组件（整体构建耗时在 9ms 左右）。</p>
<p>优化仅需为每一个 item 嵌套分帧组件，并为其设置  <code>placeHolder</code> （placeHolder 尽量简单，样式与实际 item 接近即可）。</p>
<p>在列表情况下，给 ListView 嵌套  <code>SizeCacheWidget</code> ，同时建议将预加载范围  <code>cacheExtent</code>  设置大一点，例如 500（该属性默认为 250），提升慢速滑动时候的体验。</p>
<p><img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/4f33ddd7d9de4e369b0e457f84171cc8~tplv-k3u1fbpfcp-zoom-in-crop-mark:3024:0:0:0.awebp" alt="Screenrecording_20210611_194905.gif"> (占位与实际列表项不一致时，首次渲染抖动，二次渲染正常)</p>
<p>此外，也可以给 item 嵌套透明度 / 位移等动画，优化视觉上的效果。</p>
<p>效果如下图：</p>
<table>
<thead>
<tr>
<th><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/bb7d1361ae7842df954bb1c559e2ec54~tplv-k3u1fbpfcp-zoom-in-crop-mark:3024:0:0:0.awebp" alt="Screenrecording_20210315_133310.gif"></th>
<th><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/6ee6827f7eed4463a1a8a5b00a58fd6e~tplv-k3u1fbpfcp-zoom-in-crop-mark:3024:0:0:0.awebp" alt="Screenrecording_20210315_133848.gif"></th>
</tr>
</thead>
<tbody>
<tr>
<td></td>
<td></td>
</tr>
</tbody>
</table>
<hr>
<h2 id="分帧的成本"><a class="markdownIt-Anchor" href="#分帧的成本">#</a> 分帧的成本</h2>
<p>当然分帧方案也非十全十美，在我看来主要有两点成本：</p>
<p>1、额外的构建开销：整个构建过程的构建消耗由「n * widget 消耗 」变成了「n *（ widget + 占位）消耗 + 系统调度 n 帧消耗」。可以看出，额外的开销主要由占位的复杂度决定。如果占位只是简单的 Container，测试后发现整体构建耗时大概提升在 15 % 左右。这种额外开销对于当下的移动设备而言，成本几乎可以不计。</p>
<p>2、视觉上的变化：如同上面的演示，组件会将 item 分帧渲染，页面在视觉上出现占位变成实际 widget 的过程。但其实由于列表存在缓存区域（建议将缓存区调大），在高端机或正常滑动情况下用户并无感知。而在中低端设备上快速滑动能感觉到切换的过程，但比严重顿挫要好。</p>
<hr>
<h2 id="优化前后对比演示"><a class="markdownIt-Anchor" href="#优化前后对比演示">#</a> 优化前后对比演示</h2>
<p>注：gif 帧率只有 20</p>
<table>
<thead>
<tr>
<th>优化前</th>
<th>优化后</th>
</tr>
</thead>
<tbody>
<tr>
<td><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/2f20f593cc144b72a1df4bdae57a165c~tplv-k3u1fbpfcp-zoom-in-crop-mark:3024:0:0:0.awebp" alt="优化前"></td>
<td><img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/05aea6de421545b9bbf868c344a9afe9~tplv-k3u1fbpfcp-zoom-in-crop-mark:3024:0:0:0.awebp" alt="优化后"></td>
</tr>
</tbody>
</table>
<hr>
<h2 id="最后一点点思考"><a class="markdownIt-Anchor" href="#最后一点点思考">#</a> 最后：一点点思考</h2>
<p>列表优化篇到此告一段落，在整个开源实践过程中，有两点感触较深：</p>
<p>作者：Nayuta<br>
 链接：<a target="_blank" rel="noopener" href="https://juejin.cn/post/6979781997568884766">https://juejin.cn/post/6979781997568884766</a></p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2022-12-27T08:18:48.556Z" title="2022-12-27 16:18:48">2022-12-27</time>发表</span><span class="level-item"><time dateTime="2023-02-03T05:17:58.908Z" title="2023-2-3 13:17:58">2023-02-03</time>更新</span><span class="level-item">10 分钟读完 (大约1510个字)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2022/12/27/%E3%80%90Elasticsearch%E3%80%91Elasticsearch7%E9%85%8D%E7%BD%AE%E8%AF%81%E4%B9%A6/">ELASTICSEARCH7.X安全性之访问密码设置</a></p><div class="content"><h2 id="elasticsearch7x安全性之访问密码设置"><a class="markdownIt-Anchor" href="#elasticsearch7x安全性之访问密码设置">#</a> ELASTICSEARCH7.X 安全性之访问密码设置</h2>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">当我们安装完ElasticSearch的时候发现，访问过程中我们没有任何安全认证就可以直接访问并操作。如果是生产环境，端口向外暴露的话，那么对数据的安全性是无法得到保障的。</span><br></pre></td></tr></table></figure>
<p>一般解决方案有</p>
<ul>
<li>开启 ElasticSearch 认证插件，访问的时候添加账密</li>
<li>当然也可以通过 nginx 作代理防护</li>
</ul>
<p>本文主要讲解通过启用 X-Pack 来设置 ElasticSearch 的访问密码。</p>
<p>集群与单据环境都适合次方法</p>
<ul>
<li>集群与单据环境配置的区别就是，集群需要在某一台生成证书然后拷贝到其它节点目录下。</li>
<li>集群环境重设置密码的时候需要整个集群节点都已启动，可在任一台处修改。</li>
</ul>
<h2 id="2x-pack简介"><a class="markdownIt-Anchor" href="#2x-pack简介">#</a> 2.X-PACK 简介</h2>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">X-Pack是Elastic Stack扩展功能，提供安全性，警报，监视，报告，机器学习和许多其他功能。 ES7.0+之后，默认情况下，当安装Elasticsearch时，会自动安装X-Pack，无需单独再安装。自6.8以及7.1+版本之后，基础级安全永久免费了。</span><br><span class="line">在使用的时候主要需要配置一下证书，以及修改配置文件（config/elasticsearch.yml ）</span><br></pre></td></tr></table></figure>
<h2 id="3证书配置"><a class="markdownIt-Anchor" href="#3证书配置">#</a> 3. 证书配置</h2>
<h3 id="31生成节点证书"><a class="markdownIt-Anchor" href="#31生成节点证书">#</a> 3.1 生成节点证书</h3>
<p>切换到 elasticsearch 安装文件目录 bin 下 ：示例：/usr/local/elasticsearch-7.4.0/bin<br>
 借助 elasticsearch-certutil 命令生成证书：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./elasticsearch-certutil ca -out config/certs/elastic-certificates.p12 -pass</span><br></pre></td></tr></table></figure>
<p>这里单独设置了一个 证书文件目录 config/certs<br>
<img src="https://www.freesion.com/images/951/a3d0c1934c0ed0f8440f830d63e96dbf.png" alt="在这里插入图片描述"></p>
<p>生成后的证书<br>
<img src="https://www.freesion.com/images/953/de92ac2cf73d1ed0da994f9d1066e8f1.png" alt="在这里插入图片描述"></p>
<h3 id="32修改配置"><a class="markdownIt-Anchor" href="#32修改配置">#</a> 3.2 修改配置</h3>
<p>配置通信证书 &gt; 需要在 config 目前下 elasticsearch.yml 配置</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"># 开启xpack</span><br><span class="line">xpack.security.enabled: true</span><br><span class="line">xpack.license.self_generated.type: basic</span><br><span class="line">xpack.security.transport.ssl.enabled: true</span><br><span class="line"># 证书配置</span><br><span class="line">xpack.security.transport.ssl.verification_mode: certificate</span><br><span class="line">xpack.security.transport.ssl.keystore.path: certs/elastic-certificates.p12</span><br><span class="line">xpack.security.transport.ssl.truststore.path: certs/elastic-certificates.p12</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>其它配置（可选）</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">#跨域配置</span><br><span class="line">http.cors.enabled: true</span><br><span class="line">http.cors.allow-origin: &quot;*&quot;</span><br><span class="line">http.cors.allow-headers: Authorization,X-Requested-With,Content-Length,Content-Type</span><br></pre></td></tr></table></figure>
<p>注：若是集群环境则需要将证书文件目录，以及配置文件，在所有集群环境下都修改一下。</p>
<h3 id="33重启生效"><a class="markdownIt-Anchor" href="#33重启生效">#</a> 3.3. 重启生效</h3>
<p>需要重启 elasticsearch</p>
<p>注：若是集群环境下则需要启动所有集群节点，再统一设置密码</p>
<p>注：重启异常情况，若出现报错，类似 failed to load plugin class [org.elasticsearch.xpack.core.XPackPlugin]<br>
 请检查是否是使用 root 用户生成的证书，启动用户无权限导致。</p>
<h2 id="4设置用户密码"><a class="markdownIt-Anchor" href="#4设置用户密码">#</a> 4. 设置用户密码</h2>
<p>执行设置用户名和密码的命令，内置了部分用户<br>
切换到 elasticsearch 安装文件目录 bin 下 ：示例：/usr/local/elasticsearch-7.4.0/bin/</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 手动配置每个用户密码模式（需要一个一个的输入）</span><br><span class="line">./elasticsearch-setup-passwords interactive</span><br></pre></td></tr></table></figure>
<p>也可以先自动配置密码后续再修改</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#自动配置每个用户密码（随机生成并返回字符串密码,需要保存好）</span><br><span class="line">./elasticsearch-setup-passwords auto  </span><br></pre></td></tr></table></figure>
<p>下图 1 是自动生成密码情况（一定拷贝下来要牢记密码）<br>
<img src="https://www.freesion.com/images/198/f383d0d38bab2a11f3293d44ffccf0ae.png" alt="在这里插入图片描述"></p>
<p>下图 2 是自定义密码情况<br>
分别为多个用户设置密码例如：elastic, kibana, logstash_system,beats_system,<br>
 设置密码的时候需要连续输入 2 遍。<br>
<img src="https://www.freesion.com/images/458/363890f3fdffcc0b1bcfaae3c8295952.png" alt="在这里插入图片描述"></p>
<p>部分内置账号的角色权限解释如下：</p>
<ul>
<li>elastic 账号：拥有 superuser 角色，是内置的超级用户。</li>
<li>kibana 账号：拥有 kibana_system 角色，用户 kibana 用来连接 elasticsearch 并与之通信。Kibana 服务器以该用户身份提交请求以访问集群监视 API 和 .kibana 索引。不能访问 index。</li>
<li>logstash_system 账号：拥有 logstash_system 角色。用户 Logstash 在 Elasticsearch 中存储监控信息时使用。</li>
</ul>
<p>至此单节点安全配置完毕，重启 es 后访问 9200 会出现用户名和密码的提示窗口，我们就可以通过用户生成的密码过行访问了</p>
<h2 id="5测试访问"><a class="markdownIt-Anchor" href="#5测试访问">#</a> 5. 测试访问</h2>
<p>通过查看证书方式，顺便测试一下密码是否生效了<br>
浏览器输入 <a target="_blank" rel="noopener" href="http://ip:9200/_license">http://IP:9200/_license</a> 可以看到，弹窗出来，需要输入密码了<br>
<img src="https://www.freesion.com/images/561/b7034fa6ab245e277567b01d40929119.png" alt="在这里插入图片描述"><br>
<img src="https://brath.oss-cn-shanghai.aliyuncs.com/pigo/9b1a95e8a4b361dd4f7e3012300d1115.png" alt="在这里插入图片描述"></p>
<h2 id="附录常见问题"><a class="markdownIt-Anchor" href="#附录常见问题">#</a> 附录：常见问题</h2>
<h3 id="1如何修改账号密码"><a class="markdownIt-Anchor" href="#1如何修改账号密码">#</a> 1. 如何修改账号密码</h3>
<p>以 elastic 账号为例，注意需要在 elasticsearch 服务已启动的情况下进行</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -H &#x27;Content-Type: application/json&#x27; -u elastic:123456 -XPUT &#x27;http://localhost:9200/_xpack/security/user/elastic/_password&#x27; -d &#x27;&#123; &quot;password&quot; : &quot;1234567&quot; &#125;&#x27;</span><br></pre></td></tr></table></figure>
<h3 id="2客户端es-head连接问题"><a class="markdownIt-Anchor" href="#2客户端es-head连接问题">#</a> 2. 客户端 ES-HEAD 连接问题</h3>
<p>连接失败情况下先检查是否是跨域问题</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">http.cors.enabled: true</span><br><span class="line">http.cors.allow-origin: &quot;*&quot;</span><br><span class="line">http.cors.allow-headers: Authorization,X-Requested-With,Content-Length,Content-Type</span><br></pre></td></tr></table></figure>
<p>例如下图连接的时候报错未授权<br>
<img src="https://www.freesion.com/images/96/57fa25b106cf1cdee9f44a2f8577e620.png" alt="在这里插入图片描述"></p>
<p>解决方案：在访问的 URL 中拼接授权账号信息<br>
示例：?auth_user=elastic&amp;auth_password=1234567</p>
<p>示例：指定服务端地址以及账户</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://IP:9100/?base_uri=http://IP:9200&amp;auth_user=elastic&amp;auth_password=1234567</span><br></pre></td></tr></table></figure>
<h3 id="3启动报xpack相关错"><a class="markdownIt-Anchor" href="#3启动报xpack相关错">#</a> 3. 启动报 XPACK 相关错</h3>
<p><img src="https://www.freesion.com/images/947/90ff281ef660a79e49875391f87e474b.png" alt="在这里插入图片描述"></p>
<p>DecoderException: javax.net.ssl.SSLHandshakeException: No available authentication scheme<br>
<img src="https://www.freesion.com/images/485/efd6d897ad8655121334fd050eecd445.png" alt="在这里插入图片描述"></p>
<p>解决方案：请通过上文配置步骤，排查，检查证书是否已经配置好，以及配置是否填写正确</p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2022-12-27T08:18:48.554Z" title="2022-12-27 16:18:48">2022-12-27</time>发表</span><span class="level-item"><time dateTime="2021-10-22T03:45:20.100Z" title="2021-10-22 11:45:20">2021-10-22</time>更新</span><span class="level-item">1 小时读完 (大约7552个字)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2022/12/27/%E3%80%90Elasticsearch%E3%80%91Elasticsearch/">Elasticsearch学习</a></p><div class="content"><h1 id="elasticsearch"><a class="markdownIt-Anchor" href="#elasticsearch">#</a> Elasticsearch</h1>
<p><img src="https://images-jsh.oss-cn-beijing.aliyuncs.com/img/elasticsearch.jpg" alt="img"></p>
<h2 id="目标"><a class="markdownIt-Anchor" href="#目标">#</a> 目标</h2>
<ul>
<li>了解 ES 中的基本概念</li>
<li>掌握 RESTFul 操作 ES 的 CRUD</li>
<li>掌握 Spring Data Elasticsearch 操作 ES</li>
</ul>
<h2 id="简介"><a class="markdownIt-Anchor" href="#简介">#</a> 简介</h2>
<p>Elasticsearch 是一个基于 Lucene 的搜索服务器。它提供了一个分布式多用户能力的全文搜索引擎，基于 RESTful web 接口。Elasticsearch 是用 Java 开发的，并作为 Apache 许可条款下的开放源码发布，是当前流行的企业级搜索引擎。设计用于云计算中，能够达到实时搜索，稳定，可靠，快速，安装使用方便。</p>
<p>我们建立一个网站或应用程序，并要添加搜索功能，但是想要完成搜索工作的创建是非常困难的。我们希望搜索解决方案要运行速度快，我们希望能有一个零配置和一个完全免费的搜索模式，我们希望能够简单地使用 JSON 通过 HTTP 来索引数据，我们希望我们的搜索服务器始终可用，我们希望能够从一台开始并扩展到数百台，我们要实时搜索，我们要简单的多用户，我们希望建立一个云的解决方案。因此我们利用 Elasticsearch 来解决所有这些问题及可能出现的更多其它问题。</p>
<h2 id="安装和运行"><a class="markdownIt-Anchor" href="#安装和运行">#</a> 安装和运行</h2>
<p>该软件是基于 Java 编写的解压即用的软件，只需要有 Java 的运行环境即可，把压缩包解压后，进入到 bin 目录运行 elasticsearch.bat，出现以下界面，表示成功启动服务器</p>
<p><img src="https://images-jsh.oss-cn-beijing.aliyuncs.com/img/20190606092632.png" alt="img"></p>
<p>浏览器输入：<strong>localhost:9200</strong>，看到浏览器输出服务器的信息，表示安装成功，可以使用了</p>
<p><img src="https://images-jsh.oss-cn-beijing.aliyuncs.com/img/20190606093141.png" alt="img"></p>
<p>注意：程序启动后有两个端口 9200 和 9300，9200 端口用于 HTTP 协议，基于 RESTFul 来使用，9300 端口用于 TCP 协议，基于 jar 包来使用</p>
<h3 id="后台启动"><a class="markdownIt-Anchor" href="#后台启动">#</a> 后台启动</h3>
<p>使用<strong>安装目录 /bin/elasticsearch-service.bat</strong> 程序可以把 Elasticsearch 安装后服务列表中，以后我们可以在服务列表来启动该程序，也可以设置成开机启动模式</p>
<p>注意：设置后台启动需要手动配置 Java 虚拟机的路径，使用命令<strong> elasticsearch-service.bat manager</strong> 来配置</p>
<p><img src="https://images-jsh.oss-cn-beijing.aliyuncs.com/img/20190622211819.png" alt="img"></p>
<h3 id="安装head插件"><a class="markdownIt-Anchor" href="#安装head插件">#</a> 安装 head 插件</h3>
<p>Elasticsearch 默认的客户端工具是命令行形式的，操作起来不方便，也不直观看到数据的展示，所以我们需要去安装一个可视化插件，但是这些插件都是基于 H5 开发的，在谷歌的应用商店中找到<strong> elasticsearch-head</strong> 插件，然后安装，使用该插件能比较直观的展示服务器中的数据</p>
<h3 id="安装kibana"><a class="markdownIt-Anchor" href="#安装kibana">#</a> 安装 kibana</h3>
<p>该软件也是解压即用的工具，用于管理和监控 Elasticsearch 的运作，同时内部包含了客户端工具，支持 RESTFul 操作 Elasticsearch。解压后运行 bin/kibana.bat，看到启动成功的端口号即可以使用浏览器来使用了</p>
<p><img src="https://images-jsh.oss-cn-beijing.aliyuncs.com/img/20190606141235.png" alt="img"></p>
<p>浏览器输入：<a target="_blank" rel="noopener" href="http://localhost:5601/">http://localhost:5601</a></p>
<h2 id="概念名词"><a class="markdownIt-Anchor" href="#概念名词">#</a> 概念名词</h2>
<h3 id="数据存储图"><a class="markdownIt-Anchor" href="#数据存储图">#</a> 数据存储图</h3>
<p><img src="https://images-jsh.oss-cn-beijing.aliyuncs.com/img/20190604113843.png" alt="img"></p>
<p>注意：从 Elasticsearch6 开始一个索引里面只能有一个类型，后续计划删除类型这个概念，从 ES6 开始一般让索引名称和类型名称一致</p>
<h3 id="主要组件"><a class="markdownIt-Anchor" href="#主要组件">#</a> 主要组件</h3>
<ul>
<li>
<p>索引</p>
<p>ES 将数据存储于一个或多个索引中，索引是具有类似特性的文档的集合。类比传统的关系型数据库领域来说，索引相当于 SQL 中的一个数据库，或者一个数据存储方案 (schema)。索引由其名称 (必须为全小写字符) 进行标识，并通过引用此名称完成文档的创建、搜索、更新及删除操作。一个 ES 集群中可以按需创建任意数目的索引。</p>
</li>
<li>
<p>类型</p>
<p>类型是索引内部的逻辑分区 (category/partition)，然而其意义完全取决于用户需求。因此，一个索引内部可定义一个或多个类型 (type)。一般来说，类型就是为那些拥有相同的域的文档做的预定义。例如，在索引中，可以定义一个用于存储用户数据的类型，一个存储日志数据的类型，以及一个存储评论数据的类型。类比传统的关系型数据库领域来说，类型相当于表。</p>
</li>
<li>
<p>映射</p>
<p>Mapping, 就是对索引库中索引的字段名称及其数据类型进行定义，类似于 mysql 中的表结构信息。不过 es 的 mapping 比数据库灵活很多，它可以动态识别字段。一般不需要指定 mapping 都可以，因为 es 会自动根据数据格式识别它的类型，如果你需要对某些字段添加特殊属性（如：定义使用其它分词器、是否分词、是否存储等），就必须手动添加 mapping。</p>
<p>需要注意的是映射是不可修改的，一旦确定就不允许改动，在使用自动识别功能时，会以第一个存入的文档为参考来建立映射，后面存入的文档也必须符合该映射才能存入</p>
</li>
<li>
<p>文档</p>
<p>文档是 Lucene 索引和搜索的原子单位，它是包含了一个或多个域的容器，基于 JSON 格式进行表示。文档由一个或多个域组成，每个域拥有一个名字及一个或多个值，有多个值的域通常称为多值域。每个文档可以存储不同的域集，但同一类型下的文档至应该有某种程度上的相似之处。</p>
</li>
</ul>
<h3 id="分片和副本"><a class="markdownIt-Anchor" href="#分片和副本">#</a> 分片和副本</h3>
<p>ES 的分片 (shard) 机制可将一个索引内部的数据分布地存储于多个节点，它通过将一个索引切分为多个底层物理的 Lucene 索引完成索引数据的分割存储功能，这每一个物理的 Lucene 索引称为一个分片 (shard)。每个分片其内部都是一个全功能且独立的索引，因此可由集群中的任何主机存储。创建索引时，用户可指定其分片的数量，默认数量为 5 个。</p>
<p>Shard 有两种类型：primary 和 replica，即主 shard 及副本 shard。Primary shard 用于文档存储，每个新的索引会自动创建 5 个 Primary shard，当然此数量可在索引创建之前通过配置自行定义，不过，一旦创建完成，其 Primary shard 的数量将不可更改。Replica shard 是 Primary Shard 的副本，用于冗余数据及提高搜索性能。每个 Primary shard 默认配置了一个 Replica shard，但也可以配置多个，且其数量可动态更改。ES 会根据需要自动增加或减少这些 Replica shard 的数量。</p>
<h3 id="分词器"><a class="markdownIt-Anchor" href="#分词器">#</a> 分词器</h3>
<p>把文本内容按照标准进行切分，默认的是 standard，该分词器按照单词切分，内容转变为小写，去掉标点，遇到每个中文字符都当成 1 个单词处理，后面会安装开源的中文分词器插件（ik）</p>
<h4 id="感受分词器效果"><a class="markdownIt-Anchor" href="#感受分词器效果">#</a> 感受分词器效果</h4>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">先创建一个名叫shop_product的索引，然后再感受分词效果</span><br><span class="line">PUT /shop_product</span><br><span class="line"></span><br><span class="line">默认分词器：</span><br><span class="line">GET /shop_product/_analyze</span><br><span class="line">&#123;</span><br><span class="line">  &quot;text&quot;:&quot;I am Groot&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">GET /shop_product/_analyze</span><br><span class="line">&#123;</span><br><span class="line">  &quot;text&quot;:&quot;英特尔酷睿i7处理器&quot;</span><br><span class="line">&#125;</span><br><span class="line">结论：默认的分词器只能对英文正常分词，不能对中文正常分词</span><br></pre></td></tr></table></figure>
<h4 id="安装ik分词器"><a class="markdownIt-Anchor" href="#安装ik分词器">#</a> 安装 IK 分词器</h4>
<p>直接把压缩文件中的内容解压，然后放在 elasticsearch/plugins 下，然后重启即可</p>
<p><img src="https://images-jsh.oss-cn-beijing.aliyuncs.com/img/20190611130218.png" alt="img"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">IK分词器：</span><br><span class="line">ik_smart：粗力度分词</span><br><span class="line">ik_max_word：细力度分词</span><br><span class="line"></span><br><span class="line">GET /shop_product/_analyze</span><br><span class="line">&#123;</span><br><span class="line">  &quot;text&quot;:&quot;I am Groot&quot;,</span><br><span class="line">  &quot;analyzer&quot;:&quot;ik_smart&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">GET /shop_product/_analyze</span><br><span class="line">&#123;</span><br><span class="line">  &quot;text&quot;:&quot;英特尔酷睿i7处理器&quot;,</span><br><span class="line">  &quot;analyzer&quot;:&quot;ik_smart&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">GET /shop_product/_analyze</span><br><span class="line">&#123;</span><br><span class="line">  &quot;text&quot;:&quot;英特尔酷睿i7处理器&quot;,</span><br><span class="line">  &quot;analyzer&quot;:&quot;ik_max_word&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">结论：都能正常分词</span><br></pre></td></tr></table></figure>
<h4 id="拓展词库"><a class="markdownIt-Anchor" href="#拓展词库">#</a> 拓展词库</h4>
<p>最简单的方式就是找到 IK 插件中的<strong> config/main.dic</strong> 文件，往里面添加新的词汇，然后重启服务器即可</p>
<h3 id="倒排索引"><a class="markdownIt-Anchor" href="#倒排索引">#</a> 倒排索引</h3>
<p><img src="https://images-jsh.oss-cn-beijing.aliyuncs.com/img/20190604141259.png" alt="img"></p>
<h2 id="基本操作了解"><a class="markdownIt-Anchor" href="#基本操作了解">#</a> 基本操作（了解）</h2>
<h3 id="索引操作"><a class="markdownIt-Anchor" href="#索引操作">#</a> 索引操作</h3>
<p>建表索引，相当于在是在建立数据库</p>
<h4 id="建立索引"><a class="markdownIt-Anchor" href="#建立索引">#</a> 建立索引</h4>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">语法：PUT /索引名</span><br><span class="line">在没有特殊设置的情况下，默认有5个分片，1个备份，也可以通过请求参数的方式来指定</span><br><span class="line">参数格式：</span><br><span class="line">&#123;</span><br><span class="line">  &quot;settings&quot;: &#123;</span><br><span class="line">    &quot;number_of_shards&quot;: 5, //设置5个片区</span><br><span class="line">    &quot;number_of_replicas&quot;: 1 //设置1个备份</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="删除索引"><a class="markdownIt-Anchor" href="#删除索引">#</a> 删除索引</h4>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">语法：DELETE /索引名</span><br></pre></td></tr></table></figure>
<h3 id="映射操作"><a class="markdownIt-Anchor" href="#映射操作">#</a> 映射操作</h3>
<h4 id="建立索引和映射"><a class="markdownIt-Anchor" href="#建立索引和映射">#</a> 建立索引和映射</h4>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">语法：PUT /索引名</span><br><span class="line">&#123;</span><br><span class="line">  &quot;mappings&quot;: &#123;</span><br><span class="line">    类型名: &#123;</span><br><span class="line">      &quot;properties..0&quot;: &#123;</span><br><span class="line">        字段名: &#123;</span><br><span class="line">          &quot;type&quot;: 字段类型, </span><br><span class="line">          &quot;analyzer&quot;: 分词器类型, </span><br><span class="line">          &quot;search_analyzer&quot;: 分词器类型,</span><br><span class="line">          ...</span><br><span class="line">        &#125;,</span><br><span class="line">        ...</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">字段类型：double / long / integer / text / keyword / date / binary</span><br><span class="line">注意：text和keyword都是字符串类型，但是只有text类型的数据才能分词，字段的配置一旦确定就不能更改</span><br><span class="line">映射的配置项有很多，我们可以根据需要只配置用得上的属性</span><br></pre></td></tr></table></figure>
<h4 id="查询映射"><a class="markdownIt-Anchor" href="#查询映射">#</a> 查询映射</h4>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">语法：GET /索引名/_mapping</span><br></pre></td></tr></table></figure>
<h2 id="crud操作"><a class="markdownIt-Anchor" href="#crud操作">#</a> CRUD 操作</h2>
<h3 id="文档操作"><a class="markdownIt-Anchor" href="#文档操作">#</a> 文档操作</h3>
<h4 id="新增和替换文档"><a class="markdownIt-Anchor" href="#新增和替换文档">#</a> 新增和替换文档</h4>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">语法：PUT /索引名/类型名/文档ID</span><br><span class="line">&#123;</span><br><span class="line">  field1: value1,</span><br><span class="line">  field2: value2,</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">注意：当索引/类型/映射不存在时，会使用默认设置自动添加</span><br><span class="line">ES中的数据一般是从别的数据库导入的，所以文档的ID会沿用原数据库中的ID</span><br><span class="line">索引库中没有该ID对应的文档时则新增，拥有该ID对应的文档时则替换</span><br><span class="line"></span><br><span class="line">需求1：新增一个文档</span><br><span class="line">需求2：替换一个文档</span><br></pre></td></tr></table></figure>
<p>每一个文档都内置以下字段</p>
<blockquote>
<p>_index：所属索引</p>
<p>_type：所属类型</p>
<p>_id：文档 ID</p>
<p>_version：乐观锁版本号</p>
<p>_source：数据内容</p>
</blockquote>
<h4 id="查询文档"><a class="markdownIt-Anchor" href="#查询文档">#</a> 查询文档</h4>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">语法：</span><br><span class="line">根据ID查询 -&gt; GET /索引名/类型名/文档ID</span><br><span class="line">查询所有（基本查询语句） -&gt; GET /索引名/类型名/_search</span><br><span class="line"></span><br><span class="line">需求1：根据文档ID查询一个文档</span><br><span class="line">需求2：查询所有的文档</span><br></pre></td></tr></table></figure>
<p>查询所有结果中包含以下字段</p>
<blockquote>
<p>took：耗时</p>
<p>_shards.total：分片总数</p>
<p>hits.total：查询到的数量</p>
<p>hits.max_score：最大匹配度</p>
<p>hits.hits：查询到的结果</p>
<p>hits.hits._score：匹配度</p>
</blockquote>
<h4 id="删除文档"><a class="markdownIt-Anchor" href="#删除文档">#</a> 删除文档</h4>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">语法：DELETE /索引名/类型名/文档ID</span><br><span class="line">注意：这里的删除并且不是真正意义上的删除，仅仅是清空文档内容而已，并且标记该文档的状态为删除</span><br><span class="line"></span><br><span class="line">需求1：根据文档ID删除一个文档</span><br><span class="line">需求2：替换刚刚删除的文档</span><br></pre></td></tr></table></figure>
<h2 id="高级查询"><a class="markdownIt-Anchor" href="#高级查询">#</a> 高级查询</h2>
<p>数据准备：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">PUT /shop_product</span><br><span class="line">&#123;</span><br><span class="line">  &quot;mappings&quot;: &#123;</span><br><span class="line">    &quot;shop_product&quot;: &#123;</span><br><span class="line">      &quot;properties&quot;: &#123;</span><br><span class="line">        &quot;id&quot;: &#123;</span><br><span class="line">          &quot;type&quot;: &quot;integer&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;title&quot;:&#123;</span><br><span class="line">          &quot;type&quot;: &quot;text&quot;, </span><br><span class="line">          &quot;analyzer&quot;: &quot;ik_smart&quot;, </span><br><span class="line">          &quot;search_analyzer&quot;: &quot;ik_smart&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;price&quot;:&#123;</span><br><span class="line">          &quot;type&quot;: &quot;double&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;intro&quot;:&#123;</span><br><span class="line">          &quot;type&quot;: &quot;text&quot;, </span><br><span class="line">          &quot;analyzer&quot;: &quot;ik_smart&quot;, </span><br><span class="line">          &quot;search_analyzer&quot;: &quot;ik_smart&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;brand&quot;:&#123;</span><br><span class="line">          &quot;type&quot;: &quot;keyword&quot;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">POST /shop_product/shop_product/_bulk</span><br><span class="line">&#123;&quot;create&quot;:&#123;&quot;_id&quot;: 1&#125;&#125;</span><br><span class="line">&#123;&quot;id&quot;:1,&quot;title&quot;:&quot;Apple iPhone XR (A2108) 128GB 白色 移动联通电信4G手机 双卡双待&quot;,&quot;price&quot;:5299,&quot;intro&quot;:&quot;【iPhoneXR限时特惠！】6.1英寸视网膜显示屏，A12仿生芯片，面容识别，无线充电，支持双卡！选【换修无忧版】获 AppleCare 原厂服务，享只换不修！更有快速换机、保值换新、轻松月付！&quot;,&quot;brand&quot;:&quot;Apple&quot;&#125;</span><br><span class="line">&#123;&quot;create&quot;:&#123;&quot;_id&quot;: 2&#125;&#125;</span><br><span class="line">&#123;&quot;id&quot;:2,&quot;title&quot;:&quot;Apple 2019款 Macbook Pro 13.3【带触控栏】八代i7 18G 256G RP645显卡 深空灰 苹果笔记本电脑 轻薄本 MUHN2CH/A&quot;,&quot;price&quot;:15299,&quot;intro&quot;:&quot;【八月精选】Pro2019年新品上市送三重好礼，现在购买领满8000减400元优惠神劵，劵后更优惠！&quot;,&quot;brand&quot;:&quot;Apple&quot;&#125;</span><br><span class="line">&#123;&quot;create&quot;:&#123;&quot;_id&quot;: 3&#125;&#125;</span><br><span class="line">&#123;&quot;id&quot;:3,&quot;title&quot;:&quot;Apple iPad Air 3 2019年新款平板电脑 10.5英寸（64G WLAN版/A12芯片/Retina显示屏/MUUL2CH/A）金色&quot;,&quot;price&quot;:3788,&quot;intro&quot;:&quot;8月尊享好礼！买iPad即送蓝牙耳机！领券立减！多款产品支持手写笔！【新一代iPad，总有一款适合你】选【换修无忧版】获 AppleCare 原厂服务，享只换不修！更有快速换机、保值换新、轻松月付！&quot;,&quot;brand&quot;:&quot;Apple&quot;&#125;</span><br><span class="line">&#123;&quot;create&quot;:&#123;&quot;_id&quot;: 4&#125;&#125;</span><br><span class="line">&#123;&quot;id&quot;:4,&quot;title&quot;:&quot;华为HUAWEI MateBook X Pro 2019款 英特尔酷睿i5 13.9英寸全面屏轻薄笔记本电脑(i5 8G 512G 3K 触控) 灰&quot;,&quot;price&quot;:7999,&quot;intro&quot;:&quot;3K全面屏开启无界视野;轻薄设计灵动有型，HuaweiShare一碰传&quot;,&quot;brand&quot;:&quot;华为&quot;&#125;</span><br><span class="line">&#123;&quot;create&quot;:&#123;&quot;_id&quot;: 5&#125;&#125;</span><br><span class="line">&#123;&quot;id&quot;:5,&quot;title&quot;:&quot;华为 HUAWEI Mate20 X (5G) 7nm工艺5G旗舰芯片全面屏超大广角徕卡三摄8GB+256GB翡冷翠5G双模全网通手机&quot;,&quot;price&quot;:6199,&quot;intro&quot;:&quot;【5G双模，支持SA/NSA网络，7.2英寸全景巨屏，石墨烯液冷散热】5G先驱，极速体验。&quot;,&quot;brand&quot;:&quot;华为&quot;&#125;</span><br><span class="line">&#123;&quot;create&quot;:&#123;&quot;_id&quot;: 6&#125;&#125;</span><br><span class="line">&#123;&quot;id&quot;:6,&quot;title&quot;:&quot;华为平板 M6 10.8英寸麒麟980影音娱乐平板电脑4GB+64GB WiFi（香槟金）&quot;,&quot;price&quot;:2299,&quot;intro&quot;:&quot;【华为暑期购】8月2日-4日，M5青春版指定爆款型号优惠100元，AI语音控制&quot;,&quot;brand&quot;:&quot;华为&quot;&#125;</span><br><span class="line">&#123;&quot;create&quot;:&#123;&quot;_id&quot;: 7&#125;&#125;</span><br><span class="line">&#123;&quot;id&quot;:7,&quot;title&quot;:&quot;荣耀20 PRO DXOMARK全球第二高分 4800万四摄 双光学防抖 麒麟980 全网通4G 8GB+128GB 蓝水翡翠 拍照手机&quot;,&quot;price&quot;:3199,&quot;intro&quot;:&quot;白条6期免息！麒麟980，4800万全焦段AI四摄！荣耀20系列2699起，4800万超广角AI四摄！&quot;,&quot;brand&quot;:&quot;荣耀&quot;&#125;</span><br><span class="line">&#123;&quot;create&quot;:&#123;&quot;_id&quot;: 8&#125;&#125;</span><br><span class="line">&#123;&quot;id&quot;:8,&quot;title&quot;:&quot;荣耀MagicBook Pro 16.1英寸全面屏轻薄性能笔记本电脑（酷睿i7 8G 512G MX250 IPS FHD 指纹解锁）冰河银&quot;,&quot;price&quot;:6199,&quot;intro&quot;:&quot;16.1英寸无界全面屏金属轻薄本，100%sRGB色域，全高清IPS防眩光护眼屏，14小时长续航，指纹一健开机登录，魔法一碰传高速传输。&quot;,&quot;brand&quot;:&quot;荣耀&quot;&#125;</span><br><span class="line">&#123;&quot;create&quot;:&#123;&quot;_id&quot;: 9&#125;&#125;</span><br><span class="line">&#123;&quot;id&quot;:9,&quot;title&quot;:&quot;荣耀平板5 麒麟8核芯片 GT游戏加速 4G+128G 10.1英寸全高清屏影音平板电脑 WiFi版 冰川蓝&quot;,&quot;price&quot;:1549,&quot;intro&quot;:&quot;【爆款平板推荐】哈曼卡顿专业调音，10.1英寸全高清大屏，双喇叭立体环绕音，配置多重护眼，值得拥有！&quot;,&quot;brand&quot;:&quot;荣耀&quot;&#125;</span><br><span class="line">&#123;&quot;create&quot;:&#123;&quot;_id&quot;: 10&#125;&#125;</span><br><span class="line">&#123;&quot;id&quot;:10,&quot;title&quot;:&quot;小米9 4800万超广角三摄 6GB+128GB全息幻彩蓝 骁龙855 全网通4G 双卡双待 水滴全面屏拍照智能游戏手机&quot;,&quot;price&quot;:2799,&quot;intro&quot;:&quot;限时优惠200，成交价2799！索尼4800万广角微距三摄，屏下指纹解锁！&quot;,&quot;brand&quot;:&quot;小米&quot;&#125;</span><br><span class="line">&#123;&quot;create&quot;:&#123;&quot;_id&quot;: 11&#125;&#125;</span><br><span class="line">&#123;&quot;id&quot;:11,&quot;title&quot;:&quot;小米(MI)Pro 2019款 15.6英寸金属轻薄笔记本(第八代英特尔酷睿i7-8550U 16G 512GSSD MX250 2G独显) 深空灰&quot;,&quot;price&quot;:6899,&quot;intro&quot;:&quot;【PCIE固态硬盘、72%NTSC高色域全高清屏】B面康宁玻璃覆盖、16G双通道大内存、第八代酷睿I7处理器、专业级调校MX150&quot;,&quot;brand&quot;:&quot;小米&quot;&#125;</span><br><span class="line">&#123;&quot;create&quot;:&#123;&quot;_id&quot;: 12&#125;&#125;</span><br><span class="line">&#123;&quot;id&quot;:12,&quot;title&quot;:&quot;联想(Lenovo)拯救者Y7000P 2019英特尔酷睿i7 15.6英寸游戏笔记本电脑(i7 9750H 16G 1T SSD GTX1660Ti 144Hz)&quot;,&quot;price&quot;:9299,&quot;intro&quot;:&quot;超大1T固态，升级双通道16G内存一步到位，GTX1660Ti电竞级独显，英特尔9代i7H高性能处理器，144Hz电竞屏窄边框！&quot;,&quot;brand&quot;:&quot;联想&quot;&#125;</span><br></pre></td></tr></table></figure>
<p>Elasticsearch 基于 JSON 提供完整的查询 DSL（Domain Specific Language：领域特定语言）来定义查询。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">基本语法：</span><br><span class="line">GET /索引名/类型名/_search</span><br></pre></td></tr></table></figure>
<p>一般都是需要配合查询参数来使用的，配合不同的参数有不同的查询效果</p>
<p>参数配置项可以参考博客：<a target="_blank" rel="noopener" href="https://www.jianshu.com/p/6333940621ec">https://www.jianshu.com/p/6333940621ec</a></p>
<h3 id="结果排序"><a class="markdownIt-Anchor" href="#结果排序">#</a> 结果排序</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">参数格式：</span><br><span class="line">&#123;</span><br><span class="line">  &quot;sort&quot;: [</span><br><span class="line">    &#123;field: 排序规则&#125;,</span><br><span class="line">    ...</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">排序</span><br><span class="line">GET /shop_product/shop_product/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;sort&quot;: [</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;price&quot;: &#123;</span><br><span class="line">        &quot;order&quot;: &quot;desc&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">排序规则：</span><br><span class="line">asc表示升序</span><br><span class="line">desc:表示降序</span><br><span class="line">没有配置排序的情况下，默认按照评分降序排列</span><br></pre></td></tr></table></figure>
<h3 id="分页查询"><a class="markdownIt-Anchor" href="#分页查询">#</a> 分页查询</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">参数格式：</span><br><span class="line">&#123;</span><br><span class="line">  &quot;from&quot;: start,</span><br><span class="line">  &quot;size&quot;: pageSize</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">分页 从第几个开始 每页几个</span><br><span class="line">GET /shop_product/shop_product/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;from&quot;: 2,</span><br><span class="line">  &quot;size&quot;: 4,</span><br><span class="line">  &quot;sort&quot;: [</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;price&quot;: &#123;</span><br><span class="line">        &quot;order&quot;: &quot;desc&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">需求1：查询所有文档按照价格降序排列</span><br><span class="line">需求2：分页查询文档按照价格降序排列，显示第2页，每页显示3个</span><br></pre></td></tr></table></figure>
<h3 id="检索查询"><a class="markdownIt-Anchor" href="#检索查询">#</a> 检索查询</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line">参数格式：</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    检索方式: &#123;field: value&#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">检索查询 全文检索</span><br><span class="line">需求1：查询商品标题中符合&quot;游戏 手机&quot;的字样的商品</span><br><span class="line">GET /shop_product/shop_product/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;match&quot;: &#123;</span><br><span class="line">      &quot;title&quot;: &quot;游戏 手机&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">检索查询 精准匹配</span><br><span class="line">需求2：查询商品价格等于15299的商品</span><br><span class="line">GET /shop_product/shop_product/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;term&quot;: &#123;</span><br><span class="line">      &quot;price&quot;: 15299</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">检索查询 范围检索</span><br><span class="line">需求3：查询商品价格在5000~10000之间商品，按照价格升序排列</span><br><span class="line">GET /shop_product/shop_product/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;range&quot;: &#123;</span><br><span class="line">      &quot;price&quot;: &#123;</span><br><span class="line">        &quot;gte&quot;: 5000,</span><br><span class="line">        &quot;lte&quot;: 10000</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;sort&quot;: [</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;price&quot;: &#123;</span><br><span class="line">        &quot;order&quot;: &quot;asc&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">检索方式：</span><br><span class="line">term表示精确匹配，value值不会被分词器拆分，按照倒排索引匹配</span><br><span class="line">match表示全文检索，value值会被分词器拆分，然后去倒排索引中匹配</span><br><span class="line">range表示范围检索，其value值是一个对象，如&#123; &quot;range&quot;: &#123;field: &#123;比较规则: value, ...&#125;&#125; &#125;</span><br><span class="line">  比较规则有gt / gte / lt / lte 等</span><br><span class="line">  </span><br><span class="line">注意：term和match都能用在数值和字符上，range用在数值上</span><br><span class="line"></span><br><span class="line">需求1：查询商品标题中符合&quot;游戏 手机&quot;的字样的商品</span><br><span class="line">需求2：查询商品价格等于15299的商品</span><br><span class="line">需求3：查询商品价格在5000~10000之间商品，按照价格升序排列</span><br></pre></td></tr></table></figure>
<h3 id="关键字查询"><a class="markdownIt-Anchor" href="#关键字查询">#</a> 关键字查询</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">参数格式：</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;multi_match&quot;: &#123;</span><br><span class="line">      &quot;query&quot;: value,</span><br><span class="line">      &quot;fields&quot;: [field1, field2, ...]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">关键字查询</span><br><span class="line">需求1：查询商品标题或简介中符合&quot;蓝牙 指纹 双卡&quot;的字样的商品</span><br><span class="line">GET /shop_product/shop_product/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;multi_match&quot;: &#123;</span><br><span class="line">      &quot;query&quot;: &quot;蓝牙 指纹 双卡&quot;,</span><br><span class="line">      &quot;fields&quot;: [&quot;title&quot;, &quot;intro&quot;]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">multi_match：表示在多个字段间做检索，只要其中一个字段满足条件就能查询出来，多用在字段上</span><br><span class="line"></span><br><span class="line">需求1：查询商品标题或简介中符合&quot;蓝牙 指纹 双卡&quot;的字样的商品</span><br></pre></td></tr></table></figure>
<h3 id="高亮显示"><a class="markdownIt-Anchor" href="#高亮显示">#</a> 高亮显示</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">参数格式：</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123; ... &#125;,</span><br><span class="line">  &quot;highlight&quot;: &#123;</span><br><span class="line">    &quot;fields&quot;: &#123;</span><br><span class="line">      field1: &#123;&#125;,</span><br><span class="line">      field2: &#123;&#125;,</span><br><span class="line">      ...</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;pre_tags&quot;: 开始标签,</span><br><span class="line">    &quot;post_tags&quot; 结束标签</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">高亮显示</span><br><span class="line">需求1：查询商品标题或简介中符合&quot;蓝牙 指纹 双卡&quot;的字样的商品，并且高亮显示</span><br><span class="line">GET /shop_product/shop_product/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;multi_match&quot;: &#123;</span><br><span class="line">      &quot;query&quot;: &quot;蓝牙 指纹 双卡&quot;,</span><br><span class="line">      &quot;fields&quot;: [&quot;title&quot;, &quot;intro&quot;]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;highlight&quot;: &#123;</span><br><span class="line">    &quot;fields&quot;: &#123;</span><br><span class="line">      &quot;title&quot;: &#123;&#125;,</span><br><span class="line">      &quot;intro&quot;: &#123;&#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;pre_tags&quot;:&quot;&lt;h1&gt;&quot;,</span><br><span class="line">    &quot;post_tags&quot;:&quot;&lt;/h1&gt;&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">highlight：表示高亮显示，需要在fields中配置哪些字段中检索到该内容需要高亮显示</span><br><span class="line">  必须配合检索(term / match)一起使用</span><br><span class="line">  </span><br><span class="line">需求1：查询商品标题或简介中符合&quot;蓝牙 指纹 双卡&quot;的字样的商品，并且高亮显示</span><br></pre></td></tr></table></figure>
<h3 id="逻辑查询"><a class="markdownIt-Anchor" href="#逻辑查询">#</a> 逻辑查询</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line">参数格式： </span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;bool&quot;: &#123;</span><br><span class="line">      逻辑规则: [</span><br><span class="line">        &#123;检索方式: &#123;field: value&#125;&#125;, </span><br><span class="line">        ...</span><br><span class="line">      ],</span><br><span class="line">      ...</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">逻辑查询</span><br><span class="line">需求1：查询商品标题中符合&quot;i7&quot;的字样并且价格大于7000的商品</span><br><span class="line">GET /shop_product/shop_product/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;bool&quot;: &#123;</span><br><span class="line">      &quot;must&quot;: [</span><br><span class="line">        &#123;&quot;match&quot;: &#123;</span><br><span class="line">          &quot;title&quot;: &quot;i7&quot;</span><br><span class="line">        &#125;&#125;,</span><br><span class="line">        &#123;&quot;range&quot;: &#123;</span><br><span class="line">          &quot;price&quot;: &#123;</span><br><span class="line">            &quot;gt&quot;: 7000</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;&#125;</span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">逻辑查询</span><br><span class="line">需求2：查询商品标题中符合&quot;pro&quot;的字样或者价格在1000~3000的商品</span><br><span class="line">GET /shop_product/shop_product/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;bool&quot;: &#123;</span><br><span class="line">      &quot;should&quot;: [</span><br><span class="line">        &#123;&quot;match&quot;: &#123;</span><br><span class="line">          &quot;title&quot;: &quot;pro&quot;</span><br><span class="line">        &#125;&#125;,</span><br><span class="line">        &#123;&quot;range&quot;: &#123;</span><br><span class="line">          &quot;price&quot;: &#123;</span><br><span class="line">            &quot;gte&quot;: 1000,</span><br><span class="line">            &quot;lte&quot;: 3000</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;&#125;</span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">逻辑规则：must / should / must_not，相当于and / or / not</span><br><span class="line"></span><br><span class="line">需求1：查询商品标题中符合&quot;i7&quot;的字样并且价格大于7000的商品</span><br><span class="line">需求2：查询商品标题中符合&quot;pro&quot;的字样或者价格在1000~3000的商品</span><br></pre></td></tr></table></figure>
<h3 id="过滤查询"><a class="markdownIt-Anchor" href="#过滤查询">#</a> 过滤查询</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">参数格式：</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;bool&quot;: &#123;</span><br><span class="line">      &quot;filter&quot;: [</span><br><span class="line">        &#123; 检索方式: &#123; field: value &#125; &#125;，            	</span><br><span class="line">        ...</span><br><span class="line">      ]</span><br><span class="line">    &#125;             </span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">过滤查询 不评分</span><br><span class="line">GET /shop_product/shop_product/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;bool&quot;: &#123;</span><br><span class="line">      &quot;filter&quot;: [</span><br><span class="line">        &#123;&quot;match&quot;: &#123;</span><br><span class="line">          &quot;title&quot;: &quot;pro&quot;</span><br><span class="line">        &#125;&#125;</span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">从效果上讲过滤查询和检索查询能做一样的效果</span><br><span class="line">区别在于过滤查询不评分，结果能缓存，检索查询要评分，结果不缓存</span><br><span class="line">一般是不会直接使用过滤查询，都是在检索了一定数据的基础上再使用</span><br></pre></td></tr></table></figure>
<p>关于 filter 的更多认知推荐大家读这篇博客：<a target="_blank" rel="noopener" href="https://blog.csdn.net/laoyang360/article/details/80468757">https://blog.csdn.net/laoyang360/article/details/80468757</a></p>
<h3 id="分组查询"><a class="markdownIt-Anchor" href="#分组查询">#</a> 分组查询</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><span class="line">参数格式：</span><br><span class="line">&#123;</span><br><span class="line">  &quot;size&quot;: 0,</span><br><span class="line">  &quot;aggs&quot;: &#123;</span><br><span class="line">    自定义分组字段: &#123;</span><br><span class="line">      &quot;terms&quot;: &#123;</span><br><span class="line">        &quot;field&quot;: 分组字段, </span><br><span class="line">        &quot;order&quot;: &#123;自定义统计字段:排序规则&#125;, </span><br><span class="line">        &quot;size&quot;: 10  //默认显示10组 </span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;aggs&quot;: &#123; //分组后的统计查询，相当于MySQL分组函数查询</span><br><span class="line">        自定义统计字段: &#123;</span><br><span class="line">          分组运算: &#123;</span><br><span class="line">            &quot;field&quot;: 统计字段</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;       </span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">分组查询</span><br><span class="line">需求1：按照品牌分组，统计各品牌的数量</span><br><span class="line">GET /shop_product/shop_product/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;size&quot;: 0,</span><br><span class="line">  &quot;aggs&quot;: &#123;</span><br><span class="line">    &quot;brand_group&quot;: &#123;</span><br><span class="line">      &quot;terms&quot;: &#123;</span><br><span class="line">        &quot;field&quot;: &quot;brand&quot;, </span><br><span class="line">        &quot;order&quot;: &#123;&quot;brand_group&quot;:&quot;desc&quot;&#125;, </span><br><span class="line">        &quot;size&quot;: 10  </span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;aggs&quot;: &#123; </span><br><span class="line">        &quot;brand_group&quot;: &#123;</span><br><span class="line">          &quot;value_count&quot;: &#123;</span><br><span class="line">            &quot;field&quot;: &quot;id&quot;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;       </span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">分组查询</span><br><span class="line">需求2：按照品牌分组，统计各品牌的平均价格</span><br><span class="line">GET /shop_product/shop_product/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;size&quot;: 0,</span><br><span class="line">  &quot;aggs&quot;: &#123;</span><br><span class="line">    &quot;brand_group&quot;: &#123;</span><br><span class="line">      &quot;terms&quot;: &#123;</span><br><span class="line">        &quot;field&quot;: &quot;brand&quot;, </span><br><span class="line">        &quot;order&quot;: &#123;&quot;brand_group&quot;:&quot;desc&quot;&#125;, </span><br><span class="line">        &quot;size&quot;: 10  </span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;aggs&quot;: &#123; </span><br><span class="line">        &quot;brand_group&quot;: &#123;</span><br><span class="line">          &quot;avg&quot;: &#123;</span><br><span class="line">            &quot;field&quot;: &quot;price&quot;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;       </span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">分组查询</span><br><span class="line">需求3：按照品牌分组，统计各品牌的价格数据</span><br><span class="line">GET /shop_product/shop_product/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;size&quot;: 0,</span><br><span class="line">  &quot;aggs&quot;: &#123;</span><br><span class="line">    &quot;brand_group_aggs&quot;: &#123;</span><br><span class="line">      &quot;terms&quot;: &#123;</span><br><span class="line">        &quot;field&quot;: &quot;brand&quot;, </span><br><span class="line">        &quot;order&quot;: &#123;&quot;brand_group_aggs.count&quot;:&quot;desc&quot;&#125;, </span><br><span class="line">        &quot;size&quot;: 10  </span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;aggs&quot;: &#123; </span><br><span class="line">        &quot;brand_group_aggs&quot;: &#123;</span><br><span class="line">          &quot;stats&quot;: &#123;</span><br><span class="line">            &quot;field&quot;: &quot;price&quot;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;       </span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">分组运算：avg / sum / min / max / value_count / stats(执行以上所有功能的)</span><br><span class="line">注意：这里是size=0其目的是为了不要显示hit内容，专注点放在观察分组上</span><br><span class="line"></span><br><span class="line">需求1：按照品牌分组，统计各品牌的数量</span><br><span class="line">需求2：按照品牌分组，统计各品牌的平均价格</span><br><span class="line">需求3：按照品牌分组，统计各品牌的价格数据</span><br></pre></td></tr></table></figure>
<h2 id="批处理了解"><a class="markdownIt-Anchor" href="#批处理了解">#</a> 批处理（了解）</h2>
<p>当需要集中的批量处理文档时，如果依然使用传统的操作单个 API 的方式，将会浪费大量网络资源，Elasticsearch 为了提高操作的性能，专门提供了批处理的 API</p>
<h3 id="mget批量查询"><a class="markdownIt-Anchor" href="#mget批量查询">#</a> mget 批量查询</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">语法：</span><br><span class="line">GET /索引名/类型/_mget</span><br><span class="line">&#123;</span><br><span class="line">  &quot;docs&quot;: [</span><br><span class="line">    &#123;&quot;_id&quot;: 文档ID&#125;,</span><br><span class="line">    ...</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="bulk批量增删改"><a class="markdownIt-Anchor" href="#bulk批量增删改">#</a> bulk 批量增删改</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">语法：</span><br><span class="line">POST /索引名/类型/_bulk</span><br><span class="line">&#123;动作:&#123;&quot;_id&quot;: 文档ID&#125;&#125;</span><br><span class="line">&#123;...&#125;</span><br><span class="line">&#123;动作:&#123;&quot;_id&quot;: 文档ID&#125;&#125;</span><br><span class="line">&#123;...&#125;</span><br><span class="line"></span><br><span class="line">动作：create / update / delete，其中delete只有1行JSON，其他操作都是有2行JSON，并且JSON不能格式化，如果是update动作，它的数据需要加个key为doc</span><br><span class="line">如：</span><br><span class="line">&#123;&quot;update&quot;: &#123;&quot;_id&quot;: xx&#125;&#125;</span><br><span class="line">&#123;&quot;doc&quot;: &#123;&quot;xx&quot;:xx, &quot;xx&quot;:xx&#125;&#125;</span><br></pre></td></tr></table></figure>
<h2 id="spring-data-elasticsearch"><a class="markdownIt-Anchor" href="#spring-data-elasticsearch">#</a> Spring Data Elasticsearch</h2>
<h3 id="准备环境"><a class="markdownIt-Anchor" href="#准备环境">#</a> 准备环境</h3>
<h4 id="导入依赖"><a class="markdownIt-Anchor" href="#导入依赖">#</a> 导入依赖</h4>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">&lt;parent&gt;</span><br><span class="line">    &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;spring-boot-starter-parent&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;2.1.3.RELEASE&lt;/version&gt;</span><br><span class="line">&lt;/parent&gt;</span><br><span class="line"></span><br><span class="line">&lt;properties&gt;</span><br><span class="line">    &lt;java.version&gt;1.8&lt;/java.version&gt;</span><br><span class="line">&lt;/properties&gt;</span><br><span class="line"></span><br><span class="line">&lt;dependencies&gt;</span><br><span class="line">    &lt;dependency&gt;</span><br><span class="line">        &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">        &lt;artifactId&gt;spring-boot-starter&lt;/artifactId&gt;</span><br><span class="line">    &lt;/dependency&gt;</span><br><span class="line">    </span><br><span class="line">    &lt;!--SpringBoot整合Spring Data Elasticsearch的依赖--&gt;</span><br><span class="line">    &lt;dependency&gt;</span><br><span class="line">        &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">        &lt;artifactId&gt;spring-boot-starter-data-elasticsearch&lt;/artifactId&gt;</span><br><span class="line">    &lt;/dependency&gt;</span><br><span class="line">    &lt;dependency&gt;</span><br><span class="line">        &lt;groupId&gt;org.projectlombok&lt;/groupId&gt;</span><br><span class="line">        &lt;artifactId&gt;lombok&lt;/artifactId&gt;</span><br><span class="line">    &lt;/dependency&gt;</span><br><span class="line">    &lt;dependency&gt;</span><br><span class="line">        &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">        &lt;artifactId&gt;spring-boot-starter-test&lt;/artifactId&gt;</span><br><span class="line">        &lt;scope&gt;test&lt;/scope&gt;</span><br><span class="line">    &lt;/dependency&gt;</span><br><span class="line">    </span><br><span class="line">    &lt;dependency&gt;</span><br><span class="line">        &lt;groupId&gt;commons-beanutils&lt;/groupId&gt;</span><br><span class="line">        &lt;artifactId&gt;commons-beanutils&lt;/artifactId&gt;</span><br><span class="line">        &lt;version&gt;1.8.3&lt;/version&gt;</span><br><span class="line">    &lt;/dependency&gt;</span><br><span class="line">&lt;/dependencies&gt;</span><br><span class="line"></span><br><span class="line">&lt;build&gt;</span><br><span class="line">    &lt;plugins&gt;</span><br><span class="line">        &lt;plugin&gt;</span><br><span class="line">            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;spring-boot-maven-plugin&lt;/artifactId&gt;</span><br><span class="line">        &lt;/plugin&gt;</span><br><span class="line">    &lt;/plugins&gt;</span><br><span class="line">&lt;/build&gt;</span><br></pre></td></tr></table></figure>
<h4 id="编写domain"><a class="markdownIt-Anchor" href="#编写domain">#</a> 编写 DOMAIN</h4>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line">  @Document：配置操作哪个索引下的哪个类型</span><br><span class="line">  @Id：标记文档ID字段</span><br><span class="line">  @Field：配置映射信息，如：分词器</span><br><span class="line"> */</span><br><span class="line">@Getter@Setter@ToString</span><br><span class="line">@NoArgsConstructor</span><br><span class="line">@AllArgsConstructor</span><br><span class="line">@Document(indexName=&quot;shop_product&quot;, type=&quot;shop_product&quot;)</span><br><span class="line">public class Product &#123;</span><br><span class="line">    @Id</span><br><span class="line">    private String id;</span><br><span class="line"></span><br><span class="line">    @Field(analyzer=&quot;ik_max_word&quot;,searchAnalyzer=&quot;ik_max_word&quot;, type=FieldType.Text)</span><br><span class="line">    private String title;</span><br><span class="line"></span><br><span class="line">    private Integer price;</span><br><span class="line"></span><br><span class="line">    @Field(analyzer=&quot;ik_max_word&quot;,searchAnalyzer=&quot;ik_max_word&quot;, type=FieldType.Text)</span><br><span class="line">    private String intro;</span><br><span class="line"></span><br><span class="line">    @Field(type=FieldType.Keyword)</span><br><span class="line">    private String brand;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="配置连接信息"><a class="markdownIt-Anchor" href="#配置连接信息">#</a> 配置连接信息</h4>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">#application.properties</span><br><span class="line"># 配置集群名称，名称写错会连不上服务器，默认elasticsearch</span><br><span class="line">spring.data.elasticsearch.cluster-name=elasticsearch</span><br><span class="line"># 配置集群节点</span><br><span class="line">spring.data.elasticsearch.cluster-nodes=localhost:9300</span><br></pre></td></tr></table></figure>
<h3 id="elasticsearchrepository"><a class="markdownIt-Anchor" href="#elasticsearchrepository">#</a> ElasticsearchRepository</h3>
<p>该接口是框架封装的用于操作 Elastsearch 的高级接口，只要我们自己的写个接口去继承该接口就能直接对 Elasticsearch 进行 CRUD 操作</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line">  泛型1：domain的类型</span><br><span class="line">  泛型2：文档主键类型</span><br><span class="line">  该接口直接该给Spring，底层会使用JDK代理的方式创建对象，交给容器管理</span><br><span class="line"> */</span><br><span class="line">@Repository</span><br><span class="line">public interface ProductESRepository extends ElasticsearchRepository&lt;Product, String&gt; &#123;</span><br><span class="line">    // 符合Spring Data规范的高级查询方法</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="完成crud分页排序"><a class="markdownIt-Anchor" href="#完成crud分页排序">#</a> 完成 CRUD + 分页 + 排序</h3>
<h3 id="组件介绍"><a class="markdownIt-Anchor" href="#组件介绍">#</a> 组件介绍</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">ElasticsearchRepository：框架封装的用于便捷完成常用操作的工具接口</span><br><span class="line">ElasticsearchTemplate：框架封装的用于便捷操作Elasticsearch的模板类</span><br><span class="line"></span><br><span class="line">NativeSearchQueryBuilder：用于生成查询条件的构建器，需要去封装各种查询条件</span><br><span class="line">QueryBuilder：该接口表示一个查询条件，其对象可以通过QueryBuilders工具类中的方法快速生成各种条件</span><br><span class="line">  boolQuery()：生成bool条件，相当于 &quot;bool&quot;: &#123; &#125;</span><br><span class="line">  matchQuery()：生成match条件，相当于 &quot;match&quot;: &#123; &#125;</span><br><span class="line">  rangeQuery()：生成range条件，相当于 &quot;range&quot;: &#123; &#125;</span><br><span class="line">AbstractAggregationBuilder：用于生成分组查询的构建器，其对象通过AggregationBuilders工具类生成</span><br><span class="line">Pageable：表示分页参数，对象通过PageRequest.of(页数, 容量)获取</span><br><span class="line">SortBuilder：排序构建器，对象通过SortBuilders.fieldSort(字段).order(规则)获取</span><br></pre></td></tr></table></figure>
<h3 id="elasticsearchtemplate"><a class="markdownIt-Anchor" href="#elasticsearchtemplate">#</a> ElasticsearchTemplate</h3>
<p>该模板类，封装了便捷操作 Elasticsearch 的模板方法，包括 索引 / 映射 / CRUD 等底层操作和高级操作，该对象用起来会略微复杂些，尤其是对于查询，还需要把查询到的结果自己封装对象</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">//该对象已经由SpringBoot完成自动配置，直接注入即可</span><br><span class="line">@Autowired</span><br><span class="line">private ElasticsearchTemplate template;</span><br></pre></td></tr></table></figure>
<p>一般情况下，ElasticsearchTemplate 和 ElasticsearchRepository 是分工合作的，ElasticsearchRepository 已经能完成绝大部分的功能，如果遇到复杂的查询则要使用 ElasticsearchTemplate，如多字段分组、高亮显示等</p>
<h3 id="实例代码"><a class="markdownIt-Anchor" href="#实例代码">#</a> 实例代码</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br></pre></td><td class="code"><pre><span class="line">@Autowired</span><br><span class="line">private ElasticsearchTemplate template;</span><br><span class="line"></span><br><span class="line">@Autowired</span><br><span class="line">private ProductESRepository repository;</span><br><span class="line"></span><br><span class="line">// 新增或者覆盖一个文档</span><br><span class="line">@Test</span><br><span class="line">public void testSaveOrUpdate() throws Exception &#123;</span><br><span class="line">    // 索引库中不存在则新增，存在则覆盖</span><br><span class="line">    Product p = new Product(&quot;13&quot;, &quot;华为手环 B5（Android 运动手环）&quot;, 999,</span><br><span class="line">                            &quot;高清彩屏 腕上蓝牙耳机 心率检测 来电消息提醒&quot;, &quot;华为&quot;);</span><br><span class="line">    repostitory.save(p);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 删除一个文档</span><br><span class="line">@Test</span><br><span class="line">public void testDelete() throws Exception &#123;</span><br><span class="line">    repostitory.deleteById(&quot;13&quot;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 根据ID查询一个文档</span><br><span class="line">@Test</span><br><span class="line">public void testGet() throws Exception &#123;</span><br><span class="line">    Optional&lt;Product&gt; optional = repostitory.findById(&quot;1&quot;);</span><br><span class="line">    optional.ifPresent(System.out::println);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 查询所有文档</span><br><span class="line">@Test</span><br><span class="line">public void testList() throws Exception &#123;</span><br><span class="line">    Iterable&lt;Product&gt; iter = repostitory.findAll();</span><br><span class="line">    iter.forEach(System.out::println);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 分页查询文档按照价格降序排列，显示第2页，每页显示3个</span><br><span class="line">@Test</span><br><span class="line">public void testQuery1() throws Exception &#123;</span><br><span class="line">    NativeSearchQueryBuilder builder = new NativeSearchQueryBuilder();</span><br><span class="line">    // 设置分页信息</span><br><span class="line">    builder.withPageable(PageRequest.of(1, 3));</span><br><span class="line">    // 设置排序信息</span><br><span class="line">    builder.withSort(SortBuilders.fieldSort(&quot;price&quot;).order(SortOrder.DESC));</span><br><span class="line"></span><br><span class="line">    Page&lt;Product&gt; page = repostitory.search(builder.build());</span><br><span class="line">    System.out.println(page.getTotalElements()); //总记录数</span><br><span class="line">    System.out.println(page.getTotalPages()); //总页数</span><br><span class="line">    page.forEach(System.out::println);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 查询商品标题中符合&quot;游戏 手机&quot;的字样的商品</span><br><span class="line">@Test</span><br><span class="line">public void testQuery2() throws Exception &#123;</span><br><span class="line">    NativeSearchQueryBuilder builder = new NativeSearchQueryBuilder();</span><br><span class="line">    builder.withQuery(</span><br><span class="line">        QueryBuilders.matchQuery(&quot;title&quot;, &quot;游戏 手机&quot;)</span><br><span class="line">    );</span><br><span class="line">    Page&lt;Product&gt; page = repostitory.search(builder.build());</span><br><span class="line">    page.forEach(System.out::println);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 查询商品价格等于15299的商品</span><br><span class="line">@Test</span><br><span class="line">public void testQuery3() throws Exception &#123;</span><br><span class="line">    NativeSearchQueryBuilder builder = new NativeSearchQueryBuilder();</span><br><span class="line">    builder.withQuery(</span><br><span class="line">        QueryBuilders.termQuery(&quot;price&quot;, 15299)</span><br><span class="line">    );</span><br><span class="line">    Page&lt;Product&gt; page = repostitory.search(builder.build());</span><br><span class="line">    page.forEach(System.out::println);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 查询商品价格在5000~9000之间商品，按照价格升序排列</span><br><span class="line">@Test</span><br><span class="line">public void testQuery4() throws Exception &#123;</span><br><span class="line">    NativeSearchQueryBuilder builder = new NativeSearchQueryBuilder();</span><br><span class="line">    builder.withQuery(</span><br><span class="line">        QueryBuilders.rangeQuery(&quot;price&quot;)</span><br><span class="line">            .gte(5000).lte(9000)</span><br><span class="line">    );</span><br><span class="line">    builder.withSort(SortBuilders.fieldSort(&quot;price&quot;).order(SortOrder.ASC));</span><br><span class="line">    Page&lt;Product&gt; page = repostitory.search(builder.build());</span><br><span class="line">    page.forEach(System.out::println);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 查询商品标题或简介中符合&quot;蓝牙 指纹 双卡&quot;的字样的商品</span><br><span class="line">@Test</span><br><span class="line">public void testQuery5() throws Exception &#123;</span><br><span class="line">    NativeSearchQueryBuilder builder = new NativeSearchQueryBuilder();</span><br><span class="line">    builder.withQuery(</span><br><span class="line">        QueryBuilders.multiMatchQuery(&quot;蓝牙 指纹 双卡&quot;,</span><br><span class="line">                                      &quot;title&quot;, &quot;intro&quot;)</span><br><span class="line">    );</span><br><span class="line">    Page&lt;Product&gt; page = repostitory.search(builder.build());</span><br><span class="line">    page.forEach(System.out::println);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 查询商品标题中符合&quot;i7&quot;的字样并且价格大于7000的商品</span><br><span class="line">@Test</span><br><span class="line">public void testQuery6() throws Exception &#123;</span><br><span class="line">    NativeSearchQueryBuilder builder = new NativeSearchQueryBuilder();</span><br><span class="line">    builder.withQuery(</span><br><span class="line">        QueryBuilders.boolQuery()</span><br><span class="line">        .must(QueryBuilders.matchQuery(&quot;title&quot;, &quot;i7&quot;))</span><br><span class="line">        .must(QueryBuilders.rangeQuery(&quot;price&quot;).gt(7000))</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    Page&lt;Product&gt; page = repostitory.search(builder.build());</span><br><span class="line">    page.forEach(System.out::println);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 查询商品标题中符合&quot;pro&quot;的字样或者价格在1000~3000的商品</span><br><span class="line">@Test</span><br><span class="line">public void testQuery7() throws Exception &#123;</span><br><span class="line">    NativeSearchQueryBuilder builder = new NativeSearchQueryBuilder();</span><br><span class="line">    builder.withQuery(</span><br><span class="line">        QueryBuilders.boolQuery()</span><br><span class="line">            .should(QueryBuilders.matchQuery(&quot;title&quot;, &quot;pro&quot;))</span><br><span class="line">            .should(QueryBuilders.rangeQuery(&quot;price&quot;).gte(1000).lte(3000))</span><br><span class="line">    );</span><br><span class="line">    Page&lt;Product&gt; page = repostitory.search(builder.build());</span><br><span class="line">    page.forEach(System.out::println);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 按照品牌分组，统计各品牌的数量</span><br><span class="line">@Test</span><br><span class="line">public void testQuery8() throws Exception &#123;</span><br><span class="line">    NativeSearchQueryBuilder builder = new NativeSearchQueryBuilder();</span><br><span class="line">    builder.addAggregation(</span><br><span class="line">        AggregationBuilders.terms(&quot;groupByBrand&quot;).field(&quot;brand&quot;)</span><br><span class="line">    );</span><br><span class="line">    AggregatedPage&lt;Product&gt; page = (AggregatedPage&lt;Product&gt;) repostitory.search(builder.build());</span><br><span class="line">    // 获取自定义的分组字段</span><br><span class="line">    StringTerms brand = (StringTerms) page.getAggregation(&quot;groupByBrand&quot;);</span><br><span class="line">    brand.getBuckets().forEach(bucket -&gt; System.out.println(bucket.getDocCount()));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 按照品牌分组，统计各品牌的平均价格</span><br><span class="line">@Test</span><br><span class="line">public void testQuery9() throws Exception &#123;</span><br><span class="line">    NativeSearchQueryBuilder builder = new NativeSearchQueryBuilder();</span><br><span class="line">    builder.addAggregation(</span><br><span class="line">        AggregationBuilders.terms(&quot;groupByBrand&quot;).field(&quot;brand&quot;)</span><br><span class="line">        .subAggregation(AggregationBuilders.avg(&quot;avgPrice&quot;).field(&quot;price&quot;))</span><br><span class="line">    );</span><br><span class="line">    AggregatedPage&lt;Product&gt; page = (AggregatedPage&lt;Product&gt;) repostitory.search(builder.build());</span><br><span class="line">    // 获取自定义的分组字段</span><br><span class="line">    StringTerms brand = (StringTerms) page.getAggregation(&quot;groupByBrand&quot;);</span><br><span class="line">    brand.getBuckets().forEach(bucket -&gt; &#123;</span><br><span class="line">        InternalAvg avgPrice = bucket.getAggregations().get(&quot;avgPrice&quot;);</span><br><span class="line">        System.out.println(avgPrice.getValue());</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 按照品牌分组，统计各品牌的价格数据</span><br><span class="line">@Test</span><br><span class="line">public void testQuery10() throws Exception &#123;</span><br><span class="line">    NativeSearchQueryBuilder builder = new NativeSearchQueryBuilder();</span><br><span class="line">    builder.addAggregation(</span><br><span class="line">        AggregationBuilders.terms(&quot;groupByBrand&quot;).field(&quot;brand&quot;)</span><br><span class="line">        .subAggregation(AggregationBuilders.stats(&quot;statsPrice&quot;).field(&quot;price&quot;))</span><br><span class="line">    );</span><br><span class="line">    AggregatedPage&lt;Product&gt; page = (AggregatedPage&lt;Product&gt;) repostitory.search(builder.build());</span><br><span class="line">    // 获取自定义的分组字段</span><br><span class="line">    StringTerms brand = (StringTerms) page.getAggregation(&quot;groupByBrand&quot;);</span><br><span class="line">    brand.getBuckets().forEach(bucket -&gt; &#123;</span><br><span class="line">        InternalStats statsPrice = bucket.getAggregations().get(&quot;statsPrice&quot;);</span><br><span class="line">        System.out.println(statsPrice.getSumAsString());</span><br><span class="line">        System.out.println(statsPrice.getAvgAsString());</span><br><span class="line">        System.out.println(statsPrice.getMaxAsString());</span><br><span class="line">        System.out.println(statsPrice.getMinAsString());</span><br><span class="line">        System.out.println(statsPrice.getCount());</span><br><span class="line">        System.out.println(&quot;-----------------------&quot;);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 查询商品标题或简介中符合&quot;蓝牙 指纹 双卡&quot;的字样的商品，并且高亮显示</span><br><span class="line">@Test</span><br><span class="line">public void testHighlight() throws Exception &#123;</span><br><span class="line">    // Java与JSON互转的工具对象</span><br><span class="line">    ObjectMapper mapper = new ObjectMapper();</span><br><span class="line"></span><br><span class="line">    NativeSearchQueryBuilder builder = new NativeSearchQueryBuilder();</span><br><span class="line">    // 设置查询哪个索引中的哪个类型</span><br><span class="line">    builder.withIndices(&quot;shop_product&quot;).withTypes(&quot;shop_product&quot;);</span><br><span class="line">    builder.withQuery(</span><br><span class="line">        QueryBuilders.multiMatchQuery(&quot;蓝牙 指纹 双卡&quot;,</span><br><span class="line">                                      &quot;title&quot;, &quot;intro&quot;)</span><br><span class="line">    );</span><br><span class="line">    builder.withHighlightFields(</span><br><span class="line">        new HighlightBuilder.Field(&quot;title&quot;)</span><br><span class="line">            .preTags(&quot;&lt;span style=&#x27;color:red&#x27;&gt;&quot;).postTags(&quot;&lt;/span&gt;&quot;),</span><br><span class="line">        new HighlightBuilder.Field(&quot;intro&quot;)</span><br><span class="line">            .preTags(&quot;&lt;span style=&#x27;color:red&#x27;&gt;&quot;).postTags(&quot;&lt;/span&gt;&quot;)</span><br><span class="line">    );</span><br><span class="line">    AggregatedPage&lt;Product&gt; page = template.queryForPage(builder.build(), Product.class, new SearchResultMapper() &#123;</span><br><span class="line">        public &lt;T&gt; AggregatedPage&lt;T&gt; mapResults(SearchResponse resp, Class&lt;T&gt; clazz, Pageable pageable) &#123;</span><br><span class="line">            List&lt;T&gt; list = new ArrayList&lt;&gt;();</span><br><span class="line">            try &#123;</span><br><span class="line">                for (SearchHit hit : resp.getHits().getHits()) &#123;</span><br><span class="line">                    // 把查询到的JSON字符串转换成Java对象</span><br><span class="line">                    T t = mapper.readValue(hit.getSourceAsString(), clazz);</span><br><span class="line">                    for (HighlightField field : hit.getHighlightFields().values()) &#123;</span><br><span class="line">                        // 替换需要高亮显示的字段，用到Apache的BeanUtils工具</span><br><span class="line">                        BeanUtils.setProperty(t, field.getName(), field.getFragments()[0].string());</span><br><span class="line">                    &#125;</span><br><span class="line">                    list.add(t);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; catch (Exception e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">                return null;</span><br><span class="line">            &#125;</span><br><span class="line">            long total = resp.getHits().totalHits;</span><br><span class="line">            return new AggregatedPageImpl&lt;&gt;(list, pageable, total);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    page.forEach(System.out::println);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="springboot23x以上配置"><a class="markdownIt-Anchor" href="#springboot23x以上配置">#</a> springboot2.3.x 以上配置</h3>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://docs.spring.io/spring-data/elasticsearch/docs/4.0.1.RELEASE/reference/html/#new-features">配置关系对应</a></p>
<p><img src="https://images-jsh.oss-cn-beijing.aliyuncs.com/img/%E6%88%AA%E5%B1%8F2021-08-14%2014.17.14.png" alt="截屏2021-08-14 14.17.14"></p>
</blockquote>
<ol>
<li>
<p>pom 相同</p>
</li>
<li>
<p>配置</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">## 旧版本以spring.data.elasticsearch.开头;访问地址配置不用声明访问协议,监听es的tcp端口</span><br><span class="line">#spring.data.elasticsearch.cluster-nodes=localhost:9300</span><br><span class="line">#spring.data.elasticsearch.cluster-name=elasticsearch</span><br><span class="line"></span><br><span class="line">## 新版本以spring.elasticsearch.rest.开头;访问地址配置需要声明访问协议,直接监听es访问端口</span><br><span class="line">spring.elasticsearch.rest.uris=http://localhost:9200</span><br><span class="line">spring.elasticsearch.rest.username=elasticsearch</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>使用</p>
<ul>
<li>
<p>旧版的核心访问对象是 ElasticsearchTemplate；新版的核心访问对象是 ElasticsearchRestTemplate；</p>
</li>
<li>
<p>实体类没有类型</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">// @Document指定当前类是索引对象。indexName:索引名称;shards:创建索引时的分片数;replicas:创建索引时的备份数</span><br><span class="line">@Document(indexName = &quot;book_&quot;, shards = 5, replicas = 1)</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
</ol>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2022-12-27T08:18:48.552Z" title="2022-12-27 16:18:48">2022-12-27</time>发表</span><span class="level-item"><time dateTime="2023-02-10T06:15:39.398Z" title="2023-2-10 14:15:39">2023-02-10</time>更新</span><span class="level-item">4 分钟读完 (大约544个字)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2022/12/27/%E3%80%90RocketMQ%E3%80%91docker%E7%AE%80%E5%8D%95%E9%83%A8%E7%BD%B2rocketMQ/">docker简单部署rocketMQ</a></p><div class="content"><h1 id="docker简单部署rocketmq"><a class="markdownIt-Anchor" href="#docker简单部署rocketmq">#</a> docker 简单部署 rocketMQ</h1>
<p>1. 创建 namesrv 服务<br>
拉取镜像</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker pull rocketmqinc/rocketmq</span><br></pre></td></tr></table></figure>
<h3 id="创建namesrv数据存储路径"><a class="markdownIt-Anchor" href="#创建namesrv数据存储路径">#</a> 创建 namesrv 数据存储路径</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p  /docker/rocketmq/data/namesrv/logs   /docker/rocketmq/data/namesrv/store</span><br></pre></td></tr></table></figure>
<h3 id="构建namesrv容器"><a class="markdownIt-Anchor" href="#构建namesrv容器">#</a> 构建 namesrv 容器</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">docker run -d \</span><br><span class="line">--restart=always \</span><br><span class="line">--name rmqnamesrv \</span><br><span class="line">-p 9876:9876 \</span><br><span class="line">-v /docker/rocketmq/data/namesrv/logs:/root/logs \</span><br><span class="line">-v /docker/rocketmq/data/namesrv/store:/root/store \</span><br><span class="line">-e &quot;MAX_POSSIBLE_HEAP=100000000&quot; \</span><br><span class="line">rocketmqinc/rocketmq \</span><br><span class="line">sh mqnamesrv </span><br></pre></td></tr></table></figure>
<h1 id="2创建broker节点"><a class="markdownIt-Anchor" href="#2创建broker节点">#</a> 2. 创建 broker 节点</h1>
<h2 id="创建broker数据存储路径"><a class="markdownIt-Anchor" href="#创建broker数据存储路径">#</a> 创建 broker 数据存储路径</h2>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> -p  /docker/rocketmq/data/broker/logs   /docker/rocketmq/data/broker/store /docker/rocketmq/conf</span><br></pre></td></tr></table></figure>
<h2 id="创建配置文件"><a class="markdownIt-Anchor" href="#创建配置文件">#</a> 创建配置文件</h2>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">vi /docker/rocketmq/conf/broker.conf</span><br><span class="line"># 所属集群名称，如果节点较多可以配置多个</span><br><span class="line">brokerClusterName = DefaultCluster</span><br><span class="line">#broker名称，master和slave使用相同的名称，表明他们的主从关系</span><br><span class="line">brokerName = broker-a</span><br><span class="line">#0表示Master，大于0表示不同的slave</span><br><span class="line">brokerId = 0</span><br><span class="line">#表示几点做消息删除动作，默认是凌晨4点</span><br><span class="line">deleteWhen = 04</span><br><span class="line">#在磁盘上保留消息的时长，单位是小时</span><br><span class="line">fileReservedTime = 48</span><br><span class="line">#有三个值：SYNC_MASTER，ASYNC_MASTER，SLAVE；同步和异步表示Master和Slave之间同步数据的机制；</span><br><span class="line">brokerRole = ASYNC_MASTER</span><br><span class="line">#刷盘策略，取值为：ASYNC_FLUSH，SYNC_FLUSH表示同步刷盘和异步刷盘；SYNC_FLUSH消息写入磁盘后才返回成功状态，ASYNC_FLUSH不需要；</span><br><span class="line">flushDiskType = ASYNC_FLUSH</span><br><span class="line"># 磁盘使用达到95%之后,生产者再写入消息会报错 CODE: 14 DESC: service not available now, maybe disk full</span><br><span class="line">diskMaxUsedSpaceRatio=95</span><br><span class="line"></span><br><span class="line">namesrvAddr=【IP】:9876</span><br><span class="line">brokerIP1 = 【IP】</span><br></pre></td></tr></table></figure>
<h2 id="构建broker容器"><a class="markdownIt-Anchor" href="#构建broker容器">#</a> 构建 broker 容器</h2>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">docker run -d  \</span><br><span class="line">--restart=always \</span><br><span class="line">--name rmqbroker \</span><br><span class="line">--link rmqnamesrv:namesrv \</span><br><span class="line">-p 10911:10911 \</span><br><span class="line">-p 10912:10912 \</span><br><span class="line">-p 10909:10909 \</span><br><span class="line">-v  /docker/rocketmq/data/broker/logs:/root/logs \</span><br><span class="line">-v  /docker/rocketmq/data/broker/store:/root/store \</span><br><span class="line">-v /docker/rocketmq/conf/broker.conf:/opt/rocketmq-4.4.0/conf/broker.conf \</span><br><span class="line">-e &quot;NAMESRV_ADDR= 【你的IP地址】:9876&quot; \</span><br><span class="line">-e &quot;MAX_POSSIBLE_HEAP=200000000&quot; \</span><br><span class="line">rocketmqinc/rocketmq \</span><br><span class="line">sh mqbroker -c /opt/rocketmq-4.4.0/conf/broker.conf  </span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h1 id="3创建rockermq-console服务"><a class="markdownIt-Anchor" href="#3创建rockermq-console服务">#</a> 3. 创建 rockermq-console 服务</h1>
<h2 id="拉取镜像"><a class="markdownIt-Anchor" href="#拉取镜像">#</a> 拉取镜像</h2>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker pull pangliang/rocketmq-console-ng</span><br></pre></td></tr></table></figure>
<h2 id="构建rockermq-console容器"><a class="markdownIt-Anchor" href="#构建rockermq-console容器">#</a> 构建 rockermq-console 容器</h2>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">docker run -d \</span><br><span class="line">--restart=always \</span><br><span class="line">--name rmqadmin \</span><br><span class="line">-e &quot;JAVA_OPTS=-Drocketmq.namesrv.addr=【你的IP地址】:9876 \</span><br><span class="line">-Dcom.rocketmq.sendMessageWithVIPChannel=false&quot; \</span><br><span class="line">-p 9877:8080 \</span><br><span class="line">pangliang/rocketmq-console-ng</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="关闭防火墙"><a class="markdownIt-Anchor" href="#关闭防火墙">#</a> 关闭防火墙</h3>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl stop firewalld.service</span><br></pre></td></tr></table></figure>
<h3 id="开放指定端口"><a class="markdownIt-Anchor" href="#开放指定端口">#</a> 开放指定端口</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">firewall-cmd --permanent --zone=public --add-port=9876/tcp</span><br><span class="line">firewall-cmd --permanent --zone=public --add-port=10911/tcp</span><br><span class="line">firewall-cmd --permanent --zone=public --add-port=10912/tcp</span><br><span class="line"># 立即生效</span><br><span class="line">firewall-cmd --reload</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="访问控制台"><a class="markdownIt-Anchor" href="#访问控制台">#</a> 访问控制台</h2>
<p>网页访问 http://【IP】:9999 / 查看控制台信息</p>
<p><img src="https://brath.cloud/blogImg/20201013235856206.png" alt="在这里插入图片描述"></p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2022-12-27T08:18:48.550Z" title="2022-12-27 16:18:48">2022-12-27</time>发表</span><span class="level-item"><time dateTime="2011-07-13T02:16:27.913Z" title="2011-7-13 10:16:27">2011-07-13</time>更新</span><span class="level-item">1 分钟读完 (大约157个字)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2022/12/27/%E3%80%90Docker%E3%80%91Docker%E7%8E%AF%E5%A2%83%E9%83%A8%E7%BD%B2Reids%E9%95%9C%E5%83%8F%E4%BD%9C%E4%B8%BA%E4%BB%8E%E8%8A%82%E7%82%B9/">Docker环境部署Reids镜像作为从节点</a></p><div class="content"><h2 id="docker环境部署reids镜像作为从节点"><a class="markdownIt-Anchor" href="#docker环境部署reids镜像作为从节点">#</a> Docker 环境部署 Reids 镜像作为从节点</h2>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"># 拉取镜像</span><br><span class="line">docker pull redis</span><br><span class="line"></span><br><span class="line"># 配置文件</span><br><span class="line">本地：/mydata/redis/data/redis.conf 提前准备好</span><br><span class="line">主要配置</span><br><span class="line">bind 127.0.0.1 #注释掉这部分，使redis可以外部访问</span><br><span class="line">daemonize no#用守护线程的方式启动</span><br><span class="line">requirepass 你的密码#给redis设置密码</span><br><span class="line">appendonly yes#redis持久化　　默认是no</span><br><span class="line">tcp-keepalive 300 #防止出现远程主机强迫关闭了一个现有的连接的错误 默认是300</span><br><span class="line"></span><br><span class="line"># 创建实例并启动</span><br><span class="line">docker run -p 6380:6379 --name redis -v /mydata/redis/data/redis.conf:/etc/redis/redis.conf  -v /mydata/redis/data:/data -d redis redis-server /etc/redis/redis.conf --appendonly yes</span><br></pre></td></tr></table></figure></div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2022-12-27T08:18:48.548Z" title="2022-12-27 16:18:48">2022-12-27</time>发表</span><span class="level-item"><time dateTime="2022-07-12T07:37:18.955Z" title="2022-7-12 15:37:18">2022-07-12</time>更新</span><span class="level-item">几秒读完 (大约99个字)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2022/12/27/%E3%80%90Docker%E3%80%91Docker%E7%8E%AF%E5%A2%83%E4%B8%8B%E5%AE%89%E8%A3%85vim/">Docker环境下安装vim</a></p><div class="content"><h2 id="docker环境下安装vim"><a class="markdownIt-Anchor" href="#docker环境下安装vim">#</a> Docker 环境下安装 vim</h2>
<p>在使用 docker 容器时，容器一般没有安装 vim，就需要安装 vim<br>
apt-get install vim 命令用于安装 vim，但是下载过慢。<br>
第一步 配置国内镜像源<br>
进入某个容器</p>
<p>例如进入 mysql</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker exec -it mysql /bin/bash</span><br></pre></td></tr></table></figure>
<p>第二步：更新源</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">apt update</span><br></pre></td></tr></table></figure>
<p>第三步安装 vim</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">apt-get install vim</span><br></pre></td></tr></table></figure></div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2022-12-27T08:18:48.546Z" title="2022-12-27 16:18:48">2022-12-27</time>发表</span><span class="level-item"><time dateTime="2022-09-29T01:42:32.138Z" title="2022-9-29 9:42:32">2022-09-29</time>更新</span><span class="level-item">11 分钟读完 (大约1579个字)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2022/12/27/%E3%80%90Java%E3%80%91CompletableFuture%E4%BD%BF%E7%94%A8%E6%96%87%E6%A1%A3/">CompletableFuture使用文档</a></p><div class="content"><p>背景：<br>
CompletableFuture 字面翻译过来，就是 “可完成的 Future”。同传统的 Future 相比较，CompletableFuture 能够主动设置计算的结果值（主动终结计算过程，即 completable），从而在某些场景下主动结束阻塞等待。而 Future 由于不能主动设置计算结果值，一旦调用 get () 进行阻塞等待，要么当计算结果产生，要么超时，才会返回。</p>
<p>CompletableFuture 说白了其实就是为了解决 Future 的问题（阻塞），而生！！！</p>
<p>下面总结 CompletableFuture 的常用 api</p>
<ol>
<li>
<p>创建 CompletableFuture<br>
 实例方法：</p>
<pre><code>//实例方法
CompletableFuture&lt;String&gt; completableFutureOne = new CompletableFuture&lt;&gt;();
Supplier&lt;?&gt; task=new Supplier&lt;Object&gt;() &#123;
    @Override
    public Object get() &#123;
        return null;
    &#125;
&#125;;
CompletableFuture&lt;?&gt; completableFuture = completableFutureOne.supplyAsync(task);
</code></pre>
</li>
</ol>
<p>静态方法：</p>
<p>public static void main(String[] args) throws ExecutionException, InterruptedException {<br>
Runnable runnable = () -&gt;<br>
System.out.println (“执行无返回结果的异步任务”);<br>
System.out.println(CompletableFuture.runAsync(runnable).get());</p>
<pre><code>      CompletableFuture&lt;String&gt; future = CompletableFuture.supplyAsync(() -&gt; &#123;
          System.out.println(&quot;执行有返回值的异步任务&quot;);
          return &quot;Hello World&quot;;
      &#125;);
      String result = future.get();
      System.out.println(result);
  &#125;
</code></pre>
<h2 id="2-whencomplete-第一个任务结束对其结果处理handly的作用一样"><a class="markdownIt-Anchor" href="#2-whencomplete-第一个任务结束对其结果处理handly的作用一样">#</a> 2、whenComplete - 第一个任务结束，对其结果处理 (handly 的作用一样)</h2>
<p>结果处理就是当 future 任务完成时，对任务的结果做处理工作！或异常情况处理！</p>
  <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">public static void main(String[] args) throws ExecutionException, InterruptedException &#123;</span><br><span class="line">        CompletableFuture&lt;Integer&gt; future = CompletableFuture.supplyAsync(() -&gt; &#123;</span><br><span class="line">            try &#123;</span><br><span class="line">                TimeUnit.SECONDS.sleep(1);</span><br><span class="line">            &#125; catch (InterruptedException e) &#123;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">            System.out.println(&quot;执行结束1！&quot;);</span><br><span class="line">            return 5;</span><br><span class="line">        &#125;);</span><br><span class="line">        future.whenComplete(new BiConsumer&lt;Integer, Throwable&gt;() &#123;</span><br><span class="line">            @Override</span><br><span class="line">            public void accept(Integer t, Throwable action) &#123;</span><br><span class="line">                t=t+1;</span><br><span class="line">//                int i = 12 / 0;</span><br><span class="line">                System.out.println(&quot;执行完成2！&quot;+action.getMessage());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">        .exceptionally(new Function&lt;Throwable, Integer&gt;() &#123;</span><br><span class="line">            @Override</span><br><span class="line">            public Integer apply(Throwable t) &#123;</span><br><span class="line">                System.out.println(&quot;执行失败3：&quot; + t.getMessage());</span><br><span class="line">                return null;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;).join();</span><br><span class="line">        Integer integer = future.get();</span><br><span class="line">        System.out.println(&quot;=&gt;integer&quot;+integer);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>1、whenComplete 只是对任务运行结束后，拿到任务结果，做个处理，并且如果任务执行有异常，会监听到异常！<br>
2、如果 whenComplete 本身有异常，那么需要单独加 exceptionally 来监听异常！<br>
3、最终 future.get () 拿到的还是任务 1 的结果<br>
 4、如果任务有异常，future.get () 拿到会抛出异常！</p>
  <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">执行结束1！</span><br><span class="line">执行失败3：java.lang.ArithmeticException: / by zero</span><br><span class="line">Exception in thread &quot;main&quot; java.util.concurrent.ExecutionException: java.lang.ArithmeticException: / by zero</span><br><span class="line">	at java.util.concurrent.CompletableFuture.reportGet(CompletableFuture.java:357)</span><br><span class="line">	at java.util.concurrent.CompletableFuture.get(CompletableFuture.java:1895)</span><br><span class="line">	at top.lisicheng.wmd.CompleableFutureTest2.main(CompleableFutureTest2.java:83)</span><br><span class="line">Caused by: java.lang.ArithmeticException: / by zero</span><br><span class="line">	at top.lisicheng.wmd.CompleableFutureTest2.lambda$main$0(CompleableFutureTest2.java:65)</span><br><span class="line">	at java.util.concurrent.CompletableFuture$AsyncSupply.run$$$capture(CompletableFuture.java:1590)</span><br><span class="line">	at java.util.concurrent.CompletableFuture$AsyncSupply.run(CompletableFuture.java)</span><br><span class="line">	at java.util.concurrent.CompletableFuture$AsyncSupply.exec(CompletableFuture.java:1582)</span><br><span class="line">	at java.util.concurrent.ForkJoinTask.doExec(ForkJoinTask.java:289)</span><br><span class="line">	at java.util.concurrent.ForkJoinPool$WorkQueue.runTask(ForkJoinPool.java:1056)</span><br><span class="line">	at java.util.concurrent.ForkJoinPool.runWorker(ForkJoinPool.java:1692)</span><br><span class="line">	at java.util.concurrent.ForkJoinWorkerThread.run(ForkJoinWorkerThread.java:157)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="3-thenapply-第一个任务结束可能还有第二-第三个任务且后面一个任务需要用到前面任务的返回值"><a class="markdownIt-Anchor" href="#3-thenapply-第一个任务结束可能还有第二-第三个任务且后面一个任务需要用到前面任务的返回值">#</a> 3、thenApply - 第一个任务结束，可能还有第二、第三个任务，且后面一个任务，需要用到前面任务的返回值</h2>
  <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">public static void test4(String[] args) throws ExecutionException, InterruptedException &#123;</span><br><span class="line">        /**</span><br><span class="line">         * public &lt;U&gt; CompletableFuture&lt;U&gt; thenApply(Function&lt;? super T,? extends U&gt; fn)</span><br><span class="line">         * public &lt;U&gt; CompletableFuture&lt;U&gt; thenApplyAsync(Function&lt;? super T,? extends U&gt; fn)</span><br><span class="line">         * public &lt;U&gt; CompletableFuture&lt;U&gt; thenApplyAsync(Function&lt;? super T,? extends U&gt; fn, Executor executor)</span><br><span class="line">         *  总结：thenApply 接收一个函数作为参数，使用该函数处理上一个CompletableFuture 调用的结果，</span><br><span class="line">         *  并返回一个具有处理结果的Future对象。</span><br><span class="line">         *</span><br><span class="line">         */</span><br><span class="line">        CompletableFuture&lt;Integer&gt; future = CompletableFuture.supplyAsync(() -&gt; &#123;</span><br><span class="line">            int result = 100;</span><br><span class="line">            System.out.println(&quot;一阶段：&quot; + result);</span><br><span class="line">            return result;</span><br><span class="line">        &#125;).thenApply(number -&gt; &#123;</span><br><span class="line">            int result = number * 3;</span><br><span class="line">            System.out.println(&quot;二阶段：&quot; + result);</span><br><span class="line">            return result;</span><br><span class="line">        &#125;).thenApply(number -&gt; &#123;</span><br><span class="line">            int result = number * 3;</span><br><span class="line">            System.out.println(&quot;三阶段：&quot; + result);</span><br><span class="line">            return result;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        System.out.println(&quot;最终结果：&quot; + future.get());</span><br><span class="line"></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h2 id="4-thencompose-跟上面一样的作用"><a class="markdownIt-Anchor" href="#4-thencompose-跟上面一样的作用">#</a> 4、thenCompose - 跟上面一样的作用：</h2>
<p>thenCompose 的参数为一个返回 CompletableFuture 实例的函数，该函数的参数是先前计算步骤的结果。</p>
  <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">public &lt;U&gt; CompletableFuture&lt;U&gt; thenCompose(Function&lt;? super T, ? extends CompletionStage&lt;U&gt;&gt; fn);</span><br><span class="line">public &lt;U&gt; CompletableFuture&lt;U&gt; thenComposeAsync(Function&lt;? super T, ? extends CompletionStage&lt;U&gt;&gt; fn) ;</span><br><span class="line">public &lt;U&gt; CompletableFuture&lt;U&gt; thenComposeAsync(Function&lt;? super T, ? extends CompletionStage&lt;U&gt;&gt; fn, Executor executor) ;</span><br></pre></td></tr></table></figure>
  <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line">public static void main(String[] args) throws InterruptedException, ExecutionException &#123;</span><br><span class="line">    CompletableFuture&lt;Integer&gt; future = CompletableFuture.supplyAsync(new Supplier&lt;Integer&gt;() &#123;</span><br><span class="line">        @Override</span><br><span class="line">        public Integer get() &#123;</span><br><span class="line">            int number = new Random().nextInt(3);</span><br><span class="line">            System.out.println(&quot;第一阶段：&quot; + number);</span><br><span class="line">            return number;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;).thenCompose(new Function&lt;Integer, CompletionStage&lt;Integer&gt;&gt;() &#123;</span><br><span class="line">        @Override</span><br><span class="line">        public CompletionStage&lt;Integer&gt; apply(Integer param) &#123;</span><br><span class="line">            return CompletableFuture.supplyAsync(new Supplier&lt;Integer&gt;() &#123;</span><br><span class="line">                @Override</span><br><span class="line">                public Integer get() &#123;</span><br><span class="line">                    int number = param * 2;</span><br><span class="line">                    System.out.println(&quot;第二阶段：&quot; + number);</span><br><span class="line">                    return number;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    System.out.println(&quot;最终结果: &quot; + future.get());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
  <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">那么 thenApply 和 thenCompose 有何区别呢：</span><br><span class="line"></span><br><span class="line">thenApply 转换的是泛型中的类型，返回的是同一个CompletableFuture；</span><br><span class="line">thenCompose 将内部的 CompletableFuture 调用展开来并使用上一个CompletableFutre 调用的结果在下一步的 CompletableFuture 调用中进行运算，</span><br><span class="line">是生成一个新的CompletableFuture。</span><br></pre></td></tr></table></figure>
<p><strong>下面用一个例子对对比：</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">public static void main(String[] args) throws InterruptedException, ExecutionException &#123;</span><br><span class="line">    CompletableFuture&lt;String&gt; future = CompletableFuture.supplyAsync(() -&gt; &quot;Hello&quot;);</span><br><span class="line"></span><br><span class="line">    CompletableFuture&lt;String&gt; result1 = future.thenApply(param -&gt; param + &quot; World&quot;);</span><br><span class="line">    CompletableFuture&lt;String&gt; result2 = future.thenCompose(param -&gt; CompletableFuture.supplyAsync(() -&gt; param + &quot; World&quot;));</span><br><span class="line"></span><br><span class="line">    System.out.println(result1.get());</span><br><span class="line">    System.out.println(result2.get());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="5-结果消费"><a class="markdownIt-Anchor" href="#5-结果消费">#</a> 5、结果消费</h2>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">thenAccept系列：对单个结果进行消费</span><br><span class="line">thenAcceptBoth系列：对两个结果进行消费</span><br><span class="line">thenRun系列：不关心结果，只对结果执行Action</span><br></pre></td></tr></table></figure>
<p>只会拿到上个任务的值，然后对值进行消费，但是绝对不会产生新的值<br>
这是跟上面任务中间 转换的，最大的区别</p>
<p>消费结果还包括 thenRun<br>
thenRun 跟 thenAccept 的区别是，它不仅不产生新的值，还不消费上个任务的值，只是自己做一个业务处理。</p>
<p>6、结果组合<br>
 thenCombine - 合并两个线程任务的结果，并进一步处理。<br>
applyToEither - 两个线程任务相比较，先获得执行结果的，就对该结果进行下一步的转化操作。<br>
acceptEither - 两个线程任务相比较，先获得执行结果的，就对该结果进行下一步的消费操作。<br>
runAfterEither - 两个线程任务相比较，有任何一个执行完成，就进行下一步操作，不关心运行结果。<br>
runAfterBoth - 两个线程任务相比较，两个全部执行完成，才进行下一步操作，不关心运行结果。<br>
anyOf-anyOf 方法的参数是多个给定的 CompletableFuture，当其中的任何一个完成时，方法返回这个 CompletableFuture。<br>
allOf-allOf 方法用来实现多 CompletableFuture 的同时返回。</p>
<p>代码实例</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line">@RestController</span><br><span class="line">@RequestMapping(&quot;/test&quot;)</span><br><span class="line">public class TestController &#123;</span><br><span class="line"></span><br><span class="line">    public static ExecutorService threadPool =</span><br><span class="line">            new ThreadPoolExecutor(</span><br><span class="line">                    10,</span><br><span class="line">                    40,</span><br><span class="line">                    20,</span><br><span class="line">                    TimeUnit.SECONDS,</span><br><span class="line">                    new ArrayBlockingQueue&lt;Runnable&gt;(</span><br><span class="line">                            16</span><br><span class="line">                    ));</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * CompletableFuture 测试</span><br><span class="line">     *</span><br><span class="line">     * @return</span><br><span class="line">     */</span><br><span class="line">    @ApiOperation(&quot;CompletableFuture 测试&quot;)</span><br><span class="line">    @PostMapping(&quot;test&quot;)</span><br><span class="line">    public Object test() &#123;</span><br><span class="line">        Map&lt;Object, Object&gt; result = new HashMap&lt;&gt;();</span><br><span class="line">        CompletableFuture.allOf(</span><br><span class="line">                CompletableFuture.runAsync(() -&gt; &#123;</span><br><span class="line">                    System.out.println(&quot;执行1&quot;);</span><br><span class="line">                    result.put(&quot;key1&quot;, seslectData1());</span><br><span class="line">                &#125;, threadPool),</span><br><span class="line">                CompletableFuture.runAsync(() -&gt; &#123;</span><br><span class="line">                    System.out.println(&quot;执行2&quot;);</span><br><span class="line">                    result.put(&quot;key2&quot;, seslectData2());</span><br><span class="line">                &#125;, threadPool),</span><br><span class="line">                CompletableFuture.runAsync(() -&gt; &#123;</span><br><span class="line">                    System.out.println(&quot;执行3&quot;);</span><br><span class="line">                    result.put(&quot;key3&quot;, seslectData3());</span><br><span class="line">                &#125;, threadPool)</span><br><span class="line">        ).join();</span><br><span class="line"></span><br><span class="line">        return ResponseUtil.ok(result);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public String seslectData1() &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            Thread.sleep(500);</span><br><span class="line">        &#125; catch (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        return &quot;key1&quot;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public String seslectData2() &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            Thread.sleep(500);</span><br><span class="line">        &#125; catch (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        return &quot;key2&quot;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public String seslectData3() &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            Thread.sleep(300);</span><br><span class="line">        &#125; catch (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        return &quot;key3&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2022-12-27T08:18:48.544Z" title="2022-12-27 16:18:48">2022-12-27</time>发表</span><span class="level-item"><time dateTime="2022-12-27T05:23:20.447Z" title="2022-12-27 13:23:20">2022-12-27</time>更新</span><span class="level-item">21 分钟读完 (大约3195个字)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2022/12/27/%E3%80%90Java%E3%80%91CAS%E6%9C%BA%E5%88%B6/">CAS机制</a></p><div class="content"><h1 id="cas机制"><a class="markdownIt-Anchor" href="#cas机制">#</a> CAS 机制</h1>
<h3 id="我们先看一段代码"><a class="markdownIt-Anchor" href="#我们先看一段代码">#</a> 我们先看一段代码：</h3>
<p>启动两个线程，每个线程中让静态变量 count 循环累加 100 次。</p>
<p><img src="https://img-blog.csdn.net/20180312170840546?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvcXFfMzI5OTgxNTM=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70" alt="img"></p>
<p>最终输出的 count 结果一定是 200 吗？因为这段代码是非<a target="_blank" rel="noopener" href="https://so.csdn.net/so/search?q=%E7%BA%BF%E7%A8%8B%E5%AE%89%E5%85%A8&amp;spm=1001.2101.3001.7020">线程安全</a>的，所以最终的自增结果很可能会小于 200。我们再加上 synchronized 同步锁，再来看一下。</p>
<p><img src="https://img-blog.csdn.net/20180312170827236?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvcXFfMzI5OTgxNTM=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70" alt="img"></p>
<p>加了同步锁之后，count 自增的操作变成了原子性操作，所以最终输出一定是 count=200，代码实现了线程安全。虽然 synchronized 确保了线程安全，但是在某些情况下，这并不是一个最有的选择。</p>
<p>关键在于性能问题。</p>
<p>synchronized 关键字会让没有得到锁资源的线程进入 BLOCKED 状态，而后在争夺到锁资源后恢复为 RUNNABLE 状态，这个过程中涉及到操作系统用户模式和内核模式的转换，代价比较高。</p>
<p>尽管 JAVA 1.6 为 synchronized 做了优化，增加了从偏向锁到轻量级锁再到重量级锁的过过度，但是在最终转变为重量级锁之后，性能仍然比较低。所以面对这种情况，我们就可以使用 java 中的 “原子操作类”。</p>
<p>所谓原子操作类，指的是 java.util.concurrent.atomic 包下，一系列以 Atomic 开头的包装类。如 AtomicBoolean，AtomicUInteger，AtomicLong。它们分别用于 Boolean，Integer，Long 类型的原子性操作。</p>
<p>现在我们尝试使用 AtomicInteger 类：</p>
<p><img src="https://img-blog.csdn.net/20180312172106130?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvcXFfMzI5OTgxNTM=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70" alt="img"></p>
<p>使用 AtomicInteger 之后，最终的输出结果同样可以保证是 200。并且在某些情况下，代码的性能会比 synchronized 更好。</p>
<p>而 Atomic 操作类的底层正是用到了 “CAS 机制”。</p>
<p>CAS 是英文单词 Compare and Swap 的缩写，翻译过来就是比较并替换。</p>
<p>CAS 机制中使用了 3 个基本操作数：内存地址 V，旧的预期值 A，要修改的新值 B。</p>
<p>更新一个变量的时候，只有当变量的预期值 A 和内存地址 V 当中的实际值相同时，才会将内存地址 V 对应的值修改为 B。</p>
<p>我们看一个例子：</p>
<p>\1. 在内存地址 V 当中，存储着值为 10 的变量。</p>
<p><img src="https://img-blog.csdn.net/20180312172707148?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvcXFfMzI5OTgxNTM=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70" alt="img"></p>
<p>\2. 此时线程 1 想把变量的值增加 1. 对线程 1 来说，旧的预期值 A=10，要修改的新值 B=11.</p>
<p><img src="https://img-blog.csdn.net/20180312172814864?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvcXFfMzI5OTgxNTM=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70" alt="img"></p>
<p>\3. 在线程 1 要提交更新之前，另一个线程 2 抢先一步，把内存地址 V 中的变量值率先更新成了 11。</p>
<p><img src="https://img-blog.csdn.net/20180312172943800?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvcXFfMzI5OTgxNTM=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70" alt="img"></p>
<p>\4. 线程 1 开始提交更新，首先进行 A 和地址 V 的实际值比较，发现 A 不等于 V 的实际值，提交失败。</p>
<p><img src="https://img-blog.csdn.net/20180312173045349?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvcXFfMzI5OTgxNTM=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70" alt="img"></p>
<p>\5. 线程 1 重新获取内存地址 V 的当前值，并重新计算想要修改的值。此时对线程 1 来说，A=11，B=12。这个重新尝试的过程被称为自旋。</p>
<p><img src="https://img-blog.csdn.net/20180312173220371?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvcXFfMzI5OTgxNTM=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70" alt="img"></p>
<p>\6. 这一次比较幸运，没有其他线程改变地址 V 的值。线程 1 进行比较，发现 A 和地址 V 的实际值是相等的。</p>
<p><img src="https://img-blog.csdn.net/20180312173331761?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvcXFfMzI5OTgxNTM=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70" alt="img"></p>
<p>\7. 线程 1 进行交换，把地址 V 的值替换为 B，也就是 12.</p>
<p><img src="https://img-blog.csdn.net/20180312173421205?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvcXFfMzI5OTgxNTM=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70" alt="img"></p>
<p>从思想上来说，synchronized 属于悲观锁，悲观的认为程序中的并发情况严重，所以严防死守，CAS 属于乐观锁，乐观地认为程序中的并发情况不那么严重，所以让线程不断去重试更新。</p>
<p>在 java 中除了上面提到的 Atomic 系列类，以及 Lock 系列类夺得底层实现，甚至在 JAVA1.6 以上版本，synchronized 转变为重量级锁之前，也会采用 CAS 机制。</p>
<p><strong>CAS 的缺点：</strong></p>
<p>1） CPU 开销过大</p>
<p>在并发量比较高的情况下，如果许多线程反复尝试更新某一个变量，却又一直更新不成功，循环往复，会给 CPU 带来很到的压力。</p>
<p>2） 不能保证代码块的原子性</p>
<p>CAS 机制所保证的知识一个变量的原子性操作，而不能保证整个代码块的原子性。比如需要保证 3 个变量共同进行原子性的更新，就不得不使用 synchronized 了。</p>
<p>3） ABA 问题</p>
<p>这是 CAS 机制最大的问题所在。（后面有介绍）</p>
<p>我们下面来介绍一下两个问题：</p>
<p><em><strong>*1. JAVA 中 CAS 的底层实现 *</strong></em></p>
<p><em><strong>*2. CAS 的 ABA 问题和解决办法。*</strong></em></p>
<p>我们看一下 AtomicInteger 当中常用的自增方法 incrementAndGet：</p>
<p>public final int incrementAndGet() {</p>
<p>for (;😉 {</p>
<p>​    int current = get();</p>
<p>​    int next = current + 1;</p>
<p>​    if (compareAndSet(current, next))</p>
<p>​      return next;</p>
<p>}</p>
<p>}</p>
<p>private volatile int value;</p>
<p>public final int get() {</p>
<p>return value;</p>
<p>}</p>
<p>这段代码是一个无限循环，也就是 CAS 的自旋，循环体中做了三件事：</p>
<p>\1. 获取当前值</p>
<p>\2. 当前值 + 1，计算出目标值</p>
<p>\3. 进行 CAS 操作，如果成功则跳出循环，如果失败则重复上述步骤</p>
<p>这里需要注意的重点是 get 方法，这个方法的作用是获取变量的当前值。</p>
<p>如何保证获取的当前值是内存中的最新值？很简单，用 volatile 关键字来保证（保证线程间的可见性）。我们接下来看一下 compareAndSet 方法的实现：</p>
<p><img src="https://img-blog.csdn.net/2018031217514825?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvcXFfMzI5OTgxNTM=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70" alt="img"></p>
<p>compareAndSet 方法的实现很简单，只有一行代码。这里涉及到两个重要的对象，一个是 unsafe，一个是 valueOffset。</p>
<p>什么是 unsafe 呢？Java 语言不像 C，C++ 那样可以直接访问底层操作系统，但是 JVM 为我们提供了一个后门，这个后门就是 unsafe。unsafe 为我们提供了硬件级别的原子操作。</p>
<p>至于 valueOffset 对象，是通过 unsafe.objectFiledOffset 方法得到，所代表的是 AtomicInteger 对象 value 成员变量在内存中的偏移量。我们可以简单的把 valueOffset 理解为 value 变量的内存地址。</p>
<p>我们上面说过，CAS 机制中使用了 3 个基本操作数：内存地址 V，旧的预期值 A，要修改的新值 B。</p>
<p>而 unsafe 的 compareAndSwapInt 方法的参数包括了这三个基本元素：valueOffset 参数代表了 V，expect 参数代表了 A，update 参数代表了 B。</p>
<p>正是 unsafe 的 compareAndSwapInt 方法保证了 Compare 和 Swap 操作之间的原子性操作。</p>
<p>我们现在来说什么是 ABA 问题。假设内存中有一个值为 A 的变量，存储在地址 V 中。</p>
<p><img src="https://img-blog.csdn.net/2018031218013467?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvcXFfMzI5OTgxNTM=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70" alt="img"></p>
<p>此时有三个线程想使用 CAS 的方式更新这个变量的值，每个线程的执行时间有略微偏差。线程 1 和线程 2 已经获取当前值，线程 3 还未获取当前值。</p>
<p><img src="https://img-blog.csdn.net/20180312180247202?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvcXFfMzI5OTgxNTM=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70" alt="img"></p>
<p>接下来，线程 1 先一步执行成功，把当前值成功从 A 更新为 B；同时线程 2 因为某种原因被阻塞住，没有做更新操作；线程 3 在线程 1 更新之后，获取了当前值 B。</p>
<p><img src="https://img-blog.csdn.net/20180312180432152?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvcXFfMzI5OTgxNTM=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70" alt="img"></p>
<p>在之后，线程 2 仍然处于阻塞状态，线程 3 继续执行，成功把当前值从 B 更新成了 A。</p>
<p><img src="https://img-blog.csdn.net/20180312180546889?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvcXFfMzI5OTgxNTM=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70" alt="img"></p>
<p>最后，线程 2 终于恢复了运行状态，由于阻塞之前已经获得了 “当前值 A”，并且经过 compare 检测，内存地址 V 中的实际值也是 A，所以成功把变量值 A 更新成了 B。</p>
<p><img src="https://img-blog.csdn.net/20180312180729792?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvcXFfMzI5OTgxNTM=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70" alt="img"></p>
<p>看起来这个例子没啥问题，但如果结合实际，就可以发现它的问题所在。</p>
<p>我们假设一个提款机的例子。假设有一个遵循 CAS 原理的提款机，小灰有 100 元存款，要用这个提款机来提款 50 元。</p>
<p><img src="https://img-blog.csdn.net/20180312181342879?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvcXFfMzI5OTgxNTM=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70" alt="img"></p>
<p>由于提款机硬件出了点问题，小灰的提款操作被同时提交了两次，开启了两个线程，两个线程都是获取当前值 100 元，要更新成 50 元。</p>
<p>理想情况下，应该一个线程更新成功，一个线程更新失败，小灰的存款值被扣一次。</p>
<p><img src="https://img-blog.csdn.net/20180312181404403?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvcXFfMzI5OTgxNTM=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70" alt="img"></p>
<p>线程 1 首先执行成功，把余额从 100 改成 50. 线程 2 因为某种原因阻塞。这时，小灰的妈妈刚好给小灰汇款 50 元。</p>
<p><img src="https://img-blog.csdn.net/20180312181531202?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvcXFfMzI5OTgxNTM=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70" alt="img"></p>
<p>线程 2 仍然是阻塞状态，线程 3 执行成功，把余额从 50 改成了 100。</p>
<p><img src="https://img-blog.csdn.net/20180312181635868?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvcXFfMzI5OTgxNTM=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70" alt="img"></p>
<p>线程 2 恢复运行，由于阻塞之前获得了 “当前值” 100，并且经过 compare 检测，此时存款实际值也是 100，所以会成功把变量值 100 更新成 50。</p>
<p><img src="https://img-blog.csdn.net/20180312181813320?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvcXFfMzI5OTgxNTM=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70" alt="img"></p>
<p>原本线程 2 应当提交失败，小灰的正确余额应该保持 100 元，结果由于 ABA 问题提交成功了。</p>
<p>怎么解决呢？加个版本号就可以了。</p>
<p>真正要做到严谨的 CAS 机制，我们在 compare 阶段不仅要比较期望值 A 和地址 V 中的实际值，还要比较变量的版本号是否一致。</p>
<p>我们仍然以刚才的例子来说明，假设地址 V 中存储着变量值 A，当前版本号是 01。线程 1 获取了当前值 A 和版本号 01，想要更新为 B，但是被阻塞了。</p>
<p><img src="https://img-blog.csdn.net/20180312182255181?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvcXFfMzI5OTgxNTM=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70" alt="img"></p>
<p>这时候，内存地址 V 中变量发生了多次改变，版本号提升为 03，但是变量值仍然是 A。</p>
<p><img src="https://img-blog.csdn.net/20180312182346458?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvcXFfMzI5OTgxNTM=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70" alt="img"></p>
<p>随后线程 1 恢复运行，进行 compare 操作。经过比较，线程 1 所获得的值和地址的实际值都是 A，但是版本号不相等，所以这一次更新失败。</p>
<p><img src="https://img-blog.csdn.net/20180312182506360?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvcXFfMzI5OTgxNTM=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70" alt="img"></p>
<p>在 Java 中，AtomicStampedReference 类就实现了用版本号作比较额 CAS 机制。</p>
<p><em><strong>*1. java 语言 CAS 底层如何实现？*</strong></em></p>
<p><em><strong>* 利用 unsafe 提供的原子性操作方法。*</strong></em></p>
<p><em><strong>*2. 什么事 ABA 问题？怎么解决？*</strong></em></p>
<p><em><strong>* 当一个值从 A 变成 B，又更新回 A，普通 CAS 机制会误判通过检测。*</strong></em></p>
<p><em><strong>* 利用版本号比较可以有效解决 ABA 问题。*</strong></em></p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2022-12-27T08:18:48.542Z" title="2022-12-27 16:18:48">2022-12-27</time>发表</span><span class="level-item"><time dateTime="2022-12-27T05:21:04.148Z" title="2022-12-27 13:21:04">2022-12-27</time>更新</span><span class="level-item">7 分钟读完 (大约1089个字)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2022/12/27/%E3%80%90Java%E3%80%91CAS-ABA%E9%97%AE%E9%A2%98/">CAS-ABA问题</a></p><div class="content"><h1 id="cas-aba问题"><a class="markdownIt-Anchor" href="#cas-aba问题">#</a> CAS-ABA 问题</h1>
<h2 id="一概述"><a class="markdownIt-Anchor" href="#一概述">#</a> 一。概述：</h2>
<p>​		ABA 问题是在多线程并发的情况下，发生的一种现象。上一次记录了有关 CAS 操作的一些知识，CAS 通过比较内存中的一个数据是否是预期值，如果是就将它修改成新值，如果不是则进行自旋，重复比较的操作，直到某一刻内存值等于预期值再进行修改。而 ABA 问题则是在 CAS 操作中存在的一个经典问题，这个问题某些时候不会带来任何影响，某些时候却是影响很大的。</p>
<h2 id="二什么是aba问题"><a class="markdownIt-Anchor" href="#二什么是aba问题">#</a> 二。什么是 ABA 问题？</h2>
<h4 id="理解一"><a class="markdownIt-Anchor" href="#理解一">#</a> 理解一：</h4>
<p>​		当执行 campare and swap 会出现失败的情况。例如，一个线程先读取共享内存数据值 A，随后因某种原因，线程暂时挂起，同时另一个线程临时将共享内存数据值先改为 B，随后又改回为 A。随后挂起线程恢复，并通过 CAS 比较，最终比较结果将会无变化。这样会通过检查，这就是 ABA 问题。 在 CAS 比较前会读取原始数据，随后进行原子 CAS 操作。这个间隙之间由于并发操作，最终可能会带来问题。</p>
<h4 id="理解二"><a class="markdownIt-Anchor" href="#理解二">#</a> <strong>理解二:</strong></h4>
<p><img src="https://brath.oss-cn-shanghai.aliyuncs.com/pigo/image-20181231131658183.png" alt=""></p>
<p>“ABA” 问题：假设 t1 线程工作时间为 10 秒，t2 线程工作时间为 2 秒，那么可能在 A 的工作期间，主内存中的共享变量 A 已经被 t2 线程修改了多次，只是恰好最后一次修改的值是该变量的初始值，虽然用 CAS 判定出来的结果是期望值，但是却不是原来那个了 =======》“狸猫换太子”<br>
 相当于是只关心共享变量的起始值和结束值，而不关心过程中共享变量是否被其他线程动过。<br>
有些业务可能不需要关心中间过程，只要前后值一样就行，但是有些业务需求要求变量在中间过程不能被修改。</p>
<p>只靠 CAS 无法保证 ABA 问题，需要使用 “原子引用” 才能解决！！！！</p>
<h1 id="三aba问题的解决"><a class="markdownIt-Anchor" href="#三aba问题的解决">#</a> 三.ABA 问题的解决：</h1>
<h2 id="原子引用存在aba问题"><a class="markdownIt-Anchor" href="#原子引用存在aba问题">#</a> 原子引用：（存在 ABA 问题）</h2>
<p>案例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"> <span class="keyword">package</span> InterviewTest;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.atomic.AtomicReference;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">User</span>&#123;</span><br><span class="line">	 String name;</span><br><span class="line">	 <span class="type">int</span> age;</span><br><span class="line">	 </span><br><span class="line">	 <span class="keyword">public</span> <span class="title function_">User</span><span class="params">(String name,<span class="type">int</span> age)</span> &#123;</span><br><span class="line">		 <span class="built_in">this</span>.name=name;</span><br><span class="line">		 <span class="built_in">this</span>.age=age;</span><br><span class="line">	 &#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">public</span> String <span class="title function_">toString</span><span class="params">()</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="string">&quot;User [name=&quot;</span> + name + <span class="string">&quot;, age=&quot;</span> + age + <span class="string">&quot;]&quot;</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> String <span class="title function_">getName</span><span class="params">()</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> name;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setName</span><span class="params">(String name)</span> &#123;</span><br><span class="line">		<span class="built_in">this</span>.name = name;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getAge</span><span class="params">()</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> age;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setAge</span><span class="params">(<span class="type">int</span> age)</span> &#123;</span><br><span class="line">		<span class="built_in">this</span>.age = age;</span><br><span class="line">	&#125;</span><br><span class="line"> &#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AtomicReferenceDemo</span> &#123;</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">		<span class="type">User</span> <span class="variable">z3</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">User</span>(<span class="string">&quot;z3&quot;</span>,<span class="number">25</span>);</span><br><span class="line">		<span class="type">User</span> <span class="variable">li4</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">User</span>(<span class="string">&quot;li4&quot;</span>,<span class="number">25</span>);</span><br><span class="line">		AtomicReference&lt;User&gt; atomicReference  = <span class="keyword">new</span> <span class="title class_">AtomicReference</span>&lt;&gt;();</span><br><span class="line">		atomicReference.set(z3);</span><br><span class="line">		System.out.println(atomicReference);</span><br><span class="line">		System.out.println(atomicReference.compareAndSet(z3, li4)+</span><br><span class="line">							<span class="string">&quot;       &quot;</span>+atomicReference.get().toString());</span><br><span class="line">		System.out.println(atomicReference.compareAndSet(li4, z3)+</span><br><span class="line">				<span class="string">&quot;       &quot;</span>+atomicReference.get().toString());</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="带版本号的原子引用解决aba问题"><a class="markdownIt-Anchor" href="#带版本号的原子引用解决aba问题">#</a> 带版本号的原子引用（解决 ABA 问题）</h2>
<p><strong>AtomicStampedReference 版本号原子引用：</strong><br>
<strong>案例：两种原子引用的对比</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">package</span> InterviewTest;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.atomic.AtomicReference;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.atomic.AtomicStampedReference;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ABADemo</span> &#123;</span><br><span class="line">	</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">static</span> AtomicReference&lt;Integer&gt; atomicReference </span><br><span class="line">									= <span class="keyword">new</span> <span class="title class_">AtomicReference</span>&lt;&gt;(<span class="number">100</span>);</span><br><span class="line">	<span class="keyword">static</span> AtomicStampedReference&lt;Integer&gt;  atomicStampedReference </span><br><span class="line">									= <span class="keyword">new</span> <span class="title class_">AtomicStampedReference</span>&lt;&gt;(<span class="number">100</span>,<span class="number">1</span>);</span><br><span class="line">	</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">		</span><br><span class="line">		System.out.println(<span class="string">&quot;************以下是ABA问题的产生**************&quot;</span>);</span><br><span class="line">		<span class="keyword">new</span> <span class="title class_">Thread</span>(()-&gt;&#123;</span><br><span class="line">			atomicReference.compareAndSet(<span class="number">100</span>, <span class="number">101</span>);</span><br><span class="line">			atomicReference.compareAndSet(<span class="number">101</span>, <span class="number">100</span>);</span><br><span class="line">		&#125;,<span class="string">&quot;t1&quot;</span>).start();</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">new</span> <span class="title class_">Thread</span>(()-&gt;&#123;</span><br><span class="line">			<span class="keyword">try</span> &#123;</span><br><span class="line">				Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">			&#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">				e.printStackTrace();</span><br><span class="line">			&#125;</span><br><span class="line">			</span><br><span class="line">			System.out.println(atomicReference.compareAndSet(<span class="number">100</span>, <span class="number">2019</span>)</span><br><span class="line">					+<span class="string">&quot;   &quot;</span>+atomicReference.get());</span><br><span class="line">		&#125;,<span class="string">&quot;t2&quot;</span>).start();</span><br><span class="line">		</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			Thread.sleep(<span class="number">2000</span>);</span><br><span class="line">		&#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">		System.out.println(<span class="string">&quot;************以下是ABA问题的解决**************&quot;</span>);</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">new</span> <span class="title class_">Thread</span>(()-&gt;&#123;</span><br><span class="line">			<span class="type">int</span> <span class="variable">stamp</span> <span class="operator">=</span> atomicStampedReference.getStamp();</span><br><span class="line">			System.out.println(Thread.currentThread().getName()</span><br><span class="line">					+<span class="string">&quot;  &quot;</span>+<span class="string">&quot;   第一次版本号：&quot;</span>+stamp);</span><br><span class="line">			<span class="keyword">try</span> &#123;</span><br><span class="line">				Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">			&#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">				e.printStackTrace();</span><br><span class="line">			&#125;</span><br><span class="line">			</span><br><span class="line">			atomicStampedReference.compareAndSet(<span class="number">100</span>, </span><br><span class="line">										<span class="number">101</span>, </span><br><span class="line">										atomicStampedReference.getStamp(),</span><br><span class="line">										atomicStampedReference.getStamp()+<span class="number">1</span>);</span><br><span class="line">			System.out.println(Thread.currentThread().getName()</span><br><span class="line">					+<span class="string">&quot;  &quot;</span>+<span class="string">&quot;   第2次版本号：&quot;</span>+atomicStampedReference.getStamp());</span><br><span class="line">			atomicStampedReference.compareAndSet(<span class="number">101</span>, </span><br><span class="line">					<span class="number">100</span>, </span><br><span class="line">					atomicStampedReference.getStamp(),</span><br><span class="line">					atomicStampedReference.getStamp()+<span class="number">1</span>);</span><br><span class="line">			System.out.println(Thread.currentThread().getName()</span><br><span class="line">					+<span class="string">&quot;  &quot;</span>+<span class="string">&quot;   第3次版本号：&quot;</span>+atomicStampedReference.getStamp());</span><br><span class="line">			</span><br><span class="line">		&#125;,<span class="string">&quot;t3&quot;</span>).start();</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">new</span> <span class="title class_">Thread</span>(()-&gt;&#123;</span><br><span class="line">			<span class="type">int</span> <span class="variable">stamp</span> <span class="operator">=</span> atomicStampedReference.getStamp();</span><br><span class="line">			System.out.println(Thread.currentThread().getName()</span><br><span class="line">					+<span class="string">&quot;  &quot;</span>+<span class="string">&quot;   第一次版本号：&quot;</span>+stamp);</span><br><span class="line">			<span class="keyword">try</span> &#123;</span><br><span class="line">				Thread.sleep(<span class="number">3000</span>);</span><br><span class="line">			&#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">				e.printStackTrace();</span><br><span class="line">			&#125;</span><br><span class="line">			</span><br><span class="line">			<span class="type">boolean</span> <span class="variable">result</span> <span class="operator">=</span>  atomicStampedReference.compareAndSet(</span><br><span class="line">					<span class="number">100</span>, </span><br><span class="line">					<span class="number">2019</span>, </span><br><span class="line">					stamp, </span><br><span class="line">					stamp+<span class="number">1</span>);</span><br><span class="line">			System.out.println(Thread.currentThread().getName()+</span><br><span class="line">					<span class="string">&quot;  修改成功否：&quot;</span>+result+<span class="string">&quot;  当前最新实际版本号：&quot;</span></span><br><span class="line">					+atomicStampedReference.getStamp());</span><br><span class="line">			System.out.println(Thread.currentThread().getName()+</span><br><span class="line">					<span class="string">&quot;  当前实际最新值：&quot;</span></span><br><span class="line">					+atomicStampedReference.getReference());</span><br><span class="line">			</span><br><span class="line">		&#125;,<span class="string">&quot;t4&quot;</span>).start();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">输出:</span><br><span class="line">************以下是ABA问题的产生**************</span><br><span class="line"><span class="literal">true</span>   <span class="number">2019</span></span><br><span class="line">************以下是ABA问题的解决**************</span><br><span class="line">t3     第一次版本号：<span class="number">1</span></span><br><span class="line">t4     第一次版本号：<span class="number">1</span></span><br><span class="line">t3     第<span class="number">2</span>次版本号：<span class="number">2</span></span><br><span class="line">t3     第<span class="number">3</span>次版本号：<span class="number">3</span></span><br><span class="line">t4  修改成功否：<span class="literal">false</span>  当前最新实际版本号：<span class="number">3</span></span><br><span class="line">t4  当前实际最新值：<span class="number">100</span></span><br></pre></td></tr></table></figure>
</div></article></div><nav class="pagination" role="navigation" aria-label="pagination"><div class="pagination-previous"><a href="/page/7/">上一页</a></div><div class="pagination-next"><a href="/page/9/">下一页</a></div><ul class="pagination-list is-hidden-mobile"><li><a class="pagination-link" href="/">1</a></li><li><span class="pagination-ellipsis">&hellip;</span></li><li><a class="pagination-link" href="/page/7/">7</a></li><li><a class="pagination-link is-current" href="/page/8/">8</a></li><li><a class="pagination-link" href="/page/9/">9</a></li></ul></nav></div><div class="column column-left is-4-tablet is-4-desktop is-3-widescreen  order-1"><!--!--><div class="card widget" data-type="recent-posts"><div class="card-content"><h3 class="menu-label">最新文章</h3><article class="media"><div class="media-content"><p class="date"><time dateTime="2023-03-19T03:13:28.214Z">2023-03-19</time></p><p class="title"><a href="/2023/03/19/%E3%80%90SpringBoot%E3%80%91SpringBoot%E5%90%AF%E5%8A%A8Banner%E5%A6%82%E4%BD%95%E4%BF%AE%E6%94%B9/">【SpringBoot】SpringBoot启动Banner如何修改</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2023-03-19T03:11:04.235Z">2023-03-19</time></p><p class="title"><a href="/2023/03/19/%E3%80%90Java%E3%80%91Canal%E6%95%B0%E6%8D%AE%E5%90%8C%E6%AD%A5%EF%BC%8C%E6%8E%A5%E6%94%B6%E4%B8%8D%E5%88%B0Rowdata%E7%B1%BB%E5%9E%8B/">Canal数据同步，接收不到Rowdata类型</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2023-03-16T05:10:11.024Z">2023-03-16</time></p><p class="title"><a href="/2023/03/16/%E3%80%90Docker%E3%80%91Linux%E9%83%A8%E7%BD%B2Docker/">【Docker】Linux部署Docker</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2023-03-16T04:37:23.329Z">2023-03-16</time></p><p class="title"><a href="/2023/03/16/%E3%80%90Docker%E3%80%91Docker%E4%B8%8B%E5%AE%89%E8%A3%85Canal%E5%B9%B6%E6%95%B4%E5%90%88SpringBoot/">【Docker】Docker下安装Canal并整合SpringBoot</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2023-03-03T11:24:09.423Z">2023-03-03</time></p><p class="title"><a href="/2023/03/03/%E3%80%90Docker%E3%80%91docker%E4%B8%AD%E8%AE%BE%E7%BD%AEelasticsearch%E3%80%81kibana%E7%94%A8%E6%88%B7%E5%90%8D%E5%AF%86%E7%A0%81%E3%80%81%E4%BF%AE%E6%94%B9%E5%AF%86%E7%A0%81/">docker中设置elasticsearch、kibana用户名密码、修改密码</a></p></div></article></div></div><div class="card widget" data-type="archives"><div class="card-content"><div class="menu"><h3 class="menu-label">归档</h3><ul class="menu-list"><li><a class="level is-mobile" href="/archives/2023/"><span class="level-start"><span class="level-item">2023</span></span><span class="level-end"><span class="level-item tag">27</span></span></a></li><li><a class="level is-mobile" href="/archives/2022/"><span class="level-start"><span class="level-item">2022</span></span><span class="level-end"><span class="level-item tag">56</span></span></a></li></ul></div></div></div><!--!--><div class="card widget" data-type="subscribe-email"><div class="card-content"><div class="menu"><h3 class="menu-label">订阅更新</h3><form action="https://feedburner.google.com/fb/a/mailverify" method="post" target="popupwindow" onsubmit="window.open(&#039;https://feedburner.google.com/fb/a/mailverify?uri=&#039;,&#039;popupwindow&#039;,&#039;scrollbars=yes,width=550,height=520&#039;);return true"><input type="hidden" value="" name="uri"><input type="hidden" name="loc" value="en_US"><div class="field has-addons"><div class="control has-icons-left is-expanded"><input class="input" name="email" type="email" placeholder="Email"><span class="icon is-small is-left"><i class="fas fa-envelope"></i></span></div><div class="control"><input class="button" type="submit" value="订阅"></div></div></form></div></div></div><div class="card widget" data-type="subscribe-email"><div class="card-content"><div class="menu"><h3 class="menu-label">follow.it</h3><form action="" method="post" target="_blank"><div class="field has-addons"><div class="control has-icons-left is-expanded"><input class="input" name="email" type="email" placeholder="Email"><span class="icon is-small is-left"><i class="fas fa-envelope"></i></span></div><div class="control"><input class="button" type="submit" value="订阅"></div></div></form></div></div></div><div class="column-right-shadow is-hidden-widescreen"></div></div><div class="column column-right is-4-tablet is-4-desktop is-3-widescreen is-hidden-touch is-hidden-desktop-only order-3"><div class="card widget" data-type="profile"><div class="card-content"><nav class="level"><div class="level-item has-text-centered flex-shrink-1"><div><figure class="image is-128x128 mx-auto mb-2"><img class="avatar is-rounded" src="https://brath.oss-cn-shanghai.aliyuncs.com/me.png" alt="Brath"></figure><p class="title is-size-4 is-block" style="line-height:inherit;">Brath</p><p class="is-size-6 is-block">为了更好的你，也为了更好的世界。</p><p class="is-size-6 is-flex justify-content-center"><i class="fas fa-map-marker-alt mr-1"></i><span>中国·江苏·无锡</span></p></div></div></nav><nav class="level is-mobile"><div class="level-item has-text-centered is-marginless"><div><p class="heading">文章</p><a href="/archives"><p class="title">83</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">分类</p><a href="/categories"><p class="title">0</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">标签</p><a href="/tags"><p class="title">0</p></a></div></div></nav><div class="level"><a class="level-item button is-primary is-rounded" href="https://github.com/Guoqing815" target="_blank" rel="noopener">关注我</a></div><div class="level is-mobile is-multiline"><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Github" href="https://github.com/Guoqing815"><i class="fab fa-github"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Gitee" href="https://gitee.com/Guoqing-Li"><i class="fab fa-gitee"></i></a></div></div></div><!--!--><div class="card widget" data-type="links"><div class="card-content"><div class="menu"><h3 class="menu-label">链接</h3><ul class="menu-list"><li><a class="level is-mobile" href="https://gitee.com/Guoqing-Li" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">Gitee(码云)</span></span><span class="level-right"><span class="level-item tag">gitee.com</span></span></a></li><li><a class="level is-mobile" href="https://blog.csdn.net/Brath?type=blog" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">CSDN</span></span><span class="level-right"><span class="level-item tag">blog.csdn.net</span></span></a></li><li><a class="level is-mobile" href="https://juejin.cn/user/settings/profile" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">掘金</span></span><span class="level-right"><span class="level-item tag">juejin.cn</span></span></a></li><li><a class="level is-mobile" href="https://oss.console.aliyun.com/" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">AliCloud(阿里云)</span></span><span class="level-right"><span class="level-item tag">oss.console.aliyun.com</span></span></a></li><li><a class="level is-mobile" href="https://cloud.tencent.com/" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">TencentCloud(腾讯云)</span></span><span class="level-right"><span class="level-item tag">cloud.tencent.com</span></span></a></li><li><a class="level is-mobile" href="https://www.zhipin.com/web/user/" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">BOSS</span></span><span class="level-right"><span class="level-item tag">www.zhipin.com</span></span></a></li><li><a class="level is-mobile" href="https://www.bilibili.com/" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">Bilibili(B站)</span></span><span class="level-right"><span class="level-item tag">www.bilibili.com</span></span></a></li></ul></div></div></div></div></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/"><img src="https://brath.cloud/me.png" alt="Brath-Blog" height="28"></a><p class="is-size-7"><span>&copy; 2023 Brath</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a></p><p class="is-size-7">© 2029</p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Attribution 4.0 International" href="https://creativecommons.org/licenses/by/4.0/"><i class="fab fa-creative-commons-by"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/ppoffice/hexo-theme-icarus"><i class="fab fa-github"></i></a></p></div></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script><script>moment.locale("zh-cn");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="/js/column.js"></script><script src="/js/animation.js"></script><a id="back-to-top" title="回到顶端" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><!--!--><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.js" defer></script><script>window.addEventListener("load", () => {
      window.cookieconsent.initialise({
        type: "info",
        theme: "edgeless",
        static: false,
        position: "bottom-left",
        content: {
          message: "此网站使用Cookie来改善您的体验。",
          dismiss: "知道了！",
          allow: "允许使用Cookie",
          deny: "拒绝",
          link: "了解更多",
          policy: "Cookie政策",
          href: "https://www.cookiesandyou.com/",
        },
        palette: {
          popup: {
            background: "#edeff5",
            text: "#838391"
          },
          button: {
            background: "#4b81e8"
          },
        },
      });
    });</script><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><!--!--><!--!--><!--!--><script src="/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="想要查找什么..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"想要查找什么...","untitled":"(无标题)","posts":"文章","pages":"页面","categories":"分类","tags":"标签"});
        });</script></body></html>