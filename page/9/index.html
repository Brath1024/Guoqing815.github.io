<!doctype html>
<html lang="zh"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta><title>Brath-Blog</title><link rel="manifest" href="/manifest.json"><meta name="application-name" content="Brath-Blog"><meta name="msapplication-TileImage" content="https://brath.cloud/avatar.png"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="Brath-Blog"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta name="description" content="为了更好的你，也为了更好的世界"><meta property="og:type" content="blog"><meta property="og:title" content="Brath-Blog"><meta property="og:url" content="http://example.com/"><meta property="og:site_name" content="Brath-Blog"><meta property="og:description" content="为了更好的你，也为了更好的世界"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="http://example.com/img/og_image.png"><meta property="article:author" content="Brath"><meta property="twitter:card" content="summary"><meta property="twitter:image:src" content="http://example.com/img/og_image.png"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"http://example.com"},"headline":"Brath-Blog","image":["http://example.com/img/og_image.png"],"author":{"@type":"Person","name":"Brath"},"publisher":{"@type":"Organization","name":"Brath-Blog","logo":{"@type":"ImageObject","url":"https://brath.cloud/avatar.png"}},"description":"为了更好的你，也为了更好的世界"}</script><link rel="icon" href="https://brath.cloud/avatar.png"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v6.0.0/css/all.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/atom-one-light.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><!--!--><!--!--><script src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" defer></script><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/css/justifiedGallery.min.css"><!--!--><!--!--><style>.pace{-webkit-pointer-events:none;pointer-events:none;-webkit-user-select:none;-moz-user-select:none;user-select:none}.pace-inactive{display:none}.pace .pace-progress{background:#3273dc;position:fixed;z-index:2000;top:0;right:100%;width:100%;height:2px}</style><script src="https://cdn.jsdelivr.net/npm/pace-js@1.2.4/pace.min.js"></script><!--!--><!--!--><!-- hexo injector head_end start --><script>
  (function () {
      function switchTab() {
          if (!location.hash) {
            return;
          }

          const id = '#' + CSS.escape(location.hash.substring(1));
          const $tabMenu = document.querySelector(`.tabs a[href="${id}"]`);
          if (!$tabMenu) {
            return;
          }

          const $tabMenuContainer = $tabMenu.parentElement.parentElement;
          Array.from($tabMenuContainer.children).forEach($menu => $menu.classList.remove('is-active'));
          Array.from($tabMenuContainer.querySelectorAll('a'))
              .map($menu => document.getElementById($menu.getAttribute("href").substring(1)))
              .forEach($content => $content.classList.add('is-hidden'));

          if ($tabMenu) {
              $tabMenu.parentElement.classList.add('is-active');
          }
          const $activeTab = document.querySelector(id);
          if ($activeTab) {
              $activeTab.classList.remove('is-hidden');
          }
      }
      switchTab();
      window.addEventListener('hashchange', switchTab, false);
  })();
  </script><!-- hexo injector head_end end --><meta name="generator" content="Hexo 6.3.0"></head><body class="is-3-column"><nav class="navbar navbar-main"><div class="container navbar-container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="https://brath.cloud/avatar.png" alt="Brath-Blog" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">主页</a><a class="navbar-item" href="/archives">文章列表</a><a class="navbar-item" href="/tags">标签</a><a class="navbar-item" href="/about">更多</a></div><div class="navbar-end"><a class="navbar-item" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/Guoqing815"><i class="fab fa-github"></i></a><a class="navbar-item search" title="搜索" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-6-widescreen"><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2021-08-09T13:55:59.000Z" title="2021-8-9 21:55:59">2021-08-09</time>发表</span><span class="level-item"><time dateTime="2023-12-21T22:54:49.000Z" title="2023-12-22 6:54:49">2023-12-22</time>更新</span><span class="level-item">4 分钟读完 (大约592个字)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2021/08/09/%E3%80%90Flutter%E3%80%91%E8%A7%A3%E5%86%B3%E5%8D%87%E7%BA%A7Flutter3.0%E5%90%8E%E5%87%BA%E7%8E%B0%E8%AD%A6%E5%91%8AOperand%20of%20null-aware%20operation%20%E2%80%98!%E2%80%98%20has%20type%20%E2%80%98WidgetsBinding%E2%80%98%20which%20excludes%20null/">【Flutter】解决升级Flutter3.0后出现警告Operand of null-aware operation ‘!‘ has type ‘WidgetsBinding‘ which excludes null</a></p><div class="content"><p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/%E6%89%AB%E7%A0%81_%E6%90%9C%E7%B4%A2%E8%81%94%E5%90%88%E4%BC%A0%E6%92%AD%E6%A0%B7%E5%BC%8F-%E6%A0%87%E5%87%86%E8%89%B2%E7%89%88.png" alt="InterviewCoder"></p>
<h1 id="flutter解决升级flutter30后出现警告operand-of-null-aware-operation-has-type-widgetsbinding-which-excludes-null"><a class="markdownIt-Anchor" href="#flutter解决升级flutter30后出现警告operand-of-null-aware-operation-has-type-widgetsbinding-which-excludes-null">#</a> 【Flutter】解决升级 Flutter3.0 后出现警告 Operand of null-aware operation ‘!‘ has type ‘WidgetsBinding‘ which excludes null</h1>
<h1 id="出现场景"><a class="markdownIt-Anchor" href="#出现场景">#</a> 出现场景</h1>
<p>将<a target="_blank" rel="noopener" href="https://so.csdn.net/so/search?q=Flutter&amp;spm=1001.2101.3001.7020"> Flutter</a> SDK 升级到 3.0，运行时报以下警告。<br>
虽然不影响程序的运行，但是看着很烦。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">lib/stress_test/stress_test_page.dart:120:22: Warning: Operand of null-aware operation <span class="string">&#x27;!&#x27;</span> has <span class="built_in">type</span> <span class="string">&#x27;WidgetsBinding&#x27;</span> <span class="built_in">which</span> excludes null.</span><br><span class="line"> - <span class="string">&#x27;WidgetsBinding&#x27;</span> is from <span class="string">&#x27;package:flutter/src/widgets/binding.dart&#x27;</span> (<span class="string">&#x27;../../develop_env/flutter_3.0/packages/flutter/lib/src/widgets/binding.dart&#x27;</span>).</span><br><span class="line">      WidgetsBinding.instance!.addPostFrameCallback((timeStamp) &#123;</span><br><span class="line">                     ^</span><br></pre></td></tr></table></figure>
<h1 id="解决方案"><a class="markdownIt-Anchor" href="#解决方案">#</a> 解决方案</h1>
<p>这是因为在 Flutter 3.0 中，binding 的 instance 是不可为空的，所以不需要使用 <code>!</code> 。</p>
<p>下面有 2 种情况。</p>
<h2 id="三方依赖库"><a class="markdownIt-Anchor" href="#三方依赖库">#</a> 三方依赖库</h2>
<p>如果是依赖的库要使用到了 Binding.instance，去 pub 上看看库的新版本有没有兼容 3.0。如果有就升级库的版本。</p>
<p>比如我的项目用到了 getx 4.6.1，是 Flutter 3.0 出来之前的版本。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">../../develop_env/flutter_3.0/.pub-cache/hosted/pub.flutter-io.cn/get-4.6.1/lib/get_state_manager/src/simple/get_controllers.dart:96:20: Warning: Operand of null-aware operation <span class="string">&#x27;!&#x27;</span> has <span class="built_in">type</span> <span class="string">&#x27;WidgetsBinding&#x27;</span> <span class="built_in">which</span> excludes null.</span><br><span class="line"> - <span class="string">&#x27;WidgetsBinding&#x27;</span> is from <span class="string">&#x27;package:flutter/src/widgets/binding.dart&#x27;</span> (<span class="string">&#x27;../../develop_env/flutter_3.0/packages/flutter/lib/src/widgets/binding.dart&#x27;</span>).</span><br><span class="line">    WidgetsBinding.instance!.removeObserver(this);</span><br><span class="line">                   ^</span><br></pre></td></tr></table></figure>
<p>去 pub 上查看更新记录 (changelog)，可以看到 4.6.2 兼容了 Flutter 3.0。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[4.6.5] #</span><br><span class="line">Fix pub dev score</span><br><span class="line"></span><br><span class="line">[4.6.4] </span><br><span class="line">Added backward compatibility with flutter 2.</span><br><span class="line"></span><br><span class="line">[4.6.3] </span><br><span class="line">Fix SDK constraints</span><br><span class="line"></span><br><span class="line">[4.6.2] </span><br><span class="line">Added compatibility with flutter 3.0</span><br><span class="line"></span><br><span class="line">[4.6.1] </span><br><span class="line">Fix GetConnect on Flutter web</span><br></pre></td></tr></table></figure>
<p>所以我们只需要将 get 的版本更改为 4.6.2 或以上即可。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">dependencies:</span></span><br><span class="line">  <span class="comment"># get: ^4.6.1</span></span><br><span class="line">  <span class="attr">get:</span> <span class="string">^4.6.2</span></span><br></pre></td></tr></table></figure>
<h2 id="本地代码"><a class="markdownIt-Anchor" href="#本地代码">#</a> 本地代码</h2>
<p>如果是项目中有用到 Binding.instance，可以使用<a target="_blank" rel="noopener" href="https://so.csdn.net/so/search?q=dart&amp;spm=1001.2101.3001.7020"> dart</a> 命令 <code>dart fix --apply</code>  自动修复，这样就会自动把 instance 后面的 <code>!</code>  去掉。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">adodeMacBook-Pro:fusion_pro wangyang$ dart fix --apply</span><br><span class="line">Computing fixes <span class="keyword">in</span> fusion_pro... 105.4s</span><br><span class="line">Applying fixes...                      0.0s</span><br><span class="line"></span><br><span class="line">lib/pages/splash_page.dart</span><br><span class="line">  UNNECESSARY_NON_NULL_ASSERTION • 1 fix</span><br><span class="line"></span><br><span class="line">lib/stress_test/stress_test_page.dart</span><br><span class="line">  UNNECESSARY_NON_NULL_ASSERTION • 1 fix</span><br><span class="line"></span><br><span class="line">2 fixes made <span class="keyword">in</span> 2 files.</span><br></pre></td></tr></table></figure>
<h2 id="关于我"><a class="markdownIt-Anchor" href="#关于我">#</a> 关于我</h2>
<p>Brath 是一个热爱技术的 Java 程序猿，公众号「InterviewCoder」定期分享有趣有料的精品原创文章！</p>
<p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/%E4%BA%8C%E7%BB%B4%E7%A0%81plus.png" alt="InterviewCoder"></p>
<p>非常感谢各位人才能看到这里，原创不易，文章如果有帮助可以关注、点赞、分享或评论，这都是对我的莫大支持！</p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2021-07-26T21:18:48.000Z" title="2021-7-27 5:18:48">2021-07-27</time>发表</span><span class="level-item"><time dateTime="2020-11-24T01:35:24.000Z" title="2020-11-24 9:35:24">2020-11-24</time>更新</span><span class="level-item">29 分钟读完 (大约4390个字)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2021/07/27/%E3%80%90SpringBoot%E3%80%91SpringBoot%E8%87%AA%E5%8A%A8%E8%A3%85%E9%85%8D%E5%8E%9F%E7%90%86/">SpringBoot自动装配原理</a></p><div class="content"><p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/%E6%89%AB%E7%A0%81_%E6%90%9C%E7%B4%A2%E8%81%94%E5%90%88%E4%BC%A0%E6%92%AD%E6%A0%B7%E5%BC%8F-%E6%A0%87%E5%87%86%E8%89%B2%E7%89%88.png" alt="InterviewCoder"></p>
<p>自动装配原理：</p>
<p>要学会 SpringBoot 自动装配原理，首先要来看装配了什么？或者说是装配有什么用？</p>
<p>1 . 自动装配了什么？</p>
<p>​		Pom 文件：SpringBoot 帮我们配置好了所有 web 开发常见场景、组件、比如 tomcat、mutipart 文件上传。</p>
<p>​		配置文件：SpringBoot 帮我们装配好了所有组件或者类需要的配置，这些类都有默认的配置，可以通过 application.ymal 或者 application.properties 来修改：比如 server.port=80 修改端口号，默认为 80</p>
<p>2 . 自动装配有什么用？</p>
<p>​		简化 SpringMVC 复杂的配置流程、复杂的依赖引入。SpringBoot 旨在：简化开发，约定大于配置。</p>
<p><strong>总结：</strong></p>
<ul>
<li>
<p><strong>SpringBoot 先加载所有的自动配置类  xxxAutoConfiguration</strong></p>
</li>
<li>
<p><strong>每个自动配置类按照条件进行生效，默认都会绑定配置文件指定的值。xxxProperties 里面拿。xxxProperties 和配置文件进行了绑定</strong></p>
</li>
<li>
<p><strong>生效的配置类就会给容器中装配很多组件</strong></p>
</li>
<li>
<p><strong>只要容器中有这些组件，相当于这些功能就有了</strong></p>
</li>
<li>
<p><strong>定制化配置</strong></p>
</li>
<li>
<ul>
<li><strong>用户直接自己 @Bean 替换底层的组件</strong></li>
<li><strong>用户去看这个组件是获取的配置文件什么值就去修改。</strong></li>
</ul>
</li>
</ul>
<p><strong>xxxAutoConfiguration —&gt; 组件  —&gt;</strong> <strong>xxxProperties 里面拿值  ----&gt; application.properties</strong></p>
<h1 id="1-springboot特点"><a class="markdownIt-Anchor" href="#1-springboot特点">#</a> 1、SpringBoot 特点</h1>
<h2 id="11-依赖管理"><a class="markdownIt-Anchor" href="#11-依赖管理">#</a> 1.1、依赖管理</h2>
<ul>
<li>父项目做依赖管理</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">依赖管理    </span><br><span class="line"><span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.3.4.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line"></span><br><span class="line">他的父项目</span><br><span class="line"> <span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-dependencies<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.3.4.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line"></span><br><span class="line">几乎声明了所有开发中常用的依赖的版本号,自动版本仲裁机制</span><br></pre></td></tr></table></figure>
<ul>
<li>开发导入 starter 场景启动器</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">1、见到很多 spring-boot-starter-* ： *就某种场景</span><br><span class="line">2、只要引入starter，这个场景的所有常规需要的依赖我们都自动引入</span><br><span class="line">3、SpringBoot所有支持的场景</span><br><span class="line">https://docs.spring.io/spring-boot/docs/current/reference/html/using-spring-boot.html#using-boot-starter</span><br><span class="line">4、见到的  *-spring-boot-starter： 第三方为我们提供的简化开发的场景启动器。</span><br><span class="line">5、所有场景启动器最底层的依赖</span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.3.4.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">scope</span>&gt;</span>compile<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<ul>
<li>无需关注版本号，自动版本仲裁</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">1、引入依赖默认都可以不写版本</span><br><span class="line">2、引入非版本仲裁的jar，要写版本号。</span><br></pre></td></tr></table></figure>
<ul>
<li>可以修改默认版本号</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">1、查看spring-boot-dependencies里面规定当前依赖的版本 用的 key。</span><br><span class="line">2、在当前项目里面重写配置</span><br><span class="line">    <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">mysql.version</span>&gt;</span>5.1.43<span class="tag">&lt;/<span class="name">mysql.version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h2 id="12-自动配置"><a class="markdownIt-Anchor" href="#12-自动配置">#</a> 1.2、自动配置</h2>
<ul>
<li>
<p>自动配好 Tomcat</p>
</li>
<li>
<ul>
<li>引入 Tomcat 依赖。</li>
<li>配置 Tomcat</li>
</ul>
</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-tomcat<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.3.4.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">scope</span>&gt;</span>compile<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<ul>
<li>
<p>自动配好 SpringMVC</p>
</li>
<li>
<ul>
<li>引入 SpringMVC 全套组件</li>
<li>自动配好 SpringMVC 常用组件（功能）</li>
</ul>
</li>
<li>
<p>自动配好 Web 常见功能，如：字符编码问题</p>
</li>
<li>
<ul>
<li>SpringBoot 帮我们配置好了所有 web 开发的常见场景</li>
</ul>
</li>
<li>
<p>默认的包结构</p>
</li>
<li>
<ul>
<li>主程序所在包及其下面的所有子包里面的组件都会被默认扫描进来</li>
<li>无需以前的包扫描配置</li>
</ul>
</li>
<li>
<ul>
<li>想要改变扫描路径，@SpringBootApplication (scanBasePackages=<strong>“com.atguigu”</strong>)</li>
</ul>
</li>
<li>
<ul>
<li>
<ul>
<li>或者 @ComponentScan 指定扫描路径</li>
</ul>
</li>
</ul>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line">等同于</span><br><span class="line"><span class="meta">@SpringBootConfiguration</span></span><br><span class="line"><span class="meta">@EnableAutoConfiguration</span></span><br><span class="line"><span class="meta">@ComponentScan(&quot;com.atguigu.boot&quot;)</span></span><br></pre></td></tr></table></figure>
<ul>
<li>
<p>各种配置拥有默认值</p>
</li>
<li>
<ul>
<li>默认配置最终都是映射到某个类上，如：MultipartProperties</li>
<li>配置文件的值最终会绑定每个类上，这个类会在容器中创建对象</li>
</ul>
</li>
<li>
<p>按需加载所有自动配置项</p>
</li>
<li>
<ul>
<li>非常多的 starter</li>
<li>引入了哪些场景这个场景的自动配置才会开启</li>
</ul>
</li>
<li>
<ul>
<li>SpringBoot 所有的自动配置功能都在 spring-boot-autoconfigure 包里面</li>
<li></li>
</ul>
</li>
<li>
<p>…</p>
</li>
</ul>
<h1 id="2-容器功能"><a class="markdownIt-Anchor" href="#2-容器功能">#</a> 2、容器功能</h1>
<h2 id="21-组件添加"><a class="markdownIt-Anchor" href="#21-组件添加">#</a> 2.1、组件添加</h2>
<h3 id="1-configuration"><a class="markdownIt-Anchor" href="#1-configuration">#</a> 1、@Configuration</h3>
<ul>
<li>
<p>基本使用</p>
</li>
<li>
<p><strong>Full 模式与 Lite 模式</strong></p>
</li>
<li>
<ul>
<li>示例</li>
<li>最佳实战</li>
</ul>
</li>
<li>
<ul>
<li>
<ul>
<li>配置 类组件之间无依赖关系用 Lite 模式加速容器启动过程，减少判断</li>
<li>配置类组件之间有依赖关系，方法会被调用得到之前单实例组件，用 Full 模式</li>
</ul>
</li>
</ul>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line">#############################Configuration使用示例######################################################</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 1、配置类里面使用<span class="doctag">@Bean</span>标注在方法上给容器注册组件，默认也是单实例的</span></span><br><span class="line"><span class="comment"> * 2、配置类本身也是组件</span></span><br><span class="line"><span class="comment"> * 3、proxyBeanMethods：代理bean的方法</span></span><br><span class="line"><span class="comment"> *      Full(proxyBeanMethods = true)、【保证每个<span class="doctag">@Bean</span>方法被调用多少次返回的组件都是单实例的】</span></span><br><span class="line"><span class="comment"> *      Lite(proxyBeanMethods = false)【每个<span class="doctag">@Bean</span>方法被调用多少次返回的组件都是新创建的】</span></span><br><span class="line"><span class="comment"> *      组件依赖必须使用Full模式默认。其他默认是否Lite模式</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Configuration(proxyBeanMethods = false)</span> <span class="comment">//告诉SpringBoot这是一个配置类 == 配置文件</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Full:外部无论对配置类中的这个组件注册方法调用多少次获取的都是之前注册容器中的单实例对象</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span> <span class="comment">//给容器中添加组件。以方法名作为组件的id。返回类型就是组件类型。返回的值，就是组件在容器中的实例</span></span><br><span class="line">    <span class="keyword">public</span> User <span class="title function_">user01</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="type">User</span> <span class="variable">zhangsan</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">User</span>(<span class="string">&quot;zhangsan&quot;</span>, <span class="number">18</span>);</span><br><span class="line">        <span class="comment">//user组件依赖了Pet组件</span></span><br><span class="line">        zhangsan.setPet(tomcatPet());</span><br><span class="line">        <span class="keyword">return</span> zhangsan;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean(&quot;tom&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Pet <span class="title function_">tomcatPet</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Pet</span>(<span class="string">&quot;tomcat&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">################################<span class="meta">@Configuration</span>测试代码如下########################################</span><br><span class="line"><span class="meta">@SpringBootConfiguration</span></span><br><span class="line"><span class="meta">@EnableAutoConfiguration</span></span><br><span class="line"><span class="meta">@ComponentScan(&quot;com.atguigu.boot&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MainApplication</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="comment">//1、返回我们IOC容器</span></span><br><span class="line">        <span class="type">ConfigurableApplicationContext</span> <span class="variable">run</span> <span class="operator">=</span> SpringApplication.run(MainApplication.class, args);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//2、查看容器里面的组件</span></span><br><span class="line">        String[] names = run.getBeanDefinitionNames();</span><br><span class="line">        <span class="keyword">for</span> (String name : names) &#123;</span><br><span class="line">            System.out.println(name);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//3、从容器中获取组件</span></span><br><span class="line"></span><br><span class="line">        <span class="type">Pet</span> <span class="variable">tom01</span> <span class="operator">=</span> run.getBean(<span class="string">&quot;tom&quot;</span>, Pet.class);</span><br><span class="line"></span><br><span class="line">        <span class="type">Pet</span> <span class="variable">tom02</span> <span class="operator">=</span> run.getBean(<span class="string">&quot;tom&quot;</span>, Pet.class);</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;组件：&quot;</span>+(tom01 == tom02));</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">//4、com.atguigu.boot.config.MyConfig$$EnhancerBySpringCGLIB$$51f1e1ca@1654a892</span></span><br><span class="line">        <span class="type">MyConfig</span> <span class="variable">bean</span> <span class="operator">=</span> run.getBean(MyConfig.class);</span><br><span class="line">        System.out.println(bean);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//如果@Configuration(proxyBeanMethods = true)代理对象调用方法。SpringBoot总会检查这个组件是否在容器中有。</span></span><br><span class="line">        <span class="comment">//保持组件单实例</span></span><br><span class="line">        <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> bean.user01();</span><br><span class="line">        <span class="type">User</span> <span class="variable">user1</span> <span class="operator">=</span> bean.user01();</span><br><span class="line">        System.out.println(user == user1);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="type">User</span> <span class="variable">user01</span> <span class="operator">=</span> run.getBean(<span class="string">&quot;user01&quot;</span>, User.class);</span><br><span class="line">        <span class="type">Pet</span> <span class="variable">tom</span> <span class="operator">=</span> run.getBean(<span class="string">&quot;tom&quot;</span>, Pet.class);</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;用户的宠物：&quot;</span>+(user01.getPet() == tom));</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="2-bean-component-controller-service-repository"><a class="markdownIt-Anchor" href="#2-bean-component-controller-service-repository">#</a> 2、@Bean、@Component、@Controller、@Service、@Repository</h3>
<h3 id="3-componentscan-import"><a class="markdownIt-Anchor" href="#3-componentscan-import">#</a> 3、@ComponentScan、@Import</h3>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"> * <span class="number">4</span>、<span class="meta">@Import(&#123;User.class, DBHelper.class&#125;)</span></span><br><span class="line"> *      给容器中自动创建出这两个类型的组件、默认组件的名字就是全类名</span><br><span class="line"> *</span><br><span class="line"> *</span><br><span class="line"> *</span><br><span class="line"> */</span><br><span class="line"></span><br><span class="line"><span class="meta">@Import(&#123;User.class, DBHelper.class&#125;)</span></span><br><span class="line"><span class="meta">@Configuration(proxyBeanMethods = false)</span> <span class="comment">//告诉SpringBoot这是一个配置类 == 配置文件</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyConfig</span> &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>@Import 高级用法： <a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1gW411W7wy?p=8">https://www.bilibili.com/video/BV1gW411W7wy?p=8</a></p>
<h3 id="4-conditional"><a class="markdownIt-Anchor" href="#4-conditional">#</a> 4、@Conditional</h3>
<p>条件装配：满足 Conditional 指定的条件，则进行组件注入</p>
<p><img src="https://cdn.nlark.com/yuque/0/2020/png/1354552/1602835786727-28b6f936-62f5-4fd6-a6c5-ae690bd1e31d.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_17%2Ctext_YXRndWlndS5jb20g5bCa56GF6LC3%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10" alt="img"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">=====================测试条件装配==========================</span><br><span class="line"><span class="meta">@Configuration(proxyBeanMethods = false)</span> <span class="comment">//告诉SpringBoot这是一个配置类 == 配置文件</span></span><br><span class="line"><span class="comment">//@ConditionalOnBean(name = &quot;tom&quot;)</span></span><br><span class="line"><span class="meta">@ConditionalOnMissingBean(name = &quot;tom&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyConfig</span> &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Full:外部无论对配置类中的这个组件注册方法调用多少次获取的都是之前注册容器中的单实例对象</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span> <span class="comment">//给容器中添加组件。以方法名作为组件的id。返回类型就是组件类型。返回的值，就是组件在容器中的实例</span></span><br><span class="line">    <span class="keyword">public</span> User <span class="title function_">user01</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="type">User</span> <span class="variable">zhangsan</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">User</span>(<span class="string">&quot;zhangsan&quot;</span>, <span class="number">18</span>);</span><br><span class="line">        <span class="comment">//user组件依赖了Pet组件</span></span><br><span class="line">        zhangsan.setPet(tomcatPet());</span><br><span class="line">        <span class="keyword">return</span> zhangsan;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean(&quot;tom22&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Pet <span class="title function_">tomcatPet</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Pet</span>(<span class="string">&quot;tomcat&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="comment">//1、返回我们IOC容器</span></span><br><span class="line">        <span class="type">ConfigurableApplicationContext</span> <span class="variable">run</span> <span class="operator">=</span> SpringApplication.run(MainApplication.class, args);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//2、查看容器里面的组件</span></span><br><span class="line">        String[] names = run.getBeanDefinitionNames();</span><br><span class="line">        <span class="keyword">for</span> (String name : names) &#123;</span><br><span class="line">            System.out.println(name);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">boolean</span> <span class="variable">tom</span> <span class="operator">=</span> run.containsBean(<span class="string">&quot;tom&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;容器中Tom组件：&quot;</span>+tom);</span><br><span class="line"></span><br><span class="line">        <span class="type">boolean</span> <span class="variable">user01</span> <span class="operator">=</span> run.containsBean(<span class="string">&quot;user01&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;容器中user01组件：&quot;</span>+user01);</span><br><span class="line"></span><br><span class="line">        <span class="type">boolean</span> <span class="variable">tom22</span> <span class="operator">=</span> run.containsBean(<span class="string">&quot;tom22&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;容器中tom22组件：&quot;</span>+tom22);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h2 id="22-原生配置文件引入"><a class="markdownIt-Anchor" href="#22-原生配置文件引入">#</a> 2.2、原生配置文件引入</h2>
<h3 id="1-importresource"><a class="markdownIt-Anchor" href="#1-importresource">#</a> 1、@ImportResource</h3>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">======================beans.xml=========================</span><br><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.springframework.org/schema/beans&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:context</span>=<span class="string">&quot;http://www.springframework.org/schema/context&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd http://www.springframework.org/schema/context https://www.springframework.org/schema/context/spring-context.xsd&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;haha&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.atguigu.boot.bean.User&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;name&quot;</span> <span class="attr">value</span>=<span class="string">&quot;zhangsan&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;age&quot;</span> <span class="attr">value</span>=<span class="string">&quot;18&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;hehe&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.atguigu.boot.bean.Pet&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;name&quot;</span> <span class="attr">value</span>=<span class="string">&quot;tomcat&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br><span class="line">@ImportResource(&quot;classpath:beans.xml&quot;)</span><br><span class="line">public class MyConfig &#123;&#125;</span><br><span class="line"></span><br><span class="line">======================测试=================</span><br><span class="line">        boolean haha = run.containsBean(&quot;haha&quot;);</span><br><span class="line">        boolean hehe = run.containsBean(&quot;hehe&quot;);</span><br><span class="line">        System.out.println(&quot;haha：&quot;+haha);//true</span><br><span class="line">        System.out.println(&quot;hehe：&quot;+hehe);//true</span><br></pre></td></tr></table></figure>
<h2 id="23-配置绑定"><a class="markdownIt-Anchor" href="#23-配置绑定">#</a> 2.3、配置绑定</h2>
<p>如何使用 Java 读取到 properties 文件中的内容，并且把它封装到 JavaBean 中，以供随时使用；</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">getProperties</span> &#123;</span><br><span class="line">     <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> FileNotFoundException, IOException &#123;</span><br><span class="line">         <span class="type">Properties</span> <span class="variable">pps</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Properties</span>();</span><br><span class="line">         pps.load(<span class="keyword">new</span> <span class="title class_">FileInputStream</span>(<span class="string">&quot;a.properties&quot;</span>));</span><br><span class="line">         <span class="type">Enumeration</span> <span class="variable">enum1</span> <span class="operator">=</span> pps.propertyNames();<span class="comment">//得到配置文件的名字</span></span><br><span class="line">         <span class="keyword">while</span>(enum1.hasMoreElements()) &#123;</span><br><span class="line">             <span class="type">String</span> <span class="variable">strKey</span> <span class="operator">=</span> (String) enum1.nextElement();</span><br><span class="line">             <span class="type">String</span> <span class="variable">strValue</span> <span class="operator">=</span> pps.getProperty(strKey);</span><br><span class="line">             System.out.println(strKey + <span class="string">&quot;=&quot;</span> + strValue);</span><br><span class="line">             <span class="comment">//封装到JavaBean。</span></span><br><span class="line">         &#125;</span><br><span class="line">     &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<h3 id="1-configurationproperties"><a class="markdownIt-Anchor" href="#1-configurationproperties">#</a> 1、@ConfigurationProperties</h3>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 只有在容器中的组件，才会拥有SpringBoot提供的强大功能</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@ConfigurationProperties(prefix = &quot;mycar&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Car</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String brand;</span><br><span class="line">    <span class="keyword">private</span> Integer price;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getBrand</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> brand;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setBrand</span><span class="params">(String brand)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.brand = brand;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Integer <span class="title function_">getPrice</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> price;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setPrice</span><span class="params">(Integer price)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.price = price;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">toString</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Car&#123;&quot;</span> +</span><br><span class="line">                <span class="string">&quot;brand=&#x27;&quot;</span> + brand + <span class="string">&#x27;\&#x27;&#x27;</span> +</span><br><span class="line">                <span class="string">&quot;, price=&quot;</span> + price +</span><br><span class="line">                <span class="string">&#x27;&#125;&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="2-enableconfigurationproperties-configurationproperties"><a class="markdownIt-Anchor" href="#2-enableconfigurationproperties-configurationproperties">#</a> 2、@EnableConfigurationProperties + @ConfigurationProperties</h3>
<h3 id="3-component-configurationproperties"><a class="markdownIt-Anchor" href="#3-component-configurationproperties">#</a> 3、@Component + @ConfigurationProperties</h3>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableConfigurationProperties(Car.class)</span></span><br><span class="line"><span class="comment">//1、开启Car配置绑定功能</span></span><br><span class="line"><span class="comment">//2、把这个Car这个组件自动注册到容器中</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyConfig</span> &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="3-自动配置原理入门"><a class="markdownIt-Anchor" href="#3-自动配置原理入门">#</a> 3、自动配置原理入门</h1>
<h2 id="31-引导加载自动配置类"><a class="markdownIt-Anchor" href="#31-引导加载自动配置类">#</a> 3.1、引导加载自动配置类</h2>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootConfiguration</span></span><br><span class="line"><span class="meta">@EnableAutoConfiguration</span></span><br><span class="line"><span class="meta">@ComponentScan(excludeFilters = &#123; @Filter(type = FilterType.CUSTOM, classes = TypeExcludeFilter.class),</span></span><br><span class="line"><span class="meta">		@Filter(type = FilterType.CUSTOM, classes = AutoConfigurationExcludeFilter.class) &#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> SpringBootApplication&#123;&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">======================</span><br><span class="line">    </span><br></pre></td></tr></table></figure>
<h3 id="1-springbootconfiguration"><a class="markdownIt-Anchor" href="#1-springbootconfiguration">#</a> 1、@SpringBootConfiguration</h3>
<p>@Configuration。代表当前是一个配置类</p>
<h3 id="2-componentscan"><a class="markdownIt-Anchor" href="#2-componentscan">#</a> 2、@ComponentScan</h3>
<p>指定扫描哪些，Spring 注解；</p>
<h3 id="3-enableautoconfiguration"><a class="markdownIt-Anchor" href="#3-enableautoconfiguration">#</a> 3、@EnableAutoConfiguration</h3>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@AutoConfigurationPackage</span></span><br><span class="line"><span class="meta">@Import(AutoConfigurationImportSelector.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> EnableAutoConfiguration &#123;&#125;</span><br></pre></td></tr></table></figure>
<h4 id="1-autoconfigurationpackage"><a class="markdownIt-Anchor" href="#1-autoconfigurationpackage">#</a> 1、@AutoConfigurationPackage</h4>
<p>自动配置包？指定了默认的包规则</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Import(AutoConfigurationPackages.Registrar.class)</span>  <span class="comment">//给容器中导入一个组件</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> AutoConfigurationPackage &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//利用Registrar给容器中导入一系列组件</span></span><br><span class="line"><span class="comment">//将指定的一个包下的所有组件导入进来？MainApplication 所在包下。</span></span><br></pre></td></tr></table></figure>
<h4 id="2-importautoconfigurationimportselectorclass"><a class="markdownIt-Anchor" href="#2-importautoconfigurationimportselectorclass">#</a> 2、@Import(AutoConfigurationImportSelector.class)</h4>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span>、利用getAutoConfigurationEntry(annotationMetadata);给容器中批量导入一些组件</span><br><span class="line"><span class="number">2</span>、调用List&lt;String&gt; configurations = getCandidateConfigurations(annotationMetadata, attributes)获取到所有需要导入到容器中的配置类</span><br><span class="line"><span class="number">3</span>、利用工厂加载 Map&lt;String, List&lt;String&gt;&gt; <span class="title function_">loadSpringFactories</span><span class="params">(<span class="meta">@Nullable</span> ClassLoader classLoader)</span>；得到所有的组件</span><br><span class="line"><span class="number">4</span>、从META-INF/spring.factories位置来加载一个文件。</span><br><span class="line">	默认扫描我们当前系统里面所有META-INF/spring.factories位置的文件</span><br><span class="line">    spring-boot-autoconfigure-<span class="number">2.3</span><span class="number">.4</span>.RELEASE.jar包里面也有META-INF/spring.factories</span><br><span class="line">    </span><br></pre></td></tr></table></figure>
<h2 id="img"><a class="markdownIt-Anchor" href="#img">#</a> <img src="https://cdn.nlark.com/yuque/0/2020/png/1354552/1602845382065-5c41abf5-ee10-4c93-89e4-2a9b831c3ceb.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_29%2Ctext_YXRndWlndS5jb20g5bCa56GF6LC3%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10" alt="img"></h2>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br></pre></td><td class="code"><pre><span class="line">文件里面写死了spring-boot一启动就要给容器中加载的所有配置类</span><br><span class="line">spring-boot-autoconfigure-2.3.4.RELEASE.jar/META-INF/spring.factories</span><br><span class="line"># Auto Configure</span><br><span class="line">org.springframework.boot.autoconfigure.EnableAutoConfiguration=\</span><br><span class="line">org.springframework.boot.autoconfigure.admin.SpringApplicationAdminJmxAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.aop.AopAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.amqp.RabbitAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.batch.BatchAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.cache.CacheAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.cassandra.CassandraAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.context.ConfigurationPropertiesAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.context.LifecycleAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.context.MessageSourceAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.context.PropertyPlaceholderAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.couchbase.CouchbaseAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.dao.PersistenceExceptionTranslationAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.data.cassandra.CassandraDataAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.data.cassandra.CassandraReactiveDataAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.data.cassandra.CassandraReactiveRepositoriesAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.data.cassandra.CassandraRepositoriesAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.data.couchbase.CouchbaseDataAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.data.couchbase.CouchbaseReactiveDataAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.data.couchbase.CouchbaseReactiveRepositoriesAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.data.couchbase.CouchbaseRepositoriesAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.data.elasticsearch.ElasticsearchDataAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.data.elasticsearch.ElasticsearchRepositoriesAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.data.elasticsearch.ReactiveElasticsearchRepositoriesAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.data.elasticsearch.ReactiveElasticsearchRestClientAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.data.jdbc.JdbcRepositoriesAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.data.jpa.JpaRepositoriesAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.data.ldap.LdapRepositoriesAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.data.mongo.MongoDataAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.data.mongo.MongoReactiveDataAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.data.mongo.MongoReactiveRepositoriesAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.data.mongo.MongoRepositoriesAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.data.neo4j.Neo4jDataAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.data.neo4j.Neo4jRepositoriesAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.data.solr.SolrRepositoriesAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.data.r2dbc.R2dbcDataAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.data.r2dbc.R2dbcRepositoriesAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.data.r2dbc.R2dbcTransactionManagerAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.data.redis.RedisAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.data.redis.RedisReactiveAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.data.redis.RedisRepositoriesAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.data.rest.RepositoryRestMvcAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.data.web.SpringDataWebAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.elasticsearch.ElasticsearchRestClientAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.flyway.FlywayAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.freemarker.FreeMarkerAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.groovy.template.GroovyTemplateAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.gson.GsonAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.h2.H2ConsoleAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.hateoas.HypermediaAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.hazelcast.HazelcastAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.hazelcast.HazelcastJpaDependencyAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.http.HttpMessageConvertersAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.http.codec.CodecsAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.influx.InfluxDbAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.info.ProjectInfoAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.integration.IntegrationAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.jackson.JacksonAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.jdbc.DataSourceAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.jdbc.JdbcTemplateAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.jdbc.JndiDataSourceAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.jdbc.XADataSourceAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.jdbc.DataSourceTransactionManagerAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.jms.JmsAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.jmx.JmxAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.jms.JndiConnectionFactoryAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.jms.activemq.ActiveMQAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.jms.artemis.ArtemisAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.jersey.JerseyAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.jooq.JooqAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.jsonb.JsonbAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.kafka.KafkaAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.availability.ApplicationAvailabilityAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.ldap.embedded.EmbeddedLdapAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.ldap.LdapAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.liquibase.LiquibaseAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.mail.MailSenderAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.mail.MailSenderValidatorAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.mongo.embedded.EmbeddedMongoAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.mongo.MongoAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.mongo.MongoReactiveAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.mustache.MustacheAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.orm.jpa.HibernateJpaAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.quartz.QuartzAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.r2dbc.R2dbcAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.rsocket.RSocketMessagingAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.rsocket.RSocketRequesterAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.rsocket.RSocketServerAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.rsocket.RSocketStrategiesAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.security.servlet.SecurityAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.security.servlet.UserDetailsServiceAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.security.servlet.SecurityFilterAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.security.reactive.ReactiveSecurityAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.security.reactive.ReactiveUserDetailsServiceAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.security.rsocket.RSocketSecurityAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.security.saml2.Saml2RelyingPartyAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.sendgrid.SendGridAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.session.SessionAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.security.oauth2.client.servlet.OAuth2ClientAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.security.oauth2.client.reactive.ReactiveOAuth2ClientAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.security.oauth2.resource.servlet.OAuth2ResourceServerAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.security.oauth2.resource.reactive.ReactiveOAuth2ResourceServerAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.solr.SolrAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.task.TaskExecutionAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.task.TaskSchedulingAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.thymeleaf.ThymeleafAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.transaction.TransactionAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.transaction.jta.JtaAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.validation.ValidationAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.web.client.RestTemplateAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.web.embedded.EmbeddedWebServerFactoryCustomizerAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.web.reactive.HttpHandlerAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.web.reactive.ReactiveWebServerFactoryAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.web.reactive.WebFluxAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.web.reactive.error.ErrorWebFluxAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.web.reactive.function.client.ClientHttpConnectorAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.web.reactive.function.client.WebClientAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.web.servlet.DispatcherServletAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.web.servlet.ServletWebServerFactoryAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.web.servlet.error.ErrorMvcAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.web.servlet.HttpEncodingAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.web.servlet.MultipartAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.web.servlet.WebMvcAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.websocket.reactive.WebSocketReactiveAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.websocket.servlet.WebSocketServletAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.websocket.servlet.WebSocketMessagingAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.webservices.WebServicesAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.webservices.client.WebServiceTemplateAutoConfiguration</span><br></pre></td></tr></table></figure>
<h2 id="32-按需开启自动配置项"><a class="markdownIt-Anchor" href="#32-按需开启自动配置项">#</a> 3.2、按需开启自动配置项</h2>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">虽然我们<span class="number">127</span>个场景的所有自动配置启动的时候默认全部加载。xxxxAutoConfiguration</span><br><span class="line">按照条件装配规则（<span class="meta">@Conditional</span>），最终会按需配置。</span><br></pre></td></tr></table></figure>
<h2 id="33-修改默认配置"><a class="markdownIt-Anchor" href="#33-修改默认配置">#</a> 3.3、修改默认配置</h2>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">        <span class="meta">@Bean</span></span><br><span class="line">		<span class="meta">@ConditionalOnBean(MultipartResolver.class)</span>  <span class="comment">//容器中有这个类型组件</span></span><br><span class="line">		<span class="meta">@ConditionalOnMissingBean(name = DispatcherServlet.MULTIPART_RESOLVER_BEAN_NAME)</span> <span class="comment">//容器中没有这个名字 multipartResolver 的组件</span></span><br><span class="line">		<span class="keyword">public</span> MultipartResolver <span class="title function_">multipartResolver</span><span class="params">(MultipartResolver resolver)</span> &#123;</span><br><span class="line">            <span class="comment">//给@Bean标注的方法传入了对象参数，这个参数的值就会从容器中找。</span></span><br><span class="line">            <span class="comment">//SpringMVC multipartResolver。防止有些用户配置的文件上传解析器不符合规范</span></span><br><span class="line">			<span class="comment">// Detect if the user has created a MultipartResolver but named it incorrectly</span></span><br><span class="line">			<span class="keyword">return</span> resolver;</span><br><span class="line">		&#125;</span><br><span class="line">给容器中加入了文件上传解析器；</span><br></pre></td></tr></table></figure>
<h2 id=""><a class="markdownIt-Anchor" href="#">#</a> </h2>
<h3 id="springboot默认会在底层配好所有的组件-但是如果用户自己配置了以用户的优先"><a class="markdownIt-Anchor" href="#springboot默认会在底层配好所有的组件-但是如果用户自己配置了以用户的优先">#</a> SpringBoot 默认会在底层配好所有的组件。但是如果用户自己配置了以用户的优先</h3>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line">	<span class="meta">@ConditionalOnMissingBean</span></span><br><span class="line">	<span class="keyword">public</span> CharacterEncodingFilter <span class="title function_">characterEncodingFilter</span><span class="params">()</span> &#123;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h2 id="-2"><a class="markdownIt-Anchor" href="#-2">#</a> </h2>
<p>总结：</p>
<ul>
<li>
<p>SpringBoot 先加载所有的自动配置类  xxxxxAutoConfiguration</p>
</li>
<li>
<p>每个自动配置类按照条件进行生效，默认都会绑定配置文件指定的值。xxxxProperties 里面拿。xxxProperties 和配置文件进行了绑定</p>
</li>
<li>
<p>生效的配置类就会给容器中装配很多组件</p>
</li>
<li>
<p>只要容器中有这些组件，相当于这些功能就有了</p>
</li>
<li>
<p>定制化配置</p>
</li>
<li>
<ul>
<li>用户直接自己 @Bean 替换底层的组件</li>
<li>用户去看这个组件是获取的配置文件什么值就去修改。</li>
</ul>
</li>
</ul>
<p><strong>xxxxxAutoConfiguration —&gt; 组件  —&gt;</strong> <strong>xxxxProperties 里面拿值  ----&gt; application.properties</strong></p>
<h2 id="34-最佳实践"><a class="markdownIt-Anchor" href="#34-最佳实践">#</a> 3.4、最佳实践</h2>
<ul>
<li>
<p>引入场景依赖</p>
</li>
<li>
<ul>
<li><a target="_blank" rel="noopener" href="https://docs.spring.io/spring-boot/docs/current/reference/html/using-spring-boot.html#using-boot-starter">https://docs.spring.io/spring-boot/docs/current/reference/html/using-spring-boot.html#using-boot-starter</a></li>
</ul>
</li>
<li>
<p>查看自动配置了哪些（选做）</p>
</li>
<li>
<ul>
<li>自己分析，引入场景对应的自动配置一般都生效了</li>
<li>配置文件中 debug=true 开启自动配置报告。Negative（不生效）\Positive（生效）</li>
</ul>
</li>
<li>
<p>是否需要修改</p>
</li>
<li>
<ul>
<li>参照文档修改配置项</li>
</ul>
</li>
<li>
<ul>
<li>
<ul>
<li><a target="_blank" rel="noopener" href="https://docs.spring.io/spring-boot/docs/current/reference/html/appendix-application-properties.html#common-application-properties">https://docs.spring.io/spring-boot/docs/current/reference/html/appendix-application-properties.html#common-application-properties</a></li>
<li>自己分析。xxxxProperties 绑定了配置文件的哪些。</li>
</ul>
</li>
</ul>
</li>
<li>
<ul>
<li>自定义加入或者替换组件</li>
</ul>
</li>
<li>
<ul>
<li>
<ul>
<li>@Bean、@Component。。。</li>
</ul>
</li>
</ul>
</li>
<li>
<ul>
<li>自定义器  <strong>XXXXXCustomizer</strong>；</li>
<li>…</li>
</ul>
</li>
</ul>
<h1 id="4-开发小技巧"><a class="markdownIt-Anchor" href="#4-开发小技巧">#</a> 4、开发小技巧</h1>
<h2 id="41-lombok"><a class="markdownIt-Anchor" href="#41-lombok">#</a> 4.1、Lombok</h2>
<p>简化 JavaBean 开发</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">idea中搜索安装lombok插件</span><br><span class="line">===============================简化JavaBean开发===================================</span><br><span class="line">@NoArgsConstructor</span><br><span class="line">//@AllArgsConstructor</span><br><span class="line">@Data</span><br><span class="line">@ToString</span><br><span class="line">@EqualsAndHashCode</span><br><span class="line">public class User &#123;</span><br><span class="line"></span><br><span class="line">    private String name;</span><br><span class="line">    private Integer age;</span><br><span class="line"></span><br><span class="line">    private Pet pet;</span><br><span class="line"></span><br><span class="line">    public User(String name,Integer age)&#123;</span><br><span class="line">        this.name = name;</span><br><span class="line">        this.age = age;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">================================简化日志开发===================================</span><br><span class="line">@Slf4j</span><br><span class="line">@RestController</span><br><span class="line">public class HelloController &#123;</span><br><span class="line">    @RequestMapping(&quot;/hello&quot;)</span><br><span class="line">    public String handle01(@RequestParam(&quot;name&quot;) String name)&#123;</span><br><span class="line">        </span><br><span class="line">        log.info(&quot;请求进来了....&quot;);</span><br><span class="line">        </span><br><span class="line">        return &quot;Hello, Spring Boot 2!&quot;+&quot;你好：&quot;+name;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="42-dev-tools"><a class="markdownIt-Anchor" href="#42-dev-tools">#</a> 4.2、dev-tools</h2>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-devtools<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>项目或者页面修改以后：Ctrl+F9；</p>
<h2 id="43-spring-initailizr项目初始化向导"><a class="markdownIt-Anchor" href="#43-spring-initailizr项目初始化向导">#</a> 4.3、Spring Initailizr（项目初始化向导）</h2>
<h3 id="0-选择我们需要的开发场景"><a class="markdownIt-Anchor" href="#0-选择我们需要的开发场景">#</a> 0、选择我们需要的开发场景</h3>
<p><img src="https://cdn.nlark.com/yuque/0/2020/png/1354552/1602922147241-73fb2496-e795-4b5a-b909-a18c6011a028.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_37%2Ctext_YXRndWlndS5jb20g5bCa56GF6LC3%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10" alt="img"></p>
<h3 id="1-自动依赖引入"><a class="markdownIt-Anchor" href="#1-自动依赖引入">#</a> 1、自动依赖引入</h3>
<p><img src="https://cdn.nlark.com/yuque/0/2020/png/1354552/1602921777330-8fc5c198-75da-4ff9-b82c-71ee3fe18af8.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_28%2Ctext_YXRndWlndS5jb20g5bCa56GF6LC3%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10" alt="img"></p>
<h3 id="2-自动创建项目结构"><a class="markdownIt-Anchor" href="#2-自动创建项目结构">#</a> 2、自动创建项目结构</h3>
<p><img src="https://cdn.nlark.com/yuque/0/2020/png/1354552/1602921758313-5099fe18-4c7b-4417-bf6f-2f40b9028296.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_18%2Ctext_YXRndWlndS5jb20g5bCa56GF6LC3%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10" alt="img"></p>
<h3 id="3-自动编写好主配置类"><a class="markdownIt-Anchor" href="#3-自动编写好主配置类">#</a> 3、自动编写好主配置类</h3>
<p><img src="https://cdn.nlark.com/yuque/0/2020/png/1354552/1602922039074-79e98aad-8158-4113-a7e7-305b57b0a6bf.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_29%2Ctext_YXRndWlndS5jb20g5bCa56GF6LC3%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10" alt="img"></p>
<h2 id="关于我"><a class="markdownIt-Anchor" href="#关于我">#</a> 关于我</h2>
<p>Brath 是一个热爱技术的 Java 程序猿，公众号「InterviewCoder」定期分享有趣有料的精品原创文章！</p>
<p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/%E4%BA%8C%E7%BB%B4%E7%A0%81plus.png" alt="InterviewCoder"></p>
<p>非常感谢各位人才能看到这里，原创不易，文章如果有帮助可以关注、点赞、分享或评论，这都是对我的莫大支持！</p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2021-07-17T15:49:58.000Z" title="2021-7-17 23:49:58">2021-07-17</time>发表</span><span class="level-item"><time dateTime="2020-07-07T05:33:57.000Z" title="2020-7-7 13:33:57">2020-07-07</time>更新</span><span class="level-item">3 分钟读完 (大约431个字)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2021/07/17/%E3%80%90MYSQL%E3%80%91%E4%B8%BB%E4%BB%8E%E5%90%8C%E6%AD%A5%E5%BC%82%E5%B8%B8%E8%AE%B0%E5%BD%95/">主从同步遇到 Got fatal error 1236 from master when reading data from binary log</a></p><div class="content"><p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/%E6%89%AB%E7%A0%81_%E6%90%9C%E7%B4%A2%E8%81%94%E5%90%88%E4%BC%A0%E6%92%AD%E6%A0%B7%E5%BC%8F-%E6%A0%87%E5%87%86%E8%89%B2%E7%89%88.png" alt="InterviewCoder"></p>
<h1 id=""><a class="markdownIt-Anchor" href="#">#</a> </h1>
<p>首先遇到这个是因为 binlog 位置索引处的问题，不要<a target="_blank" rel="noopener" href="https://so.csdn.net/so/search?q=reset&amp;spm=1001.2101.3001.7020"> reset</a> slave；</p>
<p>reset slave 会将主从同步的文件以及位置恢复到初始状态，一开始没有数据还好，有数据的话，相当于重新开始同步，可能会出现一些问题；</p>
<p>一般做主从同步，都是要求以后的数据实现主从同步，而对于旧的数据完全可以使用数据库同步工具先将数据库同步，完了再进行主从同步；</p>
<p>好了遇到上面的问题，正确做法是：</p>
<p>1. 打开主服务器，进入 mysql</p>
<p>2. 执行 flush logs；// 这时主服务器会重新创建一个 binlog 文件；</p>
<p>3. 在主服务上执行 show master status;  显示如下：</p>
<p><img src="https://brath.cloud/blogImg/1620811-20190720113929965-58969472.png" alt="img"></p>
<p>4. 来到从服务器的 mysql；</p>
<p>5.stop slave;</p>
<p>6.change master to master_log_file=‘mysql-bin.000012’,master_log_pos=154;// 这里的 file 和 pos 都是上面主服务器 master 显示的。</p>
<p>7.start slave;// 这时候就应可以了</p>
<p>8.show slave status \G;</p>
<p><img src="https://brath.cloud/blogImg/1620811-20190720114247073-1479221471.png" alt="img"></p>
<h2 id="关于我"><a class="markdownIt-Anchor" href="#关于我">#</a> 关于我</h2>
<p>Brath 是一个热爱技术的 Java 程序猿，公众号「InterviewCoder」定期分享有趣有料的精品原创文章！</p>
<p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/%E4%BA%8C%E7%BB%B4%E7%A0%81plus.png" alt="InterviewCoder"></p>
<p>非常感谢各位人才能看到这里，原创不易，文章如果有帮助可以关注、点赞、分享或评论，这都是对我的莫大支持！</p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2021-07-08T18:53:41.000Z" title="2021-7-9 2:53:41">2021-07-09</time>发表</span><span class="level-item"><time dateTime="2021-09-25T08:55:37.000Z" title="2021-9-25 16:55:37">2021-09-25</time>更新</span><span class="level-item">17 分钟读完 (大约2507个字)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2021/07/09/%E3%80%90Flutter%E3%80%91Flutter%E4%BF%AE%E5%A4%8DAndroid%2012%E6%97%A0%E6%B3%95%E6%9E%84%E5%BB%BA%E7%9A%84%E9%97%AE%E9%A2%98%EF%BC%8C%E8%87%AA%E5%8A%A8%E9%80%82%E9%85%8D%20exported%20%E6%B7%B1%E5%85%A5%E8%A7%A3%E6%9E%90%E9%81%BF%E5%9D%91/">【Flutter】Flutter修复Android 12无法构建的问题，自动适配 exported 深入解析避坑.md</a></p><div class="content"><p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/%E6%89%AB%E7%A0%81_%E6%90%9C%E7%B4%A2%E8%81%94%E5%90%88%E4%BC%A0%E6%92%AD%E6%A0%B7%E5%BC%8F-%E6%A0%87%E5%87%86%E8%89%B2%E7%89%88.png" alt="InterviewCoder"></p>
<h1 id="flutterflutter修复android-12无法构建的问题自动适配-exported-深入解析避坑"><a class="markdownIt-Anchor" href="#flutterflutter修复android-12无法构建的问题自动适配-exported-深入解析避坑">#</a> 【Flutter】Flutter 修复 Android 12 无法构建的问题，自动适配 exported 深入解析避坑</h1>
<blockquote>
<p><em>【摘要】 众所周知，从 Android 12 开始，使用了 TargetSDK 31 之后，四大组件如果使用了 intent-filter， 但是没显性质配置 exported App 将会无法安装，甚至编译不通过…</em></p>
</blockquote>
<blockquote>
<p>比如启动的  <code>Activity</code>  就需要设置  <code>exported</code>  为  <code>true</code>  ，至于其他组件是否设置为  <code>true</code>  则看它是否需要被其它应用调用。</p>
</blockquote>
<h4 id="然而这个事情的状态是这样的"><a class="markdownIt-Anchor" href="#然而这个事情的状态是这样的">#</a> 然而这个事情的状态是这样的:</h4>
<ul>
<li>如果出现问题的  <code>AndroidManifest</code>  文件是你本地的，那手动修改即可；</li>
<li>但如果出现问题的是第三方远程依赖，并且对方并没有提供源码和更新，你就无法直接修改；</li>
<li>如果第三方依赖太多，查找哪些出了问题十分费时费力。</li>
</ul>
<h2 id="脚本"><a class="markdownIt-Anchor" href="#脚本">#</a> 脚本</h2>
<p>所以在之前的 《Android 12 快速适配要点》 一文中提供了一套脚本，专门用于适配 Android 12 下缺少  <code>android:exported</code>  无法编译或者安装的问题，但是在这期间收到了不少问题反馈：</p>
<h3 id="comandroidtoolsbuildgradle400-以及其下版本"><a class="markdownIt-Anchor" href="#comandroidtoolsbuildgradle400-以及其下版本">#</a> com.android.tools.build:gradle:4.0.0 以及其下版本</h3>
<p>一下脚本经过测试最高可到支持的版本： <strong>gradle:4.0.0 &amp; gradle-6.1.1-all.zip</strong></p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 修改 Android 12 因为 exported 的构建问题</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">android.applicationVariants.all &#123; variant -&gt;</span><br><span class="line">    variant.outputs.all &#123; output -&gt;</span><br><span class="line">        output.processResources.<span class="keyword">doFirst</span> &#123; pm -&gt;</span><br><span class="line">            String manifestPath = output.processResources.manifestFile</span><br><span class="line">            <span class="keyword">def</span> manifestFile = <span class="keyword">new</span> <span class="keyword">File</span>(manifestPath)</span><br><span class="line">            <span class="keyword">def</span> xml = <span class="keyword">new</span> XmlParser(<span class="keyword">false</span>, <span class="keyword">true</span>).parse(manifestFile)</span><br><span class="line">            <span class="keyword">def</span> exportedTag = <span class="string">&quot;android:exported&quot;</span></span><br><span class="line">            <span class="comment">///指定 space</span></span><br><span class="line">            <span class="keyword">def</span> androidSpace = <span class="keyword">new</span> groovy.xml.Namespace(<span class="string">&#x27;http://schemas.android.com/apk/res/android&#x27;</span>, <span class="string">&#x27;android&#x27;</span>)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">def</span> nodes = xml.application[<span class="number">0</span>].<span class="string">&#x27;*&#x27;</span>.<span class="keyword">findAll</span> &#123;</span><br><span class="line">                <span class="comment">//挑选要修改的节点，没有指定的 exported 的才需要增加</span></span><br><span class="line">                (it.name() == <span class="string">&#x27;activity&#x27;</span> || it.name() == <span class="string">&#x27;receiver&#x27;</span> || it.name() == <span class="string">&#x27;service&#x27;</span>) &amp;&amp; it.attribute(androidSpace.exported) == <span class="keyword">null</span></span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">///添加 exported，默认 false</span></span><br><span class="line">            nodes.<span class="keyword">each</span> &#123;</span><br><span class="line">                <span class="keyword">def</span> isMain = <span class="keyword">false</span></span><br><span class="line">                it.<span class="keyword">each</span> &#123;</span><br><span class="line">                    <span class="keyword">if</span> (it.name() == <span class="string">&quot;intent-filter&quot;</span>) &#123;</span><br><span class="line">                        it.<span class="keyword">each</span> &#123;</span><br><span class="line">                            <span class="keyword">if</span> (it.name() == <span class="string">&quot;action&quot;</span>) &#123;</span><br><span class="line">                                <span class="keyword">if</span> (it.attributes().get(androidSpace.name) == <span class="string">&quot;android.intent.action.MAIN&quot;</span>) &#123;</span><br><span class="line">                                    isMain = <span class="keyword">true</span></span><br><span class="line">                                    <span class="keyword">println</span>(<span class="string">&quot;......................MAIN FOUND......................&quot;</span>)</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                it.attributes().put(exportedTag, <span class="string">&quot;$&#123;isMain&#125;&quot;</span>)</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            PrintWriter pw = <span class="keyword">new</span> PrintWriter(manifestFile)</span><br><span class="line">            pw.<span class="keyword">write</span>(groovy.xml.XmlUtil.serialize(xml))</span><br><span class="line">            pw.close()</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="comandroidtoolsbuildgradle400-以上版本"><a class="markdownIt-Anchor" href="#comandroidtoolsbuildgradle400-以上版本">#</a> com.android.tools.build:gradle:4.0.0 以上版本</h3>
<p>以下脚本经过测试支持的版本： <strong>gradle:4.1.0 &amp; gradle-6.5.1-all.zip</strong></p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 修改 Android 12 因为 exported 的构建问题</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line">android.applicationVariants.all &#123; variant -&gt;</span><br><span class="line">    variant.outputs.<span class="keyword">each</span> &#123; output -&gt;</span><br><span class="line">        <span class="keyword">def</span> processManifest = output.getProcessManifestProvider().get()</span><br><span class="line">        processManifest.<span class="keyword">doLast</span> &#123; <span class="keyword">task</span> -&gt;</span><br><span class="line">            <span class="keyword">def</span> outputDir = <span class="keyword">task</span>.multiApkManifestOutputDirectory</span><br><span class="line">            <span class="keyword">File</span> outputDirectory</span><br><span class="line">            <span class="keyword">if</span> (outputDir <span class="keyword">instanceof</span> <span class="keyword">File</span>) &#123;</span><br><span class="line">                outputDirectory = outputDir</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                outputDirectory = outputDir.get().asFile</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">File</span> manifestOutFile = <span class="keyword">file</span>(<span class="string">&quot;$outputDirectory/AndroidManifest.xml&quot;</span>)</span><br><span class="line">            <span class="keyword">println</span>(<span class="string">&quot;----------- $&#123;manifestOutFile&#125; ----------- &quot;</span>)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (manifestOutFile.exists() &amp;&amp; manifestOutFile.canRead() &amp;&amp; manifestOutFile.canWrite()) &#123;</span><br><span class="line">                <span class="keyword">def</span> manifestFile = manifestOutFile</span><br><span class="line">                <span class="comment">///这里第二个参数是 false ，所以 namespace 是展开的，所以下面不能用 androidSpace，而是用 nameTag</span></span><br><span class="line">                <span class="keyword">def</span> xml = <span class="keyword">new</span> XmlParser(<span class="keyword">false</span>, <span class="keyword">false</span>).parse(manifestFile)</span><br><span class="line">                <span class="keyword">def</span> exportedTag = <span class="string">&quot;android:exported&quot;</span></span><br><span class="line">                <span class="keyword">def</span> nameTag = <span class="string">&quot;android:name&quot;</span></span><br><span class="line">                <span class="comment">///指定 space</span></span><br><span class="line">                <span class="comment">//def androidSpace = new groovy.xml.Namespace(&#x27;http://schemas.android.com/apk/res/android&#x27;, &#x27;android&#x27;)</span></span><br><span class="line"></span><br><span class="line">                <span class="keyword">def</span> nodes = xml.application[<span class="number">0</span>].<span class="string">&#x27;*&#x27;</span>.<span class="keyword">findAll</span> &#123;</span><br><span class="line">                    <span class="comment">//挑选要修改的节点，没有指定的 exported 的才需要增加</span></span><br><span class="line">                    <span class="comment">//如果 exportedTag 拿不到可以尝试 it.attribute(androidSpace.exported)</span></span><br><span class="line">                    (it.name() == <span class="string">&#x27;activity&#x27;</span> || it.name() == <span class="string">&#x27;receiver&#x27;</span> || it.name() == <span class="string">&#x27;service&#x27;</span>) &amp;&amp; it.attribute(exportedTag) == <span class="keyword">null</span></span><br><span class="line"></span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">///添加 exported，默认 false</span></span><br><span class="line">                nodes.<span class="keyword">each</span> &#123;</span><br><span class="line">                    <span class="keyword">def</span> isMain = <span class="keyword">false</span></span><br><span class="line">                    it.<span class="keyword">each</span> &#123;</span><br><span class="line">                        <span class="keyword">if</span> (it.name() == <span class="string">&quot;intent-filter&quot;</span>) &#123;</span><br><span class="line">                            it.<span class="keyword">each</span> &#123;</span><br><span class="line">                                <span class="keyword">if</span> (it.name() == <span class="string">&quot;action&quot;</span>) &#123;</span><br><span class="line">                                    <span class="comment">//如果 nameTag 拿不到可以尝试 it.attribute(androidSpace.name)</span></span><br><span class="line">                                    <span class="keyword">if</span> (it.attributes().get(nameTag) == <span class="string">&quot;android.intent.action.MAIN&quot;</span>) &#123;</span><br><span class="line">                                        isMain = <span class="keyword">true</span></span><br><span class="line">                                        <span class="keyword">println</span>(<span class="string">&quot;......................MAIN FOUND......................&quot;</span>)</span><br><span class="line">                                    &#125;</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    it.attributes().put(exportedTag, <span class="string">&quot;$&#123;isMain&#125;&quot;</span>)</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                PrintWriter pw = <span class="keyword">new</span> PrintWriter(manifestFile)</span><br><span class="line">                pw.<span class="keyword">write</span>(groovy.xml.XmlUtil.serialize(xml))</span><br><span class="line">                pw.close()</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这段脚本你可以直接放到  <code>app/build.gradle</code>  下执行，也可以单独放到一个 gradle 文件之后  <code>apply</code>  引入，它的作用就是：</p>
<blockquote>
<p>在打包过程中检索所有没有设置  <code>exported</code>  的组件，给他们动态配置上  <code>exported</code> ，这里有个特殊需要注意的是，因为启动  <code>Activity</code>  默认就是需要被 Launcher 打开的，所以  <code>&quot;android.intent.action.MAIN&quot;</code>  需要  <code>exported</code>  设置为  <code>true</code>  。（<strong>PS：更正规应该是用 LAUNCHER 类别，这里故意用 MAIN</strong>）</p>
</blockquote>
<p>而后综合问题，具体反馈的问题有 ：</p>
<ul>
<li><code>label</code>  直接写死中文，不是引用  <code>@string</code>  导致的在 3.x 的版本可以正常运行，但不能打包 ；</li>
<li><code>XmlParser</code>  类找不到，这个首先确定 AGP 版本和 Gradle 版本是否匹配，具体可见 gradle-plugin，另外可以通过 <strong> <code>groovy.util.XmlParser</code> </strong> 或者 <strong> <code>groovy.xml.XmlParser</code> </strong> 全路径指定使用 ，如果是 gradle 文件里显示红色并不会影响运行；</li>
<li><strong>运行报错提示  <code>android:exported needs</code> ，这个就是今天需要输入聊的</strong>；</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Error</span>: <span class="attr">android</span>:exported needs to be explicitly specified <span class="keyword">for</span> &lt;xxxx&gt;. <span class="title class_">Apps</span> targeting <span class="title class_">Android</span> <span class="number">12</span> and higher are required to specify an explicit value <span class="keyword">for</span> <span class="string">`android:exported`</span> when the corresponding component has an intent filter defined.</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"> </span><br></pre></td></tr></table></figure>
<p>基于上述脚本测试和反馈，目前的结论是：</p>
<blockquote>
<p><strong>从  <code>gradle:4.2.0 &amp; gradle-6.7.1-all.zip</code>  开始，TargetSDK 31 下脚本会有异常，因为在  <code>processDebugMainManifest</code>  （带有 Main） 的阶段，会直接扫描依赖库的  <code>AndroidManifest.xml</code>  然后抛出直接报错，从而进不去  <code>processDebugManifest</code>  任务阶段就编译停止，所以实际上脚本并没有成功运行</strong>。</p>
</blockquote>
<p>所以此时拿不到  <code>mergerd_manifest</code>  下的文件，因为  <code>mergerd_manifest</code>  下  <code>AndroidManifest.xml</code>  也还没创建成功，没办法进入 task ，也就是该脚本目前只能针对  <code>gradle:4.1.0</code>  以及其下版本安装 apk 到 Android12 的机器上， 有  <code>intent-filter</code>  但没有 exoprted 的适配问题，<strong>基于这个问题，不知道各位是否有什么好的建议？</strong></p>
<h2 id="新脚本"><a class="markdownIt-Anchor" href="#新脚本">#</a> 新脚本</h2>
<p>而目前基于这个问题，这里提供了如下脚本，在  <code>gradle:4.2.0 &amp; gradle-6.7.1-all.zip</code>  以及  <code>7.0</code>  的版本上，<strong>该脚本的作用是在运行时自动帮你打印出现问题的 aar 包依赖路径和组建名称</strong>：</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">android.applicationVariants.all &#123; variant -&gt;</span><br><span class="line">    variant.outputs.<span class="keyword">each</span> &#123; output -&gt;</span><br><span class="line">        <span class="comment">//println(&quot;=============== $&#123;variant.getBuildType().name.toUpperCase()&#125; ===============&quot;)</span></span><br><span class="line">        <span class="comment">//println(&quot;=============== $&#123;variant.getFlavorName()&#125; ===============&quot;)</span></span><br><span class="line">        <span class="keyword">def</span> vn</span><br><span class="line">        <span class="keyword">if</span> (variant.getFlavorName() != <span class="keyword">null</span> &amp;&amp; variant.getFlavorName() != <span class="string">&quot;&quot;</span>) &#123;</span><br><span class="line">            vn = variant.name;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (variant.getBuildType().name == <span class="string">&quot;release&quot;</span>) &#123;</span><br><span class="line">                vn = <span class="string">&quot;Release&quot;</span></span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                vn = <span class="string">&quot;Debug&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">def</span> taskName = <span class="string">&quot;process$&#123;vn&#125;MainManifest&quot;</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">println</span>(<span class="string">&quot;=============== taskName $&#123;taskName&#125; ===============&quot;</span>)</span><br><span class="line">            <span class="keyword">project</span>.getTasks().getByName(taskName)</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">///你的自定义名字</span></span><br><span class="line">        <span class="keyword">project</span>.getTasks().getByName(taskName).<span class="keyword">doFirst</span> &#123;</span><br><span class="line">            <span class="comment">//def method = it.getClass().getMethods()</span></span><br><span class="line">            it.getManifests().getFiles().<span class="keyword">each</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (it.exists() &amp;&amp; it.canRead()) &#123;</span><br><span class="line">                    <span class="keyword">def</span> manifestFile = it</span><br><span class="line">                    <span class="keyword">def</span> exportedTag = <span class="string">&quot;android:exported&quot;</span></span><br><span class="line">                    <span class="keyword">def</span> nameTag = <span class="string">&quot;android:name&quot;</span></span><br><span class="line">                    <span class="comment">///这里第二个参数是 false ，所以 namespace 是展开的，所以下面不能用 androidSpace，而是用 nameTag</span></span><br><span class="line">                    <span class="keyword">def</span> xml = <span class="keyword">new</span> XmlParser(<span class="keyword">false</span>, <span class="keyword">false</span>).parse(manifestFile)</span><br><span class="line">                    <span class="keyword">if</span> (xml.application != <span class="keyword">null</span> &amp;&amp; xml.application.<span class="keyword">size</span>() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                        <span class="keyword">def</span> nodes = xml.application[<span class="number">0</span>].<span class="string">&#x27;*&#x27;</span>.<span class="keyword">findAll</span> &#123;</span><br><span class="line">                            <span class="comment">//挑选要修改的节点，没有指定的 exported 的才需要增加</span></span><br><span class="line">                            <span class="comment">//如果 exportedTag 拿不到可以尝试 it.attribute(androidSpace.exported)</span></span><br><span class="line">                            (it.name() == <span class="string">&#x27;activity&#x27;</span> || it.name() == <span class="string">&#x27;receiver&#x27;</span> || it.name() == <span class="string">&#x27;service&#x27;</span>) &amp;&amp; it.attribute(exportedTag) == <span class="keyword">null</span></span><br><span class="line"></span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">if</span> (nodes.application != <span class="keyword">null</span> &amp;&amp; nodes.application.<span class="keyword">size</span>() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                            nodes.<span class="keyword">each</span> &#123;</span><br><span class="line">                                <span class="keyword">def</span> t = it</span><br><span class="line">                                it.<span class="keyword">each</span> &#123;</span><br><span class="line">                                    <span class="keyword">if</span> (it.name() == <span class="string">&quot;intent-filter&quot;</span>) &#123;</span><br><span class="line">                                        <span class="keyword">println</span>(<span class="string">&quot;$manifestFile \n .....................$&#123;t.attributes().get(nameTag)&#125;......................&quot;</span>)</span><br><span class="line">                                    &#125;</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"> </span><br></pre></td></tr></table></figure>
<p>如下图所示，<strong>因为目前官方如红色信息内容其实指向并不正确，容易误导问题方向，所以通过上述脚本打印，可以快速查找到问题所在的点，然后通过  <code>tool:replace</code>  临时解决</strong>。</p>
<p><img src="https://img-blog.csdnimg.cn/img_convert/95c73f26b50f1880f6e8a6548ecbdd7a.png" alt="img"></p>
<p>具体为什么之前的脚本在高版本 AGP 下无法使用，原因在于新版本在  <code>processDebugMainManifest</code>  ，或者说  <code>processXXXXXXMainManifest</code>  的处理逻辑发生了变化，通过找到  <code>processDebugMainManifest</code>  的实现类，可以看到问题出现就是在于  <code>Merging library manifest</code>  。</p>
<blockquote>
<p><code>processDebugMainManifest</code>  的实现在 ProcessApplicationManifest 里，对应路径是 ProcessApplicationManifest -&gt; MainfestHelper mergeManifestsForApplication -&gt; MainfestMerger2</p>
</blockquote>
<p>错误是在  <code>Merging library manifest</code>  的阶段出现异常，但是这个阶段的 task 里对于第三方依赖路径的输入，主要是从  <code>private fun computeFullProviderList</code>  方法开始，所以输入到  <code>mergeManifestsForApplication</code>  里的第三方路径是通过这个私有方法生成。</p>
<p><img src="https://img-blog.csdnimg.cn/img_convert/5e0802f3e6ebb8d98de0b09c9603bbe4.png" alt="img"></p>
<p>感觉唯一可以考虑操作的就是内部的  <code>manifests</code>  对象去变换路径，但是它是  <code>private</code>  ，并且内部并不能很好复写其内容。</p>
<p><img src="https://img-blog.csdnimg.cn/img_convert/1b2cad1e51fd633a56c64c106219d76a.png" alt="img"></p>
<p><strong>另外因为 aar 文件里的  <code>AndroidManifset</code>  是 readOnly ，所以如果真的要修改，感觉只能在输入之前读取到对应  <code>AndroidManifset</code> ， 并生成临时文件，在  <code>manifests</code>  对象中更改其路径来完成</strong>，不知道大家有没有什么比较好的思路 。</p>
<blockquote>
<p>如果有好的解决办法，后续再更新。</p>
</blockquote>
<h2 id="最后"><a class="markdownIt-Anchor" href="#最后">#</a> 最后</h2>
<p>最后再说一个坑 ，如果你是低版本 Gradle 可以打包成功，但是运行到 Android12 机器的时候，可能会因为没有 exported 遇到安装失败的问题：</p>
<p>1、如果是模拟器 12，你可能会看到如下所示的错误提示 ，提示上显示还是很直观的， 直接告诉你是  <code>android:exported</code>  的问题：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">* <span class="title class_">What</span> went <span class="attr">wrong</span>:</span><br><span class="line"><span class="title class_">Execution</span> failed <span class="keyword">for</span> task <span class="string">&#x27;:app:installDebug&#x27;</span>.</span><br><span class="line">&gt; java.<span class="property">util</span>.<span class="property">concurrent</span>.<span class="property">ExecutionException</span>: com.<span class="property">android</span>.<span class="property">builder</span>.<span class="property">testing</span>.<span class="property">api</span>.<span class="property">DeviceException</span>: com.<span class="property">android</span>.<span class="property">ddmlib</span>.<span class="property">InstallException</span>: <span class="attr">INSTALL_PARSE_FAILED_MANIFEST_MALFORMED</span>: <span class="title class_">Failed</span> parse during <span class="attr">installPackageLI</span>: <span class="regexp">/data/</span>app/vmdl487461761.<span class="property">tmp</span>/base.<span class="property">apk</span> (at <span class="title class_">Binary</span> <span class="variable constant_">XML</span> file line #<span class="number">358</span>): xxxxx.<span class="property">Activity</span>: <span class="title class_">Targeting</span> S+ (version <span class="number">31</span> and above) requires that an explicit value <span class="keyword">for</span> <span class="attr">android</span>:exported be defined when intent filters are present</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"> </span><br></pre></td></tr></table></figure>
<p>2、如果你是真机 12，那可能就是这样的提示，提示然是  <code>INSTALL_FAILED_USER_RESTRICTED</code>  ，<strong>不得不说小米系统这个安装失败很具误导性，比如 minSDK 太高导致无法安装，在小米上也会是  <code>INSTALL_FAILED_USER_RESTRICTED</code> </strong>：</p>
<p><img src="https://img-blog.csdnimg.cn/img_convert/30ac3d45bb59a0a966036244d82bfc56.png" alt="img"></p>
<p>基本上内容就这些，具体如何进一步优化还待后续测试， <strong>所以针对脚本实现，你还有什么问题或者想法，欢迎评论交流 ～</strong></p>
<p>文章来源: <a target="_blank" rel="noopener" href="http://carguo.blog.csdn.net">carguo.blog.csdn.net</a>，作者：恋猫 de 小郭，版权归原作者所有，如需转载，请联系作者。</p>
<p>原文链接：<a target="_blank" rel="noopener" href="http://carguo.blog.csdn.net/article/details/123438734">carguo.blog.csdn.net/article/details/123438734</a></p>
<h2 id="关于我"><a class="markdownIt-Anchor" href="#关于我">#</a> 关于我</h2>
<p>Brath 是一个热爱技术的 Java 程序猿，公众号「InterviewCoder」定期分享有趣有料的精品原创文章！</p>
<p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/%E4%BA%8C%E7%BB%B4%E7%A0%81plus.png" alt="InterviewCoder"></p>
<p>非常感谢各位人才能看到这里，原创不易，文章如果有帮助可以关注、点赞、分享或评论，这都是对我的莫大支持！</p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2021-06-24T11:49:33.000Z" title="2021-6-24 19:49:33">2021-06-24</time>发表</span><span class="level-item"><time dateTime="2021-10-25T19:47:40.000Z" title="2021-10-26 3:47:40">2021-10-26</time>更新</span><span class="level-item">26 分钟读完 (大约3850个字)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2021/06/24/%E3%80%90%E6%9E%B6%E6%9E%84%E3%80%91DDD%E5%88%86%E5%B1%82%E6%9E%B6%E6%9E%84%E6%A8%A1%E5%9E%8B/">【架构】DDD分层架构模型</a></p><div class="content"><p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/%E6%89%AB%E7%A0%81_%E6%90%9C%E7%B4%A2%E8%81%94%E5%90%88%E4%BC%A0%E6%92%AD%E6%A0%B7%E5%BC%8F-%E6%A0%87%E5%87%86%E8%89%B2%E7%89%88.png" alt="InterviewCoder"></p>
<h1 id="架构ddd分层架构模型"><a class="markdownIt-Anchor" href="#架构ddd分层架构模型">#</a> 【架构】DDD 分层架构模型</h1>
<p>还在单体应用的时候就是分层架构一说，我们用得最多的就是<a target="_blank" rel="noopener" href="https://so.csdn.net/so/search?q=%E4%B8%89%E5%B1%82%E6%9E%B6%E6%9E%84&amp;spm=1001.2101.3001.7020">三层架构</a>。而现在已经是微服务时代，在微服务架构模型比较常用的有几个，例如：整洁架构，CQRS（命令查询分离）以及六边形架构。每种架构模型都有自己的应用场景，但其核心都是 “<strong>高内聚低耦合</strong>” 原则。而运用领域驱动设计（DDD）理念以应对日常加速的业务变化对架构的影响，架构的边界越来越清晰，各司其职，这也符合<a target="_blank" rel="noopener" href="https://so.csdn.net/so/search?q=%E5%BE%AE%E6%9C%8D%E5%8A%A1&amp;spm=1001.2101.3001.7020">微服务</a>架构的设计思想。以领域驱动设计（DDD）为理念的分层架构已经成为微服务架构实践的最佳实践方法。</p>
<h1 id="一-什么是ddd分层架构"><a class="markdownIt-Anchor" href="#一-什么是ddd分层架构">#</a> 一、什么是 DDD 分层架构</h1>
<h1 id="1-传统三层架构"><a class="markdownIt-Anchor" href="#1-传统三层架构">#</a> 1. 传统三层架构</h1>
<p>要了解 DDD 分层架构，首先先了解传统的三层架构。</p>
<p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/bc95fd968f658441bac8dde830d82d39.png" alt="DDD分层架构最佳实践"></p>
<p>传统三层架构流程：</p>
<ul>
<li>第一步考虑的是数据库设计，数据表如何建，表之间的关系如何设计</li>
<li>第二步就是搭建数据访问层，如选一个 ORM 框架或者拼接 SQL 操作</li>
<li>第三步就是业务逻辑的实现，由于我们先设计了数据库，我们整个的思考都会围绕着数据库，想着怎么写才能把数据正确地写入数据库中，这时 CRUD 的标准作法就出现了，也就没有太多考虑面向对象，解耦的事情了，这样的代码对日常的维护自然是越来越困难的</li>
<li>第四步表示层主要面向用户的输出</li>
</ul>
<h1 id="2-ddd分层架构"><a class="markdownIt-Anchor" href="#2-ddd分层架构">#</a> 2. DDD 分层架构</h1>
<p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/0688f3781f073a93538b05557b6dbe22.png" alt="DDD分层架构最佳实践"></p>
<p>为了解决高耦合问题并轻松应对以后的系统变化，我们提出了运用领域驱动设计的理念来设计架构。</p>
<blockquote>
<p>此段落部分总结来源于欧创新《DDD 实践课》的《07 | DDD 分层架构：有效降低层与层之间的依赖》读后感</p>
</blockquote>
<h1 id="1领域层"><a class="markdownIt-Anchor" href="#1领域层">#</a> 1）领域层</h1>
<p>首先我们抛开数据库的困扰，<strong>先从业务逻辑入手开始</strong>，设计时不再考虑数据库的实现。将以前的业务逻辑层（BLL）拆分成了领域层和应用层。</p>
<p>领域层聚焦业务对象的业务逻辑实现，体现现实世界业务的逻辑变化。它用来表达业务概念、业务状态和业务规则，对于业务分析可参照：《使用领域驱动设计分析业务》</p>
<h1 id="2应用层"><a class="markdownIt-Anchor" href="#2应用层">#</a> 2）应用层</h1>
<p>应用层是领域层的上层，依赖领域层，是各聚合的协调和编排，原则上是不包括任何业务逻辑。它以较粗粒度的封闭为前端接口提供支持。除了提供上层调用外，还可以包括事件和消息的订阅。</p>
<h1 id="3-用户接口层"><a class="markdownIt-Anchor" href="#3-用户接口层">#</a> 3） 用户接口层</h1>
<p>用户接口层面向用户访问的数据入向接口，可按不同场景提供不一样的用户接口实现。面向 Web 的可使用 http restful 的方式提供服务，可增加安全认证、权限校验，日志记录等功能；面向微服务的可使用 RPC 方式提供服务，可增加限流、熔断等功能。</p>
<h1 id="4-基础设施层"><a class="markdownIt-Anchor" href="#4-基础设施层">#</a> 4） 基础设施层</h1>
<p>基础设施层是数据的出向接口，封装数据调用的技术细节。可为其它任意层提供服务，但为了解决耦合的问题采用了依赖倒置原则。其它层只依赖基础设施的接口，于具体实现进行分离。</p>
<h1 id="二-ddd分层代码实现"><a class="markdownIt-Anchor" href="#二-ddd分层代码实现">#</a> 二、DDD 分层代码实现</h1>
<h1 id="1-结构模型"><a class="markdownIt-Anchor" href="#1-结构模型">#</a> 1. 结构模型</h1>
<p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/7ba92eeaedb20c360874015795e57354.png" alt="DDD分层架构最佳实践"></p>
<h1 id="2-目录结构"><a class="markdownIt-Anchor" href="#2-目录结构">#</a> 2. 目录结构</h1>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">.</span><br><span class="line">├── pom.xml</span><br><span class="line">└── src</span><br><span class="line">    ├── main</span><br><span class="line">    │   ├── java</span><br><span class="line">    │   │   └── fun</span><br><span class="line">    │   │       └── barryhome</span><br><span class="line">    │   │           └── ddd</span><br><span class="line">    │   │               ├── WalletApplication.java</span><br><span class="line">    │   │               ├── application</span><br><span class="line">    │   │               │   ├── TradeEventProcessor.java</span><br><span class="line">    │   │               │   ├── TradeMQReceiver.java</span><br><span class="line">    │   │               │   └── TradeManager.java</span><br><span class="line">    │   │               ├── constant</span><br><span class="line">    │   │               │   └── MessageConstant.java</span><br><span class="line">    │   │               ├── controller</span><br><span class="line">    │   │               │   ├── TradeController.java</span><br><span class="line">    │   │               │   ├── WalletController.java</span><br><span class="line">    │   │               │   └── dto</span><br><span class="line">    │   │               │       └── TradeDTO.java</span><br><span class="line">    │   │               ├── domain</span><br><span class="line">    │   │               │   ├── TradeService.java</span><br><span class="line">    │   │               │   ├── TradeServiceImpl.java</span><br><span class="line">    │   │               │   ├── enums</span><br><span class="line">    │   │               │   │   ├── InOutFlag.java</span><br><span class="line">    │   │               │   │   ├── TradeStatus.java</span><br><span class="line">    │   │               │   │   ├── TradeType.java</span><br><span class="line">    │   │               │   │   └── WalletStatus.java</span><br><span class="line">    │   │               │   ├── event</span><br><span class="line">    │   │               │   │   └── TradeEvent.java</span><br><span class="line">    │   │               │   ├── model</span><br><span class="line">    │   │               │   │   ├── BaseEntity.java</span><br><span class="line">    │   │               │   │   ├── TradeRecord.java</span><br><span class="line">    │   │               │   │   └── Wallet.java</span><br><span class="line">    │   │               │   └── repository</span><br><span class="line">    │   │               │       ├── TradeRepository.java</span><br><span class="line">    │   │               │       └── WalletRepository.java</span><br><span class="line">    │   │               └── infrastructure</span><br><span class="line">    │   │                   ├── TradeRepositoryImpl.java</span><br><span class="line">    │   │                   ├── WalletRepositoryImpl.java</span><br><span class="line">    │   │                   ├── cache</span><br><span class="line">    │   │                   │   └── Redis.java</span><br><span class="line">    │   │                   ├── client</span><br><span class="line">    │   │                   │   ├── AuthFeignClient.java</span><br><span class="line">    │   │                   │   └── LocalAuthClient.java</span><br><span class="line">    │   │                   ├── jpa</span><br><span class="line">    │   │                   │   ├── JpaTradeRepository.java</span><br><span class="line">    │   │                   │   └── JpaWalletRepository.java</span><br><span class="line">    │   │                   └── mq</span><br><span class="line">    │   │                       └── RabbitMQSender.java</span><br><span class="line">    │   └── resources</span><br><span class="line">    │       ├── application.properties</span><br><span class="line">    │       └── rabbitmq-spring.xml</span><br><span class="line">    └── test</span><br><span class="line">        └── java</span><br></pre></td></tr></table></figure>
<p>此结构为单一微服务的简单结构，各层在同一个模块中。</p>
<p>在大型项目开发过程中，为了达到核心模块的权限控制或更好的灵活性可适当调整结构，可参考《 数字钱包系统》系统结构</p>
<h1 id="3-领域层实现domain"><a class="markdownIt-Anchor" href="#3-领域层实现domain">#</a> 3. 领域层实现（domain）</h1>
<p>在业务分析（《使用领域驱动设计分析业务》）之后，开始编写代码，首先就是写领域层，创建领域对象和领域服务接口</p>
<h1 id="1领域对象"><a class="markdownIt-Anchor" href="#1领域对象">#</a> 1）领域对象</h1>
<p>这里的领域对象包括实体对象、值对象。</p>
<p><strong>实体对象</strong>：具有唯一标识，能单独存在且可变化的对象</p>
<p><strong>值对象</strong>：不能单独存在或在逻辑层面单独存在无意义，且不可变化的对象</p>
<p><strong>聚合</strong>：多个对象的集合，对外是一个整体</p>
<p><strong>聚合根</strong>：聚合中可代表整个业务操作的实体对象，通过它提供对外访问操作，它维护聚合内部的数据一致性，它是聚合中对象的管理者</p>
<p>代码示例：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line">// 交易</span><br><span class="line">public class TradeRecord extends BaseEntity &#123;</span><br><span class="line">    /**</span><br><span class="line">     * 交易号</span><br><span class="line">     */</span><br><span class="line">    @Column(unique = true)</span><br><span class="line">    private String tradeNumber;</span><br><span class="line">    /**</span><br><span class="line">     * 交易金额</span><br><span class="line">     */</span><br><span class="line">    private BigDecimal tradeAmount;</span><br><span class="line">    /**</span><br><span class="line">     * 交易类型</span><br><span class="line">     */</span><br><span class="line">    @Enumerated(EnumType.STRING)</span><br><span class="line">    private TradeType tradeType;</span><br><span class="line">    /**</span><br><span class="line">     * 交易余额</span><br><span class="line">     */</span><br><span class="line">    private BigDecimal balance;</span><br><span class="line">    /**</span><br><span class="line">     * 钱包</span><br><span class="line">     */</span><br><span class="line">    @ManyToOne</span><br><span class="line">    private Wallet wallet;</span><br><span class="line"> </span><br><span class="line">    /**</span><br><span class="line">     * 交易状态</span><br><span class="line">     */</span><br><span class="line">    @Enumerated(EnumType.STRING)</span><br><span class="line">    private TradeStatus tradeStatus;</span><br><span class="line"> </span><br><span class="line">  	@DomainEvents</span><br><span class="line">    public List&lt;Object&gt; domainEvents() &#123;</span><br><span class="line">        return Collections.singletonList(new TradeEvent(this));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">// 钱包</span><br><span class="line">public class Wallet extends BaseEntity &#123;</span><br><span class="line"> </span><br><span class="line">    /**</span><br><span class="line">     * 钱包ID</span><br><span class="line">     */</span><br><span class="line">    @Id</span><br><span class="line">    private String walletId;</span><br><span class="line">    /**</span><br><span class="line">     * 密码</span><br><span class="line">     */</span><br><span class="line">    private String password;</span><br><span class="line">    /**</span><br><span class="line">     * 状态</span><br><span class="line">     */</span><br><span class="line">    @Enumerated(EnumType.STRING)</span><br><span class="line">    private WalletStatus walletStatus = WalletStatus.AVAILABLE;</span><br><span class="line">    /**</span><br><span class="line">     * 用户Id</span><br><span class="line">     */</span><br><span class="line">    private Integer userId;</span><br><span class="line">    /**</span><br><span class="line">     * 余额</span><br><span class="line">     */</span><br><span class="line">    private BigDecimal balance = BigDecimal.ZERO;</span><br><span class="line"> </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>从<strong>钱包交易</strong>例子的系统设计中，钱包的任何操作如：充值、消息等都是通过交易对象驱动钱包余额的变化</li>
<li><strong>交易对象</strong>和<strong>钱包对象</strong>均为实体对象且组成聚合关系，<strong>交易对象</strong>是钱包交易业务模型的聚合根，代表聚合向外提供调用服务</li>
<li>经过分析<strong>交易对象</strong>与<strong>钱包对象</strong>为 1 对多关系（@ManyToOne），这里采用了 JPA 做<strong> ORM</strong> 架构，更多 JPA 实践请参考 &gt;&gt;</li>
<li>这里的领域建模使用的是贫血模型，结构简单，职责单一，相互隔离性好但缺乏面向对象设计思想，关于领域建模可参考《领域建模的贫血模型与充血模型》</li>
<li>domainEvents () 为领域事件发布的一种实现，作用是<strong>交易对象</strong>任何的数据操作都将触发事件的发布，再配合<strong>事件订阅</strong>实现<strong>事件驱动设计</strong>模型，当然也可以有别的实现方式</li>
</ul>
<h1 id="2领域服务"><a class="markdownIt-Anchor" href="#2领域服务">#</a> 2）领域服务</h1>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * Created on 2020/9/7 11:40 上午</span><br><span class="line"> *</span><br><span class="line"> * @author barry</span><br><span class="line"> * Description: 交易服务</span><br><span class="line"> */</span><br><span class="line">public interface TradeService &#123;</span><br><span class="line"> </span><br><span class="line">    /**</span><br><span class="line">     * 充值</span><br><span class="line">     *</span><br><span class="line">     * @param tradeRecord</span><br><span class="line">     * @return</span><br><span class="line">     */</span><br><span class="line">    TradeRecord recharge(TradeRecord tradeRecord);</span><br><span class="line"> </span><br><span class="line">    /**</span><br><span class="line">     * 消费</span><br><span class="line">     *</span><br><span class="line">     * @param tradeRecord</span><br><span class="line">     * @return</span><br><span class="line">     */</span><br><span class="line">    TradeRecord consume(TradeRecord tradeRecord);</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"> </span><br></pre></td></tr></table></figure>
<p>先定义服务接口，接口的定义需要遵循<strong>现实业务的操作</strong>，切勿以程序逻辑或数据库逻辑来设计定义出增删改查</p>
<ul>
<li>主要的思考方向是交易对象对外可提供哪些服务，这种服务的定义是<strong>粗粒度</strong>且<strong>高内聚</strong>的，切勿将某些具体代码实现层面的方法定义出来</li>
<li>接口的输入输出参数尽量考虑以对象的形式，充分兼容各种场景变化</li>
<li>关于前端需要的复杂查询方法可不在此定义，一般情况下查询并非是一种领域服务且没有数据变化，可单独处理</li>
<li>领域服务的实现主要关注逻辑实现，切勿包含技术基础类代码，比如缓存实现，数据库实现，远程调用等</li>
</ul>
<h1 id="3基础设施接口"><a class="markdownIt-Anchor" href="#3基础设施接口">#</a> 3）基础设施接口</h1>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">public interface TradeRepository &#123;</span><br><span class="line">    /**</span><br><span class="line">     * 保存</span><br><span class="line">     * @param tradeRecord</span><br><span class="line">     * @return</span><br><span class="line">     */</span><br><span class="line">    TradeRecord save(TradeRecord tradeRecord);</span><br><span class="line"> </span><br><span class="line">    /**</span><br><span class="line">     * 查询订单</span><br><span class="line">     * @param tradeNumber</span><br><span class="line">     * @return</span><br><span class="line">     */</span><br><span class="line">    TradeRecord findByTradeNumber(String tradeNumber);</span><br><span class="line"> </span><br><span class="line">    /**</span><br><span class="line">     * 发送MQ事件消息</span><br><span class="line">     * @param tradeEvent</span><br><span class="line">     */</span><br><span class="line">    void sendMQEvent(TradeEvent tradeEvent);</span><br><span class="line"> </span><br><span class="line">    /**</span><br><span class="line">     * 获取所有</span><br><span class="line">     * @return</span><br><span class="line">     */</span><br><span class="line">    List&lt;TradeRecord&gt; findAll();</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"> </span><br></pre></td></tr></table></figure>
<ul>
<li>基础设施接口放在领域层主要的目的是减少领域层对基础设施层的依赖</li>
<li>接口的设计是不可暴露实现的技术细节，如不能将拼装的 SQL 作为参数</li>
</ul>
<h1 id="4-应用层实现application"><a class="markdownIt-Anchor" href="#4-应用层实现application">#</a> 4. 应用层实现（application）</h1>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">// 交易服务</span><br><span class="line">@Component</span><br><span class="line">public class TradeManager &#123;</span><br><span class="line"> </span><br><span class="line">    private final TradeService tradeService;</span><br><span class="line">    public TradeManager(TradeService tradeService) &#123;</span><br><span class="line">        this.tradeService = tradeService;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">    // 充值</span><br><span class="line">    @Transactional(rollbackFor = Exception.class)</span><br><span class="line">    public TradeRecord recharge(TradeRecord tradeRecord) &#123;</span><br><span class="line">        return tradeService.recharge(tradeRecord);</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">     // 消费</span><br><span class="line">    @Transactional(rollbackFor = Exception.class)</span><br><span class="line">    public TradeRecord consume(TradeRecord tradeRecord) &#123;</span><br><span class="line">        return tradeService.consume(tradeRecord);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">// 交易事件订阅</span><br><span class="line">@Component</span><br><span class="line">public class TradeEventProcessor &#123;</span><br><span class="line"> </span><br><span class="line">    @Autowired</span><br><span class="line">    private TradeRepository tradeRepository;</span><br><span class="line"> </span><br><span class="line">    @TransactionalEventListener(phase = TransactionPhase.AFTER_COMMIT, condition = &quot;# tradeEvent.tradeStatus.name() == &#x27;SUCCEED&#x27;&quot;)</span><br><span class="line">    public void TradeSucceed(TradeEvent tradeEvent) &#123;</span><br><span class="line">        tradeRepository.sendMQEvent(tradeEvent);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">// 交易消息订阅</span><br><span class="line">@Component</span><br><span class="line">public class TradeMQReceiver &#123;</span><br><span class="line"> </span><br><span class="line">    @RabbitListener(queues = &quot;ddd-trade-succeed&quot;)</span><br><span class="line">    public void receiveTradeMessage(TradeEvent tradeEvent)&#123;</span><br><span class="line">        System.err.println(&quot;========MQ Receiver============&quot;);</span><br><span class="line">        System.err.println(tradeEvent);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"> </span><br></pre></td></tr></table></figure>
<p><strong>应用服务</strong>：</p>
<ul>
<li>应用层是很薄的一层，主要用于调用和组合领域服务，切勿包含任何业务逻辑</li>
<li>可包括少量的流程参数判断</li>
<li>由于可能是多个领域服务组合操作调用，如果存在原子性要求可以增加 **@Transactional** 事务控制</li>
</ul>
<p><strong>事件订阅</strong>：</p>
<ul>
<li>事件订阅是进程内多个领域操作协作解耦的一种实现方式，它也是进程内所有后续操作的接入口</li>
<li>它与应用服务的组合操作用途不一样，组合是根据场景需求可增可减，但事件订阅后的操作是相对固化的，主要是满足逻辑的一致性要求</li>
</ul>
<p><strong>TransactionPhase.AFTER_COMMIT</strong> 配置是在前一操作事务完成后再调用，从而减少后续操作对前操作的影响</p>
<ul>
<li>事件订阅可能会有多个消息主体，为了方便管理最好统一在一个类里处理</li>
<li>MQ 消息发布一般放在事件订阅中</li>
</ul>
<p><strong>消息订阅</strong>：</p>
<ul>
<li>消息订阅是多个微服务间协作解耦的一步实现方式</li>
<li>消息体尽量以统一的对象包装进行传递，降低对象异构带来的处理难度</li>
</ul>
<h1 id="5-基础设施层infrastructure"><a class="markdownIt-Anchor" href="#5-基础设施层infrastructure">#</a> 5. 基础设施层（infrastructure）</h1>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">@Repository</span><br><span class="line">public class TradeRepositoryImpl implements TradeRepository &#123;</span><br><span class="line"> </span><br><span class="line">    private final JpaTradeRepository jpaTradeRepository;</span><br><span class="line">    private final RabbitMQSender rabbitMQSender;</span><br><span class="line">    private final Redis redis;</span><br><span class="line"> </span><br><span class="line">    public TradeRepositoryImpl(JpaTradeRepository jpaTradeRepository, RabbitMQSender rabbitMQSender, Redis redis) &#123;</span><br><span class="line">        this.jpaTradeRepository = jpaTradeRepository;</span><br><span class="line">        this.rabbitMQSender = rabbitMQSender;</span><br><span class="line">        this.redis = redis;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    @Override</span><br><span class="line">    public TradeRecord save(TradeRecord tradeRecord) &#123;</span><br><span class="line">        return jpaTradeRepository.save(tradeRecord);</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    /**</span><br><span class="line">     * 查询订单</span><br><span class="line">     */</span><br><span class="line">    @Override</span><br><span class="line">    public TradeRecord findByTradeNumber(String tradeNumber) &#123;</span><br><span class="line">        TradeRecord tradeRecord = redis.getTrade(tradeNumber);</span><br><span class="line">        if (tradeRecord == null)&#123;</span><br><span class="line">            tradeRecord = jpaTradeRepository.findFirstByTradeNumber(tradeNumber);</span><br><span class="line">            // 缓存</span><br><span class="line">            redis.cacheTrade(tradeRecord);</span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line">        return tradeRecord;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    /**</span><br><span class="line">     * 发送事件消息</span><br><span class="line">     * @param tradeEvent</span><br><span class="line">     */</span><br><span class="line">    @Override</span><br><span class="line">    public void sendMQEvent(TradeEvent tradeEvent) &#123;</span><br><span class="line">        // 发送消息</span><br><span class="line">        rabbitMQSender.sendMQTradeEvent(tradeEvent);</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    /**</span><br><span class="line">     * 获取所有</span><br><span class="line">     */</span><br><span class="line">    @Override</span><br><span class="line">    public List&lt;TradeRecord&gt; findAll() &#123;</span><br><span class="line">        return jpaTradeRepository.findAll();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"> </span><br></pre></td></tr></table></figure>
<ul>
<li>基础设施层是数据的输出向，主要包含数据库、缓存、消息队列、远程访问等的技术实现</li>
<li>基础设计层对外隐藏技术实现细节，提供粗粒度的数据输出服务</li>
<li>数据库操作：领域层传递的是数据对象，在这里可以按数据表的实现方式进行拆分实现</li>
</ul>
<h1 id="6-用户接口层controller"><a class="markdownIt-Anchor" href="#6-用户接口层controller">#</a> 6. 用户接口层（controller）</h1>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">@RequestMapping</span>(<span class="string">&quot;/trade&quot;</span>)</span><br><span class="line"><span class="variable">@RestController</span></span><br><span class="line">public class TradeController &#123;</span><br><span class="line"> </span><br><span class="line">    <span class="variable">@Autowired</span></span><br><span class="line">    private TradeManager tradeManager;</span><br><span class="line"> </span><br><span class="line">    <span class="variable">@Autowired</span></span><br><span class="line">    private TradeRepository tradeRepository;</span><br><span class="line"> </span><br><span class="line">    <span class="variable">@PostMapping</span>(path = <span class="string">&quot;/recharge&quot;</span>)</span><br><span class="line">    public TradeDTO <span class="built_in">recharge</span>(<span class="variable">@RequestBody</span> TradeDTO tradeDTO) &#123;</span><br><span class="line">        <span class="selector-tag">return</span> <span class="selector-tag">TradeDTO</span><span class="selector-class">.toDto</span>(tradeManager.<span class="built_in">recharge</span>(tradeDTO.<span class="built_in">toEntity</span>()));</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    @<span class="selector-tag">PostMapping</span>(path = <span class="string">&quot;/consume&quot;</span>)</span><br><span class="line">    <span class="selector-tag">public</span> <span class="selector-tag">TradeDTO</span> <span class="selector-tag">consume</span>(<span class="variable">@RequestBody</span> TradeDTO tradeDTO) &#123;</span><br><span class="line">        <span class="selector-tag">return</span> <span class="selector-tag">TradeDTO</span><span class="selector-class">.toDto</span>(tradeManager.<span class="built_in">consume</span>(tradeDTO.<span class="built_in">toEntity</span>()));</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    @<span class="selector-tag">GetMapping</span>(path = <span class="string">&quot;/&#123;tradeNumber&#125;&quot;</span>)</span><br><span class="line">    <span class="selector-tag">public</span> <span class="selector-tag">TradeDTO</span> <span class="selector-tag">findByTradeNumber</span>(<span class="variable">@PathVariable</span>(<span class="string">&quot;tradeNumber&quot;</span>) String tradeNumber)&#123;</span><br><span class="line">        <span class="selector-tag">return</span> <span class="selector-tag">TradeDTO</span><span class="selector-class">.toDto</span>(tradeRepository.<span class="built_in">findByTradeNumber</span>(tradeNumber));</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"> </span><br></pre></td></tr></table></figure>
<ul>
<li>用户接口层面向终端提供服务支持</li>
<li>可根据不同的场景单独一个模块，面向 Web 提供 http restful，面向服务间 API 调用提供 RPG 支持</li>
<li>为 Web 端提供身份认证和权限验证服务，VO 数据转换</li>
<li>为 API 端提供限流和熔断服务，DTO 数据转换</li>
<li>将数据转换从应用层提到用户接口层更方便不同场景之前的需求变化，同时也保证应用层数据格式的统一性</li>
</ul>
<h1 id="7-复杂数据查询"><a class="markdownIt-Anchor" href="#7-复杂数据查询">#</a> 7. 复杂数据查询</h1>
<p>以上可见并没有涉及复杂数据查询问题，此问题不涉及业务逻辑处理所以不应该放在领域层处理。</p>
<p>如果复杂数据查询需求较多可采用 CQRS 模式，将查询单独一个模块处理。如果较少可由基础设施层做数据查询，应用层做数据封装，用户接口层做数据调用</p>
<ul>
<li>JPA 不太适合做多表关联的数据库查询操作，可使用其它的灵活性较高的 ORM 架构</li>
</ul>
<p>在大数据大并发情况下，多表关联会严重影响数据库性能，可以考虑做<strong>宽表查询</strong></p>
<h1 id="三-综述"><a class="markdownIt-Anchor" href="#三-综述">#</a> 三、综述</h1>
<p>DDD 分层主要解决各层之间耦合度问题，做到各层各施其职互不影响。各层中领域层的设计是整个系统的中枢，最能体现领域驱动设计的核心思想。它的良好设计是保证往后架构的可持续性，可维护性。</p>
<h2 id="关于我"><a class="markdownIt-Anchor" href="#关于我">#</a> 关于我</h2>
<p>Brath 是一个热爱技术的 Java 程序猿，公众号「InterviewCoder」定期分享有趣有料的精品原创文章！</p>
<p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/%E4%BA%8C%E7%BB%B4%E7%A0%81plus.png" alt="InterviewCoder"></p>
<p>非常感谢各位人才能看到这里，原创不易，文章如果有帮助可以关注、点赞、分享或评论，这都是对我的莫大支持！</p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2021-06-20T01:05:20.000Z" title="2021-6-20 9:05:20">2021-06-20</time>发表</span><span class="level-item"><time dateTime="2020-01-16T23:30:43.000Z" title="2020-1-17 7:30:43">2020-01-17</time>更新</span><span class="level-item">1 分钟读完 (大约206个字)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2021/06/20/%E3%80%90Java%E3%80%91%E7%AB%AF%E5%8F%A3%E5%8F%B7%E8%A2%AB%E5%8D%A0%E7%94%A8%E7%9A%84%E6%83%85%E5%86%B5%E5%A6%82%E4%BD%95%E8%A7%A3%E5%86%B3/">端口占用问题</a></p><div class="content"><p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/%E6%89%AB%E7%A0%81_%E6%90%9C%E7%B4%A2%E8%81%94%E5%90%88%E4%BC%A0%E6%92%AD%E6%A0%B7%E5%BC%8F-%E6%A0%87%E5%87%86%E8%89%B2%E7%89%88.png" alt="InterviewCoder"></p>
<p>安装好 Maven 之后配置环境变量：</p>
<p>netstat -ano：查询全部活动连接</p>
<p>tasklist ：查询全部的进程和 PID</p>
<p>tasklist | findstr “占用端口的进程 PID”</p>
<p>taskkill /f/t /im 占用端口的进程名字.exe</p>
<h2 id="关于我"><a class="markdownIt-Anchor" href="#关于我">#</a> 关于我</h2>
<p>Brath 是一个热爱技术的 Java 程序猿，公众号「InterviewCoder」定期分享有趣有料的精品原创文章！</p>
<p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/%E4%BA%8C%E7%BB%B4%E7%A0%81plus.png" alt="InterviewCoder"></p>
<p>非常感谢各位人才能看到这里，原创不易，文章如果有帮助可以关注、点赞、分享或评论，这都是对我的莫大支持！</p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2021-06-18T12:15:15.000Z" title="2021-6-18 20:15:15">2021-06-18</time>发表</span><span class="level-item"><time dateTime="2023-05-23T03:39:49.253Z" title="2023-5-23 11:39:49">2023-05-23</time>更新</span><span class="level-item">15 分钟读完 (大约2300个字)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2021/06/18/%E3%80%90Java%E3%80%91%E5%A4%9A%E7%A7%8D%E4%BB%A3%E7%90%86%E7%9A%84%E5%AE%9E%E7%8E%B0%E6%96%B9%E5%BC%8F/">【Java】多种代理的实现方式</a></p><div class="content"><p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/%E6%89%AB%E7%A0%81_%E6%90%9C%E7%B4%A2%E8%81%94%E5%90%88%E4%BC%A0%E6%92%AD%E6%A0%B7%E5%BC%8F-%E6%A0%87%E5%87%86%E8%89%B2%E7%89%88.png" alt=""></p>
<h1 id="java多种代理的实现方式"><a class="markdownIt-Anchor" href="#java多种代理的实现方式">#</a> 【Java】多种代理的实现方式</h1>
<h2 id="五种类代理的方式"><a class="markdownIt-Anchor" href="#五种类代理的方式">#</a> 五种类代理的方式</h2>
<p><code>不出意外</code> ，你可能只知道两种类代理的方式。一种是 JDK 自带的，另外一种是 CGLIB。</p>
<p>我们先定义出一个接口和相应的实现类，方便后续使用代理类在方法中添加输出信息。</p>
<p><strong>定义接口</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">IUserApi</span> &#123;</span><br><span class="line"></span><br><span class="line">    String <span class="title function_">queryUserInfo</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>实现接口</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserApi</span> <span class="keyword">implements</span> <span class="title class_">IUserApi</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">queryUserInfo</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;面试记公众号：InterviewCoder，为了更好的你，也为了更好的世界！&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>好！接下来我们就给这个类方法使用代理加入一行额外输出的信息。</p>
<h3 id="0-先补充一点反射的知识"><a class="markdownIt-Anchor" href="#0-先补充一点反射的知识">#</a> 0. 先补充一点反射的知识</h3>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test_reflect</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    Class&lt;UserApi&gt; clazz = UserApi.class;</span><br><span class="line">    <span class="type">Method</span> <span class="variable">queryUserInfo</span> <span class="operator">=</span> clazz.getMethod(<span class="string">&quot;queryUserInfo&quot;</span>);</span><br><span class="line">    <span class="type">Object</span> <span class="variable">invoke</span> <span class="operator">=</span> queryUserInfo.invoke(clazz.newInstance());</span><br><span class="line">    System.out.println(invoke);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<ul>
<li>指数：⭐⭐</li>
<li>点评：有代理地方几乎就会有反射，他们是一套互相配合使用的功能类。在反射中可以调用方法、获取属性、拿到注解等相关内容。这些都可以与接下来的类代理组合使用，完成各种框架中的技术场景。</li>
</ul>
<h3 id="1-jdk代理方式"><a class="markdownIt-Anchor" href="#1-jdk代理方式">#</a> 1. JDK 代理方式</h3>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JDKProxy</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; T <span class="title function_">getProxy</span><span class="params">(Class clazz)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">ClassLoader</span> <span class="variable">classLoader</span> <span class="operator">=</span> Thread.currentThread().getContextClassLoader();</span><br><span class="line">        <span class="keyword">return</span> (T) Proxy.newProxyInstance(classLoader, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;clazz&#125;, <span class="keyword">new</span> <span class="title class_">InvocationHandler</span>() &#123;</span><br><span class="line">            <span class="keyword">public</span> Object <span class="title function_">invoke</span><span class="params">(Object proxy, Method method, Object[] args)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">                System.out.println(method.getName() + <span class="string">&quot; 你被代理了，By JDKProxy！&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span> <span class="string">&quot;面试记公众号：InterviewCoder，为了更好的你，也为了更好的世界！&quot;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test_JDKProxy</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="type">IUserApi</span> <span class="variable">userApi</span> <span class="operator">=</span> JDKProxy.getProxy(IUserApi.class);</span><br><span class="line">    <span class="type">String</span> <span class="variable">invoke</span> <span class="operator">=</span> userApi.queryUserInfo();</span><br><span class="line">    logger.info(<span class="string">&quot;测试结果：&#123;&#125;&quot;</span>, invoke);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 测试结果：</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * queryUserInfo 你被代理了，By JDKProxy！</span></span><br><span class="line"><span class="comment"> * 19:55:47.319 [main] INFO  cn.brath.interview.test.ApiTest - 测试结果：面试记公众号：InterviewCoder，为了更好的你，也为了更好的世界！</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Process finished with exit code 0</span></span><br><span class="line"><span class="comment"> */</span>  </span><br></pre></td></tr></table></figure>
<hr>
<ul>
<li>指数：⭐⭐</li>
<li>场景：中间件开发、设计模式中代理模式和装饰器模式应用</li>
<li>点评：这种 JDK 自带的类代理方式是非常常用的一种，也是非常简单的一种。基本会在一些中间件代码里看到例如：数据库路由组件、Redis 组件等，同时我们也可以使用这样的方式应用到设计模式中。</li>
</ul>
<h3 id="2-cglib代理方式"><a class="markdownIt-Anchor" href="#2-cglib代理方式">#</a> 2. CGLIB 代理方式</h3>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CglibProxy</span> <span class="keyword">implements</span> <span class="title class_">MethodInterceptor</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">newInstall</span><span class="params">(Object object)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> Enhancer.create(object.getClass(), <span class="built_in">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">intercept</span><span class="params">(Object o, Method method, Object[] objects, MethodProxy methodProxy)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;我被CglibProxy代理了&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> methodProxy.invokeSuper(o, objects);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test_CglibProxy</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="type">CglibProxy</span> <span class="variable">cglibProxy</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CglibProxy</span>();</span><br><span class="line">    <span class="type">UserApi</span> <span class="variable">userApi</span> <span class="operator">=</span> (UserApi) cglibProxy.newInstall(<span class="keyword">new</span> <span class="title class_">UserApi</span>());</span><br><span class="line">    <span class="type">String</span> <span class="variable">invoke</span> <span class="operator">=</span> userApi.queryUserInfo();</span><br><span class="line">    logger.info(<span class="string">&quot;测试结果：&#123;&#125;&quot;</span>, invoke);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 测试结果：</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * queryUserInfo 你被代理了，By CglibProxy！</span></span><br><span class="line"><span class="comment"> * 19:55:47.319 [main] INFO  cn.brath.interview.test.ApiTest - 测试结果：面试记公众号：InterviewCoder，为了更好的你，也为了更好的世界！</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Process finished with exit code 0</span></span><br><span class="line"><span class="comment"> */</span></span><br></pre></td></tr></table></figure>
<hr>
<ul>
<li>指数：⭐⭐⭐</li>
<li>场景：Spring、AOP 切面、鉴权服务、中间件开发、RPC 框架等</li>
<li>点评：CGLIB 不同于 JDK，它的底层使用 ASM 字节码框架在类中修改指令码实现代理，所以这种代理方式也就不需要像 JDK 那样需要接口才能代理。同时得益于字节码框架的使用，所以这种代理方式也会比使用 JDK 代理的方式快 1.5~2.0 倍。</li>
</ul>
<h3 id="3-asm代理方式"><a class="markdownIt-Anchor" href="#3-asm代理方式">#</a> 3. ASM 代理方式</h3>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ASMProxy</span> <span class="keyword">extends</span> <span class="title class_">ClassLoader</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; T <span class="title function_">getProxy</span><span class="params">(Class clazz)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">ClassReader</span> <span class="variable">classReader</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClassReader</span>(clazz.getName());</span><br><span class="line">        <span class="type">ClassWriter</span> <span class="variable">classWriter</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClassWriter</span>(classReader, ClassWriter.COMPUTE_MAXS);</span><br><span class="line"></span><br><span class="line">        classReader.accept(<span class="keyword">new</span> <span class="title class_">ClassVisitor</span>(ASM5, classWriter) &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> MethodVisitor <span class="title function_">visitMethod</span><span class="params">(<span class="type">int</span> access, <span class="keyword">final</span> String name, String descriptor, String signature, String[] exceptions)</span> &#123;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 方法过滤</span></span><br><span class="line">                <span class="keyword">if</span> (!<span class="string">&quot;queryUserInfo&quot;</span>.equals(name))</span><br><span class="line">                    <span class="keyword">return</span> <span class="built_in">super</span>.visitMethod(access, name, descriptor, signature, exceptions);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">final</span> <span class="type">MethodVisitor</span> <span class="variable">methodVisitor</span> <span class="operator">=</span> <span class="built_in">super</span>.visitMethod(access, name, descriptor, signature, exceptions);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">AdviceAdapter</span>(ASM5, methodVisitor, access, name, descriptor) &#123;</span><br><span class="line"></span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onMethodEnter</span><span class="params">()</span> &#123;</span><br><span class="line">                        <span class="comment">// 执行指令；获取静态属性</span></span><br><span class="line">                        methodVisitor.visitFieldInsn(Opcodes.GETSTATIC, <span class="string">&quot;java/lang/System&quot;</span>, <span class="string">&quot;out&quot;</span>, <span class="string">&quot;Ljava/io/PrintStream;&quot;</span>);</span><br><span class="line">                        <span class="comment">// 加载常量 load constant</span></span><br><span class="line">                        methodVisitor.visitLdcInsn(name + <span class="string">&quot; 你被代理了，By ASM！&quot;</span>);</span><br><span class="line">                        <span class="comment">// 调用方法</span></span><br><span class="line">                        methodVisitor.visitMethodInsn(Opcodes.INVOKEVIRTUAL, <span class="string">&quot;java/io/PrintStream&quot;</span>, <span class="string">&quot;println&quot;</span>, <span class="string">&quot;(Ljava/lang/String;)V&quot;</span>, <span class="literal">false</span>);</span><br><span class="line">                        <span class="built_in">super</span>.onMethodEnter();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, ClassReader.EXPAND_FRAMES);</span><br><span class="line"></span><br><span class="line">        <span class="type">byte</span>[] bytes = classWriter.toByteArray();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> (T) <span class="keyword">new</span> <span class="title class_">ASMProxy</span>().defineClass(clazz.getName(), bytes, <span class="number">0</span>, bytes.length).newInstance();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test_ASMProxy</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="type">IUserApi</span> <span class="variable">userApi</span> <span class="operator">=</span> ASMProxy.getProxy(UserApi.class);</span><br><span class="line">    <span class="type">String</span> <span class="variable">invoke</span> <span class="operator">=</span> userApi.queryUserInfo();</span><br><span class="line">    logger.info(<span class="string">&quot;测试结果：&#123;&#125;&quot;</span>, invoke);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 测试结果：</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * queryUserInfo 你被代理了，By ASM！</span></span><br><span class="line"><span class="comment"> * 20:12:26.791 [main] INFO  cn.brath.interview.test.ApiTest - 测试结果：面试记公众号：InterviewCoder，为了更好的你，也为了更好的世界！</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Process finished with exit code 0</span></span><br><span class="line"><span class="comment"> */</span></span><br></pre></td></tr></table></figure>
<hr>
<ul>
<li>指数：⭐⭐⭐⭐⭐</li>
<li>场景：全链路监控、破解工具包、CGLIB、Spring 获取类元数据等</li>
<li>点评：这种代理就是使用字节码编程的方式进行处理，它的实现方式相对复杂，而且需要了解 Java 虚拟机规范相关的知识。因为你的每一步代理操作，都是在操作字节码指令，例如： <code>Opcodes.GETSTATIC</code> 、 <code>Opcodes.INVOKEVIRTUAL</code> ，除了这些还有小 200 个常用的指令。但这种最接近底层的方式，也是最快的方式。所以在一些使用字节码插装的全链路监控中，会非常常见。</li>
</ul>
<h3 id="4-byte-buddy代理方式"><a class="markdownIt-Anchor" href="#4-byte-buddy代理方式">#</a> 4. Byte-Buddy 代理方式</h3>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ByteBuddyProxy</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; T <span class="title function_">getProxy</span><span class="params">(Class clazz)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line">        DynamicType.Unloaded&lt;?&gt; dynamicType = <span class="keyword">new</span> <span class="title class_">ByteBuddy</span>()</span><br><span class="line">                .subclass(clazz)</span><br><span class="line">                .method(ElementMatchers.&lt;MethodDescription&gt;named(<span class="string">&quot;queryUserInfo&quot;</span>))</span><br><span class="line">                .intercept(MethodDelegation.to(InvocationHandler.class))</span><br><span class="line">                .make();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> (T) dynamicType.load(Thread.currentThread().getContextClassLoader()).getLoaded().newInstance();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RuntimeType</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">intercept</span><span class="params">(<span class="meta">@Origin</span> Method method, <span class="meta">@AllArguments</span> Object[] args, <span class="meta">@SuperCall</span> Callable&lt;?&gt; callable)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    System.out.println(method.getName() + <span class="string">&quot; 你被代理了，By Byte-Buddy！&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> callable.call();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test_ByteBuddyProxy</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="type">IUserApi</span> <span class="variable">userApi</span> <span class="operator">=</span> ByteBuddyProxy.getProxy(UserApi.class);</span><br><span class="line">    <span class="type">String</span> <span class="variable">invoke</span> <span class="operator">=</span> userApi.queryUserInfo();</span><br><span class="line">    logger.info(<span class="string">&quot;测试结果：&#123;&#125;&quot;</span>, invoke);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 测试结果：</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * queryUserInfo 你被代理了，By Byte-Buddy！</span></span><br><span class="line"><span class="comment"> * 20:19:44.498 [main] INFO  cn.brath.interview.test.ApiTest - 测试结果：面试记公众号：InterviewCoder，为了更好的你，也为了更好的世界！</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Process finished with exit code 0</span></span><br><span class="line"><span class="comment"> */</span>  </span><br></pre></td></tr></table></figure>
<hr>
<ul>
<li>指数：⭐⭐⭐⭐</li>
<li>场景：AOP 切面、类代理、组件、监控、日志</li>
<li>点评： <code>Byte Buddy</code>  也是一个字节码操作的类库，但  <code>Byte Buddy</code>  的使用方式更加简单。无需理解字节码指令，即可使用简单的 API 就能很容易操作字节码，控制类和方法。比起 JDK 动态代理、cglib，Byte Buddy 在性能上具有一定的优势。<strong>另外</strong>，2015 年 10 月，Byte Buddy 被 Oracle 授予了 Duke’s Choice 大奖。该奖项对 Byte Buddy 的 “Java 技术方面的巨大创新” 表示赞赏。</li>
</ul>
<h3 id="5-javassist代理方式"><a class="markdownIt-Anchor" href="#5-javassist代理方式">#</a> 5. Javassist 代理方式</h3>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JavassistProxy</span> <span class="keyword">extends</span> <span class="title class_">ClassLoader</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; T <span class="title function_">getProxy</span><span class="params">(Class clazz)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">ClassPool</span> <span class="variable">pool</span> <span class="operator">=</span> ClassPool.getDefault();</span><br><span class="line">        <span class="comment">// 获取类</span></span><br><span class="line">        <span class="type">CtClass</span> <span class="variable">ctClass</span> <span class="operator">=</span> pool.get(clazz.getName());</span><br><span class="line">        <span class="comment">// 获取方法</span></span><br><span class="line">        <span class="type">CtMethod</span> <span class="variable">ctMethod</span> <span class="operator">=</span> ctClass.getDeclaredMethod(<span class="string">&quot;queryUserInfo&quot;</span>);</span><br><span class="line">        <span class="comment">// 方法前加强</span></span><br><span class="line">        ctMethod.insertBefore(<span class="string">&quot;&#123;System.out.println(\&quot;&quot;</span> + ctMethod.getName() + <span class="string">&quot; 你被代理了，By Javassist\&quot;);&#125;&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">byte</span>[] bytes = ctClass.toBytecode();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> (T) <span class="keyword">new</span> <span class="title class_">JavassistProxy</span>().defineClass(clazz.getName(), bytes, <span class="number">0</span>, bytes.length).newInstance();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test_JavassistProxy</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="type">IUserApi</span> <span class="variable">userApi</span> <span class="operator">=</span> JavassistProxy.getProxy(UserApi.class)</span><br><span class="line">    <span class="type">String</span> <span class="variable">invoke</span> <span class="operator">=</span> userApi.queryUserInfo();</span><br><span class="line">    logger.info(<span class="string">&quot;测试结果：&#123;&#125;&quot;</span>, invoke);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 测试结果：</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * queryUserInfo 你被代理了，By Javassist</span></span><br><span class="line"><span class="comment"> * 20:23:39.139 [main] INFO  cn.brath.interview.test.ApiTest - 测试结果：面试记公众号：InterviewCoder，为了更好的你，也为了更好的世界！</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Process finished with exit code 0</span></span><br><span class="line"><span class="comment"> */</span></span><br></pre></td></tr></table></figure>
<hr>
<ul>
<li>指数：⭐⭐⭐⭐</li>
<li>场景：全链路监控、类代理、AOP</li>
<li>点评： <code>Javassist</code>  是一个使用非常广的字节码插装框架，几乎一大部分非入侵的全链路监控都是会选择使用这个框架。因为它不想 ASM 那样操作字节码导致风险，同时它的功能也非常齐全。另外，这个框架即可使用它所提供的方式直接编写插装代码，也可以使用字节码指令进行控制生成代码，所以综合来看也是一个非常不错的字节码框架。</li>
</ul>
<h2 id="四-总结"><a class="markdownIt-Anchor" href="#四-总结">#</a> 四、总结</h2>
<p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/interview-14-01.png" alt="img"></p>
<ul>
<li>代理的实际目的就是通过一些技术手段，替换掉原有的实现类或者给原有的实现类注入新的字节码指令。而这些技术最终都会用到一些框架应用、中间件开发以及类似非入侵的全链路监控中。</li>
<li>一个技术栈深度的学习能让你透彻的了解到一些基本的根本原理，通过这样的学习可以解惑掉一些似懂非懂的疑问，也可以通过这样技术的拓展让自己有更好的工作机会和薪资待遇。</li>
<li>这些技术学起来并不会很容易，甚至可能还有一些烧脑。但每一段值得深入学习的技术都能帮助你突破一定阶段的技术瓶颈。</li>
</ul>
<h2 id="关于我"><a class="markdownIt-Anchor" href="#关于我">#</a> 关于我</h2>
<p>Brath 是一个热爱技术的 Java 程序猿，公众号「InterviewCoder」定期分享有趣有料的精品原创文章！</p>
<p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/%E4%BA%8C%E7%BB%B4%E7%A0%81plus.png" alt="InterviewCoder"></p>
<p>非常感谢各位人才能看到这里，原创不易，文章如果有帮助可以关注、点赞、分享或评论，这都是对我的莫大支持！</p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2021-06-17T00:05:58.000Z" title="2021-6-17 8:05:58">2021-06-17</time>发表</span><span class="level-item"><time dateTime="2020-08-05T19:29:14.000Z" title="2020-8-6 3:29:14">2020-08-06</time>更新</span><span class="level-item">3 分钟读完 (大约497个字)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2021/06/17/%E3%80%90Maven%E3%80%91MVN%E5%BC%95%E5%85%A5Jar%E5%8C%85%E6%B5%81%E7%A8%8B/">Maven通过命令提示符引入jar包的流程</a></p><div class="content"><p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/%E6%89%AB%E7%A0%81_%E6%90%9C%E7%B4%A2%E8%81%94%E5%90%88%E4%BC%A0%E6%92%AD%E6%A0%B7%E5%BC%8F-%E6%A0%87%E5%87%86%E8%89%B2%E7%89%88.png" alt="InterviewCoder"></p>
<p>安装好 Maven 之后配置环境变量：</p>
<p>​		在系统变量新建 “MAVEN_HOME” 值为：Maven 的安装路径：<strong>E:\Maven\apache-maven-3.5.3</strong>，接着在 Path 变量中，添加：% MAVEN_HOME%\bin，指定 maven 的 bin 路径。</p>
<p>​		现在在 CMD 中就可以用 mvn -v 的命令查看是否安装成功：</p>
<p><img src="f:%5Cmd%E5%9B%BE%E7%89%87%5Cmaven%E7%8E%AF%E5%A2%83.png" alt="maven环境"></p>
<h3 id="引入流程"><a class="markdownIt-Anchor" href="#引入流程">#</a> 引入流程：</h3>
<p>​		接下来找到你要引入的 jar 包的根路径，指定路径 + jar 包名，指定 groupId、artifactId、version 名，就可以引入了。</p>
<h4 id="举例"><a class="markdownIt-Anchor" href="#举例">#</a> 举例:</h4>
<p>​		mvn install:install-file -Dfile=D:\jar\WxQyhPrj\0.0.1-SNAPSHOT\WxQyhPrj-0.0.1-SNAPSHOT.jar -DgroupId=com.chis.wx -DartifactId=WxQyhPrj -Dversion=0.0.1-SNAPSHOT -Dpackaging=jar</p>
<p>​		mvn install:install-file -Dfile：Jar 包的绝对路径</p>
<p>​		-DgroupId：Jar 包的 groupId 分组 id</p>
<p>​		-DartiactId：Jar 包的 artifactId 版本 id</p>
<p>​		-Dversion：Jar 包的 version 版本</p>
<p>其中<br>
– DgroupId 和 DartifactId 构成了该 jar 包在 pom.xml 的坐标， 对应依赖的 DgroupId 和 DartifactId</p>
<p>– Dfile 表示需要上传的 jar 包的绝对路径</p>
<p>– Dpackaging 为安装文件的种类</p>
<p>– DgroupId 和 DartifactId 构成了该 jar 包在 pom.xml 的坐标， 对应依赖的 DgroupId 和 DartifactId</p>
<p>– Dfile 表示需要上传的 jar 包的绝对路径</p>
<p>– Durl 私服上仓库的 url 精确地址 (打开 nexus 左侧 repositories 菜单，可以看到该路径)</p>
<p>– DrepositoryId 服务器的表示 id，在 nexus 的 configuration 可以看到</p>
<h2 id="关于我"><a class="markdownIt-Anchor" href="#关于我">#</a> 关于我</h2>
<p>Brath 是一个热爱技术的 Java 程序猿，公众号「InterviewCoder」定期分享有趣有料的精品原创文章！</p>
<p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/%E4%BA%8C%E7%BB%B4%E7%A0%81plus.png" alt="InterviewCoder"></p>
<p>非常感谢各位人才能看到这里，原创不易，文章如果有帮助可以关注、点赞、分享或评论，这都是对我的莫大支持！</p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2021-06-15T23:57:34.000Z" title="2021-6-16 7:57:34">2021-06-16</time>发表</span><span class="level-item"><time dateTime="2022-10-16T08:39:22.000Z" title="2022-10-16 16:39:22">2022-10-16</time>更新</span><span class="level-item">4 分钟读完 (大约611个字)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2021/06/16/%E3%80%90SpringCloudAlibaba%E3%80%91Seata%E9%83%A8%E7%BD%B2Linux%E6%96%87%E6%A1%A3/">Linux以及Windows部署Seata服务</a></p><div class="content"><p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/%E6%89%AB%E7%A0%81_%E6%90%9C%E7%B4%A2%E8%81%94%E5%90%88%E4%BC%A0%E6%92%AD%E6%A0%B7%E5%BC%8F-%E6%A0%87%E5%87%86%E8%89%B2%E7%89%88.png" alt="InterviewCoder"></p>
<p>1. 确保 linux 有 Nacos 正常启动，并知晓正确的端口 用户名 密码</p>
<ol start="2">
<li><a target="_blank" rel="noopener" href="https://github.com/seata/seata.git">https://github.com/seata/seata.git</a> 克隆 seata 项目到本地</li>
<li>在 Github 下载对应你项目 SpringCloudAlibaba 建议版本的 Seata，我的版本是 2.5.5，建议 Seata 版本 1.3.0</li>
<li>下载好后进入 seata/conf 配置目录，修改 file.conf</li>
</ol>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">## transaction log store<span class="punctuation">,</span> only used in seata-server</span><br><span class="line">store <span class="punctuation">&#123;</span></span><br><span class="line">  ## store mode<span class="punctuation">:</span> file、db、redis</span><br><span class="line">  mode = <span class="string">&quot;db&quot;</span> #如果单机：file 如果是集群：db  并在下方配置你的Mysql数据源</span><br><span class="line"></span><br><span class="line">  ## file store property</span><br><span class="line">  file <span class="punctuation">&#123;</span></span><br><span class="line">    ## store location dir</span><br><span class="line">    dir = <span class="string">&quot;sessionStore&quot;</span></span><br><span class="line">    # branch session size <span class="punctuation">,</span> if exceeded first try compress lockkey<span class="punctuation">,</span> still exceeded throws exceptions</span><br><span class="line">    maxBranchSessionSize = <span class="number">16384</span></span><br><span class="line">    # globe session size <span class="punctuation">,</span> if exceeded throws exceptions</span><br><span class="line">    maxGlobalSessionSize = <span class="number">512</span></span><br><span class="line">    # file buffer size <span class="punctuation">,</span> if exceeded allocate new buffer</span><br><span class="line">    fileWriteBufferCacheSize = <span class="number">16384</span></span><br><span class="line">    # when recover batch read size</span><br><span class="line">    sessionReloadReadSize = <span class="number">100</span></span><br><span class="line">    # async<span class="punctuation">,</span> sync</span><br><span class="line">    flushDiskMode = async</span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"></span><br><span class="line">  ## database store property</span><br><span class="line">  db <span class="punctuation">&#123;</span></span><br><span class="line">    ## the implement of javax.sql.DataSource<span class="punctuation">,</span> such as DruidDataSource(druid)/BasicDataSource(dbcp)/HikariDataSource(hikari) etc.</span><br><span class="line">    datasource = <span class="string">&quot;druid&quot;</span></span><br><span class="line">    ## mysql/oracle/postgresql/h2/oceanbase etc.</span><br><span class="line">    dbType = <span class="string">&quot;mysql&quot;</span></span><br><span class="line">    driverClassName = <span class="string">&quot;com.mysql.jdbc.Driver&quot;</span></span><br><span class="line">    url = <span class="string">&quot;jdbc:mysql://sh-cynosdbmysql-grp-o5n8fbw2.sql.tencentcdb.com:20345/seata_server&quot;</span></span><br><span class="line">    user = <span class="string">&quot;brath&quot;</span></span><br><span class="line">    password = <span class="string">&quot;Lgq081538&quot;</span></span><br><span class="line">    minConn = <span class="number">5</span></span><br><span class="line">    maxConn = <span class="number">30</span></span><br><span class="line">    globalTable = <span class="string">&quot;global_table&quot;</span></span><br><span class="line">    branchTable = <span class="string">&quot;branch_table&quot;</span></span><br><span class="line">    lockTable = <span class="string">&quot;lock_table&quot;</span></span><br><span class="line">    queryLimit = <span class="number">100</span></span><br><span class="line">    maxWait = <span class="number">5000</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<p>5. 修改 registry.conf</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">registry <span class="punctuation">&#123;</span></span><br><span class="line">  type = <span class="string">&quot;nacos&quot;</span>  <span class="comment">//配置nacos</span></span><br><span class="line"></span><br><span class="line">  nacos <span class="punctuation">&#123;</span></span><br><span class="line">    application = <span class="string">&quot;seata-server&quot;</span></span><br><span class="line">    serverAddr = <span class="string">&quot;nacosip+端口&quot;</span> <span class="comment">//nacosip+端口</span></span><br><span class="line">    group = <span class="string">&quot;SEATA_GROUP&quot;</span></span><br><span class="line">    namespace = <span class="string">&quot;命名空间&quot;</span> <span class="comment">//如果默认可以不填</span></span><br><span class="line">    cluster = <span class="string">&quot;default&quot;</span> <span class="comment">//如果是集群请填写集群名</span></span><br><span class="line">    username = <span class="string">&quot;账号&quot;</span></span><br><span class="line">    password = <span class="string">&quot;密码&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line">  file <span class="punctuation">&#123;</span></span><br><span class="line">    name = <span class="string">&quot;file.conf&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"></span><br><span class="line">config <span class="punctuation">&#123;</span></span><br><span class="line">  type = <span class="string">&quot;nacos&quot;</span></span><br><span class="line"></span><br><span class="line">  nacos <span class="punctuation">&#123;</span></span><br><span class="line">    serverAddr = <span class="string">&quot;nacosip+端口&quot;</span> <span class="comment">//nacosip+端口</span></span><br><span class="line">    namespace = <span class="string">&quot;命名空间&quot;</span> <span class="comment">//如果默认可以不填</span></span><br><span class="line">    group = <span class="string">&quot;SEATA_GROUP&quot;</span></span><br><span class="line">    username = <span class="string">&quot;账号&quot;</span></span><br><span class="line">    password = <span class="string">&quot;密码&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line">  </span><br><span class="line">  file <span class="punctuation">&#123;</span></span><br><span class="line">    name = <span class="string">&quot;file.conf&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>6. 在克隆好的项目中找到 script/confing-center 找到 config.txt 文件</p>
<p>修改</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">store.mode=db</span><br></pre></td></tr></table></figure>
<p>修改数据源</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">store.db.url=localhost:3306/seata_server?useUnicode=true&amp;rewriteBatchedStatements=true</span><br><span class="line">store.db.user=****</span><br><span class="line">store.db.password=****</span><br></pre></td></tr></table></figure>
<p>进入 script\config-center\nacos</p>
<p>如果是 windows 系统请确保安装了 GIT 以及 GIT bash</p>
<p><a target="_blank" rel="noopener" href="http://xn--nacos-config-wm5t9655a.sh">点击 nacos-config.sh</a> 会自动把 config.txt 配置文件，配置到你的 Nacos 客户端中指定命名空间的配置中心供你的 Seata 使用</p>
<p>7. 进入 Seata/bin</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sh seata-server.sh #启动seata服务</span><br></pre></td></tr></table></figure>
<h2 id="关于我"><a class="markdownIt-Anchor" href="#关于我">#</a> 关于我</h2>
<p>Brath 是一个热爱技术的 Java 程序猿，公众号「InterviewCoder」定期分享有趣有料的精品原创文章！</p>
<p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/%E4%BA%8C%E7%BB%B4%E7%A0%81plus.png" alt="InterviewCoder"></p>
<p>非常感谢各位人才能看到这里，原创不易，文章如果有帮助可以关注、点赞、分享或评论，这都是对我的莫大支持！</p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2021-06-14T00:22:20.000Z" title="2021-6-14 8:22:20">2021-06-14</time>发表</span><span class="level-item"><time dateTime="2023-05-09T00:29:23.926Z" title="2023-5-9 8:29:23">2023-05-09</time>更新</span><span class="level-item">1 小时读完 (大约10620个字)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2021/06/14/%E3%80%90Java%E3%80%91Java%E5%A4%9A%E7%BA%BF%E7%A8%8B%E5%AD%A6%E4%B9%A0(%E5%90%90%E8%A1%80%E8%B6%85%E8%AF%A6%E7%BB%86%E6%80%BB%E7%BB%93)/">Java多线程学习（吐血超详细总结）</a></p><div class="content"><p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/%E6%89%AB%E7%A0%81_%E6%90%9C%E7%B4%A2%E8%81%94%E5%90%88%E4%BC%A0%E6%92%AD%E6%A0%B7%E5%BC%8F-%E6%A0%87%E5%87%86%E8%89%B2%E7%89%88.png" alt="InterviewCoder"></p>
<h1 id="java多线程学习吐血超详细总结"><a class="markdownIt-Anchor" href="#java多线程学习吐血超详细总结">#</a> Java 多线程学习（吐血超详细总结）</h1>
<p>写在前面的话：此文只能说是 java<a target="_blank" rel="noopener" href="https://so.csdn.net/so/search?q=%E5%A4%9A%E7%BA%BF%E7%A8%8B&amp;spm=1001.2101.3001.7020"> 多线程</a>的一个入门，其实 Java 里头线程完全可以写一本书了，但是如果最基本的你都学掌握好，又怎么能更上一个台阶呢？如果你觉得此文很简单，那推荐你看看 Java 并发包的的线程池（<a target="_blank" rel="noopener" href="http://blog.csdn.net/evankaka/article/details/51489322">Java 并发编程与技术内幕：线程池深入理解</a>），或者看这个专栏：<a target="_blank" rel="noopener" href="http://blog.csdn.net/column/details/javahhighconcurrence.html">Java 并发编程与技术内幕</a>。你将会对 Java 里头的高并发场景下的线程有更加深刻的理解。</p>
<p>目录<a target="_blank" rel="noopener" href="http://blog.csdn.net/evankaka/article/details/44153709#"> (?)</a>[<a target="_blank" rel="noopener" href="http://blog.csdn.net/evankaka/article/details/44153709#">-]</a></p>
<ol>
<li><a target="_blank" rel="noopener" href="http://blog.csdn.net/evankaka/article/details/44153709#t0">一扩展 javalangThread 类</a></li>
<li><a target="_blank" rel="noopener" href="http://blog.csdn.net/evankaka/article/details/44153709#t1">二实现 javalangRunnable 接口</a></li>
<li><a target="_blank" rel="noopener" href="http://blog.csdn.net/evankaka/article/details/44153709#t2">三 Thread 和 Runnable 的区别</a></li>
<li><a target="_blank" rel="noopener" href="http://blog.csdn.net/evankaka/article/details/44153709#t3">四线程状态转换</a></li>
<li><a target="_blank" rel="noopener" href="http://blog.csdn.net/evankaka/article/details/44153709#t4">五线程调度</a></li>
<li><a target="_blank" rel="noopener" href="http://blog.csdn.net/evankaka/article/details/44153709#t5">六常用函数说明</a></li>
<li>
<ol>
<li><a target="_blank" rel="noopener" href="http://blog.csdn.net/evankaka/article/details/44153709#t6">使用方式</a></li>
<li><a target="_blank" rel="noopener" href="http://blog.csdn.net/evankaka/article/details/44153709#t7">为什么要用 join 方法</a></li>
</ol>
</li>
<li><a target="_blank" rel="noopener" href="http://blog.csdn.net/evankaka/article/details/44153709#t8">七常见线程名词解释</a></li>
<li><a target="_blank" rel="noopener" href="http://blog.csdn.net/evankaka/article/details/44153709#t9">八线程同步</a></li>
<li><a target="_blank" rel="noopener" href="http://blog.csdn.net/evankaka/article/details/44153709#t10">九线程数据传递</a></li>
</ol>
<p>​    本文主要讲了 java 中多线程的使用方法、线程同步、线程数据传递、线程状态及相应的一些线程函数用法、概述等。在这之前，首先让我们来了解下在操作系统中进程和线程的区别：</p>
<p><strong>进程：每个进程都有独立的代码和数据空间（进程上下文），进程间的切换会有较大的开销，一个进程包含 1–n 个线程。（进程是资源分配的最小单位）</strong></p>
<p><strong>线程：同一类线程共享代码和数据空间，每个线程有独立的运行栈和程序计数器 (PC)，线程切换开销小。（线程是 cpu 调度的最小单位）</strong></p>
<p>线程和进程一样分为五个阶段：创建、就绪、运行、阻塞、终止。</p>
<p>多进程是指操作系统能同时运行多个任务（程序）。</p>
<p>多线程是指在同一程序中有多个顺序流在执行。</p>
<p>在<em> java</em> 中要想实现多线程，有两种手段，一种是继续<em> Thread</em> 类，另外一种是实现<em> Runable</em> 接口.(<strong>其实准确来讲，应该有三种，还有一种是实现 Callable 接口</strong>，并与 Future、线程池结合使用，此文这里不讲这个，有兴趣看这里<a target="_blank" rel="noopener" href="http://blog.csdn.net/evankaka/article/details/51610635"> Java 并发编程与技术内幕：Callable、Future、FutureTask、CompletionService</a> )</p>
<h1 id="一-扩展javalangthread类"><a class="markdownIt-Anchor" href="#一-扩展javalangthread类">#</a> 一、扩展 java.lang.Thread 类</h1>
<p>这里继承 Thread 类的方法是比较常用的一种，如果说你只是想起一条线程。没有什么其它特殊的要求，那么可以使用 Thread.（<strong>笔者推荐使用 Runable，后头会说明为什么</strong>）。下面来看一个简单的实例</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.multithread.learning;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Thread1</span> <span class="keyword">extends</span> <span class="title class_">Thread</span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> String name;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Thread1</span><span class="params">(String name)</span> &#123;</span><br><span class="line"></span><br><span class="line">       <span class="built_in">this</span>.name=name;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">5</span>; i++) &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            System.out.println(name + <span class="string">&quot;运行  :  &quot;</span> + i);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">                sleep((<span class="type">int</span>) Math.random() * <span class="number">10</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">                e.printStackTrace();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">       </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Main</span> &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">		Thread1 mTh1=<span class="keyword">new</span> <span class="title class_">Thread1</span>(<span class="string">&quot;A&quot;</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">		Thread1 mTh2=<span class="keyword">new</span> <span class="title class_">Thread1</span>(<span class="string">&quot;B&quot;</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">		mTh1.start();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">		mTh2.start();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>输出：</p>
<p>A 运行 : 0<br>
B 运行 : 0<br>
A 运行 : 1<br>
A 运行 : 2<br>
A 运行 : 3<br>
A 运行 : 4<br>
B 运行 : 1<br>
B 运行 : 2<br>
B 运行 : 3<br>
B 运行 : 4</p>
<p>再运行一下：</p>
<p>A 运行 : 0<br>
B 运行 : 0<br>
B 运行 : 1<br>
B 运行 : 2<br>
B 运行 : 3<br>
B 运行 : 4<br>
A 运行 : 1<br>
A 运行 : 2<br>
A 运行 : 3<br>
A 运行 : 4</p>
<p>说明：</p>
<p>程序启动运行 main 时候，java 虚拟机启动一个进程，主线程 main 在 main () 调用时候被创建。随着调用 MitiSay 的两个对象的 start 方法，另外两个线程也启动了，这样，整个应用就在多线程下运行。</p>
<p>注意：start () 方法的调用后并不是立即执行多线程代码，而是使得该线程变为可运行态（Runnable），什么时候运行是由操作系统决定的。</p>
<p>从程序运行的结果可以发现，多线程程序是乱序执行。因此，只有乱序执行的代码才有必要设计为多线程。</p>
<p>Thread.sleep () 方法调用目的是不让当前线程独自霸占该进程所获取的 CPU 资源，以留出一定时间给其他线程执行的机会。</p>
<p>实际上所有的多线程代码执行顺序都是不确定的，每次执行的结果都是随机的。</p>
<p>但是 start 方法重复调用的话，会出现 java.lang.IllegalThreadStateException 异常。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">Thread1 mTh1=<span class="keyword">new</span> <span class="title class_">Thread1</span>(<span class="string">&quot;A&quot;</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Thread1 mTh2=mTh1;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">mTh1.start();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">mTh2.start();</span><br></pre></td></tr></table></figure>
<p>输出：</p>
<p>Exception in thread “main” java.lang.IllegalThreadStateException<br>
at java.lang.Thread.start(Unknown Source)<br>
at com.multithread.learning.Main.main(Main.java:31)<br>
 A 运行 : 0<br>
A 运行 : 1<br>
A 运行 : 2<br>
A 运行 : 3<br>
A 运行 : 4</p>
<h1 id="二-实现javalangrunnable接口"><a class="markdownIt-Anchor" href="#二-实现javalangrunnable接口">#</a> 二、实现 java.lang.Runnable 接口</h1>
<p>采用 Runnable 也是非常常见的一种，我们只需要重写 run 方法即可。下面也来看个实例。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"> *<span class="doctag">@functon</span> 多线程学习</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"> *<span class="doctag">@author</span> 林炳文</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"> *<span class="doctag">@time</span> 2015.3.9</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">package</span> com.multithread.runnable;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Thread2</span> <span class="keyword">implements</span> <span class="title class_">Runnable</span>&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> String name;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="title function_">Thread2</span><span class="params">(String name)</span> &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">		<span class="built_in">this</span>.name=name;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">		  <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">5</span>; i++) &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	            System.out.println(name + <span class="string">&quot;运行  :  &quot;</span> + i);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	            <span class="keyword">try</span> &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	            	Thread.sleep((<span class="type">int</span>) Math.random() * <span class="number">10</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	                e.printStackTrace();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	            &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">		</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Main</span> &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">		<span class="keyword">new</span> <span class="title class_">Thread</span>(<span class="keyword">new</span> <span class="title class_">Thread2</span>(<span class="string">&quot;C&quot;</span>)).start();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">		<span class="keyword">new</span> <span class="title class_">Thread</span>(<span class="keyword">new</span> <span class="title class_">Thread2</span>(<span class="string">&quot;D&quot;</span>)).start();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>输出：</p>
<p>C 运行 : 0<br>
D 运行 : 0<br>
D 运行 : 1<br>
C 运行 : 1<br>
D 运行 : 2<br>
C 运行 : 2<br>
D 运行 : 3<br>
C 运行 : 3<br>
D 运行 : 4<br>
C 运行 : 4</p>
<p>说明：</p>
<p>Thread2 类通过实现 Runnable 接口，使得该类有了多线程类的特征。run（）方法是多线程程序的一个约定。所有的多线程代码都在 run 方法里面。Thread 类实际上也是实现了 Runnable 接口的类。</p>
<p>在启动的多线程的时候，需要先通过 Thread 类的构造方法 Thread (Runnable target) 构造出对象，然后调用 Thread 对象的 start () 方法来运行多线程代码。</p>
<p>实际上所有的多线程代码都是通过运行 Thread 的 start () 方法来运行的。因此，不管是扩展 Thread 类还是实现 Runnable 接口来实现多线程，最终还是通过 Thread 的对象的 API 来控制线程的，熟悉 Thread 类的 API 是进行多线程编程的基础。</p>
<h1 id="三-thread和runnable的区别"><a class="markdownIt-Anchor" href="#三-thread和runnable的区别">#</a> 三、Thread 和 Runnable 的区别</h1>
<p>如果一个类继承 Thread，则不适合资源共享。但是如果实现了 Runable 接口的话，则很容易的实现资源共享。</p>
<p>** 总结：<br>
**</p>
<p><strong>实现 Runnable 接口比继承 Thread 类所具有的优势：</strong></p>
<p><strong>1）：适合多个相同的程序代码的线程去处理同一个资源</strong></p>
<p><strong>2）：可以避免 java 中的单继承的限制</strong></p>
<p><strong>3）：增加程序的健壮性，代码可以被多个线程共享，代码和数据独立</strong></p>
<p><strong>4）：线程池只能放入实现 Runable 或 callable 类线程，不能直接放入继承 Thread 的类</strong></p>
<p><strong><em>* 提醒一下大家：*</em>*<em>main*</em>*<em> 方法其实也是一个线程。在 *</em>*<em>java*</em>*<em> 中所以的线程都是同时启动的，至于什么时候，哪个先执行，完全看谁先得到 *</em>*<em>CPU*</em>*<em> 的资源。*</em></strong></p>
<p><strong>在<strong><strong> java</strong></strong> 中，每次程序运行至少启动<strong><strong> 2</strong></strong> 个线程。一个是<strong><strong> main</strong></strong> 线程，一个是垃圾收集线程。因为每当使用<strong><strong> java</strong></strong> 命令执行一个类的时候，实际上都会启动一个ＪＶＭ，每一个ｊＶＭ实习在就是在操作系统中启动了一个进程。</strong></p>
<h1 id="四-线程状态转换"><a class="markdownIt-Anchor" href="#四-线程状态转换">#</a> 四、线程状态转换</h1>
<p>下面的这个图非常重要！你如果看懂了这个图，那么对于多线程的理解将会更加深刻！</p>
<p><img src="https://img-blog.csdn.net/20150309140927553" alt="img"></p>
<p>1、新建状态（New）：新创建了一个线程对象。</p>
<p>2、就绪状态（Runnable）：线程对象创建后，其他线程调用了该对象的 start () 方法。该状态的线程位于可运行线程池中，变得可运行，等待获取 CPU 的使用权。</p>
<p>3、运行状态（Running）：就绪状态的线程获取了 CPU，执行程序代码。</p>
<p><strong>4、阻塞状态（Blocked）：阻塞状态是线程因为某种原因放弃 CPU 使用权，暂时停止运行。直到线程进入就绪状态，才有机会转到运行状态。阻塞的情况分三种：</strong></p>
<p><strong>（一）、等待阻塞：运行的线程执行 wait () 方法，JVM 会把该线程放入等待池中。(wait 会释放持有的锁)</strong></p>
<p><strong>（二）、同步阻塞：运行的线程在获取对象的同步锁时，若该同步锁被别的线程占用，则 JVM 会把该线程放入锁池中。</strong></p>
<p><strong>（三）、其他阻塞：运行的线程执行 sleep () 或 join () 方法，或者发出了 I/O 请求时，JVM 会把该线程置为阻塞状态。当 sleep () 状态超时、join () 等待线程终止或者超时、或者 I/O 处理完毕时，线程重新转入就绪状态。（注意，sleep 是不会释放持有的锁）</strong></p>
<p>5、死亡状态（Dead）：线程执行完了或者因异常退出了 run () 方法，该线程结束生命周期。</p>
<h1 id="五-线程调度"><a class="markdownIt-Anchor" href="#五-线程调度">#</a> 五、线程调度</h1>
<p>线程的调度</p>
<p>1、调整线程优先级：Java 线程有优先级，优先级高的线程会获得较多的运行机会。</p>
<p>Java 线程的优先级用整数表示，取值范围是 1~10，Thread 类有以下三个静态常量：</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="type">int</span> MAX_PRIORITY</span><br><span class="line">          线程可以具有的最高优先级，取值为<span class="number">10</span>。</span><br><span class="line"><span class="keyword">static</span> <span class="type">int</span> MIN_PRIORITY</span><br><span class="line">          线程可以具有的最低优先级，取值为<span class="number">1</span>。</span><br><span class="line"><span class="keyword">static</span> <span class="type">int</span> NORM_PRIORITY</span><br><span class="line">          分配给线程的默认优先级，取值为<span class="number">5</span>。</span><br></pre></td></tr></table></figure>
<p>Thread 类的 setPriority () 和 getPriority () 方法分别用来设置和获取线程的优先级。</p>
<p>每个线程都有默认的优先级。主线程的默认优先级为 Thread.NORM_PRIORITY。</p>
<p>线程的优先级有继承关系，比如 A 线程中创建了 B 线程，那么 B 将和 A 具有相同的优先级。</p>
<p>JVM 提供了 10 个线程优先级，但与常见的操作系统都不能很好的映射。如果希望程序能移植到各个操作系统中，应该仅仅使用 Thread 类有以下三个静态常量作为优先级，这样能保证同样的优先级采用了同样的调度方式。</p>
<p>2、线程睡眠：Thread.sleep (long millis) 方法，使线程转到阻塞状态。millis 参数设定睡眠的时间，以毫秒为单位。当睡眠结束后，就转为就绪（Runnable）状态。sleep () 平台移植性好。</p>
<p>3、线程等待：Object 类中的 wait () 方法，导致当前的线程等待，直到其他线程调用此对象的 notify () 方法或 notifyAll () 唤醒方法。这个两个唤醒方法也是 Object 类中的方法，行为等价于调用 wait (0) 一样。</p>
<p>4、线程让步：Thread.yield () 方法，暂停当前正在执行的线程对象，把执行机会让给相同或者更高优先级的线程。</p>
<p>5、线程加入：join () 方法，等待其他线程终止。在当前线程中调用另一个线程的 join () 方法，则当前线程转入阻塞状态，直到另一个进程运行结束，当前线程再由阻塞转为就绪状态。</p>
<p>6、线程唤醒：Object 类中的 notify () 方法，唤醒在此对象监视器上等待的单个线程。如果所有线程都在此对象上等待，则会选择唤醒其中一个线程。选择是任意性的，并在对实现做出决定时发生。线程通过调用其中一个 wait 方法，在对象的监视器上等待。 直到当前的线程放弃此对象上的锁定，才能继续执行被唤醒的线程。被唤醒的线程将以常规方式与在该对象上主动同步的其他所有线程进行竞争；例如，唤醒的线程在作为锁定此对象的下一个线程方面没有可靠的特权或劣势。类似的方法还有一个 notifyAll ()，唤醒在此对象监视器上等待的所有线程。</p>
<p>注意：Thread 中 suspend () 和 resume () 两个方法在 JDK1.5 中已经废除，不再介绍。因为有死锁倾向。</p>
<h1 id="六-常用函数说明"><a class="markdownIt-Anchor" href="#六-常用函数说明">#</a> 六、常用函数说明</h1>
<p>**①sleep (long millis): 在指定的毫秒数内让当前正在执行的线程休眠（暂停执行）</p>
<p>②join (): 指等待 t 线程终止。**</p>
<h3 id="使用方式"><a class="markdownIt-Anchor" href="#使用方式">#</a> 使用方式。</h3>
<p>join 是 Thread 类的一个方法，启动线程后直接调用，即 join () 的作用是：“等待该线程终止”，这里需要理解的就是该线程是指的主线程等待子线程的终止。也就是在子线程调用了 join () 方法后面的代码，只有等到子线程结束了才能执行。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Thread</span> <span class="variable">t</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AThread</span>(); t.start(); t.join();</span><br></pre></td></tr></table></figure>
<h3 id="为什么要用join方法"><a class="markdownIt-Anchor" href="#为什么要用join方法">#</a> 为什么要用 join () 方法</h3>
<p>在很多情况下，主线程生成并起动了子线程，如果子线程里要进行大量的耗时的运算，主线程往往将于子线程之前结束，但是如果主线程处理完其他的事务后，需要用到子线程的处理结果，也就是主线程需要等待子线程执行完成之后再结束，这个时候就要用到 join () 方法了。</p>
<p>不加 join。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"> *<span class="doctag">@functon</span> 多线程学习,join</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"> *<span class="doctag">@author</span> 林炳文</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"> *<span class="doctag">@time</span> 2015.3.9</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">package</span> com.multithread.join;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Thread1</span> <span class="keyword">extends</span> <span class="title class_">Thread</span>&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> String name;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Thread1</span><span class="params">(String name)</span> &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    	<span class="built_in">super</span>(name);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">       <span class="built_in">this</span>.name=name;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">		System.out.println(Thread.currentThread().getName() + <span class="string">&quot; 线程运行开始!&quot;</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">5</span>; i++) &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            System.out.println(<span class="string">&quot;子线程&quot;</span>+name + <span class="string">&quot;运行 : &quot;</span> + i);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">                sleep((<span class="type">int</span>) Math.random() * <span class="number">10</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">                e.printStackTrace();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        System.out.println(Thread.currentThread().getName() + <span class="string">&quot; 线程运行结束!&quot;</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Main</span> &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">		System.out.println(Thread.currentThread().getName()+<span class="string">&quot;主线程运行开始!&quot;</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">		Thread1 mTh1=<span class="keyword">new</span> <span class="title class_">Thread1</span>(<span class="string">&quot;A&quot;</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">		Thread1 mTh2=<span class="keyword">new</span> <span class="title class_">Thread1</span>(<span class="string">&quot;B&quot;</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">		mTh1.start();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">		mTh2.start();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">		System.out.println(Thread.currentThread().getName()+ <span class="string">&quot;主线程运行结束!&quot;</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"> </span><br></pre></td></tr></table></figure>
<p>输出结果：<br>
main 主线程运行开始！<br>
main 主线程运行结束！<br>
B 线程运行开始！<br>
 子线程 B 运行 : 0<br>
A 线程运行开始！<br>
 子线程 A 运行 : 0<br>
 子线程 B 运行 : 1<br>
 子线程 A 运行 : 1<br>
 子线程 A 运行 : 2<br>
 子线程 A 运行 : 3<br>
 子线程 A 运行 : 4<br>
A 线程运行结束！<br>
 子线程 B 运行 : 2<br>
 子线程 B 运行 : 3<br>
 子线程 B 运行 : 4<br>
B 线程运行结束！<br>
 发现主线程比子线程早结束</p>
<p>加 join</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Main</span> &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">		System.out.println(Thread.currentThread().getName()+<span class="string">&quot;主线程运行开始!&quot;</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">		Thread1 mTh1=<span class="keyword">new</span> <span class="title class_">Thread1</span>(<span class="string">&quot;A&quot;</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">		Thread1 mTh2=<span class="keyword">new</span> <span class="title class_">Thread1</span>(<span class="string">&quot;B&quot;</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">		mTh1.start();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">		mTh2.start();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">			mTh1.join();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">		&#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">			e.printStackTrace();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">			mTh2.join();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">		&#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">			e.printStackTrace();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">		System.out.println(Thread.currentThread().getName()+ <span class="string">&quot;主线程运行结束!&quot;</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>运行结果：<br>
main 主线程运行开始！<br>
A 线程运行开始！<br>
 子线程 A 运行 : 0<br>
B 线程运行开始！<br>
 子线程 B 运行 : 0<br>
 子线程 A 运行 : 1<br>
 子线程 B 运行 : 1<br>
 子线程 A 运行 : 2<br>
 子线程 B 运行 : 2<br>
 子线程 A 运行 : 3<br>
 子线程 B 运行 : 3<br>
 子线程 A 运行 : 4<br>
 子线程 B 运行 : 4<br>
A 线程运行结束！<br>
 主线程一定会等子线程都结束了才结束</p>
<p><strong>③yield (): 暂停当前正在执行的线程对象，并执行其他线程。</strong></p>
<p>​    Thread.yield () 方法作用是：暂停当前正在执行的线程对象，并执行其他线程。</p>
<p>​      ****yield () 应该做的是让当前运行线程回到可运行状态，以允许具有相同优先级的其他线程获得运行机会。**** 因此，使用 yield () 的目的是让相同优先级的线程之间能适当的轮转执行。但是，实际中无法保证 yield () 达到让步目的，因为让步的线程还有可能被线程调度程序再次选中。</p>
<p>结论：yield () 从未导致线程转到等待 / 睡眠 / 阻塞状态。在大多数情况下，yield () 将导致线程从运行状态转到可运行状态，但有可能没有效果。可看上面的图。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"> *@functon 多线程学习 yield</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"> *@author 林炳文</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"> *@time 2015.3.9</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">package com.multithread.yield;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ThreadYield</span> extends Thread&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ThreadYield</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="built_in">super</span>(name);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    @<span class="function">Override</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">    <span class="keyword">public</span> <span class="type">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">1</span>; i &lt;= <span class="number">50</span>; i++) &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            System.out.<span class="built_in">println</span>(<span class="string">&quot;&quot;</span> + <span class="keyword">this</span>.<span class="built_in">getName</span>() + <span class="string">&quot;-----&quot;</span> + i);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            <span class="comment">// 当i为30时，该线程就会把CPU时间让掉，让其他或者自己的线程执行（也就是谁先抢到谁执行）</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (i ==<span class="number">30</span>) &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">                <span class="keyword">this</span>.<span class="built_in">yield</span>();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Main</span> &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="type">static</span> <span class="type">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">		</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">		ThreadYield yt1 = <span class="keyword">new</span> <span class="built_in">ThreadYield</span>(<span class="string">&quot;张三&quot;</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    	ThreadYield yt2 = <span class="keyword">new</span> <span class="built_in">ThreadYield</span>(<span class="string">&quot;李四&quot;</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        yt1.<span class="built_in">start</span>();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        yt2.<span class="built_in">start</span>();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>运行结果：</p>
<p>第一种情况：李四（线程）当执行到 30 时会 CPU 时间让掉，这时张三（线程）抢到 CPU 时间并执行。</p>
<p>第二种情况：李四（线程）当执行到 30 时会 CPU 时间让掉，这时李四（线程）抢到 CPU 时间并执行。</p>
<p><strong>sleep () 和 yield () 的区别</strong><br>
 sleep () 和 yield () 的区别):sleep () 使当前线程进入停滞状态，所以执行 sleep () 的线程在指定的时间内肯定不会被执行；yield () 只是使当前线程重新回到可执行状态，所以执行 yield () 的线程有可能在进入到可执行状态后马上又被执行。<br>
sleep 方法使当前运行中的线程睡眼一段时间，进入不可运行状态，这段时间的长短是由程序设定的，yield 方法使当前线程让出 CPU 占有权，但让出的时间是不可设定的。实际上，yield () 方法对应了如下操作：先检测当前是否有相同优先级的线程处于同可运行状态，如有，则把 CPU 的占有权交给此线程，否则，继续运行原来的线程。所以 yield () 方法称为 “退让”，它把运行机会让给了同等优先级的其他线程<br>
另外，sleep 方法允许较低优先级的线程获得运行机会，但 yield () 方法执行时，当前线程仍处在可运行状态，所以，不可能让出较低优先级的线程些时获得 CPU 占有权。在一个运行系统中，如果较高优先级的线程没有调用 sleep 方法，又没有受到 I\O 阻塞，那么，较低优先级线程只能等待所有较高优先级的线程运行结束，才有机会运行。</p>
<p><strong>④setPriority (): 更改线程的优先级。</strong></p>
<p>MIN_PRIORITY = 1<br>
　　  NORM_PRIORITY = 5<br>
MAX_PRIORITY = 10</p>
<p>用法：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Thread4 t1 = new Thread4(&quot;t1&quot;);</span><br><span class="line">Thread4 t2 = new Thread4(&quot;t2&quot;);</span><br><span class="line">t1.setPriority(Thread.MAX_PRIORITY);</span><br><span class="line">t2.setPriority(Thread.MIN_PRIORITY);</span><br></pre></td></tr></table></figure>
<p><strong><em>*⑤interrupt (): 不要以为它是中断某个线程！它只是线线程发送一个中断信号，让线程在无限等待时（如死锁时）能抛出抛出，从而结束线程，但是如果你吃掉了这个异常，那么 *</em>*<em> 这个线程还是不会中断的！*</em></strong></p>
<p>⑥wait()</p>
<p>Obj.wait ()，与 Obj.notify () 必须要与 synchronized (Obj) 一起使用，也就是 wait, 与 notify 是针对已经获取了 Obj 锁进行操作，从语法角度来说就是 Obj.wait (),Obj.notify 必须在 synchronized (Obj){…} 语句块内。从功能上来说 wait 就是说线程在获取对象锁后，主动释放对象锁，同时本线程休眠。直到有其它线程调用对象的 notify () 唤醒该线程，才能继续获取对象锁，并继续执行。相应的 notify () 就是对对象锁的唤醒操作。但有一点需要注意的是 notify () 调用后，并不是马上就释放对象锁的，而是在相应的 synchronized (){} 语句块执行结束，自动释放锁后，JVM 会在 wait () 对象锁的线程中随机选取一线程，赋予其对象锁，唤醒线程，继续执行。这样就提供了在线程间同步、唤醒的操作。Thread.sleep () 与 Object.wait () 二者都可以暂停当前线程，释放 CPU 控制权，主要的区别在于 Object.wait () 在释放 CPU 同时，释放了对象锁的控制。</p>
<p>单单在概念上理解清楚了还不够，需要在实际的例子中进行测试才能更好的理解。对 Object.wait ()，Object.notify () 的应用最经典的例子，应该是三线程打印 ABC 的问题了吧，这是一道比较经典的面试题，题目要求如下：</p>
<p>建立三个线程，A 线程打印 10 次 A，B 线程打印 10 次 B,C 线程打印 10 次 C，要求线程同时运行，交替打印 10 次 ABC。这个问题用 Object 的 wait ()，notify () 就可以很方便的解决。代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"> * wait用法</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> DreamSea </span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@time</span> 2015.3.9 </span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">package</span> com.multithread.wait;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyThreadPrinter2</span> <span class="keyword">implements</span> <span class="title class_">Runnable</span> &#123;   </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	  </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String name;   </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Object prev;   </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Object self;   </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="title function_">MyThreadPrinter2</span><span class="params">(String name, Object prev, Object self)</span> &#123;   </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="built_in">this</span>.name = name;   </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="built_in">this</span>.prev = prev;   </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="built_in">this</span>.self = self;   </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;   </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span>  </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;   </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="type">int</span> <span class="variable">count</span> <span class="operator">=</span> <span class="number">10</span>;   </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> (count &gt; <span class="number">0</span>) &#123;   </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            <span class="keyword">synchronized</span> (prev) &#123;   </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">                <span class="keyword">synchronized</span> (self) &#123;   </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">                    System.out.print(name);   </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">                    count--;  </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">                    </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">                    self.notify();   </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">                &#125;   </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">                <span class="keyword">try</span> &#123;   </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">                    prev.wait();   </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;   </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">                    e.printStackTrace();   </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">                &#125;   </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            &#125;   </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        &#125;   </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;   </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;   </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="type">Object</span> <span class="variable">a</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Object</span>();   </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="type">Object</span> <span class="variable">b</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Object</span>();   </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="type">Object</span> <span class="variable">c</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Object</span>();   </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="type">MyThreadPrinter2</span> <span class="variable">pa</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MyThreadPrinter2</span>(<span class="string">&quot;A&quot;</span>, c, a);   </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="type">MyThreadPrinter2</span> <span class="variable">pb</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MyThreadPrinter2</span>(<span class="string">&quot;B&quot;</span>, a, b);   </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="type">MyThreadPrinter2</span> <span class="variable">pc</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MyThreadPrinter2</span>(<span class="string">&quot;C&quot;</span>, b, c);   </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">           </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">           </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(pa).start();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        Thread.sleep(<span class="number">100</span>);  <span class="comment">//确保按顺序A、B、C执行</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(pb).start();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        Thread.sleep(<span class="number">100</span>);  </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(pc).start();   </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        Thread.sleep(<span class="number">100</span>);  </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        &#125;   </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;  </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"> </span><br></pre></td></tr></table></figure>
<p>输出结果：</p>
<p>ABCABCABCABCABCABCABCABCABCABC</p>
<p>先来解释一下其整体思路，从大的方向上来讲，该问题为三线程间的同步唤醒操作，主要的目的就是 ThreadA-&gt;ThreadB-&gt;ThreadC-&gt;ThreadA 循环执行三个线程。为了控制线程执行的顺序，那么就必须要确定唤醒、等待的顺序，所以每一个线程必须同时持有两个对象锁，才能继续执行。一个对象锁是 prev，就是前一个线程所持有的对象锁。还有一个就是自身对象锁。主要的思想就是，为了控制执行的顺序，必须要先持有 prev 锁，也就前一个线程要释放自身对象锁，再去申请自身对象锁，两者兼备时打印，之后首先调用 self.notify () 释放自身对象锁，唤醒下一个等待线程，再调用 prev.wait () 释放 prev 对象锁，终止当前线程，等待循环结束后再次被唤醒。运行上述代码，可以发现三个线程循环打印 ABC，共 10 次。程序运行的主要过程就是 A 线程最先运行，持有 C,A 对象锁，后释放 A,C 锁，唤醒 B。线程 B 等待 A 锁，再申请 B 锁，后打印 B，再释放 B，A 锁，唤醒 C，线程 C 等待 B 锁，再申请 C 锁，后打印 C，再释放 C,B 锁，唤醒 A。看起来似乎没什么问题，但如果你仔细想一下，就会发现有问题，就是初始条件，三个线程按照 A,B,C 的顺序来启动，按照前面的思考，A 唤醒 B，B 唤醒 C，C 再唤醒 A。但是这种假设依赖于 JVM 中线程调度、执行的顺序。<br>
<strong>wait 和 sleep 区别<br>
共同点：</strong><br>
\1. 他们都是在多线程的环境下，都可以在程序的调用处阻塞指定的毫秒数，并返回。<br>
\2. wait () 和 sleep () 都可以通过 interrupt () 方法 打断线程的暂停状态 ，从而使线程立刻抛出 InterruptedException。<br>
如果线程 A 希望立即结束线程 B，则可以对线程 B 对应的 Thread 实例调用 interrupt 方法。如果此刻线程 B 正在 wait/sleep/join，则线程 B 会立刻抛出 InterruptedException，在 catch () {} 中直接 return 即可安全地结束线程。<br>
需要注意的是，InterruptedException 是线程自己从内部抛出的，并不是 interrupt () 方法抛出的。对某一线程调用 interrupt () 时，如果该线程正在执行普通的代码，那么该线程根本就不会抛出 InterruptedException。但是，一旦该线程进入到 wait ()/sleep ()/join () 后，就会立刻抛出 InterruptedException 。<br>
<strong>不同点：</strong><br>
\1. Thread 类的方法：sleep (),yield () 等<br>
 Object 的方法：wait () 和 notify () 等<br>
 \2. 每个对象都有一个锁来控制同步访问。Synchronized 关键字可以和对象的锁交互，来实现线程的同步。<br>
sleep 方法没有释放锁，而 wait 方法释放了锁，使得其他线程可以使用同步控制块或者方法。<br>
\3. wait，notify 和 notifyAll 只能在同步控制方法或者同步控制块里面使用，而 sleep 可以在任何地方使用<br>
所以 sleep () 和 wait () 方法的最大区别是：<br>
　　　　sleep () 睡眠时，保持对象锁，仍然占有该锁；<br>
　　　　而 wait () 睡眠时，释放对象锁。<br>
　　但是 wait () 和 sleep () 都可以通过 interrupt () 方法打断线程的暂停状态，从而使线程立刻抛出 InterruptedException（但不建议使用该方法）。<br>
<strong>sleep（）方法</strong><br>
 sleep () 使当前线程进入停滞状态（阻塞当前线程），让出 CUP 的使用、目的是不让当前线程独自霸占该进程所获的 CPU 资源，以留一定时间给其他线程执行的机会；<br>
　　 sleep () 是 Thread 类的 Static (静态) 的方法；因此他不能改变对象的机锁，所以当在一个 Synchronized 块中调用 Sleep () 方法是，线程虽然休眠了，但是对象的机锁并木有被释放，其他线程无法访问这个对象（即使睡着也持有对象锁）。<br>
　　在 sleep () 休眠时间期满后，该线程不一定会立即执行，这是因为其它线程可能正在运行而且没有被调度为放弃执行，除非此线程具有更高的优先级。<br>
<strong>wait（）方法</strong><br>
 wait () 方法是 Object 类里的方法；当一个线程执行到 wait () 方法时，它就进入到一个和该对象相关的等待池中，同时失去（释放）了对象的机锁（暂时失去机锁，wait (long timeout) 超时时间到后还需要返还对象锁）；其他线程可以访问；<br>
　　wait () 使用 notify 或者 notifyAlll 或者指定睡眠时间来唤醒当前等待池中的线程。<br>
　　wiat () 必须放在 synchronized block 中，否则会在 program runtime 时扔出”java.lang.IllegalMonitorStateException“异常。</p>
<h1 id="七-常见线程名词解释"><a class="markdownIt-Anchor" href="#七-常见线程名词解释">#</a> 七、常见线程名词解释</h1>
<p>主线程：JVM 调用程序 main () 所产生的线程。</p>
<p>当前线程：这个是容易混淆的概念。一般指通过 Thread.currentThread () 来获取的进程。</p>
<p>后台线程：指为其他线程提供服务的线程，也称为守护线程。JVM 的垃圾回收线程就是一个后台线程。 <strong>用户线程和守护线程的区别在于，是否等待主线程依赖于主线程结束而结束</strong></p>
<p>前台线程：是指接受后台线程服务的线程，其实前台后台线程是联系在一起，就像傀儡和幕后操纵者一样的关系。傀儡是前台线程、幕后操纵者是后台线程。由前台线程创建的线程默认也是前台线程。可以通过 isDaemon () 和 setDaemon () 方法来判断和设置一个线程是否为后台线程。</p>
<p>** 线程类的一些常用方法：</p>
<p>sleep (): 强迫一个线程睡眠Ｎ毫秒。<br>
　　isAlive (): 判断一个线程是否存活。<br>
　　join (): 等待线程终止。<br>
　　activeCount (): 程序中活跃的线程数。<br>
　　enumerate (): 枚举程序中的线程。<br>
currentThread (): 得到当前线程。<br>
　　isDaemon (): 一个线程是否为守护线程。<br>
　　setDaemon (): 设置一个线程为守护线程。(用户线程和守护线程的区别在于，是否等待主线程依赖于主线程结束而结束)<br>
　　setName (): 为线程设置一个名称。<br>
　　wait (): 强迫一个线程等待。<br>
　　notify (): 通知一个线程继续运行。<br>
　　setPriority (): 设置一个线程的优先级。<br>
**</p>
<h1 id="八-线程同步"><a class="markdownIt-Anchor" href="#八-线程同步">#</a> 八、线程同步</h1>
<p>1、synchronized 关键字的作用域有二种：<br>
1）是某个对象实例内，synchronized aMethod (){} 可以防止多个线程同时访问这个对象的 synchronized 方法（如果一个对象有多个 synchronized 方法，只要一个线程访问了其中的一个 synchronized 方法，其它线程不能同时访问这个对象中任何一个 synchronized 方法）。这时，不同的对象实例的 synchronized 方法是不相干扰的。也就是说，其它线程照样可以同时访问相同类的另一个对象实例中的 synchronized 方法；<br>
2）是某个类的范围，synchronized static aStaticMethod {} 防止多个线程同时访问这个类中的 synchronized static 方法。它可以对类的所有对象实例起作用。</p>
<p>2、除了方法前用 synchronized 关键字，synchronized 关键字还可以用于方法中的某个区块中，表示只对这个区块的资源实行互斥访问。用法是: synchronized (this){/<em> 区块</em> /}，它的作用域是当前对象；</p>
<p>3、synchronized 关键字是不能继承的，也就是说，基类的方法 synchronized f (){} 在继承类中并不自动是 synchronized f (){}，而是变成了 f (){}。继承类需要你显式的指定它的某个方法为 synchronized 方法；</p>
<p>Java 对多线程的支持与同步机制深受大家的喜爱，似乎看起来使用了 synchronized 关键字就可以轻松地解决多线程共享数据同步问题。到底如何？――还得对 synchronized 关键字的作用进行深入了解才可定论。</p>
<p>总的说来，synchronized 关键字可以作为函数的修饰符，也可作为函数内的语句，也就是平时说的同步方法和同步语句块。如果再细的分类，synchronized 可作用于 instance 变量、object reference（对象引用）、static 函数和 class literals (类名称字面常量) 身上。</p>
<p>在进一步阐述之前，我们需要明确几点：</p>
<p>A．无论 synchronized 关键字加在方法上还是对象上，它取得的锁都是对象，而不是把一段代码或函数当作锁――而且同步方法很可能还会被其他线程的对象访问。</p>
<p>B．每个对象只有一个锁（lock）与之相关联。</p>
<p>C．实现同步是要很大的系统开销作为代价的，甚至可能造成死锁，所以尽量避免无谓的同步控制。</p>
<p>接着来讨论 synchronized 用到不同地方对代码产生的影响：</p>
<p>假设 P1、P2 是同一个类的不同对象，这个类中定义了以下几种情况的同步块或同步方法，P1、P2 就都可以调用它们。</p>
<p>1． 把 synchronized 当作函数修饰符时，示例代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">Public <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title function_">methodAAA</span><span class="params">()</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//….</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这也就是同步方法，那这时 synchronized 锁定的是哪个对象呢？它锁定的是调用这个同步方法对象。也就是说，当一个对象 P1 在不同的线程中执行这个同步方法时，它们之间会形成互斥，达到同步的效果。但是这个对象所属的 Class 所产生的另一对象 P2 却可以任意调用这个被加了 synchronized 关键字的方法。</p>
<p>上边的示例代码等同于如下代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">methodAAA</span><span class="params">()</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">synchronized</span> (<span class="built_in">this</span>)      <span class="comment">//  (1)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">       <span class="comment">//…..</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>(1) 处的 this 指的是什么呢？它指的就是调用这个方法的对象，如 P1。可见同步方法实质是将 synchronized 作用于 object reference。――那个拿到了 P1 对象锁的线程，才可以调用 P1 的同步方法，而对 P2 而言，P1 这个锁与它毫不相干，程序也可能在这种情形下摆脱同步机制的控制，造成数据混乱：（</p>
<p>2．同步块，示例代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">method3</span><span class="params">(SomeObject so)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">              &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">                     <span class="keyword">synchronized</span>(so)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">       <span class="comment">//…..</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这时，锁就是 so 这个对象，谁拿到这个锁谁就可以运行它所控制的那段代码。当有一个明确的对象作为锁时，就可以这样写程序，但当没有明确的对象作为锁，只是想让一段代码同步时，可以创建一个特殊的 instance 变量（它得是一个对象）来充当锁：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Foo</span> <span class="keyword">implements</span> <span class="title class_">Runnable</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">       <span class="keyword">private</span> <span class="type">byte</span>[] lock = <span class="keyword">new</span> <span class="title class_">byte</span>[<span class="number">0</span>];  <span class="comment">// 特殊的instance变量</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    Public <span class="keyword">void</span> <span class="title function_">methodA</span><span class="params">()</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">       <span class="keyword">synchronized</span>(lock) &#123; <span class="comment">//… &#125;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//…..</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>注：零长度的 byte 数组对象创建起来将比任何对象都经济――查看编译后的字节码：生成零长度的 byte [] 对象只需 3 条操作码，而 Object lock = new Object () 则需要 7 行操作码。</p>
<p>3．将 synchronized 作用于 static 函数，示例代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">Class Foo</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">methodAAA</span><span class="params">()</span>   <span class="comment">// 同步的static 函数</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//….</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">methodBBB</span><span class="params">()</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">       <span class="keyword">synchronized</span>(Foo.class)   <span class="comment">//  class literal(类名称字面常量)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">       &#125;</span><br></pre></td></tr></table></figure>
<p>代码中的 methodBBB () 方法是把 class literal 作为锁的情况，它和同步的 static 函数产生的效果是一样的，取得的锁很特别，是当前调用这个方法的对象所属的类（Class，而不再是由这个 Class 产生的某个具体对象了）。</p>
<p>记得在《Effective Java》一书中看到过将 Foo.class 和 P1.getClass () 用于作同步锁还不一样，不能用 P1.getClass () 来达到锁这个 Class 的目的。P1 指的是由 Foo 类产生的对象。</p>
<p>可以推断：如果一个类中定义了一个 synchronized 的 static 函数 A，也定义了一个 synchronized 的 instance 函数 B，那么这个类的同一对象 Obj 在多线程中分别访问 A 和 B 两个方法时，不会构成同步，因为它们的锁都不一样。A 方法的锁是 Obj 这个对象，而 B 的锁是 Obj 所属的那个 Class。</p>
<p><strong>总结一下：</strong></p>
<p>1、线程同步的目的是为了保护多个线程反问一个资源时对资源的破坏。<br>
2、线程同步方法是通过锁来实现，每个对象都有切仅有一个锁，这个锁与一个特定的对象关联，线程一旦获取了对象锁，其他访问该对象的线程就无法再访问该对象的其他非同步方法<br>
 3、对于静态同步方法，锁是针对这个类的，锁对象是该类的 Class 对象。静态和非静态方法的锁互不干预。一个线程获得锁，当在一个同步方法中访问另外对象上的同步方法时，会获取这两个对象锁。<br>
4、对于同步，要时刻清醒在哪个对象上同步，这是关键。<br>
5、编写线程安全的类，需要时刻注意对多个线程竞争访问资源的逻辑和安全做出正确的判断，对 “原子” 操作做出分析，并保证原子操作期间别的线程无法访问竞争资源。<br>
6、当多个线程等待一个对象锁时，没有获取到锁的线程将发生阻塞。<br>
7、死锁是线程间相互等待锁锁造成的，在实际中发生的概率非常的小。真让你写个死锁程序，不一定好使，呵呵。但是，一旦程序发生死锁，程序将死掉。</p>
<h1 id="九-线程数据传递"><a class="markdownIt-Anchor" href="#九-线程数据传递">#</a> 九、线程数据传递</h1>
<p>在传统的同步开发模式下，当我们调用一个函数时，通过这个函数的参数将数据传入，并通过这个函数的返回值来返回最终的计算结果。但在多线程的异步开发模式下，数据的传递和返回和同步开发模式有很大的区别。由于线程的运行和结束是不可预料的，因此，在传递和返回数据时就无法象函数一样通过函数参数和 return 语句来返回数据。</p>
<p>9.1、通过构造方法传递数据<br>
在创建线程时，必须要建立一个 Thread 类的或其子类的实例。因此，我们不难想到在调用 start 方法之前通过线程类的构造方法将数据传入线程。并将传入的数据使用类变量保存起来，以便线程使用 (其实就是在 run 方法中使用)。下面的代码演示了如何通过构造方法来传递数据：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> mythread; </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyThread1</span> <span class="keyword">extends</span> <span class="title class_">Thread</span> </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#123; </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> String name; </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="title function_">MyThread1</span><span class="params">(String name)</span> </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#123; </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="built_in">this</span>.name = name; </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#123; </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">System.out.println(<span class="string">&quot;hello &quot;</span> + name); </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#123; </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">Thread</span> <span class="variable">thread</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MyThread1</span>(<span class="string">&quot;world&quot;</span>); </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">thread.start(); </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>
<p>由于这种方法是在创建线程对象的同时传递数据的，因此，在线程运行之前这些数据就就已经到位了，这样就不会造成数据在线程运行后才传入的现象。如果要传递更复杂的数据，可以使用集合、类等数据结构。使用构造方法来传递数据虽然比较安全，但如果要传递的数据比较多时，就会造成很多不便。由于 Java 没有默认参数，要想实现类似默认参数的效果，就得使用重载，这样不但使构造方法本身过于复杂，又会使构造方法在数量上大增。因此，要想避免这种情况，就得通过类方法或类变量来传递数据。</p>
<p>9.2、通过变量和方法传递数据<br>
向对象中传入数据一般有两次机会，第一次机会是在建立对象时通过构造方法将数据传入，另外一次机会就是在类中定义一系列的 public 的方法或变量（也可称之为字段）。然后在建立完对象后，通过对象实例逐个赋值。下面的代码是对 MyThread1 类的改版，使用了一个 setName 方法来设置 name 变量：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> mythread; </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyThread2</span> <span class="keyword">implements</span> <span class="title class_">Runnable</span> </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#123; </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> String name; </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setName</span><span class="params">(String name)</span> </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#123; </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="built_in">this</span>.name = name; </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#123; </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">System.out.println(<span class="string">&quot;hello &quot;</span> + name); </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#123; </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">MyThread2</span> <span class="variable">myThread</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MyThread2</span>(); </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">myThread.setName(<span class="string">&quot;world&quot;</span>); </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">Thread</span> <span class="variable">thread</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(myThread); </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">thread.start(); </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>
<p>9.3、通过回调函数传递数据</p>
<p>上面讨论的两种向线程中传递数据的方法是最常用的。但这两种方法都是 main 方法中主动将数据传入线程类的。这对于线程来说，是被动接收这些数据的。然而，在有些应用中需要在线程运行的过程中动态地获取数据，如在下面代码的 run 方法中产生了 3 个随机数，然后通过 Work 类的 process 方法求这三个随机数的和，并通过 Data 类的 value 将结果返回。从这个例子可以看出，在返回 value 之前，必须要得到三个随机数。也就是说，这个 value 是无法事先就传入线程类的。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> mythread; </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Data</span> </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#123; </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="variable">value</span> <span class="operator">=</span> <span class="number">0</span>; </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Work</span> </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#123; </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">process</span><span class="params">(Data data, Integer numbers)</span> </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#123; </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> n : numbers) </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#123; </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">data.value += n; </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyThread3</span> <span class="keyword">extends</span> <span class="title class_">Thread</span> </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#123; </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> Work work; </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="title function_">MyThread3</span><span class="params">(Work work)</span> </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#123; </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="built_in">this</span>.work = work; </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#123; </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">java.util.<span class="type">Random</span> <span class="variable">random</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">java</span>.util.Random(); </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">Data</span> <span class="variable">data</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Data</span>(); </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="variable">n1</span> <span class="operator">=</span> random.nextInt(<span class="number">1000</span>); </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="variable">n2</span> <span class="operator">=</span> random.nextInt(<span class="number">2000</span>); </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="variable">n3</span> <span class="operator">=</span> random.nextInt(<span class="number">3000</span>); </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">work.process(data, n1, n2, n3); <span class="comment">// 使用回调函数 </span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">System.out.println(String.valueOf(n1) + <span class="string">&quot;+&quot;</span> + String.valueOf(n2) + <span class="string">&quot;+&quot;</span> </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">+ String.valueOf(n3) + <span class="string">&quot;=&quot;</span> + data.value); </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#123; </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">Thread</span> <span class="variable">thread</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MyThread3</span>(<span class="keyword">new</span> <span class="title class_">Work</span>()); </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">thread.start(); </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>
<p>好了，Java 多线程的基础知识就讲到这里了，有兴趣研究多线程的推荐直接看 java 的源码，你将会得到很大的提升！</p>
<h2 id="关于我"><a class="markdownIt-Anchor" href="#关于我">#</a> 关于我</h2>
<p>Brath 是一个热爱技术的 Java 程序猿，公众号「InterviewCoder」定期分享有趣有料的精品原创文章！</p>
<p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/%E4%BA%8C%E7%BB%B4%E7%A0%81plus.png" alt="InterviewCoder"></p>
<p>非常感谢各位人才能看到这里，原创不易，文章如果有帮助可以关注、点赞、分享或评论，这都是对我的莫大支持！</p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2021-06-11T03:15:38.000Z" title="2021-6-11 11:15:38">2021-06-11</time>发表</span><span class="level-item"><time dateTime="2022-06-03T06:20:18.000Z" title="2022-6-3 14:20:18">2022-06-03</time>更新</span><span class="level-item">29 分钟读完 (大约4303个字)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2021/06/11/%E3%80%90Java%E3%80%91JVM%E8%99%9A%E6%8B%9F%E6%9C%BA%E7%AC%94%E8%AE%B0/">JVM学习记录</a></p><div class="content"><p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/%E6%89%AB%E7%A0%81_%E6%90%9C%E7%B4%A2%E8%81%94%E5%90%88%E4%BC%A0%E6%92%AD%E6%A0%B7%E5%BC%8F-%E6%A0%87%E5%87%86%E8%89%B2%E7%89%88.png" alt="InterviewCoder"></p>
<h4 id="jvm位置在操作系统之上运行操作系统在硬件之上运行"><a class="markdownIt-Anchor" href="#jvm位置在操作系统之上运行操作系统在硬件之上运行">#</a> JVM 位置：在操作系统之上运行，操作系统在硬件之上运行</h4>
<p>JDK（JRE（JVM））: JDK 包含了 JRE，JRE 包含了 JVM</p>
<h4 id="jvm体系结构"><a class="markdownIt-Anchor" href="#jvm体系结构">#</a> JVM 体系结构：</h4>
<p><img src="https://brath.oss-cn-shanghai.aliyuncs.com/pigo/JVM%E5%BA%95%E5%B1%82%E7%BB%93%E6%9E%84%E7%94%BB%E5%9B%BE%EF%BC%88%E7%B2%BE%E7%BB%86%EF%BC%89.jpg" alt="JVM底层结构画图（精细）"></p>
<p>Java File</p>
<p>=&gt; Class File</p>
<p>=&gt; Class Loader SubSystem {</p>
<p>1 . Loading : [1 . ApplicationClassLoader   2 . ExtClassLoader  3 . BootStrapClassLoader]</p>
<p>2 . Linking : [1. Verify  2.Prepare  3. Resolve ]</p>
<p>3 . Initialization</p>
<p>}</p>
<p>=&gt; RuntimeData Areas ：(1,2) : Memory sharing，(3,4,5) : Memory is not shared{</p>
<p>1 . Method Area</p>
<p>2 . Heap Area </p>
<p>3 . Stack Area   {</p>
<p>T1 [1. Thread  2. Stack Frame ]</p>
<p>T2 [1. Thread  2. Stack Frame ]</p>
<p>}</p>
<p>4 . Native MethodStack Area    --&gt; JNI</p>
<p>5 . Program Counter Register [PC Registers for Thread]</p>
<p>}</p>
<p>=&gt; Execution Engine {</p>
<p>1 . interpreter</p>
<p>2 . JIT Compiler  {</p>
<p>Intermediate Code Generator</p>
<p>=&gt; Code Optimizer</p>
<p>=&gt; Target Code Generator</p>
<p>}</p>
<p>3 . Profiler</p>
<p>4 . Garbage Collection</p>
<p>}</p>
<p>=&gt; Java Native Method Interface （JNI）</p>
<p>=&gt; Native Method Library</p>
<h4 id="类加载器-classloader-subsystem-类加载器子系统-运行时在堆中运行-不运行时是独立子系统"><a class="markdownIt-Anchor" href="#类加载器-classloader-subsystem-类加载器子系统-运行时在堆中运行-不运行时是独立子系统">#</a> 类加载器： ClassLoader SubSystem : 类加载器子系统 运行时在堆中运行 不运行时是独立子系统</h4>
<p>application ClassLoader 应用程序加载器  主要负责加载应用程序的主函数类</p>
<p>Ext ClassLoader 扩展加载器  主要负责加载 jre/lib/ext 目录下的一些扩展的 jar。</p>
<p>BootStrap ClassLoader 根类加载器  主要负责加载核心的类库 (java.lang.* 等)</p>
<p>加载过程：class File =&gt; Loading 加载 =&gt; Linking （验证，准备，解析） 链接 =&gt; Initialization 初始化</p>
<h4 id="双亲委派机制"><a class="markdownIt-Anchor" href="#双亲委派机制">#</a> 双亲委派机制</h4>
<p><img src="https://img-blog.csdnimg.cn/20201217213314510.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2NvZGV5YW5iYW8=,size_16,color_FFFFFF,t_70" alt="img"></p>
<p>从上图中我们就更容易理解了，当一个 Hello.class 这样的文件要被加载时。不考虑我们自定义类加载器，首先会在 AppClassLoader 中检查是否加载过，如果有那就无需再加载了。如果没有，那么会拿到父加载器，然后调用父加载器的 loadClass 方法。父类中同理也会先检查自己是否已经加载过，如果没有再往上。注意这个类似递归的过程，直到到达 Bootstrap classLoader 之前，都是在检查是否加载过，并不会选择自己去加载。直到 BootstrapClassLoader，已经没有父加载器了，这时候开始考虑自己是否能加载了，如果自己无法加载，会下沉到子加载器去加载，一直到最底层，如果没有任何加载器能加载，就会抛出 ClassNotFoundException。那么有人就有下面这种疑问了？</p>
<p>为什么要设计这种机制<br>
这种设计有个好处是，如果有人想替换系统级别的类：String.java。篡改它的实现，在这种机制下这些系统的类已经被 Bootstrap classLoader 加载过了（为什么？因为当一个类需要加载的时候，最先去尝试加载的就是 BootstrapClassLoader），所以其他类加载器并没有机会再去加载，从一定程度上防止了危险代码的植入。</p>
<p>沙箱安全机制</p>
<p>在 Java 中将执行程序分成本地代码和远程代码两种，本地代码默认视为可信任的，而远程代码则被看作是不受信的。对于授信的本地代码，可以访问一切本地资源。而对于非授信的远程代码在早期的 Java 实现中，安全依赖于沙箱 (Sandbox) 机制。</p>
<p><img src="https://img-blog.csdnimg.cn/20200312212803678.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MDkyNzQzNg==,size_16,color_FFFFFF,t_70" alt="img"></p>
<p>当前最新的安全机制实现，则引入了域 (Domain) 的概念。虚拟机会把所有代码加载到不同的系统域和应用域，系统域部分专门负责与关键资源进行交互，而各个应用域部分则通过系统域的部分代理来对各种需要的资源进行访问。虚拟机中不同的受保护域 (Protected Domain)，对应不一样的权限 (Permission)。存在于不同域中的类文件就具有了当前域的全部权限，如下图所示</p>
<h4 id="native"><a class="markdownIt-Anchor" href="#native">#</a> Native</h4>
<p><strong>native 即 JNI,Java Native Interface</strong></p>
<p>Native 关键字是  JNI，也就是 java 本地方法接口，用来调用本地方法库，可以调用本地方法中的 C 语言代码</p>
<h4 id="pc寄存器"><a class="markdownIt-Anchor" href="#pc寄存器">#</a> PC 寄存器</h4>
<p>每次线程启动的时候会创建一个 PC 寄存器，保存正在执行的 JVM 指令地址，每个线程都有自己的 PC 寄存器，是一个比较小的内存空间，是为一个一个不会出现 OutOfMemoryError 的内存区域，它的生命周期随着线程的创建而创建，随着线程的结束而死亡。</p>
<h4 id="方法区"><a class="markdownIt-Anchor" href="#方法区">#</a> 方法区</h4>
<p>Hotspot 虚拟机，方法区别称：non-heap（非堆），其实就是存储堆类型的数据，而不占据堆内存的空间</p>
<p>方法区和堆区线程共享，方法区大小和堆一样，可以选择固定大小或者拓展</p>
<p>方法区大小决定了系统可以保存多少个类，如果系统定义了太多的类，导致方法区溢出，虚拟机同样会抛出内存溢出错误。</p>
<p>关闭 JVM 就会释放这个区域的内存</p>
<p>设置方法区的内存大小：</p>
<h4 id="jdk17-之前"><a class="markdownIt-Anchor" href="#jdk17-之前">#</a> JDK1.7 之前：</h4>
<p><strong>-XX：PermSize 设置永久代初始分配空间  默认是 20.75m</strong></p>
<p><strong>-XX：MaxPermSize 设置最大永久代分配空间，32 位机器默认 64m，64 位机器默认 82m</strong></p>
<h4 id="jdk18-及以后永久代被元空间代替metaspace"><a class="markdownIt-Anchor" href="#jdk18-及以后永久代被元空间代替metaspace">#</a> JDK1.8 及以后：永久代被元空间代替（MetaSpace）</h4>
<p>元空间大小可以用参数：-XX:MetaspaceSzie 和 -XX:MaxMetaspaceSize 指定</p>
<p>-XX:MetaspaceSzie 默认 21.75m -XX:MaxMetaspaceSize 默认 - 1 没有限制</p>
<p>默认情况下，虚拟机会耗尽所有可用的系统内存，如果元空间发生溢出，虚拟机照样会抛出 OOM</p>
<p>如果初始高位线设置过低，通过垃圾回收器日志可以观察到 Full GC 多次调用，为了避免频繁 GC，</p>
<p>建议将 - XX:MetaspaceSize 设置为一个相对较高的值。</p>
<h4 id="栈数据结构"><a class="markdownIt-Anchor" href="#栈数据结构">#</a> 栈：数据结构</h4>
<p>程序 = 数据结构 + 算法</p>
<p>先进后出，后进先出</p>
<p>栈是桶的概念：先进去的后出来，后进去的先出来</p>
<p>栈有压栈、弹栈</p>
<p>队列是管道概念：先进先出 (F I F O) ，后进后出 First Input First Out</p>
<p>喝多了吐就是栈，吃多了拉就是队列</p>
<p>栈：主管程序运行，生命周期和线程同步；</p>
<p>main 主线程结束，栈内存也就释放了，对于栈来说，不存在垃圾回收问题，一旦线程结束，栈就 Over 了。</p>
<p>栈存什么东西：</p>
<p>八大基本数据类型 + 对象的引用地址 + 实例方法</p>
<p>栈运行原理：栈帧：方法索引，输入输出参数，本地变量，类引用，父帧，子帧</p>
<p>栈满了就会抛出错误 Error：StackOverflowError 栈溢出</p>
<h3 id="堆heap"><a class="markdownIt-Anchor" href="#堆heap">#</a> 堆：Heap</h3>
<p>​		一个 JVM 只有一个堆内存，堆内存大小是可以调节的。</p>
<p>​		类加载器读取的类文件后，一般会把：类，方法，常量，变量，引用类型的真实对象放到堆中。</p>
<p>​		堆内存还要细分为三个区域：{</p>
<p>新生代：Eden Space：</p>
<p>Survior0 区和 Survior1 区：幸存者 0/1 区</p>
<p>经过新生代的轻 GC 15 次的考验进入老年代。</p>
<p>老年代：重量级 Full GC 垃圾回收</p>
<p>永久代：（1.8 移除）</p>
<p>GC 垃圾回收集中在新生代和老年代执行。</p>
<p>假设内存满了，爆出 OOM，堆内存溢出。</p>
<p>内存溢出代码怎么写：</p>
<p>利用 while 循环一个字符串无限 += 随机数</p>
<p>JDK8 以后，永久代被移除，更名为元空间：MetaSpace</p>
<p>}</p>
<h4 id="详解"><a class="markdownIt-Anchor" href="#详解">#</a> 详解：</h4>
<h5 id="新生代"><a class="markdownIt-Anchor" href="#新生代">#</a> 新生代：</h5>
<p>​	类：诞生成长的地方，也可能类死亡的地方</p>
<p>​	Eden 区、幸存者 0 和 1 区，</p>
<p>​	所有对象都是在 Eden 区 new 出来的</p>
<p>​	Eden 区没死亡的对象在幸存者区存活</p>
<p>​	如果 Eden 区存储触发了轻 GC 回收机制，就会对 Eden 区进行清除，存活下来对象在幸存区，清除的对象会消失。当 Eden 区和幸存者区都满了之后会执行一次 Full GC，再次存活下来的对象会进入老年代。</p>
<p>Tips：新生代 99% 都是临时对象！，能进入老年代的对象并不多。所以平时很少见到 OOM 的错误</p>
<h5 id="老年代"><a class="markdownIt-Anchor" href="#老年代">#</a> 老年代：</h5>
<p>每次发生轻 GC 会对新生代进行对象清理，当新生代和幸存区的对象在轻 GC 清除下存活 15 次之后，进入老年代</p>
<p>永久代：用来存放 jdk 自身携带的 calss 对象，interface 元数据，存储的是运行的一些时环境，永久代不存在垃圾回收，关闭 JJVM 虚拟机就会释放永久代内存。</p>
<p>假设一个启动类，加载了大量的第三方 jar 包，或者一个 tomcat 部署了太多应用，或者大量动态生成的反射类，如果不断的加载，可能会导致永久代内存溢出。</p>
<p>jdk1.6 之前：永久代，常量池存在于方法区中</p>
<p>jdk1.7：去永久代，常量池在堆中</p>
<p>jdk1.8：无永久代，常量池在元空间中</p>
<p><strong>元空间：</strong></p>
<p>（方法区）：非堆</p>
<p>非堆指的是空间上，不属于堆空间；但是由于存储的内容，特性上又被称为堆</p>
<p>默认情况下：虚拟机被分配到的总内存是电脑内存的 1/4 ，而初始化的内存只有 1/64</p>
<p>因为与堆共享内存，逻辑上存在，物理上不存在</p>
<p><img src="https://xysaobi.oss-cn-beijing.aliyuncs.com/img/image-20210908225948384.png" alt="image-20210908225948384"></p>
<p><img src="https://xysaobi.oss-cn-beijing.aliyuncs.com/img/image-20210908230652551.png" alt="image-20210908230652551"></p>
<p>dump 文件～Jprofiler 插件</p>
<p>-Xms : 初始化内存</p>
<p>-Xmx : 最大内存</p>
<p>-XX:+PrintGCDetails  打印 GC 回收的详细信息</p>
<p>-XX:+HeapDumpOnOutOfMemoryError 发生 OOM 异常打印 dump 内存快照</p>
<p>-XX:MaxTenuringReshlod 设置最大存活时间，默认是 15 次</p>
<p>GC：垃圾回收</p>
<p>JVM 在进行 GC 时：大部分回收都在新生代，并不是三个区都回收</p>
<p>新生代</p>
<p>幸存区（form、to）Survior0、Survior1 区</p>
<p>老年代</p>
<p>GC 两个种类：轻 GC（GC）、重 GC（Full GC）</p>
<p>轻 GC 对新生代和幸存区进行回收</p>
<p>重 GC 进行全局回收</p>
<p>如何区分 from 和 to 区：谁空谁是 to 区</p>
<p>1 . 每次 GC 都会将 Eden 区活的对象移到幸存区中：一旦 Eden 区被 GC 后，就会是空的！</p>
<p>2 . 当一个对象经历了 15 次 GC，还没有死，就会进入老年代</p>
<p>-XX:MaxTenuringReshold，通过这个参数可以设定进入老年代的时间（指定在 0~15 次之间）</p>
<h4 id="常用算法"><a class="markdownIt-Anchor" href="#常用算法">#</a> <strong>常用算法：</strong></h4>
<p>**1 . 标记清除 **</p>
<p>分为两步骤：标记 ---- 清除</p>
<p>标记：扫描，对存活的对象进行标记</p>
<p>清除：扫描，对没有标记的对象进行清除</p>
<p>优点：简单，成功率高</p>
<p>缺点：两次扫描严重耗时，清除会产生内存碎片</p>
<p><strong>2 .  标记压缩（标记 — 清除 — 压缩）</strong></p>
<p>标记清除的优化版：防止内存碎片产生</p>
<p>在标记清除基础上，再次扫描，向一端移动仍存活的对象，清除另一外的碎片</p>
<p>优点：在标记清除优点上优化了内存碎片</p>
<p>缺点：对于标记清除又多了一次移动成本，时间增加</p>
<p><strong>3 .  复制算法</strong>（新生代主要用的复制算法）</p>
<p>把 from 区向 to 区复制一份，然后清空 from 区，这时 from 区会变成 to 区，复制过去的 to 区变成 from 区等待回收。</p>
<p>优点：没有内存碎片</p>
<p>缺点：浪费内存空间（多了一半空间永远是 to 区，假设对象 100% 存活）极端情况下不适用</p>
<p>复制算法最佳使用场景：对象存活度较低的时候，新生区使用复制算法！</p>
<p><strong>4 . 分代收集算法：</strong></p>
<p>​		<strong>由于每个收集算法都无法符合所有的场景，就好比每个对象所在的内存阶段不一样，被回收的概率也不一样，比如在新生代，基本 90% 的对象会被回收，而到了老年代则一半以上的对象存活，所以针对不同的场景，回收的策略也就不一样，所以引出了分代收集算法，根据新生代和老年代不同的场景下使用不同的算法，比如新生代用复制算法，老年代则用标记整理算法</strong></p>
<p><strong>5.  引用计数器（不高效）</strong></p>
<p>给每个对象设置计数器，只要有引用就会计数，当一个对象计数器为 0 时，进行回收。缺点：效率低下，现在基本不用</p>
<h2 id="总结"><a class="markdownIt-Anchor" href="#总结">#</a> 总结：</h2>
<p>内存效率：复制算法 &gt; 标记清除算法 &gt; 标记压缩（时间复杂度）</p>
<p>内存整齐度：复制算法 == 标记压缩算法 &gt; 标记清除算法</p>
<p>内存利用率：标记压缩算法 == 标记清除算法 &gt; 复制算法</p>
<p>// 思考一个问题：难道没有最优算法吗？</p>
<p>答案：永远不能有最优算法。只有最合适的算法。</p>
<p>GC：分代收集算法：根据每个代需求来配置不同算法</p>
<p>年轻代：存活率低：需求时间短：所以用复制算法</p>
<p>老年代：存活率高、区域大：标记清除 + 标记压缩混合</p>
<p>内存碎片不是很多就标记清除，内存碎片太多就用压缩</p>
<p>JMM：</p>
<p>1 . 什么是 JMM：Java 内存模型（Java Memory Model）</p>
<p>2 . JMM 作用：</p>
<p>3 . 如何学习：</p>
<p>经历过很多面试大部分都会问一句： 你知道 Java 内存模型么？ 然后我就 pulapula 的说一大堆什么堆呀，栈呀，GC 呀什么的，这段时间把 JVM 虚拟机和多线程编程完整的学习了一遍，发现 JMM 和堆 / 栈这些完全不是一个概念，不知道是不是就是因为这才被拒了十来次的 / 尴尬。</p>
<p>JVM 是 Java 实现的虚拟计算机（Java Virtual Machine），对于熟悉计算机结构的同学，我感觉把这些概念和物理机对应起来更好理解。</p>
<p>JVM 对应的就是物理机，它有存放数据的存储区：堆、栈等由 JVM 管理的内存（对应于物理机的内存）、执行数据计算的执行单元：线程（对应于物理机的 CPU）、加速线程执行的本次存储区：可能会从存储区里分配一块空间来存储线程本地数据，比如栈（对应于物理机的 cache）。</p>
<p>众所周知，现代计算机一般都会包含多个处理器，多个处理器共享主内存。为了提升性能，会在每个处理器上增加一个小容量的 cache 加速数据读写。cache 会导致了缓存一致性问题，为了解决缓存一致性问题又引入了一系列 Cache 一致性协议（比如 MSI、MESI、MOSI、Synapse、Firefly 及 Dragon Protocol）来解决 CPU 本地缓存和主内存数据不一致问题。</p>
<p>而 JVM 中管理下的存储空间（包括堆、栈等）就对应与物理机的内存；</p>
<p>线程本次存储区（例如栈）就对应于物理机的 cache；</p>
<p>而 JMM 就对应于类似于 MSI、MESI、MOSI、Synapse、Firefly 及 Dragon Protocol 这样的缓存一致性协议，用于定义数据读写的规则。</p>
<p>JMM 相对于物理机的缓存一致性协议来说它还要处理 JVM 自身特有的问题：重排序问题，参见： <a target="_blank" rel="noopener" href="http://cmsblogs.com/?p=2116%E3%80%82">http://cmsblogs.com/?p=2116。</a></p>
<p>那么 JMM 都有哪些内容呢？</p>
<p>官方文档： <a target="_blank" rel="noopener" href="http://101.96.10.64/www.cs.umd.edu/~pugh/java/memoryModel/CommunityReview.pdf">http://101.96.10.64/www.cs.umd.edu/~pugh/java/memoryModel/CommunityReview.pdf</a></p>
<p>通俗理解就是 happens-before 原则 <a target="_blank" rel="noopener" href="https://www.cnblogs.com/chenssy/p/6393321.html">https://www.cnblogs.com/chenssy/p/6393321.html</a></p>
<h2 id="关于我"><a class="markdownIt-Anchor" href="#关于我">#</a> 关于我</h2>
<p>Brath 是一个热爱技术的 Java 程序猿，公众号「InterviewCoder」定期分享有趣有料的精品原创文章！</p>
<p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/%E4%BA%8C%E7%BB%B4%E7%A0%81plus.png" alt="InterviewCoder"></p>
<p>非常感谢各位人才能看到这里，原创不易，文章如果有帮助可以关注、点赞、分享或评论，这都是对我的莫大支持！</p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2021-06-08T05:43:06.000Z" title="2021-6-8 13:43:06">2021-06-08</time>发表</span><span class="level-item"><time dateTime="2020-05-13T02:26:39.000Z" title="2020-5-13 10:26:39">2020-05-13</time>更新</span><span class="level-item">3 分钟读完 (大约464个字)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2021/06/08/%E3%80%90MySQL%E3%80%91Mysql%E6%9F%A5%E8%AF%A2%E6%8A%80%E5%B7%A7/">mysql查询技巧</a></p><div class="content"><p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/%E6%89%AB%E7%A0%81_%E6%90%9C%E7%B4%A2%E8%81%94%E5%90%88%E4%BC%A0%E6%92%AD%E6%A0%B7%E5%BC%8F-%E6%A0%87%E5%87%86%E8%89%B2%E7%89%88.png" alt="InterviewCoder"></p>
<h1 id="mysql-查询当天-昨天-本周-上周-本月-上月-今年-去年数据"><a class="markdownIt-Anchor" href="#mysql-查询当天-昨天-本周-上周-本月-上月-今年-去年数据">#</a> mysql 查询当天、昨天、本周、上周、本月、上月、今年、去年数据</h1>
<h2 id="mysql查询今天-昨天-7天-近30天-本月-上一月-数据"><a class="markdownIt-Anchor" href="#mysql查询今天-昨天-7天-近30天-本月-上一月-数据">#</a> mysql 查询今天、昨天、7 天、近 30 天、本月、上一月 数据</h2>
<p>今天	select * from 表名 where to_days (时间字段名) = to_days (now ());</p>
<p>昨天	SELECT * FROM 表名 WHERE TO_DAYS (NOW () ) - TO_DAYS ( 时间字段名) = 1</p>
<p>近 7 天	SELECT * FROM 表名 where DATE_SUB (CURDATE (), INTERVAL 7 DAY) &lt;= date (时间字段名)</p>
<p>查询当前这周的数据<br>
 SELECT name,submittime FROM enterprise WHERE YEARWEEK (date_format (submittime,’% Y-% m-% d’)) = YEARWEEK (now ());</p>
<p>查询上周的数据<br>
 SELECT name,submittime FROM enterprise WHERE YEARWEEK (date_format (submittime,’% Y-% m-% d’)) = YEARWEEK (now ())-1;</p>
<p>近 30 天	SELECT * FROM 表名 where DATE_SUB (CURDATE (), INTERVAL 30 DAY) &lt;= date (时间字段名) 本月 SELECT * FROM 表名 WHERE DATE_FORMAT ( 时间字段名，‘% Y% m’ ) = DATE_FORMAT ( CURDATE ( ) , ‘% Y% m’ )</p>
<p>上一月	SELECT * FROM 表名 WHERE PERIOD_DIFF (date_format ( now () , ‘% Y% m’ ) , date_format ( 时间字段名，‘% Y% m’ ) ) =1</p>
<p>查询距离当前现在 6 个月的数据<br>
 select name,submittime from enterprise where submittime between date_sub (now (),interval 6 month) and now (); #查询本季度数据	select * from  <code>ht_invoice_information</code>  where QUARTER(create_date)=QUARTER(now());</p>
<p>查询上季度数据	select * from  <code>ht_invoice_information</code>  where QUARTER(create_date)=QUARTER(DATE_SUB(now(),interval 1 QUARTER));</p>
<p>查询本年数据	select * from  <code>ht_invoice_information</code>  where YEAR(create_date)=YEAR(NOW());</p>
<p>查询上年数据	select * from  <code>ht_invoice_information</code>  where year(create_date)=year(date_sub(now(),interval 1 year));</p>
<h2 id="关于我"><a class="markdownIt-Anchor" href="#关于我">#</a> 关于我</h2>
<p>Brath 是一个热爱技术的 Java 程序猿，公众号「InterviewCoder」定期分享有趣有料的精品原创文章！</p>
<p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/%E4%BA%8C%E7%BB%B4%E7%A0%81plus.png" alt="InterviewCoder"></p>
<p>非常感谢各位人才能看到这里，原创不易，文章如果有帮助可以关注、点赞、分享或评论，这都是对我的莫大支持！</p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2021-05-24T08:45:04.000Z" title="2021-5-24 16:45:04">2021-05-24</time>发表</span><span class="level-item"><time dateTime="2022-07-24T09:23:08.000Z" title="2022-7-24 17:23:08">2022-07-24</time>更新</span><span class="level-item">16 分钟读完 (大约2429个字)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2021/05/24/%E3%80%90ElasticSearch%E3%80%91ElasticSearch%E6%98%AF%E4%BB%80%E4%B9%88%EF%BC%9F/">ElasticSearch 处理检索海量数据“神器”？</a></p><div class="content"><p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/%E6%89%AB%E7%A0%81_%E6%90%9C%E7%B4%A2%E8%81%94%E5%90%88%E4%BC%A0%E6%92%AD%E6%A0%B7%E5%BC%8F-%E6%A0%87%E5%87%86%E8%89%B2%E7%89%88.png" alt="InterviewCoder"></p>
<hr>
<blockquote>
<p><strong>海量数据我们是如何去检索数据呢</strong>，如何快速定位呢，去查询后台数据库吗？<strong>还是走缓存</strong>，是什么缓存能承载这么大的符合呢，并且快速检索出来？对于海量的数据是<strong>对系统极大的压力</strong>，<em><strong>我们该从什么角度去处理这个棘手的问题呢</strong></em>？</p>
</blockquote>
<p><img src="https://brath.oss-cn-shanghai.aliyuncs.com/pigo/82bb3c20ec5d414c838322d08edd1015.png" alt="在这里插入图片描述"></p>
<h2 id="elasticsearch"><a class="markdownIt-Anchor" href="#elasticsearch">#</a> <a target="_blank" rel="noopener" href="https://so.csdn.net/so/search?q=ElasticSearch&amp;spm=1001.2101.3001.7020">ElasticSearch</a> 处理检索海量数据 “神器”？</h2>
<p><img src="https://brath.oss-cn-shanghai.aliyuncs.com/pigo/aba293bd092b42368e36b7839eb7df10.png" alt="在这里插入图片描述"></p>
<h2 id="11-介绍"><a class="markdownIt-Anchor" href="#11-介绍">#</a> 1.1 介绍</h2>
<blockquote>
<p>Elasticsearch 是一个基于<a target="_blank" rel="noopener" href="https://so.csdn.net/so/search?q=Lucene&amp;spm=1001.2101.3001.7020"> Lucene</a> 的搜索服务器。它提供了一个分布式多用户能力的全文搜索引擎，基于 RESTful<br>
web 接口。Elasticsearch 是用 Java 语言开发的，并作为<a target="_blank" rel="noopener" href="https://so.csdn.net/so/search?q=Apache&amp;spm=1001.2101.3001.7020"> Apache</a> 许可条款下的开放源码发布，是一种流行的企业级搜索引擎。Elasticsearch 用于云计算中，能够达到实时搜索，稳定，可靠，快速，安装使用方便。官方客户端在 Java、.NET（C#）、PHP、Python、Apache<br>
Groovy、Ruby 和许多其他语言中都是可用的。根据 DB-Engines 的排名显示，Elasticsearch 是最受欢迎的企业搜索引擎，其次是 Apache<br>
Solr，也是基于 Lucene。</p>
</blockquote>
<h2 id="12-es-介绍官网地址们"><a class="markdownIt-Anchor" href="#12-es-介绍官网地址们">#</a> 1.2 es 介绍 “官网地址们”</h2>
<ol>
<li>官方文档</li>
<li>中文官方文档 3.<a target="_blank" rel="noopener" href="https://es.xiaoleilu.com/index.html"> 中文社区</a></li>
</ol>
<h2 id="21-基本介绍"><a class="markdownIt-Anchor" href="#21-基本介绍">#</a> 2.1 基本介绍</h2>
<blockquote>
<p><strong>1、Index（索引）</strong> 动词，相当于 MySQL 中的 insert； 名词，相当于 MySQL 中的 Database<br>
<strong>2、Type（类型）</strong> 在 Index（索引）中，可以定义一个或多个类型。 类似于 MySQL 中的 Table；每一种类型的数据放在一起；<br>
<strong>3、Document（文档）</strong><br>
保存在某个索引（Index）下，某种类型（Type）的一个数据（Document），文档是 JSON 格<br>
式的，Document 就像是 MySQL 中的某个 Table 里面的内容；</p>
</blockquote>
<p><img src="https://brath.oss-cn-shanghai.aliyuncs.com/pigo/906e9a7bc76e4bba979fb394fe61a6cc.png" alt="数据概念"></p>
<h2 id="22-es是如何进行检索的呢"><a class="markdownIt-Anchor" href="#22-es是如何进行检索的呢">#</a> 2.2 ES 是如何进行检索的呢</h2>
<p><img src="https://brath.oss-cn-shanghai.aliyuncs.com/pigo/eddb7d02f575452fbfaa011cef1b75fa.png" alt="在这里插入图片描述"></p>
<h2 id="23-elasticsearch-长啥样呢有无操作界面"><a class="markdownIt-Anchor" href="#23-elasticsearch-长啥样呢有无操作界面">#</a> 2.3 ElasticSearch 长啥样呢，有无操作界面</h2>
<blockquote>
<p>ElasticSearch<br>
 是有操作界面的，它需要配置<strong> Kibana</strong>，和它一起操作方便，也是主流的一种搭配方式，安装这两个工具，不做过多介绍</p>
<p><em><strong>Kibana 介绍</strong></em> Kibana 是一款开源的数据分析和可视化平台，它是 Elastic Stack 成员之一，设计用于和 Elasticsearch 协作。您可以使用 Kibana 对 Elasticsearch 索引中的数据进行搜索、查看、交互操作。您可以很方便的利用图表、表格及地图对数据进行多元化的分析和呈现</p>
</blockquote>
<p><img src="https://brath.oss-cn-shanghai.aliyuncs.com/pigo/b90b4864012740a2bb99f48f0f2e2ab6.png" alt="在这里插入图片描述"></p>
<h2 id="24-初步检索"><a class="markdownIt-Anchor" href="#24-初步检索">#</a> 2.4 初步检索</h2>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span>、_cat</span><br><span class="line">GET /_cat/nodes：查看所有节点</span><br><span class="line">GET /_cat/health：查看 es 健康状况</span><br><span class="line">GET /_cat/master：查看主节点</span><br><span class="line">GET /_cat/indices：查看所有索引 show databases;</span><br><span class="line"><span class="number">2</span>、索引一个文档（保存）</span><br><span class="line">保存一个数据，保存在哪个索引的哪个类型下，指定用哪个唯一标识</span><br><span class="line">PUT customer/external/<span class="number">1</span>；在 customer 索引下的 external 类型下保存 <span class="number">1</span> 号数据为</span><br><span class="line"><span class="number">12345678</span></span><br><span class="line">PUT 和 POST 都可以，</span><br><span class="line">POST 新增。如果不指定 id，会自动生成 id。指定 id 就会修改这个数据，并新增版本号</span><br><span class="line">PUT 可以新增可以修改。PUT 必须指定 id；由于 PUT 需要指定 id，我们一般都用来做修改</span><br><span class="line">操作，不指定 id 会报错</span><br><span class="line"><span class="number">1234</span></span><br></pre></td></tr></table></figure>
<h2 id="241-在postman测试数据"><a class="markdownIt-Anchor" href="#241-在postman测试数据">#</a> 2.4.1 在 postMan 测试数据</h2>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">PUT customer/external/<span class="number">1</span></span><br><span class="line">&#123; <span class="string">&quot;name&quot;</span>: <span class="string">&quot;John Doe&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="number">123</span></span><br></pre></td></tr></table></figure>
<p><strong>2.4.2、查询文档</strong></p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">GET customer/external/<span class="number">1</span></span><br><span class="line"><span class="number">1</span></span><br><span class="line">结果：</span><br><span class="line">&#123; <span class="string">&quot;_index&quot;</span>: <span class="string">&quot;customer&quot;</span>, //在哪个索引</span><br><span class="line"><span class="string">&quot;_type&quot;</span>: <span class="string">&quot;external&quot;</span>, //在哪个类型</span><br><span class="line"><span class="string">&quot;_id&quot;</span>: <span class="string">&quot;1&quot;</span>, //记录 id</span><br><span class="line"><span class="string">&quot;_version&quot;</span>: <span class="number">2</span>, //版本号</span><br><span class="line"><span class="string">&quot;_seq_no&quot;</span>: <span class="number">1</span>, //并发控制字段，每次更新就会+<span class="number">1</span>，用来做乐观锁</span><br><span class="line"><span class="string">&quot;_primary_term&quot;</span>: <span class="number">1</span>, //同上，主分片重新分配，如重启，就会变化</span><br><span class="line"><span class="string">&quot;found&quot;</span>: true, <span class="string">&quot;_source&quot;</span>: &#123; //真正的内容</span><br><span class="line"><span class="string">&quot;name&quot;</span>: <span class="string">&quot;John Doe&quot;</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="number">1234567891011</span></span><br></pre></td></tr></table></figure>
<p><strong>2.4.3、更新文档</strong></p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">POST customer/external/<span class="number">1</span>/_update</span><br><span class="line">&#123; <span class="string">&quot;doc&quot;</span>:&#123; <span class="string">&quot;name&quot;</span>: <span class="string">&quot;John Doew&quot;</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">或者</span><br><span class="line">POST customer/external/<span class="number">1</span></span><br><span class="line">&#123; <span class="string">&quot;name&quot;</span>: <span class="string">&quot;John Doe2&quot;</span></span><br><span class="line">&#125;</span><br><span class="line">或者</span><br><span class="line">PUT customer/external/<span class="number">1</span></span><br><span class="line">&#123; <span class="string">&quot;name&quot;</span>: <span class="string">&quot;John Doe&quot;</span></span><br><span class="line">&#125;</span><br><span class="line">? 不同：POST 操作会对比源文档数据，如果相同不会有什么操作，文档 version 不增加</span><br><span class="line">PUT 操作总会将数据重新保存并增加 version 版本；</span><br><span class="line">带_update 对比元数据如果一样就不进行任何操作。</span><br><span class="line">看场景；</span><br><span class="line">对于大并发更新，不带 update；</span><br><span class="line">对于大并发查询偶尔更新，带 update；对比更新，重新计算分配规则。</span><br><span class="line">? 更新同时增加属性</span><br><span class="line">POST customer/external/<span class="number">1</span>/_update</span><br><span class="line">&#123; <span class="string">&quot;doc&quot;</span>: &#123; <span class="string">&quot;name&quot;</span>: <span class="string">&quot;Jane Doe&quot;</span>, <span class="string">&quot;age&quot;</span>: <span class="number">20</span> &#125;</span><br><span class="line">&#125;</span><br><span class="line">PUT 和 POST 不带_update 也可以</span><br><span class="line"><span class="number">1234567891011121314151617181920212223</span></span><br></pre></td></tr></table></figure>
<p><strong>2.4.4、删除文档 &amp; 索引</strong></p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">DELETE customer/external/<span class="number">1</span></span><br><span class="line">DELETE customer</span><br><span class="line"><span class="number">12</span></span><br></pre></td></tr></table></figure>
<p><strong>2.4.5 bulk 批量 API</strong></p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">POST customer/external/_bulk</span><br><span class="line">&#123;<span class="string">&quot;index&quot;</span>:&#123;<span class="string">&quot;_id&quot;</span>:<span class="string">&quot;1&quot;</span>&#125;&#125;</span><br><span class="line">&#123;<span class="string">&quot;name&quot;</span>: <span class="string">&quot;John Doe&quot;</span> &#125;</span><br><span class="line">&#123;<span class="string">&quot;index&quot;</span>:&#123;<span class="string">&quot;_id&quot;</span>:<span class="string">&quot;2&quot;</span>&#125;&#125;</span><br><span class="line">&#123;<span class="string">&quot;name&quot;</span>: <span class="string">&quot;Jane Doe&quot;</span> &#125;</span><br><span class="line">语法格式：</span><br><span class="line">&#123; action: &#123; metadata &#125;&#125;\n</span><br><span class="line">&#123; request body &#125;\n</span><br><span class="line">&#123; action: &#123; metadata &#125;&#125;\n</span><br><span class="line">&#123; request body &#125;\n</span><br><span class="line">复杂实例：</span><br><span class="line">POST /_bulk</span><br><span class="line">&#123; <span class="string">&quot;delete&quot;</span>: &#123; <span class="string">&quot;_index&quot;</span>: <span class="string">&quot;website&quot;</span>, <span class="string">&quot;_type&quot;</span>: <span class="string">&quot;blog&quot;</span>, <span class="string">&quot;_id&quot;</span>: <span class="string">&quot;123&quot;</span> &#125;&#125;</span><br><span class="line">&#123; <span class="string">&quot;create&quot;</span>: &#123; <span class="string">&quot;_index&quot;</span>: <span class="string">&quot;website&quot;</span>, <span class="string">&quot;_type&quot;</span>: <span class="string">&quot;blog&quot;</span>, <span class="string">&quot;_id&quot;</span>: <span class="string">&quot;123&quot;</span> &#125;&#125;</span><br><span class="line">&#123; <span class="string">&quot;title&quot;</span>: <span class="string">&quot;My first blog post&quot;</span> &#125;</span><br><span class="line">&#123; <span class="string">&quot;index&quot;</span>: &#123; <span class="string">&quot;_index&quot;</span>: <span class="string">&quot;website&quot;</span>, <span class="string">&quot;_type&quot;</span>: <span class="string">&quot;blog&quot;</span> &#125;&#125;</span><br><span class="line">&#123; <span class="string">&quot;title&quot;</span>: <span class="string">&quot;My second blog post&quot;</span> &#125;</span><br><span class="line">&#123; <span class="string">&quot;update&quot;</span>: &#123; <span class="string">&quot;_index&quot;</span>: <span class="string">&quot;website&quot;</span>, <span class="string">&quot;_type&quot;</span>: <span class="string">&quot;blog&quot;</span>, <span class="string">&quot;_id&quot;</span>: <span class="string">&quot;123&quot;</span>, <span class="string">&quot;_retry_on_conflict&quot;</span> : <span class="number">3</span>&#125; &#125;</span><br><span class="line">&#123; <span class="string">&quot;doc&quot;</span> : &#123;<span class="string">&quot;title&quot;</span> : <span class="string">&quot;My updated blog post&quot;</span>&#125; &#125;</span><br><span class="line">bulk API 以此按顺序执行所有的 action（动作）。如果一个单个的动作因任何原因而失败，</span><br><span class="line">它将继续处理它后面剩余的动作。当 bulk API 返回时，它将提供每个动作的状态（与发送</span><br><span class="line">的顺序相同），所以您可以检查是否一个指定的动作是不是失败了。</span><br><span class="line"><span class="number">12345678910111213141516171819202122</span></span><br></pre></td></tr></table></figure>
<h2 id="24-searchapi"><a class="markdownIt-Anchor" href="#24-searchapi">#</a> 2.4 SearchAPI</h2>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">ES 支持两种基本方式检索 :</span><br><span class="line">? 一个是通过使用 REST request URI 发送搜索参数（uri+检索参数）</span><br><span class="line">? 另一个是通过使用 REST request body 来发送它们（uri+请求体）</span><br><span class="line"><span class="number">1</span>）、检索信息</span><br><span class="line">? 一切检索从_search 开始</span><br><span class="line">GET bank/_search 检索 bank 下所有信息，包括 <span class="keyword">type</span> 和 docs</span><br><span class="line">GET bank/_search?q=*&amp;sort=account_number:asc 请求参数方式检索</span><br><span class="line">响应结果解释：</span><br><span class="line">took - Elasticsearch 执行搜索的时间（毫秒）</span><br><span class="line">time_out - 告诉我们搜索是否超时</span><br><span class="line">_shards - 告诉我们多少个分片被搜索了，以及统计了成功/失败的搜索分片</span><br><span class="line">hits - 搜索结果</span><br><span class="line">hits.total - 搜索结果</span><br><span class="line">hits.hits - 实际的搜索结果数组（默认为前 <span class="number">10</span> 的文档）</span><br><span class="line">sort - 结果的排序 key（键）（没有则按 score 排序）</span><br><span class="line">score 和 max_score –相关性得分和最高得分（全文检索用）</span><br><span class="line"><span class="number">12345678910111213141516</span></span><br></pre></td></tr></table></figure>
<p><strong>其他在 Kibana 操作的语句，都可以在 es 官网去查询，不做过多的赘述！！！</strong></p>
<h2 id="25-mapping映射"><a class="markdownIt-Anchor" href="#25-mapping映射">#</a> 2.5、Mapping 映射</h2>
<p><img src="https://brath.oss-cn-shanghai.aliyuncs.com/pigo/792e34eb6b8d40568272d2413c1c0aaf.png" alt="在这里插入图片描述"></p>
<blockquote>
<p>Mapping（映射） Mapping 是用来定义一个文档（document），以及它所包含的属性（field）是如何存储和<br>
索引的。比如，使用 mapping 来定义： ? 哪些字符串属性应该被看做全文本属性（full text fields）。 ?<br>
 哪些属性包含数字，日期或者地理位置。 ? 文档中的所有属性是否都能被索引（_all 配置）。 ? 日期的格式。 ?<br>
 自定义映射规则来执行动态添加属性。</p>
</blockquote>
<h2 id="26-分词"><a class="markdownIt-Anchor" href="#26-分词">#</a> 2.6 分词</h2>
<blockquote>
<p>个 tokenizer（分词器）接收一个字符流，将之分割为独立的 tokens（词元，通常是独立 的单词），然后输出 tokens 流。<br>
例如，whitespace tokenizer 遇到空白字符时分割文本。它会将文本 “Quick brown fox!” 分割 为<br>
 [Quick, brown, fox!]。 该 tokenizer（分词器）还负责记录各个 term（词条）的顺序或 position<br>
 位置（用于 phrase 短 语和 word proximity 词近邻查询），以及 term（词条）所代表的原始 word（单词）的<br>
 start （起始）和 end（结束）的 character offsets（字符偏移量）（用于高亮显示搜索的内容）。<br>
Elasticsearch 提供了很多内置的分词器，可以用来构建 custom analyzers（自定义分词器）。</p>
</blockquote>
<p><img src="https://brath.oss-cn-shanghai.aliyuncs.com/pigo/a81d083a8d594324b2d58b6d398f0dbe.png" alt="在这里插入图片描述"><br>
<strong> 2.6.1 安装分词器</strong></p>
<blockquote>
<p>注意：不能用默认 elasticsearch-plugin install xxx.zip 进行自动安装<br>
<a target="_blank" rel="noopener" href="https://github.com/medcl/elasticsearch-analysis-ik/releases?after=v6.4.2"> https://github.com/medcl/elasticsearch-analysis-ik/releases?after=v6.4.2</a><br>
 对应 es 版本安装</p>
</blockquote>
<h2 id="总结"><a class="markdownIt-Anchor" href="#总结">#</a> 总结</h2>
<blockquote>
<p>elasticsearch<br>
 功能是非常强大的，可以作为生成环境的<strong> ELK 日志</strong>存储，方便检索，也可以部署集群，提高效率，最主要是它是走内存的，查询效率极高，为大数据检索而生！！！</p>
</blockquote>
<h2 id="使用场景es"><a class="markdownIt-Anchor" href="#使用场景es">#</a> 使用场景（Es）</h2>
<p><img src="https://brath.oss-cn-shanghai.aliyuncs.com/pigo/157dbcd31b4a4534a70bf24b62050d10.png" alt="在这里插入图片描述"></p>
<hr>
<h2 id="关于我"><a class="markdownIt-Anchor" href="#关于我">#</a> 关于我</h2>
<p>Brath 是一个热爱技术的 Java 程序猿，公众号「InterviewCoder」定期分享有趣有料的精品原创文章！</p>
<p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/%E4%BA%8C%E7%BB%B4%E7%A0%81plus.png" alt="InterviewCoder"></p>
<p>非常感谢各位人才能看到这里，原创不易，文章如果有帮助可以关注、点赞、分享或评论，这都是对我的莫大支持！</p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2021-05-17T02:43:26.000Z" title="2021-5-17 10:43:26">2021-05-17</time>发表</span><span class="level-item"><time dateTime="2022-02-11T06:56:47.000Z" title="2022-2-11 14:56:47">2022-02-11</time>更新</span><span class="level-item">2 小时读完 (大约14373个字)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2021/05/17/%E3%80%90Go%E3%80%91Go%E8%AF%AD%E8%A8%80%E8%B6%85%E5%85%A8%E8%AF%A6%E8%A7%A3(%E5%85%A5%E9%97%A8%E7%BA%A7)/">Go语言超全详解（入门级）</a></p><div class="content"><p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/%E6%89%AB%E7%A0%81_%E6%90%9C%E7%B4%A2%E8%81%94%E5%90%88%E4%BC%A0%E6%92%AD%E6%A0%B7%E5%BC%8F-%E6%A0%87%E5%87%86%E8%89%B2%E7%89%88.png" alt="InterviewCoder"></p>
<h1 id="go语言超全详解入门级"><a class="markdownIt-Anchor" href="#go语言超全详解入门级">#</a> Go 语言超全详解（入门级）</h1>
<h3 id="文章目录"><a class="markdownIt-Anchor" href="#文章目录">#</a> 文章目录</h3>
<ul>
<li><a href="#1_Go_6">1. Go 语言的出现</a></li>
<li><a href="#2_gohello_world_12">2. go 版本的 hello world</a></li>
<li><a href="#3__36">3. 数据类型</a></li>
<li>
<ul>
<li><a href="#30__48">3.0 定义变量</a></li>
<li>
<ul>
<li><a href="#301__61">3.0.1 如果变量没有初始化</a></li>
<li><a href="#302__70">3.0.2 如果变量没有指定类型</a></li>
<li><a href="#303___82">3.0.3 := 符号</a></li>
<li><a href="#304__94">3.0.4 多变量声明</a></li>
<li><a href="#305__121">3.0.5 匿名变量</a></li>
<li><a href="#306__141">3.0.6 变量作用域</a></li>
</ul>
</li>
<li><a href="#31__150">3.1 基本类型</a></li>
<li><a href="#32__164">3.2 指针</a></li>
<li>
<ul>
<li><a href="#321__169">3.2.1 指针声明和初始化</a></li>
<li><a href="#322__188">3.2.2 空指针</a></li>
</ul>
</li>
<li><a href="#33__193">3.3 数组</a></li>
<li>
<ul>
<li><a href="#331__196">3.3.1 声明数组</a></li>
<li><a href="#332__208">3.3.2 初始化数组</a></li>
<li><a href="#333_go_219">3.3.3 go 中的数组名意义</a></li>
<li><a href="#334__225">3.3.4 数组指针</a></li>
</ul>
</li>
<li><a href="#34__243">3.4 结构体</a></li>
<li>
<ul>
<li><a href="#341__246">3.4.1 声明结构体</a></li>
<li><a href="#342__265">3.4.2 访问结构体成员</a></li>
<li><a href="#343__285">3.4.3 结构体指针</a></li>
</ul>
</li>
<li><a href="#35__297">3.5 字符串</a></li>
<li>
<ul>
<li><a href="#351__301">3.5.1 字符串定义和初始化</a></li>
<li><a href="#352_UTF8_317">3.5.2 字符串 UTF8 编码</a></li>
<li><a href="#353__343">3.5.3 字符串的强制类型转换</a></li>
</ul>
</li>
<li><a href="#36_slice_354">3.6 slice</a></li>
<li>
<ul>
<li><a href="#361_slice_359">3.6.1 slice 定义</a></li>
<li><a href="#362__381">3.6.2 添加元素</a></li>
<li><a href="#363__428">3.6.3 删除元素</a></li>
</ul>
</li>
<li><a href="#37__491">3.7 函数</a></li>
<li>
<ul>
<li><a href="#371__493">3.7.1 函数分类</a></li>
<li><a href="#372__521">3.7.2 函数声明和定义</a></li>
<li><a href="#373__538">3.7.3 函数传参</a></li>
<li><a href="#374__559">3.7.4 函数返回值</a></li>
<li><a href="#375__610">3.7.5 递归调用</a></li>
</ul>
</li>
<li><a href="#38__628">3.8 方法</a></li>
<li><a href="#39__673">3.9 接口</a></li>
<li>
<ul>
<li><a href="#391__674">3.9.1 什么是接口</a></li>
<li><a href="#392__684">3.9.2 结构体类型</a></li>
<li><a href="#393__738">3.9.3 具体类型向接口类型赋值</a></li>
<li><a href="#394__749">3.9.4 获取接口类型数据的具体类型信息</a></li>
</ul>
</li>
<li><a href="#310_channel_754">3.10 channel</a></li>
<li>
<ul>
<li><a href="#3101__755">3.10.1 相关结构体定义</a></li>
<li><a href="#3102_channel_794">3.10.2 阻塞式读写 channel 操作</a></li>
<li><a href="#3103_channel_826">3.10.3 非阻塞式读写 channel 操作</a></li>
</ul>
</li>
<li><a href="#311_map_855">3.11 map</a></li>
<li>
<ul>
<li><a href="#3111__944">3.11.1 插入数据</a></li>
<li><a href="#3112__957">3.11.2 删除数据</a></li>
<li><a href="#3113__966">3.11.3 查找数据</a></li>
<li><a href="#3114__980">3.11.4 扩容</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#4__1012">4. 常用语句及关键字</a></li>
<li>
<ul>
<li><a href="#41__1014">4.1 条件语句</a></li>
<li><a href="#42__1078">4.2 循环语句</a></li>
<li>
<ul>
<li><a href="#421__1079">4.2.1 循环处理语句</a></li>
<li><a href="#421__1095">4.2.1 循环控制语句</a></li>
</ul>
</li>
<li><a href="#43__1200">4.3 关键字</a></li>
</ul>
</li>
</ul>
<hr>
<h1 id="1-go语言的出现"><a class="markdownIt-Anchor" href="#1-go语言的出现">#</a> 1. Go 语言的出现</h1>
<p>在具体学习 go 语言的基础语法之前，我们来了解一下 go 语言出现的时机及其特点。</p>
<p>Go 语言最初由 Google 公司的 Robert Griesemer、Ken Thompson 和 Rob Pike 三个大牛于 2007 年开始设计发明，他们最终的目标是设计一种<strong>适应网络和多核时代的 C 语言</strong>。所以 Go 语言很多时候被描述为 “类 C 语言”，或者是 “21 世纪的 C 语言”，当然从各种角度看，Go 语言确实是从 C 语言继承了相似的表达式语法、控制流结构、基础数据类型、调用参数传值、指针等诸多编程思想。但是 Go 语言更是对 C 语言最彻底的一次扬弃，它舍弃了 C 语言中灵活但是危险的指针运算，还重新设计了 C 语言中部分不太合理运算符的优先级，并在很多细微的地方都做了必要的打磨和改变。</p>
<h1 id="2-go版本的hello-world"><a class="markdownIt-Anchor" href="#2-go版本的hello-world">#</a> 2. go 版本的 hello world</h1>
<p>在这一部分我们只是使用 “hello world” 的程序来向大家介绍一下 go 语言的所编写的程序的基本组成。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">package main</span><br><span class="line">import <span class="string">&quot;fmt&quot;</span></span><br><span class="line">func <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">	<span class="comment">// 终端输出hello world</span></span><br><span class="line">	fmt.Println(<span class="string">&quot;Hello world!&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"><span class="number">123456</span></span><br></pre></td></tr></table></figure>
<p>和 C 语言相似，go 语言的基本组成有：</p>
<ul>
<li>包声明，编写源文件时，必须在非注释的第一行指明这个文件属于哪个包，如 <code>package main</code> 。</li>
<li>引入包，其实就是告诉 Go 编译器这个程序需要使用的包，如 <code>import &quot;fmt&quot;</code>  其实就是引入了 fmt 包。</li>
<li>函数，和 c 语言相同，即是一个可以实现某一个功能的函数体，每一个可执行程序中必须拥有一个 main 函数。</li>
<li>变量，Go 语言变量名由字母、数字、下划线组成，其中首个字符不能为数字。</li>
<li>语句 / 表达式，在 Go 程序中，一行代表一个语句结束。每个语句不需要像 C 家族中的其它语言一样以分号；结尾，因为这些工作都将由 Go 编译器自动完成。</li>
<li>注释，和 c 语言中的注释方式相同，可以在任何地方使用以 // 开头的单行注释。以 /* 开头，并以 */ 结尾来进行多行注释，且不可以嵌套使用，多行注释一般用于包的文档描述或注释成块的代码片段。</li>
</ul>
<blockquote>
<p>需要注意的是：<strong>标识符</strong>是用来命名变量、类型等程序实体。一个标识符实际上就是一个或是多个字母和数字、下划线_组成的序列，但是第一个字符必须是字母或下划线而不能是数字。</p>
<ol>
<li>当标识符（包括常量、变量、类型、函数名、结构字段等等）以一个大写字母开头，如：Group1，那么使用这种形式的标识符的对象就可以被外部包的代码所使用（客户端程序需要先导入这个包），这被称为导出（像面向对象语言中的 public）；</li>
<li>标识符如果以小写字母开头，则对包外是不可见的，但是他们在整个包的内部是可见并且可用的（像面向对象语言中的 protected）。</li>
</ol>
</blockquote>
<h1 id="3-数据类型"><a class="markdownIt-Anchor" href="#3-数据类型">#</a> 3. 数据类型</h1>
<p>在 Go 编程语言中，数据类型用于声明函数和变量。</p>
<p>数据类型的出现是为了把数据分成所需内存大小不同的数据，编程的时候需要用大数据的时候才需要申请大内存，就可以充分利用内存。具体分类如下：</p>
<table>
<thead>
<tr>
<th>类型</th>
<th>详解</th>
</tr>
</thead>
<tbody>
<tr>
<td>布尔型</td>
<td>布尔型的值只可以是常量 true 或者 false。</td>
</tr>
<tr>
<td>数字类型</td>
<td>整型 int 和浮点型 float。Go 语言支持整型和浮点型数字，并且支持复数，其中位的运算采用补码。</td>
</tr>
<tr>
<td>字符串类型</td>
<td>字符串就是一串固定长度的字符连接起来的字符序列。Go 的字符串是由单个字节连接起来的。Go 语言的字符串的字节使用 UTF-8 编码标识 Unicode 文本。</td>
</tr>
<tr>
<td>派生类型</td>
<td>(a) 指针类型（Pointer）(b) 数组类型 © 结构化类型 (struct)(d) Channel 类型 (e) 函数类型 (f) 切片类型 (g) 接口类型（interface）(h) Map 类型</td>
</tr>
</tbody>
</table>
<h2 id="30-定义变量"><a class="markdownIt-Anchor" href="#30-定义变量">#</a> 3.0 定义变量</h2>
<p>声明变量的一般形式是使用 var 关键字，具体格式为： <code>var identifier typename</code> 。如下的代码中我们定义了一个类型为 int 的变量。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;fmt&quot;</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	<span class="keyword">var</span> a <span class="type">int</span> = <span class="number">27</span></span><br><span class="line">	fmt.Println(a);</span><br><span class="line">&#125; </span><br><span class="line"><span class="number">123456</span></span><br></pre></td></tr></table></figure>
<h3 id="301-如果变量没有初始化"><a class="markdownIt-Anchor" href="#301-如果变量没有初始化">#</a> 3.0.1 如果变量没有初始化</h3>
<p>在 go 语言中定义了一个变量，指定变量类型，如果没有初始化，则变量默认为零值。<strong>零值就是变量没有做初始化时系统默认设置的值</strong>。</p>
<table>
<thead>
<tr>
<th>类型</th>
<th>零值</th>
</tr>
</thead>
<tbody>
<tr>
<td>数值类型</td>
<td>0</td>
</tr>
<tr>
<td>布尔类型</td>
<td>false</td>
</tr>
<tr>
<td>字符串</td>
<td>“”（空字符串）</td>
</tr>
</tbody>
</table>
<h3 id="302-如果变量没有指定类型"><a class="markdownIt-Anchor" href="#302-如果变量没有指定类型">#</a> 3.0.2 如果变量没有指定类型</h3>
<p>在 go 语言中如果没有指定变量类型，可以通过变量的初始值来判断变量类型。如下代码</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;fmt&quot;</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">var</span> d = <span class="literal">true</span></span><br><span class="line">    fmt.Println(d)</span><br><span class="line">&#125;</span><br><span class="line"><span class="number">123456</span></span><br></pre></td></tr></table></figure>
<h3 id="303-符号"><a class="markdownIt-Anchor" href="#303-符号">#</a> 3.0.3 := 符号</h3>
<p>当我们定义一个变量后又使用该符号初始化变量，就会产生编译错误，因为该符号其实是一个声明语句。</p>
<p>使用格式： <code>typename := value</code></p>
<p>也就是说 <code>intVal := 1</code>  相等于：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> intVal <span class="type">int</span> </span><br><span class="line">intVal =<span class="number">1</span> </span><br><span class="line"><span class="number">12</span></span><br></pre></td></tr></table></figure>
<h3 id="304-多变量声明"><a class="markdownIt-Anchor" href="#304-多变量声明">#</a> 3.0.4 多变量声明</h3>
<p>可以同时声明多个类型相同的变量（非全局变量），如下图所示：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> x, y <span class="type">int</span></span><br><span class="line"><span class="keyword">var</span> c, d <span class="type">int</span> = <span class="number">1</span>, <span class="number">2</span></span><br><span class="line">g, h := <span class="number">123</span>, <span class="string">&quot;hello&quot;</span></span><br><span class="line"><span class="number">123</span></span><br></pre></td></tr></table></figure>
<p>关于全局变量的声明如下：<br>
 <code>var ( vname1 v_type1 vname2 v_type2 )</code> <br>
 具体举例如下：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> ( </span><br><span class="line">    a <span class="type">int</span></span><br><span class="line">    b <span class="type">bool</span></span><br><span class="line">)</span><br><span class="line"><span class="number">1234</span></span><br></pre></td></tr></table></figure>
<h3 id="305-匿名变量"><a class="markdownIt-Anchor" href="#305-匿名变量">#</a> 3.0.5 匿名变量</h3>
<p>匿名变量的特点是一个下画线 <code>_</code> ，这本身就是一个特殊的标识符，被称为空白标识符。它可以像其他标识符那样用于变量的声明或赋值（任何类型都可以赋值给它），但任何赋给这个标识符的值都将被抛弃，因此这些值<strong>不能在后续的代码中使用</strong>，也不可以使用这个标识符作为变量对其它变量进行赋值或运算。</p>
<p>使用匿名变量时，只需要在<strong>变量声明的地方</strong>使用下画线替换即可。</p>
<p>示例代码如下：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">GetData</span><span class="params">()</span></span> (<span class="type">int</span>, <span class="type">int</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">10</span>, <span class="number">20</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">        a, _ := GetData()</span><br><span class="line">        _, b := GetData()</span><br><span class="line">        fmt.Println(a, b)</span><br><span class="line">    &#125;</span><br><span class="line"><span class="number">12345678</span></span><br></pre></td></tr></table></figure>
<p>需要注意的是匿名变量不占用内存空间，不会分配内存。匿名变量与匿名变量之间也不会因为多次声明而无法使用。</p>
<h3 id="306-变量作用域"><a class="markdownIt-Anchor" href="#306-变量作用域">#</a> 3.0.6 变量作用域</h3>
<p>作用域指的是已声明的标识符所表示的常量、类型、函数或者包在源代码中的作用范围，在此我们主要看一下 go 中变量的作用域，根据变量定义位置的不同，可以分为一下三个类型：</p>
<ol>
<li>函数内定义的变量为<strong>局部变量</strong>，这种局部变量的作用域只在函数体内，函数的参数和返回值变量都属于局部变量。这种变量在存在于函数被调用时，销毁于函数调用结束后。</li>
<li>函数外定义的变量为<strong>全局变量</strong>，全局变量只需要在一个源文件中定义，就可以在所有源文件中使用，甚至可以使用 import 引入外部包来使用。全局变量声明必须<strong>以 var 关键字开头</strong>，如果想要在<strong>外部包中使用</strong>全局变量的<strong>首字母必须大写</strong>。</li>
<li>函数定义中的变量成为<strong>形式参数</strong>，定义函数时函数名后面括号中的变量叫做形式参数（简称形参）。形式参数只在函数调用时才会生效，函数调用结束后就会被销毁，在函数未被调用时，函数的形参并不占用实际的存储单元，也没有实际值。<strong>形式参数会作为函数的局部变量来使用</strong>。</li>
</ol>
<h2 id="31-基本类型"><a class="markdownIt-Anchor" href="#31-基本类型">#</a> 3.1 基本类型</h2>
<table>
<thead>
<tr>
<th>类型</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>uint8 / uint16 / uint32 / uint64</td>
<td>无符号 8 / 16 / 32 / 64 位整型</td>
</tr>
<tr>
<td>int8 / int16 / int32 / int64</td>
<td>有符号 8 / 16 / 32 / 64 位整型</td>
</tr>
<tr>
<td>float32 / float64</td>
<td>IEEE-754 32 / 64 位浮点型数</td>
</tr>
<tr>
<td>complex64 / complex128</td>
<td>32 / 64 位实数和虚数</td>
</tr>
<tr>
<td>byte</td>
<td>类似 uint8</td>
</tr>
<tr>
<td>rune</td>
<td>类似 int32</td>
</tr>
<tr>
<td>uintptr</td>
<td>无符号整型，用于存放一个指针</td>
</tr>
</tbody>
</table>
<p>以上就是 go 语言基本的数据类型，有了数据类型，我们就可以使用这些类型来定义变量，Go 语言变量名由字母、数字、下划线组成，其中首个字符不能为数字。</p>
<h2 id="32-指针"><a class="markdownIt-Anchor" href="#32-指针">#</a> 3.2 指针</h2>
<p>与 C 相同，Go 语言让程序员决定何时使用指针。变量其实是一种使用方便的占位符，用于引用计算机内存地址。Go 语言中的的取地址符是 <code>&amp;</code> ，放到一个变量前使用就会返回相应变量的内存地址。</p>
<p>指针变量其实就是用于存放某一个对象的内存地址。</p>
<h3 id="321-指针声明和初始化"><a class="markdownIt-Anchor" href="#321-指针声明和初始化">#</a> 3.2.1 指针声明和初始化</h3>
<p>和基础类型数据相同，在使用指针变量之前我们首先需要申明指针，声明格式如下： <code>var var_name *var-type</code> ，其中的 var-type 为指针类型，var_name 为指针变量名，* 号用于指定变量是作为一个指针。</p>
<p>代码举例如下：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> ip *<span class="type">int</span>        <span class="comment">/* 指向整型*/</span></span><br><span class="line"><span class="keyword">var</span> fp *<span class="type">float32</span>    <span class="comment">/* 指向浮点型 */</span></span><br><span class="line"><span class="number">12</span></span><br></pre></td></tr></table></figure>
<p>指针的初始化就是取出相对应的变量地址对指针进行赋值，具体如下：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">   <span class="keyword">var</span> a <span class="type">int</span>= <span class="number">20</span>   <span class="comment">/* 声明实际变量 */</span></span><br><span class="line">   <span class="keyword">var</span> ip *<span class="type">int</span>        <span class="comment">/* 声明指针变量 */</span></span><br><span class="line"></span><br><span class="line">   ip = &amp;a  <span class="comment">/* 指针变量的存储地址 */</span></span><br><span class="line"><span class="number">1234</span></span><br></pre></td></tr></table></figure>
<h3 id="322-空指针"><a class="markdownIt-Anchor" href="#322-空指针">#</a> 3.2.2 <a target="_blank" rel="noopener" href="https://so.csdn.net/so/search?q=%E7%A9%BA%E6%8C%87%E9%92%88&amp;spm=1001.2101.3001.7020">空指针</a></h3>
<p>当一个指针被定义后<strong>没有分配到任何变量</strong>时，它的值为 <strong>nil</strong>，也称为空指针。它概念上和其它语言的 null、NULL 一样，都指代零值或空值。</p>
<h2 id="33-数组"><a class="markdownIt-Anchor" href="#33-数组">#</a> 3.3 数组</h2>
<p>和 c 语言相同，Go 语言也提供了数组类型的数据结构，数组是具有<strong>相同唯一类型</strong>的一组已编号且<strong>长度固定</strong>的数据项序列，这种类型可以是任意的原始类型例如整型、字符串或者自定义类型。</p>
<h3 id="331-声明数组"><a class="markdownIt-Anchor" href="#331-声明数组">#</a> 3.3.1 <a target="_blank" rel="noopener" href="https://so.csdn.net/so/search?q=%E5%A3%B0%E6%98%8E%E6%95%B0%E7%BB%84&amp;spm=1001.2101.3001.7020">声明数组</a></h3>
<p>Go 语言数组声明需要指定元素类型及元素个数，语法格式如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">var variable_name [SIZE] variable_type</span><br></pre></td></tr></table></figure>
<p>以上就可以定一个一维数组，我们举例代码如下：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> balance [<span class="number">10</span>] <span class="type">float32</span></span><br><span class="line"><span class="number">1</span></span><br></pre></td></tr></table></figure>
<h3 id="332-初始化数组"><a class="markdownIt-Anchor" href="#332-初始化数组">#</a> 3.3.2 初始化数组</h3>
<p>数组的初始化方式有不止一种方式，我们列举如下：</p>
<ol>
<li>直接进行初始化： <code>var balance = [5]float32&#123;1000.0, 2.0, 3.4, 7.0, 50.0&#125;</code></li>
<li>通过字面量在声明数组的同时快速初始化数组： <code>balance := [5]float32&#123;1000.0, 2.0, 3.4, 7.0, 50.0&#125;</code></li>
<li>数组长度不确定，编译器通过元素个数自行推断数组长度，在 [ ] 中填入 <code>...</code> ，举例如下： <code>var balance = [...]float32&#123;1000.0, 2.0, 3.4, 7.0, 50.0&#125;</code>  和 <code>balance := [...]float32&#123;1000.0, 2.0, 3.4, 7.0, 50.0&#125;</code></li>
<li>数组长度确定，指定下标进行部分初始化： <code>balanced := [5]float32(1:2.0, 3:7.0)</code></li>
</ol>
<blockquote>
<p>注意：</p>
<ul>
<li>初始化数组中 {} 中的元素个数不能大于 [] 中的数字。<br>
如果忽略 [] 中的数字不设置数组大小，Go 语言会根据元素的个数来设置数组的大小。</li>
</ul>
</blockquote>
<h3 id="333-go中的数组名意义"><a class="markdownIt-Anchor" href="#333-go中的数组名意义">#</a> 3.3.3 go 中的数组名意义</h3>
<p>在 c 语言中我们知道数组名在本质上是数组中第一个元素的地址，而在 go 语言中，数组名仅仅表示整个数组，是一个完整的值，一个数组变量即是表示整个数组。</p>
<p>所以在 go 中一个数组变量被赋值或者被传递的时候实际上就会复制整个数组。如果数组比较大的话，这种复制往往会占有很大的开销。所以为了避免这种开销，往往需要传递一个指向数组的指针，这个数组指针并不是数组。关于数组指针具体在指针的部分深入的了解。</p>
<h3 id="334-数组指针"><a class="markdownIt-Anchor" href="#334-数组指针">#</a> 3.3.4 数组指针</h3>
<p>通过数组和指针的知识我们就可以定义一个数组指针，代码如下：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> a = [...]<span class="type">int</span>&#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>&#125; <span class="comment">// a 是一个数组</span></span><br><span class="line"><span class="keyword">var</span> b = &amp;a                <span class="comment">// b 是指向数组的指针</span></span><br><span class="line"><span class="number">12</span></span><br></pre></td></tr></table></figure>
<p>数组指针除了可以防止数组作为参数传递的时候浪费空间，还可以利用其和 <code>for range</code>  来遍历数组，具体代码如下：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> i, v := <span class="keyword">range</span> b &#123;     <span class="comment">// 通过数组指针迭代数组的元素</span></span><br><span class="line">    fmt.Println(i, v)</span><br><span class="line">&#125;</span><br><span class="line"><span class="number">123</span></span><br></pre></td></tr></table></figure>
<p>具体关于 go 语言的循环语句我们在后文中再进行详细介绍。</p>
<h2 id="34-结构体"><a class="markdownIt-Anchor" href="#34-结构体">#</a> 3.4 结构体</h2>
<p>通过上述数组的学习，我们就可以直接定义多个同类型的变量，但这往往也是一种限制，只能存储同一种类型的数据，而我们在结构体中就可以定义多个不同的数据类型。</p>
<h3 id="341-声明结构体"><a class="markdownIt-Anchor" href="#341-声明结构体">#</a> 3.4.1 声明结构体</h3>
<p>在声明结构体之前我们首先需要定义一个结构体类型，这需要使用 type 和 struct，type 用于设定结构体的名称，struct 用于定义一个新的数据类型。具体结构如下：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> struct_variable_type <span class="keyword">struct</span> &#123;</span><br><span class="line">   member definition</span><br><span class="line">   member definition</span><br><span class="line">   ...</span><br><span class="line">   member definition</span><br><span class="line">&#125;</span><br><span class="line"><span class="number">123456</span></span><br></pre></td></tr></table></figure>
<p>定义好了结构体类型，我们就可以使用该结构体声明这样一个结构体变量，语法如下：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">variable_name := structure_variable_type &#123;value1, value2...valuen&#125;</span><br><span class="line"></span><br><span class="line">variable_name := structure_variable_type &#123; key1: value1, key2: value2..., keyn: valuen&#125;</span><br><span class="line"><span class="number">123</span></span><br></pre></td></tr></table></figure>
<h3 id="342-访问结构体成员"><a class="markdownIt-Anchor" href="#342-访问结构体成员">#</a> 3.4.2 访问结构体成员</h3>
<p>如果要访问结构体成员，需要使用点号  <code>.</code>  操作符，格式为： <code>结构体变量名.成员名</code> 。举例代码如下：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;fmt&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Books <span class="keyword">struct</span> &#123;</span><br><span class="line">   title <span class="type">string</span></span><br><span class="line">   author <span class="type">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	<span class="keyword">var</span> book1 Books</span><br><span class="line">	Book1.title = <span class="string">&quot;Go 语言入门&quot;</span></span><br><span class="line">	Book1.author = <span class="string">&quot;mars.hao&quot;</span>	</span><br><span class="line">&#125;</span><br><span class="line"><span class="number">1234567891011121314</span></span><br></pre></td></tr></table></figure>
<h3 id="343-结构体指针"><a class="markdownIt-Anchor" href="#343-结构体指针">#</a> 3.4.3 结构体指针</h3>
<p>关于结构体指针的定义和申明同样可以套用前文中讲到的指针的相关定义，从而使用一个指针变量存放一个结构体变量的地址。</p>
<p>定义一个结构体变量的语法： <code>var struct_pointer *Books</code> 。</p>
<p>这种指针变量的初始化和上文指针部分的初始化方式相同 <code>struct_pointer = &amp;Book1</code> ，但是和 c 语言中有所不同，使用结构体指针访问结构体成员仍然使用 <code>.</code>  操作符。格式如下： <code>struct_pointer.title</code></p>
<h2 id="35-字符串"><a class="markdownIt-Anchor" href="#35-字符串">#</a> 3.5 字符串</h2>
<p>一个字符串是一个<strong>不可改变</strong>的字节序列，字符串通常是用来包含人类可读的文本数据。和数组不同的是，字符串的元素不可修改，是一个只读的<strong>字节数组</strong>。每个字符串的长度虽然也是固定的，但是字符串的长度并不是字符串类型的一部分。</p>
<h3 id="351-字符串定义和初始化"><a class="markdownIt-Anchor" href="#351-字符串定义和初始化">#</a> 3.5.1 字符串定义和初始化</h3>
<p>Go 语言字符串的底层结构在 reflect.StringHeader 中定义，具体如下：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> StringHeader <span class="keyword">struct</span> &#123;</span><br><span class="line">    Data <span class="type">uintptr</span></span><br><span class="line">    Len  <span class="type">int</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="number">1234</span></span><br></pre></td></tr></table></figure>
<p>也就是说字符串结构由两个信息组成：第一个是字符串指向的底层字节数组，第二个是字符串的字节的长度。</p>
<p>字符串其实是一个结构体，因此字符串的赋值操作也就是 reflect.StringHeader 结构体的复制过程，并不会涉及底层字节数组的复制，所以我们也可以将字符串数组看作一个结构体数组。</p>
<p>字符串和数组类似，内置的 len 函数返回字符串的长度。</p>
<h3 id="352-字符串utf8编码"><a class="markdownIt-Anchor" href="#352-字符串utf8编码">#</a> 3.5.2 字符串 UTF8 编码</h3>
<p>根据 Go 语言规范，Go 语言的源文件都是采用<strong> UTF8</strong> 编码。因此，Go 源文件中出现的字符串面值常量一般也是 UTF8 编码的（对于转义字符，则没有这个限制）。提到 Go 字符串时，我们一般都会假设字符串对应的是一个合法的 UTF8 编码的字符序列。</p>
<p>Go 语言的字符串中可以存放任意的二进制字节序列，而且即使是 UTF8 字符序列也可能会遇到坏的编码。如果遇到一个<strong>错误的 UTF8 编码输入</strong>，将生成一个<strong>特别的 Unicode 字符</strong>‘\uFFFD’，这个字符在不同的软件中的显示效果可能不太一样，在印刷中这个符号通常是一个黑色六角形或钻石形状，里面包含一个白色的问号‘ ’。</p>
<p>下面的字符串中，我们故意损坏了第一字符的第二和第三字节，因此第一字符将会打印为 “”，第二和第三字节则被忽略；后面的 “abc” 依然可以正常解码打印（<strong>错误编码不会向后扩散是 UTF8 编码的优秀特性之一</strong>）。代码如下：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">fmt.Println(<span class="string">&quot;\xe4\x00\x00\xe7\x95\x8cabc&quot;</span>) <span class="comment">//  界abc</span></span><br><span class="line"><span class="number">1</span></span><br></pre></td></tr></table></figure>
<p>不过在 for range 迭代这个含有损坏的 UTF8 字符串时，第一字符的第二和第三字节依然会被单独迭代到，不过此时迭代的值是损坏后的 0：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 0 65533  // \uFFFD, 对应  </span></span><br><span class="line"><span class="comment">// 1 0      // 空字符</span></span><br><span class="line"><span class="comment">// 2 0      // 空字符</span></span><br><span class="line"><span class="comment">// 3 30028  // 界</span></span><br><span class="line"><span class="comment">// 6 97     // a</span></span><br><span class="line"><span class="comment">// 7 98     // b</span></span><br><span class="line"><span class="comment">// 8 99     // c</span></span><br><span class="line"><span class="number">1234567</span></span><br></pre></td></tr></table></figure>
<h3 id="353-字符串的强制类型转换"><a class="markdownIt-Anchor" href="#353-字符串的强制类型转换">#</a> 3.5.3 字符串的强制类型转换</h3>
<p>在上文中我们知道源代码往往会采用 UTF8 编码，如果不想解码 UTF8 字符串，想直接遍历原始的字节码：</p>
<ol>
<li>可以将字符串强制转为 [] byte 字节序列后再行遍历（这里的转换一般不会产生运行时开销）：</li>
<li>采用传统的下标方式遍历字符串的字节数组</li>
</ol>
<p>除此以外，字符串相关的强制类型转换主要<strong>涉及到 [] byte 和 [] rune 两种类型</strong>。每个转换都可能隐含<strong>重新分配内存</strong>的代价，最坏的情况下它们的运算时间复杂度都是 O (n)。</p>
<p>不过字符串和 [] rune 的转换要更为特殊一些，因为一般这种强制类型转换要求两个类型的底层内存结构要尽量一致，显然它们底层对应的 [] byte 和 [] int32 类型是完全不同的内部布局，因此这种转换可能隐含重新分配内存的操作。</p>
<h2 id="36-slice"><a class="markdownIt-Anchor" href="#36-slice">#</a> 3.6 slice</h2>
<p>简单地说，切片就是一种简化版的<strong>动态数组</strong>。因为动态数组的<strong>长度不固定</strong>，切片的长度自然也就不能是类型的组成部分了。数组虽然有适用它们的地方，但是数组的类型和操作都不够灵活，而切片则使用得相当广泛。</p>
<p>切片高效操作的要点是要降低内存分配的次数，尽量保证 append 操作（在后续的插入和删除操作中都涉及到这个函数）不会超出 cap 的容量，降低触发内存分配的次数和每次分配内存大小。</p>
<h3 id="361-slice定义"><a class="markdownIt-Anchor" href="#361-slice定义">#</a> 3.6.1 slice 定义</h3>
<p>我们先看看切片的结构定义，reflect.SliceHeader：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> SliceHeader <span class="keyword">struct</span> &#123;</span><br><span class="line">    Data <span class="type">uintptr</span>   <span class="comment">// 指向底层的的数组指针</span></span><br><span class="line">    Len  <span class="type">int</span>	   <span class="comment">// 切片长度</span></span><br><span class="line">    Cap  <span class="type">int</span>	   <span class="comment">// 切片最大长度</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="number">12345</span></span><br></pre></td></tr></table></figure>
<p>和数组一样，内置的 len 函数返回切片中有效元素的长度，内置的 cap 函数返回切片容量大小，容量必须大于或等于切片的长度。</p>
<p>切片可以和<strong> nil</strong> 进行比较，只有当切片<strong>底层数据指针为空时</strong>切片本身为 nil，这时候<strong>切片的长度和容量信息将是无效的</strong>。如果有切片的底层数据指针为空，但是长度和容量不为 0 的情况，那么说明切片本身已经被损坏了</p>
<p>只要是<strong>切片的底层</strong>数据指针、长度和容量<strong>没有发生变化</strong>的话，对切片的遍历、元素的读取和修改都和数组是一样的。在对切片本身赋值或参数传递时，和数组指针的操作方式类似，只是复制切片头信息（reflect.SliceHeader），并不会复制底层的数据。对于类型，和数组的最大不同是，切片的类型和长度信息无关，只要是相同类型元素构成的切片均对应相同的切片类型。</p>
<p>当我们想定义声明一个切片时可以如下：</p>
<p>在对切片本身赋值或参数传递时，和数组指针的操作方式类似，只是复制切片头信息・（reflect.SliceHeader），并不会复制底层的数据。对于类型，和数组的最大不同是，切片的类型和长度信息无关，<strong>只要是相同类型元素构成的切片均对应相同的切片类型</strong>。</p>
<h3 id="362-添加元素"><a class="markdownIt-Anchor" href="#362-添加元素">#</a> 3.6.2 添加元素</h3>
<p><code>append()</code>  ：内置的泛型函数，可以向切片中增加元素。</p>
<ol>
<li>在切片尾部追加 N 个元素</li>
</ol>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> a []<span class="type">int</span></span><br><span class="line">a = <span class="built_in">append</span>(a, <span class="number">1</span>)               <span class="comment">// 追加1个元素</span></span><br><span class="line">a = <span class="built_in">append</span>(a, <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>)         <span class="comment">// 追加多个元素, 手写解包方式</span></span><br><span class="line">a = <span class="built_in">append</span>(a, []<span class="type">int</span>&#123;<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>&#125;...) <span class="comment">// 追加一个切片, 切片需要解包</span></span><br><span class="line"><span class="number">1234</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>注意：尾部添加在容量不足的条件下需要重新分配内存，可能导致巨大的内存分配和复制数据代价。即使容量足够，依然需要用 append 函数的返回值来更新切片本身，因为新切片的长度已经发生了变化。</p>
</blockquote>
<ol>
<li>在切片开头位置添加元素</li>
</ol>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> a = []<span class="type">int</span>&#123;<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>&#125;</span><br><span class="line">a = <span class="built_in">append</span>([]<span class="type">int</span>&#123;<span class="number">0</span>&#125;, a...)        <span class="comment">// 在开头位置添加1个元素</span></span><br><span class="line">a = <span class="built_in">append</span>([]<span class="type">int</span>&#123;<span class="number">-3</span>,<span class="number">-2</span>,<span class="number">-1</span>&#125;, a...) <span class="comment">// 在开头添加1个切片</span></span><br><span class="line"><span class="number">123</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>注意：在开头一般都会导致内存的重新分配，而且会导致已有的元素全部复制 1 次。因此，从切片的开头添加元素的性能一般要比从尾部追加元素的性能差很多。</p>
</blockquote>
<ol>
<li>append 链式操作</li>
</ol>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> a []<span class="type">int</span></span><br><span class="line">a = <span class="built_in">append</span>(a[:i], <span class="built_in">append</span>([]<span class="type">int</span>&#123;x&#125;, a[i:]...)...)     <span class="comment">// 在第i个位置插入x</span></span><br><span class="line">a = <span class="built_in">append</span>(a[:i], <span class="built_in">append</span>([]<span class="type">int</span>&#123;<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>&#125;, a[i:]...)...) <span class="comment">// 在第i个位置插入切片</span></span><br><span class="line"><span class="number">123</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>每个添加操作中的第二个 append 调用都会创建一个<strong>临时切片</strong>，并将 a [i:] 的内容复制到新创建的切片中，然后将临时创建的切片再追加到 a [:i]。</p>
</blockquote>
<ol>
<li>append 和 copy 组合</li>
</ol>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">a = <span class="built_in">append</span>(a, <span class="number">0</span>)     <span class="comment">// 切片扩展1个空间</span></span><br><span class="line"><span class="built_in">copy</span>(a[i+<span class="number">1</span>:], a[i:]) <span class="comment">// a[i:]向后移动1个位置</span></span><br><span class="line">a[i] = x             <span class="comment">// 设置新添加的元素</span></span><br><span class="line"><span class="number">123</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>第三个操作中会创建一个临时对象，我们可以借用 copy 函数避免这个操作，这种方式操作语句虽然冗长了一点，但是相比前面的方法，可以减少中间创建的临时切片。</p>
</blockquote>
<h3 id="363-删除元素"><a class="markdownIt-Anchor" href="#363-删除元素">#</a> 3.6.3 删除元素</h3>
<p>根据要删除元素的位置有三种情况：</p>
<ol>
<li>从开头位置删除；</li>
</ol>
<ul>
<li>直接移动数据指针，代码如下：</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">a = []<span class="type">int</span>&#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, ...&#125;</span><br><span class="line">a = a[<span class="number">1</span>:]                       <span class="comment">// 删除开头1个元素</span></span><br><span class="line">a = a[N:]                       <span class="comment">// 删除开头N个元素</span></span><br><span class="line"><span class="number">123</span></span><br></pre></td></tr></table></figure>
<ul>
<li>将后面的数据向开头移动，使用<strong> append 原地完成</strong>（所谓原地完成是指在原有的切片数据对应的内存区间内完成，不会导致内存空间结构的变化）</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">a = []<span class="type">int</span>&#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, ...&#125;</span><br><span class="line">a = <span class="built_in">append</span>(a[:<span class="number">0</span>], a[<span class="number">1</span>:]...) <span class="comment">// 删除开头1个元素</span></span><br><span class="line">a = <span class="built_in">append</span>(a[:<span class="number">0</span>], a[N:]...) <span class="comment">// 删除开头N个元素</span></span><br><span class="line"><span class="number">123</span></span><br></pre></td></tr></table></figure>
<ul>
<li>使用 copy 将后续数据向前移动，代码如下：</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">a = []<span class="type">int</span>&#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>&#125;</span><br><span class="line">a = a[:<span class="built_in">copy</span>(a, a[<span class="number">1</span>:])] <span class="comment">// 删除开头1个元素</span></span><br><span class="line">a = a[:<span class="built_in">copy</span>(a, a[N:])] <span class="comment">// 删除开头N个元素</span></span><br><span class="line"><span class="number">123</span></span><br></pre></td></tr></table></figure>
<ol>
<li>从中间位置删除；<br>
对于删除中间的元素，需要对剩余的元素进行一次整体挪动，同样可以用 append 或 copy 原地完成：</li>
</ol>
<ul>
<li>append 删除操作如下：</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">a = []<span class="type">int</span>&#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, ...&#125;</span><br><span class="line">a = <span class="built_in">append</span>(a[:i], a[i+<span class="number">1</span>], ...)</span><br><span class="line">a = <span class="built_in">append</span>(a[:i], a[i+N:], ...)</span><br><span class="line"><span class="number">123</span></span><br></pre></td></tr></table></figure>
<ul>
<li>copy 删除操作如下：</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">a = []<span class="type">int</span>&#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>&#125;</span><br><span class="line">a = a[:<span class="built_in">copy</span>(a[:i], a[i+<span class="number">1</span>:])] <span class="comment">// 删除中间1个元素</span></span><br><span class="line">a = a[:<span class="built_in">copy</span>(a[:i], a[i+N:])] <span class="comment">// 删除中间N个元素</span></span><br><span class="line"><span class="number">123</span></span><br></pre></td></tr></table></figure>
<ol>
<li>从尾部删除。</li>
</ol>
<p>代码如下所示：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">a = []<span class="type">int</span>&#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, ...&#125;</span><br><span class="line"></span><br><span class="line">a = a[:<span class="built_in">len</span>(a)<span class="number">-1</span>]   <span class="comment">// 删除尾部1个元素</span></span><br><span class="line">a = a[:<span class="built_in">len</span>(a)-N]   <span class="comment">// 删除尾部N个元素</span></span><br><span class="line"><span class="number">1234</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>删除切片尾部的元素是最快的</p>
</blockquote>
<h2 id="37-函数"><a class="markdownIt-Anchor" href="#37-函数">#</a> 3.7 函数</h2>
<p>为完成某一功能的程序指令 (语句) 的集合，称为函数。</p>
<h3 id="371-函数分类"><a class="markdownIt-Anchor" href="#371-函数分类">#</a> 3.7.1 函数分类</h3>
<p>在 Go 语言中，函数是第一类对象，我们可以将函数保持到变量中。函数主要有<strong>具名</strong>和<strong>匿名</strong>之分，包级函数一般都是具名函数，具名函数是匿名函数的一种特例，当匿名函数引用了外部作用域中的变量时就成了<strong>闭包函数</strong>，闭包函数是函数式编程语言的核心。</p>
<p>举例代码如下：</p>
<ol>
<li>具名函数：就和 c 语言中的普通函数意义相同，具有函数名、返回值以及函数参数的函数。</li>
</ol>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Add</span><span class="params">(a, b <span class="type">int</span>)</span></span> <span class="type">int</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> a+b</span><br><span class="line">&#125;</span><br><span class="line"><span class="number">123</span></span><br></pre></td></tr></table></figure>
<ol>
<li>匿名函数：指不需要定义函数名的一种函数实现方式，它由一个不带函数名的函数声明和函数体组成。</li>
</ol>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> Add = <span class="function"><span class="keyword">func</span><span class="params">(a, b <span class="type">int</span>)</span></span> <span class="type">int</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> a+b</span><br><span class="line">&#125;</span><br><span class="line"><span class="number">123</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>解释几个名词如下：</p>
<ol>
<li>闭包函数：返回为函数对象，不仅仅是一个函数对象，在该函数外还包裹了一层作用域，这使得，该函数无论在何处调用，优先使用自己外层包裹的作用域。</li>
<li>一级对象：支持闭包的多数语言都将函数作为第一级对象，就是说函数可以存储到变量中作为参数传递给其他函数，最重要的是能够被函数动态创建和返回。</li>
<li>包：go 的每一个文件都是属于一个包的，也就是说 go 是以包的形式来管理文件和项目目录结构的。</li>
</ol>
</blockquote>
<h3 id="372-函数声明和定义"><a class="markdownIt-Anchor" href="#372-函数声明和定义">#</a> 3.7.2 函数声明和定义</h3>
<p>Go 语言函数定义格式如下：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">fuction_name</span><span class="params">([parameter list])</span></span>[<span class="keyword">return</span> types]&#123;</span><br><span class="line">	函数体</span><br><span class="line">&#125;</span><br><span class="line"><span class="number">123</span></span><br></pre></td></tr></table></figure>
<table>
<thead>
<tr>
<th></th>
<th>解析</th>
</tr>
</thead>
<tbody>
<tr>
<td>func</td>
<td>函数由 func 开始声明</td>
</tr>
<tr>
<td>function_name</td>
<td>函数名称</td>
</tr>
<tr>
<td>parameter list</td>
<td>参数列表</td>
</tr>
<tr>
<td>return_types</td>
<td>返回类型</td>
</tr>
<tr>
<td>函数体</td>
<td>函数定义的代码集合</td>
</tr>
</tbody>
</table>
<h3 id="373-函数传参"><a class="markdownIt-Anchor" href="#373-函数传参">#</a> 3.7.3 函数传参</h3>
<blockquote>
<p>Go 语言中的函数可以有多个参数和多个返回值，参数和返回值都是以传值的方式和被调用者交换数据。在语法上，函数还支持可变数量的参数，<strong>可变数量的参数必须是最后出现的参数</strong>，可变数量的参数其实是一个切片类型的参数。</p>
</blockquote>
<p>当可变参数是一个<strong>空接口类型</strong>时，调用者是否解包可变参数会导致不同的结果，我们解释一下解包的含义，代码如下：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">	<span class="keyword">var</span> a = []<span class="type">int</span>&#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>&#125;</span><br><span class="line">	Print(a...)   <span class="comment">// 解包</span></span><br><span class="line">	Print(a)	  <span class="comment">// 未解包</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Print</span><span class="params">(a ...<span class="type">int</span>&#123;&#125;)</span></span> &#123;</span><br><span class="line">	fmt.Println(a...)</span><br><span class="line">&#125;</span><br><span class="line"><span class="number">123456789</span></span><br></pre></td></tr></table></figure>
<p>以上当传入参数为 <code>a...</code>  时即是对切片 a 进行了解包，此时其实相当于直接调用 <code>Print(1,2,3)</code> 。当传入参数直接为  <code>a</code>  时等价于直接调用 <code>Print([]int&#123;&#125;&#123;1,2,3&#125;)</code></p>
<h3 id="374-函数返回值"><a class="markdownIt-Anchor" href="#374-函数返回值">#</a> 3.7.4 函数返回值</h3>
<blockquote>
<p>不仅函数的参数可以有名字，也可以给函数的返回值命名。</p>
</blockquote>
<p>举例代码如下：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Find</span><span class="params">(m <span class="keyword">map</span>[<span class="type">int</span>]<span class="type">int</span>, key <span class="type">int</span>)</span></span>(value <span class="type">int</span>, ok <span class="type">bool</span>) &#123;</span><br><span class="line">	value,ok = m[key]</span><br><span class="line">	<span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="number">1234</span></span><br></pre></td></tr></table></figure>
<p>如果返回值命名了，可以通过名字来修改返回值，也可以通过 defer 语句在 return 语句之后修改返回值，举例代码如下：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">mian</span><span class="params">()</span></span> &#123;</span><br><span class="line">	<span class="keyword">for</span> i := <span class="number">0</span> ; i&lt;<span class="number">3</span>; i++ &#123;</span><br><span class="line">		<span class="keyword">defer</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123; <span class="built_in">println</span>(i) &#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 该函数最终的输出为：</span></span><br><span class="line"><span class="comment">// 3</span></span><br><span class="line"><span class="comment">// 3</span></span><br><span class="line"><span class="comment">// 3</span></span><br><span class="line"><span class="number">12345678910</span></span><br></pre></td></tr></table></figure>
<p>以上代码中如果没有 defer 其实返回值就是 <code>0,1,2</code> ，但 defer 语句会在函数 return 之后才会执行，也就是或只有以上函数在执行结束 return 之后才会执行 defer 语句，而该函数 return 时的 <code>i</code>  值将会达到 3，所以最终的 defer 语句执行 printlin 的输出都是 3。</p>
<p>defer 语句延迟执行的其实是一个匿名函数，因为这个匿名函数捕获了外部函数的局部变量 v，这种函数我们一般叫闭包。闭包对捕获的外部变量并不是传值方式访问，而是以<strong>引用</strong>的方式访问。</p>
<p>这种方式往往会带来一些问题，修复方法为在每一轮迭代中都为 defer 函数提供一个独有的变量，修改代码如下：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">3</span>; i++ &#123;</span><br><span class="line">        i := i <span class="comment">// 定义一个循环体内局部变量i</span></span><br><span class="line">        <span class="keyword">defer</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span>&#123; <span class="built_in">println</span>(i) &#125; ()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">3</span>; i++ &#123;</span><br><span class="line">        <span class="comment">// 通过函数传入i</span></span><br><span class="line">        <span class="comment">// defer 语句会马上对调用参数求值</span></span><br><span class="line">        <span class="comment">// 不再捕获，而是直接传值</span></span><br><span class="line">        <span class="keyword">defer</span> <span class="function"><span class="keyword">func</span><span class="params">(i <span class="type">int</span>)</span></span>&#123; <span class="built_in">println</span>(i) &#125; (i)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="number">123456789101112131415</span></span><br></pre></td></tr></table></figure>
<h3 id="375-递归调用"><a class="markdownIt-Anchor" href="#375-递归调用">#</a> 3.7.5 递归调用</h3>
<p>Go 语言中，函数还可以直接或间接地调用自己，也就是支持递归调用。Go 语言函数的递归调用<strong>深度逻辑上没有限制</strong>，函数调用的栈是<strong>不会出现溢出错误</strong>的，因为 Go 语言运行时会根据需要动态地调整函数栈的大小。这部分的知识将会涉及 goroutint 和动态栈的相关知识，我们将会在之后的博文中向大家解释。</p>
<p>它的语法和 c 很相似，格式如下：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">recursion</span><span class="params">()</span></span> &#123;</span><br><span class="line">   recursion() <span class="comment">/* 函数调用自身 */</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">   recursion()</span><br><span class="line">&#125;</span><br><span class="line"><span class="number">1234567</span></span><br></pre></td></tr></table></figure>
<h2 id="38-方法"><a class="markdownIt-Anchor" href="#38-方法">#</a> 3.8 方法</h2>
<p>方法一般是面向对象编程 (OOP) 的一个特性，在 C++ 语言中方法对应一个类对象的成员函数，是关联到具体对象上的虚表中的。但是 Go 语言的方法却是<strong>关联到类型</strong>的，这样可以在<strong>编译阶段完成方法的静态绑定</strong>。一个面向对象的程序会用方法来表达其属性对应的操作，这样使用这个对象的用户就不需要直接去操作对象，而是借助方法来做这些事情。</p>
<p>实现 C 语言中的一组函数如下：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 文件对象</span></span><br><span class="line"><span class="keyword">type</span> File <span class="keyword">struct</span> &#123;</span><br><span class="line">    fd <span class="type">int</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 打开文件</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">OpenFile</span><span class="params">(name <span class="type">string</span>)</span></span> (f *File, err <span class="type">error</span>) &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 关闭文件</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">CloseFile</span><span class="params">(f *File)</span></span> <span class="type">error</span> &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 读文件数据</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">ReadFile</span><span class="params">(f *File, offset <span class="type">int64</span>, data []<span class="type">byte</span>)</span></span> <span class="type">int</span> &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="number">12345678910111213141516171819</span></span><br></pre></td></tr></table></figure>
<p>以上的三个函数都是普通的函数，需要占用包级空间中的名字资源。不过 CloseFile 和 ReadFile 函数只是针对 File 类型对象的操作，这时候我们更希望这类函数和操作对象的类型紧密绑定在一起。</p>
<p>所以在 go 语言中我们修改如下：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 关闭文件</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(f *File)</span></span> CloseFile() <span class="type">error</span> &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 读文件数据</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(f *File)</span></span> ReadFile(offset <span class="type">int64</span>, data []<span class="type">byte</span>) <span class="type">int</span> &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="number">123456789</span></span><br></pre></td></tr></table></figure>
<p>将 CloseFile 和 ReadFile 函数的第一个参数移动到函数名的开头，这两个函数就成了<strong> File 类型</strong>独有的方法了（而不是 File 对象方法）</p>
<p>从代码角度看虽然只是一个小的改动，但是从编程哲学角度来看，Go 语言已经是进入面向对象语言的行列了。我们可以给任何自定义类型添加一个或多个方法。每种类型对应的方法必须和类型的定义在同一个包中，因此是无法给 int 这类内置类型添加方法的（因为方法的定义和类型的定义不在一个包中）。对于给定的类型，每个方法的名字必须是唯一的，同时方法和函数一样也不支持重载。</p>
<h2 id="39-接口"><a class="markdownIt-Anchor" href="#39-接口">#</a> 3.9 接口</h2>
<h3 id="391-什么是接口"><a class="markdownIt-Anchor" href="#391-什么是接口">#</a> 3.9.1 什么是接口</h3>
<p>Go 语言提供了另外一种数据类型即接口，它把所有的具有共性的方法定义在一起，任何其他类型只要实现了这些方法就是实现了这个接口。</p>
<p>Go 的接口类型是对其它类型行为的抽象和概括；因为接口类型<strong>不会和特定的实现细节绑定在一起</strong>，通过这种抽象的方式我们可以让对象更加灵活和更具有适应能力。很多面向对象的语言都有相似的接口概念，但 Go 语言中接口类型的独特之处在于它是满足隐式实现的鸭子类型。</p>
<p>所谓<strong>鸭子类型</strong>说的是：只要走起路来像鸭子、叫起来也像鸭子，那么就可以把它当作鸭子。Go 语言中的面向对象就是如此，如果一个对象只要看起来像是某种接口类型的实现，那么它就可以作为该接口类型使用。</p>
<p>就比如说在 c 语言中，使用 printf 在终端输出的时候只能输出有限类型的几个变量，而在 go 中可以使用 fmt.Printf，实际上是 fmt.Fprintf 向任意自定义的输出流对象打印，甚至可以打印到网络甚至是压缩文件，同时打印的数据不限于语言内置的基础类型，任意隐士满足 fmt.Stringer 接口的对象都可以打印，不满足 fmt.Stringer 接口的依然可以通过反射的技术打印。</p>
<h3 id="392-结构体类型"><a class="markdownIt-Anchor" href="#392-结构体类型">#</a> 3.9.2 结构体类型</h3>
<p>interface 实际上就是一个结构体，包含两个成员。其中一个成员是指向具体数据的指针，另一个成员中包含了类型信息。空接口和带方法的接口略有不同，下面分别是空接口的数据结构：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> Eface</span><br><span class="line">&#123;</span><br><span class="line">    Type*    <span class="keyword">type</span>;</span><br><span class="line">    void*    data;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="number">12345</span></span><br></pre></td></tr></table></figure>
<p>其中的 Type 指的是：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> Type</span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">uintptr</span> size;</span><br><span class="line">    <span class="type">uint32</span> hash;</span><br><span class="line">    <span class="type">uint8</span> _unused;</span><br><span class="line">    <span class="type">uint8</span> align;</span><br><span class="line">    <span class="type">uint8</span> fieldAlign;</span><br><span class="line">    <span class="type">uint8</span> kind;</span><br><span class="line">    Alg *alg;</span><br><span class="line">    void *gc;</span><br><span class="line">    String *<span class="type">string</span>;</span><br><span class="line">    UncommonType *x;</span><br><span class="line">    Type *ptrto;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="number">1234567891011121314</span></span><br></pre></td></tr></table></figure>
<p>和带方法的接口使用的数据结构：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> Iface</span><br><span class="line">&#123;</span><br><span class="line">    Itab*    tab;</span><br><span class="line">    void*    data;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="number">12345</span></span><br></pre></td></tr></table></figure>
<p>其中的 Iface 指的是：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span>    Itab</span><br><span class="line">&#123;</span><br><span class="line">    InterfaceType*    inter;</span><br><span class="line">    Type*    <span class="keyword">type</span>;</span><br><span class="line">    Itab*    link;</span><br><span class="line">    <span class="type">int32</span>    bad;</span><br><span class="line">    <span class="type">int32</span>    unused;</span><br><span class="line">    void    (*fun[])(void);   <span class="comment">// 方法表</span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="number">123456789</span></span><br></pre></td></tr></table></figure>
<h3 id="393-具体类型向接口类型赋值"><a class="markdownIt-Anchor" href="#393-具体类型向接口类型赋值">#</a> 3.9.3 具体类型向接口类型赋值</h3>
<p>将一个具体类型数据赋值给 interface 这样的抽象类型，需要进行类型转换。这个转换过程中涉及哪些操作呢？</p>
<p>如果转换为空接口，返回一个 Eface，将 Eface 中的 data 指针指向原型数据，type 指针会指向数据的 Type 结构体。</p>
<p>如果将其转化为带方法的 interface，需要进行一次检测，该类型必须实现 interface 中声明的所有方法才可以进行转换，这个检测将会在编译过程中进行。检测过程具体实现式通过比较具体类型的方法表和接口类型的方法表来进行的。</p>
<ul>
<li>具体类型方法表：Type 的 UncommonType 中有一个方法表，某个具体类型实现的所有方法都会被收集到这张表中。</li>
<li>接口类型方法表：Iface 的 Itab 的 InterfaceType 中也有一张方法表，这张方法表中是接口所声明的方法。Iface 中的 Itab 的 func 域也是一张方法表，这张表中的每一项就是一个函数指针，也就是只有实现没有声明。</li>
</ul>
<p>这两处方法表都是排序过的，只需要一遍顺序扫描进行比较，应该可以知道 Type 中否实现了接口中声明的所有方法。最后还会将 Type 方法表中的函数指针，拷贝到 Itab 的 fun 字段中。Iface 中的 Itab 的 func 域也是一张方法表，这张表中的每一项就是一个函数指针，也就是只有实现没有声明。</p>
<h3 id="394-获取接口类型数据的具体类型信息"><a class="markdownIt-Anchor" href="#394-获取接口类型数据的具体类型信息">#</a> 3.9.4 获取接口类型数据的具体类型信息</h3>
<p>接口类型转换为具体类型 (也就是反射，reflect)，也涉及到了类型转换。reflect 包中的 TypeOf 和 ValueOf 函数来得到接口变量的 Type 和 Value。</p>
<h2 id="310-channel"><a class="markdownIt-Anchor" href="#310-channel">#</a> 3.10 channel</h2>
<h3 id="3101-相关结构体定义"><a class="markdownIt-Anchor" href="#3101-相关结构体定义">#</a> 3.10.1 相关结构体定义</h3>
<p>go 中的 channel 是可以被存储在变量中，可以作为参数传递给函数，也可以作为函数返回值返回，我们先来看一下 channel 的结构体定义：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span>    Hchan</span><br><span class="line">&#123;</span><br><span class="line">    uintgo    qcount;            <span class="comment">// 队列q中的总数据数量</span></span><br><span class="line">    uintgo    dataqsize;        <span class="comment">// 环形队列q的数据大小</span></span><br><span class="line">    <span class="type">uint16</span>    elemsize;			<span class="comment">// 当前队列的使用量</span></span><br><span class="line">    <span class="type">bool</span>    closed;				</span><br><span class="line">    <span class="type">uint8</span>    elemalign;</span><br><span class="line">    Alg*    elemalg;        <span class="comment">// interface for element type</span></span><br><span class="line">    uintgo    sendx;            <span class="comment">// 发送index</span></span><br><span class="line">    uintgo    recvx;            <span class="comment">// 接收index</span></span><br><span class="line">    WaitQ    recvq;            <span class="comment">// 因recv而阻塞的等待队列</span></span><br><span class="line">    WaitQ    sendq;            <span class="comment">// 因send而阻塞的等待队列</span></span><br><span class="line">    Lock;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="number">1234567891011121314</span></span><br></pre></td></tr></table></figure>
<p>Hchan 结构体中的核心部分是存放 channel 数据的环形队列，相关数据的作用已经在其后做出了备注。在该结构体中没有存放数据的域，如果是带缓冲区的 chan，则缓冲区数据实际上是紧接着 Hchan 结构体中分配的。</p>
<p>另一个重要部分就是 recvq 和 sendq 两个链表，一个是因读这个通道而导致阻塞的 goroutine，另一个是因为写这个通道而阻塞的 goroutine。如果一个 goroutine 阻塞于 channel 了，那么它就被挂在 recvq 或 sendq 中。WaitQ 是链表的定义，包含一个头结点和一个尾结点，该链表中中存放的成员是一个 sudoG 结构体变量，具体定义如下：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span>    SudoG</span><br><span class="line">&#123;</span><br><span class="line">    G*    g;        <span class="comment">// g and selgen constitute</span></span><br><span class="line">    <span class="type">uint32</span>    selgen;        <span class="comment">// a weak pointer to g</span></span><br><span class="line">    SudoG*    link;</span><br><span class="line">    <span class="type">int64</span>    releasetime;</span><br><span class="line">    <span class="type">byte</span>*    elem;        <span class="comment">// data element</span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="number">12345678</span></span><br></pre></td></tr></table></figure>
<p>该结构体中最主要的是 g 和 elem。elem 用于存储 goroutine 的数据。读通道时，数据会从 Hchan 的队列中拷贝到 SudoG 的 elem 域。写通道时，数据则是由 SudoG 的 elem 域拷贝到 Hchan 的队列中。</p>
<p>Hchan 结构如下：<br>
<img src="https://brath.oss-cn-shanghai.aliyuncs.com/pigo/ddf2855d06234305a122bea469d0adaa.png" alt="在这里插入图片描述"></p>
<h3 id="3102-阻塞式读写channel操作"><a class="markdownIt-Anchor" href="#3102-阻塞式读写channel操作">#</a> 3.10.2 阻塞式读写 channel 操作</h3>
<p>写操作代码如下，其中的 c 就是 channel，v 指的是数据：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">c &lt;- v</span><br><span class="line"><span class="number">1</span></span><br></pre></td></tr></table></figure>
<p>事实上基本的阻塞模式写 channel 操作在底层运行时库中对应的是一个 runtime.chansend 函数。具体如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">void runtime·chansend(ChanType *t, Hchan *c, byte *ep, bool *pres, void *pc)</span><br></pre></td></tr></table></figure>
<p>其中的 ep 指的是变量 v 的地址，这里的传值约定是调用者负责分配好 ep 的空间，仅需要简单的取变量地址就好了，pres 是在 select 中的通道操作中使用的。</p>
<p><img src="https://brath.oss-cn-shanghai.aliyuncs.com/pigo/22fb68eff45145c89f2f64d51b3e556f.png" alt="在这里插入图片描述"></p>
<p>阻塞模式读操作的核心函数有两种包装如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chanrecv(c *hchan, ep unsafe.Pointer, block bool) (selected, received bool)</span><br></pre></td></tr></table></figure>
<p>以及</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chanrecv(c *hchan, ep unsafe.Pointer, block bool) (selected)</span><br></pre></td></tr></table></figure>
<p>这两种的区别主要在于返回值是否会返回一个 bool 类型值，该值只是用于判断 channel 是否能读取出数据。</p>
<p>读写操作的以上阻塞的过程类似，故而不再做出说明，我们补充三个细节：</p>
<ul>
<li>以上我们都强调是阻塞式的读写操作，其实相对应的也有<strong>非阻塞的</strong>读写操作，使用过 select-case 来进行调用的。</li>
<li>空通道，指的是将一个 channel 赋值为 nil，或者调用后不适用 make 进行初始化。读写空通道是永远阻塞的。</li>
<li>关闭的通道，永远不会阻塞，会返回一个通道数据类型的零值。首先将 closed 置为 1，第二步收集读等待队列 recvq 的所有 sg，每个 sg 的 elem 都设为类型零值，第三步收集写等待队列 sendq 的所有 sg，每个 sg 的 elem 都设为 nil，最后唤醒所有收集的 sg。</li>
</ul>
<h3 id="3103-非阻塞式读写channel操作"><a class="markdownIt-Anchor" href="#3103-非阻塞式读写channel操作">#</a> 3.10.3 非阻塞式读写 channel 操作</h3>
<p>如上文所说，非阻塞式其实就是使用 select-case 来实现，在编译时将会被编译为 if-else。</p>
<p>如：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> &#123;</span><br><span class="line"><span class="keyword">case</span> v = &lt;-c:</span><br><span class="line">        ...foo</span><br><span class="line"><span class="keyword">default</span>:</span><br><span class="line">        ...bar</span><br><span class="line">&#125;</span><br><span class="line"><span class="number">123456</span></span><br></pre></td></tr></table></figure>
<p>就会被编译为：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> selectnbrecv(&amp;v, c) &#123;</span><br><span class="line">        ...foo</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        ...bar</span><br><span class="line">&#125;</span><br><span class="line"><span class="number">12345</span></span><br></pre></td></tr></table></figure>
<p>至于其中的 selectnbrecv 相关的函数简单地调 runtime.chanrecv 函数，设置了一个参数，告诉 runtime.chanrecv 函数，当不能完成操作时不要阻塞，而是返回失败。</p>
<p>但是 select 中的 case 的执行顺序是随机的，而不像 switch 中的 case 那样一条一条的顺序执行。让每一个 select 都对应一个 Select 结构体。在 Select 数据结构中有个 Scase 数组，记录下了每一个 case，而 Scase 中包含了 Hchan。然后 pollorder 数组将元素随机排列，这样就可以将 Scase 乱序了。</p>
<h2 id="311-map"><a class="markdownIt-Anchor" href="#311-map">#</a> 3.11 map</h2>
<p>map 表的底层原理是哈希表，其结构体定义如下：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Map <span class="keyword">struct</span> &#123;</span><br><span class="line">    Key  *Type <span class="comment">// Key type</span></span><br><span class="line">    Elem *Type <span class="comment">// Val (elem) type</span></span><br><span class="line"></span><br><span class="line">    Bucket *Type <span class="comment">// 哈希桶</span></span><br><span class="line">    Hmap   *Type <span class="comment">// 底层使用的哈希表元信息</span></span><br><span class="line">    Hiter  *Type <span class="comment">// 用于遍历哈希表的迭代器</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="number">12345678</span></span><br></pre></td></tr></table></figure>
<p>其中的 Hmap 的具体化数据结构如下：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> hmap <span class="keyword">struct</span> &#123;</span><br><span class="line">    <span class="comment">// Note: the format of the hmap is also encoded in cmd/compile/internal/gc/reflect.go.</span></span><br><span class="line">    <span class="comment">// Make sure this stays in sync with the compiler&#x27;s definition.</span></span><br><span class="line">    count     <span class="type">int</span> <span class="comment">// map目前的元素数目</span></span><br><span class="line">    flags     <span class="type">uint8</span> <span class="comment">// map状态（正在被遍历/正在被写入）</span></span><br><span class="line">    B         <span class="type">uint8</span>  <span class="comment">// 哈希桶数目以2为底的对数（哈希桶的数目都是 2 的整数次幂，用位运算来计算取余运算的值, 即 N mod M = N &amp; (M-1))）</span></span><br><span class="line">    noverflow <span class="type">uint16</span> <span class="comment">//溢出桶的数目, 这个数值不是恒定精确的, 当其 B&gt;=16 时为近似值</span></span><br><span class="line">    hash0     <span class="type">uint32</span> <span class="comment">// 随机哈希种子</span></span><br><span class="line"></span><br><span class="line">    buckets    unsafe.Pointer <span class="comment">// 指向当前哈希桶的指针</span></span><br><span class="line">    oldbuckets unsafe.Pointer <span class="comment">// 扩容时指向旧桶的指针</span></span><br><span class="line">    nevacuate  <span class="type">uintptr</span>        <span class="comment">// 桶进行调整时指示的搬迁进度</span></span><br><span class="line"></span><br><span class="line">    extra *mapextra <span class="comment">// 表征溢出桶的变量</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="number">123456789101112131415</span></span><br></pre></td></tr></table></figure>
<p>以上 hmap 基本都是涉及到了哈希桶和溢出桶，我们首先看一下它的数据结构，如下：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> bmap <span class="keyword">struct</span> &#123;</span><br><span class="line">    topbits  [<span class="number">8</span>]<span class="type">uint8</span>    <span class="comment">// 键哈希值的高8位</span></span><br><span class="line">    keys     [<span class="number">8</span>]keytype  <span class="comment">// 哈希桶中所有键</span></span><br><span class="line">    elems    [<span class="number">8</span>]elemtype	<span class="comment">// 哈希桶中所有值</span></span><br><span class="line">    <span class="comment">//pad      uintptr(新的 go 版本已经移除了该字段, 我未具体了解此处的 change detail, 之前设置该字段是为了在 nacl/amd64p32 上的内存对齐)</span></span><br><span class="line">    overflow <span class="type">uintptr</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="number">1234567</span></span><br></pre></td></tr></table></figure>
<p>我们会发现哈希桶 bmap 一般指定其能保存 8 个键值对，如果多于 8 个键值对，就会申请新的 buckets，并将其于之前的 buckets 链接在一起。</p>
<p>其中的联系如图所示：<br>
<img src="https://brath.oss-cn-shanghai.aliyuncs.com/pigo/13c1b9f9899d48b08c32b76ef4037a17.png" alt="在这里插入图片描述"></p>
<p>在具体插入时，首先会根据 key 值采用相应的 hash 算法计算对应的哈希值，将哈希值的低 8 位作为 Hmap 结构体中 buckets 数组的索引，找到 key 值所对应的 bucket，将哈希值的高 8 位催出在 bucket 的 tophash 中。</p>
<p>特点如下：</p>
<ul>
<li>map 是<strong>无序的</strong>（原因为无序写入以及扩容导致的元素顺序发生变化），每次打印出来的 map 都会不一样，它不能通过 index 获取，而必须通过 key 获取</li>
<li>map 的<strong>长度是不固定</strong>的，也就是和 slice 一样，也是一种引用类型</li>
<li>内置的 len 函数同样适用于 map，返回 map 拥有的 key 的数量</li>
<li>map 的 key 可以是所有可比较的类型，如布尔型、整数型、浮点型、复杂型、字符串型…… 也可以键。</li>
</ul>
<p>如下方式即可进行初始化：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> a <span class="keyword">map</span>[keytype]valuetype</span><br><span class="line"><span class="number">1</span></span><br></pre></td></tr></table></figure>
<table>
<thead>
<tr>
<th>类型名</th>
<th>意义</th>
</tr>
</thead>
<tbody>
<tr>
<td>a</td>
<td>map 表名字</td>
</tr>
<tr>
<td>keytype</td>
<td>键类型</td>
</tr>
<tr>
<td>valuetype</td>
<td>键对应的值的类型</td>
</tr>
</tbody>
</table>
<p>除此以外还可以使用 make 进行初始化，代码如下：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">map_variable = <span class="built_in">make</span>(<span class="keyword">map</span>[key_data_type]value_data_type)</span><br><span class="line"><span class="number">1</span></span><br></pre></td></tr></table></figure>
<p>我们还可以使用初始值进行初始化，如下：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> m <span class="keyword">map</span>[<span class="type">string</span>]<span class="type">int</span> = <span class="keyword">map</span>[<span class="type">string</span>]<span class="type">int</span>&#123;<span class="string">&quot;hunter&quot;</span>:<span class="number">12</span>,<span class="string">&quot;tony&quot;</span>:<span class="number">10</span>&#125;</span><br><span class="line"><span class="number">1</span></span><br></pre></td></tr></table></figure>
<h3 id="3111-插入数据"><a class="markdownIt-Anchor" href="#3111-插入数据">#</a> 3.11.1 插入数据</h3>
<p>map 的数据插入代码如下：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">map_variable[<span class="string">&quot;mars&quot;</span>] = <span class="number">27</span></span><br><span class="line"><span class="number">1</span></span><br></pre></td></tr></table></figure>
<p>插入过程如下：</p>
<ol>
<li>根据 key 值计算出哈希值</li>
<li>取哈希值低位和 hmap.B 取模确定 bucket 位置</li>
<li>查找该 key 是否已经存在，如果存在则直接更新值</li>
<li>如果没有找到 key，则将这一对 key-value 插入</li>
</ol>
<h3 id="3112-删除数据"><a class="markdownIt-Anchor" href="#3112-删除数据">#</a> 3.11.2 删除数据</h3>
<p><strong>delete(map, key)</strong> 函数用于删除集合的元素，参数为 map 和其对应的 key。删除函数不返回任何值。相关代码如下：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">   countryCapitalMap := <span class="keyword">map</span>[<span class="type">string</span>] <span class="type">string</span> &#123;<span class="string">&quot;France&quot;</span>:<span class="string">&quot;Paris&quot;</span>,<span class="string">&quot;Italy&quot;</span>:<span class="string">&quot;Rome&quot;</span>,<span class="string">&quot;Japan&quot;</span>:<span class="string">&quot;Tokyo&quot;</span>,<span class="string">&quot;India&quot;</span>:<span class="string">&quot;New Delhi&quot;</span>&#125;</span><br><span class="line">   <span class="comment">/* 删除元素 */</span></span><br><span class="line">   <span class="built_in">delete</span>(countryCapitalMap,<span class="string">&quot;France&quot;</span>);</span><br><span class="line"><span class="number">123</span></span><br></pre></td></tr></table></figure>
<h3 id="3113-查找数据"><a class="markdownIt-Anchor" href="#3113-查找数据">#</a> 3.11.3 查找数据</h3>
<p>通过 key 获取 map 中对应的 value 值。语法为： <code>map[key] </code> . 但是当 key 如果不存在的时候，我们会得到该 value 值类型的默认值，比如 string 类型得到空字符串，int 类型得到 0。但是程序不会报错。</p>
<p>所以我们可以使用<strong> ok-idiom</strong> 获取值，如下： <code>value, ok := map[key] </code> ，其中的 value 是返回值，ok 是一个 bool 值，可知道 key/value 是否存在。</p>
<p>在 map 表中的查找过程如下：</p>
<ol>
<li>查找或者操作 map 时，首先 key 经过 hash 函数生成 hash 值</li>
<li>通过哈希值的低 8 位来判断当前数据属于哪个桶</li>
<li>找到桶之后，通过哈希值的高八位与 bucket 存储的高位哈希值循环比对</li>
<li>如果相同就比较刚才找到的底层数组的 key 值，如果 key 相同，取出 value</li>
<li>如果高八位 hash 值在此 bucket 没有，或者有，但是 key 不相同，就去链表中下一个溢出 bucket 中查找，直到查找到链表的末尾</li>
<li>如果查找不到，也不会返回空值，而是返回相应类型的 0 值。</li>
</ol>
<h3 id="3114-扩容"><a class="markdownIt-Anchor" href="#3114-扩容">#</a> 3.11.4 扩容</h3>
<p>哈希表就是以空间换时间，访问速度是直接跟填充因子相关的，所以当哈希表太满之后就需要进行扩容。</p>
<p>如果扩容前的哈希表大小为 2B 扩容之后的大小为 2 (B+1)，每次扩容都变为<strong>原来大小的两倍</strong>，哈希表大小始终为 2 的指数倍，则有 (hash mod 2B) 等价于 (hash &amp; (2B-1))。这样可以简化运算，避免了取余操作。</p>
<blockquote>
<p>触发扩容的条件？</p>
</blockquote>
<ol>
<li>负载因子 (负载因子 = 键数量 /bucket 数量) &gt; 6.5 时，也即平均每个 bucket 存储的键值对达到 6.5 个。</li>
<li>溢出桶（overflow）数量 &gt; 2^15 时，也即 overflow 数量超过 32768 时。</li>
</ol>
<blockquote>
<p>什么是增量扩容呢？</p>
</blockquote>
<p>如果负载因子 &gt; 6.5 时，进行增量扩容。这时会新建一个桶（bucket），新的 bucket 长度是原来的 2 倍，然后旧桶数据搬迁到新桶。每个旧桶的键值对都会分流到两个新桶中</p>
<p>主要是缩短 map 容器的响应时间。假如我们直接将 map 用作某个响应实时性要求非常高的 web 应用存储，如果不采用增量扩容，当 map 里面存储的元素很多之后，扩容时系统就会卡往，导致较长一段时间内无法响应请求。不过增量扩容本质上还是将总的扩容时间分摊到了每一次哈希操作上面。</p>
<blockquote>
<p>什么是等量扩容？它的触发条件是什么？进行等量扩容后的优势是什么？</p>
</blockquote>
<p>等量扩容，就是创建和旧桶数目一样多的新桶，然后把原来的键值对迁移到新桶中，重新做一遍类似增量扩容的搬迁动作。</p>
<p>触发条件：负载因子没超标，溢出桶较多。这个较多的评判标准为：</p>
<ul>
<li>如果常规桶数目不大于 2^15，那么使用的溢出桶数目超过常规桶就算是多了；</li>
<li>如果常规桶数目大于 215，那么使用溢出桶数目一旦超过 215 就算多了。</li>
</ul>
<p>这样做的目的是把松散的键值对重新排列一次，能够存储的更加紧凑，进而减少溢出桶的使用，以使 bucket 的使用率更高，进而保证更快的存取。</p>
<h1 id="4-常用语句及关键字"><a class="markdownIt-Anchor" href="#4-常用语句及关键字">#</a> 4. 常用语句及关键字</h1>
<p>接下来我们了解一下关于 go 语言语句的基本内容。</p>
<h2 id="41-条件语句"><a class="markdownIt-Anchor" href="#41-条件语句">#</a> 4.1 条件语句</h2>
<p>和 c 语言类似，相关的条件语句如下表所示：</p>
<table>
<thead>
<tr>
<th>语句</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>if 语句</td>
<td>if 语句 由一个布尔表达式后紧跟一个或多个语句组成。</td>
</tr>
<tr>
<td>if…else 语句</td>
<td>if 语句 后可以使用可选的 else 语句，else 语句中的表达式在布尔表达式为 false 时执行。</td>
</tr>
<tr>
<td>switch 语句</td>
<td>switch 语句用于基于不同条件执行不同动作。</td>
</tr>
<tr>
<td>select 语句</td>
<td>select 语句类似于 switch 语句，但是 select 会随机执行一个可运行的 case。如果没有 case 可运行，它将阻塞，直到有 case 可运行。</td>
</tr>
</tbody>
</table>
<ul>
<li>if 语句<br>
语法如下：</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> 布尔表达式 &#123;</span><br><span class="line">   <span class="comment">/* 在布尔表达式为 true 时执行 */</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="number">123</span></span><br></pre></td></tr></table></figure>
<ul>
<li>if-else 语句</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> 布尔表达式 &#123;</span><br><span class="line">   <span class="comment">/* 在布尔表达式为 true 时执行 */</span></span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">	<span class="comment">/* 在布尔表达式为 false 时执行 */</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="number">12345</span></span><br></pre></td></tr></table></figure>
<ul>
<li>switch 语句<br>
其中的变量 <code>v</code>  可以是任何类型， <code>val1</code>  和 <code>val2</code>  可以是同类型的任意值，类型不局限为常量或者整数，或者最终结果为相同类型的表达式。</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">switch</span> v &#123;</span><br><span class="line">    <span class="keyword">case</span> val1:</span><br><span class="line">        ...</span><br><span class="line">    <span class="keyword">case</span> val2:</span><br><span class="line">        ...</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">        ...</span><br><span class="line">&#125;</span><br><span class="line"><span class="number">12345678</span></span><br></pre></td></tr></table></figure>
<ul>
<li>select 语句<br>
 select 是 Go 中的一个控制结构，类似于用于通信的 switch 语句。每个 case 必须是一个<strong>通信操作</strong>，要么是发送要么是接收。它将会随机执行一个可运行的 case。如果没有 case 可运行，它将阻塞，直到有 case 可运行。一个默认的子句应该总是可运行的。</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> &#123;</span><br><span class="line">    <span class="keyword">case</span> communication clause  :</span><br><span class="line">       statement(s);      </span><br><span class="line">    <span class="keyword">case</span> communication clause  :</span><br><span class="line">       statement(s);</span><br><span class="line">    <span class="comment">/* 你可以定义任意数量的 case */</span></span><br><span class="line">    <span class="keyword">default</span> : <span class="comment">/* 可选 */</span></span><br><span class="line">       statement(s);</span><br><span class="line">&#125;</span><br><span class="line"><span class="number">123456789</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>注意：</p>
<ul>
<li>每个 case 必须都是一个通信</li>
<li>所有 channel 表达式都会被求值，所有被发送的表达式都会被求值</li>
<li>如果任意某一个通信都可以，它就执行，其他就忽略</li>
<li>如果有多个 case 都可以运行，select 就会随机挑选一个来执行。</li>
<li>如果没有一个 case 可以被运行：如果有 default 子句，就执行 default 子句，select 将被阻塞，直到某个通信可以运行，从而避免饥饿问题。</li>
</ul>
</blockquote>
<h2 id="42-循环语句"><a class="markdownIt-Anchor" href="#42-循环语句">#</a> 4.2 循环语句</h2>
<h3 id="421-循环处理语句"><a class="markdownIt-Anchor" href="#421-循环处理语句">#</a> 4.2.1 循环处理语句</h3>
<p>go 中时使用 for 实现循环的，共有三种形式：</p>
<table>
<thead>
<tr>
<th></th>
<th>语法</th>
</tr>
</thead>
<tbody>
<tr>
<td>和 c 语言中的 for 相同</td>
<td>for init; condition; post {}</td>
</tr>
<tr>
<td>和 c 语言中的 while 相同</td>
<td>for condition{}</td>
</tr>
<tr>
<td>和 c 语言中的 <code>for(;;)</code>  相同</td>
<td>for{}</td>
</tr>
</tbody>
</table>
<p>除此以外，for 循环还可以直接使用<strong> range</strong> 对 slice、map、数组以及字符串等进行迭代循环，格式如下：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> key, value := <span class="keyword">range</span> oldmap &#123;</span><br><span class="line">	newmap[key] = value</span><br><span class="line">&#125;</span><br><span class="line"><span class="number">123</span></span><br></pre></td></tr></table></figure>
<h3 id="421-循环控制语句"><a class="markdownIt-Anchor" href="#421-循环控制语句">#</a> 4.2.1 循环控制语句</h3>
<table>
<thead>
<tr>
<th>控制语句</th>
<th>详解</th>
</tr>
</thead>
<tbody>
<tr>
<td>break</td>
<td>中断跳出循环或者 switch 语句</td>
</tr>
<tr>
<td>continue</td>
<td>跳过当前循环的剩余语句，然后继续下一轮循环</td>
</tr>
<tr>
<td>goto 语句</td>
<td>将控制转移到被标记的语句</td>
</tr>
</tbody>
</table>
<ol>
<li>break<br>
break 主要用于循环语句跳出循环，和 c 语言中的使用方式是相同的。且在多重循环的时候还可以使用 label 标出想要 break 的循环。<br>
实例代码如下：</li>
</ol>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">a := <span class="number">0</span></span><br><span class="line"><span class="keyword">for</span> a&lt;<span class="number">5</span> &#123;</span><br><span class="line">	fmt.Printf(<span class="string">&quot;%d\n&quot;</span>, a)</span><br><span class="line">	a++</span><br><span class="line">	<span class="keyword">if</span> a==<span class="number">2</span> &#123;</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/* output</span></span><br><span class="line"><span class="comment">0</span></span><br><span class="line"><span class="comment">1</span></span><br><span class="line"><span class="comment">2</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="number">12345678910111213</span></span><br></pre></td></tr></table></figure>
<ol>
<li>continue<br>
Go 语言的 continue 语句 有点像 break 语句。但是 continue 不是跳出循环，而是跳过当前循环执行下一次循环语句。在多重循环中，可以用标号 label 标出想 continue 的循环。<br>
实例代码如下：</li>
</ol>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">    <span class="comment">// 不使用标记</span></span><br><span class="line">    fmt.Println(<span class="string">&quot;---- continue ---- &quot;</span>)</span><br><span class="line">    <span class="keyword">for</span> i := <span class="number">1</span>; i &lt;= <span class="number">3</span>; i++ &#123;</span><br><span class="line">        fmt.Printf(<span class="string">&quot;i: %d\n&quot;</span>, i)</span><br><span class="line">            <span class="keyword">for</span> i2 := <span class="number">11</span>; i2 &lt;= <span class="number">13</span>; i2++ &#123;</span><br><span class="line">                fmt.Printf(<span class="string">&quot;i2: %d\n&quot;</span>, i2)</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">            &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* output</span></span><br><span class="line"><span class="comment">i: 1</span></span><br><span class="line"><span class="comment">i2: 11</span></span><br><span class="line"><span class="comment">i2: 12</span></span><br><span class="line"><span class="comment">i2: 13</span></span><br><span class="line"><span class="comment">i: 2</span></span><br><span class="line"><span class="comment">i2: 11</span></span><br><span class="line"><span class="comment">i2: 12</span></span><br><span class="line"><span class="comment">i2: 13</span></span><br><span class="line"><span class="comment">i: 3</span></span><br><span class="line"><span class="comment">i2: 11</span></span><br><span class="line"><span class="comment">i2: 12</span></span><br><span class="line"><span class="comment">i2: 13</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 使用标记</span></span><br><span class="line">    fmt.Println(<span class="string">&quot;---- continue label ----&quot;</span>)</span><br><span class="line">    re:</span><br><span class="line">        <span class="keyword">for</span> i := <span class="number">1</span>; i &lt;= <span class="number">3</span>; i++ &#123;</span><br><span class="line">            fmt.Printf(<span class="string">&quot;i: %d&quot;</span>, i)</span><br><span class="line">                <span class="keyword">for</span> i2 := <span class="number">11</span>; i2 &lt;= <span class="number">13</span>; i2++ &#123;</span><br><span class="line">                    fmt.Printf(<span class="string">&quot;i2: %d\n&quot;</span>, i2)</span><br><span class="line">                    <span class="keyword">continue</span> re</span><br><span class="line">                &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* output</span></span><br><span class="line"><span class="comment">i: 1</span></span><br><span class="line"><span class="comment">i2: 11</span></span><br><span class="line"><span class="comment">i: 2</span></span><br><span class="line"><span class="comment">i2: 11</span></span><br><span class="line"><span class="comment">i: 3</span></span><br><span class="line"><span class="comment">i2: 11</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="number">1234567891011121314151617181920212223242526272829303132333435363738394041424344</span></span><br></pre></td></tr></table></figure>
<ol>
<li>goto<br>
goto 语句主要是无条件转移到过程中<strong>指定的行</strong>。goto 语句通常和条件语句配合使用，可用来实现条件转移、构成循环以及跳出循环体等功能。但是并不主张使用 goto 语句，以免造成程序流程混乱。<br>
示例代码如下：</li>
</ol>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> a <span class="type">int</span> = <span class="number">0</span></span><br><span class="line">LOOP: <span class="keyword">for</span> a&lt;<span class="number">5</span> &#123;</span><br><span class="line">	<span class="keyword">if</span> a == <span class="number">2</span> &#123;</span><br><span class="line">		a = a+<span class="number">1</span></span><br><span class="line">		<span class="keyword">goto</span> LOOP</span><br><span class="line">	&#125;</span><br><span class="line">	fmt.Printf(<span class="string">&quot;%d\n&quot;</span>, a)</span><br><span class="line">	a++</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">output:</span></span><br><span class="line"><span class="comment">0</span></span><br><span class="line"><span class="comment">1</span></span><br><span class="line"><span class="comment">2</span></span><br><span class="line"><span class="comment">3</span></span><br><span class="line"><span class="comment">4</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="number">123456789101112131415161718</span></span><br></pre></td></tr></table></figure>
<p>以上代码中的 LOOP 就是一个标签，当运行到 goto 语句的时候，此时执行流就会跳转到 LOOP 标志的哪一行上。</p>
<h2 id="43-关键字"><a class="markdownIt-Anchor" href="#43-关键字">#</a> 4.3 关键字</h2>
<p>我们这一部分直接列表供大家了解 go 中的关键字如下：</p>
<table>
<thead>
<tr>
<th>关键字</th>
<th>用法</th>
</tr>
</thead>
<tbody>
<tr>
<td>import</td>
<td>导入相应的包文件</td>
</tr>
<tr>
<td>package</td>
<td>创建包文件，用于标记该文件归属哪个包</td>
</tr>
<tr>
<td>chan</td>
<td>channal，通道</td>
</tr>
<tr>
<td>var</td>
<td>变量控制，用于简短声明定义变量（:= 符号只能在函数内部使用，不能全局使用）</td>
</tr>
<tr>
<td>const</td>
<td>常量声明，任何时候 const 和 var 都可以同时出现</td>
</tr>
<tr>
<td>func</td>
<td>定义函数和方法</td>
</tr>
<tr>
<td>interface</td>
<td>接口，是一种具有一组方法的类型，这些方法定义了 interface 的行为</td>
</tr>
<tr>
<td>map</td>
<td>哈希表</td>
</tr>
<tr>
<td>struct</td>
<td>定义结构体</td>
</tr>
<tr>
<td>type</td>
<td>声明类型，取别名</td>
</tr>
<tr>
<td>for</td>
<td>for 是 go 中唯一的循环结构，上文中已经介绍过它的用法</td>
</tr>
<tr>
<td>break</td>
<td>中止，跳出循环</td>
</tr>
<tr>
<td>continue</td>
<td>继续下一轮循环</td>
</tr>
<tr>
<td>select</td>
<td>选择流程，可以同时等待多个通道操作</td>
</tr>
<tr>
<td>switch</td>
<td>多分枝选择，上文中已经详细介绍过它的用法</td>
</tr>
<tr>
<td>case</td>
<td>和 switch 配套使用</td>
</tr>
<tr>
<td>default</td>
<td>用于选择结构的默认选型</td>
</tr>
<tr>
<td>defer</td>
<td>用于资源释放，会在函数返回之前进行调用</td>
</tr>
<tr>
<td>if</td>
<td>分支选择</td>
</tr>
<tr>
<td>else</td>
<td>和 if 配套使用</td>
</tr>
<tr>
<td>go</td>
<td>通过 <code>go func()</code>  来开启一个 goroutine</td>
</tr>
<tr>
<td>goto</td>
<td>跳转至标志点的代码块，不推荐使用</td>
</tr>
<tr>
<td>fallthrouth</td>
<td></td>
</tr>
<tr>
<td>range</td>
<td>用于遍历 slice 类型数据</td>
</tr>
<tr>
<td>return</td>
<td>用于标注函数返回值</td>
</tr>
</tbody>
</table>
<h2 id="关于我"><a class="markdownIt-Anchor" href="#关于我">#</a> 关于我</h2>
<p>Brath 是一个热爱技术的 Java 程序猿，公众号「InterviewCoder」定期分享有趣有料的精品原创文章！</p>
<p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/%E4%BA%8C%E7%BB%B4%E7%A0%81plus.png" alt="InterviewCoder"></p>
<p>非常感谢各位人才能看到这里，原创不易，文章如果有帮助可以关注、点赞、分享或评论，这都是对我的莫大支持！</p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2021-05-11T03:13:46.000Z" title="2021-5-11 11:13:46">2021-05-11</time>发表</span><span class="level-item"><time dateTime="2023-06-04T04:09:06.000Z" title="2023-6-4 12:09:06">2023-06-04</time>更新</span><span class="level-item">2 分钟读完 (大约304个字)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2021/05/11/%E3%80%90Docker%E3%80%91Docker%E7%8E%AF%E5%A2%83%E9%83%A8%E7%BD%B2Reids%E9%95%9C%E5%83%8F%E4%BD%9C%E4%B8%BA%E4%BB%8E%E8%8A%82%E7%82%B9/">Docker环境部署Reids镜像作为从节点</a></p><div class="content"><p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/%E6%89%AB%E7%A0%81_%E6%90%9C%E7%B4%A2%E8%81%94%E5%90%88%E4%BC%A0%E6%92%AD%E6%A0%B7%E5%BC%8F-%E6%A0%87%E5%87%86%E8%89%B2%E7%89%88.png" alt="InterviewCoder"></p>
<h2 id="docker环境部署reids镜像作为从节点"><a class="markdownIt-Anchor" href="#docker环境部署reids镜像作为从节点">#</a> Docker 环境部署 Reids 镜像作为从节点</h2>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"># 拉取镜像</span><br><span class="line">docker pull redis</span><br><span class="line"></span><br><span class="line"># 配置文件</span><br><span class="line">本地：/mydata/redis/data/redis.conf 提前准备好</span><br><span class="line">主要配置</span><br><span class="line">bind 127.0.0.1 #注释掉这部分，使redis可以外部访问</span><br><span class="line">daemonize no#用守护线程的方式启动</span><br><span class="line">requirepass 你的密码#给redis设置密码</span><br><span class="line">appendonly yes#redis持久化　　默认是no</span><br><span class="line">tcp-keepalive 300 #防止出现远程主机强迫关闭了一个现有的连接的错误 默认是300</span><br><span class="line"></span><br><span class="line"># 创建实例并启动</span><br><span class="line">docker run -p 6380:6379 --name redis -v /mydata/redis/data/redis.conf:/etc/redis/redis.conf  -v /mydata/redis/data:/data -d redis redis-server /etc/redis/redis.conf --appendonly yes</span><br></pre></td></tr></table></figure>
<h2 id="关于我"><a class="markdownIt-Anchor" href="#关于我">#</a> 关于我</h2>
<p>Brath 是一个热爱技术的 Java 程序猿，公众号「InterviewCoder」定期分享有趣有料的精品原创文章！</p>
<p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/%E4%BA%8C%E7%BB%B4%E7%A0%81plus.png" alt="InterviewCoder"></p>
<p>非常感谢各位人才能看到这里，原创不易，文章如果有帮助可以关注、点赞、分享或评论，这都是对我的莫大支持！</p>
</div></article></div><nav class="pagination" role="navigation" aria-label="pagination"><div class="pagination-previous"><a href="/page/8/">上一页</a></div><div class="pagination-next"><a href="/page/10/">下一页</a></div><ul class="pagination-list is-hidden-mobile"><li><a class="pagination-link" href="/">1</a></li><li><span class="pagination-ellipsis">&hellip;</span></li><li><a class="pagination-link" href="/page/8/">8</a></li><li><a class="pagination-link is-current" href="/page/9/">9</a></li><li><a class="pagination-link" href="/page/10/">10</a></li><li><a class="pagination-link" href="/page/11/">11</a></li></ul></nav></div><div class="column column-left is-4-tablet is-4-desktop is-3-widescreen  order-1"><!--!--><div class="card widget" data-type="recent-posts"><div class="card-content"><h3 class="menu-label">最新文章</h3><article class="media"><div class="media-content"><p class="date"><time dateTime="2023-06-12T04:13:41.000Z">2023-06-12</time></p><p class="title"><a href="/2023/06/12/%E3%80%90%E5%85%AC%E4%BC%97%E5%8F%B7%E5%BC%80%E5%8F%91%E3%80%91%E5%85%AC%E4%BC%97%E5%8F%B7%E6%8A%80%E6%9C%AF%E5%88%86%E4%BA%AB%E7%AC%AC%E4%B8%89%E6%9C%9F-%E5%85%AC%E4%BC%97%E5%8F%B7%E4%BA%8B%E4%BB%B6%E5%A4%84%E7%90%86-%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F%E5%AE%9E%E6%88%98%E5%88%86%E4%BA%AB/">【公众号开发】公众号技术分享第三期-公众号事件处理-设计模式实战分享</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2023-06-06T00:13:41.000Z">2023-06-06</time></p><p class="title"><a href="/2023/06/06/%E3%80%90%E5%85%AC%E4%BC%97%E5%8F%B7%E5%BC%80%E5%8F%91%E3%80%91%E5%85%AC%E4%BC%97%E5%8F%B7%E6%8A%80%E6%9C%AF%E5%88%86%E4%BA%AB%E7%AC%AC%E4%BA%8C%E6%9C%9F-%E5%85%AC%E4%BC%97%E5%8F%B7%E6%A8%A1%E6%9D%BF%E6%B6%88%E6%81%AF-%E6%A8%A1%E6%9D%BF%E6%A8%A1%E5%BC%8F%E5%AE%9E%E6%88%98%E5%88%86%E4%BA%AB/">【公众号开发】公众号技术分享第二期-公众号模板消息-模板模式实战分享</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2023-06-06T00:10:41.000Z">2023-06-06</time></p><p class="title"><a href="/2023/06/06/%E3%80%90%E5%85%AC%E4%BC%97%E5%8F%B7%E5%BC%80%E5%8F%91%E3%80%91%E5%85%AC%E4%BC%97%E5%8F%B7%E6%8A%80%E6%9C%AF%E5%88%86%E4%BA%AB%E7%AC%AC%E4%B8%80%E6%9C%9F-%E5%A6%82%E4%BD%95%E6%B3%A8%E5%86%8C%E5%BE%AE%E4%BF%A1%E5%85%AC%E4%BC%97%E5%B9%B3%E5%8F%B0%E5%B9%B6%E4%BD%BF%E7%94%A8%E5%85%AC%E4%BC%97%E5%8F%B7%E6%A8%A1%E6%9D%BF%E6%B6%88%E6%81%AF/">【公众号开发】公众号技术分享第一期-如何注册微信公众平台并使用公众号模板消息</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2023-06-05T17:10:41.000Z">2023-06-06</time></p><p class="title"><a href="/2023/06/06/%E3%80%90Sentinel%E3%80%91Docker%E6%90%AD%E5%BB%BASentinel/">【Sentinel】Docker搭建Sentinel</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2023-06-05T07:25:21.000Z">2023-06-05</time></p><p class="title"><a href="/2023/06/05/%E3%80%90Git%E3%80%91Github%E6%8F%90%E4%BA%A4%E4%BB%A3%E7%A0%81%E9%81%87%E5%88%B0%E9%94%99%E8%AF%AF%EF%BC%9AERROR%20You%E2%80%98re%20using%20an%20RSA%20key%20with%20SHA-1,%20which%20is%20no%20longer%20allowed/">【Git】Github提交代码遇到错误：ERROR You‘re using an RSA key with SHA-1, which is no longer allowed</a></p></div></article></div></div><div class="card widget" data-type="archives"><div class="card-content"><div class="menu"><h3 class="menu-label">归档</h3><ul class="menu-list"><li><a class="level is-mobile" href="/archives/2023/"><span class="level-start"><span class="level-item">2023</span></span><span class="level-end"><span class="level-item tag">41</span></span></a></li><li><a class="level is-mobile" href="/archives/2022/"><span class="level-start"><span class="level-item">2022</span></span><span class="level-end"><span class="level-item tag">62</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/"><span class="level-start"><span class="level-item">2021</span></span><span class="level-end"><span class="level-item tag">43</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/"><span class="level-start"><span class="level-item">2020</span></span><span class="level-end"><span class="level-item tag">5</span></span></a></li></ul></div></div></div><!--!--><div class="card widget" data-type="profile"><div class="card-content"><nav class="level"><div class="level-item has-text-centered flex-shrink-1"><div><figure class="image is-128x128 mx-auto mb-2"><img class="avatar" src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/%E4%BA%8C%E7%BB%B4%E7%A0%81plus.png" alt="InterviewCoder"></figure><p class="title is-size-4 is-block" style="line-height:inherit;">InterviewCoder</p><p class="is-size-6 is-block">面试记官方公众号</p></div></div></nav><nav class="level is-mobile"><div class="level-item has-text-centered is-marginless"><div><p class="heading">文章</p><a href="/archives"><p class="title">151</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">分类</p><a href="/categories"><p class="title">0</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">标签</p><a href="/tags"><p class="title">0</p></a></div></div></nav><div class="level"><a class="level-item button is-primary is-rounded" href="https://mp.weixin.qq.com/s/jWs6lLHl5L-atXJhHc4YvA" target="_blank" rel="noopener">关注我</a></div></div></div><div class="column-right-shadow is-hidden-widescreen"></div></div><div class="column column-right is-4-tablet is-4-desktop is-3-widescreen is-hidden-touch is-hidden-desktop-only order-3"><div class="card widget" data-type="profile"><div class="card-content"><nav class="level"><div class="level-item has-text-centered flex-shrink-1"><div><figure class="image is-128x128 mx-auto mb-2"><img class="avatar is-rounded" src="https://brath.cloud/me.png" alt="Brath"></figure><p class="title is-size-4 is-block" style="line-height:inherit;">Brath</p><p class="is-size-6 is-block">技能改变人生，知识改变命运。</p><p class="is-size-6 is-flex justify-content-center"><i class="fas fa-map-marker-alt mr-1"></i><span>中国·江苏·无锡</span></p></div></div></nav><nav class="level is-mobile"><div class="level-item has-text-centered is-marginless"><div><p class="heading">文章</p><a href="/archives"><p class="title">151</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">分类</p><a href="/categories"><p class="title">0</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">标签</p><a href="/tags"><p class="title">0</p></a></div></div></nav><div class="level"><a class="level-item button is-primary is-rounded" href="https://github.com/Guoqing815" target="_blank" rel="noopener">关注我</a></div><div class="level is-mobile is-multiline"><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Github" href="https://github.com/Guoqing815"><i class="fab fa-github"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Gitee" href="https://gitee.com/Guoqing-Li"><i class="fab fa-gitee"></i></a></div></div></div><!--!--><div class="card widget" data-type="links"><div class="card-content"><div class="menu"><h3 class="menu-label">链接</h3><ul class="menu-list"><li><a class="level is-mobile" href="https://schokolade.cn/" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">泠灵(特别鸣谢)</span></span><span class="level-right"><span class="level-item tag">schokolade.cn</span></span></a></li><li><a class="level is-mobile" href="https://github.com/Guoqing815/interview" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">面试记Github</span></span><span class="level-right"><span class="level-item tag">github.com</span></span></a></li><li><a class="level is-mobile" href="https://www.pgyer.com/interview_app_release" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">面试记App(Android)</span></span><span class="level-right"><span class="level-item tag">www.pgyer.com</span></span></a></li><li><a class="level is-mobile" href="https://gitee.com/Guoqing-Li" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">Gitee(码云)</span></span><span class="level-right"><span class="level-item tag">gitee.com</span></span></a></li><li><a class="level is-mobile" href="https://blog.csdn.net/Brath?type=blog" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">CSDN</span></span><span class="level-right"><span class="level-item tag">blog.csdn.net</span></span></a></li><li><a class="level is-mobile" href="https://juejin.cn/user/settings/profile" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">掘金</span></span><span class="level-right"><span class="level-item tag">juejin.cn</span></span></a></li><li><a class="level is-mobile" href="https://oss.console.aliyun.com/" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">AliCloud(阿里云)</span></span><span class="level-right"><span class="level-item tag">oss.console.aliyun.com</span></span></a></li><li><a class="level is-mobile" href="https://cloud.tencent.com/" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">TencentCloud(腾讯云)</span></span><span class="level-right"><span class="level-item tag">cloud.tencent.com</span></span></a></li><li><a class="level is-mobile" href="https://www.zhipin.com/web/user/" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">BOSS</span></span><span class="level-right"><span class="level-item tag">www.zhipin.com</span></span></a></li><li><a class="level is-mobile" href="https://www.bilibili.com/" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">Bilibili(B站)</span></span><span class="level-right"><span class="level-item tag">www.bilibili.com</span></span></a></li></ul></div></div></div></div></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/"><img src="https://brath.cloud/avatar.png" alt="Brath-Blog" height="28"></a><p class="is-size-7"><span>&copy; 2023 Brath</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a><br><span id="busuanzi_container_site_uv">共<span id="busuanzi_value_site_uv">0</span>个访客</span></p><p class="is-size-7">© 2030</p></div><div class="level-end"></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script><script>moment.locale("zh-cn");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="/js/column.js"></script><script src="/js/animation.js"></script><a id="back-to-top" title="回到顶端" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><!--!--><!--!--><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.js" defer></script><script>window.addEventListener("load", () => {
      window.cookieconsent.initialise({
        type: "info",
        theme: "edgeless",
        static: false,
        position: "bottom-left",
        content: {
          message: "此网站使用Cookie来改善您的体验。",
          dismiss: "知道了！",
          allow: "允许使用Cookie",
          deny: "拒绝",
          link: "了解更多",
          policy: "Cookie政策",
          href: "https://www.cookiesandyou.com/",
        },
        palette: {
          popup: {
            background: "#edeff5",
            text: "#838391"
          },
          button: {
            background: "#4b81e8"
          },
        },
      });
    });</script><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><!--!--><!--!--><!--!--><script src="/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="想要查找什么..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"想要查找什么...","untitled":"(无标题)","posts":"文章","pages":"页面","categories":"分类","tags":"标签"});
        });</script></body></html>