<!doctype html>
<html lang="zh"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta><title>Brath-Blog</title><link rel="manifest" href="/manifest.json"><meta name="application-name" content="Brath-Blog"><meta name="msapplication-TileImage" content="https://brath.cloud/avatar.png"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="Brath-Blog"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta property="og:type" content="blog"><meta property="og:title" content="Brath-Blog"><meta property="og:url" content="http://example.com/"><meta property="og:site_name" content="Brath-Blog"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="http://example.com/img/og_image.png"><meta property="article:author" content="Brath"><meta property="twitter:card" content="summary"><meta property="twitter:image:src" content="http://example.com/img/og_image.png"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"http://example.com"},"headline":"Brath-Blog","image":["http://example.com/img/og_image.png"],"author":{"@type":"Person","name":"Brath"},"publisher":{"@type":"Organization","name":"Brath-Blog","logo":{"@type":"ImageObject","url":"https://brath.cloud/avatar.png"}},"description":""}</script><link rel="icon" href="https://brath.cloud/avatar.png"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v6.0.0/css/all.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/atom-one-light.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><!--!--><!--!--><script src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" defer></script><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/css/justifiedGallery.min.css"><!--!--><!--!--><style>.pace{-webkit-pointer-events:none;pointer-events:none;-webkit-user-select:none;-moz-user-select:none;user-select:none}.pace-inactive{display:none}.pace .pace-progress{background:#3273dc;position:fixed;z-index:2000;top:0;right:100%;width:100%;height:2px}</style><script src="https://cdn.jsdelivr.net/npm/pace-js@1.2.4/pace.min.js"></script><!--!--><!--!--><!-- hexo injector head_end start --><script>
  (function () {
      function switchTab() {
          if (!location.hash) {
            return;
          }

          const id = '#' + CSS.escape(location.hash.substring(1));
          const $tabMenu = document.querySelector(`.tabs a[href="${id}"]`);
          if (!$tabMenu) {
            return;
          }

          const $tabMenuContainer = $tabMenu.parentElement.parentElement;
          Array.from($tabMenuContainer.children).forEach($menu => $menu.classList.remove('is-active'));
          Array.from($tabMenuContainer.querySelectorAll('a'))
              .map($menu => document.getElementById($menu.getAttribute("href").substring(1)))
              .forEach($content => $content.classList.add('is-hidden'));

          if ($tabMenu) {
              $tabMenu.parentElement.classList.add('is-active');
          }
          const $activeTab = document.querySelector(id);
          if ($activeTab) {
              $activeTab.classList.remove('is-hidden');
          }
      }
      switchTab();
      window.addEventListener('hashchange', switchTab, false);
  })();
  </script><!-- hexo injector head_end end --><meta name="generator" content="Hexo 6.3.0"></head><body class="is-3-column"><nav class="navbar navbar-main"><div class="container navbar-container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="https://brath.cloud/avatar.png" alt="Brath-Blog" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">主页</a><a class="navbar-item" href="/archives">文章列表</a><a class="navbar-item" href="/tags">标签</a><a class="navbar-item" href="/about">更多</a></div><div class="navbar-end"><a class="navbar-item" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/Guoqing815"><i class="fab fa-github"></i></a><a class="navbar-item search" title="搜索" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-6-widescreen"><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2021-01-10T22:26:17.000Z" title="2021-1-11 6:26:17">2021-01-11</time>发表</span><span class="level-item"><time dateTime="2021-08-24T22:52:35.000Z" title="2021-8-25 6:52:35">2021-08-25</time>更新</span><span class="level-item">6 分钟读完 (大约966个字)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2021/01/11/%E3%80%90Elasticsearch%E3%80%91Linux%E7%8E%AF%E5%A2%83%E4%B8%8B%E5%AE%89%E8%A3%85%E5%B9%B6%E5%90%AF%E5%8A%A8Elasticsearch7/">Linux环境下安装并启动Elasticsearch7</a></p><div class="content"><p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/%E6%89%AB%E7%A0%81_%E6%90%9C%E7%B4%A2%E8%81%94%E5%90%88%E4%BC%A0%E6%92%AD%E6%A0%B7%E5%BC%8F-%E6%A0%87%E5%87%86%E8%89%B2%E7%89%88.png" alt="InterviewCoder"></p>
<h3 id="elasticsearch"><a class="markdownIt-Anchor" href="#elasticsearch">#</a> Elasticsearch</h3>
<p>​        Elasticsearch (ES) 是一个基于 Lucene 构建的开源、分布式、RESTful 接口全文搜索引擎。Elasticsearch 还是一个分布式文档数据库，其中每个字段均是被索引的数据且可被搜索，它能够扩展至数以百计的服务器存储以及处理 PB 级的数据。它可以在很短的时间内在存储、搜索和分析大量的数据。它通常作为具有复杂搜索场景情况下的核心发动机。es 是由 java 语言编写的。</p>
<pre><code>Elasticsearch就是为高可用和可扩展而生的。可以通过购置性能更强的服务器来完成。
</code></pre>
<p><a target="_blank" rel="noopener" href="https://www.elastic.co/cn/elasticsearch/">Elasticsearch：官方分布式搜索和分析引擎 | Elastic<img src="https://brath.oss-cn-shanghai.aliyuncs.com/pigo/icon-default.png" alt="img">https://www.elastic.co/cn/elasticsearch/</a></p>
<h2 id=""><a class="markdownIt-Anchor" href="#">#</a> </h2>
<h2 id="linux里部署es"><a class="markdownIt-Anchor" href="#linux里部署es">#</a> Linux 里部署 ES</h2>
<h3 id="下载地址"><a class="markdownIt-Anchor" href="#下载地址">#</a> 下载地址</h3>
<p>​        我下载的版本是 ES7.15.1</p>
<p>Elasticsearch 7.15.1 | Elastic<img src="https://brath.oss-cn-shanghai.aliyuncs.com/pigo/apple-icon-57x57.png" alt="img"><a target="_blank" rel="noopener" href="https://www.elastic.co/cn/downloads/past-releases/elasticsearch-7-15-1">https://www.elastic.co/cn/downloads/past-releases/elasticsearch-7-15-1</a></p>
<p><img src="https://brath.oss-cn-shanghai.aliyuncs.com/pigo/74a3f6fc611945ebb8e492204fe4b51f.png" alt="img"></p>
<p><img src="https://brath.oss-cn-shanghai.aliyuncs.com/pigo/4490382f8fd54a48bbd8e2ffaf2ce6ea.png" alt="img"></p>
<h3 id="上传到linux"><a class="markdownIt-Anchor" href="#上传到linux">#</a> 上传到 Linux</h3>
<p>​    压缩包下载完成后上传到服务器</p>
<p><img src="https://brath.oss-cn-shanghai.aliyuncs.com/pigo/3732b77fcd15428e8397739b50f6b3b1.png" alt="img"></p>
<h3 id="解压软件"><a class="markdownIt-Anchor" href="#解压软件">#</a> 解压软件</h3>
<p>​     解压到上级目录，然后进行改名</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">解压缩</span></span><br><span class="line">tar -zxvf elasticsearch-7.15.1-linux-x86_64.tar.gz -C ../</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">改名</span></span><br><span class="line">mv elasticsearch-7.15.1 es-7.15.1</span><br></pre></td></tr></table></figure>
<p><img src="https://brath.oss-cn-shanghai.aliyuncs.com/pigo/e6ff579f0e6b4aa6994e17629bbaa96a.png" alt="img"></p>
<p><img src="https://brath.oss-cn-shanghai.aliyuncs.com/pigo/7678de3df173498e92409dc8300f09b5.png" alt="img"></p>
<p>在 /opt 目录下新建 module/es 目录，同时把 es-7.15.1 移到该目录</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mv es-7.15.1 /opt/module/es</span><br></pre></td></tr></table></figure>
<h3 id="创建用户"><a class="markdownIt-Anchor" href="#创建用户">#</a> 创建用户</h3>
<p>​    因为安全问题， Elasticsearch 不允许 root 用户直接运行，所以要创建新用户，在 root 用户中创建新用户。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">useradd es #新增 es 用户</span><br><span class="line">passwd es #为 es 用户设置密码</span><br><span class="line">userdel -r es #如果错了，可以删除再加</span><br><span class="line">chown -R es:es /opt/module/es/es-7.15.1 #文件夹所有者</span><br></pre></td></tr></table></figure>
<p><img src="https://brath.oss-cn-shanghai.aliyuncs.com/pigo/cf9ac437254f47bfa9e26f4770fa9667.png" alt="img"></p>
<p><img src="https://brath.oss-cn-shanghai.aliyuncs.com/pigo/3b5a89b6cdbb4a3bb6220423400e25d2.png" alt="img"></p>
<h3 id="修改配置文件"><a class="markdownIt-Anchor" href="#修改配置文件">#</a> 修改配置文件</h3>
<p>修改 /root/es-7.15.1/config/elasticsearch.yml 文件。</p>
<p><img src="https://brath.oss-cn-shanghai.aliyuncs.com/pigo/d40fbb16c317400495682be93a2e07d7.png" alt="img"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># 加入如下配置</span><br><span class="line">cluster.name: elasticsearch</span><br><span class="line">node.name: node-1</span><br><span class="line">network.host: 0.0.0.0</span><br><span class="line">http.port: 9200</span><br><span class="line">cluster.initial_master_nodes: [&quot;node-1&quot;]</span><br></pre></td></tr></table></figure>
<p><img src="https://brath.oss-cn-shanghai.aliyuncs.com/pigo/00e7d21c15c640ba949d3dda5e9ee885.png" alt="img"></p>
<h3 id="修改etcsecuritylimitsconf"><a class="markdownIt-Anchor" href="#修改etcsecuritylimitsconf">#</a> 修改 /etc/security/limits.conf</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># 在文件末尾中增加下面内容</span><br><span class="line"># 每个进程可以打开的文件数的限制</span><br><span class="line">es soft nofile 65536</span><br><span class="line">es hard nofile 65536</span><br></pre></td></tr></table></figure>
<p><img src="https://brath.oss-cn-shanghai.aliyuncs.com/pigo/4d4441f8e29346a0bc5a0ac8959477d9.png" alt="img"></p>
<h3 id="修改etcsysctlconf"><a class="markdownIt-Anchor" href="#修改etcsysctlconf">#</a> 修改 /etc/sysctl.conf</h3>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">在文件中增加下面内容</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">一个进程可以拥有的 VMA(虚拟内存区域)的数量,默认值为 65536</span></span><br><span class="line">vm.max_map_count=655360</span><br></pre></td></tr></table></figure>
<h3 id="重新加载"><a class="markdownIt-Anchor" href="#重新加载">#</a> 重新加载</h3>
<p>sysctl -p</p>
<h3 id="注意"><a class="markdownIt-Anchor" href="#注意">#</a> 注意：</h3>
<p>​    启动前需要先切换到 es 用户</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">su es</span><br></pre></td></tr></table></figure>
<h3 id="启动es"><a class="markdownIt-Anchor" href="#启动es">#</a> 启动 es</h3>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">启动 进入bin目录：</span></span><br><span class="line">./elasticsearch</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">后台启动</span></span><br><span class="line">./elasticsearch -d  </span><br></pre></td></tr></table></figure>
<h3 id="测试连接"><a class="markdownIt-Anchor" href="#测试连接">#</a> 测试连接</h3>
<p>​    浏览器中打开 <a target="_blank" rel="noopener" href="http://xn--ip-fr5c86lx7z:9200/">http:// 服务器 IP:9200/</a>, 出现如下则说明安装成功</p>
<p><img src="https://brath.oss-cn-shanghai.aliyuncs.com/pigo/0197dcff901f47279750939332674547.png" alt="img"></p>
<h2 id="关于我"><a class="markdownIt-Anchor" href="#关于我">#</a> 关于我</h2>
<p>Brath 是一个热爱技术的 Java 程序猿，公众号「InterviewCoder」定期分享有趣有料的精品原创文章！</p>
<p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/%E4%BA%8C%E7%BB%B4%E7%A0%81plus.png" alt="InterviewCoder"></p>
<p>非常感谢各位人才能看到这里，原创不易，文章如果有帮助可以关注、点赞、分享或评论，这都是对我的莫大支持！</p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2021-01-08T06:37:17.000Z" title="2021-1-8 14:37:17">2021-01-08</time>发表</span><span class="level-item"><time dateTime="2023-10-08T18:01:59.000Z" title="2023-10-9 2:01:59">2023-10-09</time>更新</span><span class="level-item">2 分钟读完 (大约306个字)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2021/01/08/%E3%80%90Flutter%E3%80%91Flutter%E5%BC%80%E5%8F%91%E4%B8%AD%E4%BD%BF%E7%94%A8WIFI%E7%9C%9F%E6%9C%BA%E8%B0%83%E8%AF%95/">Flutter开发中使用WIFI真机调试</a></p><div class="content"><p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/%E6%89%AB%E7%A0%81_%E6%90%9C%E7%B4%A2%E8%81%94%E5%90%88%E4%BC%A0%E6%92%AD%E6%A0%B7%E5%BC%8F-%E6%A0%87%E5%87%86%E8%89%B2%E7%89%88.png" alt="InterviewCoder"></p>
<h1 id="flutter开发中使用wifi真机调试"><a class="markdownIt-Anchor" href="#flutter开发中使用wifi真机调试">#</a> Flutter 开发中使用 WIFI 真机调试</h1>
<h4 id="使用vscode开发flutter用wifi-或者-手机热点进行-无线调试过程"><a class="markdownIt-Anchor" href="#使用vscode开发flutter用wifi-或者-手机热点进行-无线调试过程">#</a> 使用 vscode 开发 flutter，用 wifi 或者 手机热点进行 无线调试过程</h4>
<h4 id="1手机连接wifi后在设置中找到ip和端口"><a class="markdownIt-Anchor" href="#1手机连接wifi后在设置中找到ip和端口">#</a> 1. 手机连接 wifi 后在设置中找到 ip 和端口</h4>
<h4 id="2在vscode终端输入-adb-connect-手机ip手机端口"><a class="markdownIt-Anchor" href="#2在vscode终端输入-adb-connect-手机ip手机端口">#</a> 2. 在 vscode 终端输入 adb connect 手机 IP: 手机端口</h4>
<h4 id="3作者在csdn这个烂环境中没找到有用的信息全是粘贴的所以希望这篇文章帮助到你你可以把我的地址列出来粘贴可以抄袭可耻"><a class="markdownIt-Anchor" href="#3作者在csdn这个烂环境中没找到有用的信息全是粘贴的所以希望这篇文章帮助到你你可以把我的地址列出来粘贴可以抄袭可耻">#</a> 3. 作者在 CSDN 这个烂环境中没找到有用的信息，全是粘贴的，所以希望这篇文章帮助到你，你可以把我的地址列出来，粘贴可以，抄袭可耻！</h4>
<h4 id="4完成以上步骤手机端应有开启无线调试的提示记得提前打开开发者模式"><a class="markdownIt-Anchor" href="#4完成以上步骤手机端应有开启无线调试的提示记得提前打开开发者模式">#</a> 4. 完成以上步骤，手机端应有开启无线调试的提示，记得提前打开开发者模式。</h4>
<h2 id="关于我"><a class="markdownIt-Anchor" href="#关于我">#</a> 关于我</h2>
<p>Brath 是一个热爱技术的 Java 程序猿，公众号「InterviewCoder」定期分享有趣有料的精品原创文章！</p>
<p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/%E4%BA%8C%E7%BB%B4%E7%A0%81plus.png" alt="InterviewCoder"></p>
<p>非常感谢各位人才能看到这里，原创不易，文章如果有帮助可以关注、点赞、分享或评论，这都是对我的莫大支持！</p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2021-01-01T18:18:05.000Z" title="2021-1-2 2:18:05">2021-01-02</time>发表</span><span class="level-item"><time dateTime="2023-09-17T05:27:20.000Z" title="2023-9-17 13:27:20">2023-09-17</time>更新</span><span class="level-item">8 分钟读完 (大约1170个字)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2021/01/02/%E3%80%90Vue%E3%80%91JSON%E7%BC%96%E8%BE%91%E5%99%A8Bin-Coder/">【Vue】JSON编辑器Bin-Coder</a></p><div class="content"><p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/%E6%89%AB%E7%A0%81_%E6%90%9C%E7%B4%A2%E8%81%94%E5%90%88%E4%BC%A0%E6%92%AD%E6%A0%B7%E5%BC%8F-%E6%A0%87%E5%87%86%E8%89%B2%E7%89%88.png" alt="InterviewCoder"></p>
<h1 id="vuejson编辑器bin-coder"><a class="markdownIt-Anchor" href="#vuejson编辑器bin-coder">#</a> 【Vue】JSON 编辑器 Bin-Coder</h1>
<p><a target="_blank" rel="noopener" href="https://wangbin3162.gitee.io/bin-code-editor/#/guide">Bin Code Editor</a></p>
<h1 id="1-安装"><a class="markdownIt-Anchor" href="#1-安装">#</a> 1 安装</h1>
<h2 id="11-cdn-安装"><a class="markdownIt-Anchor" href="#11-cdn-安装">#</a> 1.1 CDN 安装</h2>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- <span class="keyword">import</span> <span class="title class_">Vue</span>.<span class="property">js</span> --&gt;</span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;https://cdn.jsdelivr.net/npm/vue&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span></span><br><span class="line">&lt;!-- <span class="keyword">import</span> stylesheet --&gt;</span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">&quot;stylesheet&quot;</span> <span class="attr">href</span>=<span class="string">&quot;https://unpkg.com/bin-code-editor@0.1.0/lib/styles/index.css&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="comment">&lt;!-- import bin-code-editor --&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;https://unpkg.com/bin-code-editor@0.1.0/lib/bin-code-editor.min.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span></span><br></pre></td></tr></table></figure>
<p>@0.1.0 表示版本号，我们建议锁定版本号来保证代码的稳定性</p>
<h2 id="12-npm-安装"><a class="markdownIt-Anchor" href="#12-npm-安装">#</a> 1.2 npm 安装</h2>
<p>推荐使用 npm 安装，它能更好地和<a target="_blank" rel="noopener" href="https://so.csdn.net/so/search?q=webpack%E6%89%93%E5%8C%85&amp;spm=1001.2101.3001.7020"> webpack 打包</a>工具配合使用。而且可以更好的和 es6 配合使用。并且支持按需引入</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">npm i bin-code-editor -S</span><br><span class="line"># or </span><br><span class="line">yarn add bin-code-editor</span><br></pre></td></tr></table></figure>
<h1 id="2-引入"><a class="markdownIt-Anchor" href="#2-引入">#</a> 2 引入</h1>
<p>在 main.js 中写入以下内容：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="title class_">Vue</span> <span class="keyword">from</span> <span class="string">&#x27;vue&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="title class_">CodeEditor</span> <span class="keyword">from</span> <span class="string">&#x27;bin-code-editor&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">&#x27;bin-code-editor/lib/style/index.css&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="title class_">App</span> <span class="keyword">from</span> <span class="string">&#x27;./App.vue&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="title class_">Vue</span>.<span class="title function_">use</span>(<span class="title class_">CodeEditor</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">new</span> <span class="title class_">Vue</span>(&#123;</span><br><span class="line">  <span class="attr">el</span>: <span class="string">&#x27;#app&#x27;</span>,</span><br><span class="line">  <span class="attr">render</span>: <span class="function"><span class="params">h</span> =&gt;</span> <span class="title function_">h</span>(<span class="title class_">App</span>)</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h1 id="3-用法"><a class="markdownIt-Anchor" href="#3-用法">#</a> 3 用法</h1>
<p>注意，初始化如果有数据，则会默认格式化一次，格式化快捷键默认为 F7, 使用时可以进行格式化结构！</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">JSON.stringify(JSON.parse(jsonData),null,2)`可以将默认json进行预格式化,也可以手动触发formatCode()来格式化</span><br><span class="line">`JSON.stringify(value[, replacer[, space]])</span><br></pre></td></tr></table></figure>
<p>参数说明：</p>
<ul>
<li>value: 必需， 要转换的 JavaScript 值（通常为对象或数组）。</li>
<li>replacer: 可选。用于转换结果的函数或数组。如果 replacer 为函数，则 JSON.stringify 将调用该函数，并传入每个成员的键和值。使用返回值而不是原始值。如果此函数返回 undefined，则排除成员。根对象的键是一个空字符串：“”。如果 replacer 是一个数组，则仅转换该数组中具有键值的成员。成员的转换顺序与键在数组中的顺序一样。</li>
<li>space: 可选，文本添加缩进、空格和换行符，如果 space 是一个数字，则返回值文本在每个级别缩进指定数目的空格，如果 space 大于 10，则文本缩进 10 个空格。space 也可以使用非数字，如：\t。</li>
</ul>
<p><img src="https://img-blog.csdnimg.cn/ba155f2c67e14cc0b063a92a683220ff.png" alt="在这里插入图片描述"></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">  <span class="tag">&lt;<span class="name">b-code-editor</span> <span class="attr">v-model</span>=<span class="string">&quot;jsonStr&quot;</span> <span class="attr">:indent-unit</span>=<span class="string">&quot;4&quot;</span> <span class="attr">height</span>=<span class="string">&quot;auto&quot;</span>/&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">&lt;/template&gt;</span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">  <span class="keyword">const</span> jsonData = <span class="string">`&#123;&quot;title&quot;:&quot;测试json数据&quot;,&quot;children&quot;:[&#123;&quot;name&quot;:&quot;子项名称&quot;, &quot;desc&quot;:&quot;子项说明&quot; &#125;,&#123;&quot;name&quot;:&quot;子项名称1&quot;, &quot;desc&quot;:&quot;子项说明1&quot; &#125;]&#125;`</span></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml"></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">  <span class="keyword">export</span> <span class="keyword">default</span> &#123;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">    <span class="title function_">data</span>(<span class="params"></span>) &#123;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">      <span class="keyword">return</span> &#123;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">        <span class="attr">jsonStr</span>: jsonData</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">      &#125;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">    &#125;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">  &#125;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span></span><br></pre></td></tr></table></figure>
<h1 id="4-其他配置项"><a class="markdownIt-Anchor" href="#4-其他配置项">#</a> 4 其他配置项</h1>
<table>
<thead>
<tr>
<th>参数</th>
<th>说明</th>
<th>类型</th>
<th>可选值</th>
<th>默认值</th>
</tr>
</thead>
<tbody>
<tr>
<td>value</td>
<td>绑定数据，可用 v-model</td>
<td>String</td>
<td>—</td>
<td>0</td>
</tr>
<tr>
<td>show-number</td>
<td>显示行号</td>
<td>Boolean</td>
<td>—</td>
<td>true</td>
</tr>
<tr>
<td>mode</td>
<td>模式</td>
<td>String</td>
<td>‘application/json’,‘text/javascript’</td>
<td>‘application/json’</td>
</tr>
<tr>
<td>theme</td>
<td>提供若干个默认比较好看的皮肤</td>
<td>String</td>
<td>可选值参考其他配置项中列出</td>
<td>idea</td>
</tr>
<tr>
<td>lint</td>
<td>是否进行 lint 检查</td>
<td>Boolean</td>
<td>暂时只支持 json</td>
<td>true</td>
</tr>
<tr>
<td>readonly</td>
<td>只读模式</td>
<td>Boolean</td>
<td>-</td>
<td>false</td>
</tr>
<tr>
<td>auto-format</td>
<td>是否自动格式化</td>
<td>Boolean</td>
<td>-</td>
<td>true</td>
</tr>
<tr>
<td>indent-unit</td>
<td>缩进字符</td>
<td>Number</td>
<td>-</td>
<td>2</td>
</tr>
<tr>
<td>smart-indent</td>
<td>是否自动缩进</td>
<td>Boolean</td>
<td>-</td>
<td>true</td>
</tr>
<tr>
<td>line-wrap</td>
<td>代码换行</td>
<td>Boolean</td>
<td>-</td>
<td>true</td>
</tr>
<tr>
<td>gutter</td>
<td>代码折叠</td>
<td>Boolean</td>
<td>-</td>
<td>true</td>
</tr>
<tr>
<td>height</td>
<td>默认编辑器高度</td>
<td>String</td>
<td>—</td>
<td>300px</td>
</tr>
</tbody>
</table>
<h1 id="5-events-事件"><a class="markdownIt-Anchor" href="#5-events-事件">#</a> 5 Events 事件</h1>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">	<span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">	  <span class="tag">&lt;<span class="name">b-code-editor</span> <span class="attr">v-model</span>=<span class="string">&quot;jsonStr&quot;</span> <span class="attr">:indent-unit</span>=<span class="string">&quot;4&quot;</span> <span class="attr">height</span>=<span class="string">&quot;auto&quot;</span>/&gt;</span></span></span><br><span class="line"><span class="language-xml">	  <span class="tag">&lt;<span class="name">p</span>&gt;</span><span class="tag">&lt;<span class="name">b-button</span> @<span class="attr">click</span>=<span class="string">&quot;$refs[&#x27;editor&#x27;].formatCode()&quot;</span>&gt;</span>手动触发格式化<span class="tag">&lt;/<span class="name">b-button</span>&gt;</span><span class="tag">&lt;/<span class="name">p</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">	<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">&lt;/template&gt;</span><br></pre></td></tr></table></figure>
<table>
<thead>
<tr>
<th>事件名</th>
<th>说明</th>
<th>返回值</th>
</tr>
</thead>
<tbody>
<tr>
<td>on-change</td>
<td>输入项改变事件</td>
<td>value</td>
</tr>
<tr>
<td>formatCode</td>
<td>手动触发格式化方法</td>
<td>-</td>
</tr>
<tr>
<td>refresh</td>
<td>手动刷新方法</td>
<td>-</td>
</tr>
<tr>
<td>getValue</td>
<td>自行获取值</td>
<td>-</td>
</tr>
</tbody>
</table>
<h1 id="6-theme-皮肤属性"><a class="markdownIt-Anchor" href="#6-theme-皮肤属性">#</a> 6 theme 皮肤属性</h1>
<p><code>theme</code>  属性可选值</p>
<ul>
<li>idea<br>
<img src="https://img-blog.csdnimg.cn/774c7c41e1fd4dad81c4a8c4d56fb608.png" alt="在这里插入图片描述"></li>
<li>eclipse<br>
<img src="https://img-blog.csdnimg.cn/97d00490aa2c452e96cc64717798c9d5.png" alt="在这里插入图片描述"></li>
<li>duotone-light<br>
<img src="https://img-blog.csdnimg.cn/a9a97cd2eff84e60b687ddf8368c6e50.png" alt="在这里插入图片描述"></li>
<li>mdn-like<br>
<img src="https://img-blog.csdnimg.cn/68288d52b01d41fab7653d9c3dcfb10a.png" alt="在这里插入图片描述"></li>
<li>xq-light<br>
<img src="https://img-blog.csdnimg.cn/988f7ebe12ff42ef80f6b1a527bed1c7.png" alt="在这里插入图片描述"></li>
<li>dracula<br>
<img src="https://img-blog.csdnimg.cn/2aa62e024dbd41158a8bc66db799ef82.png" alt="在这里插入图片描述"></li>
<li>rubyblue<br>
<img src="https://img-blog.csdnimg.cn/04b909ae46234a0c871daa0545215526.png" alt="在这里插入图片描述"></li>
<li>monokai<br>
<img src="https://img-blog.csdnimg.cn/7baa723e068747a885ae2fa3b80048d2.png" alt="在这里插入图片描述"></li>
<li>material<br>
<img src="https://img-blog.csdnimg.cn/f949cc3c5f7344dc98c38751bd8db085.png" alt="在这里插入图片描述"></li>
<li>material-darker<br>
<img src="https://img-blog.csdnimg.cn/48f9a957450641e4b0ebb269f09aba7d.png" alt="在这里插入图片描述"></li>
</ul>
<h2 id="关于我"><a class="markdownIt-Anchor" href="#关于我">#</a> 关于我</h2>
<p>Brath 是一个热爱技术的 Java 程序猿，公众号「InterviewCoder」定期分享有趣有料的精品原创文章！</p>
<p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/%E4%BA%8C%E7%BB%B4%E7%A0%81plus.png" alt="InterviewCoder"></p>
<p>非常感谢各位人才能看到这里，原创不易，文章如果有帮助可以关注、点赞、分享或评论，这都是对我的莫大支持！</p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2020-12-20T00:42:43.000Z" title="2020-12-20 8:42:43">2020-12-20</time>发表</span><span class="level-item"><time dateTime="2023-11-26T06:52:52.000Z" title="2023-11-26 14:52:52">2023-11-26</time>更新</span><span class="level-item">15 分钟读完 (大约2268个字)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2020/12/20/%E3%80%90MySQL%E3%80%91Mysql%E4%B8%BB%E4%BB%8E%E9%9B%86%E7%BE%A4/">Mysql主从集群搭建文档，实现读写分离</a></p><div class="content"><p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/%E6%89%AB%E7%A0%81_%E6%90%9C%E7%B4%A2%E8%81%94%E5%90%88%E4%BC%A0%E6%92%AD%E6%A0%B7%E5%BC%8F-%E6%A0%87%E5%87%86%E8%89%B2%E7%89%88.png" alt="InterviewCoder"></p>
<h2 id="mysql主从集群搭建文档实现读写分离"><a class="markdownIt-Anchor" href="#mysql主从集群搭建文档实现读写分离">#</a> Mysql 主从集群搭建文档，实现读写分离</h2>
<p>​		最近在自己写的项目中需要应对大量的用户查询读写操作，一台服务器当然是不够的，所以在边学边敲的背景下，记录这篇笔记，从 0 开始搭建主从集群。</p>
<h4 id="下面开始操作"><a class="markdownIt-Anchor" href="#下面开始操作">#</a> 下面👇开始操作：</h4>
<p>1. 分别在两台服务器搭建 mysql 服务</p>
<p>​		两台服务器的 IP 地址分别为主服务器（192.168.20.1）和从服务器（192.168.20.2）。<br>
2. 配置文件 my.cnf 的修改</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">根据上一篇文章，编辑my.cnf文件</span></span><br><span class="line">[root@localhost mysql]# vim /etc/my.cnf</span><br><span class="line"><span class="meta prompt_"> </span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">在[mysqld]中添加：</span></span><br><span class="line">server-id=1</span><br><span class="line">log_bin=master-bin</span><br><span class="line">log_bin_index=master-bin.index</span><br><span class="line">binlog_do_db=test</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">备注：</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">server-id 服务器唯一标识。</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">log_bin 启动MySQL二进制日志，即数据同步语句，从数据库会一条一条的执行这些语句。</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">binlog_do_db 指定记录二进制日志的数据库，即需要复制的数据库名，如果复制多个数据库，重复设置这个选项即可。</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">binlog_ignore_db 指定不记录二进制日志的数据库，即不需要复制的数据库名，如果有多个数据库，重复设置这个选项即可。</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">其中需要注意的是，binlog_do_db和binlog_ignore_db为互斥选项，一般只需要一个即可。</span></span><br></pre></td></tr></table></figure>
<p>3. 创建从服务器的用户和权限</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">进入mysql数据库</span></span><br><span class="line">[root@localhost mysql]# mysql -uroot -p</span><br><span class="line">Enter password:</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">创建从数据库的root用户和权限</span></span><br><span class="line"><span class="meta prompt_">mysql&gt; </span><span class="language-bash">grant replication slave on *.* to root@<span class="string">&#x27;192.168.20.%&#x27;</span> identified by <span class="string">&#x27;Lgq081538&#x27;</span>;</span></span><br><span class="line"></span><br><span class="line">grant replication slave on *.* to &#x27;123456&#x27;</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">备注</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">192.168.20.%通配符，表示0-255的IP都可访问主服务器，正式环境请配置指定从服务器IP</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">若将 192.168.20.% 改为 %，则任何ip均可作为其从数据库来访问主服务器</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">退出mysql</span></span><br><span class="line"><span class="meta prompt_">mysql&gt; </span><span class="language-bash"><span class="built_in">exit</span>;</span></span><br></pre></td></tr></table></figure>
<p>4. 重启 mysql 服务</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost mysql]# service mysql restart</span><br><span class="line">Shutting down MySQL.... SUCCESS! </span><br><span class="line">Starting MySQL. SUCCESS! </span><br></pre></td></tr></table></figure>
<p>5. 查看主服务器状态</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">进入mysql数据库</span></span><br><span class="line">[root@localhost mysql]# mysql -uroot -p</span><br><span class="line">Enter password:</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">查看主服务器状态</span></span><br><span class="line"><span class="meta prompt_">mysql&gt; </span><span class="language-bash">show master status;</span></span><br><span class="line">+-------------------+----------+--------------+------------------+-------------------+</span><br><span class="line">| File              | Position | Binlog_Do_DB | Binlog_Ignore_DB | Executed_Gtid_Set |</span><br><span class="line">+-------------------+----------+--------------+------------------+-------------------+</span><br><span class="line">| master-bin.000001 |      154 | test         |                  |                   |</span><br><span class="line">+-------------------+----------+--------------+------------------+-------------------+</span><br><span class="line">1 row in set (0.00 sec)</span><br></pre></td></tr></table></figure>
<p>6.slave 从服务器的配置</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">配置文件my.cnf的修改</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">根据上一篇文章，编辑my.cnf文件</span></span><br><span class="line">[root@localhost mysql]# vim /etc/my.cnf</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">在[mysqld]中添加：</span></span><br><span class="line">server-id=2</span><br><span class="line">relay-log=slave-relay-bin</span><br><span class="line">relay-log-index=slave-relay-bin.index</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">replicate-do-db=<span class="built_in">test</span></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">备注：</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">server-id 服务器唯一标识，如果有多个从服务器，每个服务器的server-id不能重复，跟IP一样是唯一标识，如果你没设置server-id或者设置为0，则从服务器不会连接到主服务器。</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">relay-log 启动MySQL二进制日志，可以用来做数据备份和崩溃恢复，或主服务器挂掉了，将此从服务器作为其他从服务器的主服务器。</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">replicate-do-db 指定同步的数据库，如果复制多个数据库，重复设置这个选项即可。若在master端不指定binlog-do-db，则在slave端可用replication-do-db来过滤。</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">replicate-ignore-db 不需要同步的数据库，如果有多个数据库，重复设置这个选项即可。</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">其中需要注意的是，replicate-do-db和replicate-ignore-db为互斥选项，一般只需要一个即可。</span></span><br></pre></td></tr></table></figure>
<p>7. 重启 mysql 服务</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost mysql]# service mysql restart</span><br><span class="line">Shutting down MySQL.... SUCCESS! </span><br><span class="line">Starting MySQL. SUCCESS! </span><br></pre></td></tr></table></figure>
<p>8. 连接 master 主服务器</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">进入mysql数据库</span></span><br><span class="line">[root@localhost mysql]# mysql -uroot -p</span><br><span class="line">Enter password:</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">连接master主服务器</span></span><br><span class="line"><span class="meta prompt_">mysql&gt; </span><span class="language-bash">change master to master_host=<span class="string">&#x27;192.168.20.1&#x27;</span>,master_port=3306,master_user=<span class="string">&#x27;root&#x27;</span>,master_password=<span class="string">&#x27;123456&#x27;</span>,master_log_file=<span class="string">&#x27;master-bin.000009&#x27;</span>,master_log_pos=473127;</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">备注：</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">master_host对应主服务器的IP地址。</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">master_port对应主服务器的端口。</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">master_log_file对应show master status显示的File列：master-bin.000001。</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">master_log_pos对应show master status显示的Position列：154。</span></span><br></pre></td></tr></table></figure>
<p>9. 启动 slave 数据同步</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">启动slave数据同步</span></span><br><span class="line"><span class="meta prompt_">mysql&gt; </span><span class="language-bash">start slave;</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">停止slave数据同步（若有需要）</span></span><br><span class="line"><span class="meta prompt_">mysql&gt; </span><span class="language-bash">stop slave;</span></span><br><span class="line">3.5 查看slave信息</span><br><span class="line"><span class="meta prompt_">mysql&gt; </span><span class="language-bash">show slave status\G;</span></span><br><span class="line">Slave_IO_Running和Slave_SQL_Running都为yes，则表示同步成功。</span><br></pre></td></tr></table></figure>
<p>10. 测试</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">（1）在主服务器上登陆mysql，且进入test数据库，创建test表，且插入一条数据</span><br><span class="line">提示：这里最好用数据库管理工具（如nacicat）来操作。</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">创建tb_test表</span></span><br><span class="line">create table tb_test(ID varchar(36) primary key comment &#x27;主键ID&#x27;,MEMO varchar(500) not null comment &#x27;信息&#x27;);</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">插入一条数据</span></span><br><span class="line">insert into tb_test(ID,MEMO) values(&#x27;1&#x27;,&#x27;one test&#x27;);</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">提交</span></span><br><span class="line">commit;</span><br><span class="line">（2）在从服务器上登陆mysql，且进入test数据库</span><br><span class="line">你会发现从数据库中，也出现了tb_test表，且表中还有one test数据存在，证明同步数据成功。</span><br></pre></td></tr></table></figure>
<h3 id="至此mysql主从读写分离搭建完成"><a class="markdownIt-Anchor" href="#至此mysql主从读写分离搭建完成">#</a> 至此 Mysql 主从读写分离搭建完成</h3>
<p>下面开始搭建 Spring Boot 项目中的相关配置以及实现👇</p>
<p>​		读写分离要做的事情就是对于一条 SQL 该选择哪个数据库去执行，至于谁来做选择数据库这件事，主要有两种实现方式，分别为：<br>
1. 使用中间件，比如 Atlas，cobar，TDDL，mycat，heisenberg，Oceanus，vitess，OneProxy 等<br>
 2. 使用程序自己实现，利用 Spring Boot 提供的路由数据源以及 AOP，实现起来简单快捷<br>
​</p>
<p>​		我们使用第二种方式 Spring Boot 数据源路由 + AOP ，这样能更好的控制流程，也便于后期提升性能；</p>
<p>代码实现<br>
 1. 首先配置下 pom.<a target="_blank" rel="noopener" href="https://so.csdn.net/so/search?q=xml&amp;spm=1001.2101.3001.7020">xml</a> 因为我们使用 aop 实现，所以需要 aop 依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-aop<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>2. 数据源路由类功能 RoutingDataSource.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.springframework.jdbc.datasource.lookup.AbstractRoutingDataSource;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Auther</span>: Brath</span></span><br><span class="line"><span class="comment"> * Create By Administrator on 2022/6/24 12:05</span></span><br><span class="line"><span class="comment"> * Strive to create higher performance code</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@My</span> wechat: 17604868415</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@My</span> QQ: 2634490675</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@My</span> email 1: email_ guoqing@163.com</span></span><br><span class="line"><span class="comment"> * 数据源路由类功能</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RoutingDataSource</span> <span class="keyword">extends</span> <span class="title class_">AbstractRoutingDataSource</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> Object <span class="title function_">determineCurrentLookupKey</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> DBContext.get();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>3. 数据源上下文类 DBContext.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.atomic.AtomicInteger;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Auther</span>: Brath</span></span><br><span class="line"><span class="comment"> * Create By Administrator on 2022/6/24 12:05</span></span><br><span class="line"><span class="comment"> * Strive to create higher performance code</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@My</span> wechat: 17604868415</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@My</span> QQ: 2634490675</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@My</span> email 1: email_ guoqing@163.com</span></span><br><span class="line"><span class="comment"> * 数据源上下文类</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DBContext</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ThreadLocal&lt;DBTypeEnum&gt; dbContext = <span class="keyword">new</span> <span class="title class_">ThreadLocal</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">AtomicInteger</span> <span class="variable">counter</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AtomicInteger</span>(-<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">set</span><span class="params">(DBTypeEnum dbType)</span> &#123;</span><br><span class="line">        dbContext.set(dbType);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> DBTypeEnum <span class="title function_">get</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> dbContext.get();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">master</span><span class="params">()</span> &#123;</span><br><span class="line">        set(DBTypeEnum.MASTER);</span><br><span class="line">        log.info(<span class="string">&quot;切换到master库&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">slave</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">//  读库负载均衡(轮询方式)</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">index</span> <span class="operator">=</span> counter.getAndIncrement() % <span class="number">2</span>;</span><br><span class="line">        log.info(<span class="string">&quot;slave库访问线程数==&gt;&#123;&#125;&quot;</span>, counter.get());</span><br><span class="line">        <span class="keyword">if</span> (index == <span class="number">0</span>) &#123;</span><br><span class="line">            set(DBTypeEnum.SLAVE1);</span><br><span class="line">            log.info(<span class="string">&quot;切换到slave1库&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            set(DBTypeEnum.SLAVE2);</span><br><span class="line">            log.info(<span class="string">&quot;切换到slave2库&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>4. 数据库枚举类 DBTypeEnum.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.demo.databases;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Auther</span>: Brath</span></span><br><span class="line"><span class="comment"> * Create By Administrator on 2022/6/24 12:05</span></span><br><span class="line"><span class="comment"> * Strive to create higher performance code</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@My</span> wechat: 17604868415</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@My</span> QQ: 2634490675</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@My</span> email 1: email_ guoqing@163.com</span></span><br><span class="line"><span class="comment"> * 数据库枚举类</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> <span class="title class_">DBTypeEnum</span> &#123;</span><br><span class="line">    MASTER, <span class="comment">//主库</span></span><br><span class="line">    SLAVE1, <span class="comment">//从库1</span></span><br><span class="line">    SLAVE2  <span class="comment">//从库2</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>这里我们配置三个库，分别是一个写库 Master，2 个读库 slave1,slave2</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Qualifier;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.context.properties.ConfigurationProperties;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.jdbc.DataSourceBuilder;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> javax.sql.DataSource;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Auther</span>: Brath</span></span><br><span class="line"><span class="comment"> * Create By Administrator on 2022/6/24 12:05</span></span><br><span class="line"><span class="comment"> * Strive to create higher performance code</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@My</span> wechat: 17604868415</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@My</span> QQ: 2634490675</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@My</span> email 1: email_ guoqing@163.com</span></span><br><span class="line"><span class="comment"> * 数据库配置类</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DataSourceConfigs</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@ConfigurationProperties(&quot;spring.datasource.master&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> DataSource <span class="title function_">masterDataSource</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> DataSourceBuilder.create().build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@ConfigurationProperties(&quot;spring.datasource.slave1&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> DataSource <span class="title function_">slave1DataSource</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> DataSourceBuilder.create().build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@ConfigurationProperties(&quot;spring.datasource.slave2&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> DataSource <span class="title function_">slave2DataSource</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> DataSourceBuilder.create().build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> DataSource <span class="title function_">myRoutingDataSource</span><span class="params">(<span class="meta">@Qualifier(&quot;masterDataSource&quot;)</span> DataSource masterDataSource,</span></span><br><span class="line"><span class="params">                                          <span class="meta">@Qualifier(&quot;slave1DataSource&quot;)</span> DataSource slave1DataSource,</span></span><br><span class="line"><span class="params">                                          <span class="meta">@Qualifier(&quot;slave2DataSource&quot;)</span> DataSource slave2DataSource)</span> &#123;</span><br><span class="line">        Map&lt;Object, Object&gt; targetDataSources = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        targetDataSources.put(DBTypeEnum.MASTER, masterDataSource);</span><br><span class="line">        targetDataSources.put(DBTypeEnum.SLAVE1, slave1DataSource);</span><br><span class="line">        targetDataSources.put(DBTypeEnum.SLAVE2, slave2DataSource);</span><br><span class="line">        <span class="type">RoutingDataSource</span> <span class="variable">routingDataSource</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RoutingDataSource</span>();</span><br><span class="line">        routingDataSource.setDefaultTargetDataSource(masterDataSource);</span><br><span class="line">        routingDataSource.setTargetDataSources(targetDataSources);</span><br><span class="line">        <span class="keyword">return</span> routingDataSource;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>6. 切面类 DataSourceAop.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.aspectj.lang.annotation.Aspect;</span><br><span class="line"><span class="keyword">import</span> org.aspectj.lang.annotation.Before;</span><br><span class="line"><span class="keyword">import</span> org.aspectj.lang.annotation.Pointcut;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Auther</span>: Brath</span></span><br><span class="line"><span class="comment"> * Create By Administrator on 2022/6/24 12:05</span></span><br><span class="line"><span class="comment"> * Strive to create higher performance code</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@My</span> wechat: 17604868415</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@My</span> QQ: 2634490675</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@My</span> email 1: email_ guoqing@163.com</span></span><br><span class="line"><span class="comment"> * 切面类DataSourceAop</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Aspect</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DataSourceAop</span> &#123;</span><br><span class="line">    <span class="meta">@Pointcut(&quot;@annotation(com.example.demo.databases.Master) &quot; +</span></span><br><span class="line"><span class="meta">            &quot;|| execution(* com.example.demo.*.service..*.insert*(..)) &quot; +</span></span><br><span class="line"><span class="meta">            &quot;|| execution(* com.example.demo.*.service..*.create*(..)) &quot; +</span></span><br><span class="line"><span class="meta">            &quot;|| execution(* com.example.demo.*.service..*.save*(..)) &quot; +</span></span><br><span class="line"><span class="meta">            &quot;|| execution(* com.example.demo.*.service..*.add*(..)) &quot; +</span></span><br><span class="line"><span class="meta">            &quot;|| execution(* com.example.demo.*.service..*.update*(..)) &quot; +</span></span><br><span class="line"><span class="meta">            &quot;|| execution(* com.example.demo.*.service..*.edit*(..)) &quot; +</span></span><br><span class="line"><span class="meta">            &quot;|| execution(* com.example.demo.*.service..*.delete*(..)) &quot; +</span></span><br><span class="line"><span class="meta">            &quot;|| execution(* com.example.demo.*.service..*.remove*(..))&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">writePointcut</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Pointcut(&quot;!@annotation(com.example.demo.databases.Master) &quot; +</span></span><br><span class="line"><span class="meta">            &quot;&amp;&amp; (execution(* com.example.demo.*.service..*.select*(..)) &quot; +</span></span><br><span class="line"><span class="meta">            &quot;|| execution(* com.example.demo.*.service..*.list*(..))&quot; +</span></span><br><span class="line"><span class="meta">            &quot;|| execution(* com.example.demo.*.service..*.count*(..))&quot; +</span></span><br><span class="line"><span class="meta">            &quot;|| execution(* com.example.demo.*.service..*.get*(..)))&quot;</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">    )</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">readPointcut</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Before(&quot;writePointcut()&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">write</span><span class="params">()</span> &#123;</span><br><span class="line">        DBContext.master();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Before(&quot;readPointcut()&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">read</span><span class="params">()</span> &#123;</span><br><span class="line">        DBContext.slave();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>7. 注解类 Master.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.demo.databases;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Auther</span>: Brath</span></span><br><span class="line"><span class="comment"> * Create By Administrator on 2022/6/24 12:05</span></span><br><span class="line"><span class="comment"> * Strive to create higher performance code</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@My</span> wechat: 17604868415</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@My</span> QQ: 2634490675</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@My</span> email 1: email_ guoqing@163.com</span></span><br><span class="line"><span class="comment"> * 注解类Master 主库，可读写</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> Master &#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="关于我"><a class="markdownIt-Anchor" href="#关于我">#</a> 关于我</h2>
<p>Brath 是一个热爱技术的 Java 程序猿，公众号「InterviewCoder」定期分享有趣有料的精品原创文章！</p>
<p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/%E4%BA%8C%E7%BB%B4%E7%A0%81plus.png" alt="InterviewCoder"></p>
<p>非常感谢各位人才能看到这里，原创不易，文章如果有帮助可以关注、点赞、分享或评论，这都是对我的莫大支持！</p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2020-12-18T23:25:31.000Z" title="2020-12-19 7:25:31">2020-12-19</time>发表</span><span class="level-item"><time dateTime="2023-03-06T00:33:09.000Z" title="2023-3-6 8:33:09">2023-03-06</time>更新</span><span class="level-item">12 分钟读完 (大约1779个字)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2020/12/19/%E3%80%90Nginx%E3%80%91Nginx%E4%BB%A5%E5%8F%8Akeepalived%E5%AE%89%E8%A3%85%E4%BB%A5%E5%8F%8A%E9%83%A8%E7%BD%B2/">Nginx以及Keepalived安装以及部署</a></p><div class="content"><p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/%E6%89%AB%E7%A0%81_%E6%90%9C%E7%B4%A2%E8%81%94%E5%90%88%E4%BC%A0%E6%92%AD%E6%A0%B7%E5%BC%8F-%E6%A0%87%E5%87%86%E8%89%B2%E7%89%88.png" alt="InterviewCoder"></p>
<p>​		反向代理：指的是用户要访问 youtube, 但是 youtube 悄悄地把这个请求交给后台 N 台服务器中的其中一台来做，这种方式就是反向代理了。</p>
<p>​		负载均衡：</p>
<p>1) 使用硬件负载均衡策略，如使用 F5,Array 等负载均衡器.</p>
<p>2) 使用软件进行负载均衡<br>
 3) 如使用阿里云服务器均衡 SLB<br>
4) 使用我们今天所学习的 Nginx+Keepalived<br>
5) 其他软件负载均衡如 LVS (Linux Virtual Server),haproxy 等技术</p>
<h3 id="环境搭建"><a class="markdownIt-Anchor" href="#环境搭建">#</a> 环境搭建：</h3>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">步骤:</span><br><span class="line"><span class="number">1.</span>进行安装:tar -zxvf /root/software/nginx-<span class="number">1.6</span><span class="number">.2</span>.tar.gz -C /usr/local/</span><br><span class="line"><span class="number">2.</span>下载所需要的依赖库文件:</span><br><span class="line">   yum install pcre -y</span><br><span class="line">   yum install pcre-devel -y</span><br><span class="line">   yum install zlib -y</span><br><span class="line">   yum install zlib-devel -y</span><br><span class="line"><span class="number">3.</span>进行configure配置,查看是否报错</span><br><span class="line">   cd nginx-<span class="number">1.6</span><span class="number">.2</span></span><br><span class="line">   ./configure --prefix=/usr/local/nginx</span><br><span class="line"><span class="number">4.</span>编译安装:make &amp;&amp; make install</span><br><span class="line"><span class="number">5.</span>在 /usr/local/nginx目录下,可以看到如下<span class="number">4</span>个目录</span><br><span class="line">   conf配置文件,html网页文件,logs日志文件,sbin主要二进制程序</span><br><span class="line"><span class="number">6.</span>启动命令:/usr/local/nginx/sbin/nginx</span><br><span class="line">  关闭命令:/usr/local/nginx/sbin/nginx -s stop</span><br><span class="line">  重启命令:/usr/local/nginx/sbin/nginx -s reload</span><br><span class="line"><span class="number">7.</span>访问浏览器:http:<span class="comment">//192.168.122.133(看到欢迎页面说明没问题)</span></span><br><span class="line"></span><br><span class="line">注意:如果出现这个错误:./configure: error: C compiler cc is not found</span><br><span class="line">执行这个命令:yum -y install gcc gcc-c++ autoconf automake make</span><br></pre></td></tr></table></figure>
<p>Keepalived：</p>
<p>首先介绍一下 Keepalived, 它是一个高性能的服务器高可用或热备解决方案，Keepalived 主要防止服务器单点故障的问题，可以通过其与 Nginx 的配合实现 web 服务器端的高可用.<br>
Keepalived 以 VRRP 协议为实现基础，使用 VRRP 协议来实现高可用性 (HA).VRRP (Virtual Router Redundacy Protocol) 协议用于实现路由器冗余的协议，VRRP 协议将两台或多台路由器设备虚拟成一个设备，向外提供虚拟路由 IP (一个或多个)。</p>
<p>安装以及部署：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">第一步：安装keepalived依赖的包</span><br><span class="line">	yum install -y gcc</span><br><span class="line">    yum install -y openssl-devel</span><br><span class="line">	yum install -y libnl3-devel</span><br><span class="line">	yum install -y popt-devel</span><br><span class="line">	yum install -y iptables-devel</span><br><span class="line">	yum install -y libnfnetlink-devel</span><br><span class="line">	yum install -y psmisc</span><br><span class="line">第二步：编译安装keepalived</span><br><span class="line">	将keepalived的安装包 上传到/usr/local/software 目录下  </span><br><span class="line">	cd /usr/local/software</span><br><span class="line">	tar -zxvf keepalived-<span class="number">1.2</span><span class="number">.19</span>.tar.gz -C /usr/local  </span><br><span class="line">	cd /usr/local/keepalived-<span class="number">1.2</span><span class="number">.19</span>  </span><br><span class="line">	./configure --prefix=/usr/local/keepalived  </span><br><span class="line">	make &amp;&amp; make install </span><br><span class="line">第三步：将 keepalived 安装成 Linux 系统服务</span><br><span class="line">	安装完成之后， 需要做一些工作复制默认配置文件到 默认路径  </span><br><span class="line">	mkdir /etc/keepalived  </span><br><span class="line">	cp /usr/local/keepalived/etc/keepalived/keepalived.conf /etc/keepalived/  </span><br><span class="line">	cp /usr/local/keepalived/sbin/keepalived /usr/sbin/  </span><br><span class="line">	cp /usr/local/keepalived/etc/sysconfig/keepalived /etc/sysconfig/  </span><br><span class="line">	cd /usr/local/keepalived-<span class="number">1.2</span><span class="number">.19</span>  </span><br><span class="line">	cp ./keepalived/etc/init.d/keepalived.init /etc/init.d/</span><br><span class="line">	chmod <span class="number">755</span> /etc/init.d/keepalived.init </span><br><span class="line">第四步：编写nginx检测脚本:</span><br><span class="line">vi /etc/keepalived/nginx_check.sh</span><br><span class="line">内容如下：  </span><br><span class="line">#!/bin/bash  </span><br><span class="line">A=`ps -C nginx –no-header |wc -l`  </span><br><span class="line"><span class="keyword">if</span> [ $A -eq <span class="number">0</span> ];then  </span><br><span class="line">    /usr/local/nginx/sbin/nginx  </span><br><span class="line">    sleep <span class="number">2</span>  </span><br><span class="line">    <span class="keyword">if</span> [ `ps -C nginx --no-header |wc -l` -eq <span class="number">0</span> ];then  </span><br><span class="line">        killall keepalived  </span><br><span class="line">    fi  </span><br><span class="line">fi  </span><br><span class="line">赋予执行权限  </span><br><span class="line">chmod +x /etc/keepalived/nginx_check.sh </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">启动命令:</span><br><span class="line">  keepalived</span><br></pre></td></tr></table></figure>
<p>修改 Master 配置</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">修改keepalived的Master配置文件:vi /etc/keepalived/keepalived.conf </span><br><span class="line">! Configuration File <span class="keyword">for</span> keepalived       </span><br><span class="line">global_defs &#123;      </span><br><span class="line">   router_id wolfcode                           ##路由器标志    </span><br><span class="line">&#125;    </span><br><span class="line"># 集群资源监控，组合track_script进行    </span><br><span class="line">vrrp_script check_haproxy &#123;    </span><br><span class="line">	script <span class="string">&quot;/etc/keepalived/nginx_check.sh&quot;</span>  #检测 nginx 状态的脚本路径  </span><br><span class="line">	interval <span class="number">2</span>  #检测时间间隔  </span><br><span class="line">	weight -<span class="number">20</span>  #条件成立 权重减<span class="number">20</span>  </span><br><span class="line">&#125;    </span><br><span class="line">vrrp_instance PROXY &#123;    </span><br><span class="line">	# 设置当前主机为主节点，如果是备用节点，则设置为BACKUP   </span><br><span class="line">	state MASTER</span><br><span class="line">	# 指定HA监测网络接口，可以用ifconfig查看来决定设置哪一个    </span><br><span class="line">	<span class="keyword">interface</span> <span class="title class_">ens32</span></span><br><span class="line">	# 虚拟路由标识，同一个VRRP实例要使用同一个标识，主备机    </span><br><span class="line">	virtual_router_id <span class="number">80</span>    </span><br><span class="line">	# 因为当前环境中VRRP组播有问题，改为使用单播发送VRRP报文  如果VRRP组播没问题，以下这块的内容可以注释掉。  </span><br><span class="line">	# 这个地方需要关注，之前未做此设置，结果主备节点互相不能发现，因此主备节点都升级成了MASTER，并且绑定了VIP    </span><br><span class="line">	# 主节点时，内容为：    </span><br><span class="line">	unicast_src_ip <span class="number">192.168</span><span class="number">.122</span><span class="number">.133</span></span><br><span class="line">	# 设置优先级，确保主节点的优先级高过备用节点  </span><br><span class="line">	priority <span class="number">100</span>    </span><br><span class="line">	# 用于设定主备节点间同步检查时间间隔    </span><br><span class="line">	advert_int <span class="number">2</span>    </span><br><span class="line">	# 设置主备节点间的通信验证类型及密码，同一个VRRP实例中需一致    </span><br><span class="line">	authentication &#123;    </span><br><span class="line">		auth_type PASS    </span><br><span class="line">		auth_pass wolfcode</span><br><span class="line">	&#125;    </span><br><span class="line">	# 集群资源监控，组合vrrp_script进行    </span><br><span class="line">	track_script &#123;    </span><br><span class="line">		check_haproxy    </span><br><span class="line">	&#125;    </span><br><span class="line">	# 设置虚拟IP地址，当keepalived状态切换为MASTER时，此IP会自动添加到系统中    </span><br><span class="line">	# 当状态切换到BACKUP时，此IP会自动从系统中删除    </span><br><span class="line">	# 可以通过命令ip add查看切换后的状态    </span><br><span class="line">	virtual_ipaddress &#123;    </span><br><span class="line">		<span class="number">192.168</span><span class="number">.122</span><span class="number">.110</span>  #虚拟ip配置完之后就用它访问    </span><br><span class="line">	&#125;    </span><br><span class="line">&#125;  </span><br></pre></td></tr></table></figure>
<p>修改 Slave 配置：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">修改keepalived的Slave配置文件:vi /etc/keepalived/keepalived.conf </span><br><span class="line">! Configuration File <span class="keyword">for</span> keepalived       </span><br><span class="line">global_defs &#123;      </span><br><span class="line">   router_id wolfcode                           ##路由器标志    </span><br><span class="line">&#125;    </span><br><span class="line"># 集群资源监控，组合track_script进行    </span><br><span class="line">vrrp_script check_haproxy &#123;    </span><br><span class="line">	script <span class="string">&quot;/etc/keepalived/nginx_check.sh&quot;</span>  #检测 nginx 状态的脚本路径  </span><br><span class="line">	interval <span class="number">2</span>  #检测时间间隔  </span><br><span class="line">	weight -<span class="number">20</span>  #条件成立 权重减<span class="number">20</span>  </span><br><span class="line">&#125;    </span><br><span class="line">vrrp_instance PROXY &#123;    </span><br><span class="line">	# 设置当前主机为主节点，如果是备用节点，则设置为BACKUP   </span><br><span class="line">	state BACKUP</span><br><span class="line">	# 指定HA监测网络接口，可以用ifconfig查看来决定设置哪一个    </span><br><span class="line">	<span class="keyword">interface</span> <span class="title class_">ens32</span></span><br><span class="line">	# 虚拟路由标识，同一个VRRP实例要使用同一个标识，主备机    </span><br><span class="line">	virtual_router_id <span class="number">80</span>    </span><br><span class="line">	# 因为当前环境中VRRP组播有问题，改为使用单播发送VRRP报文  如果VRRP组播没问题，以下这块的内容可以注释掉。  </span><br><span class="line">	# 这个地方需要关注，之前未做此设置，结果主备节点互相不能发现，因此主备节点都升级成了MASTER，并且绑定了VIP    </span><br><span class="line">	# 主节点时，内容为：    </span><br><span class="line">	unicast_src_ip <span class="number">192.168</span><span class="number">.122</span><span class="number">.134</span>  </span><br><span class="line">	# 设置优先级，确保主节点的优先级高过备用节点  </span><br><span class="line">	priority <span class="number">90</span>    </span><br><span class="line">	# 用于设定主备节点间同步检查时间间隔    </span><br><span class="line">	advert_int <span class="number">2</span>    </span><br><span class="line">	# 设置主备节点间的通信验证类型及密码，同一个VRRP实例中需一致    </span><br><span class="line">	authentication &#123;    </span><br><span class="line">		auth_type PASS    </span><br><span class="line">		auth_pass wolfcode</span><br><span class="line">	&#125;    </span><br><span class="line">	# 集群资源监控，组合vrrp_script进行    </span><br><span class="line">	track_script &#123;    </span><br><span class="line">		check_haproxy    </span><br><span class="line">	&#125;    </span><br><span class="line">	# 设置虚拟IP地址，当keepalived状态切换为MASTER时，此IP会自动添加到系统中    </span><br><span class="line">	# 当状态切换到BACKUP时，此IP会自动从系统中删除    </span><br><span class="line">	# 可以通过命令ip add查看切换后的状态    </span><br><span class="line">	virtual_ipaddress &#123;    </span><br><span class="line">		<span class="number">192.168</span><span class="number">.122</span><span class="number">.110</span>  #虚拟ip配置完之后就用它访问    </span><br><span class="line">	&#125;    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="关于我"><a class="markdownIt-Anchor" href="#关于我">#</a> 关于我</h2>
<p>Brath 是一个热爱技术的 Java 程序猿，公众号「InterviewCoder」定期分享有趣有料的精品原创文章！</p>
<p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/%E4%BA%8C%E7%BB%B4%E7%A0%81plus.png" alt="InterviewCoder"></p>
<p>非常感谢各位人才能看到这里，原创不易，文章如果有帮助可以关注、点赞、分享或评论，这都是对我的莫大支持！</p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2020-12-16T11:20:47.000Z" title="2020-12-16 19:20:47">2020-12-16</time>发表</span><span class="level-item"><time dateTime="2019-10-28T12:16:44.000Z" title="2019-10-28 20:16:44">2019-10-28</time>更新</span><span class="level-item">3 分钟读完 (大约493个字)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2020/12/16/%E3%80%90RocketMQ%E3%80%91Docker%E7%8E%AF%E5%A2%83%E4%B8%8B%E9%83%A8%E7%BD%B2RocketMQ%E4%BB%A5%E5%8F%8AConsole/">Docker环境下部署RocketMQ以及Console</a></p><div class="content"><p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/%E6%89%AB%E7%A0%81_%E6%90%9C%E7%B4%A2%E8%81%94%E5%90%88%E4%BC%A0%E6%92%AD%E6%A0%B7%E5%BC%8F-%E6%A0%87%E5%87%86%E8%89%B2%E7%89%88.png" alt="InterviewCoder"></p>
<h1 id="docker环境下部署rocketmq以及console"><a class="markdownIt-Anchor" href="#docker环境下部署rocketmq以及console">#</a> Docker 环境下部署 RocketMQ 以及 Console</h1>
<h2 id="1docker-安装rocketmq镜像"><a class="markdownIt-Anchor" href="#1docker-安装rocketmq镜像">#</a> 1.docker 安装 rocketmq 镜像</h2>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">#拉取镜像 </span><br><span class="line">docker pull foxiswho/rocketmq:server-4.7.0</span><br><span class="line">docker pull foxiswho/rocketmq:broker-4.7.0</span><br></pre></td></tr></table></figure>
<h2 id="2创建server和broker目录并在目录opt下创建brokerconf"><a class="markdownIt-Anchor" href="#2创建server和broker目录并在目录opt下创建brokerconf">#</a> 2. 创建 server 和 broker 目录，并在目录 /opt 下创建 broker.conf</h2>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">创建目录</span></span><br><span class="line">mkdir /opt/rocketmq-server</span><br><span class="line">mkdir /opt/rocketmq-broker/conf -p</span><br><span class="line">[root@localhost opt]# cat /opt/rocketmq-broker/conf/broker.conf </span><br><span class="line">namesrvAddr=【你的IP地址】:9876</span><br><span class="line">brokerClusterName = DefaultCluster</span><br><span class="line">brokerName = broker-a</span><br><span class="line">brokerId = 0</span><br><span class="line">deleteWhen = 04</span><br><span class="line">fileReservedTime = 48</span><br><span class="line">brokerRole = ASYNC_MASTER</span><br><span class="line">flushDiskType = ASYNC_FLUSH</span><br><span class="line">brokerIP1 = 【你的IP地址】</span><br><span class="line">listenPort=10911</span><br></pre></td></tr></table></figure>
<h2 id="3启动容器并在防火墙放行端口-9876-10911-11011"><a class="markdownIt-Anchor" href="#3启动容器并在防火墙放行端口-9876-10911-11011">#</a> 3. 启动容器并在防火墙放行端口 9876 、10911 、11011</h2>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">RocketMQ默认使用3个端口：9876 、10911 、11011</span><br><span class="line">如果防火墙没有关闭的话，那么防火墙就必须开放这些端口：</span><br><span class="line">nameserver 默认使用 9876 端口</span><br><span class="line">master 默认使用 10911 端口</span><br><span class="line">slave 默认使用11011 端口</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">启动rocketmq-server</span></span><br><span class="line">docker run -d \</span><br><span class="line">--restart=always \</span><br><span class="line">--name rmqnamesrv \</span><br><span class="line">-p 9876:9876 \</span><br><span class="line">-v /opt/rocketmq-server/logs:/root/logs \</span><br><span class="line">-v /opt/rocketmq-server/store:/root/store \</span><br><span class="line">-e &quot;MAX_POSSIBLE_HEAP=100000000&quot; \</span><br><span class="line">foxiswho/rocketmq:4.7.0 \</span><br><span class="line">sh mqnamesrv</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">启动rocketmq-broker</span></span><br><span class="line">docker run -d  \</span><br><span class="line">--restart=always \</span><br><span class="line">--name rmqbroker \</span><br><span class="line">--link rmqnamesrv:namesrv \</span><br><span class="line">-p 10911:10911 \</span><br><span class="line">-p 10909:10909 \</span><br><span class="line">-v  /opt/rocketmq-broker/logs:/root/logs \</span><br><span class="line">-v  /opt/rocketmq-broker/store:/root/store \</span><br><span class="line">-v /opt/rocketmq-broker/conf/broker.conf:/opt/rocketmq-broker/conf/broker.conf \</span><br><span class="line">-e &quot;NAMESRV_ADDR=【你的IP地址】:9876&quot; \</span><br><span class="line">-e &quot;MAX_POSSIBLE_HEAP=200000000&quot; \</span><br><span class="line">-e &quot;autoCreateTopicEnable=true&quot; \</span><br><span class="line">foxiswho/rocketmq:4.7.0 \</span><br><span class="line">sh mqbroker -c /opt/rocketmq-broker/conf/broker.conf</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">启动RocketMQ的管理工具rocketmq-console</span></span><br><span class="line">docker run -itd -e &quot;JAVA_OPTS=-Drocketmq.namesrv.addr=【你的IP地址】:9876 -Dcom.rocketmq.sendMessageWithVIPChannel=false&quot; -p 9877:8080 -t styletang/rocketmq-console-ng:latest</span><br></pre></td></tr></table></figure>
<h2 id="4测试访问console控制台"><a class="markdownIt-Anchor" href="#4测试访问console控制台">#</a> 4. 测试访问 console 控制台</h2>
<p>浏览器输入：192.168.1.200:9877</p>
<p><img src="https://brath.oss-cn-shanghai.aliyuncs.com/pigo/image-20230104082814121.png" alt="image-20230104082814121"></p>
<h2 id="关于我"><a class="markdownIt-Anchor" href="#关于我">#</a> 关于我</h2>
<p>Brath 是一个热爱技术的 Java 程序猿，公众号「InterviewCoder」定期分享有趣有料的精品原创文章！</p>
<p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/%E4%BA%8C%E7%BB%B4%E7%A0%81plus.png" alt="InterviewCoder"></p>
<p>非常感谢各位人才能看到这里，原创不易，文章如果有帮助可以关注、点赞、分享或评论，这都是对我的莫大支持！</p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2020-12-10T19:36:11.000Z" title="2020-12-11 3:36:11">2020-12-11</time>发表</span><span class="level-item"><time dateTime="2022-10-27T19:44:36.000Z" title="2022-10-28 3:44:36">2022-10-28</time>更新</span><span class="level-item">35 分钟读完 (大约5295个字)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2020/12/11/%E3%80%90Java%E3%80%91Elastic%20canal%E6%95%B0%E6%8D%AE%E5%90%8C%E6%AD%A5%E5%88%B0ES%E9%85%8D%E7%BD%AE%E5%B8%B8%E8%A7%81%E6%8A%A5%E9%94%99/">【Java】Elastic canal数据同步到ES配置常见报错</a></p><div class="content"><p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/%E6%89%AB%E7%A0%81_%E6%90%9C%E7%B4%A2%E8%81%94%E5%90%88%E4%BC%A0%E6%92%AD%E6%A0%B7%E5%BC%8F-%E6%A0%87%E5%87%86%E8%89%B2%E7%89%88.png" alt="InterviewCoder"></p>
<h1 id="javaelastic-canal数据同步到es配置常见报错"><a class="markdownIt-Anchor" href="#javaelastic-canal数据同步到es配置常见报错">#</a> 【Java】Elastic canal 数据同步到 ES 配置常见报错</h1>
<h1 id="0-引言"><a class="markdownIt-Anchor" href="#0-引言">#</a> 0. 引言</h1>
<p>所有报错均为博主在实操过程中遇到的错误和解决办法，如果有其他报错或者不同的解决办法，请留言告诉我</p>
<p>安装<a target="_blank" rel="noopener" href="https://so.csdn.net/so/search?q=canal&amp;spm=1001.2101.3001.7020"> canal</a> 过程中遇到问题，先在本文中查询是否有相同报错，将会为你节约大量排错时间</p>
<h2 id="环境"><a class="markdownIt-Anchor" href="#环境">#</a> 环境</h2>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">jdk1.8</span><br><span class="line">canal 1.1.5</span><br><span class="line">mysql8.0</span><br><span class="line">es7.13.0</span><br></pre></td></tr></table></figure>
<h1 id="1-unknown-system-variable-query_cache_size"><a class="markdownIt-Anchor" href="#1-unknown-system-variable-query_cache_size">#</a> 1. Unknown system variable ‘query_cache_size’</h1>
<p>这是因为<a target="_blank" rel="noopener" href="https://so.csdn.net/so/search?q=mysql%E9%A9%B1%E5%8A%A8&amp;spm=1001.2101.3001.7020"> mysql 驱动</a>包的版本过低导致的，query cache 在 MySQL5.7.20 就已经过时了，而在 MySQL8.0 之后就已经被移除了</p>
<p>1、只需要将 lib 中的驱动器替换成 mysql-connector-java-8.0.22.jar</p>
<p>2、修改驱动器权限</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">chmod 777 lib/mysql-connector-java-8.0.22.jar</span><br><span class="line">chmod +st lib/mysql-connector-java-8.0.22.jar</span><br></pre></td></tr></table></figure>
<p>查看权限如图所示</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ll lib</span><br></pre></td></tr></table></figure>
<p><img src="https://img-blog.csdnimg.cn/fb4993202deb4227a295dc8ffcfffafb.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAd3VfNTU1NTU=,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"></p>
<h1 id="2-reason-no-converter-found-capable-of-converting-from-type-javalangstring-to-type-javautilmapjavalangstring-javalangstring"><a class="markdownIt-Anchor" href="#2-reason-no-converter-found-capable-of-converting-from-type-javalangstring-to-type-javautilmapjavalangstring-javalangstring">#</a> 2. Reason: No converter found capable of converting from type [java.lang.String] to type [java.util.Map&lt;java.lang.String, java.lang.String&gt;]</h1>
<p>启动 canal-adapter 报错：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Failed to bind properties under &#x27;canal.conf.canal-adapters[0].groups[0].outer-adapters[1].properties&#x27; to java.util.Map&lt;java.lang.String, java.lang.String&gt;:</span><br><span class="line"></span><br><span class="line">    Reason: No converter found capable of converting from type [java.lang.String] to type [java.util.Map&lt;java.lang.String, java.lang.String&gt;]</span><br></pre></td></tr></table></figure>
<p>解决：<br>
观察报错信息可以得知是配置文件中的 outer2（0 基，所以 outer-adapter [1] 实际指的是 2）的 properties 配置有问题，我们观察配置文件，发现是 properties 下的 mode,cluster.name 等属性与 properties 同级了，将其如下图所示后退两字符即可。<br>
<img src="https://img-blog.csdnimg.cn/f5384eaf97234881bba9b3c8bcd663da.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAd3VfNTU1NTU=,size_20,color_FFFFFF,t_70,g_se,x_16" alt="配置"></p>
<h1 id="3-runtimeexception-javalangruntimeexception-no-data-source-found-xxxx"><a class="markdownIt-Anchor" href="#3-runtimeexception-javalangruntimeexception-no-data-source-found-xxxx">#</a> 3. RuntimeException: java.lang.RuntimeException: No data source found: xxxx</h1>
<p>这个因为在 conf/es/xxx.yml 中配置的 dataSourceKey 并没有在 conf/application.yml 中的 srcDataSources 中维护</p>
<p>如下图所示，es 中的 dataSourceKey 需要在 applicaiton.yml 中设置，默认是 defaultDS<br>
<img src="https://img-blog.csdnimg.cn/14dacccf628d44e7b6f67c52bccdb93e.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAd3VfNTU1NTU=,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"><br>
<img src="https://img-blog.csdnimg.cn/5e57dd86bcb8417e9e7eda2a6d014956.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAd3VfNTU1NTU=,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"></p>
<h1 id="4-reason-unable-to-set-value-for-property-src-data-sources"><a class="markdownIt-Anchor" href="#4-reason-unable-to-set-value-for-property-src-data-sources">#</a> 4. Reason: Unable to set value for property src-data-sources</h1>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Failed to bind properties under &#x27;canal.conf&#x27; to com.alibaba.otter.canal.adapter.launcher.config.AdapterCanalConfig:</span><br><span class="line"></span><br><span class="line">    Reason: Unable to set value for property src-data-sources</span><br></pre></td></tr></table></figure>
<p>原因一：<br>
mysql 驱动器导致的问题，使用的数据库是 8.x。驱动器是 5.x 的，将 mysql 驱动替换为 8.0.x 版本的。如上所示报错 1</p>
<p>原因二：<br>
检查该报错前的日志，是否有其他相关报错信息，比如无相关数据库，如下所示，根据其报错内容来检查配置项并且调整即可<br>
<img src="https://img-blog.csdnimg.cn/fbf719ab834648f9adfa37c65e402d71.png" alt="在这里插入图片描述"></p>
<h1 id="5-javasqlsqlexception-null-message-from-server-host-172161882-is-blocked-because-of-many-connection-errors-unblock-with-mysqladmin-flush-hosts"><a class="markdownIt-Anchor" href="#5-javasqlsqlexception-null-message-from-server-host-172161882-is-blocked-because-of-many-connection-errors-unblock-with-mysqladmin-flush-hosts">#</a> 5. java.sql.SQLException: null, message from server: “Host ‘172.16.188.2’ is blocked because of many connection errors; unblock with ‘mysqladmin flush-hosts’”</h1>
<p>同一个 ip 在短时间内产生太多中断的数据库连接而导致的阻塞</p>
<p>登录对应的 mysql，执行如下指令</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">flush hosts;</span><br></pre></td></tr></table></figure>
<h1 id="6-illegalstateexception-extension-instancename-es7-class-interface-comalibabaottercanalclientadapterouteradapter-could-not-be-instantiated-class-could-not-be-found"><a class="markdownIt-Anchor" href="#6-illegalstateexception-extension-instancename-es7-class-interface-comalibabaottercanalclientadapterouteradapter-could-not-be-instantiated-class-could-not-be-found">#</a> 6. IllegalStateException: Extension instance(name: es7, class: interface com.alibaba.otter.canal.client.adapter.OuterAdapter) could not be instantiated: class could not be found</h1>
<p>一般 <code> could not be instantiated: class could not be found</code>  这样的报错是配置文件的问题，如上的报错可以看到是 name: es7 中的错误，在官方的示例文档中使用的是 <code>name: es6 # or es7</code> 。</p>
<p>在 canal1.1.5 + 版本中设置的是 name: es6 # 或者 es7</p>
<p>但在 1.1.4 版本中直接使用 <code>name: es</code>  即可</p>
<h1 id="7-illegalargumentexception-not-found-the-mapping-info-of-index-user"><a class="markdownIt-Anchor" href="#7-illegalargumentexception-not-found-the-mapping-info-of-index-user">#</a> 7. IllegalArgumentException: Not found the mapping info of index: user</h1>
<p>1、这个报错是 ES 的 mapping 设置的问题，确保 es 中有该索引，并且确认是否有部分字段没有在 es 中设置 mapping, 这个要对应之前设置的 sql，以及 es 中的 mappings 来解决</p>
<p>2、使用了 elasticsearch 7.x，但 adapter1.1.4 默认支持 es6.x<br>
 解决方案：<br>
（1）修改 adapter 源码，将 es 依赖调整为 7.x；参考博客<a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/355162399"> adapter1.1.4 修改源码支持 es7.x</a><br>
（2）换成 adapter1.1.5</p>
<h1 id="8-illegalargumentexception-illegal-character-in-scheme-name-at-index-0-1721618879200"><a class="markdownIt-Anchor" href="#8-illegalargumentexception-illegal-character-in-scheme-name-at-index-0-1721618879200">#</a> 8. IllegalArgumentException: Illegal character in scheme name at index 0: 172.16.188.7:9200</h1>
<p>如果连接 es 使用的是 rest 方式，那么 hosts 中的 ip 前要添加 <code>http://</code> ，如</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hosts: http://172.16.188.7:9200</span><br></pre></td></tr></table></figure>
<h1 id="9-comalibabadruidpooldruiddatasource-cannot-be-cast-to-comalibabadruidpooldruiddatasource"><a class="markdownIt-Anchor" href="#9-comalibabadruidpooldruiddatasource-cannot-be-cast-to-comalibabadruidpooldruiddatasource">#</a> 9. com.alibaba.druid.pool.DruidDataSource cannot be cast to com.alibaba.druid.pool.DruidDataSource</h1>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">java.lang.RuntimeException: java.lang.RuntimeException: java.lang.ClassCastException: com.alibaba.druid.pool.DruidDataSource cannot be cast to com.alibaba.druid.pool.DruidDataSource</span><br><span class="line">	at com.alibaba.otter.canal.client.adapter.es7x.ES7xAdapter.init(ES7xAdapter.java:54) ~[client-adapter.es7x-1.1.5-jar-with-dependencies.jar:na]</span><br><span class="line">	at com.alibaba.otter.canal.adapter.launcher.loader.CanalAdapterLoader.loadAdapter(CanalAdapterLoader.java:225) [client-adapter.launcher-1.1.5.jar:na]</span><br><span class="line">	at com.alibaba.otter.canal.adapter.launcher.loader.CanalAdapterLoader.init(CanalAdapterLoader.java:56) [client-adapter.launcher-1.1.5.jar:na]</span><br><span class="line">	at com.alibaba.otter.canal.adapter.launcher.loader.CanalAdapterService.init(CanalAdapterService.java:60) [client-adapter.launcher-1.1.5.jar:na]</span><br><span class="line">	at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method) ~[na:1.8.0_271]</span><br><span class="line">	at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62) ~[na:1.8.0_271]</span><br><span class="line">	at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43) ~[na:1.8.0_271]</span><br><span class="line">	at java.lang.reflect.Method.invoke(Method.java:498) ~[na:1.8.0_271]</span><br></pre></td></tr></table></figure>
<p>原因：<br>
druid 包冲突<br>
解决：<br>
1、修改 client-adapter/escore/pom.xml</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;com.alibaba&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;druid&lt;/artifactId&gt;</span><br><span class="line">            &lt;!--add by whx 20220112--&gt;</span><br><span class="line">            &lt;scope&gt;provided&lt;/scope&gt;</span><br><span class="line"> &lt;/dependency&gt;</span><br></pre></td></tr></table></figure>
<p>2、重新打包<br>
<img src="https://img-blog.csdnimg.cn/dfe52cef447444469af1020bf5328ef5.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAd3VfNTU1NTU=,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"><br>
 3、将 client-adapter/es7x/target/client-adapter.es7x-1.1.5-jar-with-dependencies.jar 上传到服务器，替换 adataper/plugin 下的同名 jar 文件<br>
<img src="https://img-blog.csdnimg.cn/eb3b4b46f8ab47d391244904ecb6e89e.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAd3VfNTU1NTU=,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">scp client-adapter.es7x-1.1.5-jar-with-dependencies.jar root@172.16.188.2:/var/local</span><br></pre></td></tr></table></figure>
<p>4、给该文件赋权</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chmod 777 /var/local/client-adapter.es7x-1.1.5-jar-with-dependencies.jar </span><br></pre></td></tr></table></figure>
<p>5、重启服务</p>
<h4 id="10-canalparseexception-javaioioexception-eof-encountered"><a class="markdownIt-Anchor" href="#10-canalparseexception-javaioioexception-eof-encountered">#</a> 10 CanalParseException: java.io.IOException: EOF encountered</h4>
<p>将 lib 目录下的 mysql 驱动器替换为<a target="_blank" rel="noopener" href="https://so.csdn.net/so/search?q=mysql8&amp;spm=1001.2101.3001.7020"> mysql8</a>.0，并附权。参考上述</p>
<h1 id="11-canalclientexception-javaioioexception-broken-pipe-error-sync-but-ack"><a class="markdownIt-Anchor" href="#11-canalclientexception-javaioioexception-broken-pipe-error-sync-but-ack">#</a> 11. CanalClientException: java.io.IOException: Broken pipe Error sync but ACK</h1>
<p>服务连接断开了，将 deployer 和 adapter 都关闭，先启动 deployer 再启动 adapter</p>
<h1 id="12-documentmissingexception_doc1413298413755211778-document-missing"><a class="markdownIt-Anchor" href="#12-documentmissingexception_doc1413298413755211778-document-missing">#</a> 12. DocumentMissingException[[_doc][1413298413755211778]: document missing]</h1>
<p>1、es 集群出现问题，导致 doc 无法分配。常见的是分片数的问题，可能是副本分片过多，导致集群报黄<br>
解决：<br>
因为我的是 es 单节点，所以将主分片数设置为 1，副本分片设置为 0。不申明的话默认创建副本分片数为 1</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">PUT user</span><br><span class="line">&#123;</span><br><span class="line">  &quot;mappings&quot;: &#123;</span><br><span class="line">    &quot;properties&quot;: &#123;</span><br><span class="line">      &quot;code&quot;: &#123;</span><br><span class="line">        &quot;type&quot;: &quot;keyword&quot;</span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;email&quot;: &#123;</span><br><span class="line">        &quot;type&quot;: &quot;text&quot;,</span><br><span class="line">        &quot;fields&quot;: &#123;</span><br><span class="line">          &quot;keyword&quot;: &#123;</span><br><span class="line">            &quot;type&quot;: &quot;keyword&quot;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;realName&quot;: &#123;</span><br><span class="line">        &quot;type&quot;: &quot;text&quot;,</span><br><span class="line">        &quot;analyzer&quot;: &quot;ik_smart&quot;,</span><br><span class="line">        &quot;fields&quot;: &#123;</span><br><span class="line">          &quot;keyword&quot;: &#123;</span><br><span class="line">            &quot;type&quot;: &quot;keyword&quot;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;roleId&quot;: &#123;</span><br><span class="line">        &quot;type&quot;: &quot;text&quot;,</span><br><span class="line">        &quot;fields&quot;: &#123;</span><br><span class="line">          &quot;keyword&quot;: &#123;</span><br><span class="line">            &quot;type&quot;: &quot;keyword&quot;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;postId&quot;: &#123;</span><br><span class="line">        &quot;type&quot;: &quot;text&quot;,</span><br><span class="line">        &quot;fields&quot;: &#123;</span><br><span class="line">          &quot;keyword&quot;: &#123;</span><br><span class="line">            &quot;type&quot;: &quot;keyword&quot;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;deptId&quot;: &#123;</span><br><span class="line">        &quot;type&quot;: &quot;text&quot;,</span><br><span class="line">        &quot;fields&quot;: &#123;</span><br><span class="line">          &quot;keyword&quot;: &#123;</span><br><span class="line">            &quot;type&quot;: &quot;keyword&quot;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;settings&quot;: &#123;</span><br><span class="line">    &quot;number_of_replicas&quot;: 0,</span><br><span class="line">    &quot;number_of_shards&quot;: 1</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>2、修改的 mysql 数据库数据，在 es 中不存在。先进行全量同步，再进行增量同步</p>
<p>在 conf/example/instance.properties 中修改</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># 全量同步</span><br><span class="line">canal.instance.master.journal.name=mysql-bin.000001</span><br><span class="line">canal.instance.master.position=0</span><br><span class="line">#2019-01-01 00:00:00 上一次更新的时间</span><br><span class="line">canal.instance.master.timestamp=1546272000000</span><br></pre></td></tr></table></figure>
<h1 id="13-error-caottercanalservernettyhandlersessionhandler-something-goes-wrong-with-channelid-0x23d9cad9-12700146472-12700111111-exceptionjavaniochannelsclosedchannelexception"><a class="markdownIt-Anchor" href="#13-error-caottercanalservernettyhandlersessionhandler-something-goes-wrong-with-channelid-0x23d9cad9-12700146472-12700111111-exceptionjavaniochannelsclosedchannelexception">#</a> 13. ERROR c.a.otter.canal.server.netty.handler.SessionHandler - something goes wrong with channel:[id: 0x23d9cad9, /127.0.0.1:46472 :&gt; /127.0.0.1:11111], exception=java.nio.channels.ClosedChannelException</h1>
<p>这是由于 deployer 中的 conf/example/meta.dat 与 instance.properties 文件中的 journalName,position,timestamp 不一致导致的</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"># 查询bin log位置</span><br><span class="line">show master status;</span><br><span class="line"># 如果显示的binlog不为000001可以执行以下语句重置binlog（轻易别操作，最好让专业的运维人员操作）</span><br><span class="line"># 该操作会重新生成binlog，之前的binlog就会清空，之前的数据就不会再同步</span><br><span class="line">reset master;</span><br><span class="line"># 刷新log日志，自此刻开始产生一个新编号的binlog日志文件</span><br><span class="line">flush logs;</span><br></pre></td></tr></table></figure>
<p><img src="https://img-blog.csdnimg.cn/849d7b41b8c348dead0670db96717068.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAd3VfNTU1NTU=,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"><br>
将 meta.dat 删除或者修改一致即可。删除后将会按照 instance.properties 中设置的起点同步，生产环境考虑好需要后再删除。</p>
<p>如果想要将之前的数据也同步的话，可以将数据库先导出，再重新导入一遍，即可重新生成 binlog，实现数据的全量同步</p>
<h1 id="14-received-error-packet-errno-1236-sqlstate-hy000-errmsg-could-not-find-first-log-file-name-in-binary-log-index-file"><a class="markdownIt-Anchor" href="#14-received-error-packet-errno-1236-sqlstate-hy000-errmsg-could-not-find-first-log-file-name-in-binary-log-index-file">#</a> 14. Received error packet: errno = 1236, sqlstate = HY000 errmsg = Could not find first log file name in binary log index file</h1>
<p>mysql bin log 数据不同步，刷新一下即可</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">flush logs;</span><br></pre></td></tr></table></figure>
<h1 id="15-binlog也设置为000001了timestamp也设置了但就是无法实现全量同步"><a class="markdownIt-Anchor" href="#15-binlog也设置为000001了timestamp也设置了但就是无法实现全量同步">#</a> 15. binlog 也设置为 000001 了，timestamp 也设置了，但就是无法实现全量同步</h1>
<p>1、删除 conf/example/meta.dat<br>
2、调整 conf/example/instance.properties</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">canal.instance.master.journal.name=mysql-bin.000001</span><br><span class="line">canal.instance.master.position=0</span><br><span class="line">#2019-01-01 00:00:00 上一次更新的时间</span><br><span class="line">canal.instance.master.timestamp=1546272000000</span><br></pre></td></tr></table></figure>
<p>3、重启 deployer</p>
<p>另外需要注意的是如果 bin log 是只会记录增量操作的，也就是说开启 bin log 之前的历史数据是不会记录的，如果需要同步者之前的数据，解决这个问题有三个办法：<br>
（1）<a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_24950043/article/details/122483061">通过 logstash-input-jdbc 来实现</a><br>
（2）通过业务代码来实现（后续会详细讲解这两种方式，可以关注我后续的博客）<br>
（3）复制原数据库数据到开启了 binlog 的从数据库，然后从从数据库同步</p>
<h1 id="16-adapter启动报错something-goes-wrong-when-starting-up-the-canal-client-adapters-javalangnullpointerexception-null"><a class="markdownIt-Anchor" href="#16-adapter启动报错something-goes-wrong-when-starting-up-the-canal-client-adapters-javalangnullpointerexception-null">#</a> 16. adapter 启动报错：something goes wrong when starting up the canal client adapters: java.lang.NullPointerException: null</h1>
<p>这个报错是空指针报错，很明显是哪里获取为空的，这种错误没有固定的原因，但大概率上可以锁定配置文件的问题</p>
<p>1、adapter 的配置文件中是有包含了 mysql、es、mq、zk 等配置，如果不需要的配置项，就将其注释掉，不要打开</p>
<p>比如我这里的报错原因就是因为打开了 zookeeperHosts，但是没有配置具体值，所以导致了空指针，因为我不需要 zk，将其注释掉即可</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># flatMessage: true</span><br><span class="line"># zookeeperHosts:</span><br></pre></td></tr></table></figure>
<p>2、某些必要的配置没有设置，快速排查的方式就是根据官方文档中给出的配置文件对比排错<br>
可以参考如下配置文件</p>
<p>3、配置文件中配置项排版错位</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line">server:</span><br><span class="line">  port: 8081</span><br><span class="line">spring:</span><br><span class="line">  jackson:</span><br><span class="line">    date-format: yyyy-MM-dd HH:mm:ss</span><br><span class="line">    time-zone: GMT+8</span><br><span class="line">    default-property-inclusion: non_null</span><br><span class="line"></span><br><span class="line">canal.conf:</span><br><span class="line">  mode: tcp #tcp kafka rocketMQ rabbitMQ</span><br><span class="line">  flatMessage: true</span><br><span class="line">  zookeeperHosts:</span><br><span class="line">  syncBatchSize: 1000</span><br><span class="line">  retries: 0</span><br><span class="line">  timeout:</span><br><span class="line">  accessKey:</span><br><span class="line">  secretKey:</span><br><span class="line">  consumerProperties:</span><br><span class="line">    # canal tcp consumer</span><br><span class="line">    canal.tcp.server.host: 127.0.0.1:11111</span><br><span class="line">    canal.tcp.zookeeper.hosts:</span><br><span class="line">    canal.tcp.batch.size: 500</span><br><span class="line">    canal.tcp.username:</span><br><span class="line">    canal.tcp.password:</span><br><span class="line">    # kafka consumer</span><br><span class="line">    kafka.bootstrap.servers: 127.0.0.1:9092</span><br><span class="line">    kafka.enable.auto.commit: false</span><br><span class="line">    kafka.auto.commit.interval.ms: 1000</span><br><span class="line">    kafka.auto.offset.reset: latest</span><br><span class="line">    kafka.request.timeout.ms: 40000</span><br><span class="line">    kafka.session.timeout.ms: 30000</span><br><span class="line">    kafka.isolation.level: read_committed</span><br><span class="line">    kafka.max.poll.records: 1000</span><br><span class="line">    # rocketMQ consumer</span><br><span class="line">    rocketmq.namespace:</span><br><span class="line">    rocketmq.namesrv.addr: 127.0.0.1:9876</span><br><span class="line">    rocketmq.batch.size: 1000</span><br><span class="line">    rocketmq.enable.message.trace: false</span><br><span class="line">    rocketmq.customized.trace.topic:</span><br><span class="line">    rocketmq.access.channel:</span><br><span class="line">    rocketmq.subscribe.filter:</span><br><span class="line">    # rabbitMQ consumer</span><br><span class="line">    rabbitmq.host:</span><br><span class="line">    rabbitmq.virtual.host:</span><br><span class="line">    rabbitmq.username:</span><br><span class="line">    rabbitmq.password:</span><br><span class="line">    rabbitmq.resource.ownerId:</span><br><span class="line">  srcDataSources:</span><br><span class="line">    defaultDS:</span><br><span class="line">      url: jdbc:mysql://172.16.188.1:3306/bladex?useUnicode=true</span><br><span class="line">      #driverClassName: com.mysql.cj.jdbc.Driver</span><br><span class="line">      username: root</span><br><span class="line">      password: 123456</span><br><span class="line">  canalAdapters:</span><br><span class="line">  - instance: example # canal instance Name or mq topic name</span><br><span class="line">    groups:</span><br><span class="line">    - groupId: g1</span><br><span class="line">      outerAdapters:</span><br><span class="line">      - name: logger</span><br><span class="line">      - </span><br><span class="line">        key: esKey</span><br><span class="line">        name: es7 # es6 or es7</span><br><span class="line">        hosts: http://172.16.188.7:9200 # 集群地址，逗号隔开. 127.0.0.1:9200 for rest mode or 127.0.0.1:9300 for transport mode</span><br><span class="line">        properties:</span><br><span class="line">          mode: rest #  rest or transport </span><br><span class="line">          # security.auth: test:123456 #  only used for rest mode</span><br><span class="line">          cluster.name: cluster1</span><br></pre></td></tr></table></figure>
<h1 id="17-field-error-in-object-target-on-field-esmapping-rejected-value"><a class="markdownIt-Anchor" href="#17-field-error-in-object-target-on-field-esmapping-rejected-value">#</a> 17 Field error in object ‘target’ on field ‘esMapping’: rejected value [];</h1>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Field error in object &#x27;target&#x27; on field &#x27;esMapping&#x27;: rejected value []; codes </span><br><span class="line">[typeMismatch.target.esMapping,typeMismatch.esMapping,typeMismatch.com.alibaba.otter.canal.client.adapter.es.core.config.ESSyncConfig$ESMapping,typeMismatch]; </span><br><span class="line">arguments [org.springframework.context.support.DefaultMessageSourceResolvable: codes [target.esMapping,esMapping]; arguments []; default message [esMapping]]; default message [Failed to convert property value of type &#x27;java.lang.String&#x27; to required type </span><br><span class="line">&#x27;com.alibaba.otter.canal.client.adapter.es.core.config.ESSyncConfig$ESMapping&#x27; for property &#x27;esMapping&#x27;; nested </span><br><span class="line">exception is java.lang.IllegalStateException: Cannot convert value of type &#x27;java.lang.String&#x27; to required type</span><br><span class="line"> &#x27;com.alibaba.otter.canal.client.adapter.es.core.config.ESSyncConfig$ESMapping&#x27; for property &#x27;esMapping&#x27;: no </span><br><span class="line"> matching editors or conversion strategy found]</span><br></pre></td></tr></table></figure>
<p>这是配置文件问题，检查 es 下的配置 yml 文件，特别是 sql 语句的语法是否有问题</p>
<h1 id="18-javautilnosuchelementexception"><a class="markdownIt-Anchor" href="#18-javautilnosuchelementexception">#</a> 18 java.util.NoSuchElementException</h1>
<p>没有找到对应字段导致</p>
<p>检查下 canal 配置文件中的字段是否在 es mapping 中有对应的，大小写是否一致，是否有遗漏</p>
<p>因为我的操作是 mysql 同步至 es，所以这里说明几项容易出错的地方：<br>
1、canal 配置文件中的 sql 中是否大小写一致，canal 是区分大小写的<br>
 2、sql 中设置的别名是否与 es mappings 中的名称一致，允许 es 中的部分字段为空，但是不允许 sql 中查询出来的字段在 es mappings 中找不到对应的字段<br>
 3、canal 配置文件中的 dataSourceKey 是否正确，其对应到 canal application.yml 配置文件中的数据库是否正确</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dataSourceKey: aaa</span><br></pre></td></tr></table></figure>
<p>application.yml</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">srcDataSources:</span><br><span class="line">    aaa: # 与之对应</span><br><span class="line">      url: jdbc:mysql://192.168.244.1:3306/aaa?useUnicode=true</span><br><span class="line">      #driverClassName: com.mysql.cj.jdbc.Driver</span><br><span class="line">      username: root</span><br><span class="line">      password: 123456</span><br><span class="line">    xxx:</span><br><span class="line">      url: jdbc:mysql://192.168.244.1:3306/xxx?useUnicode=true</span><br><span class="line">      username: root</span><br><span class="line">      password: 123456</span><br><span class="line">    yyy:</span><br><span class="line">      url: jdbc:mysql://192.168.244.1:3306/yyy?useUnicode=true</span><br><span class="line">      username: root</span><br><span class="line">      password: 123456</span><br></pre></td></tr></table></figure>
<p>4、canal 配置文件中的排版是否正确，特别注意_index,_type 等属性要放在 esMappings 下</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">dataSourceKey: aaa # 这里的key与上述application.yml中配置的数据源保持一致</span><br><span class="line">outerAdapterKey: esKey # 与上述application.yml中配置的outerAdapters.key一直</span><br><span class="line">destination: example # 默认为example,与application.yml中配置的instance保持一致</span><br><span class="line">groupId:</span><br><span class="line">esMapping:</span><br><span class="line">  _index: dept </span><br><span class="line">  _type: _doc</span><br><span class="line">  _id: _id</span><br><span class="line">  sql: &quot;select</span><br><span class="line">        t.id,</span><br><span class="line">        t.id as _id,</span><br><span class="line">        t.dept_name as deptName,</span><br><span class="line">        t.dept_category as deptCategory,</span><br><span class="line">        t.parent_id as parentId,</span><br><span class="line">        t.ancestors as ancestors,</span><br><span class="line">        t.third_party_id as thirdPartyId,</span><br><span class="line">        t.phone as phone,</span><br><span class="line">        t.address as address,</span><br><span class="line">        t.is_deleted as isDeleted</span><br><span class="line">      from</span><br><span class="line">         dept t&quot;</span><br><span class="line">  #etlCondition: &quot;where t.update_time&gt;=&#x27;&#123;0&#125;&#x27;&quot;</span><br><span class="line">  commitBatch: 3000</span><br></pre></td></tr></table></figure>
<p>5、sql 查询出来的字段类型与 es mappings 中的字段数据类型是否一致</p>
<p>6、多表同步到同一个索引时，如果都有同一个常量列且值不同时会报错。<br>
如下所示的两个配置文件都有 userSource 常量列用于区分不同的数据来源，但是如下的配置会报错。<br>
xxx.yml</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">dataSourceKey: aaa # 这里的key与上述application.yml中配置的数据源保持一致</span><br><span class="line">outerAdapterKey: esKey # 与上述application.yml中配置的outerAdapters.key一直</span><br><span class="line">destination: example # 默认为example,与application.yml中配置的instance保持一致</span><br><span class="line">groupId:</span><br><span class="line">esMapping:</span><br><span class="line">  _index: user</span><br><span class="line">  _type: _doc</span><br><span class="line">  _id: _id</span><br><span class="line">  sql: &quot;select</span><br><span class="line">        t.id, </span><br><span class="line">        0 as userSource, </span><br><span class="line">      from</span><br><span class="line">         user t&quot; </span><br><span class="line">  commitBatch: 3000</span><br></pre></td></tr></table></figure>
<p>yyy.yml</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">dataSourceKey: aaa # 这里的key与上述application.yml中配置的数据源保持一致</span><br><span class="line">outerAdapterKey: esKey # 与上述application.yml中配置的outerAdapters.key一直</span><br><span class="line">destination: example # 默认为example,与application.yml中配置的instance保持一致</span><br><span class="line">groupId:</span><br><span class="line">esMapping:</span><br><span class="line">  _index: user</span><br><span class="line">  _type: _doc</span><br><span class="line">  _id: _id</span><br><span class="line">  sql: &quot;select</span><br><span class="line">        t.id, </span><br><span class="line">        1 as userSource, </span><br><span class="line">      from</span><br><span class="line">         user_wx t&quot; </span><br><span class="line">  commitBatch: 3000</span><br></pre></td></tr></table></figure>
<h1 id="19-adapter日志中没有报错但是没有读取binlog-could-not-find-first-log-file-name-in-binary-log-index-file"><a class="markdownIt-Anchor" href="#19-adapter日志中没有报错但是没有读取binlog-could-not-find-first-log-file-name-in-binary-log-index-file">#</a> 19. adapter 日志中没有报错，但是没有读取 binlog ｜ Could not find first log file name in binary log index file</h1>
<p>adapter 日志中没有报错信息，于是去查看 deployer 日志，这里的 example 是你配置的实例</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat logs/example/example.log</span><br></pre></td></tr></table></figure>
<p>会发现报错：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Could not find first log file name in binary log index file</span><br></pre></td></tr></table></figure>
<p>解决：<br>
1、既然问题是没有找到数据库的 binglog 文件位置，那么就查看一下现在的 binlog 文件位置，登陆 mysql 执行</p>
<p>2.1 如果你是做增量同步，那么查询当前 binlog 位置</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">show master status;</span><br></pre></td></tr></table></figure>
<p><img src="https://img-blog.csdnimg.cn/5a1f009e008d4b4281589f580bef9192.png" alt="在这里插入图片描述"><br>
修改 conf/example/instance.properties 文件</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">canal.instance.master.address=192.168.244.17:3306</span><br><span class="line"># 这里的文件名要与上面的保持一致，我这里就是文件名不一致，写成了mysql-bin.000001</span><br><span class="line">canal.instance.master.journal.name=binlog.000003 </span><br><span class="line">canal.instance.master.position=5921</span><br><span class="line">canal.instance.master.timestamp=</span><br><span class="line">canal.instance.master.gtid=</span><br></pre></td></tr></table></figure>
<p>2.2 如果你要做全量同步，查询 binlog 文件</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">show binary logs;</span><br></pre></td></tr></table></figure>
<p><img src="https://img-blog.csdnimg.cn/b4736c68b0f64b80bb509d395a627fb1.png" alt="在这里插入图片描述"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">canal.instance.master.address=192.168.244.17:3306</span><br><span class="line"># 这里的文件名要与上面的保持一致，我这里就是文件名不一致，写成了mysql-bin.000001</span><br><span class="line">canal.instance.master.journal.name=binlog.000001</span><br><span class="line"># 位置从0开始</span><br><span class="line">canal.instance.master.position=0</span><br><span class="line">canal.instance.master.timestamp=</span><br><span class="line">canal.instance.master.gtid=</span><br></pre></td></tr></table></figure>
<p>3、重启 deployer 和 adapter</p>
<h1 id="20-error-caottercanaladapterlauncherloaderadapterprocessor-javalangnullpointerexception"><a class="markdownIt-Anchor" href="#20-error-caottercanaladapterlauncherloaderadapterprocessor-javalangnullpointerexception">#</a> 20. ERROR c.a.otter.canal.adapter.launcher.loader.AdapterProcessor - java.lang.NullPointerException</h1>
<p>启动 adapter 报错：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">2022-05-21 06:28:44.444 [pool-2-thread-1] ERROR c.a.otter.canal.adapter.launcher.loader.AdapterProcessor - java.lang.NullPointerException</span><br><span class="line">java.lang.RuntimeException: java.lang.NullPointerException</span><br><span class="line">        at com.alibaba.otter.canal.client.adapter.es.core.service.ESSyncService.sync(ESSyncService.java:116) ~[na:na]</span><br><span class="line">        at com.alibaba.otter.canal.client.adapter.es.core.service.ESSyncService.sync(ESSyncService.java:64) ~[na:na]</span><br><span class="line">        at com.alibaba.otter.canal.client.adapter.es.core.ESAdapter.sync(ESAdapter.java:115) ~[na:na]</span><br><span class="line">        at com.alibaba.otter.canal.client.adapter.es.core.ESAdapter.sync(ESAdapter.java:94) ~[na:na]</span><br><span class="line">        at com.alibaba.otter.canal.adapter.launcher.loader.AdapterProcessor.batchSync(AdapterProcessor.java:139) ~[client-adapter.launcher-1.1.5.jar:na]</span><br><span class="line">        at com.alibaba.otter.canal.adapter.launcher.loader.AdapterProcessor.lambda$null$1(AdapterProcessor.java:97) ~[client-adapter.launcher-1.1.5.jar:na]</span><br><span class="line">        at java.util.concurrent.CopyOnWriteArrayList.forEach(CopyOnWriteArrayList.java:895) ~[na:1.8.0_312]</span><br><span class="line">        at com.alibaba.otter.canal.adapter.launcher.loader.AdapterProcessor.lambda$null$2(AdapterProcessor.java:94) ~[client-adapter.launcher-1.1.5.jar:na]</span><br><span class="line">        at java.util.concurrent.FutureTask.run(FutureTask.java:266) ~[na:1.8.0_312]</span><br><span class="line">        at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149) ~[na:1.8.0_312]</span><br><span class="line">        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624) ~[na:1.8.0_312]</span><br><span class="line">        at java.lang.Thread.run(Thread.java:748) ~[na:1.8.0_312]</span><br><span class="line">Caused by: java.lang.NullPointerException: null</span><br><span class="line">        at com.alibaba.otter.canal.client.adapter.es7x.support.ES7xTemplate.insert(ES7xTemplate.java:79) ~[na:na]</span><br><span class="line">        at com.alibaba.otter.canal.client.adapter.es.core.service.ESSyncService.singleTableSimpleFiledInsert(ESSyncService.java:448) ~[na:na]</span><br><span class="line">        at com.alibaba.otter.canal.client.adapter.es.core.service.ESSyncService.insert(ESSyncService.java:139) ~[na:na]</span><br><span class="line">        at com.alibaba.otter.canal.client.adapter.es.core.service.ESSyncService.sync(ESSyncService.java:99) ~[na:na]</span><br><span class="line">        ... 11 common frames omitted</span><br><span class="line">2022-05-21 06:28:44.449 [Thread-4] ERROR c.a.otter.canal.adapter.launcher.loader.AdapterProcessor - Outer adapter sync failed!  Error sync but ACK!</span><br></pre></td></tr></table></figure>
<p>解决：<br>
1、修改 adapter/application.yml，给 outerAdapters 配置一个 key，注意这里如果有多个 adapter 实例，那么就配置不同的 key</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">canalAdapters:</span><br><span class="line">  - instance: test # canal instance Name or mq topic name</span><br><span class="line">    groups:</span><br><span class="line">    - groupId: g2</span><br><span class="line">      outerAdapters:</span><br><span class="line">#      - name: logger</span><br><span class="line">      - </span><br><span class="line">        key: esKey3 # 配置key</span><br><span class="line">        name: es7 # es6 or es7</span><br><span class="line">        #hosts: http://192.168.101.11:9200 # 集群地址，逗号隔开. 127.0.0.1:9200 for rest mode or 127.0.0.1:9300 for transport mode</span><br><span class="line">        hosts: http://192.168.244.11:9200 # 集群地址，逗号隔开. 127.0.0.1:9200 for rest mode or 127.0.0.1:9300 for transport mode</span><br><span class="line">        properties:</span><br><span class="line">          mode: rest #  rest or transport </span><br><span class="line">          security.auth: elastic:elastic #  only used for rest mode</span><br><span class="line">          cluster.name: blade-cluster</span><br></pre></td></tr></table></figure>
<h1 id="21-canalparseexception-parse-row-data-failed-column-size-is-not-match-for-table"><a class="markdownIt-Anchor" href="#21-canalparseexception-parse-row-data-failed-column-size-is-not-match-for-table">#</a> 21. CanalParseException: parse row data failed. | column size is not match for table</h1>
<p>deployser 日志报错：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">2022-05-21 07:45:15.651 [MultiStageCoprocessor-Parser-fleet-0] ERROR com.alibaba.otter.canal.common.utils.NamedThreadFactory - from MultiStageCoprocessor-Parser-fleet-0</span><br><span class="line">com.alibaba.otter.canal.parse.exception.CanalParseException: com.alibaba.otter.canal.parse.exception.CanalParseException: com.alibaba.otter.canal.parse.exception.CanalParseException: parse row data failed.</span><br><span class="line">Caused by: com.alibaba.otter.canal.parse.exception.CanalParseException: com.alibaba.otter.canal.parse.exception.CanalParseException: parse row data failed.</span><br><span class="line">Caused by: com.alibaba.otter.canal.parse.exception.CanalParseException: parse row data failed.</span><br><span class="line">Caused by: com.alibaba.otter.canal.parse.exception.CanalParseException: column size is not match for table:fleet.source_project_cargo,9 vs 8</span><br></pre></td></tr></table></figure>
<p>解决：<br>
1、可以看到报错中已经给出明确提示了</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">column size is not match for table:fleet.source_project_cargo,9 vs 8</span><br></pre></td></tr></table></figure>
<p>2、该错误官方中有解释<br>
<a target="_blank" rel="noopener" href="https://github.com/alibaba/canal/wiki/TableMetaTSDB">官方文档 TableMetaTSDB</a><br>
 在 instance.properties 中设置</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">canal.instance.tsdb.spring.xml=classpath:spring/tsdb/h2-tsdb.xml</span><br><span class="line"># table meta tsdb info</span><br><span class="line">canal.instance.tsdb.enable=true</span><br><span class="line"># 以下配置不用开启，因为在canal.properties中已经设置过了，只要没有手动关闭过就不用再配置了</span><br><span class="line">#canal.instance.tsdb.dir=$&#123;canal.file.data.dir:../conf&#125;/$&#123;canal.instance.destination:&#125;</span><br><span class="line">#canal.instance.tsdb.url=jdbc:h2:$&#123;canal.instance.tsdb.dir&#125;/h2;CACHE_SIZE=1000;MODE=MYSQL;</span><br><span class="line">#canal.instance.tsdb.url=jdbc:mysql://127.0.0.1:3306/canal_tsdb</span><br><span class="line">#canal.instance.tsdb.dbUsername=canal</span><br><span class="line">#canal.instance.tsdb.dbPassword=canal</span><br></pre></td></tr></table></figure>
<p>3、一般将这个开启就解决了，但是我这里即时将其开启还是报错，查阅相关资料有说将 <code>canal.instance.tsdb.enable</code>  设置为 false 后重启解决的，但是我这里将其设置为 false 后依旧没有解决</p>
<p>实在没有其他办法了，查阅官方 github，导致这个问题发生的原因是因为表结构发生过变化，但是 binlog 中读取到的与现在的表结构不一致导致。</p>
<p>于是直接跳过该 binlog checkpoint，也就是将 binlog 的读取位置设置为当前的最新 binlog 位置</p>
<p>（1）查阅当前 binlog 最新位置，mysql 中执行</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">show master status;</span><br></pre></td></tr></table></figure>
<p><img src="https://img-blog.csdnimg.cn/5a1f009e008d4b4281589f580bef9192.png" alt="在这里插入图片描述"><br>
（2）将读取位置该为最新，修改 deployer conf/example/instance.properties</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">canal.instance.master.address=162.14.99.4:3306</span><br><span class="line">canal.instance.master.journal.name=mysql-bin.000002</span><br><span class="line">canal.instance.master.position=226586328</span><br><span class="line"># 当前时间的时间戳形式</span><br><span class="line">canal.instance.master.timestamp=1653140932</span><br><span class="line">canal.instance.master.gtid=</span><br></pre></td></tr></table></figure>
<p>（3）重启 deployer , adapter<br>
（4）因为读取的是最新的 binlog。为了把当前的数据同步进来，将需要同步的表或库导出，然后再导入一遍。问题解决（注意：这里的解决方案要谨慎，生产环境因为时时刻刻在产生数据，可行性很低，所以看要么设置一个停机维护来进行实操）</p>
<h1 id="22-use-gtid-and-tablemeta-tsdb-should-be-config-timestamp-0"><a class="markdownIt-Anchor" href="#22-use-gtid-and-tablemeta-tsdb-should-be-config-timestamp-0">#</a> 22. use gtid and TableMeta TSDB should be config timestamp &gt; 0</h1>
<p>在 instance.properties 中设置时间戳</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">canal.instance.master.timestamp=1546272000000</span><br></pre></td></tr></table></figure>
<h1 id="23-runtimeexception-comalibabafastjsonjsonexception-unclosed-string"><a class="markdownIt-Anchor" href="#23-runtimeexception-comalibabafastjsonjsonexception-unclosed-string">#</a> 23. RuntimeException: com.alibaba.fastjson.JSONException: unclosed string</h1>
<p>该错误是因为 sql 中使用了 <code>group_concat</code>  函数，但是该函数默认长度是 1024，超过的会被截取，导致出现了 json 格式的数据格式不正确，没有正确的关闭 json</p>
<p>解决：<br>
1、修改 my.cnf，扩大 group_concat_max_len</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">group_concat_max_len = 102400</span><br></pre></td></tr></table></figure>
<p>2、重启 mysql</p>
<h1 id="24-mysqlsyntaxerrorexception-unknown-column-_v_id-in-where-clause"><a class="markdownIt-Anchor" href="#24-mysqlsyntaxerrorexception-unknown-column-_v_id-in-where-clause">#</a> 24. MySQLSyntaxErrorException: Unknown column ‘_v._id’ in ‘where clause’</h1>
<p>sql 中没有 <code>_id</code>  字段导致，使用 as 将 id 命名别名： <code>select id as _id</code></p>
<h1 id="25-adapter中有同步日志打印但es中数据未同步"><a class="markdownIt-Anchor" href="#25-adapter中有同步日志打印但es中数据未同步">#</a> 25. adapter 中有同步日志打印，但 es 中数据未同步</h1>
<p>我这里出现这个问题是在 canal1.1.6 版本中，原因是 es7 文件夹中的 <code>.yml</code>  文件中书写的 sql 里使用了 `` 将表名括起来，导致未识别，如下所示</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> id,name,age <span class="keyword">from</span> `<span class="keyword">user</span>`</span><br></pre></td></tr></table></figure>
<p>解决：<br>
将 `` 去掉即可</p>
<h2 id="关于我"><a class="markdownIt-Anchor" href="#关于我">#</a> 关于我</h2>
<p>Brath 是一个热爱技术的 Java 程序猿，公众号「InterviewCoder」定期分享有趣有料的精品原创文章！</p>
<p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/%E4%BA%8C%E7%BB%B4%E7%A0%81plus.png" alt="InterviewCoder"></p>
<p>非常感谢各位人才能看到这里，原创不易，文章如果有帮助可以关注、点赞、分享或评论，这都是对我的莫大支持！</p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2020-12-06T10:46:26.000Z" title="2020-12-6 18:46:26">2020-12-06</time>发表</span><span class="level-item"><time dateTime="2023-05-10T05:17:15.806Z" title="2023-5-10 13:17:15">2023-05-10</time>更新</span><span class="level-item">19 分钟读完 (大约2868个字)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2020/12/06/%E3%80%90MYSQL%E3%80%91%E6%B0%B4%E5%B9%B3%E5%88%86%E8%A1%A8%E3%80%81%E5%88%86%E5%BA%93%E5%92%8C%E5%9E%82%E7%9B%B4%E5%88%86%E8%A1%A8%E3%80%81%E5%88%86%E5%BA%93%E5%92%8C%E5%85%AC%E5%85%B1%E8%A1%A8%E7%9A%84%E4%BB%A3%E7%A0%81%E5%AE%9E%E7%8E%B0%E5%92%8C%E8%AE%B2%E8%A7%A3/">【MYSQL】水平分表、分库和垂直分表、分库和公共表的代码实现和讲解</a></p><div class="content"><p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/%E6%89%AB%E7%A0%81_%E6%90%9C%E7%B4%A2%E8%81%94%E5%90%88%E4%BC%A0%E6%92%AD%E6%A0%B7%E5%BC%8F-%E6%A0%87%E5%87%86%E8%89%B2%E7%89%88.png" alt="InterviewCoder"></p>
<h3 id="文章目录"><a class="markdownIt-Anchor" href="#文章目录">#</a> 文章目录</h3>
<ul>
<li><a href="#_1">一、教学讲解视频</a></li>
<li><a href="#_3">二、环境准备</a></li>
<li><a href="#_99">三、水平分表</a></li>
<li>
<ul>
<li><a href="#1_100">1. 概念</a></li>
<li><a href="#2_114">2. 代码</a></li>
</ul>
</li>
<li><a href="#_221">四、水平分库</a></li>
<li>
<ul>
<li><a href="#1_223">1. 概念</a></li>
<li><a href="#2_229">2. 代码</a></li>
</ul>
</li>
<li><a href="#_351">五、垂直分表</a></li>
<li>
<ul>
<li><a href="#1_352">1. 概念</a></li>
<li><a href="#2_356">2. 代码</a></li>
</ul>
</li>
<li><a href="#_358">六、垂直分库</a></li>
<li>
<ul>
<li><a href="#1_359">1. 概念</a></li>
<li><a href="#2_362">2. 代码</a></li>
</ul>
</li>
<li><a href="#_364">七、公共表</a></li>
<li>
<ul>
<li><a href="#1_365">1. 概念</a></li>
<li><a href="#2_367">2. 代码</a></li>
</ul>
</li>
</ul>
<h1 id="一-教学讲解视频"><a class="markdownIt-Anchor" href="#一-教学讲解视频">#</a> 一、教学讲解视频</h1>
<p>教学讲解视频地址：<a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1tx4y1371w">视频地址</a></p>
<h1 id="二-环境准备"><a class="markdownIt-Anchor" href="#二-环境准备">#</a> 二、环境准备</h1>
<ul>
<li>
<p>操作系统：Win10</p>
</li>
<li>
<p>数据库：MySQL5.7</p>
</li>
<li>
<p>JDK：64 位 jdk1.8.0_202</p>
</li>
<li>
<p>应用框架：spring-boot-2.1.3.RELEASE</p>
</li>
<li>
<p>Sharding-JDBC：sharding-jdbc-spring-boot-starter-4.0.0-RC1</p>
</li>
</ul>
<p>对应的 pom.xml 依赖代码</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span> <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">  <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.1.3.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">relativePath</span>/&gt;</span> <span class="comment">&lt;!-- lookup parent from repository --&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.yjq.programmer<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>ShardingJDBC<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">name</span>&gt;</span>ShardingJDBC<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">project.build.sourceEncoding</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">project.build.sourceEncoding</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">maven.compiler.source</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">maven.compiler.source</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">maven.compiler.target</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">maven.compiler.target</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 引入mysql连接依赖 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>mysql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mysql-connector-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.1.6<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">scope</span>&gt;</span>runtime<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 引入sharding-jdbc连接依赖 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.shardingsphere<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>sharding-jdbc-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.0.0-RC1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--引入阿里巴巴druid连接池--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>druid<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.1.19<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 引入测试依赖 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 集成mybatis --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.mybatis.spring.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.3.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 集成junit测试 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.12<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">pluginManagement</span>&gt;</span><span class="comment">&lt;!-- lock down plugins versions to avoid using Maven defaults (may be moved to parent pom) --&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line"></span><br><span class="line">      <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">pluginManagement</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h1 id="三-水平分表"><a class="markdownIt-Anchor" href="#三-水平分表">#</a> 三、水平分表</h1>
<h2 id="1概念"><a class="markdownIt-Anchor" href="#1概念">#</a> 1. 概念</h2>
<p>水平分表是在 <code>同一个</code> 数据库内，把同一个表的数据 <code>按一定规则</code> 拆分到多个 <code>表</code> 中。<br>
因此，目前我在一个数据库中准备了两个表， <code>t_user_1</code>  和 <code>t_user_2</code> ，如下图。<br>
<img src="https://brath.oss-cn-shanghai.aliyuncs.com/pigo/b9b8ccb2a36e4028bb013590fc3e84ea.png" alt="在这里插入图片描述"><br>
表结构：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE `t_user_1` (</span><br><span class="line">  `<span class="built_in">id</span>` bigint(20) NOT NULL,</span><br><span class="line">  `name` varchar(100) DEFAULT NULL,</span><br><span class="line">  `sex` int(2) DEFAULT NULL,</span><br><span class="line">  PRIMARY KEY (`<span class="built_in">id</span>`)</span><br><span class="line">) ENGINE=InnoDB DEFAULT CHARSET=utf8;</span><br></pre></td></tr></table></figure>
<h2 id="2代码"><a class="markdownIt-Anchor" href="#2代码">#</a> 2. 代码</h2>
<p>①我们先来看下我们的 SpringBoot 的 <code>配置文件</code> 代码。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">server.port=8081</span><br><span class="line"><span class="comment">#1800s</span></span><br><span class="line">server.servlet.session.timeout=1800</span><br><span class="line">spring.jackson.time-zone=GMT+8</span><br><span class="line">spring.jackson.date-format=yyyy-MM-<span class="built_in">dd</span> HH:mm:ss</span><br><span class="line"></span><br><span class="line"><span class="comment">#定义数据源</span></span><br><span class="line">spring.shardingsphere.datasource.names=m1</span><br><span class="line"></span><br><span class="line">spring.shardingsphere.datasource.m1.url=jdbc:mysql://127.0.0.1:3306/db_user1?serverTimezone=GMT%2b8&amp;useUnicode=<span class="literal">true</span>&amp;characterEncoding=utf8</span><br><span class="line">spring.shardingsphere.datasource.m1.username=root</span><br><span class="line">spring.shardingsphere.datasource.m1.password=</span><br><span class="line">spring.shardingsphere.datasource.m1.driver‐class‐name=com.mysql.jdbc.Driver</span><br><span class="line">spring.shardingsphere.datasource.m1.type=com.alibaba.druid.pool.DruidDataSource</span><br><span class="line"></span><br><span class="line"><span class="comment"># 指定t_user表的数据分布情况，配置数据节点</span></span><br><span class="line">spring.shardingsphere.sharding.tables.t_user.actual‐data‐nodes=m1.t_user_$-&gt;&#123;1..2&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 指定t_user表的主键生成策略为SNOWFLAKE</span></span><br><span class="line">spring.shardingsphere.sharding.tables.t_user.key‐generator.column=<span class="built_in">id</span></span><br><span class="line">spring.shardingsphere.sharding.tables.t_user.key‐generator.type=SNOWFLAKE</span><br><span class="line"></span><br><span class="line"><span class="comment"># 指定t_user表的分表策略，分表策略包括分片键和分片算法</span></span><br><span class="line">spring.shardingsphere.sharding.tables.t_user.table‐strategy.inline.sharding‐column=<span class="built_in">id</span></span><br><span class="line">spring.shardingsphere.sharding.tables.t_user.table‐strategy.inline.algorithm‐expression=t_user_$-&gt;&#123;<span class="built_in">id</span> % 2 + 1&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 控制台日志配置</span></span><br><span class="line">logging.level.root=info</span><br><span class="line">logging.level.com.yjq.programmer.dao=debug</span><br><span class="line"></span><br><span class="line"><span class="comment"># 打开sql输出日志</span></span><br><span class="line">spring.shardingsphere.props.sql.show=<span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#mapper文件扫描路径</span></span><br><span class="line">mybatis.mapper-locations=classpath*:mappers/**/*.xml</span><br></pre></td></tr></table></figure>
<ul>
<li>首先定义数据源 m1，并对 m1 进行实际的参数配置。</li>
<li>指定 t_user 表的数据分布情况，他分布在 m1.t_user_1，m1.t_user_2。</li>
<li>指定 t_user 表的主键生成策略为 SNOWFLAKE，SNOWFLAKE 是一种分布式自增算法，保证 id 全局唯一。</li>
<li>定义 t_user 分表策略，id 为偶数的数据落在 t_user_1，为奇数的落在 t_user_2，所以分表策略的表达式为 t_user_$-&gt;{id% 2 + 1}。</li>
</ul>
<p><strong>踩坑注意！</strong> 如果启动项目有如下报错，可能是配置文件中的 <code>-&gt;</code>  没有用英文类型的。<br>
<img src="https://brath.oss-cn-shanghai.aliyuncs.com/pigo/1b3e0aca06df43c4bb2671eabc7a2e9d.png" alt="在这里插入图片描述"><br>
<img src="https://brath.oss-cn-shanghai.aliyuncs.com/pigo/9a9e406ab2bd4e3db3c55aac18a9b178.png" alt="在这里插入图片描述"></p>
<p>②然后接下来就写我们的 <code>dao</code>  层、 <code>mapper</code>  层和 <code>单元测试</code> 的代码，去测试我们的水平分表情况下 <code>插入</code> 和 <code>查询</code> 的结果。</p>
<p><code>dao</code>  层</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">public interface UserDao &#123;</span><br><span class="line"></span><br><span class="line">    int insertUser(User user);</span><br><span class="line"></span><br><span class="line">    List&lt;User&gt; selectUser();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>mapper</code>  层</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span><br><span class="line">&lt;!DOCTYPE mapper PUBLIC <span class="string">&quot;-//mybatis.org//DTD Mapper 3.0//EN&quot;</span> <span class="string">&quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;</span>&gt;</span><br><span class="line">&lt;mapper namespace=<span class="string">&quot;com.yjq.programmer.dao.UserDao&quot;</span>&gt;</span><br><span class="line"></span><br><span class="line">    &lt;insert <span class="built_in">id</span>=<span class="string">&quot;insertUser&quot;</span> parameterType=<span class="string">&quot;com.yjq.programmer.entity.User&quot;</span>&gt;</span><br><span class="line">        insert into t_user(name) values (<span class="comment">#&#123;name&#125;)</span></span><br><span class="line">    &lt;/insert&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &lt;select <span class="built_in">id</span>=<span class="string">&quot;selectUser&quot;</span> resultType=<span class="string">&quot;com.yjq.programmer.entity.User&quot;</span>&gt;</span><br><span class="line">        select * from t_user</span><br><span class="line">    &lt;/select&gt;</span><br><span class="line">&lt;/mapper&gt;</span><br><span class="line">12345678910111213</span><br><span class="line">单元测试</span><br><span class="line">@Test</span><br><span class="line">public void <span class="function"><span class="title">testShardingJDBCInsert</span></span>() &#123;</span><br><span class="line">    User user = new User();</span><br><span class="line">    <span class="keyword">for</span>(int i=0; i&lt;10; i++) &#123;</span><br><span class="line">        user.setName(<span class="string">&quot;小明&quot;</span> + i);</span><br><span class="line">        <span class="keyword">if</span>(userDao.insertUser(user) == 1) &#123;</span><br><span class="line">            logger.info(<span class="string">&quot;插入成功！&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            logger.info(<span class="string">&quot;插入失败！&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">@Test</span><br><span class="line">public void <span class="function"><span class="title">testShardingJDBCSelect</span></span>() &#123;</span><br><span class="line">    List&lt;User&gt; userList = userDao.selectUser();</span><br><span class="line">    logger.info(<span class="string">&quot;查询结果：&#123;&#125;&quot;</span>, JSONObject.toJSONString(userList));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>③结果说明<br>
 <code>插入</code> <br>
 id 为奇数的被插入到 t_user_2 表，为偶数的被插入到 t_user_1 表，达到预期目标。<br>
 <code>查询</code> <br>
<a target="_blank" rel="noopener" href="https://so.csdn.net/so/search?q=sharding-jdbc&amp;spm=1001.2101.3001.7020"> sharding-jdbc</a> 分别去不同的表检索数据，达到预期目标；<strong>如果有传入 id 进行查询，sharding-jdbc 也会根据 t_user 的分表策略去不同的表检索数据</strong>。</p>
<h1 id="四-水平分库"><a class="markdownIt-Anchor" href="#四-水平分库">#</a> 四、水平分库</h1>
<h2 id="1概念-2"><a class="markdownIt-Anchor" href="#1概念-2">#</a> 1. 概念</h2>
<p>水平分库是把同一个表的数据按 <code>一定规则</code> 拆分到不同的 <code>数据库</code> 中，每个库可以放在不同的服务器上。<br>
现在，我在 <code>水平分表</code> 的基础上多加了一个 db_user2 的数据库。<br>
<img src="https://brath.oss-cn-shanghai.aliyuncs.com/pigo/80d1a3af2700414b9a0850ae9172034a.png" alt="在这里插入图片描述"><br>
然后两个数据库中的表结构是一致的，表结构和上面水平分表用的保持一样。<br>
<img src="https://brath.oss-cn-shanghai.aliyuncs.com/pigo/9354ea1b1af043238412581e0769b3dd.png" alt="在这里插入图片描述"></p>
<h2 id="2代码-2"><a class="markdownIt-Anchor" href="#2代码-2">#</a> 2. 代码</h2>
<p>①我们先来看下我们的 SpringBoot 的 <code>配置文件</code> 代码。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">server.port=8081</span><br><span class="line"><span class="comment">#1800s</span></span><br><span class="line">server.servlet.session.timeout=1800</span><br><span class="line">spring.jackson.time-zone=GMT+8</span><br><span class="line">spring.jackson.date-format=yyyy-MM-<span class="built_in">dd</span> HH:mm:ss</span><br><span class="line"></span><br><span class="line"><span class="comment">#定义数据源</span></span><br><span class="line">spring.shardingsphere.datasource.names=m1,m2</span><br><span class="line"></span><br><span class="line">spring.shardingsphere.datasource.m1.url=jdbc:mysql://127.0.0.1:3306/db_user1?serverTimezone=GMT%2b8&amp;useUnicode=<span class="literal">true</span>&amp;characterEncoding=utf8</span><br><span class="line">spring.shardingsphere.datasource.m1.username=root</span><br><span class="line">spring.shardingsphere.datasource.m1.password=</span><br><span class="line">spring.shardingsphere.datasource.m1.driver‐class‐name=com.mysql.jdbc.Driver</span><br><span class="line">spring.shardingsphere.datasource.m1.type=com.alibaba.druid.pool.DruidDataSource</span><br><span class="line"></span><br><span class="line">spring.shardingsphere.datasource.m2.url=jdbc:mysql://127.0.0.1:3306/db_user2?serverTimezone=GMT%2b8&amp;useUnicode=<span class="literal">true</span>&amp;characterEncoding=utf8</span><br><span class="line">spring.shardingsphere.datasource.m2.username=root</span><br><span class="line">spring.shardingsphere.datasource.m2.password=</span><br><span class="line">spring.shardingsphere.datasource.m2.driver‐class‐name=com.mysql.jdbc.Driver</span><br><span class="line">spring.shardingsphere.datasource.m2.type=com.alibaba.druid.pool.DruidDataSource</span><br><span class="line"></span><br><span class="line"><span class="comment"># 分库策略</span></span><br><span class="line">spring.shardingsphere.sharding.tables.t_user.database‐strategy.inline.sharding‐column=sex</span><br><span class="line">spring.shardingsphere.sharding.tables.t_user.database‐strategy.inline.algorithm‐expression=m$-&gt;&#123;sex % 2 + 1&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 指定t_user表的数据分布情况，配置数据节点</span></span><br><span class="line">spring.shardingsphere.sharding.tables.t_user.actual‐data‐nodes=m$-&gt;&#123;1..2&#125;.t_user_$-&gt;&#123;1..2&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 指定t_user表的主键生成策略为SNOWFLAKE</span></span><br><span class="line">spring.shardingsphere.sharding.tables.t_user.key‐generator.column=<span class="built_in">id</span></span><br><span class="line">spring.shardingsphere.sharding.tables.t_user.key‐generator.type=SNOWFLAKE</span><br><span class="line"></span><br><span class="line"><span class="comment"># 指定t_user表的分表策略，分表策略包括分片键和分片算法</span></span><br><span class="line">spring.shardingsphere.sharding.tables.t_user.table‐strategy.inline.sharding‐column=<span class="built_in">id</span></span><br><span class="line">spring.shardingsphere.sharding.tables.t_user.table‐strategy.inline.algorithm‐expression=t_user_$-&gt;&#123;<span class="built_in">id</span> % 2 + 1&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 控制台日志配置</span></span><br><span class="line">logging.level.root=info</span><br><span class="line">logging.level.com.yjq.programmer.dao=debug</span><br><span class="line"></span><br><span class="line"><span class="comment"># 打开sql输出日志</span></span><br><span class="line">spring.shardingsphere.props.sql.show=<span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#mapper文件扫描路径</span></span><br><span class="line">mybatis.mapper-locations=classpath*:mappers/**/*.xml</span><br></pre></td></tr></table></figure>
<ul>
<li>配置了两个数据源，分配指向两个不同的数据库 db_user1 和 db_user2。</li>
<li>配置分库策略，sex 字段为偶数的数据落在 m1 数据源，为奇数的落在 m2 数据源，所以分库策略的表达式为 m$-&gt;{sex % 2 + 1}。</li>
<li>配置分表策略，分表策略和上面水平分表保持一致。</li>
<li>也就是当有数据来时，先根据 sex 字段判断落入哪个数据源，然后再根据 id 字段来判断落入哪个表中。</li>
</ul>
<p>②然后接下来就写我们的 <code>dao</code>  层、 <code>mapper</code>  层和 <code>单元测试</code> 的代码，去测试我们的水平分表情况下 <code>插入</code> 和 <code>查询</code> 的结果。</p>
<p><code>dao</code>  层</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">public interface UserDao &#123;</span><br><span class="line"></span><br><span class="line">    int insertUser(User user);</span><br><span class="line"></span><br><span class="line">    List&lt;User&gt; selectUser(User user);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>mapper</code>  层</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span><br><span class="line">&lt;!DOCTYPE mapper PUBLIC <span class="string">&quot;-//mybatis.org//DTD Mapper 3.0//EN&quot;</span> <span class="string">&quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;</span>&gt;</span><br><span class="line">&lt;mapper namespace=<span class="string">&quot;com.yjq.programmer.dao.UserDao&quot;</span>&gt;</span><br><span class="line"></span><br><span class="line">    &lt;insert <span class="built_in">id</span>=<span class="string">&quot;insertUser&quot;</span> parameterType=<span class="string">&quot;com.yjq.programmer.entity.User&quot;</span>&gt;</span><br><span class="line">        insert into t_user(name, sex) values (<span class="comment">#&#123;name&#125;, #&#123;sex&#125;)</span></span><br><span class="line">    &lt;/insert&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &lt;select <span class="built_in">id</span>=<span class="string">&quot;selectUser&quot;</span> parameterType=<span class="string">&quot;com.yjq.programmer.entity.User&quot;</span> resultType=<span class="string">&quot;com.yjq.programmer.entity.User&quot;</span>&gt;</span><br><span class="line">        select * from t_user t <span class="built_in">where</span> t.sex = <span class="comment">#&#123;sex&#125; and t.id = #&#123;id&#125;</span></span><br><span class="line">    &lt;/select&gt;</span><br><span class="line">&lt;/mapper&gt;</span><br><span class="line">12345678910111213</span><br><span class="line">单元测试</span><br><span class="line">@Test</span><br><span class="line">public void <span class="function"><span class="title">testShardingJDBCInsert</span></span>() &#123;</span><br><span class="line">    User user = new User();</span><br><span class="line">    <span class="keyword">for</span>(int i=0; i&lt;10; i++) &#123;</span><br><span class="line">        user.setName(<span class="string">&quot;小明&quot;</span> + i);</span><br><span class="line">        user.setSex(1);</span><br><span class="line">        <span class="keyword">if</span>(userDao.insertUser(user) == 1) &#123;</span><br><span class="line">            logger.info(<span class="string">&quot;插入成功！&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            logger.info(<span class="string">&quot;插入失败！&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">@Test</span><br><span class="line">public void <span class="function"><span class="title">testShardingJDBCSelect</span></span>() &#123;</span><br><span class="line">    User user = new User();</span><br><span class="line">    user.setSex(1);</span><br><span class="line">    user.setId(821357967667363840L);</span><br><span class="line">    List&lt;User&gt; userList = userDao.selectUser(user);</span><br><span class="line">    logger.info(<span class="string">&quot;查询结果：&#123;&#125;&quot;</span>, JSONObject.toJSONString(userList));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>③结果说明<br>
 <code>插入</code> <br>
 sex 字段为奇数的数据落入 m2 数据源，为偶数的落入 m1 数据源。同时 id 字段值为奇数的，插入 t_user_2 表中，为偶数的插入 t_user_1 表中，达到预期目标。<br>
 <code>查询</code> <br>
 sharding-jdbc 分别去不同的表检索数据，达到预期目标；<strong>如果有传入 sex 进行查询，sharding-jdbc 会根据 t_user 的分库策略去锁定查哪个库，如果有传入 id 进行查询，sharding-jdbc 会根据 t_user 的分表策略去锁定查哪个表</strong>。</p>
<h1 id="五-垂直分表"><a class="markdownIt-Anchor" href="#五-垂直分表">#</a> 五、垂直分表</h1>
<h2 id="1概念-3"><a class="markdownIt-Anchor" href="#1概念-3">#</a> 1. 概念</h2>
<p>垂直分表一般就是把表的结构进行改造，关于如何改造，可以浏览我的另一篇博客：<br>
<a target="_blank" rel="noopener" href="https://blog.csdn.net/dgfdhgghd/article/details/128426013">分库分表：垂直分库、垂直分表、水平分库、水平分表四个概念</a><br>
<strong>大致的思路就是：将一个表按照字段分成多表，每个表存储其中一部分字段。</strong></p>
<h2 id="2代码-3"><a class="markdownIt-Anchor" href="#2代码-3">#</a> 2. 代码</h2>
<p>无代码，垂直分表属于表结构设计层面。</p>
<h1 id="六-垂直分库"><a class="markdownIt-Anchor" href="#六-垂直分库">#</a> 六、垂直分库</h1>
<h2 id="1概念-4"><a class="markdownIt-Anchor" href="#1概念-4">#</a> 1. 概念</h2>
<p>垂直分库就是在 <code>垂直分表</code> 把表进行分类后，放到 <code>不同的数据库</code> 中。每个库可以放在不同的服务器上，它的核心理念是 <code>专库专用</code> 。关于如何改造，同样可以浏览我的另一篇博客：<br>
<a target="_blank" rel="noopener" href="https://blog.csdn.net/dgfdhgghd/article/details/128426013">分库分表：垂直分库、垂直分表、水平分库、水平分表四个概念</a></p>
<h2 id="2代码-4"><a class="markdownIt-Anchor" href="#2代码-4">#</a> 2. 代码</h2>
<p>无代码，垂直分库属于数据库设计层面。</p>
<h1 id="七-公共表"><a class="markdownIt-Anchor" href="#七-公共表">#</a> 七、公共表</h1>
<h2 id="1概念-5"><a class="markdownIt-Anchor" href="#1概念-5">#</a> 1. 概念</h2>
<p>公共表属于系统中数据量较小，变动少，而且属于高频联合查询的依赖表。参数表、数据字典表等属于此类型。 <code>可以将这类表在每个数据库都保存一份</code> ，所有更新操作都同时发送到所有分库执行。</p>
<h2 id="2代码-5"><a class="markdownIt-Anchor" href="#2代码-5">#</a> 2. 代码</h2>
<p>①只需要在 SpringBoot 的 <code>配置文件</code> 中加入下面这行来指明公共表就行。<br>
 <code>如果有多个公共表，用逗号拼接就行</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#公共表设置</span></span><br><span class="line">spring.shardingsphere.sharding.broadcast‐tables=t_dict</span><br><span class="line">12</span><br></pre></td></tr></table></figure>
<p>②然后接下来就写我们的 <code>dao</code>  层、 <code>mapper</code>  层和 <code>单元测试</code> 的代码，去测试我们的公共表的 <code>插入</code> 的结果。<br>
 <code>dao</code>  层</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">public interface DictDao &#123;</span><br><span class="line"></span><br><span class="line">    int insertDict(Dict dict);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>mapper</code>  层</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span><br><span class="line">&lt;!DOCTYPE mapper PUBLIC <span class="string">&quot;-//mybatis.org//DTD Mapper 3.0//EN&quot;</span> <span class="string">&quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;</span>&gt;</span><br><span class="line">&lt;mapper namespace=<span class="string">&quot;com.yjq.programmer.dao.DictDao&quot;</span>&gt;</span><br><span class="line"></span><br><span class="line">    &lt;insert <span class="built_in">id</span>=<span class="string">&quot;insertDict&quot;</span> parameterType=<span class="string">&quot;com.yjq.programmer.entity.Dict&quot;</span>&gt;</span><br><span class="line">        insert into t_dict(<span class="built_in">id</span>, name) values (<span class="comment">#&#123;id&#125;, #&#123;name&#125;)</span></span><br><span class="line">    &lt;/insert&gt;</span><br><span class="line">&lt;/mapper&gt;</span><br><span class="line"></span><br><span class="line">单元测试</span><br><span class="line">@Test</span><br><span class="line">public void <span class="function"><span class="title">testShardingJDBCInsertDict</span></span>() &#123;</span><br><span class="line">    Dict dict = new Dict();</span><br><span class="line">    dict.setId(1);</span><br><span class="line">    dict.setName(<span class="string">&quot;字典名称&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span>(dictDao.insertDict(dict) == 1) &#123;</span><br><span class="line">        logger.info(<span class="string">&quot;插入成功！&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        logger.info(<span class="string">&quot;插入失败！&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>③结果说明<br>
 <code>插入</code> <br>
插入的数据在 <code>每个库中的对应的公共表</code> 中都能看到，达到预期目标。</p>
<h2 id="关于我"><a class="markdownIt-Anchor" href="#关于我">#</a> 关于我</h2>
<p>Brath 是一个热爱技术的 Java 程序猿，公众号「InterviewCoder」定期分享有趣有料的精品原创文章！</p>
<p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/%E4%BA%8C%E7%BB%B4%E7%A0%81plus.png" alt="InterviewCoder"></p>
<p>非常感谢各位人才能看到这里，原创不易，文章如果有帮助可以关注、点赞、分享或评论，这都是对我的莫大支持！</p>
</div></article></div><nav class="pagination" role="navigation" aria-label="pagination"><div class="pagination-previous"><a href="/page/14/">上一页</a></div><div class="pagination-next is-invisible is-hidden-mobile"><a href="/page/16/">下一页</a></div><ul class="pagination-list is-hidden-mobile"><li><a class="pagination-link" href="/">1</a></li><li><span class="pagination-ellipsis">&hellip;</span></li><li><a class="pagination-link" href="/page/14/">14</a></li><li><a class="pagination-link is-current" href="/page/15/">15</a></li></ul></nav></div><div class="column column-left is-4-tablet is-4-desktop is-3-widescreen  order-1"><!--!--><div class="card widget" data-type="recent-posts"><div class="card-content"><h3 class="menu-label">最新文章</h3><article class="media"><div class="media-content"><p class="date"><time dateTime="2023-06-06T00:10:41.000Z">2023-06-06</time></p><p class="title"><a href="/2023/06/06/%E3%80%90%E5%85%AC%E4%BC%97%E5%8F%B7%E5%BC%80%E5%8F%91%E3%80%91%E5%85%AC%E4%BC%97%E5%8F%B7%E6%8A%80%E6%9C%AF%E5%88%86%E4%BA%AB%E7%AC%AC%E4%B8%80%E6%9C%9F-%E5%A6%82%E4%BD%95%E6%B3%A8%E5%86%8C%E5%BE%AE%E4%BF%A1%E5%85%AC%E4%BC%97%E5%B9%B3%E5%8F%B0%E5%B9%B6%E4%BD%BF%E7%94%A8%E5%85%AC%E4%BC%97%E5%8F%B7%E6%A8%A1%E6%9D%BF%E6%B6%88%E6%81%AF/">【公众号开发】公众号技术分享第一期-如何注册微信公众平台并使用公众号模板消息</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2023-06-05T17:10:41.000Z">2023-06-06</time></p><p class="title"><a href="/2023/06/06/%E3%80%90Sentinel%E3%80%91Docker%E6%90%AD%E5%BB%BASentinel/">【Sentinel】Docker搭建Sentinel</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2023-06-05T07:25:21.000Z">2023-06-05</time></p><p class="title"><a href="/2023/06/05/%E3%80%90Git%E3%80%91Github%E6%8F%90%E4%BA%A4%E4%BB%A3%E7%A0%81%E9%81%87%E5%88%B0%E9%94%99%E8%AF%AF%EF%BC%9AERROR%20You%E2%80%98re%20using%20an%20RSA%20key%20with%20SHA-1,%20which%20is%20no%20longer%20allowed/">【Git】Github提交代码遇到错误：ERROR You‘re using an RSA key with SHA-1, which is no longer allowed</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2023-05-23T02:04:23.000Z">2023-05-23</time></p><p class="title"><a href="/2023/05/23/%E3%80%90Linux%E3%80%91%E9%98%BF%E9%87%8C%E4%BA%91linux%20%E6%8C%82%E8%BD%BD%E6%95%B0%E6%8D%AE%E7%9B%98%E5%B9%B6docker%E5%B7%A5%E4%BD%9C%E7%9B%AE%E5%BD%95%E8%BF%81%E7%A7%BB%E5%88%B0%E6%95%B0%E6%8D%AE%E7%9B%98/">【Linux】阿里云linux 挂载数据盘并docker工作目录迁移到数据盘</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2023-05-23T02:04:23.000Z">2023-05-23</time></p><p class="title"><a href="/2023/05/23/%E3%80%90Seata%E3%80%91%E6%9D%A5%E8%87%AA%E9%98%BF%E9%87%8C%E5%BC%80%E6%BA%90%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1%E6%A1%86%E6%9E%B6-Seata%E7%9A%84%E5%8E%9F%E7%90%86/">【Seata】来自阿里开源分布式事务框架-Seata的原理</a></p></div></article></div></div><div class="card widget" data-type="archives"><div class="card-content"><div class="menu"><h3 class="menu-label">归档</h3><ul class="menu-list"><li><a class="level is-mobile" href="/archives/2023/"><span class="level-start"><span class="level-item">2023</span></span><span class="level-end"><span class="level-item tag">39</span></span></a></li><li><a class="level is-mobile" href="/archives/2022/"><span class="level-start"><span class="level-item">2022</span></span><span class="level-end"><span class="level-item tag">61</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/"><span class="level-start"><span class="level-item">2021</span></span><span class="level-end"><span class="level-item tag">43</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/"><span class="level-start"><span class="level-item">2020</span></span><span class="level-end"><span class="level-item tag">5</span></span></a></li></ul></div></div></div><!--!--><div class="card widget" data-type="profile"><div class="card-content"><nav class="level"><div class="level-item has-text-centered flex-shrink-1"><div><figure class="image is-128x128 mx-auto mb-2"><img class="avatar" src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/%E4%BA%8C%E7%BB%B4%E7%A0%81plus.png" alt="InterviewCoder"></figure><p class="title is-size-4 is-block" style="line-height:inherit;">InterviewCoder</p><p class="is-size-6 is-block">面试记官方公众号</p></div></div></nav><nav class="level is-mobile"><div class="level-item has-text-centered is-marginless"><div><p class="heading">文章</p><a href="/archives"><p class="title">148</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">分类</p><a href="/categories"><p class="title">0</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">标签</p><a href="/tags"><p class="title">0</p></a></div></div></nav><div class="level"><a class="level-item button is-primary is-rounded" href="https://mp.weixin.qq.com/s/jWs6lLHl5L-atXJhHc4YvA" target="_blank" rel="noopener">关注我</a></div></div></div><div class="column-right-shadow is-hidden-widescreen"></div></div><div class="column column-right is-4-tablet is-4-desktop is-3-widescreen is-hidden-touch is-hidden-desktop-only order-3"><div class="card widget" data-type="profile"><div class="card-content"><nav class="level"><div class="level-item has-text-centered flex-shrink-1"><div><figure class="image is-128x128 mx-auto mb-2"><img class="avatar is-rounded" src="https://brath.cloud/me.png" alt="Brath"></figure><p class="title is-size-4 is-block" style="line-height:inherit;">Brath</p><p class="is-size-6 is-block">技能改变人生，知识改变命运。</p><p class="is-size-6 is-flex justify-content-center"><i class="fas fa-map-marker-alt mr-1"></i><span>中国·江苏·无锡</span></p></div></div></nav><nav class="level is-mobile"><div class="level-item has-text-centered is-marginless"><div><p class="heading">文章</p><a href="/archives"><p class="title">148</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">分类</p><a href="/categories"><p class="title">0</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">标签</p><a href="/tags"><p class="title">0</p></a></div></div></nav><div class="level"><a class="level-item button is-primary is-rounded" href="https://github.com/Guoqing815" target="_blank" rel="noopener">关注我</a></div><div class="level is-mobile is-multiline"><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Github" href="https://github.com/Guoqing815"><i class="fab fa-github"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Gitee" href="https://gitee.com/Guoqing-Li"><i class="fab fa-gitee"></i></a></div></div></div><!--!--><div class="card widget" data-type="links"><div class="card-content"><div class="menu"><h3 class="menu-label">链接</h3><ul class="menu-list"><li><a class="level is-mobile" href="https://schokolade.cn/" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">泠灵(特别呜谢)</span></span><span class="level-right"><span class="level-item tag">schokolade.cn</span></span></a></li><li><a class="level is-mobile" href="https://gitee.com/Guoqing-Li" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">Gitee(码云)</span></span><span class="level-right"><span class="level-item tag">gitee.com</span></span></a></li><li><a class="level is-mobile" href="https://blog.csdn.net/Brath?type=blog" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">CSDN</span></span><span class="level-right"><span class="level-item tag">blog.csdn.net</span></span></a></li><li><a class="level is-mobile" href="https://juejin.cn/user/settings/profile" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">掘金</span></span><span class="level-right"><span class="level-item tag">juejin.cn</span></span></a></li><li><a class="level is-mobile" href="https://oss.console.aliyun.com/" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">AliCloud(阿里云)</span></span><span class="level-right"><span class="level-item tag">oss.console.aliyun.com</span></span></a></li><li><a class="level is-mobile" href="https://cloud.tencent.com/" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">TencentCloud(腾讯云)</span></span><span class="level-right"><span class="level-item tag">cloud.tencent.com</span></span></a></li><li><a class="level is-mobile" href="https://www.zhipin.com/web/user/" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">BOSS</span></span><span class="level-right"><span class="level-item tag">www.zhipin.com</span></span></a></li><li><a class="level is-mobile" href="https://www.bilibili.com/" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">Bilibili(B站)</span></span><span class="level-right"><span class="level-item tag">www.bilibili.com</span></span></a></li></ul></div></div></div></div></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/"><img src="https://brath.cloud/avatar.png" alt="Brath-Blog" height="28"></a><p class="is-size-7"><span>&copy; 2023 Brath</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a><br><span id="busuanzi_container_site_uv">共<span id="busuanzi_value_site_uv">0</span>个访客</span></p><p class="is-size-7">© 2029</p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Attribution 4.0 International" href="https://creativecommons.org/licenses/by/4.0/"><i class="fab fa-creative-commons-by"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/ppoffice/hexo-theme-icarus"><i class="fab fa-github"></i></a></p></div></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script><script>moment.locale("zh-cn");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="/js/column.js"></script><script src="/js/animation.js"></script><a id="back-to-top" title="回到顶端" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><!--!--><!--!--><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.js" defer></script><script>window.addEventListener("load", () => {
      window.cookieconsent.initialise({
        type: "info",
        theme: "edgeless",
        static: false,
        position: "bottom-left",
        content: {
          message: "此网站使用Cookie来改善您的体验。",
          dismiss: "知道了！",
          allow: "允许使用Cookie",
          deny: "拒绝",
          link: "了解更多",
          policy: "Cookie政策",
          href: "https://www.cookiesandyou.com/",
        },
        palette: {
          popup: {
            background: "#edeff5",
            text: "#838391"
          },
          button: {
            background: "#4b81e8"
          },
        },
      });
    });</script><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><!--!--><!--!--><!--!--><script src="/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="想要查找什么..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"想要查找什么...","untitled":"(无标题)","posts":"文章","pages":"页面","categories":"分类","tags":"标签"});
        });</script></body></html>