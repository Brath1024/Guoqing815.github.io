<!doctype html>
<html lang="zh"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta><title>Brath-Blog</title><link rel="manifest" href="/manifest.json"><meta name="application-name" content="Brath-Blog"><meta name="msapplication-TileImage" content="https://brath.cloud/me.png"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="Brath-Blog"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta property="og:type" content="blog"><meta property="og:title" content="Brath-Blog"><meta property="og:url" content="http://example.com/"><meta property="og:site_name" content="Brath-Blog"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="http://example.com/img/og_image.png"><meta property="article:author" content="Brath"><meta property="twitter:card" content="summary"><meta property="twitter:image:src" content="http://example.com/img/og_image.png"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"http://example.com"},"headline":"Brath-Blog","image":["http://example.com/img/og_image.png"],"author":{"@type":"Person","name":"Brath"},"publisher":{"@type":"Organization","name":"Brath-Blog","logo":{"@type":"ImageObject","url":"https://brath.cloud/me.png"}},"description":""}</script><link rel="icon" href="https://brath.cloud/me.png"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v6.0.0/css/all.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/atom-one-light.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><!--!--><!--!--><script src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" defer></script><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/css/justifiedGallery.min.css"><!--!--><!--!--><style>.pace{-webkit-pointer-events:none;pointer-events:none;-webkit-user-select:none;-moz-user-select:none;user-select:none}.pace-inactive{display:none}.pace .pace-progress{background:#3273dc;position:fixed;z-index:2000;top:0;right:100%;width:100%;height:2px}</style><script src="https://cdn.jsdelivr.net/npm/pace-js@1.2.4/pace.min.js"></script><!--!--><!--!--><!-- hexo injector head_end start --><script>
  (function () {
      function switchTab() {
          if (!location.hash) {
            return;
          }

          const id = '#' + CSS.escape(location.hash.substring(1));
          const $tabMenu = document.querySelector(`.tabs a[href="${id}"]`);
          if (!$tabMenu) {
            return;
          }

          const $tabMenuContainer = $tabMenu.parentElement.parentElement;
          Array.from($tabMenuContainer.children).forEach($menu => $menu.classList.remove('is-active'));
          Array.from($tabMenuContainer.querySelectorAll('a'))
              .map($menu => document.getElementById($menu.getAttribute("href").substring(1)))
              .forEach($content => $content.classList.add('is-hidden'));

          if ($tabMenu) {
              $tabMenu.parentElement.classList.add('is-active');
          }
          const $activeTab = document.querySelector(id);
          if ($activeTab) {
              $activeTab.classList.remove('is-hidden');
          }
      }
      switchTab();
      window.addEventListener('hashchange', switchTab, false);
  })();
  </script><!-- hexo injector head_end end --><meta name="generator" content="Hexo 6.3.0"></head><body class="is-3-column"><nav class="navbar navbar-main"><div class="container navbar-container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="https://brath.cloud/me.png" alt="Brath-Blog" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">主页</a><a class="navbar-item" href="/archives">文章列表</a><a class="navbar-item" href="/tags">标签</a><a class="navbar-item" href="/about">更多</a></div><div class="navbar-end"><a class="navbar-item" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/Guoqing815"><i class="fab fa-github"></i></a><a class="navbar-item search" title="搜索" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-6-widescreen"><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2021-04-01T22:45:39.000Z" title="2021/4/2 06:45:39">2021-04-02</time>发表</span><span class="level-item"><time dateTime="2020-01-04T09:06:42.000Z" title="2020/1/4 17:06:42">2020-01-04</time>更新</span><span class="level-item">17 分钟读完 (大约2566个字)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2021/04/02/%E3%80%90MySQL%E3%80%91%E3%80%90Redis%E3%80%91Redis%E4%B8%8EMysql%20Master%E4%B8%8ESlave%E5%90%8C%E6%AD%A5%EF%BC%9Acanal%E6%95%99%E5%AD%A6/">Redis与Mysql | Master与Slave同步：canal教学</a></p><div class="content"><p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/%E6%89%AB%E7%A0%81_%E6%90%9C%E7%B4%A2%E8%81%94%E5%90%88%E4%BC%A0%E6%92%AD%E6%A0%B7%E5%BC%8F-%E6%A0%87%E5%87%86%E8%89%B2%E7%89%88.png" alt="InterviewCoder"></p>
<h2 id="前言"><a class="markdownIt-Anchor" href="#前言">#</a> 前言：</h2>
<p>​		作者最近在做自己的项目，使用到 Redis，需要热更新，修改 Mysql 后同步 Redis 缓存，出于对圈子的贡献，也较于当前的 canal 的博客大多数不是很详细，所以写下这篇文章，时间是 2022 年 6 月 29 日。目的是帮助更多的人，希望能为在祖国的经济发展作出小小的贡献。</p>
<p>​		end</p>
<h4 id="学习canal基本需要"><a class="markdownIt-Anchor" href="#学习canal基本需要">#</a> 学习 Canal 基本需要：</h4>
<p>​	Linux 服务器，性能无大要求</p>
<p>​	Java 基础</p>
<p>​	Mysql，Redis 基础</p>
<h3 id="俗话说要了解一个东西先了解他的由来"><a class="markdownIt-Anchor" href="#俗话说要了解一个东西先了解他的由来">#</a> 俗话说，要了解一个东西，先了解他的由来：</h3>
<h2 id="一-canal起源"><a class="markdownIt-Anchor" href="#一-canal起源">#</a> 一、Canal 起源</h2>
<p>​		阿里巴巴因为业务特性，买家集中在国外，衍生出了杭州美国异地数据同步需求，从 2010 年开始，阿里巴巴开始开发 canal，canal 是基于 Java 开发的数据库增量日志解析，提供增量数据订阅 &amp; 消费的中间件。Canal 主要支持了 Mysql 和 Bilog 解析，解析完成后利用 canal Client 来处理获取相关数据。</p>
<p>了解完 canal 的起源，再来看看 canal 的核心业务依赖，也就是 mysql 的二进制日志：binary_log 简称：Binlog</p>
<h2 id="二-binlog"><a class="markdownIt-Anchor" href="#二-binlog">#</a> 二、Binlog</h2>
<p>​		binlog 指二进制日志，它记录了数据库上的所有改变，并以二进制的形式保存在磁盘中，它可以用来查看数据库的变更历史、数据库增量备份和恢复、MySQL 的复制（主从数据库的复制）。</p>
<h4 id="binlog有三种格式"><a class="markdownIt-Anchor" href="#binlog有三种格式">#</a> binlog 有三种格式：</h4>
<p>statement：基于 SQL 语句的复制（statement-based replication，SBR）<br>
row：基于行的复制（row-based replication，RBR）<br>
mixed：混合模式复制（mixed-based replication，MBR）</p>
<h4 id="statement语句级别"><a class="markdownIt-Anchor" href="#statement语句级别">#</a> statement：语句级别</h4>
<p>每一条会修改数据的 sql 都会记录在 binlog 中。</p>
<p>​		优点：不需要记录每一行的变化，减少了 binlog 日志量，节约了 IO，提高性能。但是注意 statement 相比于 row 能节约多少性能与日志量，取决于应用的 SQL 情况。正常同一条记录修改或者插入 row 格式所产生的日志量还小于 Statement 产生的日志量，但是考虑到如果带条件的 update 操作，以及整表删除，alter 表等操作，ROW 格式会产生大量日志，因此在考虑是否使用 ROW 格式日志时应该跟据应用的实际情况，其所产生的日志量会增加多少，以及带来的 IO 性能问题。</p>
<p>​		缺点：由于记录的只是执行语句，为了这些语句在 slave 上正确运行，我们还必须记录每条语句在执行时候的一些相关信息，以保证所有语句能在 slave 得到和在 master 端执行时相同的结果。另外，一些特定的函数功能如果要在 slave 和 master 上保持一致会有很多相关问题。</p>
<h4 id="row行数据级别"><a class="markdownIt-Anchor" href="#row行数据级别">#</a> row：行数据级别</h4>
<p>5.1.5 版本的 MySQL 才开始支持 row level 的复制，它不记录 sql 语句上下文相关信息，仅保存哪条记录被修改。</p>
<p>​		优点：binlog 中可以不记录执行的 sql 语句的上下文相关的信息，仅需要记录那一条记录被修改成什么了。所以 row level 的日志会非常清楚的记下每一行数据修改的细节。而且不会出现某些特定情况下的存储过程，或 function，以及 trigger 的调用和触发无法被正确复制的问题。</p>
<p>​		缺点：所有的执行的语句当记录到日志中的时候，都将以每行记录的修改来记录，这样可能会产生大量的日志内容。但是新版本的 MySQL 对 row level 模式进行了优化，并不是所有的修改都会以 row level 来记录，像遇到表结构变更的时候就会以 statement 模式来记录，如果 sql 语句确实就是 update 或者 delete 等修改数据的语句，那么还是会记录所有行的变更。</p>
<h4 id="mixed混合级别"><a class="markdownIt-Anchor" href="#mixed混合级别">#</a> mixed：混合级别</h4>
<p>从 5.1.8 版本开始，MySQL 提供了 Mixed 格式，实际上就是 Statement 与 Row 的结合。</p>
<p>​		在 Mixed 模式下，一般的语句修改使用 statment 格式保存 binlog，如果一些函数，statement 无法完成主从复制的操作，则采用 row 格式保存 binlog，MySQL 会根据执行的每一条具体的 sql 语句来区分对待记录的日志形式，也就是在 Statement 和 Row 之间选择一种。</p>
<h5 id="由于-statement-和-mixed-的特殊性通过sql来备份总会有数据不一致的情况比如now函数"><a class="markdownIt-Anchor" href="#由于-statement-和-mixed-的特殊性通过sql来备份总会有数据不一致的情况比如now函数">#</a> 由于 statement 和 mixed 的特殊性，通过 sql 来备份，总会有数据不一致的情况，比如：now () 函数。</h5>
<h5 id="所以绝大多数场景下使用-row级别也就是行级别这样保证我们备份的数据和出口的数据相一致"><a class="markdownIt-Anchor" href="#所以绝大多数场景下使用-row级别也就是行级别这样保证我们备份的数据和出口的数据相一致">#</a> 所以绝大多数场景下使用 Row 级别，也就是行级别，这样保证我们备份的数据和出口的数据相一致。</h5>
<h3 id="三-下载和安装canal工具"><a class="markdownIt-Anchor" href="#三-下载和安装canal工具">#</a> 三、下载和安装 Canal 工具</h3>
<p>下载前，在 mysql 创建 canal 用户，因为 canal 服务端需要连接 mysql 数据库</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">-- 使用命令登录：mysql -u root -p</span><br><span class="line">-- 创建用户 用户名：canal 密码：Canal@123456</span><br><span class="line">create user <span class="string">&#x27;canal&#x27;</span>@<span class="string">&#x27;%&#x27;</span> identified by <span class="string">&#x27;Canal@123456&#x27;</span>;</span><br><span class="line">-- 授权 *.*表示所有库</span><br><span class="line">grant SELECT, REPLICATION SLAVE, REPLICATION CLIENT on *.* to <span class="string">&#x27;canal&#x27;</span>@<span class="string">&#x27;%&#x27;</span> identified by <span class="string">&#x27;Canal@123456&#x27;</span>;</span><br></pre></td></tr></table></figure>
<h4 id="改了配置文件之后重启mysql使用命令查看是否打开binlog模式"><a class="markdownIt-Anchor" href="#改了配置文件之后重启mysql使用命令查看是否打开binlog模式">#</a> 改了配置文件之后，重启 MySQL，使用命令查看是否打开 binlog 模式：</h4>
<p><img src="https://brath.cloud/blogImg/20200808151606261.png" alt="在这里插入图片描述"></p>
<h4 id="查看binlog日志文件列表"><a class="markdownIt-Anchor" href="#查看binlog日志文件列表">#</a> 查看 binlog 日志文件列表：</h4>
<p><img src="https://brath.cloud/blogImg/20200808151715291.png" alt="在这里插入图片描述"></p>
<h3 id="点此下载canal"><a class="markdownIt-Anchor" href="#点此下载canal">#</a> 点此下载 Canal👇</h3>
<p><a target="_blank" rel="noopener" href="https://ghproxy.com/https://github.com/alibaba/canal/releases/download/canal-1.1.2/canal.deployer-1.1.2.tar.gz">https://ghproxy.com/https://github.com/alibaba/canal/releases/download/canal-1.1.2/canal.deployer-1.1.2.tar.gz</a></p>
<p>此链接为 github 代理提供连接，仅供参考，此处无广告意义。</p>
<p><img src="https://brath.cloud/blogImg/image-20220629152616754.png" alt="image-20220629152616754"></p>
<p>下载好后上传至 linux 服务器，创建 canal 文件夹并解压到 canal 文件夹中</p>
<p><img src="https://brath.cloud/blogImg/image-20220629153150741.png" alt="image-20220629153150741"></p>
<p>完成后会得到以上四个核心文件：bin，conf，lib，logs</p>
<p>需要修改一处配置文件：</p>
<p>​		/canal/conf/example 下的 instance.properties</p>
<p><img src="https://brath.cloud/blogImg/image-20220629153511220.png" alt="image-20220629153511220"></p>
<p>修改完成后保存退出</p>
<p>接下来进入 bin 目录 sh <a target="_blank" rel="noopener" href="http://startUp.sh">startUp.sh</a> 启动 canal 服务端</p>
<h4 id="至此服务端的操作基本完成"><a class="markdownIt-Anchor" href="#至此服务端的操作基本完成">#</a> 至此服务端的操作基本完成</h4>
<p>Java 客户端操作<br>
首先引入 maven 依赖：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.otter<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>canal.client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.1.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>然后创建一个 canal 项目，使用 SpringBoot 构建，如图所示，创建 canal 包：</p>
<p><img src="C:/Users/Administrator/AppData/Roaming/Typora/typora-user-images/image-20220629153956493.png" alt="image-20220629153956493"></p>
<p>canal 工具类，仅供参考</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.brath.canal;</span><br><span class="line"><span class="keyword">import</span> java.awt.print.Printable;</span><br><span class="line"><span class="keyword">import</span> java.time.LocalDateTime;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> cn.brath.common.redis.service.TokenService;</span><br><span class="line"><span class="keyword">import</span> cn.brath.common.redis.util.RedisKeys;</span><br><span class="line"><span class="keyword">import</span> cn.brath.common.utils.AssertUtil;</span><br><span class="line"><span class="keyword">import</span> cn.brath.common.utils.UserTokenManager;</span><br><span class="line"><span class="keyword">import</span> cn.brath.entity.IvUser;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSONObject;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.otter.canal.client.CanalConnector;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.otter.canal.client.CanalConnectors;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.otter.canal.protocol.CanalEntry.*;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.otter.canal.protocol.Message;</span><br><span class="line"><span class="keyword">import</span> com.google.protobuf.InvalidProtocolBufferException;</span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.lang3.StringUtils;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.Logger;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.LoggerFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.print.attribute.standard.MediaPrintableArea;</span><br><span class="line"><span class="keyword">import</span> java.net.InetSocketAddress;</span><br><span class="line"><span class="keyword">import</span> java.time.ZoneId;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CanalClient</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * SLF4J日志</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">Logger</span> <span class="variable">logger</span> <span class="operator">=</span> LoggerFactory.getLogger(CanalClient.class);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">String</span> <span class="variable">host</span> <span class="operator">=</span> <span class="string">&quot;***.***.***.***&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">String</span> <span class="variable">port</span> <span class="operator">=</span> <span class="string">&quot;11111&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">String</span> <span class="variable">destination</span> <span class="operator">=</span> <span class="string">&quot;example&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 用户令牌业务接口</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> TokenService tokenService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">TokenServiceIn</span><span class="params">(TokenService tokenService)</span> &#123;</span><br><span class="line">        CanalClient.tokenService = tokenService;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * canal启动方法</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (!AssertUtil.isEmptys(host, port, destination)) &#123;</span><br><span class="line">            logger.error(<span class="string">&quot;canal客户端连接失败，当前服务端host：&#123;&#125;，port：&#123;&#125;，destination：&#123;&#125;&quot;</span>, host, port, destination);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">CanalConnector</span> <span class="variable">connector</span> <span class="operator">=</span> CanalConnectors.newSingleConnector(</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InetSocketAddress</span>(host, Integer.valueOf(port)), destination, <span class="string">&quot;&quot;</span>, <span class="string">&quot;&quot;</span></span><br><span class="line">        );</span><br><span class="line">        <span class="type">int</span> <span class="variable">batchSize</span> <span class="operator">=</span> <span class="number">1000</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//建立连接</span></span><br><span class="line">            connector.connect();</span><br><span class="line">            <span class="comment">//目标为全部表</span></span><br><span class="line">            connector.subscribe(<span class="string">&quot;.*\\..*&quot;</span>);</span><br><span class="line">            connector.rollback();</span><br><span class="line">            logger.info(<span class="string">&quot;canal客户端连接完成，当前服务端host：&#123;&#125;，port：&#123;&#125;，destination：&#123;&#125;&quot;</span>, host, port, destination);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">                    <span class="comment">//尝试从master那边拉去数据batchSize条记录，有多少取多少</span></span><br><span class="line">                    <span class="type">Message</span> <span class="variable">message</span> <span class="operator">=</span> connector.getWithoutAck(batchSize);</span><br><span class="line">                    <span class="type">long</span> <span class="variable">batchId</span> <span class="operator">=</span> message.getId();</span><br><span class="line">                    <span class="type">int</span> <span class="variable">size</span> <span class="operator">=</span> message.getEntries().size();</span><br><span class="line">                    <span class="keyword">if</span> (batchId == -<span class="number">1</span> || size == <span class="number">0</span>) &#123;</span><br><span class="line">                        Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        logger.info(<span class="string">&quot;同步任务进行中，检测到修改数据，执行同步Redis&quot;</span>);</span><br><span class="line">                        dataHandle(message.getEntries());</span><br><span class="line">                    &#125;</span><br><span class="line">                    connector.ack(batchId);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InvalidProtocolBufferException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            connector.disconnect();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 数据处理</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> entrys</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">dataHandle</span><span class="params">(List&lt;Entry&gt; entrys)</span> <span class="keyword">throws</span> InvalidProtocolBufferException &#123;</span><br><span class="line">        <span class="type">JSONObject</span> <span class="variable">beforeData</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="type">JSONObject</span> <span class="variable">afterData</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">for</span> (Entry entry : entrys) &#123;</span><br><span class="line">            <span class="keyword">if</span> (EntryType.ROWDATA.equals(entry.getEntryType())) &#123;</span><br><span class="line">                <span class="comment">//反序列化rowdata</span></span><br><span class="line">                <span class="type">RowChange</span> <span class="variable">rowChange</span> <span class="operator">=</span> RowChange.parseFrom(entry.getStoreValue());</span><br><span class="line">                <span class="comment">//获取数据集</span></span><br><span class="line">                List&lt;RowData&gt; rowDataList = rowChange.getRowDatasList();</span><br><span class="line">                <span class="comment">//获取数据遍历</span></span><br><span class="line">                <span class="keyword">for</span> (RowData rowData : rowDataList) &#123;</span><br><span class="line">                    afterData = <span class="keyword">new</span> <span class="title class_">JSONObject</span>();</span><br><span class="line">                    List&lt;Column&gt; afterColumnsList = rowData.getAfterColumnsList();</span><br><span class="line">                    <span class="keyword">for</span> (Column column : afterColumnsList) &#123;</span><br><span class="line">                        afterData.put(column.getName(), column.getValue());</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                </span><br><span class="line">                <span class="comment">//因为作者这里只做同步Redis，不考虑到操作类型，只需要覆盖相同键值数据</span></span><br><span class="line">                </span><br><span class="line">                <span class="comment">//写入Redis</span></span><br><span class="line">                executeRedisWarehousing(afterData);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 执行Redis用户数据入库</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> afterData</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">executeRedisWarehousing</span><span class="params">(JSONObject afterData)</span> &#123;</span><br><span class="line">        logger.info(<span class="string">&quot;开始执行Redis热更新入库同步Mysql -- &quot;</span>);</span><br><span class="line">		</span><br><span class="line">        <span class="keyword">do</span>...</span><br><span class="line">        </span><br><span class="line">        logger.info(<span class="string">&quot;入库完成&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="启动类使用"><a class="markdownIt-Anchor" href="#启动类使用">#</a> 启动类使用：</h3>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Application</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        SpringApplication.run(InterviewUserServiceApplication.class, args);</span><br><span class="line">        <span class="comment">//项目启动，执行canal客户端监听</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">CanalClient</span>().run();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            log.error(<span class="string">&quot; canal客户端监听 启动失败，原因可能是：&#123;&#125;&quot;</span>, e.getMessage());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>接下来启动项目运行，成功连接 canal 后我们尝试修改一个 mysql 的数据，发现在客户端成功完成了与 Redis 的同步操作</p>
<p><img src="https://brath.cloud/blogImg/image-20220629154454409.png" alt="image-20220629154454409"></p>
<h3 id="相关异常"><a class="markdownIt-Anchor" href="#相关异常">#</a> 相关异常：</h3>
<p>Canal 异常：</p>
<p>dump address /124.222.106.122:3306 has an error, retrying. caused by <a target="_blank" rel="noopener" href="http://java.la">java.la</a></p>
<p>解决办法：重启 Mysql，删除 example 下的 dat 后缀文件后重启 canal</p>
<p>其他：</p>
<p>​	是否开放端口 11111</p>
<p>​	mysql 是否连接成功，查看 logs/example/example.log</p>
<p>​	服务端与客户端是否连接成功，查看当前项目日志即可</p>
<h2 id="关于我"><a class="markdownIt-Anchor" href="#关于我">#</a> 关于我</h2>
<p>Brath 是一个热爱技术的 Java 程序猿，公众号「InterviewCoder」定期分享有趣有料的精品原创文章！</p>
<p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/%E4%BA%8C%E7%BB%B4%E7%A0%81plus.png" alt="InterviewCoder"></p>
<p>非常感谢各位人才能看到这里，原创不易，文章如果有帮助可以关注、点赞、分享或评论，这都是对我的莫大支持！</p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2021-04-01T18:28:37.000Z" title="2021/4/2 02:28:37">2021-04-02</time>发表</span><span class="level-item"><time dateTime="2020-07-03T23:40:08.000Z" title="2020/7/4 07:40:08">2020-07-04</time>更新</span><span class="level-item">9 分钟读完 (大约1332个字)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2021/04/02/%E3%80%90ELK%E3%80%91%E4%BD%BF%E7%94%A8Docker%E6%90%AD%E5%BB%BAELK/">【ELK】使用Docker搭建ELK</a></p><div class="content"><p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/%E6%89%AB%E7%A0%81_%E6%90%9C%E7%B4%A2%E8%81%94%E5%90%88%E4%BC%A0%E6%92%AD%E6%A0%B7%E5%BC%8F-%E6%A0%87%E5%87%86%E8%89%B2%E7%89%88.png" alt="InterviewCoder"></p>
<h3 id="文章目录"><a class="markdownIt-Anchor" href="#文章目录">#</a> 文章目录</h3>
<ul>
<li>
<ul>
<li><a href="#_1">概念：</a></li>
<li><a href="#elkdocker_7">安装 elk (这里通过 docker 进行安装)</a></li>
<li>
<ul>
<li>
<ul>
<li><a href="#es_8">安装 es</a></li>
<li><a href="#kikana_35">安装 kikana</a></li>
<li><a href="#logstash_59">安装 logstash</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="概念"><a class="markdownIt-Anchor" href="#概念">#</a> 概念：</h2>
<blockquote>
<p>那么，<a target="_blank" rel="noopener" href="https://so.csdn.net/so/search?q=ELK&amp;spm=1001.2101.3001.7020">ELK</a> 到底是什么呢？ “ELK” 是三个开源项目的首字母缩写，这三个项目分别是：Elasticsearch、Logstash 和 Kibana。Elasticsearch 是一个搜索和分析引擎。Logstash 是服务器端数据处理管道，能够同时从多个来源采集数据，转换数据，然后将数据发送到诸如 Elasticsearch 等 “存储库” 中。Kibana 则可以让用户在 Elasticsearch 中使用图形和图表对数据进行可视化</p>
</blockquote>
<ul>
<li>工作流程<br>
<img src="https://brath.oss-cn-shanghai.aliyuncs.com/pigo/18dbff4e772c4bff918a06fc22562782.png" alt="在这里插入图片描述"></li>
<li>在后续 elk 引入了 beats (数据采集器) 后被称为 Elastic Stack 或者 ELK</li>
</ul>
<h2 id="安装elk这里通过docker进行安装"><a class="markdownIt-Anchor" href="#安装elk这里通过docker进行安装">#</a> 安装 elk (这里通过 docker 进行安装)</h2>
<h4 id="安装es"><a class="markdownIt-Anchor" href="#安装es">#</a> 安装 es</h4>
<ul>
<li>在 dockerhub 上搜索 es<img src="https://brath.oss-cn-shanghai.aliyuncs.com/pigo/6f76e4d9d5504501902ef113cc4bbc69.png" alt="在这里插入图片描述"></li>
<li>找到需要的 es 版本<br>
<img src="https://brath.oss-cn-shanghai.aliyuncs.com/pigo/6d5331d1e29649c8b784fd82a01a078c.png" alt="在这里插入图片描述"></li>
<li>拉取 es 镜像 <code>docker pull elasticsearch:tag</code> <br>
<img src="https://brath.oss-cn-shanghai.aliyuncs.com/pigo/da59ef5b031243f094ef24340170bb99.png" alt="在这里插入图片描述"><br>
<img src="https://brath.oss-cn-shanghai.aliyuncs.com/pigo/44544fc5864a4db7a11b4864768446f4.png" alt="在这里插入图片描述"></li>
<li>在 dockerhub 官网上可以看到 es 的启动命令<br>
<img src="https://brath.oss-cn-shanghai.aliyuncs.com/pigo/d0a24c581d37472b9f6b51e2946902c3.png" alt="在这里插入图片描述"></li>
<li>先创建自定义 docker 网络 <code>docker network create elastic</code> ，默认是桥接模式<br>
<img src="https://brath.oss-cn-shanghai.aliyuncs.com/pigo/2e96d2e71e594a28bfbf5c14a7e50bbc.png" alt="在这里插入图片描述"></li>
<li>查看创建的网络<img src="https://brath.oss-cn-shanghai.aliyuncs.com/pigo/1335acab2ae14d908a9c70249c11d1a8.png" alt="在这里插入图片描述"></li>
<li>启动 es 镜像，这里我以单机的形式启动 <code>docker run -d --name elasticsearch --net elastic -p 9200:9200 -p 9300:9300 -e &quot;discovery.type=single-node&quot; elasticsearch:tag</code> <br>
<img src="https://brath.oss-cn-shanghai.aliyuncs.com/pigo/cab7b5b16f7444f98587b73977f5784f.png" alt="在这里插入图片描述"></li>
<li>启动之后访问 <code>localhost:9200</code> ，有数据返回说明启动成功，如下图<br>
<img src="https://brath.oss-cn-shanghai.aliyuncs.com/pigo/b007a9897a384d45b4f99719a8e80d2b.png" alt="在这里插入图片描述"></li>
<li>修改 es 配置，进入容器 <code>docker exec -it a804 /bin/sh</code> <br>
<img src="https://brath.oss-cn-shanghai.aliyuncs.com/pigo/f3b2629fdf69469eb752ce1b23d60ab5.png" alt="在这里插入图片描述"></li>
<li>在 <code>config</code>  目录下的 <code>elasticsearch.yml</code>  文件添加</li>
</ul>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">http.cors.enabled:</span> <span class="literal">true</span> </span><br><span class="line"><span class="attr">http.cors.allow-origin:</span> <span class="string">&quot;*&quot;</span></span><br><span class="line"><span class="number">12</span></span><br></pre></td></tr></table></figure>
<ul>
<li>修改完配置之后，退出容器并重启<br>
<img src="https://brath.oss-cn-shanghai.aliyuncs.com/pigo/18e0f04b59144d16bf0c19f730cbfe72.png" alt="在这里插入图片描述"></li>
</ul>
<h4 id="安装kikana"><a class="markdownIt-Anchor" href="#安装kikana">#</a> 安装 kikana</h4>
<ul>
<li>从 dockerhub 拉取与 es 对应版本的 kibana  <code>docker pull kibana:tag</code> <br>
<img src="https://brath.oss-cn-shanghai.aliyuncs.com/pigo/786540852f3848ef91b6dc9172c62e06.png" alt="在这里插入图片描述"></li>
<li>启动 kibana  <code>docker run --name kib-7.6 --net elastic -d -p 5601:5601 kibana:tag</code></li>
<li>启动之后访问<br>
<img src="https://brath.oss-cn-shanghai.aliyuncs.com/pigo/aed86ba45de34bbdb960c67a10eba2e1.png" alt="在这里插入图片描述"></li>
<li>出现上图是由于 kibanakibana.yml，默认的地址是 http://elasticsearch:9200, 需要修改为 es 服务 ip</li>
<li>进入到 es 容器里面 <code>docker -it 容器编号 /bin/sh</code> <br>
<img src="https://brath.oss-cn-shanghai.aliyuncs.com/pigo/30cda118f3b344b6ac611f143d8cb941.png" alt="在这里插入图片描述"></li>
<li>查看 es 的容器详情 <code>docker inspect a80402dbe9f5</code></li>
<li>找到网络详情，找到 es 服务的 ip 地址<br>
<img src="https://brath.oss-cn-shanghai.aliyuncs.com/pigo/810fc12347fd4c4fbb02cb2ca219e4d6.png" alt="在这里插入图片描述"></li>
<li>也可以通过 <code>docker inspect -f '&#123;&#123;range .NetworkSettings.Networks&#125;&#125;&#123;&#123;.IPAddress&#125;&#125;&#123;&#123;end&#125;&#125;' a804</code>  获取 ip<br>
<img src="https://brath.oss-cn-shanghai.aliyuncs.com/pigo/61ff14db933c4b4889fa6d6eb5d6d17d.png" alt="在这里插入图片描述"></li>
<li>进入到 kibana 容器，切换到 <code>/usr/share/kibana/config</code>  目录<br>
<img src="https://brath.oss-cn-shanghai.aliyuncs.com/pigo/41867b50de204c558b90c08d0fdd8e88.png" alt="在这里插入图片描述"></li>
<li>修改 kibana.yml 文件<br>
<img src="https://brath.oss-cn-shanghai.aliyuncs.com/pigo/0941ebe9bb9445aa9e715440a490e0a2.png" alt="在这里插入图片描述"><br>
<img src="https://brath.oss-cn-shanghai.aliyuncs.com/pigo/3f1b21a66c2b48a8bc46e391f39a1fa6.png" alt="在这里插入图片描述"></li>
<li>修改完 kibana.yml 之后重启 kibana 容器</li>
<li>访问 kibana <code>localhost:5601</code> <br>
<img src="https://brath.oss-cn-shanghai.aliyuncs.com/pigo/b179a708ace346fca404be4c1ada73ef.png" alt="在这里插入图片描述"><br>
<img src="https://brath.oss-cn-shanghai.aliyuncs.com/pigo/d0756690b86f4f57be7919f08210b388.png" alt="在这里插入图片描述"></li>
<li>到这里 kibana 就安装成功了</li>
</ul>
<h4 id="安装logstash"><a class="markdownIt-Anchor" href="#安装logstash">#</a> 安装<a target="_blank" rel="noopener" href="https://so.csdn.net/so/search?q=logstash&amp;spm=1001.2101.3001.7020"> logstash</a></h4>
<ul>
<li>从 dockerhub 拉取 logstash <code>docker pull logstash:7.6.2</code> <br>
<img src="https://brath.oss-cn-shanghai.aliyuncs.com/pigo/b1ec7cb4c13b48a188e45bcd0d125d58.png" alt="在这里插入图片描述"></li>
</ul>
<h2 id="关于我"><a class="markdownIt-Anchor" href="#关于我">#</a> 关于我</h2>
<p>Brath 是一个热爱技术的 Java 程序猿，公众号「InterviewCoder」定期分享有趣有料的精品原创文章！</p>
<p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/%E4%BA%8C%E7%BB%B4%E7%A0%81plus.png" alt="InterviewCoder"></p>
<p>非常感谢各位人才能看到这里，原创不易，文章如果有帮助可以关注、点赞、分享或评论，这都是对我的莫大支持！</p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2021-02-14T10:13:04.000Z" title="2021/2/14 18:13:04">2021-02-14</time>发表</span><span class="level-item"><time dateTime="2021-12-10T11:23:28.000Z" title="2021/12/10 19:23:28">2021-12-10</time>更新</span><span class="level-item">23 分钟读完 (大约3434个字)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2021/02/14/%E3%80%90Redis%E3%80%91SpringBoot+Redis%E5%AE%9E%E7%8E%B0%E9%AB%98%E6%80%A7%E8%83%BD%EF%BC%8C%E5%BC%BA%E6%94%AF%E6%8C%81%E7%9A%84%E7%82%B9%E8%B5%9E-%E6%9F%A5%E7%9C%8B%E6%94%B6%E8%97%8F%E6%B5%81%E7%A8%8B%E8%AE%BE%E8%AE%A1/">SpringBoot+Redis实现高性能，强支持的点赞-查看收藏流程设计</a></p><div class="content"><p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/%E6%89%AB%E7%A0%81_%E6%90%9C%E7%B4%A2%E8%81%94%E5%90%88%E4%BC%A0%E6%92%AD%E6%A0%B7%E5%BC%8F-%E6%A0%87%E5%87%86%E8%89%B2%E7%89%88.png" alt="InterviewCoder"></p>
<h1 id="springbootredis实现高性能强支持的点赞流程设计"><a class="markdownIt-Anchor" href="#springbootredis实现高性能强支持的点赞流程设计">#</a> SpringBoot+Redis 实现高性能，强支持的点赞流程设计</h1>
<h2 id="前言"><a class="markdownIt-Anchor" href="#前言">#</a> 前言</h2>
<p>本文基于 SpringCloudAlibaba, 用户发起点赞、取消点赞，后先存入 Redis 中，再每隔两小时从 Redis 读取点赞数据写入数据库中做持久化存储。</p>
<p>点赞功能在很多系统中都有，但别看功能小，想要做好需要考虑的东西还挺多的。</p>
<p>点赞、取消点赞是高频次的操作，若每次都读写数据库，大量的操作会影响数据库性能，所以需要做缓存。</p>
<p>至于多久从 Redis 取一次数据存到数据库中，根据项目的实际情况定吧，我是暂时设了两个小时。</p>
<p>项目需求需要查看都谁点赞了，所以要存储每个点赞的点赞人、被点赞人，不能简单的做计数。</p>
<h3 id="文章分四部分介绍"><a class="markdownIt-Anchor" href="#文章分四部分介绍">#</a> 文章分四部分介绍：</h3>
<ul>
<li>
<p>Redis 缓存设计及实现</p>
</li>
<li>
<p>数据库设计</p>
</li>
<li>
<p>数据库操作</p>
</li>
<li>
<p>开启定时任务持久化存储到数据库</p>
</li>
</ul>
<h2 id="一-redis-缓存设计及实现"><a class="markdownIt-Anchor" href="#一-redis-缓存设计及实现">#</a> 一、Redis 缓存设计及实现</h2>
<h3 id="11-redis-安装及运行"><a class="markdownIt-Anchor" href="#11-redis-安装及运行">#</a> 1.1 Redis 安装及运行</h3>
<p>Redis 安装请自行查阅相关教程。</p>
<p>说下 Docker 安装运行 Redis</p>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -d -p <span class="number">6379</span>:<span class="number">6379</span> redis:<span class="number">4.0</span><span class="number">.8</span></span><br></pre></td></tr></table></figure>
<p>如果已经安装了 Redis，打开命令行，输入启动 Redis 的命令</p>
<figure class="highlight vbscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">redis-<span class="built_in">server</span></span><br></pre></td></tr></table></figure>
<h3 id="12-redis-与-springboot-项目的整合"><a class="markdownIt-Anchor" href="#12-redis-与-springboot-项目的整合">#</a> 1.2 Redis 与 SpringBoot 项目的整合</h3>
<ol>
<li>在  <code>pom.xml</code>  中引入依赖</li>
</ol>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-data-redis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<ol>
<li>在启动类上添加注释  <code>@EnableCaching</code></li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableDiscoveryClient</span></span><br><span class="line"><span class="meta">@EnableSwagger2</span></span><br><span class="line"><span class="meta">@EnableFeignClients(basePackages = &quot;com.solo.coderiver.project.client&quot;)</span></span><br><span class="line"><span class="meta">@EnableCaching</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserApplication</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        SpringApplication.run(UserApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol>
<li>编写 Redis 配置类  <code>RedisConfig</code></li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.annotation.JsonAutoDetect;</span><br><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.annotation.PropertyAccessor;</span><br><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.databind.ObjectMapper;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.condition.ConditionalOnMissingBean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.connection.RedisConnectionFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.core.RedisTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.core.StringRedisTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.serializer.Jackson2JsonRedisSerializer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.net.UnknownHostException;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RedisConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@ConditionalOnMissingBean(name = &quot;redisTemplate&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> RedisTemplate&lt;String, Object&gt; <span class="title function_">redisTemplate</span><span class="params">(</span></span><br><span class="line"><span class="params">            RedisConnectionFactory redisConnectionFactory)</span></span><br><span class="line">            <span class="keyword">throws</span> UnknownHostException &#123;</span><br><span class="line"></span><br><span class="line">        Jackson2JsonRedisSerializer&lt;Object&gt; jackson2JsonRedisSerializer = <span class="keyword">new</span> <span class="title class_">Jackson2JsonRedisSerializer</span>&lt;Object&gt;(Object.class);</span><br><span class="line">        <span class="type">ObjectMapper</span> <span class="variable">om</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectMapper</span>();</span><br><span class="line">        om.setVisibility(PropertyAccessor.ALL, JsonAutoDetect.Visibility.ANY);</span><br><span class="line">        om.enableDefaultTyping(ObjectMapper.DefaultTyping.NON_FINAL);</span><br><span class="line">        jackson2JsonRedisSerializer.setObjectMapper(om);</span><br><span class="line"></span><br><span class="line">        RedisTemplate&lt;String, Object&gt; template = <span class="keyword">new</span> <span class="title class_">RedisTemplate</span>&lt;String, Object&gt;();</span><br><span class="line">        template.setConnectionFactory(redisConnectionFactory);</span><br><span class="line">        template.setKeySerializer(jackson2JsonRedisSerializer);</span><br><span class="line">        template.setValueSerializer(jackson2JsonRedisSerializer);</span><br><span class="line">        template.setHashKeySerializer(jackson2JsonRedisSerializer);</span><br><span class="line">        template.setHashValueSerializer(jackson2JsonRedisSerializer);</span><br><span class="line">        template.afterPropertiesSet();</span><br><span class="line">        <span class="keyword">return</span> template;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@ConditionalOnMissingBean(StringRedisTemplate.class)</span></span><br><span class="line">    <span class="keyword">public</span> StringRedisTemplate <span class="title function_">stringRedisTemplate</span><span class="params">(</span></span><br><span class="line"><span class="params">            RedisConnectionFactory redisConnectionFactory)</span></span><br><span class="line">            <span class="keyword">throws</span> UnknownHostException &#123;</span><br><span class="line">        <span class="type">StringRedisTemplate</span> <span class="variable">template</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringRedisTemplate</span>();</span><br><span class="line">        template.setConnectionFactory(redisConnectionFactory);</span><br><span class="line">        <span class="keyword">return</span> template;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>至此 Redis 在 SpringBoot 项目中的配置已经完成，可以愉快的使用了。</p>
<h3 id="13-redis-的数据结构类型"><a class="markdownIt-Anchor" href="#13-redis-的数据结构类型">#</a> 1.3 Redis 的数据结构类型</h3>
<p>Redis 可以存储键与 5 种不同数据结构类型之间的映射，这 5 种数据结构类型分别为 String（字符串）、List（列表）、Set（集合）、Hash（散列）和 Zset（有序集合）。</p>
<p>下面来对这 5 种数据结构类型作简单的介绍：</p>
<table>
<thead>
<tr>
<th>结构类型</th>
<th>结构存储的值</th>
<th>结构的读写能力</th>
</tr>
</thead>
<tbody>
<tr>
<td>String</td>
<td>可以是字符串、整数或者浮点数</td>
<td>对整个字符串或者字符串的其中一部分执行操作；对象和浮点数执行自增 (increment) 或者自减 (decrement)</td>
</tr>
<tr>
<td>List</td>
<td>一个链表，链表上的每个节点都包含了一个字符串</td>
<td>从链表的两端推入或者弹出元素；根据偏移量对链表进行修剪 (trim)；读取单个或者多个元素；根据值来查找或者移除元素</td>
</tr>
<tr>
<td>Set</td>
<td>包含字符串的无序收集器 (unorderedcollection)，并且被包含的每个字符串都是独一无二的、各不相同</td>
<td>添加、获取、移除单个元素；检查一个元素是否存在于某个集合中；计算交集、并集、差集；从集合里卖弄随机获取元素</td>
</tr>
<tr>
<td>Hash</td>
<td>包含键值对的无序散列表</td>
<td>添加、获取、移除单个键值对；获取所有键值对</td>
</tr>
<tr>
<td>Zset</td>
<td>字符串成员 (member) 与浮点数分值 (score) 之间的有序映射，元素的排列顺序由分值的大小决定</td>
<td>添加、获取、删除单个元素；根据分值范围 (range) 或者成员来获取元素</td>
</tr>
</tbody>
</table>
<h3 id="14-点赞数据在-redis-中的存储格式"><a class="markdownIt-Anchor" href="#14-点赞数据在-redis-中的存储格式">#</a> 1.4 点赞数据在 Redis 中的存储格式</h3>
<p>用 Redis 存储两种数据，一种是记录点赞人、被点赞人、点赞状态的数据，另一种是每个用户被点赞了多少次，做个简单的计数。</p>
<p>由于需要记录点赞人和被点赞人，还有点赞状态（点赞、取消点赞），还要固定时间间隔取出 Redis 中所有点赞数据，分析了下 Redis 数据格式中  <code>Hash</code>  最合适。</p>
<p>因为  <code>Hash</code>  里的数据都是存在一个键里，可以通过这个键很方便的把所有的点赞数据都取出。这个键里面的数据还可以存成键值对的形式，方便存入点赞人、被点赞人和点赞状态。</p>
<p>设点赞人的 id 为  <code>likedPostId</code> ，被点赞人的 id 为  <code>likedUserId</code>  ，点赞时状态为 1，取消点赞状态为 0。将点赞人 id 和被点赞人 id 作为键，两个 id 中间用  <code>::</code>   隔开，点赞状态作为值。</p>
<p>所以如果用户点赞，存储的键为： <code>likedUserId::likedPostId</code> ，对应的值为 1 。</p>
<p>取消点赞，存储的键为： <code>likedUserId::likedPostId</code> ，对应的值为 0 。</p>
<p>取数据时把键用  <code>::</code>  切开就得到了两个 id，也很方便。</p>
<h3 id="15-操作-redis"><a class="markdownIt-Anchor" href="#15-操作-redis">#</a> 1.5 操作 Redis</h3>
<p>Redis 各种数据格式的操作方法可以看看 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.jianshu.com%2Fp%2F7bf5dc61ca06%2F">这篇文章</a> ，写的非常好。</p>
<p>将具体操作方法封装到了  <code>RedisService</code>  接口里</p>
<blockquote>
<p>RedisService.java</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.solo.coderiver.user.dataobject.UserLike;</span><br><span class="line"><span class="keyword">import</span> com.solo.coderiver.user.dto.LikedCountDTO;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">RedisService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 点赞。状态为1</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> likedUserId</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> likedPostId</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">saveLiked2Redis</span><span class="params">(String likedUserId, String likedPostId)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 取消点赞。将状态改变为0</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> likedUserId</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> likedPostId</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">unlikeFromRedis</span><span class="params">(String likedUserId, String likedPostId)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 从Redis中删除一条点赞数据</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> likedUserId</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> likedPostId</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">deleteLikedFromRedis</span><span class="params">(String likedUserId, String likedPostId)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 该用户的点赞数加1</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> likedUserId</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">incrementLikedCount</span><span class="params">(String likedUserId)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 该用户的点赞数减1</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> likedUserId</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">decrementLikedCount</span><span class="params">(String likedUserId)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取Redis中存储的所有点赞数据</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    List&lt;UserLike&gt; <span class="title function_">getLikedDataFromRedis</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取Redis中存储的所有点赞数量</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    List&lt;LikedCountDTO&gt; <span class="title function_">getLikedCountFromRedis</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>实现类 RedisServiceImpl.java</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.solo.coderiver.user.dataobject.UserLike;</span><br><span class="line"><span class="keyword">import</span> com.solo.coderiver.user.dto.LikedCountDTO;</span><br><span class="line"><span class="keyword">import</span> com.solo.coderiver.user.enums.LikedStatusEnum;</span><br><span class="line"><span class="keyword">import</span> com.solo.coderiver.user.service.LikedService;</span><br><span class="line"><span class="keyword">import</span> com.solo.coderiver.user.service.RedisService;</span><br><span class="line"><span class="keyword">import</span> com.solo.coderiver.user.utils.RedisKeyUtils;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.core.Cursor;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.core.RedisTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.core.ScanOptions;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RedisServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">RedisService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    RedisTemplate redisTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    LikedService likedService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">saveLiked2Redis</span><span class="params">(String likedUserId, String likedPostId)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> RedisKeyUtils.getLikedKey(likedUserId, likedPostId);</span><br><span class="line">        redisTemplate.opsForHash().put(RedisKeyUtils.MAP_KEY_USER_LIKED, key, LikedStatusEnum.LIKE.getCode());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">unlikeFromRedis</span><span class="params">(String likedUserId, String likedPostId)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> RedisKeyUtils.getLikedKey(likedUserId, likedPostId);</span><br><span class="line">        redisTemplate.opsForHash().put(RedisKeyUtils.MAP_KEY_USER_LIKED, key, LikedStatusEnum.UNLIKE.getCode());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">deleteLikedFromRedis</span><span class="params">(String likedUserId, String likedPostId)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> RedisKeyUtils.getLikedKey(likedUserId, likedPostId);</span><br><span class="line">        redisTemplate.opsForHash().delete(RedisKeyUtils.MAP_KEY_USER_LIKED, key);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">incrementLikedCount</span><span class="params">(String likedUserId)</span> &#123;</span><br><span class="line">        redisTemplate.opsForHash().increment(RedisKeyUtils.MAP_KEY_USER_LIKED_COUNT, likedUserId, <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">decrementLikedCount</span><span class="params">(String likedUserId)</span> &#123;</span><br><span class="line">        redisTemplate.opsForHash().increment(RedisKeyUtils.MAP_KEY_USER_LIKED_COUNT, likedUserId, -<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> List&lt;UserLike&gt; <span class="title function_">getLikedDataFromRedis</span><span class="params">()</span> &#123;</span><br><span class="line">        Cursor&lt;Map.Entry&lt;Object, Object&gt;&gt; cursor = redisTemplate.opsForHash().scan(RedisKeyUtils.MAP_KEY_USER_LIKED, ScanOptions.NONE);</span><br><span class="line">        List&lt;UserLike&gt; list = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        <span class="keyword">while</span> (cursor.hasNext())&#123;</span><br><span class="line">            Map.Entry&lt;Object, Object&gt; entry = cursor.next();</span><br><span class="line">            <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> (String) entry.getKey();</span><br><span class="line">            <span class="comment">//分离出 likedUserId，likedPostId</span></span><br><span class="line">            String[] split = key.split(<span class="string">&quot;::&quot;</span>);</span><br><span class="line">            <span class="type">String</span> <span class="variable">likedUserId</span> <span class="operator">=</span> split[<span class="number">0</span>];</span><br><span class="line">            <span class="type">String</span> <span class="variable">likedPostId</span> <span class="operator">=</span> split[<span class="number">1</span>];</span><br><span class="line">            <span class="type">Integer</span> <span class="variable">value</span> <span class="operator">=</span> (Integer) entry.getValue();</span><br><span class="line"></span><br><span class="line">            <span class="comment">//组装成 UserLike 对象</span></span><br><span class="line">            <span class="type">UserLike</span> <span class="variable">userLike</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UserLike</span>(likedUserId, likedPostId, value);</span><br><span class="line">            list.add(userLike);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//存到 list 后从 Redis 中删除</span></span><br><span class="line">            redisTemplate.opsForHash().delete(RedisKeyUtils.MAP_KEY_USER_LIKED, key);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> list;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> List&lt;LikedCountDTO&gt; <span class="title function_">getLikedCountFromRedis</span><span class="params">()</span> &#123;</span><br><span class="line">        Cursor&lt;Map.Entry&lt;Object, Object&gt;&gt; cursor = redisTemplate.opsForHash().scan(RedisKeyUtils.MAP_KEY_USER_LIKED_COUNT, ScanOptions.NONE);</span><br><span class="line">        List&lt;LikedCountDTO&gt; list = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        <span class="keyword">while</span> (cursor.hasNext())&#123;</span><br><span class="line">            Map.Entry&lt;Object, Object&gt; map = cursor.next();</span><br><span class="line">            <span class="comment">//将点赞数量存储在 LikedCountDT</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> (String)map.getKey();</span><br><span class="line">            <span class="type">LikedCountDTO</span> <span class="variable">dto</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">LikedCountDTO</span>(key, (Integer) map.getValue());</span><br><span class="line">            list.add(dto);</span><br><span class="line">            <span class="comment">//从Redis中删除这条记录</span></span><br><span class="line">            redisTemplate.opsForHash().delete(RedisKeyUtils.MAP_KEY_USER_LIKED_COUNT, key);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> list;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>用到的工具类和枚举类</p>
<blockquote>
<p>RedisKeyUtils, 用于根据一定规则生成 key</p>
</blockquote>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RedisKeyUtils</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//保存用户点赞数据的key</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> final <span class="title class_">String</span> <span class="variable constant_">MAP_KEY_USER_LIKED</span> = <span class="string">&quot;MAP_USER_LIKED&quot;</span>;</span><br><span class="line">    <span class="comment">//保存用户被点赞数量的key</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> final <span class="title class_">String</span> <span class="variable constant_">MAP_KEY_USER_LIKED_COUNT</span> = <span class="string">&quot;MAP_USER_LIKED_COUNT&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 拼接被点赞的用户id和点赞的人的id作为key。格式 222222::333333</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> likedUserId 被点赞的人id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> likedPostId 点赞的人的id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="title class_">String</span> <span class="title function_">getLikedKey</span>(<span class="params"><span class="built_in">String</span> likedUserId, <span class="built_in">String</span> likedPostId</span>)&#123;</span><br><span class="line">        <span class="title class_">StringBuilder</span> builder = <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line">        builder.<span class="title function_">append</span>(likedUserId);</span><br><span class="line">        builder.<span class="title function_">append</span>(<span class="string">&quot;::&quot;</span>);</span><br><span class="line">        builder.<span class="title function_">append</span>(likedPostId);</span><br><span class="line">        <span class="keyword">return</span> builder.<span class="title function_">toString</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>LikedStatusEnum 用户点赞状态的枚举类</p>
</blockquote>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.solo.coderiver.user.enums;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.Getter;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 用户点赞的状态</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Getter</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> LikedStatusEnum &#123;</span><br><span class="line">    LIKE(<span class="number">1</span>, <span class="string">&quot;点赞&quot;</span>),</span><br><span class="line">    UNLIKE(<span class="number">0</span>, <span class="string">&quot;取消点赞/未点赞&quot;</span>),</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Integer code;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String msg;</span><br><span class="line"></span><br><span class="line">    LikedStatusEnum(Integer code, String msg) &#123;</span><br><span class="line">        <span class="keyword">this</span>.code = code;</span><br><span class="line">        <span class="keyword">this</span>.msg = msg;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="二-数据库设计"><a class="markdownIt-Anchor" href="#二-数据库设计">#</a> 二、数据库设计</h2>
<p>数据库表中至少要包含三个字段：被点赞用户 id，点赞用户 id，点赞状态。再加上主键 id，创建时间，修改时间就行了。</p>
<p>建表语句</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">create table <span class="string">`user_like`</span>(</span><br><span class="line">	<span class="string">`id`</span> int not <span class="literal">null</span> auto_increment,</span><br><span class="line">	<span class="string">`liked_user_id`</span> <span class="title function_">varchar</span>(<span class="number">32</span>) not <span class="literal">null</span> comment <span class="string">&#x27;被点赞的用户id&#x27;</span>,</span><br><span class="line">	<span class="string">`liked_post_id`</span> <span class="title function_">varchar</span>(<span class="number">32</span>) not <span class="literal">null</span> comment <span class="string">&#x27;点赞的用户id&#x27;</span>,</span><br><span class="line">	<span class="string">`status`</span> <span class="title function_">tinyint</span>(<span class="number">1</span>) <span class="keyword">default</span> <span class="string">&#x27;1&#x27;</span> comment <span class="string">&#x27;点赞状态，0取消，1点赞&#x27;</span>,</span><br><span class="line">	<span class="string">`create_time`</span> timestamp not <span class="literal">null</span> <span class="keyword">default</span> current_timestamp comment <span class="string">&#x27;创建时间&#x27;</span>,</span><br><span class="line">  <span class="string">`update_time`</span> timestamp not <span class="literal">null</span> <span class="keyword">default</span> current_timestamp on update current_timestamp comment <span class="string">&#x27;修改时间&#x27;</span>,</span><br><span class="line">	primary <span class="title function_">key</span>(<span class="string">`id`</span>),</span><br><span class="line">	<span class="variable constant_">INDEX</span> <span class="string">`liked_user_id`</span>(<span class="string">`liked_user_id`</span>),</span><br><span class="line">	<span class="variable constant_">INDEX</span> <span class="string">`liked_post_id`</span>(<span class="string">`liked_post_id`</span>)</span><br><span class="line">) comment <span class="string">&#x27;用户点赞表&#x27;</span>;</span><br></pre></td></tr></table></figure>
<p>对应的对象  <code>UserLike</code></p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.solo.coderiver.user.enums.LikedStatusEnum;</span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.persistence.Entity;</span><br><span class="line"><span class="keyword">import</span> javax.persistence.GeneratedValue;</span><br><span class="line"><span class="keyword">import</span> javax.persistence.GenerationType;</span><br><span class="line"><span class="keyword">import</span> javax.persistence.Id;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 用户点赞表</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Entity</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserLike</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//主键id</span></span><br><span class="line">    <span class="meta">@Id</span></span><br><span class="line">    <span class="meta">@GeneratedValue(strategy = GenerationType.IDENTITY)</span></span><br><span class="line">    <span class="keyword">private</span> Integer id;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//被点赞的用户的id</span></span><br><span class="line">    <span class="keyword">private</span> String likedUserId;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//点赞的用户的id</span></span><br><span class="line">    <span class="keyword">private</span> String likedPostId;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//点赞的状态.默认未点赞</span></span><br><span class="line">    <span class="keyword">private</span> Integer status = LikedStatusEnum.UNLIKE.getCode();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> UserLike() &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> UserLike(String likedUserId, String likedPostId, Integer status) &#123;</span><br><span class="line">        <span class="keyword">this</span>.likedUserId = likedUserId;</span><br><span class="line">        <span class="keyword">this</span>.likedPostId = likedPostId;</span><br><span class="line">        <span class="keyword">this</span>.status = status;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="三-数据库操作"><a class="markdownIt-Anchor" href="#三-数据库操作">#</a> 三、数据库操作</h2>
<p>操作数据库同样封装在接口中</p>
<blockquote>
<p>LikedService</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.solo.coderiver.user.dataobject.UserLike;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.domain.Page;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.domain.Pageable;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">LikedService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 保存点赞记录</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> userLike</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    UserLike <span class="title function_">save</span><span class="params">(UserLike userLike)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 批量保存或修改</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> list</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    List&lt;UserLike&gt; <span class="title function_">saveAll</span><span class="params">(List&lt;UserLike&gt; list)</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 根据被点赞人的id查询点赞列表（即查询都谁给这个人点赞过）</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> likedUserId 被点赞人的id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> pageable</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    Page&lt;UserLike&gt; <span class="title function_">getLikedListByLikedUserId</span><span class="params">(String likedUserId, Pageable pageable)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 根据点赞人的id查询点赞列表（即查询这个人都给谁点赞过）</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> likedPostId</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> pageable</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    Page&lt;UserLike&gt; <span class="title function_">getLikedListByLikedPostId</span><span class="params">(String likedPostId, Pageable pageable)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 通过被点赞人和点赞人id查询是否存在点赞记录</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> likedUserId</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> likedPostId</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    UserLike <span class="title function_">getByLikedUserIdAndLikedPostId</span><span class="params">(String likedUserId, String likedPostId)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 将Redis里的点赞数据存入数据库中</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">transLikedFromRedis2DB</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 将Redis中的点赞数量数据存入数据库</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">transLikedCountFromRedis2DB</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>LikedServiceImpl 实现类</p>
</blockquote>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.<span class="property">solo</span>.<span class="property">coderiver</span>.<span class="property">user</span>.<span class="property">dataobject</span>.<span class="property">UserInfo</span>;</span><br><span class="line"><span class="keyword">import</span> com.<span class="property">solo</span>.<span class="property">coderiver</span>.<span class="property">user</span>.<span class="property">dataobject</span>.<span class="property">UserLike</span>;</span><br><span class="line"><span class="keyword">import</span> com.<span class="property">solo</span>.<span class="property">coderiver</span>.<span class="property">user</span>.<span class="property">dto</span>.<span class="property">LikedCountDTO</span>;</span><br><span class="line"><span class="keyword">import</span> com.<span class="property">solo</span>.<span class="property">coderiver</span>.<span class="property">user</span>.<span class="property">enums</span>.<span class="property">LikedStatusEnum</span>;</span><br><span class="line"><span class="keyword">import</span> com.<span class="property">solo</span>.<span class="property">coderiver</span>.<span class="property">user</span>.<span class="property">repository</span>.<span class="property">UserLikeRepository</span>;</span><br><span class="line"><span class="keyword">import</span> com.<span class="property">solo</span>.<span class="property">coderiver</span>.<span class="property">user</span>.<span class="property">service</span>.<span class="property">LikedService</span>;</span><br><span class="line"><span class="keyword">import</span> com.<span class="property">solo</span>.<span class="property">coderiver</span>.<span class="property">user</span>.<span class="property">service</span>.<span class="property">RedisService</span>;</span><br><span class="line"><span class="keyword">import</span> com.<span class="property">solo</span>.<span class="property">coderiver</span>.<span class="property">user</span>.<span class="property">service</span>.<span class="property">UserService</span>;</span><br><span class="line"><span class="keyword">import</span> lombok.<span class="property">extern</span>.<span class="property">slf4j</span>.<span class="property">Slf4j</span>;</span><br><span class="line"><span class="keyword">import</span> org.<span class="property">springframework</span>.<span class="property">beans</span>.<span class="property">factory</span>.<span class="property">annotation</span>.<span class="property">Autowired</span>;</span><br><span class="line"><span class="keyword">import</span> org.<span class="property">springframework</span>.<span class="property">data</span>.<span class="property">domain</span>.<span class="property">Page</span>;</span><br><span class="line"><span class="keyword">import</span> org.<span class="property">springframework</span>.<span class="property">data</span>.<span class="property">domain</span>.<span class="property">Pageable</span>;</span><br><span class="line"><span class="keyword">import</span> org.<span class="property">springframework</span>.<span class="property">stereotype</span>.<span class="property">Service</span>;</span><br><span class="line"><span class="keyword">import</span> org.<span class="property">springframework</span>.<span class="property">transaction</span>.<span class="property">annotation</span>.<span class="property">Transactional</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.<span class="property">util</span>.<span class="property">List</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LikedServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">LikedService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="title class_">UserLikeRepository</span> likeRepository;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="title class_">RedisService</span> redisService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="title class_">UserService</span> userService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="meta">@Transactional</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title class_">UserLike</span> <span class="title function_">save</span>(<span class="params">UserLike userLike</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> likeRepository.<span class="title function_">save</span>(userLike);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="meta">@Transactional</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title class_">List</span>&lt;<span class="title class_">UserLike</span>&gt; <span class="title function_">saveAll</span>(<span class="params">List&lt;UserLike&gt; list</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> likeRepository.<span class="title function_">saveAll</span>(list);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title class_">Page</span>&lt;<span class="title class_">UserLike</span>&gt; <span class="title function_">getLikedListByLikedUserId</span>(<span class="params"><span class="built_in">String</span> likedUserId, Pageable pageable</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> likeRepository.<span class="title function_">findByLikedUserIdAndStatus</span>(likedUserId, <span class="title class_">LikedStatusEnum</span>.<span class="property">LIKE</span>.<span class="title function_">getCode</span>(), pageable);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title class_">Page</span>&lt;<span class="title class_">UserLike</span>&gt; <span class="title function_">getLikedListByLikedPostId</span>(<span class="params"><span class="built_in">String</span> likedPostId, Pageable pageable</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> likeRepository.<span class="title function_">findByLikedPostIdAndStatus</span>(likedPostId, <span class="title class_">LikedStatusEnum</span>.<span class="property">LIKE</span>.<span class="title function_">getCode</span>(), pageable);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title class_">UserLike</span> <span class="title function_">getByLikedUserIdAndLikedPostId</span>(<span class="params"><span class="built_in">String</span> likedUserId, <span class="built_in">String</span> likedPostId</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> likeRepository.<span class="title function_">findByLikedUserIdAndLikedPostId</span>(likedUserId, likedPostId);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="meta">@Transactional</span></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">void</span> <span class="title function_">transLikedFromRedis2DB</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="title class_">List</span>&lt;<span class="title class_">UserLike</span>&gt; list = redisService.<span class="title function_">getLikedDataFromRedis</span>();</span><br><span class="line">        <span class="keyword">for</span> (<span class="title class_">UserLike</span> like : list) &#123;</span><br><span class="line">            <span class="title class_">UserLike</span> ul = <span class="title function_">getByLikedUserIdAndLikedPostId</span>(like.<span class="title function_">getLikedUserId</span>(), like.<span class="title function_">getLikedPostId</span>());</span><br><span class="line">            <span class="keyword">if</span> (ul == <span class="literal">null</span>)&#123;</span><br><span class="line">                <span class="comment">//没有记录，直接存入</span></span><br><span class="line">                <span class="title function_">save</span>(like);</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                <span class="comment">//有记录，需要更新</span></span><br><span class="line">                ul.<span class="title function_">setStatus</span>(like.<span class="title function_">getStatus</span>());</span><br><span class="line">                <span class="title function_">save</span>(ul);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="meta">@Transactional</span></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">void</span> <span class="title function_">transLikedCountFromRedis2DB</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="title class_">List</span>&lt;<span class="title class_">LikedCountDTO</span>&gt; list = redisService.<span class="title function_">getLikedCountFromRedis</span>();</span><br><span class="line">        <span class="keyword">for</span> (<span class="title class_">LikedCountDTO</span> dto : list) &#123;</span><br><span class="line">            <span class="title class_">UserInfo</span> user = userService.<span class="title function_">findById</span>(dto.<span class="title function_">getId</span>());</span><br><span class="line">            <span class="comment">//点赞数量属于无关紧要的操作，出错无需抛异常</span></span><br><span class="line">            <span class="keyword">if</span> (user != <span class="literal">null</span>)&#123;</span><br><span class="line">                <span class="title class_">Integer</span> likeNum = user.<span class="title function_">getLikeNum</span>() + dto.<span class="title function_">getCount</span>();</span><br><span class="line">                user.<span class="title function_">setLikeNum</span>(likeNum);</span><br><span class="line">                <span class="comment">//更新点赞数量</span></span><br><span class="line">                userService.<span class="title function_">updateInfo</span>(user);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>数据库的操作就这些，主要还是增删改查。</p>
<h2 id="四-开启定时任务持久化存储到数据库"><a class="markdownIt-Anchor" href="#四-开启定时任务持久化存储到数据库">#</a> 四、开启定时任务持久化存储到数据库</h2>
<p>定时任务  <code>Quartz</code>  很强大，就用它了。</p>
<p><code>Quartz</code>  使用步骤：</p>
<ol>
<li>添加依赖</li>
</ol>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-quartz<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>
<ol>
<li>编写配置文件</li>
</ol>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.solo.coderiver.user.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.solo.coderiver.user.task.LikeTask;</span><br><span class="line"><span class="keyword">import</span> org.quartz.*;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.<span class="keyword">annotation</span>.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.<span class="keyword">annotation</span>.Configuration;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">QuartzConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> static <span class="keyword">final</span> String LIKE_TASK_IDENTITY = <span class="string">&quot;LikeTaskQuartz&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> JobDetail quartzDetail()&#123;</span><br><span class="line">        <span class="keyword">return</span> JobBuilder.newJob(LikeTask.<span class="keyword">class</span>).withIdentity(LIKE_TASK_IDENTITY).storeDurably().build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Trigger quartzTrigger()&#123;</span><br><span class="line">        SimpleScheduleBuilder scheduleBuilder = SimpleScheduleBuilder.simpleSchedule()</span><br><span class="line"><span class="comment">//                .withIntervalInSeconds(10)  //设置时间周期单位秒</span></span><br><span class="line">                .withIntervalInHours(<span class="number">2</span>)  <span class="comment">//两个小时执行一次</span></span><br><span class="line">                .repeatForever();</span><br><span class="line">        <span class="keyword">return</span> TriggerBuilder.newTrigger().forJob(quartzDetail())</span><br><span class="line">                .withIdentity(LIKE_TASK_IDENTITY)</span><br><span class="line">                .withSchedule(scheduleBuilder)</span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol>
<li>编写执行任务的类继承自  <code>QuartzJobBean</code></li>
</ol>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.solo.coderiver.user.task;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.solo.coderiver.user.service.<span class="type">LikedService</span>;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.<span class="type">Slf4j</span>;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.lang.time.<span class="type">DateUtils</span>;</span><br><span class="line"><span class="keyword">import</span> org.quartz.<span class="type">JobExecutionContext</span>;</span><br><span class="line"><span class="keyword">import</span> org.quartz.<span class="type">JobExecutionException</span>;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.<span class="type">Autowired</span>;</span><br><span class="line"><span class="keyword">import</span> org.springframework.scheduling.quartz.<span class="type">QuartzJobBean</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.text.<span class="type">SimpleDateFormat</span>;</span><br><span class="line"><span class="keyword">import</span> java.util.<span class="type">Date</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 点赞的定时任务</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line">public <span class="class"><span class="keyword">class</span> <span class="title">LikeTask</span> <span class="keyword">extends</span> <span class="title">QuartzJobBean</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="type">LikedService</span> likedService;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">SimpleDateFormat</span> sdf = <span class="keyword">new</span> <span class="type">SimpleDateFormat</span>(<span class="string">&quot;yyyy-MM-dd HH:mm:ss&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> void executeInternal(<span class="type">JobExecutionContext</span> jobExecutionContext) <span class="keyword">throws</span> <span class="type">JobExecutionException</span> &#123;</span><br><span class="line"></span><br><span class="line">        log.info(<span class="string">&quot;LikeTask-------- &#123;&#125;&quot;</span>, sdf.format(<span class="keyword">new</span> <span class="type">Date</span>()));</span><br><span class="line"></span><br><span class="line">        <span class="comment">//将 Redis 里的点赞信息同步到数据库里</span></span><br><span class="line">        likedService.transLikedFromRedis2DB();</span><br><span class="line">        likedService.transLikedCountFromRedis2DB();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>在定时任务中直接调用  <code>LikedService</code>  封装的方法完成数据同步。</p>
<h2 id="关于我"><a class="markdownIt-Anchor" href="#关于我">#</a> 关于我</h2>
<p>Brath 是一个热爱技术的 Java 程序猿，公众号「InterviewCoder」定期分享有趣有料的精品原创文章！</p>
<p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/%E4%BA%8C%E7%BB%B4%E7%A0%81plus.png" alt="InterviewCoder"></p>
<p>非常感谢各位人才能看到这里，原创不易，文章如果有帮助可以关注、点赞、分享或评论，这都是对我的莫大支持！</p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2021-02-04T03:52:32.000Z" title="2021/2/4 11:52:32">2021-02-04</time>发表</span><span class="level-item"><time dateTime="2022-12-04T07:02:21.000Z" title="2022/12/4 15:02:21">2022-12-04</time>更新</span><span class="level-item">1 小时读完 (大约11024个字)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2021/02/04/%E3%80%90Activiti%E3%80%91Java%E5%B7%A5%E4%BD%9C%E6%B5%81%E5%BC%95%E6%93%8E%20Activiti%20%E4%B8%87%E5%AD%97%E8%AF%A6%E7%BB%86%E5%85%A5%E9%97%A8/">【Activiti】Java工作流引擎 Activiti 万字详细入门</a></p><div class="content"><p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/%E6%89%AB%E7%A0%81_%E6%90%9C%E7%B4%A2%E8%81%94%E5%90%88%E4%BC%A0%E6%92%AD%E6%A0%B7%E5%BC%8F-%E6%A0%87%E5%87%86%E8%89%B2%E7%89%88.png" alt="InterviewCoder"></p>
<h1 id="activitijava工作流引擎-activiti-万字详细入门"><a class="markdownIt-Anchor" href="#activitijava工作流引擎-activiti-万字详细入门">#</a> 【Activiti】Java 工作流引擎 Activiti 万字详细入门</h1>
<h1 id="activiti7"><a class="markdownIt-Anchor" href="#activiti7">#</a> Activiti7</h1>
<h1 id="一-工作流介绍"><a class="markdownIt-Anchor" href="#一-工作流介绍">#</a> 一、工作流介绍</h1>
<h2 id="11-概念"><a class="markdownIt-Anchor" href="#11-概念">#</a> 1.1 概念</h2>
<p>工作流 (Workflow)，就是通过计算机对业务流程自动化执行管理。它主要解决的是 “使在多个参与者之间按照某种预定义的规则自动进行传递文档、信息或任务的过程，从而实现某个预期的业务目标，或者促使此目标的实现”。</p>
<h2 id="12-工作流系统"><a class="markdownIt-Anchor" href="#12-工作流系统">#</a> 1.2 工作流系统</h2>
<p>一个软件系统中具有工作流的功能，我们把它称为工作流系统，一个系统中工作流的功能是什么？就是对系统的业务流程进行自动化管理，所以工作流是建立在业务流程的基础上，所以一个软件的系统核心根本上还是系统的业务流程，工作流只是协助进行业务流程管理。即使没有工作流业务系统也可以开发运行，只不过有了工作流可以更好的管理业务流程，提高系统的可扩展性。</p>
<h2 id="13-适用行业"><a class="markdownIt-Anchor" href="#13-适用行业">#</a> 1.3 适用行业</h2>
<p>消费品行业，制造业，电信服务业，银证险等金融服务业，物流服务业，物业服务业，物业管理，大中型进出口贸易公司，政府事业机构，研究院所及教育服务业等，特别是大的跨国企业和集团公司。</p>
<h2 id="14-具体应用"><a class="markdownIt-Anchor" href="#14-具体应用">#</a> 1.4 具体应用</h2>
<p>1、关键业务流程：订单、报价处理、合同审核、客户电话处理、供应链管理等</p>
<p>2、行政管理类：出差申请、加班申请、请假申请、用车申请、各种办公用品申请、购买申请、日报周报等凡是原来手工流转处理的行政表单。</p>
<p>3、人事管理类：员工培训安排、绩效考评、职位变动处理、员工档案信息管理等。</p>
<p>4、财务相关类：付款请求、应收款处理、日常报销处理、出差报销、预算和计划申请等。</p>
<p>5、客户服务类：客户信息管理、客户投诉、请求处理、售后服务管理等。</p>
<p>6、特殊服务类：ISO 系列对应流程、质量管理对应流程、产品数据信息管理、贸易公司报关处理、物流公司货物跟踪处理等各种通过表单逐步手工流转完成的任务均可应用工作流软件自动规范地实施。</p>
<h2 id="15-实现方式"><a class="markdownIt-Anchor" href="#15-实现方式">#</a> 1.5 实现方式</h2>
<p>在没有专门的工作流引擎之前，我们之前为了实现流程控制，通常的做法就是采用状态字段的值来跟踪流程的变化情况。这样不同角色的用户，通过状态字段的取值来决定记录是否显示。</p>
<p>针对有权限可以查看的记录，当前用户根据自己的角色来决定审批是否合格的操作。如果合格将状态字段设置一个值，来代表合格；当然如果不合格也需要设置一个值来代表不合格的情况。</p>
<p>这是一种最为原始的方式。通过状态字段虽然做到了流程控制，但是当我们的流程发生变更的时候，这种方式所编写的代码也要进行调整。</p>
<p>那么有没有专业的方式来实现工作流的管理呢？并且可以做到业务流程变化之后，我们的程序可以不用改变，如果可以实现这样的效果，那么我们的业务系统的适应能力就得到了极大提升。</p>
<h1 id="二-activiti7概述"><a class="markdownIt-Anchor" href="#二-activiti7概述">#</a> 二、Activiti7 概述</h1>
<h2 id="21-介绍"><a class="markdownIt-Anchor" href="#21-介绍">#</a> 2.1 介绍</h2>
<p>Alfresco 软件在 2010 年 5 月 17 日宣布 Activiti 业务流程管理（BPM）开源项目的正式启动，其首席架构师由业务流程管理 BPM 的专家 Tom Baeyens 担任，Tom Baeyens 就是原来 jbpm 的架构师，而 jbpm 是一个非常有名的工作流引擎，当然 activiti 也是一个工作流引擎。</p>
<p>Activiti 是一个工作流引擎， activiti 可以将业务系统中复杂的业务流程抽取出来，使用专门的建模语言 BPMN2.0 进行定义，业务流程按照预先定义的流程进行执行，实现了系统的流程由 activiti 进行管理，减少业务系统由于流程变更进行系统升级改造的工作量，从而提高系统的健壮性，同时也减少了系统开发维护成本。</p>
<p>官方网站：<a target="_blank" rel="noopener" href="https://www.activiti.org/">https://www.activiti.org/</a></p>
<p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/6d5fa212cb5c4186af366a6af2359a80.png" alt="img"></p>
<p>经历的版本:</p>
<p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/b2b6a0483819682db174c2d0bcaacd31.png" alt="img"></p>
<p>目前最新版本：Activiti7.0.0.Beta</p>
<h3 id="211-bpm"><a class="markdownIt-Anchor" href="#211-bpm">#</a> 2.1.1 BPM</h3>
<p>BPM（Business Process Management），即业务流程管理，是一种规范化的构造端到端的业务流程，以持续的提高组织业务效率。常见商业管理教育如 EMBA、MBA 等均将 BPM 包含在内。</p>
<h3 id="212-bpm软件"><a class="markdownIt-Anchor" href="#212-bpm软件">#</a> 2.1.2 BPM 软件</h3>
<p>BPM 软件就是根据企业中业务环境的变化，推进人与人之间、人与系统之间以及系统与系统之间的整合及调整的经营方法与解决方案的 IT 工具。</p>
<p>通过 BPM 软件对企业内部及外部的业务流程的整个生命周期进行建模、自动化、管理监控和优化，使企业成本降低，利润得以大幅提升。</p>
<p>BPM 软件在企业中应用领域广泛，凡是有业务流程的地方都可以 BPM 软件进行管理，比如企业人事办公管理、采购流程管理、公文审批流程管理、财务管理等。</p>
<h3 id="213-bpmn"><a class="markdownIt-Anchor" href="#213-bpmn">#</a> 2.1.3 BPMN</h3>
<p>BPMN（Business Process Model AndNotation）- 业务流程模型和符号 是由 BPMI（BusinessProcess Management Initiative）开发的一套标准的业务流程建模符号，使用 BPMN 提供的符号可以创建业务流程。</p>
<p>2004 年 5 月发布了 BPMN1.0 规范.BPMI 于 2005 年 9 月并入 OMG（The Object Management Group 对象管理组织) 组织。OMG 于 2011 年 1 月发布 BPMN2.0 的最终版本。</p>
<p>具体发展历史如下:</p>
<p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/4a5c9b0e87bab71979a722ea5967d1df.png" alt="img"></p>
<p>BPMN 是目前被各 BPM 厂商广泛接受的 BPM 标准。Activiti 就是使用 BPMN 2.0 进行流程建模、流程执行管理，它包括很多的建模符号，比如：</p>
<p>Event</p>
<p>用一个圆圈表示，它是流程中运行过程中发生的事情。</p>
<p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/c62d43f73620718b749276dd6e9c8c53.png" alt="img"></p>
<p>活动用圆角矩形表示，一个流程由一个活动或多个活动组成</p>
<p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/2e9e2be515de8ff8a0cdd4e238bc35d0.png" alt="img"></p>
<p>Bpmn 图形其实是通过 xml 表示业务流程，上边的.bpmn 文件使用文本编辑器打开：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">definitions</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.omg.org/spec/BPMN/20100524/MODEL&quot;</span> <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span> <span class="attr">xmlns:xsd</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema&quot;</span> <span class="attr">xmlns:activiti</span>=<span class="string">&quot;http://activiti.org/bpmn&quot;</span> <span class="attr">xmlns:bpmndi</span>=<span class="string">&quot;http://www.omg.org/spec/BPMN/20100524/DI&quot;</span> <span class="attr">xmlns:omgdc</span>=<span class="string">&quot;http://www.omg.org/spec/DD/20100524/DC&quot;</span> <span class="attr">xmlns:omgdi</span>=<span class="string">&quot;http://www.omg.org/spec/DD/20100524/DI&quot;</span> <span class="attr">typeLanguage</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema&quot;</span> <span class="attr">expressionLanguage</span>=<span class="string">&quot;http://www.w3.org/1999/XPath&quot;</span> <span class="attr">targetNamespace</span>=<span class="string">&quot;http://www.activiti.org/test&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">process</span> <span class="attr">id</span>=<span class="string">&quot;myProcess&quot;</span> <span class="attr">name</span>=<span class="string">&quot;My process&quot;</span> <span class="attr">isExecutable</span>=<span class="string">&quot;true&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">startEvent</span> <span class="attr">id</span>=<span class="string">&quot;startevent1&quot;</span> <span class="attr">name</span>=<span class="string">&quot;Start&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">startEvent</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">userTask</span> <span class="attr">id</span>=<span class="string">&quot;usertask1&quot;</span> <span class="attr">name</span>=<span class="string">&quot;创建请假单&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">userTask</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">sequenceFlow</span> <span class="attr">id</span>=<span class="string">&quot;flow1&quot;</span> <span class="attr">sourceRef</span>=<span class="string">&quot;startevent1&quot;</span> <span class="attr">targetRef</span>=<span class="string">&quot;usertask1&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">sequenceFlow</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">userTask</span> <span class="attr">id</span>=<span class="string">&quot;usertask2&quot;</span> <span class="attr">name</span>=<span class="string">&quot;部门经理审核&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">userTask</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">sequenceFlow</span> <span class="attr">id</span>=<span class="string">&quot;flow2&quot;</span> <span class="attr">sourceRef</span>=<span class="string">&quot;usertask1&quot;</span> <span class="attr">targetRef</span>=<span class="string">&quot;usertask2&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">sequenceFlow</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">userTask</span> <span class="attr">id</span>=<span class="string">&quot;usertask3&quot;</span> <span class="attr">name</span>=<span class="string">&quot;人事复核&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">userTask</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">sequenceFlow</span> <span class="attr">id</span>=<span class="string">&quot;flow3&quot;</span> <span class="attr">sourceRef</span>=<span class="string">&quot;usertask2&quot;</span> <span class="attr">targetRef</span>=<span class="string">&quot;usertask3&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">sequenceFlow</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">endEvent</span> <span class="attr">id</span>=<span class="string">&quot;endevent1&quot;</span> <span class="attr">name</span>=<span class="string">&quot;End&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">endEvent</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">sequenceFlow</span> <span class="attr">id</span>=<span class="string">&quot;flow4&quot;</span> <span class="attr">sourceRef</span>=<span class="string">&quot;usertask3&quot;</span> <span class="attr">targetRef</span>=<span class="string">&quot;endevent1&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">sequenceFlow</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">process</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">bpmndi:BPMNDiagram</span> <span class="attr">id</span>=<span class="string">&quot;BPMNDiagram_myProcess&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bpmndi:BPMNPlane</span> <span class="attr">bpmnElement</span>=<span class="string">&quot;myProcess&quot;</span> <span class="attr">id</span>=<span class="string">&quot;BPMNPlane_myProcess&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">bpmndi:BPMNShape</span> <span class="attr">bpmnElement</span>=<span class="string">&quot;startevent1&quot;</span> <span class="attr">id</span>=<span class="string">&quot;BPMNShape_startevent1&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">omgdc:Bounds</span> <span class="attr">height</span>=<span class="string">&quot;35.0&quot;</span> <span class="attr">width</span>=<span class="string">&quot;35.0&quot;</span> <span class="attr">x</span>=<span class="string">&quot;130.0&quot;</span> <span class="attr">y</span>=<span class="string">&quot;160.0&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">omgdc:Bounds</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">bpmndi:BPMNShape</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">bpmndi:BPMNShape</span> <span class="attr">bpmnElement</span>=<span class="string">&quot;usertask1&quot;</span> <span class="attr">id</span>=<span class="string">&quot;BPMNShape_usertask1&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">omgdc:Bounds</span> <span class="attr">height</span>=<span class="string">&quot;55.0&quot;</span> <span class="attr">width</span>=<span class="string">&quot;105.0&quot;</span> <span class="attr">x</span>=<span class="string">&quot;210.0&quot;</span> <span class="attr">y</span>=<span class="string">&quot;150.0&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">omgdc:Bounds</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">bpmndi:BPMNShape</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">bpmndi:BPMNShape</span> <span class="attr">bpmnElement</span>=<span class="string">&quot;usertask2&quot;</span> <span class="attr">id</span>=<span class="string">&quot;BPMNShape_usertask2&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">omgdc:Bounds</span> <span class="attr">height</span>=<span class="string">&quot;55.0&quot;</span> <span class="attr">width</span>=<span class="string">&quot;105.0&quot;</span> <span class="attr">x</span>=<span class="string">&quot;360.0&quot;</span> <span class="attr">y</span>=<span class="string">&quot;150.0&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">omgdc:Bounds</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">bpmndi:BPMNShape</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">bpmndi:BPMNShape</span> <span class="attr">bpmnElement</span>=<span class="string">&quot;usertask3&quot;</span> <span class="attr">id</span>=<span class="string">&quot;BPMNShape_usertask3&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">omgdc:Bounds</span> <span class="attr">height</span>=<span class="string">&quot;55.0&quot;</span> <span class="attr">width</span>=<span class="string">&quot;105.0&quot;</span> <span class="attr">x</span>=<span class="string">&quot;510.0&quot;</span> <span class="attr">y</span>=<span class="string">&quot;150.0&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">omgdc:Bounds</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">bpmndi:BPMNShape</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">bpmndi:BPMNShape</span> <span class="attr">bpmnElement</span>=<span class="string">&quot;endevent1&quot;</span> <span class="attr">id</span>=<span class="string">&quot;BPMNShape_endevent1&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">omgdc:Bounds</span> <span class="attr">height</span>=<span class="string">&quot;35.0&quot;</span> <span class="attr">width</span>=<span class="string">&quot;35.0&quot;</span> <span class="attr">x</span>=<span class="string">&quot;660.0&quot;</span> <span class="attr">y</span>=<span class="string">&quot;160.0&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">omgdc:Bounds</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">bpmndi:BPMNShape</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">bpmndi:BPMNEdge</span> <span class="attr">bpmnElement</span>=<span class="string">&quot;flow1&quot;</span> <span class="attr">id</span>=<span class="string">&quot;BPMNEdge_flow1&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">omgdi:waypoint</span> <span class="attr">x</span>=<span class="string">&quot;165.0&quot;</span> <span class="attr">y</span>=<span class="string">&quot;177.0&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">omgdi:waypoint</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">omgdi:waypoint</span> <span class="attr">x</span>=<span class="string">&quot;210.0&quot;</span> <span class="attr">y</span>=<span class="string">&quot;177.0&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">omgdi:waypoint</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">bpmndi:BPMNEdge</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">bpmndi:BPMNEdge</span> <span class="attr">bpmnElement</span>=<span class="string">&quot;flow2&quot;</span> <span class="attr">id</span>=<span class="string">&quot;BPMNEdge_flow2&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">omgdi:waypoint</span> <span class="attr">x</span>=<span class="string">&quot;315.0&quot;</span> <span class="attr">y</span>=<span class="string">&quot;177.0&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">omgdi:waypoint</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">omgdi:waypoint</span> <span class="attr">x</span>=<span class="string">&quot;360.0&quot;</span> <span class="attr">y</span>=<span class="string">&quot;177.0&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">omgdi:waypoint</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">bpmndi:BPMNEdge</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">bpmndi:BPMNEdge</span> <span class="attr">bpmnElement</span>=<span class="string">&quot;flow3&quot;</span> <span class="attr">id</span>=<span class="string">&quot;BPMNEdge_flow3&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">omgdi:waypoint</span> <span class="attr">x</span>=<span class="string">&quot;465.0&quot;</span> <span class="attr">y</span>=<span class="string">&quot;177.0&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">omgdi:waypoint</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">omgdi:waypoint</span> <span class="attr">x</span>=<span class="string">&quot;510.0&quot;</span> <span class="attr">y</span>=<span class="string">&quot;177.0&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">omgdi:waypoint</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">bpmndi:BPMNEdge</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">bpmndi:BPMNEdge</span> <span class="attr">bpmnElement</span>=<span class="string">&quot;flow4&quot;</span> <span class="attr">id</span>=<span class="string">&quot;BPMNEdge_flow4&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">omgdi:waypoint</span> <span class="attr">x</span>=<span class="string">&quot;615.0&quot;</span> <span class="attr">y</span>=<span class="string">&quot;177.0&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">omgdi:waypoint</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">omgdi:waypoint</span> <span class="attr">x</span>=<span class="string">&quot;660.0&quot;</span> <span class="attr">y</span>=<span class="string">&quot;177.0&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">omgdi:waypoint</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">bpmndi:BPMNEdge</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bpmndi:BPMNPlane</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">bpmndi:BPMNDiagram</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">definitions</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h2 id="22-使用步骤"><a class="markdownIt-Anchor" href="#22-使用步骤">#</a> 2.2 使用步骤</h2>
<h3 id="部署activiti"><a class="markdownIt-Anchor" href="#部署activiti">#</a> 部署 activiti</h3>
<p>Activiti 是一个工作流引擎（其实就是一堆 jar 包 API），业务系统访问 (操作) activiti 的接口，就可以方便的操作流程相关数据，这样就可以把工作流环境与业务系统的环境集成在一起。</p>
<h3 id="流程定义"><a class="markdownIt-Anchor" href="#流程定义">#</a> 流程定义</h3>
<p>使用 activiti 流程建模工具 (activity-designer) 定义业务流程 (.bpmn 文件) 。</p>
<p>.bpmn 文件就是业务流程定义文件，通过 xml 定义业务流程。</p>
<h3 id="流程定义部署"><a class="markdownIt-Anchor" href="#流程定义部署">#</a> 流程定义部署</h3>
<p>activiti 部署业务流程定义（.bpmn 文件）。</p>
<p>使用 activiti 提供的 api 把流程定义内容存储起来，在 Activiti 执行过程中可以查询定义的内容</p>
<p>Activiti 执行把流程定义内容存储在数据库中</p>
<h3 id="启动一个流程实例"><a class="markdownIt-Anchor" href="#启动一个流程实例">#</a> 启动一个流程实例</h3>
<p>流程实例也叫：ProcessInstance</p>
<p>启动一个流程实例表示开始一次业务流程的运行。</p>
<p>在员工请假流程定义部署完成后，如果张三要请假就可以启动一个流程实例，如果李四要请假也启动一个流程实例，两个流程的执行互相不影响。</p>
<h3 id="用户查询待办任务task"><a class="markdownIt-Anchor" href="#用户查询待办任务task">#</a> 用户查询待办任务 (Task)</h3>
<p>因为现在系统的业务流程已经交给 activiti 管理，通过 activiti 就可以查询当前流程执行到哪了，当前用户需要办理什么任务了，这些 activiti 帮我们管理了，而不需要开发人员自己编写在 sql 语句查询。</p>
<h3 id="用户办理任务"><a class="markdownIt-Anchor" href="#用户办理任务">#</a> 用户办理任务</h3>
<p>用户查询待办任务后，就可以办理某个任务，如果这个任务办理完成还需要其它用户办理，比如采购单创建后由部门经理审核，这个过程也是由 activiti 帮我们完成了。</p>
<h3 id="流程结束"><a class="markdownIt-Anchor" href="#流程结束">#</a> 流程结束</h3>
<p>当任务办理完成没有下一个任务结点了，这个流程实例就完成了。</p>
<h1 id="三-activiti环境"><a class="markdownIt-Anchor" href="#三-activiti环境">#</a> 三、Activiti 环境</h1>
<h2 id="31-开发环境"><a class="markdownIt-Anchor" href="#31-开发环境">#</a> 3.1 开发环境</h2>
<p>Jdk1.8 或以上版本</p>
<p>Mysql 5 及以上的版本</p>
<p>Tomcat8.5</p>
<p>IDEA</p>
<p><strong>注意：activiti 的流程定义工具插件可以安装在 IDEA 下，也可以安装在 Eclipse 工具下</strong></p>
<h2 id="32-activiti环境"><a class="markdownIt-Anchor" href="#32-activiti环境">#</a> 3.2 Activiti 环境</h2>
<p>我们使用：Activiti7.0.0.Beta1 默认支持 spring5</p>
<h3 id="321-下载activiti7"><a class="markdownIt-Anchor" href="#321-下载activiti7">#</a> 3.2.1 下载 activiti7</h3>
<p>Activiti 下载地址：<a target="_blank" rel="noopener" href="http://activiti.org/download.html">http://activiti.org/download.html</a> ，Maven 的依赖如下：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencyManagement</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.activiti<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>activiti-dependencies<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">version</span>&gt;</span>7.0.0.Beta1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">scope</span>&gt;</span>import<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">type</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencyManagement</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p><strong>1)</strong> <strong>Database</strong>：</p>
<p>activiti 运行需要有数据库的支持，支持的数据库有：h2, mysql, oracle, postgres, mssql, db2。</p>
<h3 id="322-流程设计器idea下安装"><a class="markdownIt-Anchor" href="#322-流程设计器idea下安装">#</a> 3.2.2 流程设计器 IDEA 下安装</h3>
<p>在 IDEA 的 File 菜单中找到子菜单”Settings”, 后面我们再选择左侧的 “plugins” 菜单，如下图所示：</p>
<p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/4222667fb5d6374e5d494385bcbf04b4.png" alt="img"></p>
<p>此时我们就可以搜索到 actiBPM 插件，它就是 Activiti Designer 的 IDEA 版本，我们点击 Install 安装。</p>
<p>安装好后，页面如下：</p>
<p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/f5a2177202ea9dd4630e255c403d7100.png" alt="img"></p>
<p>提示需要重启 idea，点击重启。</p>
<p>重启完成后，再次打开 Settings 下的 Plugins（插件列表），点击右侧的 Installed（已安装的插件），在列表中看到 actiBPM，就说明已经安装成功了，如下图所示：</p>
<p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/988e0af68496e1b4d219c78685ab7f2c.png" alt="img"></p>
<p>后面的课程里，我们会使用这个流程设计器进行 Activiti 的流程设计。</p>
<h2 id="33-activiti的数据库支持"><a class="markdownIt-Anchor" href="#33-activiti的数据库支持">#</a> 3.3 Activiti 的数据库支持</h2>
<p>Activiti 在运行时需要数据库的支持，使用 25 张表，把流程定义节点内容读取到数据库表中，以供后续使用。</p>
<h3 id="331-activiti-支持的数据库"><a class="markdownIt-Anchor" href="#331-activiti-支持的数据库">#</a> 3.3.1 Activiti 支持的数据库</h3>
<p>activiti 支持的数据库和版本如下：</p>
<table>
<thead>
<tr>
<th>数据库类型</th>
<th>版本</th>
<th>JDBC 连接示例</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>h2</td>
<td>1.3.168</td>
<td>jdbc:h2:tcp://localhost/activiti</td>
<td>默认配置的数据库</td>
</tr>
<tr>
<td>mysql</td>
<td>5.1.21</td>
<td>jdbc:mysql://localhost:3306/activiti?autoReconnect=true</td>
<td>使用 mysql-connector-java 驱动测试</td>
</tr>
<tr>
<td>oracle</td>
<td>11.2.0.1.0</td>
<td>jdbc:oracle:thin:@localhost:1521:xe</td>
<td></td>
</tr>
<tr>
<td>postgres</td>
<td>8.1</td>
<td>jdbc:postgresql://localhost:5432/activiti</td>
<td></td>
</tr>
<tr>
<td>db2</td>
<td>DB2 10.1 using db2jcc4</td>
<td>jdbc:db2://localhost:50000/activiti</td>
<td></td>
</tr>
<tr>
<td>mssql</td>
<td>2008 using sqljdbc4</td>
<td>jdbc:sqlserver://localhost:1433/activiti</td>
<td></td>
</tr>
</tbody>
</table>
<h3 id="332-在mysql生成表"><a class="markdownIt-Anchor" href="#332-在mysql生成表">#</a> 3.3.2 在 MySQL 生成表</h3>
<h4 id="3321-创建数据库"><a class="markdownIt-Anchor" href="#3321-创建数据库">#</a> 3.3.2.1 创建数据库</h4>
<p>创建 mysql 数据库 activiti （名字任意）：</p>
<p>CREATE DATABASE activiti DEFAULT CHARACTER SET utf8;</p>
<h4 id="3322-使用java代码生成表"><a class="markdownIt-Anchor" href="#3322-使用java代码生成表">#</a> 3.3.2.2 使用 java 代码生成表</h4>
<h5 id="1-创建-java-工程"><a class="markdownIt-Anchor" href="#1-创建-java-工程">#</a> 1） 创建 java 工程</h5>
<p>使用 idea 创建 java 的 maven 工程，取名：activiti01。</p>
<h5 id="2-加入-maven-依赖的坐标jar-包"><a class="markdownIt-Anchor" href="#2-加入-maven-依赖的坐标jar-包">#</a> 2） 加入 maven 依赖的坐标（jar 包）</h5>
<p>首先需要在 java 工程中加入 ProcessEngine 所需要的 jar 包，包括：</p>
<ol>
<li>activiti-engine-7.0.0.beta1.jar</li>
<li>activiti 依赖的 jar 包： mybatis、 alf4j、 log4j 等</li>
<li>activiti 依赖的 spring 包</li>
<li>mysql 数据库驱动</li>
<li>第三方数据连接池 dbcp</li>
<li>单元测试 Junit-4.12.jar</li>
</ol>
<p>我们使用 maven 来实现项目的构建，所以应当导入这些 jar 所对应的坐标到 pom.xml 文件中。</p>
<p>完整的依赖内容如下：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">slf4j.version</span>&gt;</span>1.6.6<span class="tag">&lt;/<span class="name">slf4j.version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">log4j.version</span>&gt;</span>1.2.12<span class="tag">&lt;/<span class="name">log4j.version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">activiti.version</span>&gt;</span>7.0.0.Beta1<span class="tag">&lt;/<span class="name">activiti.version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.activiti<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>activiti-engine<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;activiti.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.activiti<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>activiti-spring<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;activiti.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- bpmn 模型处理 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.activiti<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>activiti-bpmn-model<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;activiti.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- bpmn 转换 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.activiti<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>activiti-bpmn-converter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;activiti.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- bpmn json数据转换 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.activiti<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>activiti-json-converter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;activiti.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- bpmn 布局 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.activiti<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>activiti-bpmn-layout<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;activiti.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- activiti 云支持 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.activiti.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>activiti-cloud-services-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;activiti.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- mysql驱动 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>mysql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mysql-connector-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.1.40<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- mybatis --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.mybatis<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.4.5<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 链接池 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>commons-dbcp<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-dbcp<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.4<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.12<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- log start --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>log4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>log4j<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;log4j.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.slf4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>slf4j-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;slf4j.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.slf4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>slf4j-log4j12<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;slf4j.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h5 id="3-添加log4j日志配置"><a class="markdownIt-Anchor" href="#3-添加log4j日志配置">#</a> 3） 添加 log4j 日志配置</h5>
<p>我们使用 log4j 日志包，可以对日志进行配置</p>
<p>在 resources 下创建 log4j.properties</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Set root category priority to INFO and its only appender to CONSOLE.</span></span><br><span class="line"><span class="comment">#log4j.rootCategory=INFO, CONSOLE debug info warn error fatal</span></span><br><span class="line"><span class="attr">log4j.rootCategory</span>=<span class="string">debug, CONSOLE, LOGFILE</span></span><br><span class="line"><span class="comment"># Set the enterprise logger category to FATAL and its only appender to CONSOLE.</span></span><br><span class="line"><span class="attr">log4j.logger.org.apache.axis.enterprise</span>=<span class="string">FATAL, CONSOLE</span></span><br><span class="line"><span class="comment"># CONSOLE is set to be a ConsoleAppender using a PatternLayout.</span></span><br><span class="line"><span class="attr">log4j.appender.CONSOLE</span>=<span class="string">org.apache.log4j.ConsoleAppender</span></span><br><span class="line"><span class="attr">log4j.appender.CONSOLE.layout</span>=<span class="string">org.apache.log4j.PatternLayout</span></span><br><span class="line"><span class="attr">log4j.appender.CONSOLE.layout.ConversionPattern</span>=<span class="string">%d&#123;ISO8601&#125; %-6r[%15.15t] %-5p %30.30c %x - %m\n</span></span><br><span class="line"><span class="comment"># LOGFILE is set to be a File appender using a PatternLayout.</span></span><br><span class="line"><span class="attr">log4j.appender.LOGFILE</span>=<span class="string">org.apache.log4j.FileAppender</span></span><br><span class="line"><span class="attr">log4j.appender.LOGFILE.File</span>=<span class="string">f:\act\activiti.log</span></span><br><span class="line"><span class="attr">log4j.appender.LOGFILE.Append</span>=<span class="string">true</span></span><br><span class="line"><span class="attr">log4j.appender.LOGFILE.layout</span>=<span class="string">org.apache.log4j.PatternLayout</span></span><br><span class="line"><span class="attr">log4j.appender.LOGFILE.layout.ConversionPattern</span>=<span class="string">%d&#123;ISO8601&#125; %-6r[%15.15t] %-5p %30.30c %x - %m\n</span></span><br></pre></td></tr></table></figure>
<h5 id="4-添加activiti配置文件"><a class="markdownIt-Anchor" href="#4-添加activiti配置文件">#</a> 4） 添加 activiti 配置文件</h5>
<p>我们使用 activiti 提供的默认方式来创建 mysql 的表。</p>
<p>默认方式的要求是在 resources 下创建 activiti.cfg.xml 文件，注意：默认方式目录和文件名不能修改，因为 activiti 的源码中已经设置，到固定的目录读取固定文件名的文件。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.springframework.org/schema/beans&quot;</span></span></span><br><span class="line"><span class="tag"><span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag"><span class="attr">xmlns:context</span>=<span class="string">&quot;http://www.springframework.org/schema/context&quot;</span></span></span><br><span class="line"><span class="tag"><span class="attr">xmlns:tx</span>=<span class="string">&quot;http://www.springframework.org/schema/tx&quot;</span></span></span><br><span class="line"><span class="tag"><span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://www.springframework.org/schema/beans</span></span></span><br><span class="line"><span class="string"><span class="tag">                    http://www.springframework.org/schema/beans/spring-beans.xsd</span></span></span><br><span class="line"><span class="string"><span class="tag">http://www.springframework.org/schema/contex</span></span></span><br><span class="line"><span class="string"><span class="tag">http://www.springframework.org/schema/context/spring-context.xsd</span></span></span><br><span class="line"><span class="string"><span class="tag">http://www.springframework.org/schema/tx</span></span></span><br><span class="line"><span class="string"><span class="tag">http://www.springframework.org/schema/tx/spring-tx.xsd&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h5 id="5-在-activiticfgxml-中进行配置"><a class="markdownIt-Anchor" href="#5-在-activiticfgxml-中进行配置">#</a> 5） 在 activiti.cfg.xml 中进行配置</h5>
<p>默认方式要在在 activiti.cfg.xml 中 bean 的名字叫 processEngineConfiguration，名字不可修改</p>
<p>在这里有 2 中配置方式：一种是单独配置数据源，一种是不单独配置数据源</p>
<h6 id="1-直接配置processengineconfiguration"><a class="markdownIt-Anchor" href="#1-直接配置processengineconfiguration">#</a> 1、直接配置 processEngineConfiguration</h6>
<p>processEngineConfiguration 用来创建 ProcessEngine，在创建 ProcessEngine 时会执行数据库的操作。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.springframework.org/schema/beans&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:context</span>=<span class="string">&quot;http://www.springframework.org/schema/context&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:tx</span>=<span class="string">&quot;http://www.springframework.org/schema/tx&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://www.springframework.org/schema/beans</span></span></span><br><span class="line"><span class="string"><span class="tag">                    http://www.springframework.org/schema/beans/spring-beans.xsd</span></span></span><br><span class="line"><span class="string"><span class="tag">http://www.springframework.org/schema/contex</span></span></span><br><span class="line"><span class="string"><span class="tag">http://www.springframework.org/schema/context/spring-context.xsd</span></span></span><br><span class="line"><span class="string"><span class="tag">http://www.springframework.org/schema/tx</span></span></span><br><span class="line"><span class="string"><span class="tag">http://www.springframework.org/schema/tx/spring-tx.xsd&quot;</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 默认id对应的值 为processEngineConfiguration --&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- processEngine Activiti的流程引擎 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;processEngineConfiguration&quot;</span></span></span><br><span class="line"><span class="tag">          <span class="attr">class</span>=<span class="string">&quot;org.activiti.engine.impl.cfg.StandaloneProcessEngineConfiguration&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;jdbcDriver&quot;</span> <span class="attr">value</span>=<span class="string">&quot;com.mysql.jdbc.Driver&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;jdbcUrl&quot;</span> <span class="attr">value</span>=<span class="string">&quot;jdbc:mysql:///activiti&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;jdbcUsername&quot;</span> <span class="attr">value</span>=<span class="string">&quot;root&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;jdbcPassword&quot;</span> <span class="attr">value</span>=<span class="string">&quot;123456&quot;</span>/&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- activiti数据库表处理策略 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;databaseSchemaUpdate&quot;</span> <span class="attr">value</span>=<span class="string">&quot;true&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h6 id="2-配置数据源后在processengineconfiguration-引用"><a class="markdownIt-Anchor" href="#2-配置数据源后在processengineconfiguration-引用">#</a> 2、配置数据源后，在 processEngineConfiguration 引用</h6>
<p>首先配置数据源</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.springframework.org/schema/beans&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:context</span>=<span class="string">&quot;http://www.springframework.org/schema/context&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:tx</span>=<span class="string">&quot;http://www.springframework.org/schema/tx&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://www.springframework.org/schema/beans</span></span></span><br><span class="line"><span class="string"><span class="tag">                    http://www.springframework.org/schema/beans/spring-beans.xsd</span></span></span><br><span class="line"><span class="string"><span class="tag">http://www.springframework.org/schema/contex</span></span></span><br><span class="line"><span class="string"><span class="tag">http://www.springframework.org/schema/context/spring-context.xsd</span></span></span><br><span class="line"><span class="string"><span class="tag">http://www.springframework.org/schema/tx</span></span></span><br><span class="line"><span class="string"><span class="tag">http://www.springframework.org/schema/tx/spring-tx.xsd&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- 这里可以使用 链接池 dbcp--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;dataSource&quot;</span> <span class="attr">class</span>=<span class="string">&quot;org.apache.commons.dbcp.BasicDataSource&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;driverClassName&quot;</span> <span class="attr">value</span>=<span class="string">&quot;com.mysql.jdbc.Driver&quot;</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;url&quot;</span> <span class="attr">value</span>=<span class="string">&quot;jdbc:mysql:///activiti&quot;</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;username&quot;</span> <span class="attr">value</span>=<span class="string">&quot;root&quot;</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;password&quot;</span> <span class="attr">value</span>=<span class="string">&quot;123456&quot;</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;maxActive&quot;</span> <span class="attr">value</span>=<span class="string">&quot;3&quot;</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;maxIdle&quot;</span> <span class="attr">value</span>=<span class="string">&quot;1&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;processEngineConfiguration&quot;</span></span></span><br><span class="line"><span class="tag">          <span class="attr">class</span>=<span class="string">&quot;org.activiti.engine.impl.cfg.StandaloneProcessEngineConfiguration&quot;</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 引用数据源 上面已经设置好了--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;dataSource&quot;</span> <span class="attr">ref</span>=<span class="string">&quot;dataSource&quot;</span> /&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- activiti数据库表处理策略 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;databaseSchemaUpdate&quot;</span> <span class="attr">value</span>=<span class="string">&quot;true&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h5 id="6-java类编写程序生成表"><a class="markdownIt-Anchor" href="#6-java类编写程序生成表">#</a> 6） java 类编写程序生成表</h5>
<p>创建一个测试类，调用 activiti 的工具类，生成 acitivti 需要的数据库表。</p>
<p>直接使用 activiti 提供的工具类 ProcessEngines，会默认读取 classpath 下的 activiti.cfg.xml 文件，读取其中的数据库配置，创建 ProcessEngine，在创建 ProcessEngine 时会自动创建表。</p>
<p>代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.itheima.activiti01.test;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.activiti.engine.ProcessEngine;</span><br><span class="line"><span class="keyword">import</span> org.activiti.engine.ProcessEngineConfiguration;</span><br><span class="line"><span class="keyword">import</span> org.junit.Test;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestDemo</span> &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 生成 activiti的数据库表</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testCreateDbTable</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">//使用classpath下的activiti.cfg.xml中的配置创建processEngine</span></span><br><span class="line">		<span class="type">ProcessEngine</span> <span class="variable">processEngine</span> <span class="operator">=</span> ProcessEngines.getDefaultProcessEngine();</span><br><span class="line">		System.out.println(processEngine);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>说明：<br>
1、运行以上程序段即可完成 activiti 表创建，通过改变 activiti.cfg.xml 中 databaseSchemaUpdate 参数的值执行不同的数据表处理策略。<br>
2 、 上 边 的 方法 getDefaultProcessEngine 方法在执行时，从 activiti.cfg.xml 中找固定的名称 processEngineConfiguration 。</p>
<p>在测试程序执行过程中，idea 的控制台会输出日志，说明程序正在创建数据表，类似如下，注意红线内容：</p>
<p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/303798960a34b13286c1078b3cdbba1b.png" alt="img"></p>
<p>执行完成后我们查看数据库， 创建了 25 张表，结果如下：</p>
<p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/abf223e14cf32150f025c12b84be2eab.png" alt="img"></p>
<p>到这，我们就完成 activiti 运行需要的数据库和表的创建。</p>
<h2 id="34-表结构介绍"><a class="markdownIt-Anchor" href="#34-表结构介绍">#</a> 3.4 表结构介绍</h2>
<h3 id="341-表的命名规则和作用"><a class="markdownIt-Anchor" href="#341-表的命名规则和作用">#</a> 3.4.1 表的命名规则和作用</h3>
<p>看到刚才创建的表，我们发现 Activiti 的表都以 ACT_ 开头。</p>
<p>第二部分是表示表的用途的两个字母标识。 用途也和服务的 API 对应。<br>
<strong>ACT_RE</strong> ：'RE’表示 repository。 这个前缀的表包含了流程定义和流程静态资源 （图片，规则，等等）。<br>
<strong>ACT_RU</strong>：'RU’表示 runtime。 这些运行时的表，包含流程实例，任务，变量，异步任务，等运行中的数据。 Activiti 只在流程实例执行过程中保存这些数据， 在流程结束时就会删除这些记录。 这样运行时表可以一直很小速度很快。<br>
<strong>ACT_HI</strong>：'HI’表示 history。 这些表包含历史数据，比如历史流程实例， 变量，任务等等。<br>
<strong>ACT_GE</strong> ： GE 表示 general。 通用数据， 用于不同场景下</p>
<h3 id="342-activiti数据表介绍"><a class="markdownIt-Anchor" href="#342-activiti数据表介绍">#</a> 3.4.2 Activiti 数据表介绍</h3>
<table>
<thead>
<tr>
<th><strong>表分类</strong></th>
<th><strong>表名</strong></th>
<th><strong>解释</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>一般数据</td>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td>[ACT_GE_BYTEARRAY]</td>
<td>通用的流程定义和流程资源</td>
</tr>
<tr>
<td></td>
<td>[ACT_GE_PROPERTY]</td>
<td>系统相关属性</td>
</tr>
<tr>
<td>流程历史记录</td>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td>[ACT_HI_ACTINST]</td>
<td>历史的流程实例</td>
</tr>
<tr>
<td></td>
<td>[ACT_HI_ATTACHMENT]</td>
<td>历史的流程附件</td>
</tr>
<tr>
<td></td>
<td>[ACT_HI_COMMENT]</td>
<td>历史的说明性信息</td>
</tr>
<tr>
<td></td>
<td>[ACT_HI_DETAIL]</td>
<td>历史的流程运行中的细节信息</td>
</tr>
<tr>
<td></td>
<td>[ACT_HI_IDENTITYLINK]</td>
<td>历史的流程运行过程中用户关系</td>
</tr>
<tr>
<td></td>
<td>[ACT_HI_PROCINST]</td>
<td>历史的流程实例</td>
</tr>
<tr>
<td></td>
<td>[ACT_HI_TASKINST]</td>
<td>历史的任务实例</td>
</tr>
<tr>
<td></td>
<td>[ACT_HI_VARINST]</td>
<td>历史的流程运行中的变量信息</td>
</tr>
<tr>
<td>流程定义表</td>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td>[ACT_RE_DEPLOYMENT]</td>
<td>部署单元信息</td>
</tr>
<tr>
<td></td>
<td>[ACT_RE_MODEL]</td>
<td>模型信息</td>
</tr>
<tr>
<td></td>
<td>[ACT_RE_PROCDEF]</td>
<td>已部署的流程定义</td>
</tr>
<tr>
<td>运行实例表</td>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td>[ACT_RU_EVENT_SUBSCR]</td>
<td>运行时事件</td>
</tr>
<tr>
<td></td>
<td>[ACT_RU_EXECUTION]</td>
<td>运行时流程执行实例</td>
</tr>
<tr>
<td></td>
<td>[ACT_RU_IDENTITYLINK]</td>
<td>运行时用户关系信息，存储任务节点与参与者的相关信息</td>
</tr>
<tr>
<td></td>
<td>[ACT_RU_JOB]</td>
<td>运行时作业</td>
</tr>
<tr>
<td></td>
<td>[ACT_RU_TASK]</td>
<td>运行时任务</td>
</tr>
<tr>
<td></td>
<td>[ACT_RU_VARIABLE]</td>
<td>运行时变量表</td>
</tr>
</tbody>
</table>
<h1 id="四-activiti类关系图"><a class="markdownIt-Anchor" href="#四-activiti类关系图">#</a> 四、Activiti 类关系图</h1>
<p>上面我们完成了 Activiti 数据库表的生成，java 代码中我们调用 Activiti 的工具类，下面来了解 Activiti 的类关系</p>
<h2 id="41-类关系图"><a class="markdownIt-Anchor" href="#41-类关系图">#</a> 4.1 类关系图</h2>
<p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/eb571b5c4a1dff4f54dd504a537e4ade.png" alt="img"></p>
<p>在新版本中，我们通过实验可以发现 IdentityService，FormService 两个 Serivce 都已经删除了。</p>
<p>所以后面我们对于这两个 Service 也不讲解了，但老版本中还是有这两个 Service，同学们需要了解一下</p>
<h2 id="42-activiticfgxml"><a class="markdownIt-Anchor" href="#42-activiticfgxml">#</a> 4.2 activiti.cfg.xml</h2>
<p>activiti 的引擎配置文件，包括：ProcessEngineConfiguration 的定义、数据源定义、事务管理器等，此文件其实就是一个 spring 配置文件。</p>
<h2 id="43-流程引擎配置类"><a class="markdownIt-Anchor" href="#43-流程引擎配置类">#</a> 4.3 流程引擎配置类</h2>
<p>流程引擎的配置类（ProcessEngineConfiguration），通过 ProcessEngineConfiguration 可以创建工作流引擎 ProceccEngine，常用的两种方法如下：</p>
<h3 id="431-standaloneprocessengineconfiguration"><a class="markdownIt-Anchor" href="#431-standaloneprocessengineconfiguration">#</a> 4.3.1 StandaloneProcessEngineConfiguration</h3>
<p>使用 StandaloneProcessEngineConfigurationActiviti 可以单独运行，来创建 ProcessEngine，Activiti 会自己处理事务。</p>
<p>配置文件方式：</p>
<p>通常在 activiti.cfg.xml 配置文件中定义一个 id 为 processEngineConfiguration 的 bean.</p>
<p>方法如下：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;processEngineConfiguration&quot;</span></span></span><br><span class="line"><span class="tag">          <span class="attr">class</span>=<span class="string">&quot;org.activiti.engine.impl.cfg.StandaloneProcessEngineConfiguration&quot;</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--配置数据库相关的信息--&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--数据库驱动--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;jdbcDriver&quot;</span> <span class="attr">value</span>=<span class="string">&quot;com.mysql.jdbc.Driver&quot;</span>/&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--数据库链接--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;jdbcUrl&quot;</span> <span class="attr">value</span>=<span class="string">&quot;jdbc:mysql:///activiti&quot;</span>/&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--数据库用户名--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;jdbcUsername&quot;</span> <span class="attr">value</span>=<span class="string">&quot;root&quot;</span>/&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--数据库密码--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;jdbcPassword&quot;</span> <span class="attr">value</span>=<span class="string">&quot;123456&quot;</span>/&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--actviti数据库表在生成时的策略  true - 如果数据库中已经存在相应的表，那么直接使用，如果不存在，那么会创建--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;databaseSchemaUpdate&quot;</span> <span class="attr">value</span>=<span class="string">&quot;true&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>还可以加入连接池:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.springframework.org/schema/beans&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:context</span>=<span class="string">&quot;http://www.springframework.org/schema/context&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:tx</span>=<span class="string">&quot;http://www.springframework.org/schema/tx&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://www.springframework.org/schema/beans</span></span></span><br><span class="line"><span class="string"><span class="tag">                    http://www.springframework.org/schema/beans/spring-beans.xsd</span></span></span><br><span class="line"><span class="string"><span class="tag">http://www.springframework.org/schema/contex</span></span></span><br><span class="line"><span class="string"><span class="tag">http://www.springframework.org/schema/context/spring-context.xsd</span></span></span><br><span class="line"><span class="string"><span class="tag">http://www.springframework.org/schema/tx</span></span></span><br><span class="line"><span class="string"><span class="tag">http://www.springframework.org/schema/tx/spring-tx.xsd&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;dataSource&quot;</span> <span class="attr">class</span>=<span class="string">&quot;org.apache.commons.dbcp.BasicDataSource&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;driverClassName&quot;</span> <span class="attr">value</span>=<span class="string">&quot;com.mysql.jdbc.Driver&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;url&quot;</span> <span class="attr">value</span>=<span class="string">&quot;jdbc:mysql:///activiti&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;username&quot;</span> <span class="attr">value</span>=<span class="string">&quot;root&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;password&quot;</span> <span class="attr">value</span>=<span class="string">&quot;123456&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;maxActive&quot;</span> <span class="attr">value</span>=<span class="string">&quot;3&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;maxIdle&quot;</span> <span class="attr">value</span>=<span class="string">&quot;1&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--在默认方式下 bean的id  固定为 processEngineConfiguration--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;processEngineConfiguration&quot;</span></span></span><br><span class="line"><span class="tag">          <span class="attr">class</span>=<span class="string">&quot;org.activiti.engine.impl.cfg.StandaloneProcessEngineConfiguration&quot;</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--引入上面配置好的 链接池--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;dataSource&quot;</span> <span class="attr">ref</span>=<span class="string">&quot;dataSource&quot;</span>/&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--actviti数据库表在生成时的策略  true - 如果数据库中已经存在相应的表，那么直接使用，如果不存在，那么会创建--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;databaseSchemaUpdate&quot;</span> <span class="attr">value</span>=<span class="string">&quot;true&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h3 id="432-springprocessengineconfiguration"><a class="markdownIt-Anchor" href="#432-springprocessengineconfiguration">#</a> 4.3.2 SpringProcessEngineConfiguration</h3>
<p>通过<strong> org.activiti.spring.SpringProcessEngineConfiguration 与</strong> Spring 整合。</p>
<p>创建 spring 与 activiti 的整合配置文件：</p>
<p>activity-spring.cfg.xml（名称可修改）</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.springframework.org/schema/beans&quot;</span></span></span><br><span class="line"><span class="tag">   <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span> <span class="attr">xmlns:mvc</span>=<span class="string">&quot;http://www.springframework.org/schema/mvc&quot;</span></span></span><br><span class="line"><span class="tag"><span class="attr">xmlns:context</span>=<span class="string">&quot;http://www.springframework.org/schema/context&quot;</span></span></span><br><span class="line"><span class="tag">   <span class="attr">xmlns:aop</span>=<span class="string">&quot;http://www.springframework.org/schema/aop&quot;</span> <span class="attr">xmlns:tx</span>=<span class="string">&quot;http://www.springframework.org/schema/tx&quot;</span></span></span><br><span class="line"><span class="tag"><span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://www.springframework.org/schema/beans </span></span></span><br><span class="line"><span class="string"><span class="tag">      http://www.springframework.org/schema/beans/spring-beans-3.1.xsd </span></span></span><br><span class="line"><span class="string"><span class="tag">      http://www.springframework.org/schema/mvc </span></span></span><br><span class="line"><span class="string"><span class="tag">      http://www.springframework.org/schema/mvc/spring-mvc-3.1.xsd </span></span></span><br><span class="line"><span class="string"><span class="tag">      http://www.springframework.org/schema/context </span></span></span><br><span class="line"><span class="string"><span class="tag">       http://www.springframework.org/schema/context/spring-context-3.1.xsd </span></span></span><br><span class="line"><span class="string"><span class="tag">      http://www.springframework.org/schema/aop </span></span></span><br><span class="line"><span class="string"><span class="tag">      http://www.springframework.org/schema/aop/spring-aop-3.1.xsd </span></span></span><br><span class="line"><span class="string"><span class="tag">      http://www.springframework.org/schema/tx </span></span></span><br><span class="line"><span class="string"><span class="tag">      http://www.springframework.org/schema/tx/spring-tx-3.1.xsd &quot;</span>&gt;</span></span><br><span class="line">   <span class="comment">&lt;!-- 工作流引擎配置bean --&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;processEngineConfiguration&quot;</span> <span class="attr">class</span>=<span class="string">&quot;org.activiti.spring.SpringProcessEngineConfiguration&quot;</span>&gt;</span></span><br><span class="line">      <span class="comment">&lt;!-- 数据源 --&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;dataSource&quot;</span> <span class="attr">ref</span>=<span class="string">&quot;dataSource&quot;</span> /&gt;</span></span><br><span class="line">      <span class="comment">&lt;!-- 使用spring事务管理器 --&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;transactionManager&quot;</span> <span class="attr">ref</span>=<span class="string">&quot;transactionManager&quot;</span> /&gt;</span></span><br><span class="line">      <span class="comment">&lt;!-- 数据库策略 --&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;databaseSchemaUpdate&quot;</span> <span class="attr">value</span>=<span class="string">&quot;drop-create&quot;</span> /&gt;</span></span><br><span class="line">      <span class="comment">&lt;!-- activiti的定时任务关闭 --&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;jobExecutorActivate&quot;</span> <span class="attr">value</span>=<span class="string">&quot;false&quot;</span> /&gt;</span></span><br><span class="line">   <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line">   <span class="comment">&lt;!-- 流程引擎 --&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;processEngine&quot;</span> <span class="attr">class</span>=<span class="string">&quot;org.activiti.spring.ProcessEngineFactoryBean&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;processEngineConfiguration&quot;</span> <span class="attr">ref</span>=<span class="string">&quot;processEngineConfiguration&quot;</span> /&gt;</span></span><br><span class="line">   <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line">   <span class="comment">&lt;!-- 资源服务service --&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;repositoryService&quot;</span> <span class="attr">factory-bean</span>=<span class="string">&quot;processEngine&quot;</span></span></span><br><span class="line"><span class="tag">      <span class="attr">factory-method</span>=<span class="string">&quot;getRepositoryService&quot;</span> /&gt;</span></span><br><span class="line">   <span class="comment">&lt;!-- 流程运行service --&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;runtimeService&quot;</span> <span class="attr">factory-bean</span>=<span class="string">&quot;processEngine&quot;</span></span></span><br><span class="line"><span class="tag">      <span class="attr">factory-method</span>=<span class="string">&quot;getRuntimeService&quot;</span> /&gt;</span></span><br><span class="line">   <span class="comment">&lt;!-- 任务管理service --&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;taskService&quot;</span> <span class="attr">factory-bean</span>=<span class="string">&quot;processEngine&quot;</span></span></span><br><span class="line"><span class="tag">      <span class="attr">factory-method</span>=<span class="string">&quot;getTaskService&quot;</span> /&gt;</span></span><br><span class="line">   <span class="comment">&lt;!-- 历史管理service --&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;historyService&quot;</span> <span class="attr">factory-bean</span>=<span class="string">&quot;processEngine&quot;</span> <span class="attr">factory-method</span>=<span class="string">&quot;getHistoryService&quot;</span> /&gt;</span></span><br><span class="line">   <span class="comment">&lt;!-- 用户管理service --&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;identityService&quot;</span> <span class="attr">factory-bean</span>=<span class="string">&quot;processEngine&quot;</span> <span class="attr">factory-method</span>=<span class="string">&quot;getIdentityService&quot;</span> /&gt;</span></span><br><span class="line">   <span class="comment">&lt;!-- 引擎管理service --&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;managementService&quot;</span> <span class="attr">factory-bean</span>=<span class="string">&quot;processEngine&quot;</span> <span class="attr">factory-method</span>=<span class="string">&quot;getManagementService&quot;</span> /&gt;</span></span><br><span class="line">   <span class="comment">&lt;!-- 数据源 --&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;dataSource&quot;</span> <span class="attr">class</span>=<span class="string">&quot;org.apache.commons.dbcp.BasicDataSource&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;driverClassName&quot;</span> <span class="attr">value</span>=<span class="string">&quot;com.mysql.jdbc.Driver&quot;</span> /&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;url&quot;</span> <span class="attr">value</span>=<span class="string">&quot;jdbc:mysql://localhost:3306/activiti&quot;</span> /&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;username&quot;</span> <span class="attr">value</span>=<span class="string">&quot;root&quot;</span> /&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;password&quot;</span> <span class="attr">value</span>=<span class="string">&quot;mysql&quot;</span> /&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;maxActive&quot;</span> <span class="attr">value</span>=<span class="string">&quot;3&quot;</span> /&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;maxIdle&quot;</span> <span class="attr">value</span>=<span class="string">&quot;1&quot;</span> /&gt;</span></span><br><span class="line">   <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line">   <span class="comment">&lt;!-- 事务管理器 --&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;transactionManager&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">class</span>=<span class="string">&quot;org.springframework.jdbc.datasource.DataSourceTransactionManager&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;dataSource&quot;</span> <span class="attr">ref</span>=<span class="string">&quot;dataSource&quot;</span> /&gt;</span></span><br><span class="line">   <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line">   <span class="comment">&lt;!-- 通知 --&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">tx:advice</span> <span class="attr">id</span>=<span class="string">&quot;txAdvice&quot;</span> <span class="attr">transaction-manager</span>=<span class="string">&quot;transactionManager&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">tx:attributes</span>&gt;</span><span class="tag">&lt;/<span class="name">tx:attributes</span>&gt;</span></span><br><span class="line">          <span class="comment">&lt;!-- 传播行为 --&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">tx:method</span> <span class="attr">name</span>=<span class="string">&quot;save*&quot;</span> <span class="attr">propagation</span>=<span class="string">&quot;REQUIRED&quot;</span> /&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">tx:method</span> <span class="attr">name</span>=<span class="string">&quot;insert*&quot;</span> <span class="attr">propagation</span>=<span class="string">&quot;REQUIRED&quot;</span> /&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">tx:method</span> <span class="attr">name</span>=<span class="string">&quot;delete*&quot;</span> <span class="attr">propagation</span>=<span class="string">&quot;REQUIRED&quot;</span> /&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">tx:method</span> <span class="attr">name</span>=<span class="string">&quot;update*&quot;</span> <span class="attr">propagation</span>=<span class="string">&quot;REQUIRED&quot;</span> /&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">tx:method</span> <span class="attr">name</span>=<span class="string">&quot;find*&quot;</span> <span class="attr">propagation</span>=<span class="string">&quot;SUPPORTS&quot;</span> <span class="attr">read-only</span>=<span class="string">&quot;true&quot;</span> /&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">tx:method</span> <span class="attr">name</span>=<span class="string">&quot;get*&quot;</span> <span class="attr">propagation</span>=<span class="string">&quot;SUPPORTS&quot;</span> <span class="attr">read-only</span>=<span class="string">&quot;true&quot;</span> /&gt;</span></span><br><span class="line">       <span class="tag">&lt;/<span class="name">tx:attributes</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;/<span class="name">tx:advice</span>&gt;</span></span><br><span class="line">   <span class="comment">&lt;!-- 切面，根据具体项目修改切点配置 --&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">aop:config</span> <span class="attr">proxy-target-class</span>=<span class="string">&quot;true&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">aop:advisor</span> <span class="attr">advice-ref</span>=<span class="string">&quot;txAdvice&quot;</span>  <span class="attr">pointcut</span>=<span class="string">&quot;execution(* com.itheima.ihrm.service.impl.*.(..))&quot;</span>* /&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">aop:config</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h3 id="创建processengineconfiguration"><a class="markdownIt-Anchor" href="#创建processengineconfiguration">#</a> 创建 processEngineConfiguration</h3>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">ProcessEngineConfiguration</span> <span class="variable">configuration</span> <span class="operator">=</span> ProcessEngineConfiguration.createProcessEngineConfigurationFromResource(<span class="string">&quot;activiti.cfg.xml&quot;</span>)</span><br></pre></td></tr></table></figure>
<p>上边的代码要求 activiti.cfg.xml 中必须有一个 processEngineConfiguration 的 bean</p>
<p>也可以使用下边的方法，更改 bean 的名字：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ProcessEngineConfiguration.createProcessEngineConfigurationFromResource(String resource, String beanName);</span><br></pre></td></tr></table></figure>
<h2 id="44-工作流引擎创建"><a class="markdownIt-Anchor" href="#44-工作流引擎创建">#</a> 4.4 工作流引擎创建</h2>
<p>工作流引擎（ProcessEngine），相当于一个门面接口，通过 ProcessEngineConfiguration 创建 processEngine，通过 ProcessEngine 创建各个 service 接口。</p>
<h3 id="441-默认创建方式"><a class="markdownIt-Anchor" href="#441-默认创建方式">#</a> 4.4.1 默认创建方式</h3>
<p>将 activiti.cfg.xml 文件名及路径固定，且 activiti.cfg.xml 文件中有 processEngineConfiguration 的配置， 可以使用如下代码创建 processEngine:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//直接使用工具类 ProcessEngines，使用classpath下的activiti.cfg.xml中的配置创建processEngine</span></span><br><span class="line"><span class="type">ProcessEngine</span> <span class="variable">processEngine</span> <span class="operator">=</span> ProcessEngines.getDefaultProcessEngine();</span><br><span class="line">System.out.println(processEngine);</span><br></pre></td></tr></table></figure>
<h3 id="442-一般创建方式"><a class="markdownIt-Anchor" href="#442-一般创建方式">#</a> 4.4.2 一般创建方式</h3>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//先构建ProcessEngineConfiguration</span></span><br><span class="line"><span class="type">ProcessEngineConfiguration</span> <span class="variable">configuration</span> <span class="operator">=</span> ProcessEngineConfiguration.createProcessEngineConfigurationFromResource(<span class="string">&quot;activiti.cfg.xml&quot;</span>);</span><br><span class="line"><span class="comment">//通过ProcessEngineConfiguration创建ProcessEngine，此时会创建数据库</span></span><br><span class="line"><span class="type">ProcessEngine</span> <span class="variable">processEngine</span> <span class="operator">=</span> configuration.buildProcessEngine();</span><br></pre></td></tr></table></figure>
<h2 id="45-servcie服务接口"><a class="markdownIt-Anchor" href="#45-servcie服务接口">#</a> 4.5 Servcie 服务接口</h2>
<p>Service 是工作流引擎提供用于进行工作流部署、执行、管理的服务接口，我们使用这些接口可以就是操作服务对应的数据表</p>
<h3 id="451-service创建方式"><a class="markdownIt-Anchor" href="#451-service创建方式">#</a> 4.5.1 Service 创建方式</h3>
<p>通过 ProcessEngine 创建 Service</p>
<p>方式如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">RuntimeService</span> <span class="variable">runtimeService</span> <span class="operator">=</span> processEngine.getRuntimeService();</span><br><span class="line"><span class="type">RepositoryService</span> <span class="variable">repositoryService</span> <span class="operator">=</span> processEngine.getRepositoryService();</span><br><span class="line"><span class="type">TaskService</span> <span class="variable">taskService</span> <span class="operator">=</span> processEngine.getTaskService();</span><br></pre></td></tr></table></figure>
<h3 id="452-service总览"><a class="markdownIt-Anchor" href="#452-service总览">#</a> 4.5.2 Service 总览</h3>
<table>
<thead>
<tr>
<th>service 名称</th>
<th>service 作用</th>
</tr>
</thead>
<tbody>
<tr>
<td>RepositoryService</td>
<td>activiti 的资源管理类</td>
</tr>
<tr>
<td>RuntimeService</td>
<td>activiti 的流程运行管理类</td>
</tr>
<tr>
<td>TaskService</td>
<td>activiti 的任务管理类</td>
</tr>
<tr>
<td>HistoryService</td>
<td>activiti 的历史管理类</td>
</tr>
<tr>
<td>ManagerService</td>
<td>activiti 的引擎管理类</td>
</tr>
</tbody>
</table>
<p>简单介绍：</p>
<p><strong>RepositoryService</strong></p>
<p>是 activiti 的资源管理类，提供了管理和控制流程发布包和流程定义的操作。使用工作流建模工具设计的业务流程图需要使用此 service 将流程定义文件的内容部署到计算机。</p>
<p>除了部署流程定义以外还可以：查询引擎中的发布包和流程定义。</p>
<p>暂停或激活发布包，对应全部和特定流程定义。 暂停意味着它们不能再执行任何操作了，激活是对应的反向操作。获得多种资源，像是包含在发布包里的文件， 或引擎自动生成的流程图。</p>
<p>获得流程定义的 pojo 版本， 可以用来通过 java 解析流程，而不必通过 xml。</p>
<h4 id="runtimeservice"><a class="markdownIt-Anchor" href="#runtimeservice">#</a> RuntimeService</h4>
<p>Activiti 的流程运行管理类。可以从这个服务类中获取很多关于流程执行相关的信息</p>
<h4 id="taskservice"><a class="markdownIt-Anchor" href="#taskservice">#</a> TaskService</h4>
<p>Activiti 的任务管理类。可以从这个类中获取任务的信息。</p>
<h4 id="historyservice"><a class="markdownIt-Anchor" href="#historyservice">#</a> HistoryService</h4>
<p>Activiti 的历史管理类，可以查询历史信息，执行流程时，引擎会保存很多数据（根据配置），比如流程实例启动时间，任务的参与者， 完成任务的时间，每个流程实例的执行路径，等等。 这个服务主要通过查询功能来获得这些数据。</p>
<h4 id="managementservice"><a class="markdownIt-Anchor" href="#managementservice">#</a> ManagementService</h4>
<p>Activiti 的引擎管理类，提供了对 Activiti 流程引擎的管理和维护功能，这些功能不在工作流驱动的应用程序中使用，主要用于 Activiti 系统的日常维护。</p>
<h1 id="五-activiti入门"><a class="markdownIt-Anchor" href="#五-activiti入门">#</a> 五、Activiti 入门</h1>
<p>在本章内容中，我们来创建一个 Activiti 工作流，并启动这个流程。</p>
<p>创建 Activiti 工作流主要包含以下几步：</p>
<p>1、定义流程，按照 BPMN 的规范，使用流程定义工具，用<strong>流程符号</strong>把整个流程描述出来</p>
<p>2、部署流程，把画好的流程定义文件，加载到数据库中，生成表的数据</p>
<p>3、启动流程，使用 java 代码来操作数据库表中的内容</p>
<h2 id="51-流程符号"><a class="markdownIt-Anchor" href="#51-流程符号">#</a> 5.1 流程符号</h2>
<p>BPMN 2.0 是业务流程建模符号 2.0 的缩写。</p>
<p>它由 Business Process Management Initiative 这个非营利协会创建并不断发展。作为一种标识，BPMN 2.0 是使用一些<strong>符号</strong>来明确业务流程设计流程图的一整套符号规范，它能增进业务建模时的沟通效率。</p>
<p>目前 BPMN2.0 是最新的版本，它用于在 BPM 上下文中进行布局和可视化的沟通。</p>
<p>接下来我们先来了解在流程设计中常见的 符号。</p>
<p>BPMN2.0 的<strong>基本符合</strong>主要包含：</p>
<h3 id="事件-event"><a class="markdownIt-Anchor" href="#事件-event">#</a> 事件 Event</h3>
<p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/55da0d46ad4664bec6f38a53aec9e98f.png" alt="1574522151044"></p>
<h3 id="活动-activity"><a class="markdownIt-Anchor" href="#活动-activity">#</a> 活动 Activity</h3>
<p>活动是工作或任务的一个通用术语。一个活动可以是一个任务，还可以是一个当前流程的子处理流程； 其次，你还可以为活动指定不同的类型。常见活动如下：</p>
<p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/fa7d32728f189f729285e260a68c966b.png" alt="1574562726375"></p>
<h3 id="网关-gateway"><a class="markdownIt-Anchor" href="#网关-gateway">#</a> 网关 GateWay</h3>
<p>网关用来处理决策，有几种常用网关需要了解：</p>
<p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/4e671fa1ca691aae89fcba2f6cd9c7f4.png" alt="1574563600305"></p>
<h4 id="排他网关-x"><a class="markdownIt-Anchor" href="#排他网关-x">#</a> 排他网关 (x)</h4>
<p>—— 只有一条路径会被选择。流程执行到该网关时，按照输出流的顺序逐个计算，当条件的计算结果为 true 时，继续执行当前网关的输出流；</p>
<p>如果多条线路计算结果都是 true，则会执行第一个值为 true 的线路。如果所有网关计算结果没有 true，则引擎会抛出异常。</p>
<p>排他网关需要和条件顺序流结合使用，default 属性指定默认顺序流，当所有的条件不满足时会执行默认顺序流。</p>
<h4 id="并行网关"><a class="markdownIt-Anchor" href="#并行网关">#</a> 并行网关 (+)</h4>
<p>—— 所有路径会被同时选择</p>
<p>拆分 —— 并行执行所有输出顺序流，为每一条顺序流创建一个并行执行线路。</p>
<p>合并 —— 所有从并行网关拆分并执行完成的线路均在此等候，直到所有的线路都执行完成才继续向下执行。</p>
<h4 id="包容网关"><a class="markdownIt-Anchor" href="#包容网关">#</a> 包容网关 (+)</h4>
<p>—— 可以同时执行多条线路，也可以在网关上设置条件</p>
<p>拆分 —— 计算每条线路上的表达式，当表达式计算结果为 true 时，创建一个并行线路并继续执行</p>
<p>合并 —— 所有从并行网关拆分并执行完成的线路均在此等候，直到所有的线路都执行完成才继续向下执行。</p>
<h4 id="事件网关"><a class="markdownIt-Anchor" href="#事件网关">#</a> 事件网关 (+)</h4>
<p>—— 专门为中间捕获事件设置的，允许设置多个输出流指向多个不同的中间捕获事件。当流程执行到事件网关后，流程处于等待状态，需要等待抛出事件才能将等待状态转换为活动状态。</p>
<h3 id="流向-flow"><a class="markdownIt-Anchor" href="#流向-flow">#</a> 流向 <a target="_blank" rel="noopener" href="https://so.csdn.net/so/search?q=Flow&amp;spm=1001.2101.3001.7020">Flow</a></h3>
<p>流是连接两个流程节点的连线。常见的流向包含以下几种：</p>
<p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/3628cf5044d11d8aa723d8d62de112a9.png" alt="1574563937457"></p>
<h2 id="52-流程设计器使用"><a class="markdownIt-Anchor" href="#52-流程设计器使用">#</a> 5.2 流程设计器使用</h2>
<h3 id="activiti-designer使用"><a class="markdownIt-Anchor" href="#activiti-designer使用">#</a> Activiti-Designer 使用</h3>
<h4 id="palette画板"><a class="markdownIt-Anchor" href="#palette画板">#</a> Palette（画板）</h4>
<p>在 idea 中安装插件即可使用，画板中包括以下结点：</p>
<p>Connection— 连接</p>
<p>Event— 事件</p>
<p>Task— 任务</p>
<p>Gateway— 网关</p>
<p>Container— 容器</p>
<p>Boundary event— 边界事件</p>
<p>Intermediate event- - 中间事件</p>
<p>流程图设计完毕保存生成.bpmn 文件</p>
<h4 id="新建流程idea工具"><a class="markdownIt-Anchor" href="#新建流程idea工具">#</a> 新建流程 (IDEA 工具)</h4>
<p>首先选中存放图形的目录 (选择 resources 下的 bpmn 目录)，点击菜单：New -&gt; BpmnFile，如图：</p>
<p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/a29cab07f2cdeeecf23a121b955f1f38.png" alt="1575106985823"></p>
<p>弹出如下图所示框，输入 evection 表示 出差审批流程：</p>
<p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/b73038594eb6a617ab01d06ecd67d71f.png" alt="1575107231004"></p>
<p>起完名字 evection 后（默认扩展名为 bpmn），就可以看到流程设计页面，如图所示：</p>
<p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/5e11bd3ce21ca2170f3aab1954de69af.png" alt="1575107336431"></p>
<p>左侧区域是绘图区，右侧区域是 palette 画板区域</p>
<p>鼠标先点击画板的元素即可在左侧绘图</p>
<h3 id="绘制流程"><a class="markdownIt-Anchor" href="#绘制流程">#</a> 绘制流程</h3>
<p>使用滑板来绘制流程，通过从右侧把图标拖拽到左侧的画板，最终效果如下：</p>
<p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/1938218ad58d78c29863e3c3cbaf13ac.png" alt="1575107648105"></p>
<h3 id="指定流程定义key"><a class="markdownIt-Anchor" href="#指定流程定义key">#</a> 指定流程定义 Key</h3>
<p>流程定义 key 即流程定义的标识，通过 properties 视图查看流程的 key</p>
<p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/80e8ed41d420a613bb3601866bccc0b3.png" alt="1575115474865"></p>
<h3 id="指定任务负责人"><a class="markdownIt-Anchor" href="#指定任务负责人">#</a> 指定任务负责人</h3>
<p>在 properties 视图指定每个任务结点的负责人，如：填写出差申请的负责人为 zhangsan</p>
<p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/f5c59207b9f63ed98c0b14b07c35e172.png" alt="1575121491752"></p>
<p>经理审批负责人为 jerry</p>
<p>总经理审批负责人为 jack</p>
<p>财务审批负责人为 rose</p>
<h1 id="六-流程操作"><a class="markdownIt-Anchor" href="#六-流程操作">#</a> 六、流程操作</h1>
<h2 id="61-流程定义"><a class="markdownIt-Anchor" href="#61-流程定义">#</a> 6.1 流程定义</h2>
<h3 id="概述"><a class="markdownIt-Anchor" href="#概述">#</a> 概述</h3>
<p>流程定义是线下按照 bpmn2.0 标准去描述 业务流程，通常使用 idea 中的插件对业务流程进行建模。</p>
<p>使用 idea 下的 designer 设计器绘制流程，并会生成两个文件：.bpmn 和.png</p>
<h3 id="bpmn文件"><a class="markdownIt-Anchor" href="#bpmn文件">#</a> .bpmn 文件</h3>
<p>使用 activiti-desinger 设计业务流程，会生成.bpmn 文件，上面我们已经创建好了 bpmn 文件</p>
<p>BPMN 2.0 根节点是 definitions 节点。 这个元素中，可以定义多个流程定义（不过我们建议每个文件只包含一个流程定义， 可以简化开发过程中的维护难度）。 注意，definitions 元素 最少也要包含 xmlns 和 targetNamespace 的声明。 targetNamespace 可以是任意值，它用来对流程实例进行分类。</p>
<p>流程定义部分：定义了流程每个结点的描述及结点之间的流程流转。</p>
<p>流程布局定义：定义流程每个结点在流程图上的位置坐标等信息。</p>
<h3 id="生成png图片文件"><a class="markdownIt-Anchor" href="#生成png图片文件">#</a> 生成.png 图片文件</h3>
<p>IDEA 工具中的操作方式</p>
<h4 id="1-修改文件后缀为xml"><a class="markdownIt-Anchor" href="#1-修改文件后缀为xml">#</a> 1、修改文件后缀为 xml</h4>
<p>首先将 evection.bpmn 文件改名为 evection.xml，如下图：</p>
<p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/68e0b7ef038641fe75c8b4789bc9fd82.png" alt="1575108966935"></p>
<p>evection.xml 修改前的 bpmn 文件，效果如下：<br>
<img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/20210624233410152.png" alt="在这里插入图片描述"></p>
<h4 id="2-使用designer设计器打开xml文件"><a class="markdownIt-Anchor" href="#2-使用designer设计器打开xml文件">#</a> 2、使用 designer 设计器打开.xml 文件</h4>
<p>在 evection.xml 文件上面，点右键并选择 Diagrams 菜单，再选择 Show BPMN2.0 Designer…</p>
<p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/56cf4c6dbe90593db85bff1b5c0b10dc.png" alt="1575109268443"></p>
<h4 id="3-查看打开的文件"><a class="markdownIt-Anchor" href="#3-查看打开的文件">#</a> 3、查看打开的文件</h4>
<p>打开后，却出现乱码，如图：</p>
<p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/98adf795b3a3c57761fc49084a28af51.png" alt="1575109366989"></p>
<h4 id="4-解决中文乱码"><a class="markdownIt-Anchor" href="#4-解决中文乱码">#</a> 4、解决中文乱码</h4>
<p>1、打开 Settings，找到 File Encodings，把 encoding 的选项都选择 UTF-8</p>
<p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/223fbee930641ac8f6d65a467a5d36c2.png" alt="1575112075626"></p>
<p>2、打开 IDEA 安装路径，找到如下的安装目录</p>
<p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/4a5e3f122c63db4551f7e675fd36fa4e.png" alt="1575109627745"></p>
<p>根据自己所安装的版本来决定，我使用的是 64 位的 idea，所以在 idea64.exe.vmoptions 文件的最后一行追加一条命令： -Dfile.encoding=UTF-8</p>
<p>如下所示：</p>
<p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/b393629505f3409a3aca9578840b8606.png" alt="https://images2017.cnblogs.com/blog/963440/201712/963440-20171221132445475-1259807908.png"></p>
<p>一定注意，不要有空格，否则重启 IDEA 时会打不开，然后 重启 IDEA。</p>
<p>如果以上方法已经做完，还出现乱码，就再修改一个文件，并在文件的末尾添加： -Dfile.encoding=UTF-8，然后重启 idea，如图：</p>
<p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/ff19450a5625b5ae625128507546bb3c.png" alt="1575113551947"></p>
<p>最后重新在 evection.xml 文件上面，点右键并选择 Diagrams 菜单，再选择 Show BPMN2.0 Designer…，看到生成图片，如图：</p>
<p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/5b284f4d81d5207b8ea7e857f2f58ba1.png" alt="1575113951966"></p>
<p>到此，解决乱码问题</p>
<h4 id="5-导出为图片文件"><a class="markdownIt-Anchor" href="#5-导出为图片文件">#</a> 5、导出为图片文件</h4>
<p>点击 Export To File 的小图标，打开如下窗口，注意填写文件名及扩展名，选择好保存图片的位置：</p>
<p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/31410de865cf7a691087db4009d0fcd2.png" alt="1575114245068"></p>
<p>然后，我们把 png 文件拷贝到 resources 下的 bpmn 目录，并且把 evection.xml 改名为 evection.bpmn。</p>
<h2 id="62-流程定义部署"><a class="markdownIt-Anchor" href="#62-流程定义部署">#</a> 6.2 流程定义部署</h2>
<h3 id="概述-2"><a class="markdownIt-Anchor" href="#概述-2">#</a> 概述</h3>
<p>将上面在设计器中定义的流程部署到 activiti 数据库中，就是流程定义部署。</p>
<p>通过调用 activiti 的 api 将流程定义的 bpmn 和 png 两个文件一个一个添加部署到 activiti 中，也可以将两个文件打成 zip 包进行部署。</p>
<h3 id="单个文件部署方式"><a class="markdownIt-Anchor" href="#单个文件部署方式">#</a> 单个文件部署方式</h3>
<p>分别将 bpmn 文件和 png 图片文件部署。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ActivitiDemo</span> &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 部署流程定义</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testDeployment</span><span class="params">()</span>&#123;</span><br><span class="line"><span class="comment">//        1、创建ProcessEngine</span></span><br><span class="line">        <span class="type">ProcessEngine</span> <span class="variable">processEngine</span> <span class="operator">=</span> ProcessEngines.getDefaultProcessEngine();</span><br><span class="line"><span class="comment">//        2、得到RepositoryService实例</span></span><br><span class="line">        <span class="type">RepositoryService</span> <span class="variable">repositoryService</span> <span class="operator">=</span> processEngine.getRepositoryService();</span><br><span class="line"><span class="comment">//        3、使用RepositoryService进行部署</span></span><br><span class="line">        <span class="type">Deployment</span> <span class="variable">deployment</span> <span class="operator">=</span> repositoryService.createDeployment()</span><br><span class="line">                .addClasspathResource(<span class="string">&quot;bpmn/evection.bpmn&quot;</span>) <span class="comment">// 添加bpmn资源</span></span><br><span class="line">                .addClasspathResource(<span class="string">&quot;bpmn/evection.png&quot;</span>)  <span class="comment">// 添加png资源</span></span><br><span class="line">                .name(<span class="string">&quot;出差申请流程&quot;</span>)</span><br><span class="line">                .deploy();</span><br><span class="line"><span class="comment">//        4、输出部署信息</span></span><br><span class="line">        System.out.println(<span class="string">&quot;流程部署id：&quot;</span> + deployment.getId());</span><br><span class="line">        System.out.println(<span class="string">&quot;流程部署名称：&quot;</span> + deployment.getName());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>执行此操作后 activiti 会将上边代码中指定的 bpm 文件和图片文件保存在 activiti 数据库。</p>
<h3 id="压缩包部署方式"><a class="markdownIt-Anchor" href="#压缩包部署方式">#</a> 压缩包部署方式</h3>
<p>将 evection.bpmn 和 evection.png 压缩成 zip 包。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">deployProcessByZip</span><span class="params">()</span> &#123;</span><br><span class="line">		<span class="comment">// 定义zip输入流</span></span><br><span class="line">		<span class="type">InputStream</span> <span class="variable">inputStream</span> <span class="operator">=</span> <span class="built_in">this</span></span><br><span class="line">				.getClass()</span><br><span class="line">				.getClassLoader()</span><br><span class="line">				.getResourceAsStream(</span><br><span class="line">						<span class="string">&quot;bpmn/evection.zip&quot;</span>);</span><br><span class="line">		<span class="type">ZipInputStream</span> <span class="variable">zipInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ZipInputStream</span>(inputStream);</span><br><span class="line">		<span class="comment">// 获取repositoryService</span></span><br><span class="line">		<span class="type">RepositoryService</span> <span class="variable">repositoryService</span> <span class="operator">=</span> processEngine</span><br><span class="line">				.getRepositoryService();</span><br><span class="line">		<span class="comment">// 流程部署</span></span><br><span class="line">		<span class="type">Deployment</span> <span class="variable">deployment</span> <span class="operator">=</span> repositoryService.createDeployment()</span><br><span class="line">				.addZipInputStream(zipInputStream)</span><br><span class="line">				.deploy();</span><br><span class="line">		System.out.println(<span class="string">&quot;流程部署id：&quot;</span> + deployment.getId());</span><br><span class="line">		System.out.println(<span class="string">&quot;流程部署名称：&quot;</span> + deployment.getName());</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<p>执行此操作后 activiti 会将上边代码中指定的 bpm 文件和图片文件保存在 activiti 数据库。</p>
<h3 id="操作数据表"><a class="markdownIt-Anchor" href="#操作数据表">#</a> 操作数据表</h3>
<p>流程定义部署后操作 activiti 的 3 张表如下：</p>
<p>act_re_deployment 流程定义部署表，每部署一次增加一条记录</p>
<p>act_re_procdef 流程定义表，部署每个新的流程定义都会在这张表中增加一条记录</p>
<p>act_ge_bytearray 流程资源表</p>
<p>接下来我们来看看，写入了什么数据：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> act_re_deployment #流程定义部署表，记录流程部署信息</span><br><span class="line"><span class="number">1</span></span><br></pre></td></tr></table></figure>
<p>结果：</p>
<p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/bcf465a3c35a6e66e2ca075a0f793dd1.png" alt="1575116732147"></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> act_re_procdef #流程定义表，记录流程定义信息</span><br></pre></td></tr></table></figure>
<p>结果：</p>
<p>注意，KEY 这个字段是用来唯一识别不同流程的关键字</p>
<p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/f84eb1d97f90541675bd5a538b51d381.png" alt="1575116797665"></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> act_ge_bytearray #资源表 </span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>结果：</p>
<p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/20210624233344315.png" alt="在这里插入图片描述"></p>
<p>注意：</p>
<p>act_re_deployment 和 act_re_procdef 一对多关系，一次部署在流程部署表生成一条记录，但一次部署可以部署多个流程定义，每个流程定义在流程定义表生成一条记录。每一个流程定义在 act_ge_bytearray 会存在两个资源记录，bpmn 和 png。</p>
<p>建议：一次部署一个流程，这样部署表和流程定义表是一对一有关系，方便读取流程部署及流程定义信息。</p>
<h2 id="63-启动流程实例"><a class="markdownIt-Anchor" href="#63-启动流程实例">#</a> 6.3 启动流程实例</h2>
<p>流程定义部署在 activiti 后就可以通过工作流管理业务流程了，也就是说上边部署的出差申请流程可以使用了。</p>
<p>针对该流程，启动一个流程表示发起一个新的出差申请单，这就相当于 java 类与 java 对象的关系，类定义好后需要 new 创建一个对象使用，当然可以 new 多个对象。对于请出差申请流程，张三发起一个出差申请单需要启动一个流程实例，出差申请单发起一个出差单也需要启动一个流程实例。</p>
<p>代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 启动流程实例</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testStartProcess</span><span class="params">()</span>&#123;</span><br><span class="line"><span class="comment">//        1、创建ProcessEngine</span></span><br><span class="line">        <span class="type">ProcessEngine</span> <span class="variable">processEngine</span> <span class="operator">=</span> ProcessEngines.getDefaultProcessEngine();</span><br><span class="line"><span class="comment">//        2、获取RunTimeService</span></span><br><span class="line">        <span class="type">RuntimeService</span> <span class="variable">runtimeService</span> <span class="operator">=</span> processEngine.getRuntimeService();</span><br><span class="line"><span class="comment">//        3、根据流程定义Id启动流程</span></span><br><span class="line">        <span class="type">ProcessInstance</span> <span class="variable">processInstance</span> <span class="operator">=</span> runtimeService</span><br><span class="line">                .startProcessInstanceByKey(<span class="string">&quot;myEvection&quot;</span>);</span><br><span class="line"><span class="comment">//        输出内容</span></span><br><span class="line">        System.out.println(<span class="string">&quot;流程定义id：&quot;</span> + processInstance.getProcessDefinitionId());</span><br><span class="line">        System.out.println(<span class="string">&quot;流程实例id：&quot;</span> + processInstance.getId());</span><br><span class="line">        System.out.println(<span class="string">&quot;当前活动Id：&quot;</span> + processInstance.getActivityId());</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>输出内容如下：</p>
<p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/1638a3cecc5fbee4dc99ceb37e4647dd.png" alt="1575117588624"></p>
<p><strong>操作数据表</strong></p>
<p>act_hi_actinst 流程实例执行历史</p>
<p>act_hi_identitylink 流程的参与用户历史信息</p>
<p>act_hi_procinst 流程实例历史信息</p>
<p>act_hi_taskinst 流程任务历史信息</p>
<p>act_ru_execution 流程执行信息</p>
<p>act_ru_identitylink 流程的参与用户信息</p>
<p>act_ru_task 任务信息</p>
<h2 id="64-任务查询"><a class="markdownIt-Anchor" href="#64-任务查询">#</a> 6.4 任务查询</h2>
<p>流程启动后，任务的负责人就可以查询自己当前需要处理的任务，查询出来的任务都是该用户的待办任务。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 查询当前个人待执行的任务</span></span><br><span class="line"><span class="comment">      */</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testFindPersonalTaskList</span><span class="params">()</span> &#123;</span><br><span class="line"><span class="comment">//        任务负责人</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">assignee</span> <span class="operator">=</span> <span class="string">&quot;zhangsan&quot;</span>;</span><br><span class="line">        <span class="type">ProcessEngine</span> <span class="variable">processEngine</span> <span class="operator">=</span> ProcessEngines.getDefaultProcessEngine();</span><br><span class="line"><span class="comment">//        创建TaskService</span></span><br><span class="line">        <span class="type">TaskService</span> <span class="variable">taskService</span> <span class="operator">=</span> processEngine.getTaskService();</span><br><span class="line"><span class="comment">//        根据流程key 和 任务负责人 查询任务</span></span><br><span class="line">        List&lt;Task&gt; list = taskService.createTaskQuery()</span><br><span class="line">                .processDefinitionKey(<span class="string">&quot;myEvection&quot;</span>) <span class="comment">//流程Key</span></span><br><span class="line">                .taskAssignee(assignee)<span class="comment">//只查询该任务负责人的任务</span></span><br><span class="line">                .list();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (Task task : list) &#123;</span><br><span class="line"></span><br><span class="line">            System.out.println(<span class="string">&quot;流程实例id：&quot;</span> + task.getProcessInstanceId());</span><br><span class="line">            System.out.println(<span class="string">&quot;任务id：&quot;</span> + task.getId());</span><br><span class="line">            System.out.println(<span class="string">&quot;任务负责人：&quot;</span> + task.getAssignee());</span><br><span class="line">            System.out.println(<span class="string">&quot;任务名称：&quot;</span> + task.getName());</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>输出结果如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">流程实例id：2501</span><br><span class="line">任务id：2505</span><br><span class="line">任务负责人：zhangsan</span><br><span class="line">任务名称：创建出差申请</span><br></pre></td></tr></table></figure>
<h2 id="65-流程任务处理"><a class="markdownIt-Anchor" href="#65-流程任务处理">#</a> 6.5 流程任务处理</h2>
<p>任务负责人查询待办任务，选择任务进行处理，完成任务。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 完成任务</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">completTask</span><span class="params">()</span>&#123;</span><br><span class="line"><span class="comment">//        获取引擎</span></span><br><span class="line">        <span class="type">ProcessEngine</span> <span class="variable">processEngine</span> <span class="operator">=</span> ProcessEngines.getDefaultProcessEngine();</span><br><span class="line"><span class="comment">//        获取taskService</span></span><br><span class="line">        <span class="type">TaskService</span> <span class="variable">taskService</span> <span class="operator">=</span> processEngine.getTaskService();</span><br><span class="line"></span><br><span class="line"><span class="comment">//        根据流程key 和 任务的负责人 查询任务</span></span><br><span class="line"><span class="comment">//        返回一个任务对象</span></span><br><span class="line">        <span class="type">Task</span> <span class="variable">task</span> <span class="operator">=</span> taskService.createTaskQuery()</span><br><span class="line">                .processDefinitionKey(<span class="string">&quot;myEvection&quot;</span>) <span class="comment">//流程Key</span></span><br><span class="line">                .taskAssignee(<span class="string">&quot;zhangsan&quot;</span>)  <span class="comment">//要查询的负责人</span></span><br><span class="line">                .singleResult();</span><br><span class="line"></span><br><span class="line"><span class="comment">//        完成任务,参数：任务id</span></span><br><span class="line">        taskService.complete(task.getId());</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h2 id="66-流程定义信息查询"><a class="markdownIt-Anchor" href="#66-流程定义信息查询">#</a> 6.6 流程定义信息查询</h2>
<p>查询流程相关信息，包含流程定义，流程部署，流程定义版本</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 查询流程定义</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">queryProcessDefinition</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="comment">//        获取引擎</span></span><br><span class="line">        <span class="type">ProcessEngine</span> <span class="variable">processEngine</span> <span class="operator">=</span> ProcessEngines.getDefaultProcessEngine();</span><br><span class="line"><span class="comment">//        repositoryService</span></span><br><span class="line">        <span class="type">RepositoryService</span> <span class="variable">repositoryService</span> <span class="operator">=</span> processEngine.getRepositoryService();</span><br><span class="line"><span class="comment">//        得到ProcessDefinitionQuery 对象</span></span><br><span class="line">        <span class="type">ProcessDefinitionQuery</span> <span class="variable">processDefinitionQuery</span> <span class="operator">=</span> repositoryService.createProcessDefinitionQuery();</span><br><span class="line"><span class="comment">//          查询出当前所有的流程定义</span></span><br><span class="line"><span class="comment">//          条件：processDefinitionKey =evection</span></span><br><span class="line"><span class="comment">//          orderByProcessDefinitionVersion 按照版本排序</span></span><br><span class="line"><span class="comment">//        desc倒叙</span></span><br><span class="line"><span class="comment">//        list 返回集合</span></span><br><span class="line">        List&lt;ProcessDefinition&gt; definitionList = processDefinitionQuery.processDefinitionKey(<span class="string">&quot;myEvection&quot;</span>)</span><br><span class="line">                .orderByProcessDefinitionVersion()</span><br><span class="line">                .desc()</span><br><span class="line">                .list();</span><br><span class="line"><span class="comment">//      输出流程定义信息</span></span><br><span class="line">        <span class="keyword">for</span> (ProcessDefinition processDefinition : definitionList) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;流程定义 id=&quot;</span>+processDefinition.getId());</span><br><span class="line">            System.out.println(<span class="string">&quot;流程定义 name=&quot;</span>+processDefinition.getName());</span><br><span class="line">            System.out.println(<span class="string">&quot;流程定义 key=&quot;</span>+processDefinition.getKey());</span><br><span class="line">            System.out.println(<span class="string">&quot;流程定义 Version=&quot;</span>+processDefinition.getVersion());</span><br><span class="line">            System.out.println(<span class="string">&quot;流程部署ID =&quot;</span>+processDefinition.getDeploymentId());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>输出结果：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">流程定义id：myEvection:1:4</span><br><span class="line">流程定义名称：出差申请单</span><br><span class="line">流程定义key：myEvection</span><br><span class="line">流程定义版本：1</span><br></pre></td></tr></table></figure>
<h2 id="67-流程删除"><a class="markdownIt-Anchor" href="#67-流程删除">#</a> 6.7 流程删除</h2>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">deleteDeployment</span><span class="params">()</span> &#123;</span><br><span class="line">		<span class="comment">// 流程部署id</span></span><br><span class="line">		<span class="type">String</span> <span class="variable">deploymentId</span> <span class="operator">=</span> <span class="string">&quot;1&quot;</span>;</span><br><span class="line">		</span><br><span class="line">    <span class="type">ProcessEngine</span> <span class="variable">processEngine</span> <span class="operator">=</span> ProcessEngines.getDefaultProcessEngine();</span><br><span class="line">    <span class="comment">// 通过流程引擎获取repositoryService</span></span><br><span class="line">		<span class="type">RepositoryService</span> <span class="variable">repositoryService</span> <span class="operator">=</span> processEngine</span><br><span class="line">				.getRepositoryService();</span><br><span class="line">		<span class="comment">//删除流程定义，如果该流程定义已有流程实例启动则删除时出错</span></span><br><span class="line">		repositoryService.deleteDeployment(deploymentId);</span><br><span class="line">		<span class="comment">//设置true 级联删除流程定义，即使该流程有流程实例启动也可以删除，设置为false非级别删除方式，如果流程</span></span><br><span class="line">		<span class="comment">//repositoryService.deleteDeployment(deploymentId, true);</span></span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<p>说明：</p>
<ol>
<li>
<pre><code>  使用repositoryService删除流程定义，历史表信息不会被删除
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">2. ```</span><br><span class="line">     如果该流程定义下没有正在运行的流程，则可以用普通删除。</span><br></pre></td></tr></table></figure>

</code></pre>
</li>
</ol>
<p>如果该流程定义下存在已经运行的流程，使用普通删除报错，可用级联删除方法将流程及相关记录全部删除。</p>
<p>先删除没有完成流程节点，最后就可以完全删除流程定义信息</p>
<p>项目开发中级联删除操作一般只开放给超级管理员使用.</p>
<h2 id="68-流程资源下载"><a class="markdownIt-Anchor" href="#68-流程资源下载">#</a> 6.8 流程资源下载</h2>
<p>现在我们的流程资源文件已经上传到数据库了，如果其他用户想要查看这些资源文件，可以从数据库中把资源文件下载到本地。</p>
<p>解决方案有：</p>
<p>1、jdbc 对 blob 类型，clob 类型数据读取出来，保存到文件目录</p>
<p>2、使用 activiti 的 api 来实现</p>
<p>使用 commons-io.jar 解决 IO 的操作</p>
<p>引入 commons-io 依赖包</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>commons-io<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-io<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.6<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>通过流程定义对象获取流程定义资源，获取 bpmn 和 png</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.commons.io.IOUtils;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">deleteDeployment</span><span class="params">()</span>&#123;</span><br><span class="line"><span class="comment">//        获取引擎</span></span><br><span class="line">        <span class="type">ProcessEngine</span> <span class="variable">processEngine</span> <span class="operator">=</span> ProcessEngines.getDefaultProcessEngine();</span><br><span class="line"><span class="comment">//        获取repositoryService</span></span><br><span class="line">        <span class="type">RepositoryService</span> <span class="variable">repositoryService</span> <span class="operator">=</span> processEngine.getRepositoryService();</span><br><span class="line"><span class="comment">//        根据部署id 删除部署信息,如果想要级联删除，可以添加第二个参数，true</span></span><br><span class="line">        repositoryService.deleteDeployment(<span class="string">&quot;1&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span>  <span class="title function_">queryBpmnFile</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line"><span class="comment">//        1、得到引擎</span></span><br><span class="line">        <span class="type">ProcessEngine</span> <span class="variable">processEngine</span> <span class="operator">=</span> ProcessEngines.getDefaultProcessEngine();</span><br><span class="line"><span class="comment">//        2、获取repositoryService</span></span><br><span class="line">        <span class="type">RepositoryService</span> <span class="variable">repositoryService</span> <span class="operator">=</span> processEngine.getRepositoryService();</span><br><span class="line"><span class="comment">//        3、得到查询器：ProcessDefinitionQuery，设置查询条件,得到想要的流程定义</span></span><br><span class="line">        <span class="type">ProcessDefinition</span> <span class="variable">processDefinition</span> <span class="operator">=</span> repositoryService.createProcessDefinitionQuery()</span><br><span class="line">                .processDefinitionKey(<span class="string">&quot;myEvection&quot;</span>)</span><br><span class="line">                .singleResult();</span><br><span class="line"><span class="comment">//        4、通过流程定义信息，得到部署ID</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">deploymentId</span> <span class="operator">=</span> processDefinition.getDeploymentId();</span><br><span class="line"><span class="comment">//        5、通过repositoryService的方法，实现读取图片信息和bpmn信息</span></span><br><span class="line"><span class="comment">//        png图片的流</span></span><br><span class="line">        <span class="type">InputStream</span> <span class="variable">pngInput</span> <span class="operator">=</span> repositoryService.getResourceAsStream(deploymentId, processDefinition.getDiagramResourceName());</span><br><span class="line"><span class="comment">//        bpmn文件的流</span></span><br><span class="line">        <span class="type">InputStream</span> <span class="variable">bpmnInput</span> <span class="operator">=</span> repositoryService.getResourceAsStream(deploymentId, processDefinition.getResourceName());</span><br><span class="line"><span class="comment">//        6、构造OutputStream流</span></span><br><span class="line">        <span class="type">File</span> <span class="variable">file_png</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(<span class="string">&quot;d:/evectionflow01.png&quot;</span>);</span><br><span class="line">        <span class="type">File</span> <span class="variable">file_bpmn</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(<span class="string">&quot;d:/evectionflow01.bpmn&quot;</span>);</span><br><span class="line">        <span class="type">FileOutputStream</span> <span class="variable">bpmnOut</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(file_bpmn);</span><br><span class="line">        <span class="type">FileOutputStream</span> <span class="variable">pngOut</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(file_png);</span><br><span class="line"><span class="comment">//        7、输入流，输出流的转换</span></span><br><span class="line">        IOUtils.copy(pngInput,pngOut);</span><br><span class="line">        IOUtils.copy(bpmnInput,bpmnOut);</span><br><span class="line"><span class="comment">//        8、关闭流</span></span><br><span class="line">        pngOut.close();</span><br><span class="line">        bpmnOut.close();</span><br><span class="line">        pngInput.close();</span><br><span class="line">        bpmnInput.close();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>说明：</p>
<ol>
<li>
<pre><code>  deploymentId为流程部署ID
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">2. ```</span><br><span class="line">     resource_name为act_ge_bytearray表中NAME_列的值</span><br></pre></td></tr></table></figure>

</code></pre>
</li>
<li>
<pre><code>  使用repositoryService的getDeploymentResourceNames方法可以获取指定部署下得所有文件的名称
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">4. ```</span><br><span class="line">     使用repositoryService的getResourceAsStream方法传入部署ID和资源图片名称可以获取部署下指定名称文件的输入流</span><br></pre></td></tr></table></figure>

</code></pre>
</li>
</ol>
<p>最后的将输入流中的图片资源进行输出。</p>
<h2 id="69-流程历史信息的查看"><a class="markdownIt-Anchor" href="#69-流程历史信息的查看">#</a> 6.9 流程历史信息的查看</h2>
<p>即使流程定义已经删除了，流程执行的历史信息通过前面的分析，依然保存在 activiti 的 act_hi_* 相关的表中。所以我们还是可以查询流程执行的历史信息，可以通过 HistoryService 来查看相关的历史记录。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 查看历史信息</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">findHistoryInfo</span><span class="params">()</span>&#123;</span><br><span class="line"><span class="comment">//      获取引擎</span></span><br><span class="line">        <span class="type">ProcessEngine</span> <span class="variable">processEngine</span> <span class="operator">=</span> ProcessEngines.getDefaultProcessEngine();</span><br><span class="line"><span class="comment">//        获取HistoryService</span></span><br><span class="line">        <span class="type">HistoryService</span> <span class="variable">historyService</span> <span class="operator">=</span> processEngine.getHistoryService();</span><br><span class="line"><span class="comment">//        获取 actinst表的查询对象</span></span><br><span class="line">        <span class="type">HistoricActivityInstanceQuery</span> <span class="variable">instanceQuery</span> <span class="operator">=</span> historyService.createHistoricActivityInstanceQuery();</span><br><span class="line"><span class="comment">//        查询 actinst表，条件：根据 InstanceId 查询</span></span><br><span class="line"><span class="comment">//        instanceQuery.processInstanceId(&quot;2501&quot;);</span></span><br><span class="line"><span class="comment">//        查询 actinst表，条件：根据 DefinitionId 查询</span></span><br><span class="line">        instanceQuery.processDefinitionId(<span class="string">&quot;myEvection:1:4&quot;</span>);</span><br><span class="line"><span class="comment">//        增加排序操作,orderByHistoricActivityInstanceStartTime 根据开始时间排序 asc 升序</span></span><br><span class="line">        instanceQuery.orderByHistoricActivityInstanceStartTime().asc();</span><br><span class="line"><span class="comment">//        查询所有内容</span></span><br><span class="line">        List&lt;HistoricActivityInstance&gt; activityInstanceList = instanceQuery.list();</span><br><span class="line"><span class="comment">//        输出</span></span><br><span class="line">        <span class="keyword">for</span> (HistoricActivityInstance hi : activityInstanceList) &#123;</span><br><span class="line">            System.out.println(hi.getActivityId());</span><br><span class="line">            System.out.println(hi.getActivityName());</span><br><span class="line">            System.out.println(hi.getProcessDefinitionId());</span><br><span class="line">            System.out.println(hi.getProcessInstanceId());</span><br><span class="line">            System.out.println(<span class="string">&quot;&lt;==========================&gt;&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h1 id="总结"><a class="markdownIt-Anchor" href="#总结">#</a> 总结</h1>
<ul>
<li>基本功能介绍以及完成了，如果还需要更加高级的功能比如挂起、激活流程实例、流程变量等请参考<a target="_blank" rel="noopener" href="https://andyoung.blog.csdn.net/article/details/118345330">【https://andyoung.blog.csdn.net/article/details/118345330】</a>。</li>
<li>工作流引擎 Activiti 与 Spring boot 结合会是开发跟简单，不如来看下 <a target="_blank" rel="noopener" href="https://andyoung.blog.csdn.net/article/details/118372175">【工作流引擎 Activiti 实战系列】</a></li>
</ul>
<h2 id="关于我"><a class="markdownIt-Anchor" href="#关于我">#</a> 关于我</h2>
<p>Brath 是一个热爱技术的 <code>Java</code>  程序猿，公众号「InterviewCoder」定期分享有趣有料的精品原创文章！</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/fa31569d28cd4d5baa3a7168d4021f37~tplv-k3u1fbpfcp-zoom-1.image" alt="图片"></p>
<p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/%E4%BA%8C%E7%BB%B4%E7%A0%81plus.png" alt="InterviewCoder"> 非常感谢各位人才能看到这里，原创不易，文章如果有帮助可以关注、点赞、分享或评论，这都是对我的莫大支持！</p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2021-02-03T16:20:23.000Z" title="2021/2/4 00:20:23">2021-02-04</time>发表</span><span class="level-item"><time dateTime="2022-10-10T16:10:23.000Z" title="2022/10/11 00:10:23">2022-10-11</time>更新</span><span class="level-item">4 分钟读完 (大约549个字)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2021/02/04/%E3%80%90Redis%E3%80%91SpringBoot%E6%95%B4%E5%90%88Redis%EF%BC%8C%E7%BC%93%E5%AD%98%E6%89%B9%E9%87%8F%E5%88%A0%E9%99%A4%20%20redisTemplate.keys(pattern)%E6%A8%A1%E7%B3%8A%E6%9F%A5%E8%AF%A2%E6%89%BE%E4%B8%8D%E5%88%B0keys%EF%BC%8C%E2%80%9C%20%20%E2%80%9C%20%E9%80%9A%E9%85%8D%E7%AC%A6%E6%97%A0%E6%95%88/">【Redis】SpringBoot整合Redis，缓存批量删除  redisTemplate.keys(pattern)模糊查询找不到keys，“  “ 通配符无效</a></p><div class="content"><p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/%E6%89%AB%E7%A0%81_%E6%90%9C%E7%B4%A2%E8%81%94%E5%90%88%E4%BC%A0%E6%92%AD%E6%A0%B7%E5%BC%8F-%E6%A0%87%E5%87%86%E8%89%B2%E7%89%88.png" alt="InterviewCoder"></p>
<h1 id="redisspringboot整合redis缓存批量删除-redistemplatekeyspattern模糊查询找不到keys-通配符无效"><a class="markdownIt-Anchor" href="#redisspringboot整合redis缓存批量删除-redistemplatekeyspattern模糊查询找不到keys-通配符无效">#</a> 【Redis】SpringBoot 整合 Redis，缓存批量删除  redisTemplate.keys (pattern) 模糊查询找不到 keys，“  “ 通配符无效</h1>
<h3 id="引言"><a class="markdownIt-Anchor" href="#引言">#</a> 引言</h3>
<p>最近，在学习 Spring Boot 整合 Redis 的知识，在业务中需要删除某个前缀的所有<a target="_blank" rel="noopener" href="https://so.csdn.net/so/search?q=Redis%E7%BC%93%E5%AD%98&amp;spm=1001.2101.3001.7020"> Redis 缓存</a>，首先使用 <strong>RedisTemplate.keys () 模糊查询</strong>出所有合适的 keys，再使用 <a target="_blank" rel="noopener" href="https://so.csdn.net/so/search?q=redisTemplate&amp;spm=1001.2101.3001.7020">redisTemplate</a>.delete () 方法进行批量删除。参考代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Set&lt;String&gt; keys = redisTemplate.keys(prefix + <span class="string">&quot;*&quot;</span>);</span><br><span class="line">redisTemplate.delete(pageKeys);</span><br></pre></td></tr></table></figure>
<p>然而，发现 redisTemplate.keys (prefix + “*” ) 模糊查询，总是返回一个空的集合，找不到 key。</p>
<p>在日志中打印查询的 keys 集合，一直为空集合：</p>
<p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/e157868f134c4420b9989e3d3e41365a.png" alt="img"></p>
<h3 id="1-问题分析"><a class="markdownIt-Anchor" href="#1-问题分析">#</a> <strong>1、问题分析：</strong></h3>
<p>首先，确保查询字符串正确。</p>
<p>然后，尝试 redisTemplate.keys (key) ，用完整的一个 key 进行查询，发现能正常返回只有一个 key 的集合。</p>
<p>说明模糊查询 的 通配符 <strong>&quot; * &quot;</strong> 没有发挥作用，可能只是被当作一个普通的字符了。</p>
<h3 id="2-问题解决"><a class="markdownIt-Anchor" href="#2-问题解决">#</a> <strong>2、问题解决：</strong></h3>
<p>为 redis 添加配置文件 RedisConfig，重新定义 RedisTemplate 的 key 为 String 类型：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RedisConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean(name = &quot;redisTemplate&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> RedisTemplate&lt;String, Object&gt; <span class="title function_">redisTemplate</span><span class="params">(RedisConnectionFactory redisConnectionFactory)</span>&#123;</span><br><span class="line">        RedisTemplate&lt;String, Object&gt; redisTemplate = <span class="keyword">new</span> <span class="title class_">RedisTemplate</span>&lt;&gt;();</span><br><span class="line">        redisTemplate.setConnectionFactory(redisConnectionFactory);</span><br><span class="line">        <span class="type">StringRedisSerializer</span> <span class="variable">redisSerializer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringRedisSerializer</span>();</span><br><span class="line">        <span class="comment">// key采用String的序列化方式</span></span><br><span class="line">        redisTemplate.setKeySerializer(redisSerializer);</span><br><span class="line">        <span class="comment">// hash的key也采用String的序列化方式</span></span><br><span class="line">        redisTemplate.setHashKeySerializer(redisSerializer);</span><br><span class="line">        <span class="keyword">return</span> redisTemplate;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>再次测试 redisTemplate.keys (prefix + “*” ) 模糊查询，可以正常返回缓存中的 keys 集合！！！</p>
<h2 id="关于我"><a class="markdownIt-Anchor" href="#关于我">#</a> 关于我</h2>
<p>Brath 是一个热爱技术的 Java 程序猿，公众号「InterviewCoder」定期分享有趣有料的精品原创文章！</p>
<p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/%E4%BA%8C%E7%BB%B4%E7%A0%81plus.png" alt="InterviewCoder"></p>
<p>非常感谢各位人才能看到这里，原创不易，文章如果有帮助可以关注、点赞、分享或评论，这都是对我的莫大支持！</p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2021-01-12T00:06:17.000Z" title="2021/1/12 08:06:17">2021-01-12</time>发表</span><span class="level-item"><time dateTime="2023-06-30T17:42:18.000Z" title="2023/7/1 01:42:18">2023-07-01</time>更新</span><span class="level-item">12 分钟读完 (大约1726个字)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2021/01/12/%E3%80%90Java%E3%80%91CompletableFuture%E4%BD%BF%E7%94%A8%E6%96%87%E6%A1%A3/">CompletableFuture使用文档</a></p><div class="content"><p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/%E6%89%AB%E7%A0%81_%E6%90%9C%E7%B4%A2%E8%81%94%E5%90%88%E4%BC%A0%E6%92%AD%E6%A0%B7%E5%BC%8F-%E6%A0%87%E5%87%86%E8%89%B2%E7%89%88.png" alt="InterviewCoder"></p>
<p>背景：<br>
CompletableFuture 字面翻译过来，就是 “可完成的 Future”。同传统的 Future 相比较，CompletableFuture 能够主动设置计算的结果值（主动终结计算过程，即 completable），从而在某些场景下主动结束阻塞等待。而 Future 由于不能主动设置计算结果值，一旦调用 get () 进行阻塞等待，要么当计算结果产生，要么超时，才会返回。</p>
<p>CompletableFuture 说白了其实就是为了解决 Future 的问题（阻塞），而生！！！</p>
<p>下面总结 CompletableFuture 的常用 api</p>
<ol>
<li>
<p>创建 CompletableFuture<br>
 实例方法：</p>
<pre><code>//实例方法
CompletableFuture&lt;String&gt; completableFutureOne = new CompletableFuture&lt;&gt;();
Supplier&lt;?&gt; task=new Supplier&lt;Object&gt;() &#123;
    @Override
    public Object get() &#123;
        return null;
    &#125;
&#125;;
CompletableFuture&lt;?&gt; completableFuture = completableFutureOne.supplyAsync(task);
</code></pre>
</li>
</ol>
<p>静态方法：</p>
<p>public static void main(String[] args) throws ExecutionException, InterruptedException {<br>
Runnable runnable = () -&gt;<br>
System.out.println (“执行无返回结果的异步任务”);<br>
System.out.println(CompletableFuture.runAsync(runnable).get());</p>
<pre><code>      CompletableFuture&lt;String&gt; future = CompletableFuture.supplyAsync(() -&gt; &#123;
          System.out.println(&quot;执行有返回值的异步任务&quot;);
          return &quot;Hello World&quot;;
      &#125;);
      String result = future.get();
      System.out.println(result);
  &#125;
</code></pre>
<h2 id="2-whencomplete-第一个任务结束对其结果处理handly的作用一样"><a class="markdownIt-Anchor" href="#2-whencomplete-第一个任务结束对其结果处理handly的作用一样">#</a> 2、whenComplete - 第一个任务结束，对其结果处理 (handly 的作用一样)</h2>
<p>结果处理就是当 future 任务完成时，对任务的结果做处理工作！或异常情况处理！</p>
  <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">public static void main(String[] args) throws ExecutionException, InterruptedException &#123;</span><br><span class="line">        CompletableFuture&lt;Integer&gt; future = CompletableFuture.supplyAsync(() -&gt; &#123;</span><br><span class="line">            try &#123;</span><br><span class="line">                TimeUnit.SECONDS.sleep(1);</span><br><span class="line">            &#125; catch (InterruptedException e) &#123;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">            System.out.println(&quot;执行结束1！&quot;);</span><br><span class="line">            return 5;</span><br><span class="line">        &#125;);</span><br><span class="line">        future.whenComplete(new BiConsumer&lt;Integer, Throwable&gt;() &#123;</span><br><span class="line">            @Override</span><br><span class="line">            public void accept(Integer t, Throwable action) &#123;</span><br><span class="line">                t=t+1;</span><br><span class="line">//                int i = 12 / 0;</span><br><span class="line">                System.out.println(&quot;执行完成2！&quot;+action.getMessage());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">        .exceptionally(new Function&lt;Throwable, Integer&gt;() &#123;</span><br><span class="line">            @Override</span><br><span class="line">            public Integer apply(Throwable t) &#123;</span><br><span class="line">                System.out.println(&quot;执行失败3：&quot; + t.getMessage());</span><br><span class="line">                return null;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;).join();</span><br><span class="line">        Integer integer = future.get();</span><br><span class="line">        System.out.println(&quot;=&gt;integer&quot;+integer);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>1、whenComplete 只是对任务运行结束后，拿到任务结果，做个处理，并且如果任务执行有异常，会监听到异常！<br>
2、如果 whenComplete 本身有异常，那么需要单独加 exceptionally 来监听异常！<br>
3、最终 future.get () 拿到的还是任务 1 的结果<br>
 4、如果任务有异常，future.get () 拿到会抛出异常！</p>
  <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">执行结束1！</span><br><span class="line">执行失败3：java.lang.ArithmeticException: / by zero</span><br><span class="line">Exception in thread &quot;main&quot; java.util.concurrent.ExecutionException: java.lang.ArithmeticException: / by zero</span><br><span class="line">	at java.util.concurrent.CompletableFuture.reportGet(CompletableFuture.java:357)</span><br><span class="line">	at java.util.concurrent.CompletableFuture.get(CompletableFuture.java:1895)</span><br><span class="line">	at top.lisicheng.wmd.CompleableFutureTest2.main(CompleableFutureTest2.java:83)</span><br><span class="line">Caused by: java.lang.ArithmeticException: / by zero</span><br><span class="line">	at top.lisicheng.wmd.CompleableFutureTest2.lambda$main$0(CompleableFutureTest2.java:65)</span><br><span class="line">	at java.util.concurrent.CompletableFuture$AsyncSupply.run$$$capture(CompletableFuture.java:1590)</span><br><span class="line">	at java.util.concurrent.CompletableFuture$AsyncSupply.run(CompletableFuture.java)</span><br><span class="line">	at java.util.concurrent.CompletableFuture$AsyncSupply.exec(CompletableFuture.java:1582)</span><br><span class="line">	at java.util.concurrent.ForkJoinTask.doExec(ForkJoinTask.java:289)</span><br><span class="line">	at java.util.concurrent.ForkJoinPool$WorkQueue.runTask(ForkJoinPool.java:1056)</span><br><span class="line">	at java.util.concurrent.ForkJoinPool.runWorker(ForkJoinPool.java:1692)</span><br><span class="line">	at java.util.concurrent.ForkJoinWorkerThread.run(ForkJoinWorkerThread.java:157)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="3-thenapply-第一个任务结束可能还有第二-第三个任务且后面一个任务需要用到前面任务的返回值"><a class="markdownIt-Anchor" href="#3-thenapply-第一个任务结束可能还有第二-第三个任务且后面一个任务需要用到前面任务的返回值">#</a> 3、thenApply - 第一个任务结束，可能还有第二、第三个任务，且后面一个任务，需要用到前面任务的返回值</h2>
  <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">public static void test4(String[] args) throws ExecutionException, InterruptedException &#123;</span><br><span class="line">        /**</span><br><span class="line">         * public &lt;U&gt; CompletableFuture&lt;U&gt; thenApply(Function&lt;? super T,? extends U&gt; fn)</span><br><span class="line">         * public &lt;U&gt; CompletableFuture&lt;U&gt; thenApplyAsync(Function&lt;? super T,? extends U&gt; fn)</span><br><span class="line">         * public &lt;U&gt; CompletableFuture&lt;U&gt; thenApplyAsync(Function&lt;? super T,? extends U&gt; fn, Executor executor)</span><br><span class="line">         *  总结：thenApply 接收一个函数作为参数，使用该函数处理上一个CompletableFuture 调用的结果，</span><br><span class="line">         *  并返回一个具有处理结果的Future对象。</span><br><span class="line">         *</span><br><span class="line">         */</span><br><span class="line">        CompletableFuture&lt;Integer&gt; future = CompletableFuture.supplyAsync(() -&gt; &#123;</span><br><span class="line">            int result = 100;</span><br><span class="line">            System.out.println(&quot;一阶段：&quot; + result);</span><br><span class="line">            return result;</span><br><span class="line">        &#125;).thenApply(number -&gt; &#123;</span><br><span class="line">            int result = number * 3;</span><br><span class="line">            System.out.println(&quot;二阶段：&quot; + result);</span><br><span class="line">            return result;</span><br><span class="line">        &#125;).thenApply(number -&gt; &#123;</span><br><span class="line">            int result = number * 3;</span><br><span class="line">            System.out.println(&quot;三阶段：&quot; + result);</span><br><span class="line">            return result;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        System.out.println(&quot;最终结果：&quot; + future.get());</span><br><span class="line"></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h2 id="4-thencompose-跟上面一样的作用"><a class="markdownIt-Anchor" href="#4-thencompose-跟上面一样的作用">#</a> 4、thenCompose - 跟上面一样的作用：</h2>
<p>thenCompose 的参数为一个返回 CompletableFuture 实例的函数，该函数的参数是先前计算步骤的结果。</p>
  <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">public &lt;U&gt; CompletableFuture&lt;U&gt; thenCompose(Function&lt;? super T, ? extends CompletionStage&lt;U&gt;&gt; fn);</span><br><span class="line">public &lt;U&gt; CompletableFuture&lt;U&gt; thenComposeAsync(Function&lt;? super T, ? extends CompletionStage&lt;U&gt;&gt; fn) ;</span><br><span class="line">public &lt;U&gt; CompletableFuture&lt;U&gt; thenComposeAsync(Function&lt;? super T, ? extends CompletionStage&lt;U&gt;&gt; fn, Executor executor) ;</span><br></pre></td></tr></table></figure>
  <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line">public static void main(String[] args) throws InterruptedException, ExecutionException &#123;</span><br><span class="line">    CompletableFuture&lt;Integer&gt; future = CompletableFuture.supplyAsync(new Supplier&lt;Integer&gt;() &#123;</span><br><span class="line">        @Override</span><br><span class="line">        public Integer get() &#123;</span><br><span class="line">            int number = new Random().nextInt(3);</span><br><span class="line">            System.out.println(&quot;第一阶段：&quot; + number);</span><br><span class="line">            return number;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;).thenCompose(new Function&lt;Integer, CompletionStage&lt;Integer&gt;&gt;() &#123;</span><br><span class="line">        @Override</span><br><span class="line">        public CompletionStage&lt;Integer&gt; apply(Integer param) &#123;</span><br><span class="line">            return CompletableFuture.supplyAsync(new Supplier&lt;Integer&gt;() &#123;</span><br><span class="line">                @Override</span><br><span class="line">                public Integer get() &#123;</span><br><span class="line">                    int number = param * 2;</span><br><span class="line">                    System.out.println(&quot;第二阶段：&quot; + number);</span><br><span class="line">                    return number;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    System.out.println(&quot;最终结果: &quot; + future.get());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
  <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">那么 thenApply 和 thenCompose 有何区别呢：</span><br><span class="line"></span><br><span class="line">thenApply 转换的是泛型中的类型，返回的是同一个CompletableFuture；</span><br><span class="line">thenCompose 将内部的 CompletableFuture 调用展开来并使用上一个CompletableFutre 调用的结果在下一步的 CompletableFuture 调用中进行运算，</span><br><span class="line">是生成一个新的CompletableFuture。</span><br></pre></td></tr></table></figure>
<p><strong>下面用一个例子对对比：</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">public static void main(String[] args) throws InterruptedException, ExecutionException &#123;</span><br><span class="line">    CompletableFuture&lt;String&gt; future = CompletableFuture.supplyAsync(() -&gt; &quot;Hello&quot;);</span><br><span class="line"></span><br><span class="line">    CompletableFuture&lt;String&gt; result1 = future.thenApply(param -&gt; param + &quot; World&quot;);</span><br><span class="line">    CompletableFuture&lt;String&gt; result2 = future.thenCompose(param -&gt; CompletableFuture.supplyAsync(() -&gt; param + &quot; World&quot;));</span><br><span class="line"></span><br><span class="line">    System.out.println(result1.get());</span><br><span class="line">    System.out.println(result2.get());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="5-结果消费"><a class="markdownIt-Anchor" href="#5-结果消费">#</a> 5、结果消费</h2>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">thenAccept系列：对单个结果进行消费</span><br><span class="line">thenAcceptBoth系列：对两个结果进行消费</span><br><span class="line">thenRun系列：不关心结果，只对结果执行Action</span><br></pre></td></tr></table></figure>
<p>只会拿到上个任务的值，然后对值进行消费，但是绝对不会产生新的值<br>
这是跟上面任务中间 转换的，最大的区别</p>
<p>消费结果还包括 thenRun<br>
thenRun 跟 thenAccept 的区别是，它不仅不产生新的值，还不消费上个任务的值，只是自己做一个业务处理。</p>
<p>6、结果组合<br>
 thenCombine - 合并两个线程任务的结果，并进一步处理。<br>
applyToEither - 两个线程任务相比较，先获得执行结果的，就对该结果进行下一步的转化操作。<br>
acceptEither - 两个线程任务相比较，先获得执行结果的，就对该结果进行下一步的消费操作。<br>
runAfterEither - 两个线程任务相比较，有任何一个执行完成，就进行下一步操作，不关心运行结果。<br>
runAfterBoth - 两个线程任务相比较，两个全部执行完成，才进行下一步操作，不关心运行结果。<br>
anyOf-anyOf 方法的参数是多个给定的 CompletableFuture，当其中的任何一个完成时，方法返回这个 CompletableFuture。<br>
allOf-allOf 方法用来实现多 CompletableFuture 的同时返回。</p>
<p>代码实例</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line">@RestController</span><br><span class="line">@RequestMapping(&quot;/test&quot;)</span><br><span class="line">public class TestController &#123;</span><br><span class="line"></span><br><span class="line">    public static ExecutorService threadPool =</span><br><span class="line">            new ThreadPoolExecutor(</span><br><span class="line">                    10,</span><br><span class="line">                    40,</span><br><span class="line">                    20,</span><br><span class="line">                    TimeUnit.SECONDS,</span><br><span class="line">                    new ArrayBlockingQueue&lt;Runnable&gt;(</span><br><span class="line">                            16</span><br><span class="line">                    ));</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * CompletableFuture 测试</span><br><span class="line">     *</span><br><span class="line">     * @return</span><br><span class="line">     */</span><br><span class="line">    @ApiOperation(&quot;CompletableFuture 测试&quot;)</span><br><span class="line">    @PostMapping(&quot;test&quot;)</span><br><span class="line">    public Object test() &#123;</span><br><span class="line">        Map&lt;Object, Object&gt; result = new HashMap&lt;&gt;();</span><br><span class="line">        CompletableFuture.allOf(</span><br><span class="line">                CompletableFuture.runAsync(() -&gt; &#123;</span><br><span class="line">                    System.out.println(&quot;执行1&quot;);</span><br><span class="line">                    result.put(&quot;key1&quot;, seslectData1());</span><br><span class="line">                &#125;, threadPool),</span><br><span class="line">                CompletableFuture.runAsync(() -&gt; &#123;</span><br><span class="line">                    System.out.println(&quot;执行2&quot;);</span><br><span class="line">                    result.put(&quot;key2&quot;, seslectData2());</span><br><span class="line">                &#125;, threadPool),</span><br><span class="line">                CompletableFuture.runAsync(() -&gt; &#123;</span><br><span class="line">                    System.out.println(&quot;执行3&quot;);</span><br><span class="line">                    result.put(&quot;key3&quot;, seslectData3());</span><br><span class="line">                &#125;, threadPool)</span><br><span class="line">        ).join();</span><br><span class="line"></span><br><span class="line">        return ResponseUtil.ok(result);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public String seslectData1() &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            Thread.sleep(500);</span><br><span class="line">        &#125; catch (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        return &quot;key1&quot;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public String seslectData2() &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            Thread.sleep(500);</span><br><span class="line">        &#125; catch (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        return &quot;key2&quot;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public String seslectData3() &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            Thread.sleep(300);</span><br><span class="line">        &#125; catch (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        return &quot;key3&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="关于我"><a class="markdownIt-Anchor" href="#关于我">#</a> 关于我</h2>
<p>Brath 是一个热爱技术的 Java 程序猿，公众号「InterviewCoder」定期分享有趣有料的精品原创文章！</p>
<p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/%E4%BA%8C%E7%BB%B4%E7%A0%81plus.png" alt="InterviewCoder"></p>
<p>非常感谢各位人才能看到这里，原创不易，文章如果有帮助可以关注、点赞、分享或评论，这都是对我的莫大支持！</p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2021-01-10T22:26:17.000Z" title="2021/1/11 06:26:17">2021-01-11</time>发表</span><span class="level-item"><time dateTime="2021-08-24T22:52:35.000Z" title="2021/8/25 06:52:35">2021-08-25</time>更新</span><span class="level-item">6 分钟读完 (大约966个字)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2021/01/11/%E3%80%90Elasticsearch%E3%80%91Linux%E7%8E%AF%E5%A2%83%E4%B8%8B%E5%AE%89%E8%A3%85%E5%B9%B6%E5%90%AF%E5%8A%A8Elasticsearch7/">Linux环境下安装并启动Elasticsearch7</a></p><div class="content"><p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/%E6%89%AB%E7%A0%81_%E6%90%9C%E7%B4%A2%E8%81%94%E5%90%88%E4%BC%A0%E6%92%AD%E6%A0%B7%E5%BC%8F-%E6%A0%87%E5%87%86%E8%89%B2%E7%89%88.png" alt="InterviewCoder"></p>
<h3 id="elasticsearch"><a class="markdownIt-Anchor" href="#elasticsearch">#</a> Elasticsearch</h3>
<p>​        Elasticsearch (ES) 是一个基于 Lucene 构建的开源、分布式、RESTful 接口全文搜索引擎。Elasticsearch 还是一个分布式文档数据库，其中每个字段均是被索引的数据且可被搜索，它能够扩展至数以百计的服务器存储以及处理 PB 级的数据。它可以在很短的时间内在存储、搜索和分析大量的数据。它通常作为具有复杂搜索场景情况下的核心发动机。es 是由 java 语言编写的。</p>
<pre><code>Elasticsearch就是为高可用和可扩展而生的。可以通过购置性能更强的服务器来完成。
</code></pre>
<p><a target="_blank" rel="noopener" href="https://www.elastic.co/cn/elasticsearch/">Elasticsearch：官方分布式搜索和分析引擎 | Elastic<img src="https://brath.oss-cn-shanghai.aliyuncs.com/pigo/icon-default.png" alt="img">https://www.elastic.co/cn/elasticsearch/</a></p>
<h2 id=""><a class="markdownIt-Anchor" href="#">#</a> </h2>
<h2 id="linux里部署es"><a class="markdownIt-Anchor" href="#linux里部署es">#</a> Linux 里部署 ES</h2>
<h3 id="下载地址"><a class="markdownIt-Anchor" href="#下载地址">#</a> 下载地址</h3>
<p>​        我下载的版本是 ES7.15.1</p>
<p>Elasticsearch 7.15.1 | Elastic<img src="https://brath.oss-cn-shanghai.aliyuncs.com/pigo/apple-icon-57x57.png" alt="img"><a target="_blank" rel="noopener" href="https://www.elastic.co/cn/downloads/past-releases/elasticsearch-7-15-1">https://www.elastic.co/cn/downloads/past-releases/elasticsearch-7-15-1</a></p>
<p><img src="https://brath.oss-cn-shanghai.aliyuncs.com/pigo/74a3f6fc611945ebb8e492204fe4b51f.png" alt="img"></p>
<p><img src="https://brath.oss-cn-shanghai.aliyuncs.com/pigo/4490382f8fd54a48bbd8e2ffaf2ce6ea.png" alt="img"></p>
<h3 id="上传到linux"><a class="markdownIt-Anchor" href="#上传到linux">#</a> 上传到 Linux</h3>
<p>​    压缩包下载完成后上传到服务器</p>
<p><img src="https://brath.oss-cn-shanghai.aliyuncs.com/pigo/3732b77fcd15428e8397739b50f6b3b1.png" alt="img"></p>
<h3 id="解压软件"><a class="markdownIt-Anchor" href="#解压软件">#</a> 解压软件</h3>
<p>​     解压到上级目录，然后进行改名</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">解压缩</span></span><br><span class="line">tar -zxvf elasticsearch-7.15.1-linux-x86_64.tar.gz -C ../</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">改名</span></span><br><span class="line">mv elasticsearch-7.15.1 es-7.15.1</span><br></pre></td></tr></table></figure>
<p><img src="https://brath.oss-cn-shanghai.aliyuncs.com/pigo/e6ff579f0e6b4aa6994e17629bbaa96a.png" alt="img"></p>
<p><img src="https://brath.oss-cn-shanghai.aliyuncs.com/pigo/7678de3df173498e92409dc8300f09b5.png" alt="img"></p>
<p>在 /opt 目录下新建 module/es 目录，同时把 es-7.15.1 移到该目录</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mv es-7.15.1 /opt/module/es</span><br></pre></td></tr></table></figure>
<h3 id="创建用户"><a class="markdownIt-Anchor" href="#创建用户">#</a> 创建用户</h3>
<p>​    因为安全问题， Elasticsearch 不允许 root 用户直接运行，所以要创建新用户，在 root 用户中创建新用户。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">useradd es #新增 es 用户</span><br><span class="line">passwd es #为 es 用户设置密码</span><br><span class="line">userdel -r es #如果错了，可以删除再加</span><br><span class="line">chown -R es:es /opt/module/es/es-7.15.1 #文件夹所有者</span><br></pre></td></tr></table></figure>
<p><img src="https://brath.oss-cn-shanghai.aliyuncs.com/pigo/cf9ac437254f47bfa9e26f4770fa9667.png" alt="img"></p>
<p><img src="https://brath.oss-cn-shanghai.aliyuncs.com/pigo/3b5a89b6cdbb4a3bb6220423400e25d2.png" alt="img"></p>
<h3 id="修改配置文件"><a class="markdownIt-Anchor" href="#修改配置文件">#</a> 修改配置文件</h3>
<p>修改 /root/es-7.15.1/config/elasticsearch.yml 文件。</p>
<p><img src="https://brath.oss-cn-shanghai.aliyuncs.com/pigo/d40fbb16c317400495682be93a2e07d7.png" alt="img"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># 加入如下配置</span><br><span class="line">cluster.name: elasticsearch</span><br><span class="line">node.name: node-1</span><br><span class="line">network.host: 0.0.0.0</span><br><span class="line">http.port: 9200</span><br><span class="line">cluster.initial_master_nodes: [&quot;node-1&quot;]</span><br></pre></td></tr></table></figure>
<p><img src="https://brath.oss-cn-shanghai.aliyuncs.com/pigo/00e7d21c15c640ba949d3dda5e9ee885.png" alt="img"></p>
<h3 id="修改etcsecuritylimitsconf"><a class="markdownIt-Anchor" href="#修改etcsecuritylimitsconf">#</a> 修改 /etc/security/limits.conf</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># 在文件末尾中增加下面内容</span><br><span class="line"># 每个进程可以打开的文件数的限制</span><br><span class="line">es soft nofile 65536</span><br><span class="line">es hard nofile 65536</span><br></pre></td></tr></table></figure>
<p><img src="https://brath.oss-cn-shanghai.aliyuncs.com/pigo/4d4441f8e29346a0bc5a0ac8959477d9.png" alt="img"></p>
<h3 id="修改etcsysctlconf"><a class="markdownIt-Anchor" href="#修改etcsysctlconf">#</a> 修改 /etc/sysctl.conf</h3>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">在文件中增加下面内容</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">一个进程可以拥有的 VMA(虚拟内存区域)的数量,默认值为 65536</span></span><br><span class="line">vm.max_map_count=655360</span><br></pre></td></tr></table></figure>
<h3 id="重新加载"><a class="markdownIt-Anchor" href="#重新加载">#</a> 重新加载</h3>
<p>sysctl -p</p>
<h3 id="注意"><a class="markdownIt-Anchor" href="#注意">#</a> 注意：</h3>
<p>​    启动前需要先切换到 es 用户</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">su es</span><br></pre></td></tr></table></figure>
<h3 id="启动es"><a class="markdownIt-Anchor" href="#启动es">#</a> 启动 es</h3>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">启动 进入bin目录：</span></span><br><span class="line">./elasticsearch</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">后台启动</span></span><br><span class="line">./elasticsearch -d  </span><br></pre></td></tr></table></figure>
<h3 id="测试连接"><a class="markdownIt-Anchor" href="#测试连接">#</a> 测试连接</h3>
<p>​    浏览器中打开 <a target="_blank" rel="noopener" href="http://xn--ip-fr5c86lx7z:9200/">http:// 服务器 IP:9200/</a>, 出现如下则说明安装成功</p>
<p><img src="https://brath.oss-cn-shanghai.aliyuncs.com/pigo/0197dcff901f47279750939332674547.png" alt="img"></p>
<h2 id="关于我"><a class="markdownIt-Anchor" href="#关于我">#</a> 关于我</h2>
<p>Brath 是一个热爱技术的 Java 程序猿，公众号「InterviewCoder」定期分享有趣有料的精品原创文章！</p>
<p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/%E4%BA%8C%E7%BB%B4%E7%A0%81plus.png" alt="InterviewCoder"></p>
<p>非常感谢各位人才能看到这里，原创不易，文章如果有帮助可以关注、点赞、分享或评论，这都是对我的莫大支持！</p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2021-01-08T06:37:17.000Z" title="2021/1/8 14:37:17">2021-01-08</time>发表</span><span class="level-item"><time dateTime="2023-10-08T18:01:59.000Z" title="2023/10/9 02:01:59">2023-10-09</time>更新</span><span class="level-item">2 分钟读完 (大约306个字)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2021/01/08/%E3%80%90Flutter%E3%80%91Flutter%E5%BC%80%E5%8F%91%E4%B8%AD%E4%BD%BF%E7%94%A8WIFI%E7%9C%9F%E6%9C%BA%E8%B0%83%E8%AF%95/">Flutter开发中使用WIFI真机调试</a></p><div class="content"><p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/%E6%89%AB%E7%A0%81_%E6%90%9C%E7%B4%A2%E8%81%94%E5%90%88%E4%BC%A0%E6%92%AD%E6%A0%B7%E5%BC%8F-%E6%A0%87%E5%87%86%E8%89%B2%E7%89%88.png" alt="InterviewCoder"></p>
<h1 id="flutter开发中使用wifi真机调试"><a class="markdownIt-Anchor" href="#flutter开发中使用wifi真机调试">#</a> Flutter 开发中使用 WIFI 真机调试</h1>
<h4 id="使用vscode开发flutter用wifi-或者-手机热点进行-无线调试过程"><a class="markdownIt-Anchor" href="#使用vscode开发flutter用wifi-或者-手机热点进行-无线调试过程">#</a> 使用 vscode 开发 flutter，用 wifi 或者 手机热点进行 无线调试过程</h4>
<h4 id="1手机连接wifi后在设置中找到ip和端口"><a class="markdownIt-Anchor" href="#1手机连接wifi后在设置中找到ip和端口">#</a> 1. 手机连接 wifi 后在设置中找到 ip 和端口</h4>
<h4 id="2在vscode终端输入-adb-connect-手机ip手机端口"><a class="markdownIt-Anchor" href="#2在vscode终端输入-adb-connect-手机ip手机端口">#</a> 2. 在 vscode 终端输入 adb connect 手机 IP: 手机端口</h4>
<h4 id="3作者在csdn这个烂环境中没找到有用的信息全是粘贴的所以希望这篇文章帮助到你你可以把我的地址列出来粘贴可以抄袭可耻"><a class="markdownIt-Anchor" href="#3作者在csdn这个烂环境中没找到有用的信息全是粘贴的所以希望这篇文章帮助到你你可以把我的地址列出来粘贴可以抄袭可耻">#</a> 3. 作者在 CSDN 这个烂环境中没找到有用的信息，全是粘贴的，所以希望这篇文章帮助到你，你可以把我的地址列出来，粘贴可以，抄袭可耻！</h4>
<h4 id="4完成以上步骤手机端应有开启无线调试的提示记得提前打开开发者模式"><a class="markdownIt-Anchor" href="#4完成以上步骤手机端应有开启无线调试的提示记得提前打开开发者模式">#</a> 4. 完成以上步骤，手机端应有开启无线调试的提示，记得提前打开开发者模式。</h4>
<h2 id="关于我"><a class="markdownIt-Anchor" href="#关于我">#</a> 关于我</h2>
<p>Brath 是一个热爱技术的 Java 程序猿，公众号「InterviewCoder」定期分享有趣有料的精品原创文章！</p>
<p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/%E4%BA%8C%E7%BB%B4%E7%A0%81plus.png" alt="InterviewCoder"></p>
<p>非常感谢各位人才能看到这里，原创不易，文章如果有帮助可以关注、点赞、分享或评论，这都是对我的莫大支持！</p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2021-01-01T18:18:05.000Z" title="2021/1/2 02:18:05">2021-01-02</time>发表</span><span class="level-item"><time dateTime="2023-09-17T05:27:20.000Z" title="2023/9/17 13:27:20">2023-09-17</time>更新</span><span class="level-item">8 分钟读完 (大约1170个字)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2021/01/02/%E3%80%90Vue%E3%80%91JSON%E7%BC%96%E8%BE%91%E5%99%A8Bin-Coder/">【Vue】JSON编辑器Bin-Coder</a></p><div class="content"><p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/%E6%89%AB%E7%A0%81_%E6%90%9C%E7%B4%A2%E8%81%94%E5%90%88%E4%BC%A0%E6%92%AD%E6%A0%B7%E5%BC%8F-%E6%A0%87%E5%87%86%E8%89%B2%E7%89%88.png" alt="InterviewCoder"></p>
<h1 id="vuejson编辑器bin-coder"><a class="markdownIt-Anchor" href="#vuejson编辑器bin-coder">#</a> 【Vue】JSON 编辑器 Bin-Coder</h1>
<p><a target="_blank" rel="noopener" href="https://wangbin3162.gitee.io/bin-code-editor/#/guide">Bin Code Editor</a></p>
<h1 id="1-安装"><a class="markdownIt-Anchor" href="#1-安装">#</a> 1 安装</h1>
<h2 id="11-cdn-安装"><a class="markdownIt-Anchor" href="#11-cdn-安装">#</a> 1.1 CDN 安装</h2>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- <span class="keyword">import</span> <span class="title class_">Vue</span>.<span class="property">js</span> --&gt;</span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;https://cdn.jsdelivr.net/npm/vue&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span></span><br><span class="line">&lt;!-- <span class="keyword">import</span> stylesheet --&gt;</span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">&quot;stylesheet&quot;</span> <span class="attr">href</span>=<span class="string">&quot;https://unpkg.com/bin-code-editor@0.1.0/lib/styles/index.css&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="comment">&lt;!-- import bin-code-editor --&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;https://unpkg.com/bin-code-editor@0.1.0/lib/bin-code-editor.min.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span></span><br></pre></td></tr></table></figure>
<p>@0.1.0 表示版本号，我们建议锁定版本号来保证代码的稳定性</p>
<h2 id="12-npm-安装"><a class="markdownIt-Anchor" href="#12-npm-安装">#</a> 1.2 npm 安装</h2>
<p>推荐使用 npm 安装，它能更好地和<a target="_blank" rel="noopener" href="https://so.csdn.net/so/search?q=webpack%E6%89%93%E5%8C%85&amp;spm=1001.2101.3001.7020"> webpack 打包</a>工具配合使用。而且可以更好的和 es6 配合使用。并且支持按需引入</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">npm i bin-code-editor -S</span><br><span class="line"># or </span><br><span class="line">yarn add bin-code-editor</span><br></pre></td></tr></table></figure>
<h1 id="2-引入"><a class="markdownIt-Anchor" href="#2-引入">#</a> 2 引入</h1>
<p>在 main.js 中写入以下内容：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="title class_">Vue</span> <span class="keyword">from</span> <span class="string">&#x27;vue&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="title class_">CodeEditor</span> <span class="keyword">from</span> <span class="string">&#x27;bin-code-editor&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">&#x27;bin-code-editor/lib/style/index.css&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="title class_">App</span> <span class="keyword">from</span> <span class="string">&#x27;./App.vue&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="title class_">Vue</span>.<span class="title function_">use</span>(<span class="title class_">CodeEditor</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">new</span> <span class="title class_">Vue</span>(&#123;</span><br><span class="line">  <span class="attr">el</span>: <span class="string">&#x27;#app&#x27;</span>,</span><br><span class="line">  <span class="attr">render</span>: <span class="function"><span class="params">h</span> =&gt;</span> <span class="title function_">h</span>(<span class="title class_">App</span>)</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h1 id="3-用法"><a class="markdownIt-Anchor" href="#3-用法">#</a> 3 用法</h1>
<p>注意，初始化如果有数据，则会默认格式化一次，格式化快捷键默认为 F7, 使用时可以进行格式化结构！</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">JSON.stringify(JSON.parse(jsonData),null,2)`可以将默认json进行预格式化,也可以手动触发formatCode()来格式化</span><br><span class="line">`JSON.stringify(value[, replacer[, space]])</span><br></pre></td></tr></table></figure>
<p>参数说明：</p>
<ul>
<li>value: 必需， 要转换的 JavaScript 值（通常为对象或数组）。</li>
<li>replacer: 可选。用于转换结果的函数或数组。如果 replacer 为函数，则 JSON.stringify 将调用该函数，并传入每个成员的键和值。使用返回值而不是原始值。如果此函数返回 undefined，则排除成员。根对象的键是一个空字符串：“”。如果 replacer 是一个数组，则仅转换该数组中具有键值的成员。成员的转换顺序与键在数组中的顺序一样。</li>
<li>space: 可选，文本添加缩进、空格和换行符，如果 space 是一个数字，则返回值文本在每个级别缩进指定数目的空格，如果 space 大于 10，则文本缩进 10 个空格。space 也可以使用非数字，如：\t。</li>
</ul>
<p><img src="https://img-blog.csdnimg.cn/ba155f2c67e14cc0b063a92a683220ff.png" alt="在这里插入图片描述"></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">  <span class="tag">&lt;<span class="name">b-code-editor</span> <span class="attr">v-model</span>=<span class="string">&quot;jsonStr&quot;</span> <span class="attr">:indent-unit</span>=<span class="string">&quot;4&quot;</span> <span class="attr">height</span>=<span class="string">&quot;auto&quot;</span>/&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">&lt;/template&gt;</span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">  <span class="keyword">const</span> jsonData = <span class="string">`&#123;&quot;title&quot;:&quot;测试json数据&quot;,&quot;children&quot;:[&#123;&quot;name&quot;:&quot;子项名称&quot;, &quot;desc&quot;:&quot;子项说明&quot; &#125;,&#123;&quot;name&quot;:&quot;子项名称1&quot;, &quot;desc&quot;:&quot;子项说明1&quot; &#125;]&#125;`</span></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml"></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">  <span class="keyword">export</span> <span class="keyword">default</span> &#123;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">    <span class="title function_">data</span>(<span class="params"></span>) &#123;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">      <span class="keyword">return</span> &#123;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">        <span class="attr">jsonStr</span>: jsonData</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">      &#125;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">    &#125;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">  &#125;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span></span><br></pre></td></tr></table></figure>
<h1 id="4-其他配置项"><a class="markdownIt-Anchor" href="#4-其他配置项">#</a> 4 其他配置项</h1>
<table>
<thead>
<tr>
<th>参数</th>
<th>说明</th>
<th>类型</th>
<th>可选值</th>
<th>默认值</th>
</tr>
</thead>
<tbody>
<tr>
<td>value</td>
<td>绑定数据，可用 v-model</td>
<td>String</td>
<td>—</td>
<td>0</td>
</tr>
<tr>
<td>show-number</td>
<td>显示行号</td>
<td>Boolean</td>
<td>—</td>
<td>true</td>
</tr>
<tr>
<td>mode</td>
<td>模式</td>
<td>String</td>
<td>‘application/json’,‘text/javascript’</td>
<td>‘application/json’</td>
</tr>
<tr>
<td>theme</td>
<td>提供若干个默认比较好看的皮肤</td>
<td>String</td>
<td>可选值参考其他配置项中列出</td>
<td>idea</td>
</tr>
<tr>
<td>lint</td>
<td>是否进行 lint 检查</td>
<td>Boolean</td>
<td>暂时只支持 json</td>
<td>true</td>
</tr>
<tr>
<td>readonly</td>
<td>只读模式</td>
<td>Boolean</td>
<td>-</td>
<td>false</td>
</tr>
<tr>
<td>auto-format</td>
<td>是否自动格式化</td>
<td>Boolean</td>
<td>-</td>
<td>true</td>
</tr>
<tr>
<td>indent-unit</td>
<td>缩进字符</td>
<td>Number</td>
<td>-</td>
<td>2</td>
</tr>
<tr>
<td>smart-indent</td>
<td>是否自动缩进</td>
<td>Boolean</td>
<td>-</td>
<td>true</td>
</tr>
<tr>
<td>line-wrap</td>
<td>代码换行</td>
<td>Boolean</td>
<td>-</td>
<td>true</td>
</tr>
<tr>
<td>gutter</td>
<td>代码折叠</td>
<td>Boolean</td>
<td>-</td>
<td>true</td>
</tr>
<tr>
<td>height</td>
<td>默认编辑器高度</td>
<td>String</td>
<td>—</td>
<td>300px</td>
</tr>
</tbody>
</table>
<h1 id="5-events-事件"><a class="markdownIt-Anchor" href="#5-events-事件">#</a> 5 Events 事件</h1>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">	<span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">	  <span class="tag">&lt;<span class="name">b-code-editor</span> <span class="attr">v-model</span>=<span class="string">&quot;jsonStr&quot;</span> <span class="attr">:indent-unit</span>=<span class="string">&quot;4&quot;</span> <span class="attr">height</span>=<span class="string">&quot;auto&quot;</span>/&gt;</span></span></span><br><span class="line"><span class="language-xml">	  <span class="tag">&lt;<span class="name">p</span>&gt;</span><span class="tag">&lt;<span class="name">b-button</span> @<span class="attr">click</span>=<span class="string">&quot;$refs[&#x27;editor&#x27;].formatCode()&quot;</span>&gt;</span>手动触发格式化<span class="tag">&lt;/<span class="name">b-button</span>&gt;</span><span class="tag">&lt;/<span class="name">p</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">	<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">&lt;/template&gt;</span><br></pre></td></tr></table></figure>
<table>
<thead>
<tr>
<th>事件名</th>
<th>说明</th>
<th>返回值</th>
</tr>
</thead>
<tbody>
<tr>
<td>on-change</td>
<td>输入项改变事件</td>
<td>value</td>
</tr>
<tr>
<td>formatCode</td>
<td>手动触发格式化方法</td>
<td>-</td>
</tr>
<tr>
<td>refresh</td>
<td>手动刷新方法</td>
<td>-</td>
</tr>
<tr>
<td>getValue</td>
<td>自行获取值</td>
<td>-</td>
</tr>
</tbody>
</table>
<h1 id="6-theme-皮肤属性"><a class="markdownIt-Anchor" href="#6-theme-皮肤属性">#</a> 6 theme 皮肤属性</h1>
<p><code>theme</code>  属性可选值</p>
<ul>
<li>idea<br>
<img src="https://img-blog.csdnimg.cn/774c7c41e1fd4dad81c4a8c4d56fb608.png" alt="在这里插入图片描述"></li>
<li>eclipse<br>
<img src="https://img-blog.csdnimg.cn/97d00490aa2c452e96cc64717798c9d5.png" alt="在这里插入图片描述"></li>
<li>duotone-light<br>
<img src="https://img-blog.csdnimg.cn/a9a97cd2eff84e60b687ddf8368c6e50.png" alt="在这里插入图片描述"></li>
<li>mdn-like<br>
<img src="https://img-blog.csdnimg.cn/68288d52b01d41fab7653d9c3dcfb10a.png" alt="在这里插入图片描述"></li>
<li>xq-light<br>
<img src="https://img-blog.csdnimg.cn/988f7ebe12ff42ef80f6b1a527bed1c7.png" alt="在这里插入图片描述"></li>
<li>dracula<br>
<img src="https://img-blog.csdnimg.cn/2aa62e024dbd41158a8bc66db799ef82.png" alt="在这里插入图片描述"></li>
<li>rubyblue<br>
<img src="https://img-blog.csdnimg.cn/04b909ae46234a0c871daa0545215526.png" alt="在这里插入图片描述"></li>
<li>monokai<br>
<img src="https://img-blog.csdnimg.cn/7baa723e068747a885ae2fa3b80048d2.png" alt="在这里插入图片描述"></li>
<li>material<br>
<img src="https://img-blog.csdnimg.cn/f949cc3c5f7344dc98c38751bd8db085.png" alt="在这里插入图片描述"></li>
<li>material-darker<br>
<img src="https://img-blog.csdnimg.cn/48f9a957450641e4b0ebb269f09aba7d.png" alt="在这里插入图片描述"></li>
</ul>
<h2 id="关于我"><a class="markdownIt-Anchor" href="#关于我">#</a> 关于我</h2>
<p>Brath 是一个热爱技术的 Java 程序猿，公众号「InterviewCoder」定期分享有趣有料的精品原创文章！</p>
<p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/%E4%BA%8C%E7%BB%B4%E7%A0%81plus.png" alt="InterviewCoder"></p>
<p>非常感谢各位人才能看到这里，原创不易，文章如果有帮助可以关注、点赞、分享或评论，这都是对我的莫大支持！</p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2020-12-27T18:13:58.000Z" title="2020/12/28 02:13:58">2020-12-28</time>发表</span><span class="level-item"><time dateTime="2019-09-08T00:30:30.000Z" title="2019/9/8 08:30:30">2019-09-08</time>更新</span><span class="level-item">41 分钟读完 (大约6102个字)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2020/12/28/%E3%80%90SpringBoot%E3%80%91SpringBoot3.0%20%E4%BA%91%E5%8E%9F%E7%94%9F%E6%97%B6%E4%BB%A3%E5%8D%B3%E5%B0%86%E6%9D%A5%E4%B8%B4%EF%BC%81/">【SpringBoot】SpringBoot3.0 云原生时代即将来临！</a></p><div class="content"><p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/%E6%89%AB%E7%A0%81_%E6%90%9C%E7%B4%A2%E8%81%94%E5%90%88%E4%BC%A0%E6%92%AD%E6%A0%B7%E5%BC%8F-%E6%A0%87%E5%87%86%E8%89%B2%E7%89%88.png" alt="InterviewCoder"></p>
<h1 id="springbootspringboot30-云原生时代即将来临"><a class="markdownIt-Anchor" href="#springbootspringboot30-云原生时代即将来临">#</a> 【SpringBoot】SpringBoot3.0 云原生时代即将来临！</h1>
<p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/v2-b22194eefe2fd58e5b41e3ff07bef672_720w.jpg" alt="云原生时代的Spring Boot 3.0: GraalVM原生镜像，启动速度提升近30倍"></p>
<h1 id="云原生时代的spring-boot-30-graalvm原生镜像启动速度提升近30倍"><a class="markdownIt-Anchor" href="#云原生时代的spring-boot-30-graalvm原生镜像启动速度提升近30倍">#</a> 云原生时代的 Spring Boot 3.0: GraalVM 原生镜像，启动速度提升近 30 倍</h1>
<p><a target="_blank" rel="noopener" href="https://brath.top">InterviewCoder</a></p>
<h5 id="spring-boot-30-于2022年11月24日发布变化很大基于spring60spring60是spring下一个未来十年的新开端"><a class="markdownIt-Anchor" href="#spring-boot-30-于2022年11月24日发布变化很大基于spring60spring60是spring下一个未来十年的新开端">#</a> Spring Boot 3.0 于（2022 年 11 月 24 日）发布，变化很大，基于 spring6.0，spring6.0 是 Spring 下一个未来十年的新开端。</h5>
<h2 id="java-17"><a class="markdownIt-Anchor" href="#java-17">#</a> JAVA 17</h2>
<p>Spring Boot 3.0 版本最低支持 Java17，Springboot 2.7.3 最常用的 jdk 版本是 Java 8，现在直接跳了 9 个版本直接从 8 跳到了 17，且是强制要求，必须 17 或 17 以上的 java 版本。所以以后开发可以用上 17 或 17 以上的 Java 语言的新特性。</p>
<h2 id="spring-native"><a class="markdownIt-Anchor" href="#spring-native">#</a> Spring Native</h2>
<p>Spring Native 也是升级的一个重大特性，支持使用 GraalVM 将 Spring 的应用程序编译成本地可执行的镜像文件，可以显著提升启动速度、峰值性能以及减少内存使用。</p>
<p>我们传统的应用都是编译成字节码，然后通过 JVM 解释并最终编译成机器码来运行，而 Spring Native 则是通过 AOT 提前编译为机器码，在运行时直接静态编译成可执行文件，不依赖 JVM。</p>
<p><img src="https://pic2.zhimg.com/80/v2-a45dfbebce31c21085d718d07a8d9f25_720w.webp" alt="img"></p>
<h2 id="jakarta-ee"><a class="markdownIt-Anchor" href="#jakarta-ee">#</a> Jakarta EE</h2>
<p>JavaEE 改名之后就叫 JakartaEE，比如我们之前的 javax.servlet 包现在就叫 jakarta.servlet。也因此，代码中所有使用到比如 HttpServletRequest 对象的 import 都需要修改。</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">import javax.servlet.http.HttpServletRequest;</span><br><span class="line">// 改为</span><br><span class="line">import jakarta.servlet.http.HttpServletRequest;</span><br></pre></td></tr></table></figure>
<h2 id="spring-boot-30-初步使用windows"><a class="markdownIt-Anchor" href="#spring-boot-30-初步使用windows">#</a> Spring Boot 3.0 初步使用（Windows）</h2>
<p>创建 Spring Boot 3.0 项目有两种方式，一种是 Idea 直接创建。</p>
<p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/v2-519c165c4aa07ee2398da2624c44b1c1_720w.webp" alt="img"></p>
<p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/v2-fe1b1c0136ace8b2d89964265f367fc0_720w.webp" alt="img"></p>
<p>若 IDE 不是最新版本，不支持创建 Spring Boot 3.0，还有第二种方式创建 Spring Boot 3.0 项目，登录官网 <a href="https://link.zhihu.com/?target=https%3A//start.spring.io/">https://start.spring.io/</a> 生成 Spring Boot 3.0 初始项目。</p>
<p><img src="https://pic4.zhimg.com/80/v2-0be01b9e082d8c08e14dc2a7f30a8573_720w.webp" alt="img"></p>
<p>下面是 Spring Boot 3.0 的最小 pom 文件内容：</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span><br><span class="line">&lt;project xmlns=&quot;http://maven.apache.org/POM/4.0.0&quot; xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span><br><span class="line">	xsi:schemaLocation=&quot;http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd&quot;&gt;</span><br><span class="line">	&lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;</span><br><span class="line">	&lt;parent&gt;</span><br><span class="line">		&lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">		&lt;artifactId&gt;spring-boot-starter-parent&lt;/artifactId&gt;</span><br><span class="line">		&lt;version&gt;3.0.0&lt;/version&gt;</span><br><span class="line">		&lt;relativePath/&gt; &lt;!-- lookup parent from repository --&gt;</span><br><span class="line">	&lt;/parent&gt;</span><br><span class="line">	&lt;groupId&gt;com.example&lt;/groupId&gt;</span><br><span class="line">	&lt;artifactId&gt;demo&lt;/artifactId&gt;</span><br><span class="line">	&lt;version&gt;0.0.1-SNAPSHOT&lt;/version&gt;</span><br><span class="line">	&lt;name&gt;demo&lt;/name&gt;</span><br><span class="line">	&lt;description&gt;Demo project for Spring Boot&lt;/description&gt;</span><br><span class="line">	&lt;properties&gt;</span><br><span class="line">		&lt;java.version&gt;17&lt;/java.version&gt;</span><br><span class="line">	&lt;/properties&gt;</span><br><span class="line">	&lt;dependencies&gt;</span><br><span class="line">		&lt;dependency&gt;</span><br><span class="line">			&lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">			&lt;artifactId&gt;spring-boot-starter&lt;/artifactId&gt;</span><br><span class="line">		&lt;/dependency&gt;</span><br><span class="line"></span><br><span class="line">		&lt;dependency&gt;</span><br><span class="line">			&lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">			&lt;artifactId&gt;spring-boot-starter-test&lt;/artifactId&gt;</span><br><span class="line">			&lt;scope&gt;test&lt;/scope&gt;</span><br><span class="line">		&lt;/dependency&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt;</span><br><span class="line">            &lt;version&gt;3.0.0&lt;/version&gt;</span><br><span class="line">            &lt;scope&gt;compile&lt;/scope&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line">    &lt;/dependencies&gt;</span><br><span class="line"></span><br><span class="line">	&lt;build&gt;</span><br><span class="line">		&lt;plugins&gt;</span><br><span class="line">			&lt;plugin&gt;</span><br><span class="line">				&lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">				&lt;artifactId&gt;spring-boot-maven-plugin&lt;/artifactId&gt;</span><br><span class="line">			&lt;/plugin&gt;</span><br><span class="line">		&lt;/plugins&gt;</span><br><span class="line">	&lt;/build&gt;</span><br><span class="line"></span><br><span class="line">&lt;/project&gt;</span><br></pre></td></tr></table></figure>
<p>运行 spring boot 项目，需要安装开发环境，spring boot 3.0 开始不用 jdk 了，取而代之的是 graalvm，且最低版本要求是 java17 graalvm 版本。</p>
<p><a href="https://link.zhihu.com/?target=https%3A//github.com/graalvm/graalvm-ce-builds/releases">https://github.com/graalvm/graalvm-ce-builds/releases</a> 下载对应操作系统的 java17 graalvm 版本。</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">PS C:\Users\hanwei&gt; java --version</span><br><span class="line">openjdk 17.0.5 2022-10-18</span><br><span class="line">OpenJDK Runtime Environment GraalVM CE 22.3.0 (build 17.0.5+8-jvmci-22.3-b08)</span><br><span class="line">OpenJDK 64-Bit Server VM GraalVM CE 22.3.0 (build 17.0.5+8-jvmci-22.3-b08, mixed mode, sharing)</span><br></pre></td></tr></table></figure>
<p>在最小 Spring Boot 项目源码的基础上了个简单的 controller。</p>
<p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/v2-f413a5156cf2f0b1bdea0a81e417c622_720w.webp" alt="img"></p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">package com.example.demo.controller;</span><br><span class="line"></span><br><span class="line">import org.springframework.stereotype.Controller;</span><br><span class="line">import org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line">import org.springframework.web.bind.annotation.ResponseBody;</span><br><span class="line"></span><br><span class="line">@Controller</span><br><span class="line">public class QuickStartController &#123;</span><br><span class="line">    @RequestMapping(&quot;/test&quot;)</span><br><span class="line">    @ResponseBody</span><br><span class="line">    public String test()&#123;</span><br><span class="line">        return &quot;springboot 3.0 访问测试&quot;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @RequestMapping(&quot;/hello&quot;)</span><br><span class="line">    @ResponseBody</span><br><span class="line">    public String home()&#123;</span><br><span class="line">        return &quot;Hello World from springboot 3.0!&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>用 java17 graalvm 编译运行 demo 项目。</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">C:\sdk\graalvm-ce-java17-22.3.0\bin\java.exe -XX:TieredStopAtLevel=1 -Dspring.output.ansi.enabled=always -Dcom.sun.management.jmxremote -Dspring.jmx.enabled=true -Dspring.liveBeansView.mbeanDomain -Dspring.application.admin.enabled=true &quot;-javaagent:C:\Program Files\JetBrains\IntelliJ IDEA 2022.2\lib\idea_rt.jar=9872:C:\Program Files\JetBrains\IntelliJ IDEA 2022.2\bin&quot; -Dfile.encoding=UTF-8 -classpath C:\Users\hanwei\Documents\JavaProject\demo-maven\target\classes;C:\Users\hanwei\.m2\repository\org\springframework\boot\spring-boot-starter\3.0.0\spring-boot-starter-3.0.0.jar;C:\Users\hanwei\.m2\repository\org\springframework\boot\spring-boot\3.0.0\spring-boot-3.0.0.jar;C:\Users\hanwei\.m2\repository\org\springframework\spring-context\6.0.2\spring-context-6.0.2.jar;C:\Users\hanwei\.m2\repository\org\springframework\boot\spring-boot-autoconfigure\3.0.0\spring-boot-autoconfigure-3.0.0.jar;C:\Users\hanwei\.m2\repository\org\springframework\boot\spring-boot-starter-logging\3.0.0\spring-boot-starter-logging-3.0.0.jar;C:\Users\hanwei\.m2\repository\ch\qos\logback\logback-classic\1.4.5\logback-classic-1.4.5.jar;C:\Users\hanwei\.m2\repository\ch\qos\logback\logback-core\1.4.5\logback-core-1.4.5.jar;C:\Users\hanwei\.m2\repository\org\apache\logging\log4j\log4j-to-slf4j\2.19.0\log4j-to-slf4j-2.19.0.jar;C:\Users\hanwei\.m2\repository\org\apache\logging\log4j\log4j-api\2.19.0\log4j-api-2.19.0.jar;C:\Users\hanwei\.m2\repository\org\slf4j\jul-to-slf4j\2.0.4\jul-to-slf4j-2.0.4.jar;C:\Users\hanwei\.m2\repository\jakarta\annotation\jakarta.annotation-api\2.1.1\jakarta.annotation-api-2.1.1.jar;C:\Users\hanwei\.m2\repository\org\springframework\spring-core\6.0.2\spring-core-6.0.2.jar;C:\Users\hanwei\.m2\repository\org\springframework\spring-jcl\6.0.2\spring-jcl-6.0.2.jar;C:\Users\hanwei\.m2\repository\org\yaml\snakeyaml\1.33\snakeyaml-1.33.jar;C:\Users\hanwei\.m2\repository\org\slf4j\slf4j-api\2.0.4\slf4j-api-2.0.4.jar;C:\Users\hanwei\.m2\repository\org\springframework\boot\spring-boot-starter-web\3.0.0\spring-boot-starter-web-3.0.0.jar;C:\Users\hanwei\.m2\repository\org\springframework\boot\spring-boot-starter-json\3.0.0\spring-boot-starter-json-3.0.0.jar;C:\Users\hanwei\.m2\repository\com\fasterxml\jackson\core\jackson-databind\2.14.1\jackson-databind-2.14.1.jar;C:\Users\hanwei\.m2\repository\com\fasterxml\jackson\core\jackson-annotations\2.14.1\jackson-annotations-2.14.1.jar;C:\Users\hanwei\.m2\repository\com\fasterxml\jackson\core\jackson-core\2.14.1\jackson-core-2.14.1.jar;C:\Users\hanwei\.m2\repository\com\fasterxml\jackson\datatype\jackson-datatype-jdk8\2.14.1\jackson-datatype-jdk8-2.14.1.jar;C:\Users\hanwei\.m2\repository\com\fasterxml\jackson\datatype\jackson-datatype-jsr310\2.14.1\jackson-datatype-jsr310-2.14.1.jar;C:\Users\hanwei\.m2\repository\com\fasterxml\jackson\module\jackson-module-parameter-names\2.14.1\jackson-module-parameter-names-2.14.1.jar;C:\Users\hanwei\.m2\repository\org\springframework\boot\spring-boot-starter-tomcat\3.0.0\spring-boot-starter-tomcat-3.0.0.jar;C:\Users\hanwei\.m2\repository\org\apache\tomcat\embed\tomcat-embed-core\10.1.1\tomcat-embed-core-10.1.1.jar;C:\Users\hanwei\.m2\repository\org\apache\tomcat\embed\tomcat-embed-el\10.1.1\tomcat-embed-el-10.1.1.jar;C:\Users\hanwei\.m2\repository\org\apache\tomcat\embed\tomcat-embed-websocket\10.1.1\tomcat-embed-websocket-10.1.1.jar;C:\Users\hanwei\.m2\repository\org\springframework\spring-web\6.0.2\spring-web-6.0.2.jar;C:\Users\hanwei\.m2\repository\org\springframework\spring-beans\6.0.2\spring-beans-6.0.2.jar;C:\Users\hanwei\.m2\repository\io\micrometer\micrometer-observation\1.10.2\micrometer-observation-1.10.2.jar;C:\Users\hanwei\.m2\repository\io\micrometer\micrometer-commons\1.10.2\micrometer-commons-1.10.2.jar;C:\Users\hanwei\.m2\repository\org\springframework\spring-webmvc\6.0.2\spring-webmvc-6.0.2.jar;C:\Users\hanwei\.m2\repository\org\springframework\spring-aop\6.0.2\spring-aop-6.0.2.jar;C:\Users\hanwei\.m2\repository\org\springframework\spring-expression\6.0.2\spring-expression-6.0.2.jar com.example.demo.DemoApplication</span><br><span class="line"></span><br><span class="line">  .   ____          _            __ _ _</span><br><span class="line"> /\\ / ___&#x27;_ __ _ _(_)_ __  __ _ \ \ \ \</span><br><span class="line">( ( )\___ | &#x27;_ | &#x27;_| | &#x27;_ \/ _` | \ \ \ \</span><br><span class="line"> \\/  ___)| |_)| | | | | || (_| |  ) ) ) )</span><br><span class="line">  &#x27;  |____| .__|_| |_|_| |_\__, | / / / /</span><br><span class="line"> =========|_|==============|___/=/_/_/_/</span><br><span class="line"> :: Spring Boot ::                (v3.0.0)</span><br><span class="line"></span><br><span class="line">2022-11-29T10:19:58.816+08:00  INFO 20116 --- [           main] com.example.demo.DemoApplication         : Starting DemoApplication using Java 17.0.5 with PID 20116 (C:\Users\hanwei\Documents\JavaProject\demo-maven\target\classes started by hanwei in C:\Users\hanwei\Documents\JavaProject\demo-maven)</span><br><span class="line">2022-11-29T10:19:58.818+08:00  INFO 20116 --- [           main] com.example.demo.DemoApplication         : No active profile set, falling back to 1 default profile: &quot;default&quot;</span><br><span class="line">2022-11-29T10:19:59.501+08:00  INFO 20116 --- [           main] o.s.b.w.embedded.tomcat.TomcatWebServer  : Tomcat initialized with port(s): 8080 (http)</span><br><span class="line">2022-11-29T10:19:59.510+08:00  INFO 20116 --- [           main] o.apache.catalina.core.StandardService   : Starting service [Tomcat]</span><br><span class="line">2022-11-29T10:19:59.510+08:00  INFO 20116 --- [           main] o.apache.catalina.core.StandardEngine    : Starting Servlet engine: [Apache Tomcat/10.1.1]</span><br><span class="line">2022-11-29T10:19:59.594+08:00  INFO 20116 --- [           main] o.a.c.c.C.[Tomcat].[localhost].[/]       : Initializing Spring embedded WebApplicationContext</span><br><span class="line">2022-11-29T10:19:59.594+08:00  INFO 20116 --- [           main] w.s.c.ServletWebServerApplicationContext : Root WebApplicationContext: initialization completed in 737 ms</span><br><span class="line">2022-11-29T10:19:59.866+08:00  INFO 20116 --- [           main] o.s.b.w.embedded.tomcat.TomcatWebServer  : Tomcat started on port(s): 8080 (http) with context path &#x27;&#x27;</span><br><span class="line">2022-11-29T10:19:59.872+08:00  INFO 20116 --- [           main] com.example.demo.DemoApplication         : Started DemoApplication in 1.386 seconds (process running for 2.036)</span><br></pre></td></tr></table></figure>
<p>rest api 测试 ok。</p>
<p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/v2-0ee72efd4421007715a55d2c55f931cc_720w.webp" alt="img"></p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">http://localhost:8080/hello</span><br><span class="line"></span><br><span class="line">HTTP/1.1 200 </span><br><span class="line">Content-Type: text/plain;charset=UTF-8</span><br><span class="line">Content-Length: 32</span><br><span class="line">Date: Mon, 28 Nov 2022 08:31:59 GMT</span><br><span class="line">Keep-Alive: timeout=60</span><br><span class="line">Connection: keep-alive</span><br><span class="line"></span><br><span class="line">Hello World from springboot 3.0!</span><br><span class="line"></span><br><span class="line">Response code: 200; Time: 175ms (175 ms); Content length: 32 bytes (32 B)</span><br><span class="line">http://localhost:8080/test</span><br><span class="line"></span><br><span class="line">HTTP/1.1 200 </span><br><span class="line">Content-Type: text/plain;charset=UTF-8</span><br><span class="line">Content-Length: 27</span><br><span class="line">Date: Mon, 28 Nov 2022 08:32:05 GMT</span><br><span class="line">Keep-Alive: timeout=60</span><br><span class="line">Connection: keep-alive</span><br><span class="line"></span><br><span class="line">springboot 3.0 访问测试</span><br><span class="line"></span><br><span class="line">Response code: 200; Time: 17ms (17 ms); Content length: 19 bytes (19 B)</span><br></pre></td></tr></table></figure>
<p>打包二进制可执行文件需要安装 native-image ， 执行 gu install native-image 命令。</p>
<p>打包二进制可执行文件，执行出错：</p>
<p><img src="https://pic3.zhimg.com/80/v2-981af35dc5ee7613d0ddce298c9e88de_720w.webp" alt="img"></p>
<p>上面报错，因为需要安装 windows docker。</p>
<p>官网下载安装 windows dockerdesktop 完成后。启动 windows dockerdesktop 报错（可能是因为 Windows 11 的默认网络配置被改了，正常不会报错，毕竟是很常用的工具）：</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">stderr: </span><br><span class="line">   在 Docker.ApiServices.WSL2.WslShortLivedCommandResult.LogAndThrowIfUnexpectedExitCode(String prefix, ILogger log, Int32 expectedExitCode) 位置 C:\workspaces\PR-19568\src\github.com\docker\pinata\win\src\Docker.ApiServices\WSL2\WslCommand.cs:行号 160</span><br><span class="line">   在 Docker.Engines.WSL2.WSL2Provisioning.&lt;ProvisionAsync&gt;d__8.MoveNext() 位置 C:\workspaces\PR-19568\src\github.com\docker\pinata\win\src\Docker.Engines\WSL2\WSL2Provisioning.cs:行号 81</span><br><span class="line">--- 引发异常的上一位置中堆栈跟踪的末尾 ---</span><br><span class="line">   在 System.Runtime.ExceptionServices.ExceptionDispatchInfo.Throw()</span><br><span class="line">   在 System.Runtime.CompilerServices.TaskAwaiter.HandleNonSuccessAndDebuggerNotification(Task task)</span><br><span class="line">   在 Docker.Engines.WSL2.LinuxWSL2Engine.&lt;DoStartAsync&gt;d__26.MoveNext() 位置 C:\workspaces\PR-19568\src\github.com\docker\pinata\win\src\Docker.Engines\WSL2\LinuxWSL2Engine.cs:行号 170</span><br><span class="line">--- 引发异常的上一位置中堆栈跟踪的末尾 ---</span><br><span class="line">   在 System.Runtime.ExceptionServices.ExceptionDispatchInfo.Throw()</span><br><span class="line">   在 System.Runtime.CompilerServices.TaskAwaiter.HandleNonSuccessAndDebuggerNotification(Task task)</span><br><span class="line">   在 Docker.ApiServices.StateMachines.TaskExtensions.&lt;WrapAsyncInCancellationException&gt;d__0.MoveNext() 位置 C:\workspaces\PR-19568\src\github.com\docker\pinata\win\src\Docker.ApiServices\StateMachines\TaskExtensions.cs:行号 29</span><br><span class="line">--- 引发异常的上一位置中堆栈跟踪的末尾 ---</span><br><span class="line">   在 System.Runtime.ExceptionServices.ExceptionDispatchInfo.Throw()</span><br><span class="line">   在 System.Runtime.CompilerServices.TaskAwaiter.HandleNonSuccessAndDebuggerNotification(Task task)</span><br><span class="line">   在 Docker.ApiServices.StateMachines.StartTransition.&lt;DoRunAsync&gt;d__5.MoveNext() 位置 C:\workspaces\PR-19568\src\github.com\docker\pinata\win\src\Docker.ApiServices\StateMachines\StartTransition.cs:行号 67</span><br><span class="line">--- 引发异常的上一位置中堆栈跟踪的末尾 ---</span><br><span class="line">   在 System.Runtime.ExceptionServices.ExceptionDispatchInfo.Throw()</span><br><span class="line">   在 Docker.ApiServices.StateMachines.StartTransition.&lt;DoRunAsync&gt;d__5.MoveNext() 位置 C:\workspaces\PR-19568\src\github.com\docker\pinata\win\src\Docker.ApiServices\StateMachines\StartTransition.cs:行号 92</span><br><span class="line">--- 引发异常的上一位置中堆栈跟踪的末尾 ---</span><br><span class="line">   在 System.Runtime.ExceptionServices.ExceptionDispatchInfo.Throw()</span><br><span class="line">   在 System.Runtime.CompilerServices.TaskAwaiter.HandleNonSuccessAndDebuggerNotification(Task task)</span><br><span class="line">   在 Docker.ApiServices.StateMachines.EngineStateMachine.&lt;StartAsync&gt;d__14.MoveNext() 位置 C:\workspaces\PR-19568\src\github.com\docker\pinata\win\src\Docker.ApiServices\StateMachines\EngineStateMachine.cs:行号 69</span><br><span class="line">--- 引发异常的上一位置中堆栈跟踪的末尾 ---</span><br><span class="line">   在 System.Runtime.ExceptionServices.ExceptionDispatchInfo.Throw()</span><br><span class="line">   在 System.Runtime.CompilerServices.TaskAwaiter.HandleNonSuccessAndDebuggerNotification(Task task)</span><br><span class="line">   在 Docker.Engines.Engines.&lt;StartAsync&gt;d__22.MoveNext() 位置 C:\workspaces\PR-19568\src\github.com\docker\pinata\win\src\Docker.Engines\Engines.cs:行号 106</span><br></pre></td></tr></table></figure>
<p>在 PowerShell（管理员模式）或者 cmd（管理员模式）中执行</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">netsh winsock reset</span><br></pre></td></tr></table></figure>
<blockquote>
<p>执行该命令后记得重启！</p>
</blockquote>
<p>重启后，Windows 11 下的 dockerdesktop 可以正常启动。</p>
<p>对于没有 vmware 需求，没有虚拟机 vpn 网络需求，仅仅开发 springboot3.0，上面的方式已经可以实现目标。</p>
<p>不过若有 VMware 需求，以及有 VMware 虚拟机共享宿主机 vpn 网络的需求，上面的重置命令慎用，会导致 VMware 里运行的虚拟机使用宿主机 vpn 网络出现问题，网络不通。</p>
<p>并且由于 windows 下的 dockerdesktop 需要打开 hyper-v 或者 WSL 2，一旦打开会影响 VMware 嵌套虚拟化功能，导致 VMware 下虚拟机的嵌套虚拟化功能不可用。</p>
<p>不过也不用担心，只需要 3 步可以恢复：</p>
<ol>
<li>卸载 windows dockerdesktop</li>
<li>设置 - 应用 - 可选功能 - 更多 windows 功能，取消 WSL 2 和 hyper-v 的勾，重启电脑</li>
<li>卸载 wmware，重新安装 wmware。</li>
</ol>
<p>这种情况还是在沙盒环境里编译打包原生可执行文件，比如下面的用 Linux 环境。</p>
<h2 id="spring-boot-30-初步使用linux"><a class="markdownIt-Anchor" href="#spring-boot-30-初步使用linux">#</a> Spring Boot 3.0 初步使用（Linux）</h2>
<p>上面 windows 跑通的项目源码直接放到 Linux 下，执行，报错：</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[ERROR] Internal error: java.lang.RuntimeException: GraalVM native-image is missing from your system.</span><br><span class="line">[ERROR]  Make sure that GRAALVM_HOME environment variable is present.</span><br></pre></td></tr></table></figure>
<p>按报错信息，配置 GRAALVM_HOME 和 安装 GraalVM native-image。</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">export GRAALVM_HOME 到/etc/bashrc</span><br><span class="line">[hanwei@backendcloud-centos9 ~]$ gu install native-image</span><br><span class="line">Downloading: Component catalog from www.graalvm.org</span><br><span class="line">Processing Component: Native Image</span><br><span class="line">Downloading: Component native-image: Native Image from github.com</span><br><span class="line">Installing new component: Native Image (org.graalvm.native-image, version 22.3.0)</span><br></pre></td></tr></table></figure>
<p>再执行报错：</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Test configuration file wasn&#x27;t found.</span><br></pre></td></tr></table></figure>
<p>toggle ‘Skip Tests’ mode，就是在 Linux Idea 的 Maven 窗口，点击跳过测试按钮。</p>
<p>再执行 ok。</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">/home/hanwei/sdk/graalvm-ce-java17-22.3.0/bin/java -XX:TieredStopAtLevel=1 -Dspring.output.ansi.enabled=always -Dcom.sun.management.jmxremote -Dspring.jmx.enabled=true -Dspring.liveBeansView.mbeanDomain -Dspring.application.admin.enabled=true -javaagent:/home/hanwei/.local/share/JetBrains/Toolbox/apps/IDEA-U/ch-0/222.4459.24/lib/idea_rt.jar=41343:/home/hanwei/.local/share/JetBrains/Toolbox/apps/IDEA-U/ch-0/222.4459.24/bin -Dfile.encoding=UTF-8 -classpath /home/hanwei/demo/target/classes:/home/hanwei/.m2/repository/org/springframework/boot/spring-boot-starter/3.0.0/spring-boot-starter-3.0.0.jar:/home/hanwei/.m2/repository/org/springframework/boot/spring-boot/3.0.0/spring-boot-3.0.0.jar:/home/hanwei/.m2/repository/org/springframework/spring-context/6.0.2/spring-context-6.0.2.jar:/home/hanwei/.m2/repository/org/springframework/boot/spring-boot-autoconfigure/3.0.0/spring-boot-autoconfigure-3.0.0.jar:/home/hanwei/.m2/repository/org/springframework/boot/spring-boot-starter-logging/3.0.0/spring-boot-starter-logging-3.0.0.jar:/home/hanwei/.m2/repository/ch/qos/logback/logback-classic/1.4.5/logback-classic-1.4.5.jar:/home/hanwei/.m2/repository/ch/qos/logback/logback-core/1.4.5/logback-core-1.4.5.jar:/home/hanwei/.m2/repository/org/apache/logging/log4j/log4j-to-slf4j/2.19.0/log4j-to-slf4j-2.19.0.jar:/home/hanwei/.m2/repository/org/apache/logging/log4j/log4j-api/2.19.0/log4j-api-2.19.0.jar:/home/hanwei/.m2/repository/org/slf4j/jul-to-slf4j/2.0.4/jul-to-slf4j-2.0.4.jar:/home/hanwei/.m2/repository/jakarta/annotation/jakarta.annotation-api/2.1.1/jakarta.annotation-api-2.1.1.jar:/home/hanwei/.m2/repository/org/springframework/spring-core/6.0.2/spring-core-6.0.2.jar:/home/hanwei/.m2/repository/org/springframework/spring-jcl/6.0.2/spring-jcl-6.0.2.jar:/home/hanwei/.m2/repository/org/yaml/snakeyaml/1.33/snakeyaml-1.33.jar:/home/hanwei/.m2/repository/org/slf4j/slf4j-api/2.0.4/slf4j-api-2.0.4.jar:/home/hanwei/.m2/repository/org/springframework/boot/spring-boot-starter-web/3.0.0/spring-boot-starter-web-3.0.0.jar:/home/hanwei/.m2/repository/org/springframework/boot/spring-boot-starter-json/3.0.0/spring-boot-starter-json-3.0.0.jar:/home/hanwei/.m2/repository/com/fasterxml/jackson/core/jackson-databind/2.14.1/jackson-databind-2.14.1.jar:/home/hanwei/.m2/repository/com/fasterxml/jackson/core/jackson-annotations/2.14.1/jackson-annotations-2.14.1.jar:/home/hanwei/.m2/repository/com/fasterxml/jackson/core/jackson-core/2.14.1/jackson-core-2.14.1.jar:/home/hanwei/.m2/repository/com/fasterxml/jackson/datatype/jackson-datatype-jdk8/2.14.1/jackson-datatype-jdk8-2.14.1.jar:/home/hanwei/.m2/repository/com/fasterxml/jackson/datatype/jackson-datatype-jsr310/2.14.1/jackson-datatype-jsr310-2.14.1.jar:/home/hanwei/.m2/repository/com/fasterxml/jackson/module/jackson-module-parameter-names/2.14.1/jackson-module-parameter-names-2.14.1.jar:/home/hanwei/.m2/repository/org/springframework/boot/spring-boot-starter-tomcat/3.0.0/spring-boot-starter-tomcat-3.0.0.jar:/home/hanwei/.m2/repository/org/apache/tomcat/embed/tomcat-embed-core/10.1.1/tomcat-embed-core-10.1.1.jar:/home/hanwei/.m2/repository/org/apache/tomcat/embed/tomcat-embed-el/10.1.1/tomcat-embed-el-10.1.1.jar:/home/hanwei/.m2/repository/org/apache/tomcat/embed/tomcat-embed-websocket/10.1.1/tomcat-embed-websocket-10.1.1.jar:/home/hanwei/.m2/repository/org/springframework/spring-web/6.0.2/spring-web-6.0.2.jar:/home/hanwei/.m2/repository/org/springframework/spring-beans/6.0.2/spring-beans-6.0.2.jar:/home/hanwei/.m2/repository/io/micrometer/micrometer-observation/1.10.2/micrometer-observation-1.10.2.jar:/home/hanwei/.m2/repository/io/micrometer/micrometer-commons/1.10.2/micrometer-commons-1.10.2.jar:/home/hanwei/.m2/repository/org/springframework/spring-webmvc/6.0.2/spring-webmvc-6.0.2.jar:/home/hanwei/.m2/repository/org/springframework/spring-aop/6.0.2/spring-aop-6.0.2.jar:/home/hanwei/.m2/repository/org/springframework/spring-expression/6.0.2/spring-expression-6.0.2.jar com.example.demo.DemoApplication</span><br><span class="line"></span><br><span class="line">  .   ____          _            __ _ _</span><br><span class="line"> /\\ / ___&#x27;_ __ _ _(_)_ __  __ _ \ \ \ \</span><br><span class="line">( ( )\___ | &#x27;_ | &#x27;_| | &#x27;_ \/ _` | \ \ \ \</span><br><span class="line"> \\/  ___)| |_)| | | | | || (_| |  ) ) ) )</span><br><span class="line">  &#x27;  |____| .__|_| |_|_| |_\__, | / / / /</span><br><span class="line"> =========|_|==============|___/=/_/_/_/</span><br><span class="line"> :: Spring Boot ::                (v3.0.0)</span><br><span class="line"></span><br><span class="line">2022-11-29T00:02:01.348+08:00  INFO 11794 --- [           main] com.example.demo.DemoApplication         : Starting DemoApplication using Java 17.0.5 with PID 11794 (/home/hanwei/demo/target/classes started by hanwei in /home/hanwei/demo)</span><br><span class="line">2022-11-29T00:02:01.352+08:00  INFO 11794 --- [           main] com.example.demo.DemoApplication         : No active profile set, falling back to 1 default profile: &quot;default&quot;</span><br><span class="line">2022-11-29T00:02:02.011+08:00  INFO 11794 --- [           main] o.s.b.w.embedded.tomcat.TomcatWebServer  : Tomcat initialized with port(s): 8080 (http)</span><br><span class="line">2022-11-29T00:02:02.018+08:00  INFO 11794 --- [           main] o.apache.catalina.core.StandardService   : Starting service [Tomcat]</span><br><span class="line">2022-11-29T00:02:02.018+08:00  INFO 11794 --- [           main] o.apache.catalina.core.StandardEngine    : Starting Servlet engine: [Apache Tomcat/10.1.1]</span><br><span class="line">2022-11-29T00:02:02.089+08:00  INFO 11794 --- [           main] o.a.c.c.C.[Tomcat].[localhost].[/]       : Initializing Spring embedded WebApplicationContext</span><br><span class="line">2022-11-29T00:02:02.090+08:00  INFO 11794 --- [           main] w.s.c.ServletWebServerApplicationContext : Root WebApplicationContext: initialization completed in 687 ms</span><br><span class="line">2022-11-29T00:02:02.347+08:00  INFO 11794 --- [           main] o.s.b.w.embedded.tomcat.TomcatWebServer  : Tomcat started on port(s): 8080 (http) with context path &#x27;&#x27;</span><br><span class="line">2022-11-29T00:02:02.350+08:00  INFO 11794 --- [           main] com.example.demo.DemoApplication         : Started DemoApplication in 1.335 seconds (process running for 16.893)</span><br></pre></td></tr></table></figure>
<p>可见执行传统 jar 包的启动速度是 1.335 seconds ，下面编译原生二进制文件。点击 Linux Idea 的 Maven 窗口的 build image 按钮。会在项目的 target 目录下（和生成的 jar 包在同一级目录）生成二进制可执行文件。</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br></pre></td><td class="code"><pre><span class="line">/home/hanwei/sdk/graalvm-ce-java17-22.3.0/bin/java -Dmaven.multiModuleProjectDirectory=/home/hanwei/demo -Dmaven.home=/home/hanwei/.m2/wrapper/dists/apache-maven-3.8.6-bin/1ks0nkde5v1pk9vtc31i9d0lcd/apache-maven-3.8.6 -Dclassworlds.conf=/home/hanwei/.m2/wrapper/dists/apache-maven-3.8.6-bin/1ks0nkde5v1pk9vtc31i9d0lcd/apache-maven-3.8.6/bin/m2.conf -Dmaven.ext.class.path=/home/hanwei/.local/share/JetBrains/Toolbox/apps/IDEA-U/ch-0/222.4459.24/plugins/maven/lib/maven-event-listener.jar -javaagent:/home/hanwei/.local/share/JetBrains/Toolbox/apps/IDEA-U/ch-0/222.4459.24/lib/idea_rt.jar=44943:/home/hanwei/.local/share/JetBrains/Toolbox/apps/IDEA-U/ch-0/222.4459.24/bin -Dfile.encoding=UTF-8 -classpath /home/hanwei/.m2/wrapper/dists/apache-maven-3.8.6-bin/1ks0nkde5v1pk9vtc31i9d0lcd/apache-maven-3.8.6/boot/plexus-classworlds.license:/home/hanwei/.m2/wrapper/dists/apache-maven-3.8.6-bin/1ks0nkde5v1pk9vtc31i9d0lcd/apache-maven-3.8.6/boot/plexus-classworlds-2.6.0.jar org.codehaus.classworlds.Launcher -Didea.version=2022.2.4 -DskipTests=true org.graalvm.buildtools:native-maven-plugin:0.9.16:build -P native</span><br><span class="line">[INFO] Scanning for projects...</span><br><span class="line">[INFO] </span><br><span class="line">[INFO] --------------------------&lt; com.example:demo &gt;--------------------------</span><br><span class="line">[INFO] Building demo 0.0.1-SNAPSHOT</span><br><span class="line">[INFO] --------------------------------[ jar ]---------------------------------</span><br><span class="line">[INFO] </span><br><span class="line">[INFO] --- native-maven-plugin:0.9.16:build (default-cli) @ demo ---</span><br><span class="line">[WARNING] &#x27;native:build&#x27; goal is deprecated. Use &#x27;native:compile-no-fork&#x27; instead.</span><br><span class="line">[INFO] Found GraalVM installation from GRAALVM_HOME variable.</span><br><span class="line">[INFO] [graalvm reachability metadata repository for ch.qos.logback:logback-classic:1.4.5]: Configuration directory not found. Trying latest version.</span><br><span class="line">[INFO] [graalvm reachability metadata repository for ch.qos.logback:logback-classic:1.4.5]: Configuration directory is ch.qos.logback/logback-classic/1.4.1</span><br><span class="line">[INFO] [graalvm reachability metadata repository for org.apache.tomcat.embed:tomcat-embed-core:10.1.1]: Configuration directory not found. Trying latest version.</span><br><span class="line">[INFO] [graalvm reachability metadata repository for org.apache.tomcat.embed:tomcat-embed-core:10.1.1]: Configuration directory is org.apache.tomcat.embed/tomcat-embed-core/10.0.20</span><br><span class="line">[INFO] Executing: /home/hanwei/sdk/graalvm-ce-java17-22.3.0/bin/native-image -cp /home/hanwei/demo/target/classes:/home/hanwei/.m2/repository/org/slf4j/jul-to-slf4j/2.0.4/jul-to-slf4j-2.0.4.jar:/home/hanwei/.m2/repository/org/springframework/spring-web/6.0.2/spring-web-6.0.2.jar:/home/hanwei/.m2/repository/ch/qos/logback/logback-core/1.4.5/logback-core-1.4.5.jar:/home/hanwei/.m2/repository/jakarta/annotation/jakarta.annotation-api/2.1.1/jakarta.annotation-api-2.1.1.jar:/home/hanwei/.m2/repository/com/fasterxml/jackson/core/jackson-annotations/2.14.1/jackson-annotations-2.14.1.jar:/home/hanwei/.m2/repository/org/springframework/boot/spring-boot-starter-json/3.0.0/spring-boot-starter-json-3.0.0.jar:/home/hanwei/.m2/repository/org/springframework/spring-core/6.0.2/spring-core-6.0.2.jar:/home/hanwei/.m2/repository/com/fasterxml/jackson/module/jackson-module-parameter-names/2.14.1/jackson-module-parameter-names-2.14.1.jar:/home/hanwei/.m2/repository/org/apache/tomcat/embed/tomcat-embed-websocket/10.1.1/tomcat-embed-websocket-10.1.1.jar:/home/hanwei/.m2/repository/ch/qos/logback/logback-classic/1.4.5/logback-classic-1.4.5.jar:/home/hanwei/.m2/repository/org/springframework/spring-jcl/6.0.2/spring-jcl-6.0.2.jar:/home/hanwei/.m2/repository/org/springframework/boot/spring-boot-starter-web/3.0.0/spring-boot-starter-web-3.0.0.jar:/home/hanwei/.m2/repository/org/springframework/boot/spring-boot-autoconfigure/3.0.0/spring-boot-autoconfigure-3.0.0.jar:/home/hanwei/.m2/repository/org/springframework/spring-beans/6.0.2/spring-beans-6.0.2.jar:/home/hanwei/.m2/repository/org/springframework/boot/spring-boot-starter-tomcat/3.0.0/spring-boot-starter-tomcat-3.0.0.jar:/home/hanwei/.m2/repository/com/fasterxml/jackson/datatype/jackson-datatype-jsr310/2.14.1/jackson-datatype-jsr310-2.14.1.jar:/home/hanwei/.m2/repository/org/apache/tomcat/embed/tomcat-embed-el/10.1.1/tomcat-embed-el-10.1.1.jar:/home/hanwei/.m2/repository/com/fasterxml/jackson/core/jackson-core/2.14.1/jackson-core-2.14.1.jar:/home/hanwei/.m2/repository/org/apache/logging/log4j/log4j-api/2.19.0/log4j-api-2.19.0.jar:/home/hanwei/.m2/repository/org/springframework/spring-expression/6.0.2/spring-expression-6.0.2.jar:/home/hanwei/.m2/repository/org/springframework/spring-webmvc/6.0.2/spring-webmvc-6.0.2.jar:/home/hanwei/.m2/repository/org/springframework/boot/spring-boot/3.0.0/spring-boot-3.0.0.jar:/home/hanwei/.m2/repository/org/apache/tomcat/embed/tomcat-embed-core/10.1.1/tomcat-embed-core-10.1.1.jar:/home/hanwei/.m2/repository/org/springframework/spring-aop/6.0.2/spring-aop-6.0.2.jar:/home/hanwei/.m2/repository/org/apache/logging/log4j/log4j-to-slf4j/2.19.0/log4j-to-slf4j-2.19.0.jar:/home/hanwei/.m2/repository/org/springframework/boot/spring-boot-starter/3.0.0/spring-boot-starter-3.0.0.jar:/home/hanwei/.m2/repository/org/springframework/boot/spring-boot-starter-logging/3.0.0/spring-boot-starter-logging-3.0.0.jar:/home/hanwei/.m2/repository/org/slf4j/slf4j-api/2.0.4/slf4j-api-2.0.4.jar:/home/hanwei/.m2/repository/org/springframework/spring-context/6.0.2/spring-context-6.0.2.jar:/home/hanwei/.m2/repository/io/micrometer/micrometer-observation/1.10.2/micrometer-observation-1.10.2.jar:/home/hanwei/.m2/repository/org/yaml/snakeyaml/1.33/snakeyaml-1.33.jar:/home/hanwei/.m2/repository/com/fasterxml/jackson/core/jackson-databind/2.14.1/jackson-databind-2.14.1.jar:/home/hanwei/.m2/repository/com/fasterxml/jackson/datatype/jackson-datatype-jdk8/2.14.1/jackson-datatype-jdk8-2.14.1.jar:/home/hanwei/.m2/repository/io/micrometer/micrometer-commons/1.10.2/micrometer-commons-1.10.2.jar --no-fallback -H:Path=/home/hanwei/demo/target -H:Name=demo -H:ConfigurationFileDirectories=/home/hanwei/demo/target/graalvm-reachability-metadata/39f9c4cd5765941e97b499c39e24353f8a36ebd3/org.apache.tomcat.embed/tomcat-embed-core/10.0.20,/home/hanwei/demo/target/graalvm-reachability-metadata/39f9c4cd5765941e97b499c39e24353f8a36ebd3/ch.qos.logback/logback-classic/1.4.1</span><br><span class="line">========================================================================================================================</span><br><span class="line">GraalVM Native Image: Generating &#x27;demo&#x27; (executable)...</span><br><span class="line">========================================================================================================================</span><br><span class="line">[1/7] Initializing...                                                                                    (6.4s @ 0.18GB)</span><br><span class="line"> Version info: &#x27;GraalVM 22.3.0 Java 17 CE&#x27;</span><br><span class="line"> Java version info: &#x27;17.0.5+8-jvmci-22.3-b08&#x27;</span><br><span class="line"> C compiler: gcc (redhat, x86_64, 11.3.1)</span><br><span class="line"> Garbage collector: Serial GC</span><br><span class="line"> 1 user-specific feature(s)</span><br><span class="line"> - org.springframework.aot.nativex.feature.PreComputeFieldFeature</span><br><span class="line">The bundle named: org.apache.el.Messages, has not been found. If the bundle is part of a module, verify the bundle name is a fully qualified class name. Otherwise verify the bundle path is accessible in the classpath.</span><br><span class="line">Field org.springframework.core.NativeDetector#imageCode set to true at build time</span><br><span class="line">Field org.apache.commons.logging.LogAdapter#log4jSpiPresent set to true at build time</span><br><span class="line">Field org.apache.commons.logging.LogAdapter#log4jSlf4jProviderPresent set to true at build time</span><br><span class="line">Field org.apache.commons.logging.LogAdapter#slf4jSpiPresent set to true at build time</span><br><span class="line">Field org.apache.commons.logging.LogAdapter#slf4jApiPresent set to true at build time</span><br><span class="line">Field org.springframework.format.support.DefaultFormattingConversionService#jsr354Present set to false at build time</span><br><span class="line">Field org.springframework.core.KotlinDetector#kotlinPresent set to false at build time</span><br><span class="line">Field org.springframework.core.KotlinDetector#kotlinReflectPresent set to false at build time</span><br><span class="line">Field org.springframework.cglib.core.AbstractClassGenerator#imageCode set to true at build time</span><br><span class="line">Field org.springframework.boot.logging.java.JavaLoggingSystem$Factory#PRESENT set to true at build time</span><br><span class="line">Field org.springframework.boot.logging.log4j2.Log4J2LoggingSystem$Factory#PRESENT set to false at build time</span><br><span class="line">Field org.springframework.boot.logging.logback.LogbackLoggingSystem$Factory#PRESENT set to true at build time</span><br><span class="line">Field org.springframework.web.servlet.config.annotation.WebMvcConfigurationSupport#romePresent set to false at build time</span><br><span class="line">Field org.springframework.web.servlet.config.annotation.WebMvcConfigurationSupport#jaxb2Present set to false at build time</span><br><span class="line">Field org.springframework.web.servlet.config.annotation.WebMvcConfigurationSupport#jackson2Present set to true at build time</span><br><span class="line">Field org.springframework.web.servlet.config.annotation.WebMvcConfigurationSupport#jackson2XmlPresent set to false at build time</span><br><span class="line">Field org.springframework.web.servlet.config.annotation.WebMvcConfigurationSupport#jackson2SmilePresent set to false at build time</span><br><span class="line">Field org.springframework.web.servlet.config.annotation.WebMvcConfigurationSupport#jackson2CborPresent set to false at build time</span><br><span class="line">Field org.springframework.web.servlet.config.annotation.WebMvcConfigurationSupport#gsonPresent set to false at build time</span><br><span class="line">Field org.springframework.web.servlet.config.annotation.WebMvcConfigurationSupport#jsonbPresent set to false at build time</span><br><span class="line">Field org.springframework.web.servlet.config.annotation.WebMvcConfigurationSupport#kotlinSerializationCborPresent set to false at build time</span><br><span class="line">Field org.springframework.web.servlet.config.annotation.WebMvcConfigurationSupport#kotlinSerializationJsonPresent set to false at build time</span><br><span class="line">Field org.springframework.web.servlet.config.annotation.WebMvcConfigurationSupport#kotlinSerializationProtobufPresent set to false at build time</span><br><span class="line">Field org.springframework.web.servlet.view.InternalResourceViewResolver#jstlPresent set to false at build time</span><br><span class="line">Field org.springframework.web.context.support.StandardServletEnvironment#jndiPresent set to true at build time</span><br><span class="line">Field org.springframework.web.context.support.WebApplicationContextUtils#jsfPresent set to false at build time</span><br><span class="line">Field org.springframework.web.context.request.RequestContextHolder#jsfPresent set to false at build time</span><br><span class="line">Field org.springframework.context.event.ApplicationListenerMethodAdapter#reactiveStreamsPresent set to false at build time</span><br><span class="line">Field org.springframework.boot.logging.logback.LogbackLoggingSystemProperties#JBOSS_LOGGING_PRESENT set to false at build time</span><br><span class="line">Field org.springframework.http.converter.support.AllEncompassingFormHttpMessageConverter#jaxb2Present set to false at build time</span><br><span class="line">Field org.springframework.http.converter.support.AllEncompassingFormHttpMessageConverter#jackson2Present set to true at build time</span><br><span class="line">Field org.springframework.http.converter.support.AllEncompassingFormHttpMessageConverter#jackson2XmlPresent set to false at build time</span><br><span class="line">Field org.springframework.http.converter.support.AllEncompassingFormHttpMessageConverter#jackson2SmilePresent set to false at build time</span><br><span class="line">Field org.springframework.http.converter.support.AllEncompassingFormHttpMessageConverter#gsonPresent set to false at build time</span><br><span class="line">Field org.springframework.http.converter.support.AllEncompassingFormHttpMessageConverter#jsonbPresent set to false at build time</span><br><span class="line">Field org.springframework.http.converter.support.AllEncompassingFormHttpMessageConverter#kotlinSerializationCborPresent set to false at build time</span><br><span class="line">Field org.springframework.http.converter.support.AllEncompassingFormHttpMessageConverter#kotlinSerializationJsonPresent set to false at build time</span><br><span class="line">Field org.springframework.http.converter.support.AllEncompassingFormHttpMessageConverter#kotlinSerializationProtobufPresent set to false at build time</span><br><span class="line">Field org.springframework.boot.autoconfigure.web.format.WebConversionService#JSR_354_PRESENT set to false at build time</span><br><span class="line">Field org.springframework.web.client.RestTemplate#romePresent set to false at build time</span><br><span class="line">Field org.springframework.web.client.RestTemplate#jaxb2Present set to false at build time</span><br><span class="line">Field org.springframework.web.client.RestTemplate#jackson2Present set to true at build time</span><br><span class="line">Field org.springframework.web.client.RestTemplate#jackson2XmlPresent set to false at build time</span><br><span class="line">Field org.springframework.web.client.RestTemplate#jackson2SmilePresent set to false at build time</span><br><span class="line">Field org.springframework.web.client.RestTemplate#jackson2CborPresent set to false at build time</span><br><span class="line">Field org.springframework.web.client.RestTemplate#gsonPresent set to false at build time</span><br><span class="line">Field org.springframework.web.client.RestTemplate#jsonbPresent set to false at build time</span><br><span class="line">Field org.springframework.web.client.RestTemplate#kotlinSerializationCborPresent set to false at build time</span><br><span class="line">Field org.springframework.web.client.RestTemplate#kotlinSerializationJsonPresent set to false at build time</span><br><span class="line">Field org.springframework.web.client.RestTemplate#kotlinSerializationProtobufPresent set to false at build time</span><br><span class="line">Field org.springframework.core.ReactiveAdapterRegistry#reactorPresent set to false at build time</span><br><span class="line">Field org.springframework.core.ReactiveAdapterRegistry#rxjava3Present set to false at build time</span><br><span class="line">Field org.springframework.core.ReactiveAdapterRegistry#kotlinCoroutinesPresent set to false at build time</span><br><span class="line">Field org.springframework.core.ReactiveAdapterRegistry#mutinyPresent set to false at build time</span><br><span class="line">SLF4J: No SLF4J providers were found.</span><br><span class="line">SLF4J: Defaulting to no-operation (NOP) logger implementation</span><br><span class="line">SLF4J: See https://www.slf4j.org/codes.html#noProviders for further details.</span><br><span class="line">Field org.springframework.web.servlet.mvc.method.annotation.ReactiveTypeHandler#isContextPropagationPresent set to false at build time</span><br><span class="line">Field org.springframework.web.servlet.support.RequestContext#jstlPresent set to false at build time</span><br><span class="line">[2/7] Performing analysis...  [*********]                                                               (54.5s @ 1.28GB)</span><br><span class="line">  15,278 (92.35%) of 16,544 classes reachable</span><br><span class="line">  24,932 (67.63%) of 36,867 fields reachable</span><br><span class="line">  73,534 (62.25%) of 118,132 methods reachable</span><br><span class="line">     780 classes,   163 fields, and 3,506 methods registered for reflection</span><br><span class="line">      64 classes,    70 fields, and    55 methods registered for JNI access</span><br><span class="line">       4 native libraries: dl, pthread, rt, z</span><br><span class="line">[3/7] Building universe...                                                                               (5.2s @ 4.12GB)</span><br><span class="line">[4/7] Parsing methods...      [**]                                                                       (4.2s @ 4.35GB)</span><br><span class="line">[5/7] Inlining methods...     [***]                                                                      (1.9s @ 2.82GB)</span><br><span class="line">[6/7] Compiling methods...    [*****]                                                                   (27.8s @ 3.46GB)</span><br><span class="line">[7/7] Creating image...                                                                                  (6.1s @ 1.15GB)</span><br><span class="line">  32.83MB (49.82%) for code area:    48,151 compilation units</span><br><span class="line">  32.75MB (49.70%) for image heap:  354,531 objects and 320 resources</span><br><span class="line"> 324.99KB ( 0.48%) for other data</span><br><span class="line">  65.90MB in total</span><br><span class="line">------------------------------------------------------------------------------------------------------------------------</span><br><span class="line">Top 10 packages in code area:                               Top 10 object types in image heap:</span><br><span class="line">   1.63MB sun.security.ssl                                     7.21MB byte[] for code metadata</span><br><span class="line">   1.04MB java.util                                            3.88MB byte[] for embedded resources</span><br><span class="line"> 832.55KB java.lang.invoke                                     3.63MB java.lang.Class</span><br><span class="line"> 718.00KB com.sun.crypto.provider                              3.39MB java.lang.String</span><br><span class="line"> 541.00KB org.apache.catalina.core                             2.80MB byte[] for java.lang.String</span><br><span class="line"> 499.59KB org.apache.tomcat.util.net                           2.79MB byte[] for general heap data</span><br><span class="line"> 490.49KB org.apache.coyote.http2                              1.28MB com.oracle.svm.core.hub.DynamicHubCompanion</span><br><span class="line"> 472.53KB java.lang                                          815.22KB byte[] for reflection metadata</span><br><span class="line"> 461.63KB sun.security.x509                                  659.44KB java.lang.String[]</span><br><span class="line"> 459.52KB java.util.concurrent                               648.80KB java.util.HashMap$Node</span><br><span class="line">  25.43MB for 637 more packages                                5.47MB for 3070 more object types</span><br><span class="line">------------------------------------------------------------------------------------------------------------------------</span><br><span class="line">                        9.1s (7.9% of total time) in 37 GCs | Peak RSS: 6.43GB | CPU load: 4.46</span><br><span class="line">------------------------------------------------------------------------------------------------------------------------</span><br><span class="line">Produced artifacts:</span><br><span class="line"> /home/hanwei/demo/target/demo (executable)</span><br><span class="line"> /home/hanwei/demo/target/demo.build_artifacts.txt (txt)</span><br><span class="line">========================================================================================================================</span><br><span class="line">Finished generating &#x27;demo&#x27; in 1m 53s.</span><br><span class="line">[INFO] ------------------------------------------------------------------------</span><br><span class="line">[INFO] BUILD SUCCESS</span><br><span class="line">[INFO] ------------------------------------------------------------------------</span><br><span class="line">[INFO] Total time:  01:55 min</span><br><span class="line">[INFO] Finished at: 2022-11-28T23:55:32+08:00</span><br><span class="line">[INFO] ------------------------------------------------------------------------</span><br><span class="line"></span><br><span class="line">Process finished with exit code 0</span><br></pre></td></tr></table></figure>
<p>执行二进制可执行文件，启动速度只有 0.052 seconds 。</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">[hanwei@backendcloud-centos9 ~]$ cd demo/target/</span><br><span class="line">[hanwei@backendcloud-centos9 target]$ ls</span><br><span class="line">classes  demo  demo-0.0.1-SNAPSHOT.jar  demo-0.0.1-SNAPSHOT.jar.original  demo.build_artifacts.txt  generated-sources  generated-test-sources  graalvm-reachability-metadata  maven-archiver  maven-status  spring-aot  surefire-reports  test-classes</span><br><span class="line">[hanwei@backendcloud-centos9 target]$ ./demo </span><br><span class="line"></span><br><span class="line">  .   ____          _            __ _ _</span><br><span class="line"> /\\ / ___&#x27;_ __ _ _(_)_ __  __ _ \ \ \ \</span><br><span class="line">( ( )\___ | &#x27;_ | &#x27;_| | &#x27;_ \/ _` | \ \ \ \</span><br><span class="line"> \\/  ___)| |_)| | | | | || (_| |  ) ) ) )</span><br><span class="line">  &#x27;  |____| .__|_| |_|_| |_\__, | / / / /</span><br><span class="line"> =========|_|==============|___/=/_/_/_/</span><br><span class="line"> :: Spring Boot ::                (v3.0.0)</span><br><span class="line"></span><br><span class="line">2022-11-29T00:03:59.026+08:00  INFO 12061 --- [           main] com.example.demo.DemoApplication         : Starting AOT-processed DemoApplication using Java 17.0.5 with PID 12061 (/home/hanwei/demo/target/demo started by hanwei in /home/hanwei/demo/target)</span><br><span class="line">2022-11-29T00:03:59.026+08:00  INFO 12061 --- [           main] com.example.demo.DemoApplication         : No active profile set, falling back to 1 default profile: &quot;default&quot;</span><br><span class="line">2022-11-29T00:03:59.040+08:00  INFO 12061 --- [           main] o.s.b.w.embedded.tomcat.TomcatWebServer  : Tomcat initialized with port(s): 8080 (http)</span><br><span class="line">2022-11-29T00:03:59.040+08:00  INFO 12061 --- [           main] o.apache.catalina.core.StandardService   : Starting service [Tomcat]</span><br><span class="line">2022-11-29T00:03:59.040+08:00  INFO 12061 --- [           main] o.apache.catalina.core.StandardEngine    : Starting Servlet engine: [Apache Tomcat/10.1.1]</span><br><span class="line">2022-11-29T00:03:59.044+08:00  INFO 12061 --- [           main] o.a.c.c.C.[Tomcat].[localhost].[/]       : Initializing Spring embedded WebApplicationContext</span><br><span class="line">2022-11-29T00:03:59.044+08:00  INFO 12061 --- [           main] w.s.c.ServletWebServerApplicationContext : Root WebApplicationContext: initialization completed in 18 ms</span><br><span class="line">2022-11-29T00:03:59.068+08:00  INFO 12061 --- [           main] o.s.b.w.embedded.tomcat.TomcatWebServer  : Tomcat started on port(s): 8080 (http) with context path &#x27;&#x27;</span><br><span class="line">2022-11-29T00:03:59.068+08:00  INFO 12061 --- [           main] com.example.demo.DemoApplication         : Started DemoApplication in 0.052 seconds (process running for 0.056)</span><br><span class="line">[hanwei@backendcloud-centos9 target]$ ll -h</span><br><span class="line">total 84M</span><br><span class="line">drwxr-xr-x. 5 hanwei hanwei   74 Nov 28 23:15 classes</span><br><span class="line">-rwxr-xr-x. 1 hanwei hanwei  66M Nov 28 23:55 demo</span><br><span class="line">-rw-r--r--. 1 hanwei hanwei  18M Nov 28 23:49 demo-0.0.1-SNAPSHOT.jar</span><br><span class="line">-rw-r--r--. 1 hanwei hanwei 119K Nov 28 23:49 demo-0.0.1-SNAPSHOT.jar.original</span><br><span class="line">-rw-r--r--. 1 hanwei hanwei   19 Nov 28 23:55 demo.build_artifacts.txt</span><br><span class="line">drwxr-xr-x. 3 hanwei hanwei   25 Nov 28 22:59 generated-sources</span><br><span class="line">drwxr-xr-x. 3 hanwei hanwei   30 Nov 28 22:59 generated-test-sources</span><br><span class="line">drwxr-xr-x. 4 hanwei hanwei  101 Nov 28 23:42 graalvm-reachability-metadata</span><br><span class="line">drwxr-xr-x. 2 hanwei hanwei   28 Nov 28 22:59 maven-archiver</span><br><span class="line">drwxr-xr-x. 3 hanwei hanwei   35 Nov 28 22:59 maven-status</span><br><span class="line">drwxr-xr-x. 3 hanwei hanwei   18 Nov 28 22:59 spring-aot</span><br><span class="line">drwxr-xr-x. 2 hanwei hanwei  153 Nov 28 23:03 surefire-reports</span><br><span class="line">drwxr-xr-x. 3 hanwei hanwei   17 Nov 28 22:59 test-classes</span><br></pre></td></tr></table></figure>
<p>对比两种打包方式：jar 包和原生可执行文件，jar 包 18 兆，原生可执行文件因为可以不依赖 java 运行环境而直接运行，所以体积大些，60 兆。</p>
<p>上面是通过 Linux Idea 的 Maven 窗口执行的。也可以通过命令行执行 mvn 命令生成原生二进制文件。</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[hanwei@backendcloud-centos9 target]$ which mvn</span><br><span class="line">~/.local/bin/mvn</span><br><span class="line">[hanwei@backendcloud-centos9 target]$ ll ~/.local/bin/mvn</span><br><span class="line">lrwxrwxrwx. 1 hanwei hanwei 107 Nov 28 22:57 /home/hanwei/.local/bin/mvn -&gt; /home/hanwei/.m2/wrapper/dists/apache-maven-3.8.6-bin/1ks0nkde5v1pk9vtc31i9d0lcd/apache-maven-3.8.6/bin/mvn</span><br><span class="line"># 到feature-native目录下</span><br><span class="line">[hanwei@backendcloud-centos9 demo]$ cd ..</span><br><span class="line">[hanwei@backendcloud-centos9 demo]$ mvn clean</span><br><span class="line"># 打包</span><br><span class="line">[hanwei@backendcloud-centos9 demo]$ mvn package -Pnative</span><br><span class="line"># 可执行文件</span><br><span class="line">[hanwei@backendcloud-centos9 demo]$ mvn native:compile-no-fork </span><br><span class="line"># 到target目录下启动可执行文件</span><br></pre></td></tr></table></figure>
<p>从上面的执行效果对比看出，云原生时代的 Spring Boot 3.0: GraalVM 编译的二进制可执行文件，启动速度相对于传统 jar 包提升近 30 倍（1.335 seconds -&gt; 0.052 seconds）。</p>
<h1 id="欢迎订阅微信公众号-interviewcoder"><a class="markdownIt-Anchor" href="#欢迎订阅微信公众号-interviewcoder">#</a> 欢迎订阅微信公众号 “InterviewCoder” ！</h1>
<h2 id="关于我"><a class="markdownIt-Anchor" href="#关于我">#</a> 关于我</h2>
<p>Brath 是一个热爱技术的 Java 程序猿，公众号「InterviewCoder」定期分享有趣有料的精品原创文章！</p>
<p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/%E4%BA%8C%E7%BB%B4%E7%A0%81plus.png" alt="InterviewCoder"></p>
<p>非常感谢各位人才能看到这里，原创不易，文章如果有帮助可以关注、点赞、分享或评论，这都是对我的莫大支持！</p>
</div></article></div><nav class="pagination" role="navigation" aria-label="pagination"><div class="pagination-previous"><a href="/page/12/">上一页</a></div><div class="pagination-next"><a href="/page/14/">下一页</a></div><ul class="pagination-list is-hidden-mobile"><li><a class="pagination-link" href="/">1</a></li><li><span class="pagination-ellipsis">&hellip;</span></li><li><a class="pagination-link" href="/page/12/">12</a></li><li><a class="pagination-link is-current" href="/page/13/">13</a></li><li><a class="pagination-link" href="/page/14/">14</a></li></ul></nav></div><div class="column column-left is-4-tablet is-4-desktop is-3-widescreen  order-1"><!--!--><div class="card widget" data-type="recent-posts"><div class="card-content"><h3 class="menu-label">最新文章</h3><article class="media"><div class="media-content"><p class="date"><time dateTime="2023-05-05T05:58:11.000Z">2023-05-05</time></p><p class="title"><a href="/2023/05/05/%E3%80%90%E7%AE%97%E6%B3%95%E3%80%91%E7%AE%97%E6%B3%95%E7%9A%84%E6%97%B6%E9%97%B4%E4%B8%8E%E7%A9%BA%E9%97%B4%E5%A4%8D%E6%9D%82%E5%BA%A6/">【算法】算法的时间与空间复杂度</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2023-05-05T01:57:09.000Z">2023-05-05</time></p><p class="title"><a href="/2023/05/05/%E3%80%90IDEA%E3%80%91IDEA%E7%9A%84debug%E8%B0%83%E8%AF%95%E6%8A%80%E5%B7%A7%E8%AF%A6%E8%A7%A3/">【IDEA】IDEA的debug调试技巧详解</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2023-05-05T01:57:09.000Z">2023-05-05</time></p><p class="title"><a href="/2023/05/05/%E3%80%90%E6%96%87%E5%BF%83%E4%B8%80%E8%A8%80%E3%80%91%E7%99%BE%E5%BA%A6%E6%96%87%E5%BF%83%E4%B8%80%E8%A8%80%E5%A4%A7%E5%9E%8B%E8%AF%AD%E8%A8%80%E6%A8%A1%E5%9E%8B%E6%8E%A5%E5%85%A5%E6%95%99%E7%A8%8B/">【文心一言】百度文心一言大型语言模型接入教程</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2023-04-29T11:42:37.000Z">2023-04-29</time></p><p class="title"><a href="/2023/04/29/%E3%80%90%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F%E3%80%9123%20%E7%A7%8D%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F%E8%AF%A6%E8%A7%A3%EF%BC%88%E5%85%A823%E7%A7%8D%EF%BC%89/">【设计模式】23 种设计模式详解（全23种）</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2023-04-27T09:20:49.000Z">2023-04-27</time></p><p class="title"><a href="/2023/04/27/%E3%80%90Dubbo%E3%80%91Dubbo%E8%AF%A6%E8%A7%A3%EF%BC%8C%E7%94%A8%E5%BF%83%E7%9C%8B%E8%BF%99%E4%B8%80%E7%AF%87%E6%96%87%E7%AB%A0%E5%B0%B1%E5%A4%9F%E4%BA%86%E3%80%90%E9%87%8D%E7%82%B9%E3%80%91/">【Dubbo】Dubbo详解，用心看这一篇文章就够了【重点】</a></p></div></article></div></div><div class="card widget" data-type="archives"><div class="card-content"><div class="menu"><h3 class="menu-label">归档</h3><ul class="menu-list"><li><a class="level is-mobile" href="/archives/2023/"><span class="level-start"><span class="level-item">2023</span></span><span class="level-end"><span class="level-item tag">34</span></span></a></li><li><a class="level is-mobile" href="/archives/2022/"><span class="level-start"><span class="level-item">2022</span></span><span class="level-end"><span class="level-item tag">51</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/"><span class="level-start"><span class="level-item">2021</span></span><span class="level-end"><span class="level-item tag">44</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/"><span class="level-start"><span class="level-item">2020</span></span><span class="level-end"><span class="level-item tag">7</span></span></a></li></ul></div></div></div><!--!--><div class="card widget" data-type="profile"><div class="card-content"><nav class="level"><div class="level-item has-text-centered flex-shrink-1"><div><figure class="image is-128x128 mx-auto mb-2"><img class="avatar" src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/%E4%BA%8C%E7%BB%B4%E7%A0%81plus.png" alt="InterviewCoder"></figure><p class="title is-size-4 is-block" style="line-height:inherit;">InterviewCoder</p><p class="is-size-6 is-block">面试记官方公众号</p></div></div></nav><nav class="level is-mobile"><div class="level-item has-text-centered is-marginless"><div><p class="heading">文章</p><a href="/archives"><p class="title">136</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">分类</p><a href="/categories"><p class="title">0</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">标签</p><a href="/tags"><p class="title">0</p></a></div></div></nav><div class="level"><a class="level-item button is-primary is-rounded" href="https://mp.weixin.qq.com/s/jWs6lLHl5L-atXJhHc4YvA" target="_blank" rel="noopener">关注我</a></div></div></div><div class="column-right-shadow is-hidden-widescreen"></div></div><div class="column column-right is-4-tablet is-4-desktop is-3-widescreen is-hidden-touch is-hidden-desktop-only order-3"><div class="card widget" data-type="profile"><div class="card-content"><nav class="level"><div class="level-item has-text-centered flex-shrink-1"><div><figure class="image is-128x128 mx-auto mb-2"><img class="avatar is-rounded" src="https://brath.cloud/me.png" alt="Brath"></figure><p class="title is-size-4 is-block" style="line-height:inherit;">Brath</p><p class="is-size-6 is-block">技能改变人生，知识改变命运。</p><p class="is-size-6 is-flex justify-content-center"><i class="fas fa-map-marker-alt mr-1"></i><span>中国·江苏·无锡</span></p></div></div></nav><nav class="level is-mobile"><div class="level-item has-text-centered is-marginless"><div><p class="heading">文章</p><a href="/archives"><p class="title">136</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">分类</p><a href="/categories"><p class="title">0</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">标签</p><a href="/tags"><p class="title">0</p></a></div></div></nav><div class="level"><a class="level-item button is-primary is-rounded" href="https://github.com/Guoqing815" target="_blank" rel="noopener">关注我</a></div><div class="level is-mobile is-multiline"><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Github" href="https://github.com/Guoqing815"><i class="fab fa-github"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Gitee" href="https://gitee.com/Guoqing-Li"><i class="fab fa-gitee"></i></a></div></div></div><!--!--><div class="card widget" data-type="links"><div class="card-content"><div class="menu"><h3 class="menu-label">链接</h3><ul class="menu-list"><li><a class="level is-mobile" href="https://schokolade.cn/" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">泠灵(特别呜谢)</span></span><span class="level-right"><span class="level-item tag">schokolade.cn</span></span></a></li><li><a class="level is-mobile" href="https://gitee.com/Guoqing-Li" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">Gitee(码云)</span></span><span class="level-right"><span class="level-item tag">gitee.com</span></span></a></li><li><a class="level is-mobile" href="https://blog.csdn.net/Brath?type=blog" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">CSDN</span></span><span class="level-right"><span class="level-item tag">blog.csdn.net</span></span></a></li><li><a class="level is-mobile" href="https://juejin.cn/user/settings/profile" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">掘金</span></span><span class="level-right"><span class="level-item tag">juejin.cn</span></span></a></li><li><a class="level is-mobile" href="https://oss.console.aliyun.com/" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">AliCloud(阿里云)</span></span><span class="level-right"><span class="level-item tag">oss.console.aliyun.com</span></span></a></li><li><a class="level is-mobile" href="https://cloud.tencent.com/" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">TencentCloud(腾讯云)</span></span><span class="level-right"><span class="level-item tag">cloud.tencent.com</span></span></a></li><li><a class="level is-mobile" href="https://www.zhipin.com/web/user/" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">BOSS</span></span><span class="level-right"><span class="level-item tag">www.zhipin.com</span></span></a></li><li><a class="level is-mobile" href="https://www.bilibili.com/" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">Bilibili(B站)</span></span><span class="level-right"><span class="level-item tag">www.bilibili.com</span></span></a></li></ul></div></div></div></div></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/"><img src="https://brath.cloud/me.png" alt="Brath-Blog" height="28"></a><p class="is-size-7"><span>&copy; 2023 Brath</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a><br><span id="busuanzi_container_site_uv">共<span id="busuanzi_value_site_uv">0</span>个访客</span></p><p class="is-size-7">© 2029</p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Attribution 4.0 International" href="https://creativecommons.org/licenses/by/4.0/"><i class="fab fa-creative-commons-by"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/ppoffice/hexo-theme-icarus"><i class="fab fa-github"></i></a></p></div></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script><script>moment.locale("zh-cn");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="/js/column.js"></script><script src="/js/animation.js"></script><a id="back-to-top" title="回到顶端" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><!--!--><!--!--><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.js" defer></script><script>window.addEventListener("load", () => {
      window.cookieconsent.initialise({
        type: "info",
        theme: "edgeless",
        static: false,
        position: "bottom-left",
        content: {
          message: "此网站使用Cookie来改善您的体验。",
          dismiss: "知道了！",
          allow: "允许使用Cookie",
          deny: "拒绝",
          link: "了解更多",
          policy: "Cookie政策",
          href: "https://www.cookiesandyou.com/",
        },
        palette: {
          popup: {
            background: "#edeff5",
            text: "#838391"
          },
          button: {
            background: "#4b81e8"
          },
        },
      });
    });</script><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><!--!--><!--!--><!--!--><script src="/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="想要查找什么..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"想要查找什么...","untitled":"(无标题)","posts":"文章","pages":"页面","categories":"分类","tags":"标签"});
        });</script></body></html>