<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  
  <title>Redis与Mysql | Master与Slave同步：canal教学 | Hexo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="前言：​		作者最近在做自己的项目，使用到Redis，需要热更新，修改Mysql后同步Redis缓存，出于对圈子的贡献，也较于当前的canal的博客大多数不是很详细，所以写下这篇文章，时间是2022年6月29日。目的是帮助更多的人，希望能为在祖国的经济发展作出小小的贡献。 ​		end 学习Canal基本需要：​	Linux服务器，性能无大要求 ​	Java基础 ​	Mysql，Redis基础 俗">
<meta property="og:type" content="article">
<meta property="og:title" content="Redis与Mysql | Master与Slave同步：canal教学">
<meta property="og:url" content="http://example.com/2022/12/27/Redis%E4%B8%8EMysql%20Master%E4%B8%8ESlave%E5%90%8C%E6%AD%A5%EF%BC%9Acanal%E6%95%99%E5%AD%A6/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="前言：​		作者最近在做自己的项目，使用到Redis，需要热更新，修改Mysql后同步Redis缓存，出于对圈子的贡献，也较于当前的canal的博客大多数不是很详细，所以写下这篇文章，时间是2022年6月29日。目的是帮助更多的人，希望能为在祖国的经济发展作出小小的贡献。 ​		end 学习Canal基本需要：​	Linux服务器，性能无大要求 ​	Java基础 ​	Mysql，Redis基础 俗">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://brath.cloud/blogImg/20200808151606261.png">
<meta property="og:image" content="https://brath.cloud/blogImg/20200808151715291.png">
<meta property="og:image" content="https://brath.cloud/blogImg/image-20220629152616754.png">
<meta property="og:image" content="https://brath.cloud/blogImg/image-20220629153150741.png">
<meta property="og:image" content="https://brath.cloud/blogImg/image-20220629153511220.png">
<meta property="og:image" content="c:/Users/Administrator/AppData/Roaming/Typora/typora-user-images/image-20220629153956493.png">
<meta property="og:image" content="https://brath.cloud/blogImg/image-20220629154454409.png">
<meta property="article:published_time" content="2022-12-27T07:24:12.744Z">
<meta property="article:modified_time" content="2022-06-29T07:48:57.475Z">
<meta property="article:author" content="John Doe">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://brath.cloud/blogImg/20200808151606261.png">
  
    <link rel="alternate" href="/atom.xml" title="Hexo" type="application/atom+xml">
  
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
    
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/typeface-source-code-pro@0.0.71/index.min.css">

  
  
<link rel="stylesheet" href="/css/style.css">

  
    
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">

  
<meta name="generator" content="Hexo 6.3.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Hexo</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://example.com"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main"><article id="post-Redis与Mysql Master与Slave同步：canal教学" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2022/12/27/Redis%E4%B8%8EMysql%20Master%E4%B8%8ESlave%E5%90%8C%E6%AD%A5%EF%BC%9Acanal%E6%95%99%E5%AD%A6/" class="article-date">
  <time class="dt-published" datetime="2022-12-27T07:24:12.744Z" itemprop="datePublished">2022-12-27</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="p-name article-title" itemprop="headline name">
      Redis与Mysql | Master与Slave同步：canal教学
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h2 id="前言："><a href="#前言：" class="headerlink" title="前言："></a>前言：</h2><p>​		作者最近在做自己的项目，使用到Redis，需要热更新，修改Mysql后同步Redis缓存，出于对圈子的贡献，也较于当前的canal的博客大多数不是很详细，所以写下这篇文章，时间是2022年6月29日。目的是帮助更多的人，希望能为在祖国的经济发展作出小小的贡献。</p>
<p>​		end</p>
<h4 id="学习Canal基本需要："><a href="#学习Canal基本需要：" class="headerlink" title="学习Canal基本需要："></a>学习Canal基本需要：</h4><p>​	Linux服务器，性能无大要求</p>
<p>​	Java基础</p>
<p>​	Mysql，Redis基础</p>
<h3 id="俗话说，要了解一个东西，先了解他的由来："><a href="#俗话说，要了解一个东西，先了解他的由来：" class="headerlink" title="俗话说，要了解一个东西，先了解他的由来："></a>俗话说，要了解一个东西，先了解他的由来：</h3><h2 id="一、Canal起源"><a href="#一、Canal起源" class="headerlink" title="一、Canal起源"></a>一、Canal起源</h2><p>​		阿里巴巴因为业务特性，买家集中在国外，衍生出了杭州美国异地数据同步需求，从2010年开始，阿里巴巴开始开发canal，canal是基于Java开发的数据库增量日志解析，提供增量数据订阅&amp;消费的中间件。Canal主要支持了Mysql和Bilog解析，解析完成后利用canal Client来处理获取相关数据。</p>
<p>了解完canal的起源，再来看看canal的核心业务依赖，也就是mysql的二进制日志：binary_log 简称：Binlog</p>
<h2 id="二、Binlog"><a href="#二、Binlog" class="headerlink" title="二、Binlog"></a>二、Binlog</h2><p>​		binlog指二进制日志，它记录了数据库上的所有改变，并以二进制的形式保存在磁盘中，它可以用来查看数据库的变更历史、数据库增量备份和恢复、MySQL的复制（主从数据库的复制）。</p>
<h4 id="binlog有三种格式："><a href="#binlog有三种格式：" class="headerlink" title="binlog有三种格式："></a>binlog有三种格式：</h4><p>statement：基于SQL语句的复制（statement-based replication，SBR）<br>row：基于行的复制（row-based replication，RBR）<br>mixed：混合模式复制（mixed-based replication，MBR）</p>
<h4 id="statement：语句级别"><a href="#statement：语句级别" class="headerlink" title="statement：语句级别"></a>statement：语句级别</h4><p>每一条会修改数据的sql都会记录在binlog中。</p>
<p>​		优点：不需要记录每一行的变化，减少了binlog日志量，节约了IO，提高性能。但是注意statement相比于row能节约多少性能与日志量，取决于应用的SQL情况。正常同一条记录修改或者插入row格式所产生的日志量还小于Statement产生的日志量，但是考虑到如果带条件的update操作，以及整表删除，alter表等操作，ROW格式会产生大量日志，因此在考虑是否使用ROW格式日志时应该跟据应用的实际情况，其所产生的日志量会增加多少，以及带来的IO性能问题。</p>
<p>​		缺点：由于记录的只是执行语句，为了这些语句在slave上正确运行，我们还必须记录每条语句在执行时候的一些相关信息，以保证所有语句能在slave得到和在master端执行时相同的结果。另外，一些特定的函数功能如果要在slave和master上保持一致会有很多相关问题。</p>
<h4 id="row：行数据级别"><a href="#row：行数据级别" class="headerlink" title="row：行数据级别"></a>row：行数据级别</h4><p>5.1.5版本的MySQL才开始支持row level的复制，它不记录sql语句上下文相关信息，仅保存哪条记录被修改。</p>
<p>​		优点：binlog中可以不记录执行的sql语句的上下文相关的信息，仅需要记录那一条记录被修改成什么了。所以row level的日志会非常清楚的记下每一行数据修改的细节。而且不会出现某些特定情况下的存储过程，或function，以及trigger的调用和触发无法被正确复制的问题。</p>
<p>​		缺点：所有的执行的语句当记录到日志中的时候，都将以每行记录的修改来记录，这样可能会产生大量的日志内容。但是新版本的MySQL对row level模式进行了优化，并不是所有的修改都会以row level来记录，像遇到表结构变更的时候就会以statement模式来记录，如果sql语句确实就是update或者delete等修改数据的语句，那么还是会记录所有行的变更。</p>
<h4 id="mixed：混合级别"><a href="#mixed：混合级别" class="headerlink" title="mixed：混合级别"></a>mixed：混合级别</h4><p>从5.1.8版本开始，MySQL提供了Mixed格式，实际上就是Statement与Row的结合。</p>
<p>​		在Mixed模式下，一般的语句修改使用statment格式保存binlog，如果一些函数，statement无法完成主从复制的操作，则采用row格式保存binlog，MySQL会根据执行的每一条具体的sql语句来区分对待记录的日志形式，也就是在Statement和Row之间选择一种。</p>
<h5 id="由于-statement-和-mixed-的特殊性，通过sql来备份，总会有数据不一致的情况，比如：now-函数。"><a href="#由于-statement-和-mixed-的特殊性，通过sql来备份，总会有数据不一致的情况，比如：now-函数。" class="headerlink" title="由于 statement 和 mixed 的特殊性，通过sql来备份，总会有数据不一致的情况，比如：now()函数。"></a>由于 statement 和 mixed 的特殊性，通过sql来备份，总会有数据不一致的情况，比如：now()函数。</h5><h5 id="所以绝大多数场景下使用-Row级别，也就是行级别，这样保证我们备份的数据和出口的数据相一致。"><a href="#所以绝大多数场景下使用-Row级别，也就是行级别，这样保证我们备份的数据和出口的数据相一致。" class="headerlink" title="所以绝大多数场景下使用 Row级别，也就是行级别，这样保证我们备份的数据和出口的数据相一致。"></a>所以绝大多数场景下使用 Row级别，也就是行级别，这样保证我们备份的数据和出口的数据相一致。</h5><h3 id="三、下载和安装Canal工具"><a href="#三、下载和安装Canal工具" class="headerlink" title="三、下载和安装Canal工具"></a>三、下载和安装Canal工具</h3><p>下载前，在mysql创建canal用户，因为canal服务端需要连接mysql数据库</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">-- 使用命令登录：mysql -u root -p</span><br><span class="line">-- 创建用户 用户名：canal 密码：Canal@123456</span><br><span class="line">create user <span class="string">&#x27;canal&#x27;</span>@<span class="string">&#x27;%&#x27;</span> identified by <span class="string">&#x27;Canal@123456&#x27;</span>;</span><br><span class="line">-- 授权 *.*表示所有库</span><br><span class="line">grant SELECT, REPLICATION SLAVE, REPLICATION CLIENT on *.* to <span class="string">&#x27;canal&#x27;</span>@<span class="string">&#x27;%&#x27;</span> identified by <span class="string">&#x27;Canal@123456&#x27;</span>;</span><br></pre></td></tr></table></figure>

<h4 id="改了配置文件之后，重启MySQL，使用命令查看是否打开binlog模式："><a href="#改了配置文件之后，重启MySQL，使用命令查看是否打开binlog模式：" class="headerlink" title="改了配置文件之后，重启MySQL，使用命令查看是否打开binlog模式："></a>改了配置文件之后，重启MySQL，使用命令查看是否打开binlog模式：</h4><p><img src="https://brath.cloud/blogImg/20200808151606261.png" alt="在这里插入图片描述"></p>
<h4 id="查看binlog日志文件列表："><a href="#查看binlog日志文件列表：" class="headerlink" title="查看binlog日志文件列表："></a>查看binlog日志文件列表：</h4><p><img src="https://brath.cloud/blogImg/20200808151715291.png" alt="在这里插入图片描述"></p>
<h3 id="点此下载Canal👇"><a href="#点此下载Canal👇" class="headerlink" title="点此下载Canal👇"></a>点此下载Canal👇</h3><p><a target="_blank" rel="noopener" href="https://ghproxy.com/https://github.com/alibaba/canal/releases/download/canal-1.1.2/canal.deployer-1.1.2.tar.gz">https://ghproxy.com/https://github.com/alibaba/canal/releases/download/canal-1.1.2/canal.deployer-1.1.2.tar.gz</a></p>
<p>此链接为github代理提供连接，仅供参考，此处无广告意义。</p>
<p><img src="https://brath.cloud/blogImg/image-20220629152616754.png" alt="image-20220629152616754"></p>
<p>下载好后上传至linux服务器，创建canal文件夹并解压到canal文件夹中</p>
<p><img src="https://brath.cloud/blogImg/image-20220629153150741.png" alt="image-20220629153150741"></p>
<p>完成后会得到以上四个核心文件：bin，conf，lib，logs</p>
<p>需要修改一处配置文件：</p>
<p>​		&#x2F;canal&#x2F;conf&#x2F;example 下的 instance.properties</p>
<p><img src="https://brath.cloud/blogImg/image-20220629153511220.png" alt="image-20220629153511220"></p>
<p>修改完成后保存退出</p>
<p>接下来进入bin目录 sh startUp.sh 启动 canal 服务端</p>
<h4 id="至此服务端的操作基本完成"><a href="#至此服务端的操作基本完成" class="headerlink" title="至此服务端的操作基本完成"></a>至此服务端的操作基本完成</h4><p>Java客户端操作<br>首先引入maven依赖：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.otter<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>canal.client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.1.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>然后创建一个canal项目，使用SpringBoot构建，如图所示，创建canal包：</p>
<p><img src="C:/Users/Administrator/AppData/Roaming/Typora/typora-user-images/image-20220629153956493.png" alt="image-20220629153956493"></p>
<p>canal工具类，仅供参考</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.brath.canal;</span><br><span class="line"><span class="keyword">import</span> java.awt.print.Printable;</span><br><span class="line"><span class="keyword">import</span> java.time.LocalDateTime;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> cn.brath.common.redis.service.TokenService;</span><br><span class="line"><span class="keyword">import</span> cn.brath.common.redis.util.RedisKeys;</span><br><span class="line"><span class="keyword">import</span> cn.brath.common.utils.AssertUtil;</span><br><span class="line"><span class="keyword">import</span> cn.brath.common.utils.UserTokenManager;</span><br><span class="line"><span class="keyword">import</span> cn.brath.entity.IvUser;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSONObject;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.otter.canal.client.CanalConnector;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.otter.canal.client.CanalConnectors;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.otter.canal.protocol.CanalEntry.*;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.otter.canal.protocol.Message;</span><br><span class="line"><span class="keyword">import</span> com.google.protobuf.InvalidProtocolBufferException;</span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.lang3.StringUtils;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.Logger;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.LoggerFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.print.attribute.standard.MediaPrintableArea;</span><br><span class="line"><span class="keyword">import</span> java.net.InetSocketAddress;</span><br><span class="line"><span class="keyword">import</span> java.time.ZoneId;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CanalClient</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * SLF4J日志</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">Logger</span> <span class="variable">logger</span> <span class="operator">=</span> LoggerFactory.getLogger(CanalClient.class);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">String</span> <span class="variable">host</span> <span class="operator">=</span> <span class="string">&quot;***.***.***.***&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">String</span> <span class="variable">port</span> <span class="operator">=</span> <span class="string">&quot;11111&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">String</span> <span class="variable">destination</span> <span class="operator">=</span> <span class="string">&quot;example&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 用户令牌业务接口</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> TokenService tokenService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">TokenServiceIn</span><span class="params">(TokenService tokenService)</span> &#123;</span><br><span class="line">        CanalClient.tokenService = tokenService;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * canal启动方法</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (!AssertUtil.isEmptys(host, port, destination)) &#123;</span><br><span class="line">            logger.error(<span class="string">&quot;canal客户端连接失败，当前服务端host：&#123;&#125;，port：&#123;&#125;，destination：&#123;&#125;&quot;</span>, host, port, destination);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">CanalConnector</span> <span class="variable">connector</span> <span class="operator">=</span> CanalConnectors.newSingleConnector(</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InetSocketAddress</span>(host, Integer.valueOf(port)), destination, <span class="string">&quot;&quot;</span>, <span class="string">&quot;&quot;</span></span><br><span class="line">        );</span><br><span class="line">        <span class="type">int</span> <span class="variable">batchSize</span> <span class="operator">=</span> <span class="number">1000</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//建立连接</span></span><br><span class="line">            connector.connect();</span><br><span class="line">            <span class="comment">//目标为全部表</span></span><br><span class="line">            connector.subscribe(<span class="string">&quot;.*\\..*&quot;</span>);</span><br><span class="line">            connector.rollback();</span><br><span class="line">            logger.info(<span class="string">&quot;canal客户端连接完成，当前服务端host：&#123;&#125;，port：&#123;&#125;，destination：&#123;&#125;&quot;</span>, host, port, destination);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">                    <span class="comment">//尝试从master那边拉去数据batchSize条记录，有多少取多少</span></span><br><span class="line">                    <span class="type">Message</span> <span class="variable">message</span> <span class="operator">=</span> connector.getWithoutAck(batchSize);</span><br><span class="line">                    <span class="type">long</span> <span class="variable">batchId</span> <span class="operator">=</span> message.getId();</span><br><span class="line">                    <span class="type">int</span> <span class="variable">size</span> <span class="operator">=</span> message.getEntries().size();</span><br><span class="line">                    <span class="keyword">if</span> (batchId == -<span class="number">1</span> || size == <span class="number">0</span>) &#123;</span><br><span class="line">                        Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        logger.info(<span class="string">&quot;同步任务进行中，检测到修改数据，执行同步Redis&quot;</span>);</span><br><span class="line">                        dataHandle(message.getEntries());</span><br><span class="line">                    &#125;</span><br><span class="line">                    connector.ack(batchId);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InvalidProtocolBufferException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            connector.disconnect();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 数据处理</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> entrys</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">dataHandle</span><span class="params">(List&lt;Entry&gt; entrys)</span> <span class="keyword">throws</span> InvalidProtocolBufferException &#123;</span><br><span class="line">        <span class="type">JSONObject</span> <span class="variable">beforeData</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="type">JSONObject</span> <span class="variable">afterData</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">for</span> (Entry entry : entrys) &#123;</span><br><span class="line">            <span class="keyword">if</span> (EntryType.ROWDATA.equals(entry.getEntryType())) &#123;</span><br><span class="line">                <span class="comment">//反序列化rowdata</span></span><br><span class="line">                <span class="type">RowChange</span> <span class="variable">rowChange</span> <span class="operator">=</span> RowChange.parseFrom(entry.getStoreValue());</span><br><span class="line">                <span class="comment">//获取数据集</span></span><br><span class="line">                List&lt;RowData&gt; rowDataList = rowChange.getRowDatasList();</span><br><span class="line">                <span class="comment">//获取数据遍历</span></span><br><span class="line">                <span class="keyword">for</span> (RowData rowData : rowDataList) &#123;</span><br><span class="line">                    afterData = <span class="keyword">new</span> <span class="title class_">JSONObject</span>();</span><br><span class="line">                    List&lt;Column&gt; afterColumnsList = rowData.getAfterColumnsList();</span><br><span class="line">                    <span class="keyword">for</span> (Column column : afterColumnsList) &#123;</span><br><span class="line">                        afterData.put(column.getName(), column.getValue());</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                </span><br><span class="line">                <span class="comment">//因为作者这里只做同步Redis，不考虑到操作类型，只需要覆盖相同键值数据</span></span><br><span class="line">                </span><br><span class="line">                <span class="comment">//写入Redis</span></span><br><span class="line">                executeRedisWarehousing(afterData);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 执行Redis用户数据入库</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> afterData</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">executeRedisWarehousing</span><span class="params">(JSONObject afterData)</span> &#123;</span><br><span class="line">        logger.info(<span class="string">&quot;开始执行Redis热更新入库同步Mysql -- &quot;</span>);</span><br><span class="line">		</span><br><span class="line">        <span class="keyword">do</span>...</span><br><span class="line">        </span><br><span class="line">        logger.info(<span class="string">&quot;入库完成&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h3 id="启动类使用："><a href="#启动类使用：" class="headerlink" title="启动类使用："></a>启动类使用：</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Application</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        SpringApplication.run(InterviewUserServiceApplication.class, args);</span><br><span class="line">        <span class="comment">//项目启动，执行canal客户端监听</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">CanalClient</span>().run();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            log.error(<span class="string">&quot; canal客户端监听 启动失败，原因可能是：&#123;&#125;&quot;</span>, e.getMessage());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>





<p>接下来启动项目运行，成功连接canal后我们尝试修改一个mysql的数据，发现在客户端成功完成了与Redis的同步操作</p>
<p><img src="https://brath.cloud/blogImg/image-20220629154454409.png" alt="image-20220629154454409"></p>
<h3 id="相关异常："><a href="#相关异常：" class="headerlink" title="相关异常："></a>相关异常：</h3><p>Canal异常：</p>
<p>dump address &#x2F;124.222.106.122:3306 has an error, retrying. caused by java.la</p>
<p>解决办法：重启Mysql，删除example下的 dat 后缀文件后重启canal</p>
<p>其他：</p>
<p>​	是否开放端口 11111 </p>
<p>​	mysql是否连接成功，查看logs&#x2F;example&#x2F;example.log</p>
<p>​	服务端与客户端是否连接成功，查看当前项目日志即可</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2022/12/27/Redis%E4%B8%8EMysql%20Master%E4%B8%8ESlave%E5%90%8C%E6%AD%A5%EF%BC%9Acanal%E6%95%99%E5%AD%A6/" data-id="clc5wl9k5000peol675hh4sz8" data-title="Redis与Mysql | Master与Slave同步：canal教学" class="article-share-link">Share</a>
      
      
      
    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2022/12/27/Redis%E4%B8%BB%E4%BB%8E%E9%9B%86%E7%BE%A4%E6%90%AD%E5%BB%BA%E6%96%87%E6%A1%A3/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          redis主从集群-哨兵模式搭建文档
        
      </div>
    </a>
  
  
    <a href="/2022/12/27/Redis%E6%8C%81%E4%B9%85%E5%8C%96/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">Redis持久化</div>
    </a>
  
</nav>

  
</article>


</section>
        
          <aside id="sidebar">
  
    

  
    

  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/12/">December 2022</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2022/12/27/%E4%B8%BB%E4%BB%8E%E5%90%8C%E6%AD%A5%E5%BC%82%E5%B8%B8%E8%AE%B0%E5%BD%95/">主从同步遇到 Got fatal error 1236 from master when reading data from binary log</a>
          </li>
        
          <li>
            <a href="/2022/12/27/%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E9%83%A8%E7%BD%B2%E5%AE%9D%E5%A1%94/">云服务器部署宝塔面板</a>
          </li>
        
          <li>
            <a href="/2022/12/27/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%8B%86%E5%88%86%E7%BB%86%E5%88%99/">微服务拆分细则</a>
          </li>
        
          <li>
            <a href="/2022/12/27/%E8%85%BE%E8%AE%AF%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8liux%E7%B3%BB%E7%BB%9F%E4%B8%8B%E6%97%A0%E6%B3%95%E9%80%9A%E8%BF%87springBoot%E5%86%85%E7%BD%AEmail%E5%8F%91%E9%80%81%E9%82%AE%E4%BB%B6%E7%9A%84%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88/">腾讯云服务器liux系统下无法通过springBoot内置mail发送邮件的解决方案</a>
          </li>
        
          <li>
            <a href="/2022/12/27/%E4%BD%BF%E7%94%A8docker%E6%90%AD%E5%BB%BA%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83%E8%AE%B0%E5%BD%95/">使用docker搭建开发环境记录</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      
      &copy; 2022 John Doe<br>
      Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    


<script src="/js/jquery-3.4.1.min.js"></script>



  
<script src="/fancybox/jquery.fancybox.min.js"></script>




<script src="/js/script.js"></script>





  </div>
</body>
</html>