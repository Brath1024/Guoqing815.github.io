<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  
  <title>ELASTICSEARCH7.X安全性之访问密码设置 | Hexo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="ELASTICSEARCH7.X安全性之访问密码设置1当我们安装完ElasticSearch的时候发现，访问过程中我们没有任何安全认证就可以直接访问并操作。如果是生产环境，端口向外暴露的话，那么对数据的安全性是无法得到保障的。  一般解决方案有  开启ElasticSearch认证插件，访问的时候添加账密不就好了 当然也可以通过nginx作代理防护  本文主要讲解通过启用X-Pack来设置Elas">
<meta property="og:type" content="article">
<meta property="og:title" content="ELASTICSEARCH7.X安全性之访问密码设置">
<meta property="og:url" content="http://example.com/2022/12/27/Elasticsearch7%E9%85%8D%E7%BD%AE%E8%AF%81%E4%B9%A6/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="ELASTICSEARCH7.X安全性之访问密码设置1当我们安装完ElasticSearch的时候发现，访问过程中我们没有任何安全认证就可以直接访问并操作。如果是生产环境，端口向外暴露的话，那么对数据的安全性是无法得到保障的。  一般解决方案有  开启ElasticSearch认证插件，访问的时候添加账密不就好了 当然也可以通过nginx作代理防护  本文主要讲解通过启用X-Pack来设置Elas">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://www.freesion.com/images/951/a3d0c1934c0ed0f8440f830d63e96dbf.png">
<meta property="og:image" content="https://www.freesion.com/images/953/de92ac2cf73d1ed0da994f9d1066e8f1.png">
<meta property="og:image" content="https://www.freesion.com/images/198/f383d0d38bab2a11f3293d44ffccf0ae.png">
<meta property="og:image" content="https://www.freesion.com/images/458/363890f3fdffcc0b1bcfaae3c8295952.png">
<meta property="og:image" content="https://www.freesion.com/images/561/b7034fa6ab245e277567b01d40929119.png">
<meta property="og:image" content="https://brath.oss-cn-shanghai.aliyuncs.com/pigo/9b1a95e8a4b361dd4f7e3012300d1115.png">
<meta property="og:image" content="https://www.freesion.com/images/96/57fa25b106cf1cdee9f44a2f8577e620.png">
<meta property="og:image" content="https://www.freesion.com/images/947/90ff281ef660a79e49875391f87e474b.png">
<meta property="og:image" content="https://www.freesion.com/images/485/efd6d897ad8655121334fd050eecd445.png">
<meta property="article:published_time" content="2022-12-27T07:24:12.695Z">
<meta property="article:modified_time" content="2022-10-18T05:02:56.343Z">
<meta property="article:author" content="John Doe">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://www.freesion.com/images/951/a3d0c1934c0ed0f8440f830d63e96dbf.png">
  
    <link rel="alternate" href="/atom.xml" title="Hexo" type="application/atom+xml">
  
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
    
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/typeface-source-code-pro@0.0.71/index.min.css">

  
  
<link rel="stylesheet" href="/css/style.css">

  
    
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">

  
<meta name="generator" content="Hexo 6.3.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Hexo</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://example.com"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main"><article id="post-Elasticsearch7配置证书" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2022/12/27/Elasticsearch7%E9%85%8D%E7%BD%AE%E8%AF%81%E4%B9%A6/" class="article-date">
  <time class="dt-published" datetime="2022-12-27T07:24:12.695Z" itemprop="datePublished">2022-12-27</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="p-name article-title" itemprop="headline name">
      ELASTICSEARCH7.X安全性之访问密码设置
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h2 id="ELASTICSEARCH7-X安全性之访问密码设置"><a href="#ELASTICSEARCH7-X安全性之访问密码设置" class="headerlink" title="ELASTICSEARCH7.X安全性之访问密码设置"></a>ELASTICSEARCH7.X安全性之访问密码设置</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">当我们安装完ElasticSearch的时候发现，访问过程中我们没有任何安全认证就可以直接访问并操作。如果是生产环境，端口向外暴露的话，那么对数据的安全性是无法得到保障的。</span><br></pre></td></tr></table></figure>

<p>一般解决方案有</p>
<ul>
<li>开启ElasticSearch认证插件，访问的时候添加账密不就好了</li>
<li>当然也可以通过nginx作代理防护</li>
</ul>
<p>本文主要讲解通过启用X-Pack来设置ElasticSearch的访问密码。</p>
<p>集群与单据环境都适合次方法</p>
<ul>
<li>集群与单据环境配置的区别就是，集群需要在某一台生成证书然后拷贝到其它节点目录下。</li>
<li>集群环境重设置密码的时候需要整个集群节点都已启动，可在任一台处修改。</li>
</ul>
<h2 id="2-X-PACK简介"><a href="#2-X-PACK简介" class="headerlink" title="2.X-PACK简介"></a>2.X-PACK简介</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">X-Pack是Elastic Stack扩展功能，提供安全性，警报，监视，报告，机器学习和许多其他功能。 ES7.0+之后，默认情况下，当安装Elasticsearch时，会自动安装X-Pack，无需单独再安装。自6.8以及7.1+版本之后，基础级安全永久免费了。</span><br><span class="line">在使用的时候主要需要配置一下证书，以及修改配置文件（config/elasticsearch.yml ）</span><br></pre></td></tr></table></figure>

<h2 id="3-证书配置"><a href="#3-证书配置" class="headerlink" title="3.证书配置"></a>3.证书配置</h2><h3 id="3-1生成节点证书"><a href="#3-1生成节点证书" class="headerlink" title="3.1生成节点证书"></a>3.1生成节点证书</h3><p>切换到 elasticsearch 安装文件目录 bin 下 ：示例：&#x2F;usr&#x2F;local&#x2F;elasticsearch-7.4.0&#x2F;bin<br>借助elasticsearch-certutil命令生成证书：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./elasticsearch-certutil ca -out config/certs/elastic-certificates.p12 -pass</span><br></pre></td></tr></table></figure>

<p>这里单独设置了一个 证书文件目录 config&#x2F;certs<br><img src="https://www.freesion.com/images/951/a3d0c1934c0ed0f8440f830d63e96dbf.png" alt="在这里插入图片描述"></p>
<p>生成后的证书<br><img src="https://www.freesion.com/images/953/de92ac2cf73d1ed0da994f9d1066e8f1.png" alt="在这里插入图片描述"></p>
<h3 id="3-2修改配置"><a href="#3-2修改配置" class="headerlink" title="3.2修改配置"></a>3.2修改配置</h3><p>配置通信证书 &gt; 需要在 config目前下elasticsearch.yml 配置</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"># 开启xpack</span><br><span class="line">xpack.security.enabled: true</span><br><span class="line">xpack.license.self_generated.type: basic</span><br><span class="line">xpack.security.transport.ssl.enabled: true</span><br><span class="line"># 证书配置</span><br><span class="line">xpack.security.transport.ssl.verification_mode: certificate</span><br><span class="line">xpack.security.transport.ssl.keystore.path: certs/elastic-certificates.p12</span><br><span class="line">xpack.security.transport.ssl.truststore.path: certs/elastic-certificates.p12</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>其它配置（可选）</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">#跨域配置</span><br><span class="line">http.cors.enabled: true</span><br><span class="line">http.cors.allow-origin: &quot;*&quot;</span><br><span class="line">http.cors.allow-headers: Authorization,X-Requested-With,Content-Length,Content-Type</span><br></pre></td></tr></table></figure>

<p>注:若是集群环境则需要将证书文件目录，以及配置文件，在所有集群环境下都修改一下。</p>
<h3 id="3-3-重启生效"><a href="#3-3-重启生效" class="headerlink" title="3.3.重启生效"></a>3.3.重启生效</h3><p>需要重启elasticsearch</p>
<p>注：若是集群环境下则需要启动所有集群节点，再统一设置密码</p>
<p>注：重启异常情况，若出现报错，类似 failed to load plugin class[org.elasticsearch.xpack.core.XPackPlugin]<br>请检查是否是使用root用户生成的证书，启动用户无权限导致。</p>
<h2 id="4-设置用户密码"><a href="#4-设置用户密码" class="headerlink" title="4.设置用户密码"></a>4.设置用户密码</h2><p>执行设置用户名和密码的命令,内置了部分用户<br>切换到 elasticsearch 安装文件目录 bin 下 ：示例：&#x2F;usr&#x2F;local&#x2F;elasticsearch-7.4.0&#x2F;bin&#x2F;</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 手动配置每个用户密码模式（需要一个一个的输入）</span><br><span class="line">./elasticsearch-setup-passwords interactive</span><br></pre></td></tr></table></figure>

<p>也可以先自动配置密码后续再修改</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#自动配置每个用户密码（随机生成并返回字符串密码,需要保存好）</span><br><span class="line">./elasticsearch-setup-passwords auto  </span><br></pre></td></tr></table></figure>

<p>下图1是自动生成密码情况（一定拷贝下来要牢记密码）<br><img src="https://www.freesion.com/images/198/f383d0d38bab2a11f3293d44ffccf0ae.png" alt="在这里插入图片描述"></p>
<p>下图2是自定义密码情况<br>分别为多个用户设置密码例如：elastic, kibana, logstash_system,beats_system,<br>设置密码的时候需要连续输入2遍。<br><img src="https://www.freesion.com/images/458/363890f3fdffcc0b1bcfaae3c8295952.png" alt="在这里插入图片描述"></p>
<p>部分内置账号的角色权限解释如下：</p>
<ul>
<li>elastic 账号：拥有 superuser 角色，是内置的超级用户。</li>
<li>kibana 账号：拥有 kibana_system 角色，用户 kibana 用来连接 elasticsearch 并与之通信。Kibana 服务器以该用户身份提交请求以访问集群监视 API 和 .kibana 索引。不能访问 index。</li>
<li>logstash_system 账号：拥有 logstash_system 角色。用户 Logstash 在 Elasticsearch 中存储监控信息时使用。</li>
</ul>
<p>至此单节点安全配置完毕，重启es后访问9200会出现用户名和密码的提示窗口,我们就可以通过用户生成的密码过行访问了</p>
<h2 id="5-测试访问"><a href="#5-测试访问" class="headerlink" title="5.测试访问"></a>5.测试访问</h2><p>通过查看证书方式，顺便测试一下密码是否生效了<br>浏览器输入 <a target="_blank" rel="noopener" href="http://ip:9200/_license">http://IP:9200/_license</a> 可以看到，弹窗出来，需要输入密码了<br><img src="https://www.freesion.com/images/561/b7034fa6ab245e277567b01d40929119.png" alt="在这里插入图片描述"><br><img src="https://brath.oss-cn-shanghai.aliyuncs.com/pigo/9b1a95e8a4b361dd4f7e3012300d1115.png" alt="在这里插入图片描述"></p>
<h2 id="附录：常见问题"><a href="#附录：常见问题" class="headerlink" title="附录：常见问题"></a>附录：常见问题</h2><h3 id="1-如何修改账号密码"><a href="#1-如何修改账号密码" class="headerlink" title="1.如何修改账号密码"></a>1.如何修改账号密码</h3><p>以elastic账号为例，注意需要在elasticsearch服务已启动的情况下进行</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -H &#x27;Content-Type: application/json&#x27; -u elastic:123456 -XPUT &#x27;http://localhost:9200/_xpack/security/user/elastic/_password&#x27; -d &#x27;&#123; &quot;password&quot; : &quot;1234567&quot; &#125;&#x27;</span><br></pre></td></tr></table></figure>

<h3 id="2-客户端ES-HEAD连接问题"><a href="#2-客户端ES-HEAD连接问题" class="headerlink" title="2.客户端ES-HEAD连接问题"></a>2.客户端ES-HEAD连接问题</h3><p>连接失败情况下先检查是否是跨域问题</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">http.cors.enabled: true</span><br><span class="line">http.cors.allow-origin: &quot;*&quot;</span><br><span class="line">http.cors.allow-headers: Authorization,X-Requested-With,Content-Length,Content-Type</span><br></pre></td></tr></table></figure>

<p>例如下图连接的时候报错未授权<br><img src="https://www.freesion.com/images/96/57fa25b106cf1cdee9f44a2f8577e620.png" alt="在这里插入图片描述"></p>
<p>解决方案：在访问的URL中拼接授权账号信息<br>示例：?auth_user&#x3D;elastic&amp;auth_password&#x3D;1234567</p>
<p>示例:指定服务端地址以及账户</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://IP:9100/?base_uri=http://IP:9200&amp;auth_user=elastic&amp;auth_password=1234567</span><br></pre></td></tr></table></figure>

<h3 id="3-启动报XPACK相关错"><a href="#3-启动报XPACK相关错" class="headerlink" title="3.启动报XPACK相关错"></a>3.启动报XPACK相关错</h3><p><img src="https://www.freesion.com/images/947/90ff281ef660a79e49875391f87e474b.png" alt="在这里插入图片描述"></p>
<p>DecoderException: javax.net.ssl.SSLHandshakeException: No available authentication scheme<br><img src="https://www.freesion.com/images/485/efd6d897ad8655121334fd050eecd445.png" alt="在这里插入图片描述"></p>
<p>解决方案：请通过上文配置步骤，排查，检查证书是否已经配置好，以及配置是否填写正确</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2022/12/27/Elasticsearch7%E9%85%8D%E7%BD%AE%E8%AF%81%E4%B9%A6/" data-id="clc5wl9jq0005eol6bngj0bw1" data-title="ELASTICSEARCH7.X安全性之访问密码设置" class="article-share-link">Share</a>
      
      
      
    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2022/12/27/Flutter%20%E6%B5%81%E7%95%85%E5%BA%A6%E4%BC%98%E5%8C%96%E7%BB%84%E4%BB%B6%20Keframe/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          Flutter 流畅度优化组件 Keframe
        
      </div>
    </a>
  
  
    <a href="/2022/12/27/Elasticsearch/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">Elasticsearch学习</div>
    </a>
  
</nav>

  
</article>


</section>
        
          <aside id="sidebar">
  
    

  
    

  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/12/">December 2022</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2022/12/27/%E4%B8%BB%E4%BB%8E%E5%90%8C%E6%AD%A5%E5%BC%82%E5%B8%B8%E8%AE%B0%E5%BD%95/">主从同步遇到 Got fatal error 1236 from master when reading data from binary log</a>
          </li>
        
          <li>
            <a href="/2022/12/27/%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E9%83%A8%E7%BD%B2%E5%AE%9D%E5%A1%94/">云服务器部署宝塔面板</a>
          </li>
        
          <li>
            <a href="/2022/12/27/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%8B%86%E5%88%86%E7%BB%86%E5%88%99/">微服务拆分细则</a>
          </li>
        
          <li>
            <a href="/2022/12/27/%E8%85%BE%E8%AE%AF%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8liux%E7%B3%BB%E7%BB%9F%E4%B8%8B%E6%97%A0%E6%B3%95%E9%80%9A%E8%BF%87springBoot%E5%86%85%E7%BD%AEmail%E5%8F%91%E9%80%81%E9%82%AE%E4%BB%B6%E7%9A%84%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88/">腾讯云服务器liux系统下无法通过springBoot内置mail发送邮件的解决方案</a>
          </li>
        
          <li>
            <a href="/2022/12/27/%E4%BD%BF%E7%94%A8docker%E6%90%AD%E5%BB%BA%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83%E8%AE%B0%E5%BD%95/">使用docker搭建开发环境记录</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      
      &copy; 2022 John Doe<br>
      Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    


<script src="/js/jquery-3.4.1.min.js"></script>



  
<script src="/fancybox/jquery.fancybox.min.js"></script>




<script src="/js/script.js"></script>





  </div>
</body>
</html>