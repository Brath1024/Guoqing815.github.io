<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  
  <title>Elasticsearch学习 | Hexo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="Elasticsearch 目标 了解ES中的基本概念 掌握RESTFul操作ES的CRUD 掌握Spring Data Elasticsearch操作ES  简介Elasticsearch是一个基于Lucene的搜索服务器。它提供了一个分布式多用户能力的全文搜索引擎，基于RESTful web接口。Elasticsearch是用Java开发的，并作为Apache许可条款下的开放源码发布，是当前流">
<meta property="og:type" content="article">
<meta property="og:title" content="Elasticsearch学习">
<meta property="og:url" content="http://example.com/2022/12/27/Elasticsearch/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="Elasticsearch 目标 了解ES中的基本概念 掌握RESTFul操作ES的CRUD 掌握Spring Data Elasticsearch操作ES  简介Elasticsearch是一个基于Lucene的搜索服务器。它提供了一个分布式多用户能力的全文搜索引擎，基于RESTful web接口。Elasticsearch是用Java开发的，并作为Apache许可条款下的开放源码发布，是当前流">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://images-jsh.oss-cn-beijing.aliyuncs.com/img/elasticsearch.jpg">
<meta property="og:image" content="https://images-jsh.oss-cn-beijing.aliyuncs.com/img/20190606092632.png">
<meta property="og:image" content="https://images-jsh.oss-cn-beijing.aliyuncs.com/img/20190606093141.png">
<meta property="og:image" content="https://images-jsh.oss-cn-beijing.aliyuncs.com/img/20190622211819.png">
<meta property="og:image" content="https://images-jsh.oss-cn-beijing.aliyuncs.com/img/20190606141235.png">
<meta property="og:image" content="https://images-jsh.oss-cn-beijing.aliyuncs.com/img/20190604113843.png">
<meta property="og:image" content="https://images-jsh.oss-cn-beijing.aliyuncs.com/img/20190611130218.png">
<meta property="og:image" content="https://images-jsh.oss-cn-beijing.aliyuncs.com/img/20190604141259.png">
<meta property="og:image" content="https://images-jsh.oss-cn-beijing.aliyuncs.com/img/%E6%88%AA%E5%B1%8F2021-08-14%2014.17.14.png">
<meta property="article:published_time" content="2022-12-27T07:24:12.694Z">
<meta property="article:modified_time" content="2021-10-22T03:45:20.100Z">
<meta property="article:author" content="John Doe">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://images-jsh.oss-cn-beijing.aliyuncs.com/img/elasticsearch.jpg">
  
    <link rel="alternate" href="/atom.xml" title="Hexo" type="application/atom+xml">
  
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
    
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/typeface-source-code-pro@0.0.71/index.min.css">

  
  
<link rel="stylesheet" href="/css/style.css">

  
    
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">

  
<meta name="generator" content="Hexo 6.3.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Hexo</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://example.com"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main"><article id="post-Elasticsearch" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2022/12/27/Elasticsearch/" class="article-date">
  <time class="dt-published" datetime="2022-12-27T07:24:12.694Z" itemprop="datePublished">2022-12-27</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="p-name article-title" itemprop="headline name">
      Elasticsearch学习
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="Elasticsearch"><a href="#Elasticsearch" class="headerlink" title="Elasticsearch"></a>Elasticsearch</h1><p><img src="https://images-jsh.oss-cn-beijing.aliyuncs.com/img/elasticsearch.jpg" alt="img"></p>
<h2 id="目标"><a href="#目标" class="headerlink" title="目标"></a>目标</h2><ul>
<li>了解ES中的基本概念</li>
<li>掌握RESTFul操作ES的CRUD</li>
<li>掌握Spring Data Elasticsearch操作ES</li>
</ul>
<h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>Elasticsearch是一个基于Lucene的搜索服务器。它提供了一个分布式多用户能力的全文搜索引擎，基于RESTful web接口。Elasticsearch是用Java开发的，并作为Apache许可条款下的开放源码发布，是当前流行的企业级搜索引擎。设计用于云计算中，能够达到实时搜索，稳定，可靠，快速，安装使用方便。</p>
<p>我们建立一个网站或应用程序，并要添加搜索功能，但是想要完成搜索工作的创建是非常困难的。我们希望搜索解决方案要运行速度快，我们希望能有一个零配置和一个完全免费的搜索模式，我们希望能够简单地使用JSON通过HTTP来索引数据，我们希望我们的搜索服务器始终可用，我们希望能够从一台开始并扩展到数百台，我们要实时搜索，我们要简单的多用户，我们希望建立一个云的解决方案。因此我们利用Elasticsearch来解决所有这些问题及可能出现的更多其它问题。</p>
<h2 id="安装和运行"><a href="#安装和运行" class="headerlink" title="安装和运行"></a>安装和运行</h2><p>该软件是基于Java编写的解压即用的软件，只需要有Java的运行环境即可，把压缩包解压后，进入到bin目录运行elasticsearch.bat，出现以下界面，表示成功启动服务器</p>
<p><img src="https://images-jsh.oss-cn-beijing.aliyuncs.com/img/20190606092632.png" alt="img"></p>
<p>浏览器输入：<strong>localhost:9200</strong>，看到浏览器输出服务器的信息，表示安装成功，可以使用了</p>
<p><img src="https://images-jsh.oss-cn-beijing.aliyuncs.com/img/20190606093141.png" alt="img"></p>
<p>注意：程序启动后有两个端口9200和9300，9200端口用于HTTP协议，基于RESTFul来使用，9300端口用于TCP协议，基于jar包来使用</p>
<h3 id="后台启动"><a href="#后台启动" class="headerlink" title="后台启动"></a>后台启动</h3><p>使用<strong>安装目录&#x2F;bin&#x2F;elasticsearch-service.bat</strong>程序可以把Elasticsearch安装后服务列表中，以后我们可以在服务列表来启动该程序，也可以设置成开机启动模式</p>
<p>注意：设置后台启动需要手动配置Java虚拟机的路径，使用命令<strong>elasticsearch-service.bat manager</strong>来配置</p>
<p><img src="https://images-jsh.oss-cn-beijing.aliyuncs.com/img/20190622211819.png" alt="img"></p>
<h3 id="安装head插件"><a href="#安装head插件" class="headerlink" title="安装head插件"></a>安装head插件</h3><p>Elasticsearch默认的客户端工具是命令行形式的，操作起来不方便，也不直观看到数据的展示，所以我们需要去安装一个可视化插件，但是这些插件都是基于H5开发的，在谷歌的应用商店中找到<strong>elasticsearch-head</strong>插件，然后安装，使用该插件能比较直观的展示服务器中的数据</p>
<h3 id="安装kibana"><a href="#安装kibana" class="headerlink" title="安装kibana"></a>安装kibana</h3><p>该软件也是解压即用的工具，用于管理和监控Elasticsearch的运作，同时内部包含了客户端工具，支持RESTFul操作Elasticsearch。解压后运行bin&#x2F;kibana.bat，看到启动成功的端口号即可以使用浏览器来使用了</p>
<p><img src="https://images-jsh.oss-cn-beijing.aliyuncs.com/img/20190606141235.png" alt="img"></p>
<p>浏览器输入：<a target="_blank" rel="noopener" href="http://localhost:5601/">http://localhost:5601</a></p>
<h2 id="概念名词"><a href="#概念名词" class="headerlink" title="概念名词"></a>概念名词</h2><h3 id="数据存储图"><a href="#数据存储图" class="headerlink" title="数据存储图"></a>数据存储图</h3><p><img src="https://images-jsh.oss-cn-beijing.aliyuncs.com/img/20190604113843.png" alt="img"></p>
<p>注意：从Elasticsearch6开始一个索引里面只能有一个类型，后续计划删除类型这个概念，从ES6开始一般让索引名称和类型名称一致</p>
<h3 id="主要组件"><a href="#主要组件" class="headerlink" title="主要组件"></a>主要组件</h3><ul>
<li><p>索引</p>
<p>ES将数据存储于一个或多个索引中，索引是具有类似特性的文档的集合。类比传统的关系型数据库领域来说，索引相当于SQL中的一个数据库，或者一个数据存储方案(schema)。索引由其名称(必须为全小写字符)进行标识，并通过引用此名称完成文档的创建、搜索、更新及删除操作。一个ES集群中可以按需创建任意数目的索引。</p>
</li>
<li><p>类型</p>
<p>类型是索引内部的逻辑分区(category&#x2F;partition)，然而其意义完全取决于用户需求。因此，一个索引内部可定义一个或多个类型(type)。一般来说，类型就是为那些拥有相同的域的文档做的预定义。例如，在索引中，可以定义一个用于存储用户数据的类型，一个存储日志数据的类型，以及一个存储评论数据的类型。类比传统的关系型数据库领域来说，类型相当于表。</p>
</li>
<li><p>映射</p>
<p>Mapping,就是对索引库中索引的字段名称及其数据类型进行定义，类似于mysql中的表结构信息。不过es的mapping比数据库灵活很多，它可以动态识别字段。一般不需要指定mapping都可以，因为es会自动根据数据格式识别它的类型，如果你需要对某些字段添加特殊属性（如：定义使用其它分词器、是否分词、是否存储等），就必须手动添加mapping。</p>
<p>需要注意的是映射是不可修改的，一旦确定就不允许改动，在使用自动识别功能时，会以第一个存入的文档为参考来建立映射，后面存入的文档也必须符合该映射才能存入</p>
</li>
<li><p>文档</p>
<p>文档是Lucene索引和搜索的原子单位，它是包含了一个或多个域的容器，基于JSON格式进行表示。文档由一个或多个域组成，每个域拥有一个名字及一个或多个值，有多个值的域通常称为多值域。每个文档可以存储不同的域集，但同一类型下的文档至应该有某种程度上的相似之处。</p>
</li>
</ul>
<h3 id="分片和副本"><a href="#分片和副本" class="headerlink" title="分片和副本"></a>分片和副本</h3><p>ES的分片(shard)机制可将一个索引内部的数据分布地存储于多个节点，它通过将一个索引切分为多个底层物理的Lucene索引完成索引数据的分割存储功能，这每一个物理的Lucene索引称为一个分片(shard)。每个分片其内部都是一个全功能且独立的索引，因此可由集群中的任何主机存储。创建索引时，用户可指定其分片的数量，默认数量为5个。</p>
<p>Shard有两种类型：primary和replica，即主shard及副本shard。Primary shard用于文档存储，每个新的索引会自动创建5个Primary shard，当然此数量可在索引创建之前通过配置自行定义，不过，一旦创建完成，其Primary shard的数量将不可更改。Replica shard是Primary Shard的副本，用于冗余数据及提高搜索性能。每个Primary shard默认配置了一个Replica shard，但也可以配置多个，且其数量可动态更改。ES会根据需要自动增加或减少这些Replica shard的数量。</p>
<h3 id="分词器"><a href="#分词器" class="headerlink" title="分词器"></a>分词器</h3><p>把文本内容按照标准进行切分，默认的是standard，该分词器按照单词切分，内容转变为小写，去掉标点，遇到每个中文字符都当成1个单词处理，后面会安装开源的中文分词器插件（ik）</p>
<h4 id="感受分词器效果"><a href="#感受分词器效果" class="headerlink" title="感受分词器效果"></a>感受分词器效果</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">先创建一个名叫shop_product的索引，然后再感受分词效果</span><br><span class="line">PUT /shop_product</span><br><span class="line"></span><br><span class="line">默认分词器：</span><br><span class="line">GET /shop_product/_analyze</span><br><span class="line">&#123;</span><br><span class="line">  &quot;text&quot;:&quot;I am Groot&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">GET /shop_product/_analyze</span><br><span class="line">&#123;</span><br><span class="line">  &quot;text&quot;:&quot;英特尔酷睿i7处理器&quot;</span><br><span class="line">&#125;</span><br><span class="line">结论：默认的分词器只能对英文正常分词，不能对中文正常分词</span><br></pre></td></tr></table></figure>

<h4 id="安装IK分词器"><a href="#安装IK分词器" class="headerlink" title="安装IK分词器"></a>安装IK分词器</h4><p>直接把压缩文件中的内容解压，然后放在elasticsearch&#x2F;plugins下，然后重启即可</p>
<p><img src="https://images-jsh.oss-cn-beijing.aliyuncs.com/img/20190611130218.png" alt="img"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">IK分词器：</span><br><span class="line">ik_smart：粗力度分词</span><br><span class="line">ik_max_word：细力度分词</span><br><span class="line"></span><br><span class="line">GET /shop_product/_analyze</span><br><span class="line">&#123;</span><br><span class="line">  &quot;text&quot;:&quot;I am Groot&quot;,</span><br><span class="line">  &quot;analyzer&quot;:&quot;ik_smart&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">GET /shop_product/_analyze</span><br><span class="line">&#123;</span><br><span class="line">  &quot;text&quot;:&quot;英特尔酷睿i7处理器&quot;,</span><br><span class="line">  &quot;analyzer&quot;:&quot;ik_smart&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">GET /shop_product/_analyze</span><br><span class="line">&#123;</span><br><span class="line">  &quot;text&quot;:&quot;英特尔酷睿i7处理器&quot;,</span><br><span class="line">  &quot;analyzer&quot;:&quot;ik_max_word&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">结论：都能正常分词</span><br></pre></td></tr></table></figure>

<h4 id="拓展词库"><a href="#拓展词库" class="headerlink" title="拓展词库"></a>拓展词库</h4><p>最简单的方式就是找到IK插件中的<strong>config&#x2F;main.dic</strong>文件，往里面添加新的词汇，然后重启服务器即可</p>
<h3 id="倒排索引"><a href="#倒排索引" class="headerlink" title="倒排索引"></a>倒排索引</h3><p><img src="https://images-jsh.oss-cn-beijing.aliyuncs.com/img/20190604141259.png" alt="img"></p>
<h2 id="基本操作（了解）"><a href="#基本操作（了解）" class="headerlink" title="基本操作（了解）"></a>基本操作（了解）</h2><h3 id="索引操作"><a href="#索引操作" class="headerlink" title="索引操作"></a>索引操作</h3><p>建表索引，相当于在是在建立数据库</p>
<h4 id="建立索引"><a href="#建立索引" class="headerlink" title="建立索引"></a>建立索引</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">语法：PUT /索引名</span><br><span class="line">在没有特殊设置的情况下，默认有5个分片，1个备份，也可以通过请求参数的方式来指定</span><br><span class="line">参数格式：</span><br><span class="line">&#123;</span><br><span class="line">  &quot;settings&quot;: &#123;</span><br><span class="line">    &quot;number_of_shards&quot;: 5, //设置5个片区</span><br><span class="line">    &quot;number_of_replicas&quot;: 1 //设置1个备份</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="删除索引"><a href="#删除索引" class="headerlink" title="删除索引"></a>删除索引</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">语法：DELETE /索引名</span><br></pre></td></tr></table></figure>

<h3 id="映射操作"><a href="#映射操作" class="headerlink" title="映射操作"></a>映射操作</h3><h4 id="建立索引和映射"><a href="#建立索引和映射" class="headerlink" title="建立索引和映射"></a>建立索引和映射</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">语法：PUT /索引名</span><br><span class="line">&#123;</span><br><span class="line">  &quot;mappings&quot;: &#123;</span><br><span class="line">    类型名: &#123;</span><br><span class="line">      &quot;properties..0&quot;: &#123;</span><br><span class="line">        字段名: &#123;</span><br><span class="line">          &quot;type&quot;: 字段类型, </span><br><span class="line">          &quot;analyzer&quot;: 分词器类型, </span><br><span class="line">          &quot;search_analyzer&quot;: 分词器类型,</span><br><span class="line">          ...</span><br><span class="line">        &#125;,</span><br><span class="line">        ...</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">字段类型：double / long / integer / text / keyword / date / binary</span><br><span class="line">注意：text和keyword都是字符串类型，但是只有text类型的数据才能分词，字段的配置一旦确定就不能更改</span><br><span class="line">映射的配置项有很多，我们可以根据需要只配置用得上的属性</span><br></pre></td></tr></table></figure>

<h4 id="查询映射"><a href="#查询映射" class="headerlink" title="查询映射"></a>查询映射</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">语法：GET /索引名/_mapping</span><br></pre></td></tr></table></figure>

<h2 id="CRUD操作"><a href="#CRUD操作" class="headerlink" title="CRUD操作"></a>CRUD操作</h2><h3 id="文档操作"><a href="#文档操作" class="headerlink" title="文档操作"></a>文档操作</h3><h4 id="新增和替换文档"><a href="#新增和替换文档" class="headerlink" title="新增和替换文档"></a>新增和替换文档</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">语法：PUT /索引名/类型名/文档ID</span><br><span class="line">&#123;</span><br><span class="line">  field1: value1,</span><br><span class="line">  field2: value2,</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">注意：当索引/类型/映射不存在时，会使用默认设置自动添加</span><br><span class="line">ES中的数据一般是从别的数据库导入的，所以文档的ID会沿用原数据库中的ID</span><br><span class="line">索引库中没有该ID对应的文档时则新增，拥有该ID对应的文档时则替换</span><br><span class="line"></span><br><span class="line">需求1：新增一个文档</span><br><span class="line">需求2：替换一个文档</span><br></pre></td></tr></table></figure>

<p>每一个文档都内置以下字段</p>
<blockquote>
<p>_index：所属索引</p>
<p>_type：所属类型</p>
<p>_id：文档ID</p>
<p>_version：乐观锁版本号</p>
<p>_source：数据内容</p>
</blockquote>
<h4 id="查询文档"><a href="#查询文档" class="headerlink" title="查询文档"></a>查询文档</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">语法：</span><br><span class="line">根据ID查询 -&gt; GET /索引名/类型名/文档ID</span><br><span class="line">查询所有（基本查询语句） -&gt; GET /索引名/类型名/_search</span><br><span class="line"></span><br><span class="line">需求1：根据文档ID查询一个文档</span><br><span class="line">需求2：查询所有的文档</span><br></pre></td></tr></table></figure>

<p>查询所有结果中包含以下字段</p>
<blockquote>
<p>took：耗时</p>
<p>_shards.total：分片总数</p>
<p>hits.total：查询到的数量</p>
<p>hits.max_score：最大匹配度</p>
<p>hits.hits：查询到的结果</p>
<p>hits.hits._score：匹配度</p>
</blockquote>
<h4 id="删除文档"><a href="#删除文档" class="headerlink" title="删除文档"></a>删除文档</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">语法：DELETE /索引名/类型名/文档ID</span><br><span class="line">注意：这里的删除并且不是真正意义上的删除，仅仅是清空文档内容而已，并且标记该文档的状态为删除</span><br><span class="line"></span><br><span class="line">需求1：根据文档ID删除一个文档</span><br><span class="line">需求2：替换刚刚删除的文档</span><br></pre></td></tr></table></figure>

<h2 id="高级查询"><a href="#高级查询" class="headerlink" title="高级查询"></a>高级查询</h2><p>数据准备：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">PUT /shop_product</span><br><span class="line">&#123;</span><br><span class="line">  &quot;mappings&quot;: &#123;</span><br><span class="line">    &quot;shop_product&quot;: &#123;</span><br><span class="line">      &quot;properties&quot;: &#123;</span><br><span class="line">        &quot;id&quot;: &#123;</span><br><span class="line">          &quot;type&quot;: &quot;integer&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;title&quot;:&#123;</span><br><span class="line">          &quot;type&quot;: &quot;text&quot;, </span><br><span class="line">          &quot;analyzer&quot;: &quot;ik_smart&quot;, </span><br><span class="line">          &quot;search_analyzer&quot;: &quot;ik_smart&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;price&quot;:&#123;</span><br><span class="line">          &quot;type&quot;: &quot;double&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;intro&quot;:&#123;</span><br><span class="line">          &quot;type&quot;: &quot;text&quot;, </span><br><span class="line">          &quot;analyzer&quot;: &quot;ik_smart&quot;, </span><br><span class="line">          &quot;search_analyzer&quot;: &quot;ik_smart&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;brand&quot;:&#123;</span><br><span class="line">          &quot;type&quot;: &quot;keyword&quot;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">POST /shop_product/shop_product/_bulk</span><br><span class="line">&#123;&quot;create&quot;:&#123;&quot;_id&quot;: 1&#125;&#125;</span><br><span class="line">&#123;&quot;id&quot;:1,&quot;title&quot;:&quot;Apple iPhone XR (A2108) 128GB 白色 移动联通电信4G手机 双卡双待&quot;,&quot;price&quot;:5299,&quot;intro&quot;:&quot;【iPhoneXR限时特惠！】6.1英寸视网膜显示屏，A12仿生芯片，面容识别，无线充电，支持双卡！选【换修无忧版】获 AppleCare 原厂服务，享只换不修！更有快速换机、保值换新、轻松月付！&quot;,&quot;brand&quot;:&quot;Apple&quot;&#125;</span><br><span class="line">&#123;&quot;create&quot;:&#123;&quot;_id&quot;: 2&#125;&#125;</span><br><span class="line">&#123;&quot;id&quot;:2,&quot;title&quot;:&quot;Apple 2019款 Macbook Pro 13.3【带触控栏】八代i7 18G 256G RP645显卡 深空灰 苹果笔记本电脑 轻薄本 MUHN2CH/A&quot;,&quot;price&quot;:15299,&quot;intro&quot;:&quot;【八月精选】Pro2019年新品上市送三重好礼，现在购买领满8000减400元优惠神劵，劵后更优惠！&quot;,&quot;brand&quot;:&quot;Apple&quot;&#125;</span><br><span class="line">&#123;&quot;create&quot;:&#123;&quot;_id&quot;: 3&#125;&#125;</span><br><span class="line">&#123;&quot;id&quot;:3,&quot;title&quot;:&quot;Apple iPad Air 3 2019年新款平板电脑 10.5英寸（64G WLAN版/A12芯片/Retina显示屏/MUUL2CH/A）金色&quot;,&quot;price&quot;:3788,&quot;intro&quot;:&quot;8月尊享好礼！买iPad即送蓝牙耳机！领券立减！多款产品支持手写笔！【新一代iPad，总有一款适合你】选【换修无忧版】获 AppleCare 原厂服务，享只换不修！更有快速换机、保值换新、轻松月付！&quot;,&quot;brand&quot;:&quot;Apple&quot;&#125;</span><br><span class="line">&#123;&quot;create&quot;:&#123;&quot;_id&quot;: 4&#125;&#125;</span><br><span class="line">&#123;&quot;id&quot;:4,&quot;title&quot;:&quot;华为HUAWEI MateBook X Pro 2019款 英特尔酷睿i5 13.9英寸全面屏轻薄笔记本电脑(i5 8G 512G 3K 触控) 灰&quot;,&quot;price&quot;:7999,&quot;intro&quot;:&quot;3K全面屏开启无界视野;轻薄设计灵动有型，HuaweiShare一碰传&quot;,&quot;brand&quot;:&quot;华为&quot;&#125;</span><br><span class="line">&#123;&quot;create&quot;:&#123;&quot;_id&quot;: 5&#125;&#125;</span><br><span class="line">&#123;&quot;id&quot;:5,&quot;title&quot;:&quot;华为 HUAWEI Mate20 X (5G) 7nm工艺5G旗舰芯片全面屏超大广角徕卡三摄8GB+256GB翡冷翠5G双模全网通手机&quot;,&quot;price&quot;:6199,&quot;intro&quot;:&quot;【5G双模，支持SA/NSA网络，7.2英寸全景巨屏，石墨烯液冷散热】5G先驱，极速体验。&quot;,&quot;brand&quot;:&quot;华为&quot;&#125;</span><br><span class="line">&#123;&quot;create&quot;:&#123;&quot;_id&quot;: 6&#125;&#125;</span><br><span class="line">&#123;&quot;id&quot;:6,&quot;title&quot;:&quot;华为平板 M6 10.8英寸麒麟980影音娱乐平板电脑4GB+64GB WiFi（香槟金）&quot;,&quot;price&quot;:2299,&quot;intro&quot;:&quot;【华为暑期购】8月2日-4日，M5青春版指定爆款型号优惠100元，AI语音控制&quot;,&quot;brand&quot;:&quot;华为&quot;&#125;</span><br><span class="line">&#123;&quot;create&quot;:&#123;&quot;_id&quot;: 7&#125;&#125;</span><br><span class="line">&#123;&quot;id&quot;:7,&quot;title&quot;:&quot;荣耀20 PRO DXOMARK全球第二高分 4800万四摄 双光学防抖 麒麟980 全网通4G 8GB+128GB 蓝水翡翠 拍照手机&quot;,&quot;price&quot;:3199,&quot;intro&quot;:&quot;白条6期免息！麒麟980，4800万全焦段AI四摄！荣耀20系列2699起，4800万超广角AI四摄！&quot;,&quot;brand&quot;:&quot;荣耀&quot;&#125;</span><br><span class="line">&#123;&quot;create&quot;:&#123;&quot;_id&quot;: 8&#125;&#125;</span><br><span class="line">&#123;&quot;id&quot;:8,&quot;title&quot;:&quot;荣耀MagicBook Pro 16.1英寸全面屏轻薄性能笔记本电脑（酷睿i7 8G 512G MX250 IPS FHD 指纹解锁）冰河银&quot;,&quot;price&quot;:6199,&quot;intro&quot;:&quot;16.1英寸无界全面屏金属轻薄本，100%sRGB色域，全高清IPS防眩光护眼屏，14小时长续航，指纹一健开机登录，魔法一碰传高速传输。&quot;,&quot;brand&quot;:&quot;荣耀&quot;&#125;</span><br><span class="line">&#123;&quot;create&quot;:&#123;&quot;_id&quot;: 9&#125;&#125;</span><br><span class="line">&#123;&quot;id&quot;:9,&quot;title&quot;:&quot;荣耀平板5 麒麟8核芯片 GT游戏加速 4G+128G 10.1英寸全高清屏影音平板电脑 WiFi版 冰川蓝&quot;,&quot;price&quot;:1549,&quot;intro&quot;:&quot;【爆款平板推荐】哈曼卡顿专业调音，10.1英寸全高清大屏，双喇叭立体环绕音，配置多重护眼，值得拥有！&quot;,&quot;brand&quot;:&quot;荣耀&quot;&#125;</span><br><span class="line">&#123;&quot;create&quot;:&#123;&quot;_id&quot;: 10&#125;&#125;</span><br><span class="line">&#123;&quot;id&quot;:10,&quot;title&quot;:&quot;小米9 4800万超广角三摄 6GB+128GB全息幻彩蓝 骁龙855 全网通4G 双卡双待 水滴全面屏拍照智能游戏手机&quot;,&quot;price&quot;:2799,&quot;intro&quot;:&quot;限时优惠200，成交价2799！索尼4800万广角微距三摄，屏下指纹解锁！&quot;,&quot;brand&quot;:&quot;小米&quot;&#125;</span><br><span class="line">&#123;&quot;create&quot;:&#123;&quot;_id&quot;: 11&#125;&#125;</span><br><span class="line">&#123;&quot;id&quot;:11,&quot;title&quot;:&quot;小米(MI)Pro 2019款 15.6英寸金属轻薄笔记本(第八代英特尔酷睿i7-8550U 16G 512GSSD MX250 2G独显) 深空灰&quot;,&quot;price&quot;:6899,&quot;intro&quot;:&quot;【PCIE固态硬盘、72%NTSC高色域全高清屏】B面康宁玻璃覆盖、16G双通道大内存、第八代酷睿I7处理器、专业级调校MX150&quot;,&quot;brand&quot;:&quot;小米&quot;&#125;</span><br><span class="line">&#123;&quot;create&quot;:&#123;&quot;_id&quot;: 12&#125;&#125;</span><br><span class="line">&#123;&quot;id&quot;:12,&quot;title&quot;:&quot;联想(Lenovo)拯救者Y7000P 2019英特尔酷睿i7 15.6英寸游戏笔记本电脑(i7 9750H 16G 1T SSD GTX1660Ti 144Hz)&quot;,&quot;price&quot;:9299,&quot;intro&quot;:&quot;超大1T固态，升级双通道16G内存一步到位，GTX1660Ti电竞级独显，英特尔9代i7H高性能处理器，144Hz电竞屏窄边框！&quot;,&quot;brand&quot;:&quot;联想&quot;&#125;</span><br></pre></td></tr></table></figure>

<p>Elasticsearch基于JSON提供完整的查询DSL（Domain Specific Language：领域特定语言）来定义查询。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">基本语法：</span><br><span class="line">GET /索引名/类型名/_search</span><br></pre></td></tr></table></figure>

<p>一般都是需要配合查询参数来使用的，配合不同的参数有不同的查询效果</p>
<p>参数配置项可以参考博客：<a target="_blank" rel="noopener" href="https://www.jianshu.com/p/6333940621ec">https://www.jianshu.com/p/6333940621ec</a></p>
<h3 id="结果排序"><a href="#结果排序" class="headerlink" title="结果排序"></a>结果排序</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">参数格式：</span><br><span class="line">&#123;</span><br><span class="line">  &quot;sort&quot;: [</span><br><span class="line">    &#123;field: 排序规则&#125;,</span><br><span class="line">    ...</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">排序</span><br><span class="line">GET /shop_product/shop_product/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;sort&quot;: [</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;price&quot;: &#123;</span><br><span class="line">        &quot;order&quot;: &quot;desc&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">排序规则：</span><br><span class="line">asc表示升序</span><br><span class="line">desc:表示降序</span><br><span class="line">没有配置排序的情况下，默认按照评分降序排列</span><br></pre></td></tr></table></figure>

<h3 id="分页查询"><a href="#分页查询" class="headerlink" title="分页查询"></a>分页查询</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">参数格式：</span><br><span class="line">&#123;</span><br><span class="line">  &quot;from&quot;: start,</span><br><span class="line">  &quot;size&quot;: pageSize</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">分页 从第几个开始 每页几个</span><br><span class="line">GET /shop_product/shop_product/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;from&quot;: 2,</span><br><span class="line">  &quot;size&quot;: 4,</span><br><span class="line">  &quot;sort&quot;: [</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;price&quot;: &#123;</span><br><span class="line">        &quot;order&quot;: &quot;desc&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">需求1：查询所有文档按照价格降序排列</span><br><span class="line">需求2：分页查询文档按照价格降序排列，显示第2页，每页显示3个</span><br></pre></td></tr></table></figure>

<h3 id="检索查询"><a href="#检索查询" class="headerlink" title="检索查询"></a>检索查询</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line">参数格式：</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    检索方式: &#123;field: value&#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">检索查询 全文检索</span><br><span class="line">需求1：查询商品标题中符合&quot;游戏 手机&quot;的字样的商品</span><br><span class="line">GET /shop_product/shop_product/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;match&quot;: &#123;</span><br><span class="line">      &quot;title&quot;: &quot;游戏 手机&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">检索查询 精准匹配</span><br><span class="line">需求2：查询商品价格等于15299的商品</span><br><span class="line">GET /shop_product/shop_product/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;term&quot;: &#123;</span><br><span class="line">      &quot;price&quot;: 15299</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">检索查询 范围检索</span><br><span class="line">需求3：查询商品价格在5000~10000之间商品，按照价格升序排列</span><br><span class="line">GET /shop_product/shop_product/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;range&quot;: &#123;</span><br><span class="line">      &quot;price&quot;: &#123;</span><br><span class="line">        &quot;gte&quot;: 5000,</span><br><span class="line">        &quot;lte&quot;: 10000</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;sort&quot;: [</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;price&quot;: &#123;</span><br><span class="line">        &quot;order&quot;: &quot;asc&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">检索方式：</span><br><span class="line">term表示精确匹配，value值不会被分词器拆分，按照倒排索引匹配</span><br><span class="line">match表示全文检索，value值会被分词器拆分，然后去倒排索引中匹配</span><br><span class="line">range表示范围检索，其value值是一个对象，如&#123; &quot;range&quot;: &#123;field: &#123;比较规则: value, ...&#125;&#125; &#125;</span><br><span class="line">  比较规则有gt / gte / lt / lte 等</span><br><span class="line">  </span><br><span class="line">注意：term和match都能用在数值和字符上，range用在数值上</span><br><span class="line"></span><br><span class="line">需求1：查询商品标题中符合&quot;游戏 手机&quot;的字样的商品</span><br><span class="line">需求2：查询商品价格等于15299的商品</span><br><span class="line">需求3：查询商品价格在5000~10000之间商品，按照价格升序排列</span><br></pre></td></tr></table></figure>

<h3 id="关键字查询"><a href="#关键字查询" class="headerlink" title="关键字查询"></a>关键字查询</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">参数格式：</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;multi_match&quot;: &#123;</span><br><span class="line">      &quot;query&quot;: value,</span><br><span class="line">      &quot;fields&quot;: [field1, field2, ...]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">关键字查询</span><br><span class="line">需求1：查询商品标题或简介中符合&quot;蓝牙 指纹 双卡&quot;的字样的商品</span><br><span class="line">GET /shop_product/shop_product/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;multi_match&quot;: &#123;</span><br><span class="line">      &quot;query&quot;: &quot;蓝牙 指纹 双卡&quot;,</span><br><span class="line">      &quot;fields&quot;: [&quot;title&quot;, &quot;intro&quot;]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">multi_match：表示在多个字段间做检索，只要其中一个字段满足条件就能查询出来，多用在字段上</span><br><span class="line"></span><br><span class="line">需求1：查询商品标题或简介中符合&quot;蓝牙 指纹 双卡&quot;的字样的商品</span><br></pre></td></tr></table></figure>

<h3 id="高亮显示"><a href="#高亮显示" class="headerlink" title="高亮显示"></a>高亮显示</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">参数格式：</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123; ... &#125;,</span><br><span class="line">  &quot;highlight&quot;: &#123;</span><br><span class="line">    &quot;fields&quot;: &#123;</span><br><span class="line">      field1: &#123;&#125;,</span><br><span class="line">      field2: &#123;&#125;,</span><br><span class="line">      ...</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;pre_tags&quot;: 开始标签,</span><br><span class="line">    &quot;post_tags&quot; 结束标签</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">高亮显示</span><br><span class="line">需求1：查询商品标题或简介中符合&quot;蓝牙 指纹 双卡&quot;的字样的商品，并且高亮显示</span><br><span class="line">GET /shop_product/shop_product/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;multi_match&quot;: &#123;</span><br><span class="line">      &quot;query&quot;: &quot;蓝牙 指纹 双卡&quot;,</span><br><span class="line">      &quot;fields&quot;: [&quot;title&quot;, &quot;intro&quot;]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;highlight&quot;: &#123;</span><br><span class="line">    &quot;fields&quot;: &#123;</span><br><span class="line">      &quot;title&quot;: &#123;&#125;,</span><br><span class="line">      &quot;intro&quot;: &#123;&#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;pre_tags&quot;:&quot;&lt;h1&gt;&quot;,</span><br><span class="line">    &quot;post_tags&quot;:&quot;&lt;/h1&gt;&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">highlight：表示高亮显示，需要在fields中配置哪些字段中检索到该内容需要高亮显示</span><br><span class="line">  必须配合检索(term / match)一起使用</span><br><span class="line">  </span><br><span class="line">需求1：查询商品标题或简介中符合&quot;蓝牙 指纹 双卡&quot;的字样的商品，并且高亮显示</span><br></pre></td></tr></table></figure>

<h3 id="逻辑查询"><a href="#逻辑查询" class="headerlink" title="逻辑查询"></a>逻辑查询</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line">参数格式： </span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;bool&quot;: &#123;</span><br><span class="line">      逻辑规则: [</span><br><span class="line">        &#123;检索方式: &#123;field: value&#125;&#125;, </span><br><span class="line">        ...</span><br><span class="line">      ],</span><br><span class="line">      ...</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">逻辑查询</span><br><span class="line">需求1：查询商品标题中符合&quot;i7&quot;的字样并且价格大于7000的商品</span><br><span class="line">GET /shop_product/shop_product/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;bool&quot;: &#123;</span><br><span class="line">      &quot;must&quot;: [</span><br><span class="line">        &#123;&quot;match&quot;: &#123;</span><br><span class="line">          &quot;title&quot;: &quot;i7&quot;</span><br><span class="line">        &#125;&#125;,</span><br><span class="line">        &#123;&quot;range&quot;: &#123;</span><br><span class="line">          &quot;price&quot;: &#123;</span><br><span class="line">            &quot;gt&quot;: 7000</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;&#125;</span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">逻辑查询</span><br><span class="line">需求2：查询商品标题中符合&quot;pro&quot;的字样或者价格在1000~3000的商品</span><br><span class="line">GET /shop_product/shop_product/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;bool&quot;: &#123;</span><br><span class="line">      &quot;should&quot;: [</span><br><span class="line">        &#123;&quot;match&quot;: &#123;</span><br><span class="line">          &quot;title&quot;: &quot;pro&quot;</span><br><span class="line">        &#125;&#125;,</span><br><span class="line">        &#123;&quot;range&quot;: &#123;</span><br><span class="line">          &quot;price&quot;: &#123;</span><br><span class="line">            &quot;gte&quot;: 1000,</span><br><span class="line">            &quot;lte&quot;: 3000</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;&#125;</span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">逻辑规则：must / should / must_not，相当于and / or / not</span><br><span class="line"></span><br><span class="line">需求1：查询商品标题中符合&quot;i7&quot;的字样并且价格大于7000的商品</span><br><span class="line">需求2：查询商品标题中符合&quot;pro&quot;的字样或者价格在1000~3000的商品</span><br></pre></td></tr></table></figure>

<h3 id="过滤查询"><a href="#过滤查询" class="headerlink" title="过滤查询"></a>过滤查询</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">参数格式：</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;bool&quot;: &#123;</span><br><span class="line">      &quot;filter&quot;: [</span><br><span class="line">        &#123; 检索方式: &#123; field: value &#125; &#125;，            	</span><br><span class="line">        ...</span><br><span class="line">      ]</span><br><span class="line">    &#125;             </span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">过滤查询 不评分</span><br><span class="line">GET /shop_product/shop_product/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;bool&quot;: &#123;</span><br><span class="line">      &quot;filter&quot;: [</span><br><span class="line">        &#123;&quot;match&quot;: &#123;</span><br><span class="line">          &quot;title&quot;: &quot;pro&quot;</span><br><span class="line">        &#125;&#125;</span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">从效果上讲过滤查询和检索查询能做一样的效果</span><br><span class="line">区别在于过滤查询不评分，结果能缓存，检索查询要评分，结果不缓存</span><br><span class="line">一般是不会直接使用过滤查询，都是在检索了一定数据的基础上再使用</span><br></pre></td></tr></table></figure>

<p>关于filter的更多认知推荐大家读这篇博客：<a target="_blank" rel="noopener" href="https://blog.csdn.net/laoyang360/article/details/80468757">https://blog.csdn.net/laoyang360/article/details/80468757</a></p>
<h3 id="分组查询"><a href="#分组查询" class="headerlink" title="分组查询"></a>分组查询</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><span class="line">参数格式：</span><br><span class="line">&#123;</span><br><span class="line">  &quot;size&quot;: 0,</span><br><span class="line">  &quot;aggs&quot;: &#123;</span><br><span class="line">    自定义分组字段: &#123;</span><br><span class="line">      &quot;terms&quot;: &#123;</span><br><span class="line">        &quot;field&quot;: 分组字段, </span><br><span class="line">        &quot;order&quot;: &#123;自定义统计字段:排序规则&#125;, </span><br><span class="line">        &quot;size&quot;: 10  //默认显示10组 </span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;aggs&quot;: &#123; //分组后的统计查询，相当于MySQL分组函数查询</span><br><span class="line">        自定义统计字段: &#123;</span><br><span class="line">          分组运算: &#123;</span><br><span class="line">            &quot;field&quot;: 统计字段</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;       </span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">分组查询</span><br><span class="line">需求1：按照品牌分组，统计各品牌的数量</span><br><span class="line">GET /shop_product/shop_product/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;size&quot;: 0,</span><br><span class="line">  &quot;aggs&quot;: &#123;</span><br><span class="line">    &quot;brand_group&quot;: &#123;</span><br><span class="line">      &quot;terms&quot;: &#123;</span><br><span class="line">        &quot;field&quot;: &quot;brand&quot;, </span><br><span class="line">        &quot;order&quot;: &#123;&quot;brand_group&quot;:&quot;desc&quot;&#125;, </span><br><span class="line">        &quot;size&quot;: 10  </span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;aggs&quot;: &#123; </span><br><span class="line">        &quot;brand_group&quot;: &#123;</span><br><span class="line">          &quot;value_count&quot;: &#123;</span><br><span class="line">            &quot;field&quot;: &quot;id&quot;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;       </span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">分组查询</span><br><span class="line">需求2：按照品牌分组，统计各品牌的平均价格</span><br><span class="line">GET /shop_product/shop_product/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;size&quot;: 0,</span><br><span class="line">  &quot;aggs&quot;: &#123;</span><br><span class="line">    &quot;brand_group&quot;: &#123;</span><br><span class="line">      &quot;terms&quot;: &#123;</span><br><span class="line">        &quot;field&quot;: &quot;brand&quot;, </span><br><span class="line">        &quot;order&quot;: &#123;&quot;brand_group&quot;:&quot;desc&quot;&#125;, </span><br><span class="line">        &quot;size&quot;: 10  </span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;aggs&quot;: &#123; </span><br><span class="line">        &quot;brand_group&quot;: &#123;</span><br><span class="line">          &quot;avg&quot;: &#123;</span><br><span class="line">            &quot;field&quot;: &quot;price&quot;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;       </span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">分组查询</span><br><span class="line">需求3：按照品牌分组，统计各品牌的价格数据</span><br><span class="line">GET /shop_product/shop_product/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;size&quot;: 0,</span><br><span class="line">  &quot;aggs&quot;: &#123;</span><br><span class="line">    &quot;brand_group_aggs&quot;: &#123;</span><br><span class="line">      &quot;terms&quot;: &#123;</span><br><span class="line">        &quot;field&quot;: &quot;brand&quot;, </span><br><span class="line">        &quot;order&quot;: &#123;&quot;brand_group_aggs.count&quot;:&quot;desc&quot;&#125;, </span><br><span class="line">        &quot;size&quot;: 10  </span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;aggs&quot;: &#123; </span><br><span class="line">        &quot;brand_group_aggs&quot;: &#123;</span><br><span class="line">          &quot;stats&quot;: &#123;</span><br><span class="line">            &quot;field&quot;: &quot;price&quot;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;       </span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">分组运算：avg / sum / min / max / value_count / stats(执行以上所有功能的)</span><br><span class="line">注意：这里是size=0其目的是为了不要显示hit内容，专注点放在观察分组上</span><br><span class="line"></span><br><span class="line">需求1：按照品牌分组，统计各品牌的数量</span><br><span class="line">需求2：按照品牌分组，统计各品牌的平均价格</span><br><span class="line">需求3：按照品牌分组，统计各品牌的价格数据</span><br></pre></td></tr></table></figure>

<h2 id="批处理（了解）"><a href="#批处理（了解）" class="headerlink" title="批处理（了解）"></a>批处理（了解）</h2><p>当需要集中的批量处理文档时，如果依然使用传统的操作单个API的方式，将会浪费大量网络资源，Elasticsearch为了提高操作的性能，专门提供了批处理的API</p>
<h3 id="mget批量查询"><a href="#mget批量查询" class="headerlink" title="mget批量查询"></a>mget批量查询</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">语法：</span><br><span class="line">GET /索引名/类型/_mget</span><br><span class="line">&#123;</span><br><span class="line">  &quot;docs&quot;: [</span><br><span class="line">    &#123;&quot;_id&quot;: 文档ID&#125;,</span><br><span class="line">    ...</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="bulk批量增删改"><a href="#bulk批量增删改" class="headerlink" title="bulk批量增删改"></a>bulk批量增删改</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">语法：</span><br><span class="line">POST /索引名/类型/_bulk</span><br><span class="line">&#123;动作:&#123;&quot;_id&quot;: 文档ID&#125;&#125;</span><br><span class="line">&#123;...&#125;</span><br><span class="line">&#123;动作:&#123;&quot;_id&quot;: 文档ID&#125;&#125;</span><br><span class="line">&#123;...&#125;</span><br><span class="line"></span><br><span class="line">动作：create / update / delete，其中delete只有1行JSON，其他操作都是有2行JSON，并且JSON不能格式化，如果是update动作，它的数据需要加个key为doc</span><br><span class="line">如：</span><br><span class="line">&#123;&quot;update&quot;: &#123;&quot;_id&quot;: xx&#125;&#125;</span><br><span class="line">&#123;&quot;doc&quot;: &#123;&quot;xx&quot;:xx, &quot;xx&quot;:xx&#125;&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Spring-Data-Elasticsearch"><a href="#Spring-Data-Elasticsearch" class="headerlink" title="Spring Data Elasticsearch"></a>Spring Data Elasticsearch</h2><h3 id="准备环境"><a href="#准备环境" class="headerlink" title="准备环境"></a>准备环境</h3><h4 id="导入依赖"><a href="#导入依赖" class="headerlink" title="导入依赖"></a>导入依赖</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">&lt;parent&gt;</span><br><span class="line">    &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;spring-boot-starter-parent&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;2.1.3.RELEASE&lt;/version&gt;</span><br><span class="line">&lt;/parent&gt;</span><br><span class="line"></span><br><span class="line">&lt;properties&gt;</span><br><span class="line">    &lt;java.version&gt;1.8&lt;/java.version&gt;</span><br><span class="line">&lt;/properties&gt;</span><br><span class="line"></span><br><span class="line">&lt;dependencies&gt;</span><br><span class="line">    &lt;dependency&gt;</span><br><span class="line">        &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">        &lt;artifactId&gt;spring-boot-starter&lt;/artifactId&gt;</span><br><span class="line">    &lt;/dependency&gt;</span><br><span class="line">    </span><br><span class="line">    &lt;!--SpringBoot整合Spring Data Elasticsearch的依赖--&gt;</span><br><span class="line">    &lt;dependency&gt;</span><br><span class="line">        &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">        &lt;artifactId&gt;spring-boot-starter-data-elasticsearch&lt;/artifactId&gt;</span><br><span class="line">    &lt;/dependency&gt;</span><br><span class="line">    &lt;dependency&gt;</span><br><span class="line">        &lt;groupId&gt;org.projectlombok&lt;/groupId&gt;</span><br><span class="line">        &lt;artifactId&gt;lombok&lt;/artifactId&gt;</span><br><span class="line">    &lt;/dependency&gt;</span><br><span class="line">    &lt;dependency&gt;</span><br><span class="line">        &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">        &lt;artifactId&gt;spring-boot-starter-test&lt;/artifactId&gt;</span><br><span class="line">        &lt;scope&gt;test&lt;/scope&gt;</span><br><span class="line">    &lt;/dependency&gt;</span><br><span class="line">    </span><br><span class="line">    &lt;dependency&gt;</span><br><span class="line">        &lt;groupId&gt;commons-beanutils&lt;/groupId&gt;</span><br><span class="line">        &lt;artifactId&gt;commons-beanutils&lt;/artifactId&gt;</span><br><span class="line">        &lt;version&gt;1.8.3&lt;/version&gt;</span><br><span class="line">    &lt;/dependency&gt;</span><br><span class="line">&lt;/dependencies&gt;</span><br><span class="line"></span><br><span class="line">&lt;build&gt;</span><br><span class="line">    &lt;plugins&gt;</span><br><span class="line">        &lt;plugin&gt;</span><br><span class="line">            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;spring-boot-maven-plugin&lt;/artifactId&gt;</span><br><span class="line">        &lt;/plugin&gt;</span><br><span class="line">    &lt;/plugins&gt;</span><br><span class="line">&lt;/build&gt;</span><br></pre></td></tr></table></figure>

<h4 id="编写DOMAIN"><a href="#编写DOMAIN" class="headerlink" title="编写DOMAIN"></a>编写DOMAIN</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line">  @Document：配置操作哪个索引下的哪个类型</span><br><span class="line">  @Id：标记文档ID字段</span><br><span class="line">  @Field：配置映射信息，如：分词器</span><br><span class="line"> */</span><br><span class="line">@Getter@Setter@ToString</span><br><span class="line">@NoArgsConstructor</span><br><span class="line">@AllArgsConstructor</span><br><span class="line">@Document(indexName=&quot;shop_product&quot;, type=&quot;shop_product&quot;)</span><br><span class="line">public class Product &#123;</span><br><span class="line">    @Id</span><br><span class="line">    private String id;</span><br><span class="line"></span><br><span class="line">    @Field(analyzer=&quot;ik_max_word&quot;,searchAnalyzer=&quot;ik_max_word&quot;, type=FieldType.Text)</span><br><span class="line">    private String title;</span><br><span class="line"></span><br><span class="line">    private Integer price;</span><br><span class="line"></span><br><span class="line">    @Field(analyzer=&quot;ik_max_word&quot;,searchAnalyzer=&quot;ik_max_word&quot;, type=FieldType.Text)</span><br><span class="line">    private String intro;</span><br><span class="line"></span><br><span class="line">    @Field(type=FieldType.Keyword)</span><br><span class="line">    private String brand;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="配置连接信息"><a href="#配置连接信息" class="headerlink" title="配置连接信息"></a>配置连接信息</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">#application.properties</span><br><span class="line"># 配置集群名称，名称写错会连不上服务器，默认elasticsearch</span><br><span class="line">spring.data.elasticsearch.cluster-name=elasticsearch</span><br><span class="line"># 配置集群节点</span><br><span class="line">spring.data.elasticsearch.cluster-nodes=localhost:9300</span><br></pre></td></tr></table></figure>

<h3 id="ElasticsearchRepository"><a href="#ElasticsearchRepository" class="headerlink" title="ElasticsearchRepository"></a>ElasticsearchRepository</h3><p>该接口是框架封装的用于操作Elastsearch的高级接口，只要我们自己的写个接口去继承该接口就能直接对Elasticsearch进行CRUD操作</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line">  泛型1：domain的类型</span><br><span class="line">  泛型2：文档主键类型</span><br><span class="line">  该接口直接该给Spring，底层会使用JDK代理的方式创建对象，交给容器管理</span><br><span class="line"> */</span><br><span class="line">@Repository</span><br><span class="line">public interface ProductESRepository extends ElasticsearchRepository&lt;Product, String&gt; &#123;</span><br><span class="line">    // 符合Spring Data规范的高级查询方法</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="完成CRUD-分页-排序"><a href="#完成CRUD-分页-排序" class="headerlink" title="完成CRUD+分页+排序"></a>完成CRUD+分页+排序</h3><h3 id="组件介绍"><a href="#组件介绍" class="headerlink" title="组件介绍"></a>组件介绍</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">ElasticsearchRepository：框架封装的用于便捷完成常用操作的工具接口</span><br><span class="line">ElasticsearchTemplate：框架封装的用于便捷操作Elasticsearch的模板类</span><br><span class="line"></span><br><span class="line">NativeSearchQueryBuilder：用于生成查询条件的构建器，需要去封装各种查询条件</span><br><span class="line">QueryBuilder：该接口表示一个查询条件，其对象可以通过QueryBuilders工具类中的方法快速生成各种条件</span><br><span class="line">  boolQuery()：生成bool条件，相当于 &quot;bool&quot;: &#123; &#125;</span><br><span class="line">  matchQuery()：生成match条件，相当于 &quot;match&quot;: &#123; &#125;</span><br><span class="line">  rangeQuery()：生成range条件，相当于 &quot;range&quot;: &#123; &#125;</span><br><span class="line">AbstractAggregationBuilder：用于生成分组查询的构建器，其对象通过AggregationBuilders工具类生成</span><br><span class="line">Pageable：表示分页参数，对象通过PageRequest.of(页数, 容量)获取</span><br><span class="line">SortBuilder：排序构建器，对象通过SortBuilders.fieldSort(字段).order(规则)获取</span><br></pre></td></tr></table></figure>

<h3 id="ElasticsearchTemplate"><a href="#ElasticsearchTemplate" class="headerlink" title="ElasticsearchTemplate"></a>ElasticsearchTemplate</h3><p>该模板类，封装了便捷操作Elasticsearch的模板方法，包括 索引 &#x2F; 映射 &#x2F; CRUD 等底层操作和高级操作，该对象用起来会略微复杂些，尤其是对于查询，还需要把查询到的结果自己封装对象</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">//该对象已经由SpringBoot完成自动配置，直接注入即可</span><br><span class="line">@Autowired</span><br><span class="line">private ElasticsearchTemplate template;</span><br></pre></td></tr></table></figure>

<p>一般情况下，ElasticsearchTemplate和ElasticsearchRepository是分工合作的，ElasticsearchRepository已经能完成绝大部分的功能，如果遇到复杂的查询则要使用ElasticsearchTemplate，如多字段分组、高亮显示等</p>
<h3 id="实例代码"><a href="#实例代码" class="headerlink" title="实例代码"></a>实例代码</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br></pre></td><td class="code"><pre><span class="line">@Autowired</span><br><span class="line">private ElasticsearchTemplate template;</span><br><span class="line"></span><br><span class="line">@Autowired</span><br><span class="line">private ProductESRepository repository;</span><br><span class="line"></span><br><span class="line">// 新增或者覆盖一个文档</span><br><span class="line">@Test</span><br><span class="line">public void testSaveOrUpdate() throws Exception &#123;</span><br><span class="line">    // 索引库中不存在则新增，存在则覆盖</span><br><span class="line">    Product p = new Product(&quot;13&quot;, &quot;华为手环 B5（Android 运动手环）&quot;, 999,</span><br><span class="line">                            &quot;高清彩屏 腕上蓝牙耳机 心率检测 来电消息提醒&quot;, &quot;华为&quot;);</span><br><span class="line">    repostitory.save(p);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 删除一个文档</span><br><span class="line">@Test</span><br><span class="line">public void testDelete() throws Exception &#123;</span><br><span class="line">    repostitory.deleteById(&quot;13&quot;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 根据ID查询一个文档</span><br><span class="line">@Test</span><br><span class="line">public void testGet() throws Exception &#123;</span><br><span class="line">    Optional&lt;Product&gt; optional = repostitory.findById(&quot;1&quot;);</span><br><span class="line">    optional.ifPresent(System.out::println);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 查询所有文档</span><br><span class="line">@Test</span><br><span class="line">public void testList() throws Exception &#123;</span><br><span class="line">    Iterable&lt;Product&gt; iter = repostitory.findAll();</span><br><span class="line">    iter.forEach(System.out::println);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 分页查询文档按照价格降序排列，显示第2页，每页显示3个</span><br><span class="line">@Test</span><br><span class="line">public void testQuery1() throws Exception &#123;</span><br><span class="line">    NativeSearchQueryBuilder builder = new NativeSearchQueryBuilder();</span><br><span class="line">    // 设置分页信息</span><br><span class="line">    builder.withPageable(PageRequest.of(1, 3));</span><br><span class="line">    // 设置排序信息</span><br><span class="line">    builder.withSort(SortBuilders.fieldSort(&quot;price&quot;).order(SortOrder.DESC));</span><br><span class="line"></span><br><span class="line">    Page&lt;Product&gt; page = repostitory.search(builder.build());</span><br><span class="line">    System.out.println(page.getTotalElements()); //总记录数</span><br><span class="line">    System.out.println(page.getTotalPages()); //总页数</span><br><span class="line">    page.forEach(System.out::println);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 查询商品标题中符合&quot;游戏 手机&quot;的字样的商品</span><br><span class="line">@Test</span><br><span class="line">public void testQuery2() throws Exception &#123;</span><br><span class="line">    NativeSearchQueryBuilder builder = new NativeSearchQueryBuilder();</span><br><span class="line">    builder.withQuery(</span><br><span class="line">        QueryBuilders.matchQuery(&quot;title&quot;, &quot;游戏 手机&quot;)</span><br><span class="line">    );</span><br><span class="line">    Page&lt;Product&gt; page = repostitory.search(builder.build());</span><br><span class="line">    page.forEach(System.out::println);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 查询商品价格等于15299的商品</span><br><span class="line">@Test</span><br><span class="line">public void testQuery3() throws Exception &#123;</span><br><span class="line">    NativeSearchQueryBuilder builder = new NativeSearchQueryBuilder();</span><br><span class="line">    builder.withQuery(</span><br><span class="line">        QueryBuilders.termQuery(&quot;price&quot;, 15299)</span><br><span class="line">    );</span><br><span class="line">    Page&lt;Product&gt; page = repostitory.search(builder.build());</span><br><span class="line">    page.forEach(System.out::println);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 查询商品价格在5000~9000之间商品，按照价格升序排列</span><br><span class="line">@Test</span><br><span class="line">public void testQuery4() throws Exception &#123;</span><br><span class="line">    NativeSearchQueryBuilder builder = new NativeSearchQueryBuilder();</span><br><span class="line">    builder.withQuery(</span><br><span class="line">        QueryBuilders.rangeQuery(&quot;price&quot;)</span><br><span class="line">            .gte(5000).lte(9000)</span><br><span class="line">    );</span><br><span class="line">    builder.withSort(SortBuilders.fieldSort(&quot;price&quot;).order(SortOrder.ASC));</span><br><span class="line">    Page&lt;Product&gt; page = repostitory.search(builder.build());</span><br><span class="line">    page.forEach(System.out::println);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 查询商品标题或简介中符合&quot;蓝牙 指纹 双卡&quot;的字样的商品</span><br><span class="line">@Test</span><br><span class="line">public void testQuery5() throws Exception &#123;</span><br><span class="line">    NativeSearchQueryBuilder builder = new NativeSearchQueryBuilder();</span><br><span class="line">    builder.withQuery(</span><br><span class="line">        QueryBuilders.multiMatchQuery(&quot;蓝牙 指纹 双卡&quot;,</span><br><span class="line">                                      &quot;title&quot;, &quot;intro&quot;)</span><br><span class="line">    );</span><br><span class="line">    Page&lt;Product&gt; page = repostitory.search(builder.build());</span><br><span class="line">    page.forEach(System.out::println);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 查询商品标题中符合&quot;i7&quot;的字样并且价格大于7000的商品</span><br><span class="line">@Test</span><br><span class="line">public void testQuery6() throws Exception &#123;</span><br><span class="line">    NativeSearchQueryBuilder builder = new NativeSearchQueryBuilder();</span><br><span class="line">    builder.withQuery(</span><br><span class="line">        QueryBuilders.boolQuery()</span><br><span class="line">        .must(QueryBuilders.matchQuery(&quot;title&quot;, &quot;i7&quot;))</span><br><span class="line">        .must(QueryBuilders.rangeQuery(&quot;price&quot;).gt(7000))</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    Page&lt;Product&gt; page = repostitory.search(builder.build());</span><br><span class="line">    page.forEach(System.out::println);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 查询商品标题中符合&quot;pro&quot;的字样或者价格在1000~3000的商品</span><br><span class="line">@Test</span><br><span class="line">public void testQuery7() throws Exception &#123;</span><br><span class="line">    NativeSearchQueryBuilder builder = new NativeSearchQueryBuilder();</span><br><span class="line">    builder.withQuery(</span><br><span class="line">        QueryBuilders.boolQuery()</span><br><span class="line">            .should(QueryBuilders.matchQuery(&quot;title&quot;, &quot;pro&quot;))</span><br><span class="line">            .should(QueryBuilders.rangeQuery(&quot;price&quot;).gte(1000).lte(3000))</span><br><span class="line">    );</span><br><span class="line">    Page&lt;Product&gt; page = repostitory.search(builder.build());</span><br><span class="line">    page.forEach(System.out::println);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 按照品牌分组，统计各品牌的数量</span><br><span class="line">@Test</span><br><span class="line">public void testQuery8() throws Exception &#123;</span><br><span class="line">    NativeSearchQueryBuilder builder = new NativeSearchQueryBuilder();</span><br><span class="line">    builder.addAggregation(</span><br><span class="line">        AggregationBuilders.terms(&quot;groupByBrand&quot;).field(&quot;brand&quot;)</span><br><span class="line">    );</span><br><span class="line">    AggregatedPage&lt;Product&gt; page = (AggregatedPage&lt;Product&gt;) repostitory.search(builder.build());</span><br><span class="line">    // 获取自定义的分组字段</span><br><span class="line">    StringTerms brand = (StringTerms) page.getAggregation(&quot;groupByBrand&quot;);</span><br><span class="line">    brand.getBuckets().forEach(bucket -&gt; System.out.println(bucket.getDocCount()));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 按照品牌分组，统计各品牌的平均价格</span><br><span class="line">@Test</span><br><span class="line">public void testQuery9() throws Exception &#123;</span><br><span class="line">    NativeSearchQueryBuilder builder = new NativeSearchQueryBuilder();</span><br><span class="line">    builder.addAggregation(</span><br><span class="line">        AggregationBuilders.terms(&quot;groupByBrand&quot;).field(&quot;brand&quot;)</span><br><span class="line">        .subAggregation(AggregationBuilders.avg(&quot;avgPrice&quot;).field(&quot;price&quot;))</span><br><span class="line">    );</span><br><span class="line">    AggregatedPage&lt;Product&gt; page = (AggregatedPage&lt;Product&gt;) repostitory.search(builder.build());</span><br><span class="line">    // 获取自定义的分组字段</span><br><span class="line">    StringTerms brand = (StringTerms) page.getAggregation(&quot;groupByBrand&quot;);</span><br><span class="line">    brand.getBuckets().forEach(bucket -&gt; &#123;</span><br><span class="line">        InternalAvg avgPrice = bucket.getAggregations().get(&quot;avgPrice&quot;);</span><br><span class="line">        System.out.println(avgPrice.getValue());</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 按照品牌分组，统计各品牌的价格数据</span><br><span class="line">@Test</span><br><span class="line">public void testQuery10() throws Exception &#123;</span><br><span class="line">    NativeSearchQueryBuilder builder = new NativeSearchQueryBuilder();</span><br><span class="line">    builder.addAggregation(</span><br><span class="line">        AggregationBuilders.terms(&quot;groupByBrand&quot;).field(&quot;brand&quot;)</span><br><span class="line">        .subAggregation(AggregationBuilders.stats(&quot;statsPrice&quot;).field(&quot;price&quot;))</span><br><span class="line">    );</span><br><span class="line">    AggregatedPage&lt;Product&gt; page = (AggregatedPage&lt;Product&gt;) repostitory.search(builder.build());</span><br><span class="line">    // 获取自定义的分组字段</span><br><span class="line">    StringTerms brand = (StringTerms) page.getAggregation(&quot;groupByBrand&quot;);</span><br><span class="line">    brand.getBuckets().forEach(bucket -&gt; &#123;</span><br><span class="line">        InternalStats statsPrice = bucket.getAggregations().get(&quot;statsPrice&quot;);</span><br><span class="line">        System.out.println(statsPrice.getSumAsString());</span><br><span class="line">        System.out.println(statsPrice.getAvgAsString());</span><br><span class="line">        System.out.println(statsPrice.getMaxAsString());</span><br><span class="line">        System.out.println(statsPrice.getMinAsString());</span><br><span class="line">        System.out.println(statsPrice.getCount());</span><br><span class="line">        System.out.println(&quot;-----------------------&quot;);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 查询商品标题或简介中符合&quot;蓝牙 指纹 双卡&quot;的字样的商品，并且高亮显示</span><br><span class="line">@Test</span><br><span class="line">public void testHighlight() throws Exception &#123;</span><br><span class="line">    // Java与JSON互转的工具对象</span><br><span class="line">    ObjectMapper mapper = new ObjectMapper();</span><br><span class="line"></span><br><span class="line">    NativeSearchQueryBuilder builder = new NativeSearchQueryBuilder();</span><br><span class="line">    // 设置查询哪个索引中的哪个类型</span><br><span class="line">    builder.withIndices(&quot;shop_product&quot;).withTypes(&quot;shop_product&quot;);</span><br><span class="line">    builder.withQuery(</span><br><span class="line">        QueryBuilders.multiMatchQuery(&quot;蓝牙 指纹 双卡&quot;,</span><br><span class="line">                                      &quot;title&quot;, &quot;intro&quot;)</span><br><span class="line">    );</span><br><span class="line">    builder.withHighlightFields(</span><br><span class="line">        new HighlightBuilder.Field(&quot;title&quot;)</span><br><span class="line">            .preTags(&quot;&lt;span style=&#x27;color:red&#x27;&gt;&quot;).postTags(&quot;&lt;/span&gt;&quot;),</span><br><span class="line">        new HighlightBuilder.Field(&quot;intro&quot;)</span><br><span class="line">            .preTags(&quot;&lt;span style=&#x27;color:red&#x27;&gt;&quot;).postTags(&quot;&lt;/span&gt;&quot;)</span><br><span class="line">    );</span><br><span class="line">    AggregatedPage&lt;Product&gt; page = template.queryForPage(builder.build(), Product.class, new SearchResultMapper() &#123;</span><br><span class="line">        public &lt;T&gt; AggregatedPage&lt;T&gt; mapResults(SearchResponse resp, Class&lt;T&gt; clazz, Pageable pageable) &#123;</span><br><span class="line">            List&lt;T&gt; list = new ArrayList&lt;&gt;();</span><br><span class="line">            try &#123;</span><br><span class="line">                for (SearchHit hit : resp.getHits().getHits()) &#123;</span><br><span class="line">                    // 把查询到的JSON字符串转换成Java对象</span><br><span class="line">                    T t = mapper.readValue(hit.getSourceAsString(), clazz);</span><br><span class="line">                    for (HighlightField field : hit.getHighlightFields().values()) &#123;</span><br><span class="line">                        // 替换需要高亮显示的字段，用到Apache的BeanUtils工具</span><br><span class="line">                        BeanUtils.setProperty(t, field.getName(), field.getFragments()[0].string());</span><br><span class="line">                    &#125;</span><br><span class="line">                    list.add(t);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; catch (Exception e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">                return null;</span><br><span class="line">            &#125;</span><br><span class="line">            long total = resp.getHits().totalHits;</span><br><span class="line">            return new AggregatedPageImpl&lt;&gt;(list, pageable, total);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    page.forEach(System.out::println);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="springboot2-3-x以上配置"><a href="#springboot2-3-x以上配置" class="headerlink" title="springboot2.3.x以上配置"></a>springboot2.3.x以上配置</h3><blockquote>
<p><a target="_blank" rel="noopener" href="https://docs.spring.io/spring-data/elasticsearch/docs/4.0.1.RELEASE/reference/html/#new-features">配置关系对应</a></p>
<p><img src="https://images-jsh.oss-cn-beijing.aliyuncs.com/img/%E6%88%AA%E5%B1%8F2021-08-14%2014.17.14.png" alt="截屏2021-08-14 14.17.14"></p>
</blockquote>
<ol>
<li><p>pom相同</p>
</li>
<li><p>配置</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">## 旧版本以spring.data.elasticsearch.开头;访问地址配置不用声明访问协议,监听es的tcp端口</span><br><span class="line">#spring.data.elasticsearch.cluster-nodes=localhost:9300</span><br><span class="line">#spring.data.elasticsearch.cluster-name=elasticsearch</span><br><span class="line"></span><br><span class="line">## 新版本以spring.elasticsearch.rest.开头;访问地址配置需要声明访问协议,直接监听es访问端口</span><br><span class="line">spring.elasticsearch.rest.uris=http://localhost:9200</span><br><span class="line">spring.elasticsearch.rest.username=elasticsearch</span><br></pre></td></tr></table></figure>
</li>
<li><p>使用</p>
<ul>
<li><p>旧版的核心访问对象是ElasticsearchTemplate；新版的核心访问对象是ElasticsearchRestTemplate；</p>
</li>
<li><p>实体类没有类型</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">// @Document指定当前类是索引对象。indexName:索引名称;shards:创建索引时的分片数;replicas:创建索引时的备份数</span><br><span class="line">@Document(indexName = &quot;book_&quot;, shards = 5, replicas = 1)</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
</ol>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2022/12/27/Elasticsearch/" data-id="clc5wl9l0001feol6cgi5ceuz" data-title="Elasticsearch学习" class="article-share-link">Share</a>
      
      
      
    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2022/12/27/Elasticsearch7%E9%85%8D%E7%BD%AE%E8%AF%81%E4%B9%A6/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          ELASTICSEARCH7.X安全性之访问密码设置
        
      </div>
    </a>
  
  
    <a href="/2022/12/27/docker%E7%AE%80%E5%8D%95%E9%83%A8%E7%BD%B2rocketMQ/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">docker简单部署rocketMQ</div>
    </a>
  
</nav>

  
</article>


</section>
        
          <aside id="sidebar">
  
    

  
    

  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/12/">December 2022</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2022/12/27/%E4%B8%BB%E4%BB%8E%E5%90%8C%E6%AD%A5%E5%BC%82%E5%B8%B8%E8%AE%B0%E5%BD%95/">主从同步遇到 Got fatal error 1236 from master when reading data from binary log</a>
          </li>
        
          <li>
            <a href="/2022/12/27/%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E9%83%A8%E7%BD%B2%E5%AE%9D%E5%A1%94/">云服务器部署宝塔面板</a>
          </li>
        
          <li>
            <a href="/2022/12/27/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%8B%86%E5%88%86%E7%BB%86%E5%88%99/">微服务拆分细则</a>
          </li>
        
          <li>
            <a href="/2022/12/27/%E8%85%BE%E8%AE%AF%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8liux%E7%B3%BB%E7%BB%9F%E4%B8%8B%E6%97%A0%E6%B3%95%E9%80%9A%E8%BF%87springBoot%E5%86%85%E7%BD%AEmail%E5%8F%91%E9%80%81%E9%82%AE%E4%BB%B6%E7%9A%84%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88/">腾讯云服务器liux系统下无法通过springBoot内置mail发送邮件的解决方案</a>
          </li>
        
          <li>
            <a href="/2022/12/27/%E4%BD%BF%E7%94%A8docker%E6%90%AD%E5%BB%BA%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83%E8%AE%B0%E5%BD%95/">使用docker搭建开发环境记录</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      
      &copy; 2022 John Doe<br>
      Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    


<script src="/js/jquery-3.4.1.min.js"></script>



  
<script src="/fancybox/jquery.fancybox.min.js"></script>




<script src="/js/script.js"></script>





  </div>
</body>
</html>