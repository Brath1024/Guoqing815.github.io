<!doctype html>
<html lang="zh"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta><title>【Seata】来自阿里开源分布式事务框架-Seata的原理 - Brath-Blog</title><link rel="manifest" href="/manifest.json"><meta name="application-name" content="Brath-Blog"><meta name="msapplication-TileImage" content="https://brath.cloud/avatar.png"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="Brath-Blog"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta name="description" content="# 【Seata】来自阿里开源分布式事务框架 - Seata 的原理 首先  Seata  客户端启动一般分为以下几个流程：  自动加载 Bean 属性和配置信息 初始化 TM 初始化 RM 初始化分布式事务客户端完成，完成代理数据库配置 连接 TC (Seata 服务端)，注册 RM 和 TM 开启全局事务  在这篇源码的讲解中，我们主要以 AT 模式为主导，官网也是主推 AT 模式，我们在上"><meta property="og:type" content="blog"><meta property="og:title" content="【Seata】来自阿里开源分布式事务框架-Seata的原理"><meta property="og:url" content="http://example.com/2023/05/23/%E3%80%90Seata%E3%80%91%E6%9D%A5%E8%87%AA%E9%98%BF%E9%87%8C%E5%BC%80%E6%BA%90%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1%E6%A1%86%E6%9E%B6-Seata%E7%9A%84%E5%8E%9F%E7%90%86/"><meta property="og:site_name" content="Brath-Blog"><meta property="og:description" content="# 【Seata】来自阿里开源分布式事务框架 - Seata 的原理 首先  Seata  客户端启动一般分为以下几个流程：  自动加载 Bean 属性和配置信息 初始化 TM 初始化 RM 初始化分布式事务客户端完成，完成代理数据库配置 连接 TC (Seata 服务端)，注册 RM 和 TM 开启全局事务  在这篇源码的讲解中，我们主要以 AT 模式为主导，官网也是主推 AT 模式，我们在上"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/%E6%89%AB%E7%A0%81_%E6%90%9C%E7%B4%A2%E8%81%94%E5%90%88%E4%BC%A0%E6%92%AD%E6%A0%B7%E5%BC%8F-%E6%A0%87%E5%87%86%E8%89%B2%E7%89%88.png"><meta property="og:image" content="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/6b4a6708a964d51d954cec9fb660b72f.png"><meta property="og:image" content="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/bdca1226de54c44b76fbcb81ad5203ec.png"><meta property="og:image" content="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/23af43bca4492008ae3b80c10bd77c4f.png"><meta property="og:image" content="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/0f9703310464018bedfecc661d4c4e91.png"><meta property="og:image" content="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/45838801f4caeefec5623a955be68146.png"><meta property="og:image" content="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/58f1038f3648c3d95be79c183eb151b6.png"><meta property="og:image" content="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/78c4564099e2c372a310458314d545e9.png"><meta property="og:image" content="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/ef54a9c5142d96cf230b7938f60a9145.png"><meta property="og:image" content="https://img-blog.csdnimg.cn/img_convert/f16ce360addfb4ffbc43b040f0493fc5.png"><meta property="og:image" content="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/f16af649be708d3642cf86a1c451fcf7.png"><meta property="og:image" content="https://img-blog.csdnimg.cn/img_convert/cc94f7cbd5363484c839ed9e69b95c5d.png"><meta property="og:image" content="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/4dd908fc36e0128e646e3c8c0b03262a.png"><meta property="og:image" content="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/5649458fda2717fb7c87a5d8d0df2741.png"><meta property="og:image" content="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/6ef22513cae0ad8f2861cf18ec4cde0c.png"><meta property="og:image" content="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/c33801b28bbae2a960f6b14856d4e8cf.png"><meta property="og:image" content="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/e615279306d5aaf9ad85b8e2f9905a35.png"><meta property="og:image" content="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/%E4%BA%8C%E7%BB%B4%E7%A0%81plus.png"><meta property="article:published_time" content="2023-05-23T02:04:23.000Z"><meta property="article:modified_time" content="2023-06-05T07:31:10.671Z"><meta property="article:author" content="Brath"><meta property="twitter:card" content="summary"><meta property="twitter:image:src" content="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/%E6%89%AB%E7%A0%81_%E6%90%9C%E7%B4%A2%E8%81%94%E5%90%88%E4%BC%A0%E6%92%AD%E6%A0%B7%E5%BC%8F-%E6%A0%87%E5%87%86%E8%89%B2%E7%89%88.png"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"http://example.com/2023/05/23/%E3%80%90Seata%E3%80%91%E6%9D%A5%E8%87%AA%E9%98%BF%E9%87%8C%E5%BC%80%E6%BA%90%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1%E6%A1%86%E6%9E%B6-Seata%E7%9A%84%E5%8E%9F%E7%90%86/"},"headline":"【Seata】来自阿里开源分布式事务框架-Seata的原理","image":["https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/%E6%89%AB%E7%A0%81_%E6%90%9C%E7%B4%A2%E8%81%94%E5%90%88%E4%BC%A0%E6%92%AD%E6%A0%B7%E5%BC%8F-%E6%A0%87%E5%87%86%E8%89%B2%E7%89%88.png","https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/6b4a6708a964d51d954cec9fb660b72f.png","https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/bdca1226de54c44b76fbcb81ad5203ec.png","https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/23af43bca4492008ae3b80c10bd77c4f.png","https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/0f9703310464018bedfecc661d4c4e91.png","https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/45838801f4caeefec5623a955be68146.png","https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/58f1038f3648c3d95be79c183eb151b6.png","https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/78c4564099e2c372a310458314d545e9.png","https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/ef54a9c5142d96cf230b7938f60a9145.png","https://img-blog.csdnimg.cn/img_convert/f16ce360addfb4ffbc43b040f0493fc5.png","https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/f16af649be708d3642cf86a1c451fcf7.png","https://img-blog.csdnimg.cn/img_convert/cc94f7cbd5363484c839ed9e69b95c5d.png","https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/4dd908fc36e0128e646e3c8c0b03262a.png","https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/5649458fda2717fb7c87a5d8d0df2741.png","https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/6ef22513cae0ad8f2861cf18ec4cde0c.png","https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/c33801b28bbae2a960f6b14856d4e8cf.png","https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/e615279306d5aaf9ad85b8e2f9905a35.png","https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/%E4%BA%8C%E7%BB%B4%E7%A0%81plus.png"],"datePublished":"2023-05-23T02:04:23.000Z","dateModified":"2023-06-05T07:31:10.671Z","author":{"@type":"Person","name":"Brath"},"publisher":{"@type":"Organization","name":"Brath-Blog","logo":{"@type":"ImageObject","url":"https://brath.cloud/avatar.png"}},"description":"# 【Seata】来自阿里开源分布式事务框架 - Seata 的原理 首先  Seata  客户端启动一般分为以下几个流程：  自动加载 Bean 属性和配置信息 初始化 TM 初始化 RM 初始化分布式事务客户端完成，完成代理数据库配置 连接 TC (Seata 服务端)，注册 RM 和 TM 开启全局事务  在这篇源码的讲解中，我们主要以 AT 模式为主导，官网也是主推 AT 模式，我们在上"}</script><link rel="canonical" href="http://example.com/2023/05/23/%E3%80%90Seata%E3%80%91%E6%9D%A5%E8%87%AA%E9%98%BF%E9%87%8C%E5%BC%80%E6%BA%90%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1%E6%A1%86%E6%9E%B6-Seata%E7%9A%84%E5%8E%9F%E7%90%86/"><link rel="icon" href="https://brath.cloud/avatar.png"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v6.0.0/css/all.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/atom-one-light.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><!--!--><!--!--><script src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" defer></script><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/css/justifiedGallery.min.css"><!--!--><!--!--><style>.pace{-webkit-pointer-events:none;pointer-events:none;-webkit-user-select:none;-moz-user-select:none;user-select:none}.pace-inactive{display:none}.pace .pace-progress{background:#3273dc;position:fixed;z-index:2000;top:0;right:100%;width:100%;height:2px}</style><script src="https://cdn.jsdelivr.net/npm/pace-js@1.2.4/pace.min.js"></script><!--!--><!--!--><!-- hexo injector head_end start --><script>
  (function () {
      function switchTab() {
          if (!location.hash) {
            return;
          }

          const id = '#' + CSS.escape(location.hash.substring(1));
          const $tabMenu = document.querySelector(`.tabs a[href="${id}"]`);
          if (!$tabMenu) {
            return;
          }

          const $tabMenuContainer = $tabMenu.parentElement.parentElement;
          Array.from($tabMenuContainer.children).forEach($menu => $menu.classList.remove('is-active'));
          Array.from($tabMenuContainer.querySelectorAll('a'))
              .map($menu => document.getElementById($menu.getAttribute("href").substring(1)))
              .forEach($content => $content.classList.add('is-hidden'));

          if ($tabMenu) {
              $tabMenu.parentElement.classList.add('is-active');
          }
          const $activeTab = document.querySelector(id);
          if ($activeTab) {
              $activeTab.classList.remove('is-hidden');
          }
      }
      switchTab();
      window.addEventListener('hashchange', switchTab, false);
  })();
  </script><!-- hexo injector head_end end --><meta name="generator" content="Hexo 6.3.0"></head><body class="is-3-column"><nav class="navbar navbar-main"><div class="container navbar-container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="https://brath.cloud/avatar.png" alt="Brath-Blog" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">主页</a><a class="navbar-item" href="/archives">文章列表</a><a class="navbar-item" href="/tags">标签</a><a class="navbar-item" href="/about">更多</a></div><div class="navbar-end"><a class="navbar-item" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/Guoqing815"><i class="fab fa-github"></i></a><a class="navbar-item search" title="搜索" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-6-widescreen"><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2023-05-23T02:04:23.000Z" title="2023/5/23 10:04:23">2023-05-23</time>发表</span><span class="level-item"><time dateTime="2023-06-05T07:31:10.671Z" title="2023/6/5 15:31:10">2023-06-05</time>更新</span><span class="level-item">1 小时读完 (大约8834个字)</span><span class="level-item" id="busuanzi_container_page_pv"><span id="busuanzi_value_page_pv">0</span>次访问</span></div></div><h1 class="title is-3 is-size-4-mobile">【Seata】来自阿里开源分布式事务框架-Seata的原理</h1><div class="content"><p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/%E6%89%AB%E7%A0%81_%E6%90%9C%E7%B4%A2%E8%81%94%E5%90%88%E4%BC%A0%E6%92%AD%E6%A0%B7%E5%BC%8F-%E6%A0%87%E5%87%86%E8%89%B2%E7%89%88.png" alt="InterviewCoder"></p>
<h1 id="seata来自阿里开源分布式事务框架-seata的原理"><a class="markdownIt-Anchor" href="#seata来自阿里开源分布式事务框架-seata的原理">#</a> 【Seata】来自阿里开源分布式事务框架 - Seata 的原理</h1>
<p>首先  <code>Seata</code>  客户端启动一般分为以下几个流程：</p>
<ol>
<li>自动加载 Bean 属性和配置信息</li>
<li>初始化 TM</li>
<li>初始化 RM</li>
<li>初始化分布式事务客户端完成，完成代理数据库配置</li>
<li>连接 TC (Seata 服务端)，注册 RM 和 TM</li>
<li>开启全局事务</li>
</ol>
<p>在这篇源码的讲解中，我们主要以 AT 模式为主导，官网也是主推 AT 模式，我们在上篇的文章中也讲解过，感兴趣的小伙伴可以去看一看<a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s?__biz=MzA4MjM0MTQ1Mg==&amp;mid=2458786001&amp;idx=1&amp;sn=98f3b3c5d211f60a803446913fbb12e3&amp;chksm=88fd83f2bf8a0ae4b2682af7b15f9493c33d7771a066d1eb1c73583cfc67da891cffa1c9f55c&amp;token=1008440856&amp;lang=zh_CN#rd">分布式事务 (Seata) 四大模式详解</a>，在官网中也提供了对应的流程地址：<a target="_blank" rel="noopener" href="https://seata.io/zh-cn/docs/dev/mode/at-mode.html">https://seata.io/zh-cn/docs/dev/mode/at-mode.html</a> ，在这里我们只是做一些简单的介绍，AT 模式主要分为两个阶段：</p>
<p><strong>一阶段：</strong></p>
<ul>
<li>解析 SQL，获取 SQL 类型（CRUD）、表信息、条件 (where) 等相关信息</li>
<li>查询前镜像 (改变之前的数据)，根据解析得到的条件信息，生成查询语句，定位数据</li>
<li>执行业务 SQL，更新数据</li>
<li>查询后镜像（改变后的数据），根据前镜像的结果，通过主键都给你为数据</li>
<li>插入回滚日志，将前后镜像数据以及业务 SQL 等信息，组织成一条回滚日志记录，插入到 undo Log 表中</li>
<li>提交前，向 TC 注册分支，申请全局锁</li>
<li>本地事务提交，业务数据的更细腻和生成的 undoLog 一起提交</li>
<li>将本地事务提交的结果通知给 TC</li>
</ul>
<p><strong>二阶段：</strong></p>
<p>如果 TC 收到的是回滚请求</p>
<ul>
<li>开启本地事务，通过 XID 和 BranchID 查找到对应的 undo Log 记录</li>
<li>根据 undoLog 中的前镜像和业务 SQL 的相关信息生成并执行回滚语句</li>
<li>提交本地事务，将本地事务的执行结果（分支事务回滚的信息）通知给 TC</li>
</ul>
<p>如果没问题，执行提交操作</p>
<ul>
<li>收到 TC 分支提交请求，将请求放入到一个异步任务的队列中，马上返回提交成功的结果给 TC</li>
<li>异步任务阶段的分支提交请求删除 undoLog 中记录</li>
</ul>
<p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/6b4a6708a964d51d954cec9fb660b72f.png" alt="img"></p>
<h2 id="源码入口"><a class="markdownIt-Anchor" href="#源码入口">#</a> 源码入口</h2>
<p>接下来，我们就需要从官网中去下载源码，下载地址：<a target="_blank" rel="noopener" href="https://seata.io/zh-cn/blog/download.html%EF%BC%8C%E9%80%89%E6%8B%A9">https://seata.io/zh-cn/blog/download.html，选择</a>  <code>source</code>  即可，下载完成之后，通过 IDEA 打开项目。</p>
<p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/bdca1226de54c44b76fbcb81ad5203ec.png" alt="img"></p>
<p>源码下载下来之后，我们应该如何去找入口呢？首先我们需要找到对应引入的  <code>Seata</code>  包  <code>spring-alibaba-seata</code> ，我们在回想一下，我们开启事务的时候，是不是添加过一个 <code>@GlobalTransactional</code>  的注解，这个注解就是我们入手的一个点，我们在  <code>spring.factories</code>  中看到有一个  <code>GlobalTransactionAutoConfiguration</code> ，这个就是我们需要关注的点，也就是我们源码的入口</p>
<p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/23af43bca4492008ae3b80c10bd77c4f.png" alt="img"></p>
<p>在  <code>GlobalTransactionAutoConfiguration</code>  中我们找到一个用 Bean 注入的方法  <code>globalTransactionScanner</code> ，这个就是全局事务扫描器，这个类型主要负责加载配置，注入相关的 Bean</p>
<p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/0f9703310464018bedfecc661d4c4e91.png" alt="img"></p>
<p>这里给大家展示了当前 GlobalTransactionScanner 的类关系图，其中我们现在继承了 Aop 的 AbstractAutoProxyCreator 类型，在这其中有一个重点方法，这个方法就是判断 Bean 对象是否需要代理，是否需要增强。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableConfigurationProperties(SeataProperties.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GlobalTransactionAutoConfiguration</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//全局事务扫描器</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> GlobalTransactionScanner <span class="title function_">globalTransactionScanner</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">      <span class="type">String</span> <span class="variable">applicationName</span> <span class="operator">=</span> applicationContext.getEnvironment()</span><br><span class="line">          .getProperty(<span class="string">&quot;spring.application.name&quot;</span>);</span><br><span class="line"></span><br><span class="line">      <span class="type">String</span> <span class="variable">txServiceGroup</span> <span class="operator">=</span> seataProperties.getTxServiceGroup();</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (StringUtils.isEmpty(txServiceGroup)) &#123;</span><br><span class="line">        txServiceGroup = applicationName + <span class="string">&quot;-fescar-service-group&quot;</span>;</span><br><span class="line">        seataProperties.setTxServiceGroup(txServiceGroup);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// 构建全局扫描器，传入参数：应用名、事务分组名，失败处理器</span></span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">GlobalTransactionScanner</span>(applicationName, txServiceGroup);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在这其中我们要关心的是  <code>GlobalTransactionScanner</code>  这个类型，这个类型扫描  <code>@GlobalTransactional</code>  注解，并对代理方法进行拦截增强事务的功能。我们就从源码中搜索这个 <code>GlobalTransactionScanner</code>  类，看看里面具体是做了什么</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * The type Global transaction scanner.</span></span><br><span class="line"><span class="comment"> * 全局事务扫描器</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> slievrly</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GlobalTransactionScanner</span></span><br><span class="line">        <span class="comment">//AbstractAutoProxyCreator AOP动态代理 增强Bean</span></span><br><span class="line">        <span class="keyword">extends</span> <span class="title class_">AbstractAutoProxyCreator</span></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * ConfigurationChangeListener: 监听器基准接口</span></span><br><span class="line"><span class="comment">         * InitializingBean： Bean初始化</span></span><br><span class="line"><span class="comment">         * ApplicationContextAware： Spring容器</span></span><br><span class="line"><span class="comment">         * DisposableBean： Spring 容器销毁</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">implements</span> <span class="title class_">ConfigurationChangeListener</span>, InitializingBean, ApplicationContextAware, DisposableBean &#123;</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String applicationId;<span class="comment">//服务名</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String txServiceGroup;<span class="comment">//事务分组        </span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">initClient</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">//启动日志</span></span><br><span class="line">        <span class="keyword">if</span> (LOGGER.isInfoEnabled()) &#123;</span><br><span class="line">            LOGGER.info(<span class="string">&quot;Initializing Global Transaction Clients ... &quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//检查应用名以及事务分组名，为空抛出异常IllegalArgumentException</span></span><br><span class="line">        <span class="keyword">if</span> (DEFAULT_TX_GROUP_OLD.equals(txServiceGroup)) &#123;</span><br><span class="line">            LOGGER.warn(<span class="string">&quot;the default value of seata.tx-service-group: &#123;&#125; has already changed to &#123;&#125; since Seata 1.5, &quot;</span> +</span><br><span class="line">                    <span class="string">&quot;please change your default configuration as soon as possible &quot;</span> +</span><br><span class="line">                    <span class="string">&quot;and we don&#x27;t recommend you to use default tx-service-group&#x27;s value provided by seata&quot;</span>,</span><br><span class="line">                    DEFAULT_TX_GROUP_OLD, DEFAULT_TX_GROUP);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isNullOrEmpty(applicationId) || StringUtils.isNullOrEmpty(txServiceGroup)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(String.format(<span class="string">&quot;applicationId: %s, txServiceGroup: %s&quot;</span>, applicationId, txServiceGroup));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//init TM</span></span><br><span class="line">        <span class="comment">//初始化TM</span></span><br><span class="line">        TMClient.init(applicationId, txServiceGroup, accessKey, secretKey);</span><br><span class="line">        <span class="keyword">if</span> (LOGGER.isInfoEnabled()) &#123;</span><br><span class="line">            LOGGER.info(<span class="string">&quot;Transaction Manager Client is initialized. applicationId[&#123;&#125;] txServiceGroup[&#123;&#125;]&quot;</span>, applicationId, txServiceGroup);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//init RM</span></span><br><span class="line">        <span class="comment">//初始化RM</span></span><br><span class="line">        RMClient.init(applicationId, txServiceGroup);</span><br><span class="line">        <span class="keyword">if</span> (LOGGER.isInfoEnabled()) &#123;</span><br><span class="line">            LOGGER.info(<span class="string">&quot;Resource Manager is initialized. applicationId[&#123;&#125;] txServiceGroup[&#123;&#125;]&quot;</span>, applicationId, txServiceGroup);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (LOGGER.isInfoEnabled()) &#123;</span><br><span class="line">            LOGGER.info(<span class="string">&quot;Global Transaction Clients are initialized. &quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        registerSpringShutdownHook();</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">afterPropertiesSet</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (disableGlobalTransaction) &#123;</span><br><span class="line">            <span class="keyword">if</span> (LOGGER.isInfoEnabled()) &#123;</span><br><span class="line">                LOGGER.info(<span class="string">&quot;Global transaction is disabled.&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            ConfigurationCache.addConfigListener(ConfigurationKeys.DISABLE_GLOBAL_TRANSACTION,</span><br><span class="line">                    (ConfigurationChangeListener)<span class="built_in">this</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (initialized.compareAndSet(<span class="literal">false</span>, <span class="literal">true</span>)) &#123;</span><br><span class="line">            initClient();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">initClient</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">//启动日志</span></span><br><span class="line">        <span class="keyword">if</span> (LOGGER.isInfoEnabled()) &#123;</span><br><span class="line">            LOGGER.info(<span class="string">&quot;Initializing Global Transaction Clients ... &quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//检查应用名以及事务分组名，为空抛出异常IllegalArgumentException</span></span><br><span class="line">        <span class="keyword">if</span> (DEFAULT_TX_GROUP_OLD.equals(txServiceGroup)) &#123;</span><br><span class="line">            LOGGER.warn(<span class="string">&quot;the default value of seata.tx-service-group: &#123;&#125; has already changed to &#123;&#125; since Seata 1.5, &quot;</span> +</span><br><span class="line">                    <span class="string">&quot;please change your default configuration as soon as possible &quot;</span> +</span><br><span class="line">                    <span class="string">&quot;and we don&#x27;t recommend you to use default tx-service-group&#x27;s value provided by seata&quot;</span>,</span><br><span class="line">                    DEFAULT_TX_GROUP_OLD, DEFAULT_TX_GROUP);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//检查应用名以及事务分组名，为空抛出异常IllegalArgumentException</span></span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isNullOrEmpty(applicationId) || StringUtils.isNullOrEmpty(txServiceGroup)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(String.format(<span class="string">&quot;applicationId: %s, txServiceGroup: %s&quot;</span>, applicationId, txServiceGroup));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//init TM</span></span><br><span class="line">        <span class="comment">//初始化TM</span></span><br><span class="line">        TMClient.init(applicationId, txServiceGroup, accessKey, secretKey);</span><br><span class="line">        <span class="keyword">if</span> (LOGGER.isInfoEnabled()) &#123;</span><br><span class="line">            LOGGER.info(<span class="string">&quot;Transaction Manager Client is initialized. applicationId[&#123;&#125;] txServiceGroup[&#123;&#125;]&quot;</span>, applicationId, txServiceGroup);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//init RM</span></span><br><span class="line">        <span class="comment">//初始化RM</span></span><br><span class="line">        RMClient.init(applicationId, txServiceGroup);</span><br><span class="line">        <span class="keyword">if</span> (LOGGER.isInfoEnabled()) &#123;</span><br><span class="line">            LOGGER.info(<span class="string">&quot;Resource Manager is initialized. applicationId[&#123;&#125;] txServiceGroup[&#123;&#125;]&quot;</span>, applicationId, txServiceGroup);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (LOGGER.isInfoEnabled()) &#123;</span><br><span class="line">            LOGGER.info(<span class="string">&quot;Global Transaction Clients are initialized. &quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        registerSpringShutdownHook();</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//代理增强，Spring 所有的Bean都会经过这个方法</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> Object <span class="title function_">wrapIfNecessary</span><span class="params">(Object bean, String beanName, Object cacheKey)</span> &#123;</span><br><span class="line">        <span class="comment">// do checkers</span></span><br><span class="line">        <span class="comment">//检查bean和beanName</span></span><br><span class="line">        <span class="keyword">if</span> (!doCheckers(bean, beanName)) &#123;</span><br><span class="line">            <span class="keyword">return</span> bean;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//加锁防止并发</span></span><br><span class="line">            <span class="keyword">synchronized</span> (PROXYED_SET) &#123;</span><br><span class="line">                <span class="keyword">if</span> (PROXYED_SET.contains(beanName)) &#123;</span><br><span class="line">                    <span class="keyword">return</span> bean;</span><br><span class="line">                &#125;</span><br><span class="line">                interceptor = <span class="literal">null</span>;</span><br><span class="line">                <span class="comment">//check TCC proxy</span></span><br><span class="line">                <span class="comment">//检查是否为TCC模式</span></span><br><span class="line">                <span class="keyword">if</span> (TCCBeanParserUtils.isTccAutoProxy(bean, beanName, applicationContext)) &#123;</span><br><span class="line">                    <span class="comment">// init tcc fence clean task if enable useTccFence</span></span><br><span class="line">                    <span class="comment">//如果启用useTccFence 失败 ，则初始化TCC清理任务</span></span><br><span class="line">                    TCCBeanParserUtils.initTccFenceCleanTask(TCCBeanParserUtils.getRemotingDesc(beanName), applicationContext);</span><br><span class="line">                    <span class="comment">//TCC interceptor, proxy bean of sofa:reference/dubbo:reference, and LocalTCC</span></span><br><span class="line">                    <span class="comment">//如果是，添加TCC拦截器</span></span><br><span class="line">                    interceptor = <span class="keyword">new</span> <span class="title class_">TccActionInterceptor</span>(TCCBeanParserUtils.getRemotingDesc(beanName));</span><br><span class="line">                    ConfigurationCache.addConfigListener(ConfigurationKeys.DISABLE_GLOBAL_TRANSACTION,</span><br><span class="line">                            (ConfigurationChangeListener)interceptor);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="comment">//不是TCC</span></span><br><span class="line">                    Class&lt;?&gt; serviceInterface = SpringProxyUtils.findTargetClass(bean);</span><br><span class="line">                    Class&lt;?&gt;[] interfacesIfJdk = SpringProxyUtils.findInterfaces(bean);</span><br><span class="line"></span><br><span class="line">                    <span class="comment">//判断是否有相关事务注解，如果没有不进行代理</span></span><br><span class="line">                    <span class="keyword">if</span> (!existsAnnotation(<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;serviceInterface&#125;)</span><br><span class="line">                        &amp;&amp; !existsAnnotation(interfacesIfJdk)) &#123;</span><br><span class="line">                        <span class="keyword">return</span> bean;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="comment">//发现存在全局事务注解标注的Bean对象，添加拦截器</span></span><br><span class="line">                    <span class="keyword">if</span> (globalTransactionalInterceptor == <span class="literal">null</span>) &#123;</span><br><span class="line">                        <span class="comment">//添加拦截器</span></span><br><span class="line">                        globalTransactionalInterceptor = <span class="keyword">new</span> <span class="title class_">GlobalTransactionalInterceptor</span>(failureHandlerHook);</span><br><span class="line">                        ConfigurationCache.addConfigListener(</span><br><span class="line">                                ConfigurationKeys.DISABLE_GLOBAL_TRANSACTION,</span><br><span class="line">                                (ConfigurationChangeListener)globalTransactionalInterceptor);</span><br><span class="line">                    &#125;</span><br><span class="line">                    interceptor = globalTransactionalInterceptor;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                LOGGER.info(<span class="string">&quot;Bean[&#123;&#125;] with name [&#123;&#125;] would use interceptor [&#123;&#125;]&quot;</span>, bean.getClass().getName(), beanName, interceptor.getClass().getName());</span><br><span class="line">                <span class="comment">//检查是否为代理对象</span></span><br><span class="line">                <span class="keyword">if</span> (!AopUtils.isAopProxy(bean)) &#123;</span><br><span class="line">                    <span class="comment">//不是代理对象，调用父级</span></span><br><span class="line">                    bean = <span class="built_in">super</span>.wrapIfNecessary(bean, beanName, cacheKey);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="comment">//是代理对象，反射获取代理类中已经存在的拦截器组合，然后添加到这个集合中</span></span><br><span class="line">                    <span class="type">AdvisedSupport</span> <span class="variable">advised</span> <span class="operator">=</span> SpringProxyUtils.getAdvisedSupport(bean);</span><br><span class="line">                    Advisor[] advisor = buildAdvisors(beanName, getAdvicesAndAdvisorsForBean(<span class="literal">null</span>, <span class="literal">null</span>, <span class="literal">null</span>));</span><br><span class="line">                    <span class="type">int</span> pos;</span><br><span class="line">                    <span class="keyword">for</span> (Advisor avr : advisor) &#123;</span><br><span class="line">                        <span class="comment">// Find the position based on the advisor&#x27;s order, and add to advisors by pos</span></span><br><span class="line">                        pos = findAddSeataAdvisorPosition(advised, avr);</span><br><span class="line">                        advised.addAdvisor(pos, avr);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                PROXYED_SET.add(beanName);</span><br><span class="line">                <span class="keyword">return</span> bean;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception exx) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(exx);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">InitializingBean`：中实现了一个 `afterPropertiesSet()`方法，在这个方法中，调用了`initClient()</span><br></pre></td></tr></table></figure>
<p><code>AbstractAutoProxyCreator</code> ：APO 动态代理，在之前的的 Nacos 和 Sentiel 中都有这个代理类，AOP 在我们越往深入学习，在学习源码的会见到的越来越多，越来越重要，很多相关代理，都是通过 AOP 进行增强，在这个类中，我们需要关注有一个 <code>wrapIfNecessary()</code>  方法， 这个方法主要是判断被代理的 bean 或者类是否需要代理增强，在这个方法中会调用 <code>GlobalTransactionalInterceptor.invoke()</code>  进行带来增强。</p>
<p>具体代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GlobalTransactionalInterceptor</span> <span class="keyword">implements</span> <span class="title class_">ConfigurationChangeListener</span>, MethodInterceptor, SeataInterceptor &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">GlobalTransactionalInterceptor</span><span class="params">(FailureHandler failureHandler)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.failureHandler = failureHandler == <span class="literal">null</span> ? DEFAULT_FAIL_HANDLER : failureHandler;</span><br><span class="line">        <span class="built_in">this</span>.disable = ConfigurationFactory.getInstance().getBoolean(ConfigurationKeys.DISABLE_GLOBAL_TRANSACTION,</span><br><span class="line">            DEFAULT_DISABLE_GLOBAL_TRANSACTION);</span><br><span class="line">        <span class="built_in">this</span>.order =</span><br><span class="line">            ConfigurationFactory.getInstance().getInt(ConfigurationKeys.TM_INTERCEPTOR_ORDER, TM_INTERCEPTOR_ORDER);</span><br><span class="line">        degradeCheck = ConfigurationFactory.getInstance().getBoolean(ConfigurationKeys.CLIENT_DEGRADE_CHECK,</span><br><span class="line">            DEFAULT_TM_DEGRADE_CHECK);</span><br><span class="line">        <span class="keyword">if</span> (degradeCheck) &#123;</span><br><span class="line">            ConfigurationCache.addConfigListener(ConfigurationKeys.CLIENT_DEGRADE_CHECK, <span class="built_in">this</span>);</span><br><span class="line">            degradeCheckPeriod = ConfigurationFactory.getInstance()</span><br><span class="line">                .getInt(ConfigurationKeys.CLIENT_DEGRADE_CHECK_PERIOD, DEFAULT_TM_DEGRADE_CHECK_PERIOD);</span><br><span class="line">            degradeCheckAllowTimes = ConfigurationFactory.getInstance()</span><br><span class="line">                .getInt(ConfigurationKeys.CLIENT_DEGRADE_CHECK_ALLOW_TIMES, DEFAULT_TM_DEGRADE_CHECK_ALLOW_TIMES);</span><br><span class="line">            EVENT_BUS.register(<span class="built_in">this</span>);</span><br><span class="line">            <span class="keyword">if</span> (degradeCheckPeriod &gt; <span class="number">0</span> &amp;&amp; degradeCheckAllowTimes &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                startDegradeCheck();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">this</span>.initDefaultGlobalTransactionTimeout();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">invoke</span><span class="params">(<span class="keyword">final</span> MethodInvocation methodInvocation)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">        <span class="comment">//获取执行的方法</span></span><br><span class="line">        Class&lt;?&gt; targetClass =</span><br><span class="line">            methodInvocation.getThis() != <span class="literal">null</span> ? AopUtils.getTargetClass(methodInvocation.getThis()) : <span class="literal">null</span>;</span><br><span class="line">        <span class="type">Method</span> <span class="variable">specificMethod</span> <span class="operator">=</span> ClassUtils.getMostSpecificMethod(methodInvocation.getMethod(), targetClass);</span><br><span class="line">        <span class="keyword">if</span> (specificMethod != <span class="literal">null</span> &amp;&amp; !specificMethod.getDeclaringClass().equals(Object.class)) &#123;</span><br><span class="line">            <span class="keyword">final</span> <span class="type">Method</span> <span class="variable">method</span> <span class="operator">=</span> BridgeMethodResolver.findBridgedMethod(specificMethod);</span><br><span class="line">            <span class="comment">//获取GlobalTransactional（全局事务）、GlobalLock(全局锁)元数据</span></span><br><span class="line">            <span class="keyword">final</span> <span class="type">GlobalTransactional</span> <span class="variable">globalTransactionalAnnotation</span> <span class="operator">=</span></span><br><span class="line">                getAnnotation(method, targetClass, GlobalTransactional.class);</span><br><span class="line">            <span class="comment">//GlobalLock会将本地事务的执行纳入Seata分布式事务的管理，共同竞争全局锁</span></span><br><span class="line">            <span class="comment">//保证全局事务在执行的时候，本地事务不可以操作全局事务的记录</span></span><br><span class="line">            <span class="keyword">final</span> <span class="type">GlobalLock</span> <span class="variable">globalLockAnnotation</span> <span class="operator">=</span> getAnnotation(method, targetClass, GlobalLock.class);<span class="comment">//获取全局锁</span></span><br><span class="line">            <span class="type">boolean</span> <span class="variable">localDisable</span> <span class="operator">=</span> disable || (degradeCheck &amp;&amp; degradeNum &gt;= degradeCheckAllowTimes);</span><br><span class="line">            <span class="keyword">if</span> (!localDisable) &#123;</span><br><span class="line">                <span class="keyword">if</span> (globalTransactionalAnnotation != <span class="literal">null</span> || <span class="built_in">this</span>.aspectTransactional != <span class="literal">null</span>) &#123;</span><br><span class="line">                    AspectTransactional transactional;</span><br><span class="line">                    <span class="keyword">if</span> (globalTransactionalAnnotation != <span class="literal">null</span>) &#123;</span><br><span class="line">                        transactional = <span class="keyword">new</span> <span class="title class_">AspectTransactional</span>(globalTransactionalAnnotation.timeoutMills(),</span><br><span class="line">                            globalTransactionalAnnotation.name(), globalTransactionalAnnotation.rollbackFor(),</span><br><span class="line">                            globalTransactionalAnnotation.noRollbackForClassName(),</span><br><span class="line">                            globalTransactionalAnnotation.noRollbackFor(),</span><br><span class="line">                            globalTransactionalAnnotation.noRollbackForClassName(),</span><br><span class="line">                            globalTransactionalAnnotation.propagation(),</span><br><span class="line">                            globalTransactionalAnnotation.lockRetryInterval(),</span><br><span class="line">                            globalTransactionalAnnotation.lockRetryTimes());</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        transactional = <span class="built_in">this</span>.aspectTransactional;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="comment">//执行全局事务</span></span><br><span class="line">                    <span class="keyword">return</span> handleGlobalTransaction(methodInvocation, transactional);</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (globalLockAnnotation != <span class="literal">null</span>) &#123;</span><br><span class="line">                    <span class="comment">//执行全局锁</span></span><br><span class="line">                    <span class="keyword">return</span> handleGlobalLock(methodInvocation, globalLockAnnotation);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> methodInvocation.proceed();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>具体流程图如下所示：</p>
<p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/45838801f4caeefec5623a955be68146.png" alt="img"></p>
<h2 id="核心源码"><a class="markdownIt-Anchor" href="#核心源码">#</a> 核心源码</h2>
<p>在上面我们讲解到  <code>GlobalTransactionalInterceptor</code>  作为全局事务拦截器，一旦执行拦截，就会进入 invoke 方法，其中，我们会做  <code>@GlobalTransactional</code>  注解的判断，如果有这个注解的存在，会执行全局事务和全局锁，再执行全局事务的时候会调用  <code>handleGlobalTransaction</code>  全局事务处理器，获取事务信息，那我们接下来就来看一下  <code>GlobalTransactionalInterceptor.handleGlobalTransaction</code>  到底是如何执行全局事务的</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line">Object <span class="title function_">handleGlobalTransaction</span><span class="params">(<span class="keyword">final</span> MethodInvocation methodInvocation,</span></span><br><span class="line"><span class="params">        <span class="keyword">final</span> AspectTransactional aspectTransactional)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">succeed</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> transactionalTemplate.execute(<span class="keyword">new</span> <span class="title class_">TransactionalExecutor</span>() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="keyword">public</span> Object <span class="title function_">execute</span><span class="params">()</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">                    <span class="keyword">return</span> methodInvocation.proceed();</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">//获取事务名称，默认获取方法名</span></span><br><span class="line">                <span class="keyword">public</span> String <span class="title function_">name</span><span class="params">()</span> &#123;</span><br><span class="line">                    <span class="type">String</span> <span class="variable">name</span> <span class="operator">=</span> aspectTransactional.getName();</span><br><span class="line">                    <span class="keyword">if</span> (!StringUtils.isNullOrEmpty(name)) &#123;</span><br><span class="line">                        <span class="keyword">return</span> name;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">return</span> formatMethod(methodInvocation.getMethod());</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">/**</span></span><br><span class="line"><span class="comment">                 * 解析GlobalTransation注解属性，封装对对象</span></span><br><span class="line"><span class="comment">                 * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">                 */</span></span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="keyword">public</span> TransactionInfo <span class="title function_">getTransactionInfo</span><span class="params">()</span> &#123;</span><br><span class="line">                    <span class="comment">// reset the value of timeout</span></span><br><span class="line">                    <span class="comment">//获取超时时间，默认60秒</span></span><br><span class="line">                    <span class="type">int</span> <span class="variable">timeout</span> <span class="operator">=</span> aspectTransactional.getTimeoutMills();</span><br><span class="line">                    <span class="keyword">if</span> (timeout &lt;= <span class="number">0</span> || timeout == DEFAULT_GLOBAL_TRANSACTION_TIMEOUT) &#123;</span><br><span class="line">                        timeout = defaultGlobalTransactionTimeout;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="comment">//构建事务信息对象</span></span><br><span class="line">                    <span class="type">TransactionInfo</span> <span class="variable">transactionInfo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TransactionInfo</span>();</span><br><span class="line">                    transactionInfo.setTimeOut(timeout);<span class="comment">//超时时间</span></span><br><span class="line">                    transactionInfo.setName(name());<span class="comment">//事务名称</span></span><br><span class="line">                    transactionInfo.setPropagation(aspectTransactional.getPropagation());<span class="comment">//事务传播</span></span><br><span class="line">                    transactionInfo.setLockRetryInterval(aspectTransactional.getLockRetryInterval());<span class="comment">//校验或占用全局锁重试间隔</span></span><br><span class="line">                    transactionInfo.setLockRetryTimes(aspectTransactional.getLockRetryTimes());<span class="comment">//校验或占用全局锁重试次数</span></span><br><span class="line">                    Set&lt;RollbackRule&gt; rollbackRules = <span class="keyword">new</span> <span class="title class_">LinkedHashSet</span>&lt;&gt;();</span><br><span class="line">                    <span class="comment">//其他构建信息</span></span><br><span class="line">                    <span class="keyword">for</span> (Class&lt;?&gt; rbRule : aspectTransactional.getRollbackFor()) &#123;</span><br><span class="line">                        rollbackRules.add(<span class="keyword">new</span> <span class="title class_">RollbackRule</span>(rbRule));</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">for</span> (String rbRule : aspectTransactional.getRollbackForClassName()) &#123;</span><br><span class="line">                        rollbackRules.add(<span class="keyword">new</span> <span class="title class_">RollbackRule</span>(rbRule));</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">for</span> (Class&lt;?&gt; rbRule : aspectTransactional.getNoRollbackFor()) &#123;</span><br><span class="line">                        rollbackRules.add(<span class="keyword">new</span> <span class="title class_">NoRollbackRule</span>(rbRule));</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">for</span> (String rbRule : aspectTransactional.getNoRollbackForClassName()) &#123;</span><br><span class="line">                        rollbackRules.add(<span class="keyword">new</span> <span class="title class_">NoRollbackRule</span>(rbRule));</span><br><span class="line">                    &#125;</span><br><span class="line">                    transactionInfo.setRollbackRules(rollbackRules);</span><br><span class="line">                    <span class="keyword">return</span> transactionInfo;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (TransactionalExecutor.ExecutionException e) &#123;</span><br><span class="line">            <span class="comment">//执行异常</span></span><br><span class="line">            TransactionalExecutor.<span class="type">Code</span> <span class="variable">code</span> <span class="operator">=</span> e.getCode();</span><br><span class="line">            <span class="keyword">switch</span> (code) &#123;</span><br><span class="line">                <span class="keyword">case</span> RollbackDone:</span><br><span class="line">                    <span class="keyword">throw</span> e.getOriginalException();</span><br><span class="line">                <span class="keyword">case</span> BeginFailure:</span><br><span class="line">                    succeed = <span class="literal">false</span>;</span><br><span class="line">                    failureHandler.onBeginFailure(e.getTransaction(), e.getCause());</span><br><span class="line">                    <span class="keyword">throw</span> e.getCause();</span><br><span class="line">                <span class="keyword">case</span> CommitFailure:</span><br><span class="line">                    succeed = <span class="literal">false</span>;</span><br><span class="line">                    failureHandler.onCommitFailure(e.getTransaction(), e.getCause());</span><br><span class="line">                    <span class="keyword">throw</span> e.getCause();</span><br><span class="line">                <span class="keyword">case</span> RollbackFailure:</span><br><span class="line">                    failureHandler.onRollbackFailure(e.getTransaction(), e.getOriginalException());</span><br><span class="line">                    <span class="keyword">throw</span> e.getOriginalException();</span><br><span class="line">                <span class="keyword">case</span> RollbackRetrying:</span><br><span class="line">                    failureHandler.onRollbackRetrying(e.getTransaction(), e.getOriginalException());</span><br><span class="line">                    <span class="keyword">throw</span> e.getOriginalException();</span><br><span class="line">                <span class="keyword">default</span>:</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ShouldNeverHappenException</span>(String.format(<span class="string">&quot;Unknown TransactionalExecutor.Code: %s&quot;</span>, code));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (degradeCheck) &#123;</span><br><span class="line">                EVENT_BUS.post(<span class="keyword">new</span> <span class="title class_">DegradeCheckEvent</span>(succeed));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>在这里我们，主要关注一个重点方法  <code>execute()</code> ，这个方法主要用来执行事务的具体流程：</p>
<ul>
<li>获取事务信息</li>
<li>执行全局事务</li>
<li>发生异常全局回滚，各个数据通过 UndoLog 进行事务补偿</li>
<li>全局事务提交</li>
<li>清除所有资源</li>
</ul>
<p>这个位置也是一个非常核心的一个位置，因为我们所有的业务进来以后都会去走这个位置，具体源码如下所示：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Object <span class="title function_">execute</span><span class="params">(TransactionalExecutor business)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">    <span class="comment">// 1. Get transactionInfo</span></span><br><span class="line">    <span class="comment">//获取事务信息</span></span><br><span class="line">    <span class="type">TransactionInfo</span> <span class="variable">txInfo</span> <span class="operator">=</span> business.getTransactionInfo();</span><br><span class="line">    <span class="keyword">if</span> (txInfo == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ShouldNeverHappenException</span>(<span class="string">&quot;transactionInfo does not exist&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 1.1 Get current transaction, if not null, the tx role is &#x27;GlobalTransactionRole.Participant&#x27;.</span></span><br><span class="line">    <span class="comment">//获取当前事务，主要获取XID</span></span><br><span class="line">    <span class="type">GlobalTransaction</span> <span class="variable">tx</span> <span class="operator">=</span> GlobalTransactionContext.getCurrent();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 1.2 Handle the transaction propagation.</span></span><br><span class="line">    <span class="comment">//根据配置的不同事务传播行为，执行不同的逻辑</span></span><br><span class="line">    <span class="type">Propagation</span> <span class="variable">propagation</span> <span class="operator">=</span> txInfo.getPropagation();</span><br><span class="line">    <span class="type">SuspendedResourcesHolder</span> <span class="variable">suspendedResourcesHolder</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">switch</span> (propagation) &#123;</span><br><span class="line">            <span class="keyword">case</span> NOT_SUPPORTED:</span><br><span class="line">                <span class="comment">// If transaction is existing, suspend it.</span></span><br><span class="line">                <span class="keyword">if</span> (existingTransaction(tx)) &#123;</span><br><span class="line">                    suspendedResourcesHolder = tx.suspend();</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// Execute without transaction and return.</span></span><br><span class="line">                <span class="keyword">return</span> business.execute();</span><br><span class="line">            <span class="keyword">case</span> REQUIRES_NEW:</span><br><span class="line">                <span class="comment">// If transaction is existing, suspend it, and then begin new transaction.</span></span><br><span class="line">                <span class="keyword">if</span> (existingTransaction(tx)) &#123;</span><br><span class="line">                    suspendedResourcesHolder = tx.suspend();</span><br><span class="line">                    tx = GlobalTransactionContext.createNew();</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// Continue and execute with new transaction</span></span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> SUPPORTS:</span><br><span class="line">                <span class="comment">// If transaction is not existing, execute without transaction.</span></span><br><span class="line">                <span class="keyword">if</span> (notExistingTransaction(tx)) &#123;</span><br><span class="line">                    <span class="keyword">return</span> business.execute();</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// Continue and execute with new transaction</span></span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> REQUIRED:</span><br><span class="line">                <span class="comment">// If current transaction is existing, execute with current transaction,</span></span><br><span class="line">                <span class="comment">// else continue and execute with new transaction.</span></span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> NEVER:</span><br><span class="line">                <span class="comment">// If transaction is existing, throw exception.</span></span><br><span class="line">                <span class="keyword">if</span> (existingTransaction(tx)) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">TransactionException</span>(</span><br><span class="line">                        String.format(<span class="string">&quot;Existing transaction found for transaction marked with propagation &#x27;never&#x27;, xid = %s&quot;</span></span><br><span class="line">                                , tx.getXid()));</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="comment">// Execute without transaction and return.</span></span><br><span class="line">                    <span class="keyword">return</span> business.execute();</span><br><span class="line">                &#125;</span><br><span class="line">            <span class="keyword">case</span> MANDATORY:</span><br><span class="line">                <span class="comment">// If transaction is not existing, throw exception.</span></span><br><span class="line">                <span class="keyword">if</span> (notExistingTransaction(tx)) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">TransactionException</span>(<span class="string">&quot;No existing transaction found for transaction marked with propagation &#x27;mandatory&#x27;&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// Continue and execute with current transaction.</span></span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">TransactionException</span>(<span class="string">&quot;Not Supported Propagation:&quot;</span> + propagation);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 1.3 If null, create new transaction with role &#x27;GlobalTransactionRole.Launcher&#x27;.</span></span><br><span class="line">        <span class="comment">//如果当前事务为空，创建一个新的事务</span></span><br><span class="line">        <span class="keyword">if</span> (tx == <span class="literal">null</span>) &#123;</span><br><span class="line">            tx = GlobalTransactionContext.createNew();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// set current tx config to holder</span></span><br><span class="line">        <span class="type">GlobalLockConfig</span> <span class="variable">previousConfig</span> <span class="operator">=</span> replaceGlobalLockConfig(txInfo);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 2. If the tx role is &#x27;GlobalTransactionRole.Launcher&#x27;, send the request of beginTransaction to TC,</span></span><br><span class="line">            <span class="comment">//    else do nothing. Of course, the hooks will still be triggered.</span></span><br><span class="line">            <span class="comment">//开始执行全局事务</span></span><br><span class="line">            beginTransaction(txInfo, tx);</span><br><span class="line"></span><br><span class="line">            Object rs;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// Do Your Business</span></span><br><span class="line">                <span class="comment">// 执行当前业务逻辑</span></span><br><span class="line">                <span class="comment">//1、在TC注册当前分支事务，TC会在branch_table中插入一条分支事务数据</span></span><br><span class="line">                <span class="comment">//2、执行本地update语句，并在执行前后查询数据状态，并把数据前后镜像存入到undo_log中</span></span><br><span class="line">                <span class="comment">//3、远程调用其他应用，远程应用接收到XID，也会注册分支事务，写入branch_table以及本地undo_log表</span></span><br><span class="line">                <span class="comment">//4、会在lock_table表中插入全局锁数据（一个分支一条）</span></span><br><span class="line">                rs = business.execute();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Throwable ex) &#123;</span><br><span class="line">                <span class="comment">// 3. The needed business exception to rollback.</span></span><br><span class="line">                <span class="comment">//发生异常全局回滚，每个事务通过undo_log表进行事务补偿</span></span><br><span class="line">                completeTransactionAfterThrowing(txInfo, tx, ex);</span><br><span class="line">                <span class="keyword">throw</span> ex;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 4. everything is fine, commit.</span></span><br><span class="line">            <span class="comment">//全局提交</span></span><br><span class="line">            commitTransaction(tx);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> rs;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="comment">//5. clear</span></span><br><span class="line">            <span class="comment">//清理所有资源</span></span><br><span class="line">            resumeGlobalLockConfig(previousConfig);</span><br><span class="line">            triggerAfterCompletion();</span><br><span class="line">            cleanUp();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="comment">// If the transaction is suspended, resume it.</span></span><br><span class="line">        <span class="keyword">if</span> (suspendedResourcesHolder != <span class="literal">null</span>) &#123;</span><br><span class="line">            tx.resume(suspendedResourcesHolder);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这其中的第三步和第四步其实在向 TC（Seata-Server）发起全局事务的提交或者回滚，在这里我们首先关注执行全局事务的  <code>beginTransaction()</code>  方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 向TC发起请求，采用模板模式</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">beginTransaction</span><span class="params">(TransactionInfo txInfo, GlobalTransaction tx)</span> <span class="keyword">throws</span> TransactionalExecutor.ExecutionException &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        triggerBeforeBegin();</span><br><span class="line">        <span class="comment">//对TC发起请求</span></span><br><span class="line">        tx.begin(txInfo.getTimeOut(), txInfo.getName());</span><br><span class="line">        triggerAfterBegin();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (TransactionException txe) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">TransactionalExecutor</span>.ExecutionException(tx, txe,</span><br><span class="line">            TransactionalExecutor.Code.BeginFailure);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在来关注其中，向 TC 发起请求的  <code>tx.begin()</code>  方法，而调用 <code>begin()</code>  方法的类为： <code>DefaultGlobalTransaction</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">begin</span><span class="params">(<span class="type">int</span> timeout, String name)</span> <span class="keyword">throws</span> TransactionException &#123;</span><br><span class="line">       <span class="comment">//判断调用者是否为TM</span></span><br><span class="line">       <span class="keyword">if</span> (role != GlobalTransactionRole.Launcher) &#123;</span><br><span class="line">           assertXIDNotNull();</span><br><span class="line">           <span class="keyword">if</span> (LOGGER.isDebugEnabled()) &#123;</span><br><span class="line">               LOGGER.debug(<span class="string">&quot;Ignore Begin(): just involved in global transaction [&#123;&#125;]&quot;</span>, xid);</span><br><span class="line">           &#125;</span><br><span class="line">           <span class="keyword">return</span>;</span><br><span class="line">       &#125;</span><br><span class="line">       assertXIDNull();</span><br><span class="line">       <span class="type">String</span> <span class="variable">currentXid</span> <span class="operator">=</span> RootContext.getXID();</span><br><span class="line">       <span class="keyword">if</span> (currentXid != <span class="literal">null</span>) &#123;</span><br><span class="line">           <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(<span class="string">&quot;Global transaction already exists,&quot;</span> +</span><br><span class="line">               <span class="string">&quot; can&#x27;t begin a new global transaction, currentXid = &quot;</span> + currentXid);</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="comment">//获取XID</span></span><br><span class="line">       xid = transactionManager.begin(<span class="literal">null</span>, <span class="literal">null</span>, name, timeout);</span><br><span class="line">       status = GlobalStatus.Begin;</span><br><span class="line">       <span class="comment">//绑定XID</span></span><br><span class="line">       RootContext.bind(xid);</span><br><span class="line">       <span class="keyword">if</span> (LOGGER.isInfoEnabled()) &#123;</span><br><span class="line">           LOGGER.info(<span class="string">&quot;Begin new global transaction [&#123;&#125;]&quot;</span>, xid);</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>再来看一下  <code>transactionManager.begin()</code>  方法，这个时候使用的是  <code>DefaultTransactionManager.begin</code>  默认的事务管理者，来获取 XID，传入事务相关的信息 ，最好 TC 返回对应的全局事务 XID，它调用的是 <code>DefaultTransactionManager.begin()</code>  方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> String <span class="title function_">begin</span><span class="params">(String applicationId, String transactionServiceGroup, String name, <span class="type">int</span> timeout)</span></span><br><span class="line">    <span class="keyword">throws</span> TransactionException &#123;</span><br><span class="line">    <span class="type">GlobalBeginRequest</span> <span class="variable">request</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">GlobalBeginRequest</span>();</span><br><span class="line">    request.setTransactionName(name);</span><br><span class="line">    request.setTimeout(timeout);</span><br><span class="line">    <span class="comment">//发送请求得到响应</span></span><br><span class="line">    <span class="type">GlobalBeginResponse</span> <span class="variable">response</span> <span class="operator">=</span> (GlobalBeginResponse) syncCall(request);</span><br><span class="line">    <span class="keyword">if</span> (response.getResultCode() == ResultCode.Failed) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">TmTransactionException</span>(TransactionExceptionCode.BeginFailed, response.getMsg());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//返回XID</span></span><br><span class="line">    <span class="keyword">return</span> response.getXid();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在这里我们需要关注一个 <code>syncCall</code> ，在这里采用的是 Netty 通讯方式</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> AbstractTransactionResponse <span class="title function_">syncCall</span><span class="params">(AbstractTransactionRequest request)</span> <span class="keyword">throws</span> TransactionException &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// 通过Netty发送请求</span></span><br><span class="line">        <span class="keyword">return</span> (AbstractTransactionResponse) TmNettyRemotingClient.getInstance().sendSyncRequest(request);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (TimeoutException toe) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">TmTransactionException</span>(TransactionExceptionCode.IO, <span class="string">&quot;RPC timeout&quot;</span>, toe);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>具体图解如下：</p>
<p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/58f1038f3648c3d95be79c183eb151b6.png" alt="img"></p>
<p>在这里我们需要重点了解  <code>GlobalTransactionScanner</code>  这个类型，在这个类型中继承了一些接口和抽象类，这个类主要作用就是扫描有注解的 Bean，并做 AOP 增强。</p>
<ul>
<li><code>ApplicationContextAware</code> ：继承这个类型以后，需要实现其方法  <code>setApplicationContext()</code> ，当 Spring 启动完成以后，会自动调用这个类型，将  <code>ApplicationContext</code>  给  <code>bean</code> ，也就是说，  <code>GlobalTransactionScanner</code>  能够很自然的使用 Spring 环境</li>
<li><code>InitializingBean</code> ： 继承这个接口，需要实现  <code>afterPropertiesSet()</code>  ，但凡是继承这个接口的类，在初始化的时候，当所有的  <code>properties</code>  设置完成以后，会执行这个方法</li>
<li><code>DisposableBean</code>  ： 这个类，实现了一个  <code>destroy()</code>  这个方法是在销毁的时候去调用</li>
<li><code>AbstractAutoProxyCreator</code> ： 这个类是 Spring 实现 AOP 的一种方式，本质上是一个  <code>BeanPostProcessor</code>  ，在 Bean 初始化至去年，调用内部  <code>createProxy()</code>  ，创建一个 Bean 的 AOP 代理 Bean 并返回，对 Bean 进行增强。</li>
</ul>
<h2 id="seata数据源代理"><a class="markdownIt-Anchor" href="#seata数据源代理">#</a> Seata 数据源代理</h2>
<p>在上面的环节中，我们讲解了 Seata AT 模式 2PC 的执行流程，那么现在我们就来带大家了解一下关于 AT 数据源代理的信息，这也是 AT 模式中非常关键的一个重要知识点，大家可以拿起小本子，记下来。</p>
<p>首先 AT 模式的核心主要分为一下两个</p>
<ul>
<li>开启全局事务，获取全局锁。</li>
<li>解析 SQL 并写入 undoLog 中。</li>
</ul>
<p>关于第一点我们已经分析清楚了，第二点就是关于 AT 模式如何解析 SQL 并写入 undoLog 中，但是在这之前，我们需要知道 Seata 是如何选择数据源，并进行数据源代理的。虽然全局事务拦截成功后最终还是执行了业务方法进行 SQL 提交和操作，但是由于 Seata 对数据源进行了代理，所以 SQL 的解析和 undoLog 的操作，是在数据源代理中进行完成的。</p>
<p>数据源代理是 Seata 中一个非常重要的知识点，在<a target="_blank" rel="noopener" href="https://so.csdn.net/so/search?q=%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1&amp;spm=1001.2101.3001.7020">分布式事务</a>运行过程中，undoLog 的记录、资源的锁定，用户都是无感知的，因为这些操作都是数据源的代理中完成了，恰恰是这样，我们才要去了解，这样不仅有利于我们了解 Seata 的核心操作，还能对以后源码阅读有所帮助，因为其实很多底层代码都会去使用这样用户无感知的方式 (代理) 去实现。</p>
<p>同样，我们在之前的寻找源码入口的时候，通过我们项目中引入的 jar 找到一个  <code>SeataAutoConfiguration</code>  类，我们在里面找到一个 <code>SeataDataSourceBeanPostProcessor()</code> ，这个就是我们数据源代理的入口方法</p>
<p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/78c4564099e2c372a310458314d545e9.png" alt="img"></p>
<p>我们进入 <code>SeataDataSourceBeanPostProcessor</code>  类里面，发现继承了一个  <code>BeanPostProcessor</code>  , 这个接口我们应该很熟悉，这个是 Sprng 的拓展接口，所有的 Bean 对象，都有进入两个方法  <code>postProcessAfterInitialization()</code>  和  <code>postProcessBeforeInitialization()</code>  这两个方法都是由  <code>BeanPostProcessor</code>  提供的，这两个方法，一个是初始化之前执行 <code>Before</code> 。一个是在初始化之后执行 <code>After</code> ，主要用来对比我们的的 Bean 是否为数据源代理对象。</p>
<p>在这里我们需要关注到一个 <code>postProcessAfterInitialization.proxyDataSource()</code>  方法，这个里面</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> Object <span class="title function_">proxyDataSource</span><span class="params">(Object originBean)</span> &#123;</span><br><span class="line">    <span class="type">DataSourceProxy</span> <span class="variable">dataSourceProxy</span> <span class="operator">=</span> DataSourceProxyHolder.get().putDataSource((DataSource) originBean);</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">this</span>.useJdkProxy) &#123;</span><br><span class="line">        <span class="keyword">return</span> Proxy.newProxyInstance(Thread.currentThread().getContextClassLoader(), SpringProxyUtils.getAllInterfaces(originBean), (proxy, method, args) -&gt; handleMethodProxy(dataSourceProxy, method, args, originBean));</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> Enhancer.create(originBean.getClass(), (MethodInterceptor) (proxy, method, args, methodProxy) -&gt; handleMethodProxy(dataSourceProxy, method, args, originBean));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里有一个 <code>DataSourceProxy</code>  代理对象，我们需要看的就是这个类，这个就是我们数据库代理的对象，我们从我们下载的源码项目中，搜索这个代理对象，当我们打开这个类的目录时发现，除了这个，还有 <code>ConnectionProxy</code>  连接对象、 <code>StatementProxy</code> 、 <code>PreparedStatementProxy</code>  SQL 执行对象，这些都被 Seata 进行了代理，为什么要对这些都进行代理，代理的目的其实为了执行 Seata 的业务逻辑，生成 undoLog，全局事务的开启，事务的提交回滚等操作</p>
<p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/ef54a9c5142d96cf230b7938f60a9145.png" alt="img"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">DataSourceProxy` 具体做了什么，主要功能有哪些，我们来看一下。他在源码中是如何体现的，我们需要关注的是`init()</span><br><span class="line">public class DataSourceProxy extends AbstractDataSourceProxy implements Resource &#123;</span><br><span class="line"></span><br><span class="line">    private String resourceGroupId;</span><br><span class="line"></span><br><span class="line">    private void init(DataSource dataSource, String resourceGroupId) &#123;</span><br><span class="line">        //资源组ID，默认是“default”这个默认值</span><br><span class="line">        this.resourceGroupId = resourceGroupId;</span><br><span class="line">        try (Connection connection = dataSource.getConnection()) &#123;</span><br><span class="line">            //根据原始数据源得到JDBC连接和数据库类型</span><br><span class="line">            jdbcUrl = connection.getMetaData().getURL();</span><br><span class="line">            dbType = JdbcUtils.getDbType(jdbcUrl);</span><br><span class="line">            if (JdbcConstants.ORACLE.equals(dbType)) &#123;</span><br><span class="line">                userName = connection.getMetaData().getUserName();</span><br><span class="line">            &#125; else if (JdbcConstants.MARIADB.equals(dbType)) &#123;</span><br><span class="line">                dbType = JdbcConstants.MYSQL;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; catch (SQLException e) &#123;</span><br><span class="line">            throw new IllegalStateException(&quot;can not init dataSource&quot;, e);</span><br><span class="line">        &#125;</span><br><span class="line">        initResourceId();</span><br><span class="line">        DefaultResourceManager.get().registerResource(this);</span><br><span class="line">        if (ENABLE_TABLE_META_CHECKER_ENABLE) &#123;</span><br><span class="line">            //如果配置开关打开，会定时在线程池不断更新表的元数据缓存信息</span><br><span class="line">            tableMetaExecutor.scheduleAtFixedRate(() -&gt; &#123;</span><br><span class="line">                try (Connection connection = dataSource.getConnection()) &#123;</span><br><span class="line">                    TableMetaCacheFactory.getTableMetaCache(DataSourceProxy.this.getDbType())</span><br><span class="line">                        .refresh(connection, DataSourceProxy.this.getResourceId());</span><br><span class="line">                &#125; catch (Exception ignore) &#123;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;, 0, TABLE_META_CHECKER_INTERVAL, TimeUnit.MILLISECONDS);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        //Set the default branch type to &#x27;AT&#x27; in the RootContext.</span><br><span class="line">        RootContext.setDefaultBranchType(this.getBranchType());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>从上面我们可以看出，他主要做了以下几点的增强：</p>
<ol>
<li>给每个数据源标识资源组 ID</li>
<li>如果打开配置，会有一个定时线程池定时更新表的元数据信息并缓存到本地</li>
<li>生成代理连接  <code>ConnectionProxy</code>  对象</li>
</ol>
<p>在这三个增强功能里面，第三个是最重要的，在 AT 模式里面，会自动记录 undoLog，资源锁定，都是通过 <code>ConnectionProxy</code>  完成的，除此之外  <code>DataSrouceProxy</code>  重写了一个方法  <code>getConnection</code> ，因为这里返回的是一个  <code>ConnectionProxy</code> ，而不是原生的 <code>Connection</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> ConnectionProxy <span class="title function_">getConnection</span><span class="params">()</span> <span class="keyword">throws</span> SQLException &#123;</span><br><span class="line">    <span class="type">Connection</span> <span class="variable">targetConnection</span> <span class="operator">=</span> targetDataSource.getConnection();</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ConnectionProxy</span>(<span class="built_in">this</span>, targetConnection);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> ConnectionProxy <span class="title function_">getConnection</span><span class="params">(String username, String password)</span> <span class="keyword">throws</span> SQLException &#123;</span><br><span class="line">    <span class="type">Connection</span> <span class="variable">targetConnection</span> <span class="operator">=</span> targetDataSource.getConnection(username, password);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ConnectionProxy</span>(<span class="built_in">this</span>, targetConnection);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="connectionproxy"><a class="markdownIt-Anchor" href="#connectionproxy">#</a> ConnectionProxy</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ConnectionProxy` 继承 `AbstractConnectionProxy` ，在这个父类中有很多公用的方法，在这个父类有 `PreparedStatementProxy` 、`StatementProxy` 、`DataSourceProxy</span><br></pre></td></tr></table></figure>
<p><img src="https://img-blog.csdnimg.cn/img_convert/f16ce360addfb4ffbc43b040f0493fc5.png" alt="img"></p>
<p>所以我们需要先来看一下 <code>AbstractConnectionProxy</code> ，因为这里封装了需要我们用到的通用方法和逻辑，在其中我们需要关注的主要在于  <code>PreparedStatementProxy</code>  和  <code>StatementProxy</code>  ，在这里的逻辑主要是数据源连接的步骤，连接获取，创建执行对象等等</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Statement <span class="title function_">createStatement</span><span class="params">()</span> <span class="keyword">throws</span> SQLException &#123;</span><br><span class="line">    <span class="comment">//调用真实连接对象获取Statement对象</span></span><br><span class="line">    <span class="type">Statement</span> <span class="variable">targetStatement</span> <span class="operator">=</span> getTargetConnection().createStatement();</span><br><span class="line">    <span class="comment">//创建Statement的代理</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">StatementProxy</span>(<span class="built_in">this</span>, targetStatement);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> PreparedStatement <span class="title function_">prepareStatement</span><span class="params">(String sql)</span> <span class="keyword">throws</span> SQLException &#123;</span><br><span class="line">    <span class="comment">//获取数据库类型 mysql/oracle</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">dbType</span> <span class="operator">=</span> getDbType();</span><br><span class="line">    <span class="comment">// support oracle 10.2+</span></span><br><span class="line">    <span class="type">PreparedStatement</span> <span class="variable">targetPreparedStatement</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="comment">//如果是AT模式且开启全局事务</span></span><br><span class="line">    <span class="keyword">if</span> (BranchType.AT == RootContext.getBranchType()) &#123;</span><br><span class="line">        List&lt;SQLRecognizer&gt; sqlRecognizers = SQLVisitorFactory.get(sql, dbType);</span><br><span class="line">        <span class="keyword">if</span> (sqlRecognizers != <span class="literal">null</span> &amp;&amp; sqlRecognizers.size() == <span class="number">1</span>) &#123;</span><br><span class="line">            <span class="type">SQLRecognizer</span> <span class="variable">sqlRecognizer</span> <span class="operator">=</span> sqlRecognizers.get(<span class="number">0</span>);</span><br><span class="line">            <span class="keyword">if</span> (sqlRecognizer != <span class="literal">null</span> &amp;&amp; sqlRecognizer.getSQLType() == SQLType.INSERT) &#123;</span><br><span class="line">                <span class="comment">//获取表的元数据</span></span><br><span class="line">                <span class="type">TableMeta</span> <span class="variable">tableMeta</span> <span class="operator">=</span> TableMetaCacheFactory.getTableMetaCache(dbType).getTableMeta(getTargetConnection(),</span><br><span class="line">                        sqlRecognizer.getTableName(), getDataSourceProxy().getResourceId());</span><br><span class="line">                <span class="comment">//得到表的主键列名</span></span><br><span class="line">                String[] pkNameArray = <span class="keyword">new</span> <span class="title class_">String</span>[tableMeta.getPrimaryKeyOnlyName().size()];</span><br><span class="line">                tableMeta.getPrimaryKeyOnlyName().toArray(pkNameArray);</span><br><span class="line">                targetPreparedStatement = getTargetConnection().prepareStatement(sql,pkNameArray);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (targetPreparedStatement == <span class="literal">null</span>) &#123;</span><br><span class="line">        targetPreparedStatement = getTargetConnection().prepareStatement(sql);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//创建PreparedStatementProxy代理</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">PreparedStatementProxy</span>(<span class="built_in">this</span>, targetPreparedStatement, sql);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在这两个代理对象中，都用到了以下几个方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> ResultSet <span class="title function_">executeQuery</span><span class="params">(String sql)</span> <span class="keyword">throws</span> SQLException &#123;</span><br><span class="line">    <span class="built_in">this</span>.targetSQL = sql;</span><br><span class="line">    <span class="keyword">return</span> ExecuteTemplate.execute(<span class="built_in">this</span>, (statement, args) -&gt; statement.executeQuery((String) args[<span class="number">0</span>]), sql);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">executeUpdate</span><span class="params">(String sql)</span> <span class="keyword">throws</span> SQLException &#123;</span><br><span class="line">    <span class="built_in">this</span>.targetSQL = sql;</span><br><span class="line">    <span class="keyword">return</span> ExecuteTemplate.execute(<span class="built_in">this</span>, (statement, args) -&gt; statement.executeUpdate((String) args[<span class="number">0</span>]), sql);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">execute</span><span class="params">(String sql)</span> <span class="keyword">throws</span> SQLException &#123;</span><br><span class="line">    <span class="built_in">this</span>.targetSQL = sql;</span><br><span class="line">    <span class="keyword">return</span> ExecuteTemplate.execute(<span class="built_in">this</span>, (statement, args) -&gt; statement.execute((String) args[<span class="number">0</span>]), sql);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>在这些方法中都调用了  <code>ExecuteTemplate.execute()</code> ，所以我们就看一下在  <code>ExecuteTemplate</code>  类中具体是做了什么操作：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ExecuteTemplate</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T, S <span class="keyword">extends</span> <span class="title class_">Statement</span>&gt; T <span class="title function_">execute</span><span class="params">(List&lt;SQLRecognizer&gt; sqlRecognizers,</span></span><br><span class="line"><span class="params">                                                     StatementProxy&lt;S&gt; statementProxy,</span></span><br><span class="line"><span class="params">                                                     StatementCallback&lt;T, S&gt; statementCallback,</span></span><br><span class="line"><span class="params">                                                     Object... args)</span> <span class="keyword">throws</span> SQLException &#123;</span><br><span class="line">        <span class="comment">//如果没有全局锁，并且不是AT模式，直接执行SQL</span></span><br><span class="line">        <span class="keyword">if</span> (!RootContext.requireGlobalLock() &amp;&amp; BranchType.AT != RootContext.getBranchType()) &#123;</span><br><span class="line">            <span class="comment">// Just work as original statement</span></span><br><span class="line">            <span class="keyword">return</span> statementCallback.execute(statementProxy.getTargetStatement(), args);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//得到数据库类型- mysql/oracle</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">dbType</span> <span class="operator">=</span> statementProxy.getConnectionProxy().getDbType();</span><br><span class="line">        <span class="keyword">if</span> (CollectionUtils.isEmpty(sqlRecognizers)) &#123;</span><br><span class="line">            <span class="comment">//sqlRecognizers 为SQL语句的解析器，获取执行的SQL，通过它可以获得SQL语句表名、相关的列名、类型等信息，最后解析出对应的SQL表达式</span></span><br><span class="line">            sqlRecognizers = SQLVisitorFactory.get(</span><br><span class="line">                    statementProxy.getTargetSQL(),</span><br><span class="line">                    dbType);</span><br><span class="line">        &#125;</span><br><span class="line">        Executor&lt;T&gt; executor;</span><br><span class="line">        <span class="keyword">if</span> (CollectionUtils.isEmpty(sqlRecognizers)) &#123;</span><br><span class="line">            <span class="comment">//如果seata没有找到合适的SQL语句解析器，那么便创建简单执行器PlainExecutor</span></span><br><span class="line">            <span class="comment">//PlainExecutor直接使用原生的Statment对象执行SQL</span></span><br><span class="line">            executor = <span class="keyword">new</span> <span class="title class_">PlainExecutor</span>&lt;&gt;(statementProxy, statementCallback);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (sqlRecognizers.size() == <span class="number">1</span>) &#123;</span><br><span class="line">                <span class="type">SQLRecognizer</span> <span class="variable">sqlRecognizer</span> <span class="operator">=</span> sqlRecognizers.get(<span class="number">0</span>);</span><br><span class="line">                <span class="keyword">switch</span> (sqlRecognizer.getSQLType()) &#123;</span><br><span class="line">                    <span class="comment">//新增</span></span><br><span class="line">                    <span class="keyword">case</span> INSERT:</span><br><span class="line">                        executor = EnhancedServiceLoader.load(InsertExecutor.class, dbType,</span><br><span class="line">                                    <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;StatementProxy.class, StatementCallback.class, SQLRecognizer.class&#125;,</span><br><span class="line">                                    <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;statementProxy, statementCallback, sqlRecognizer&#125;);</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                        <span class="comment">//修改</span></span><br><span class="line">                    <span class="keyword">case</span> UPDATE:</span><br><span class="line">                        executor = <span class="keyword">new</span> <span class="title class_">UpdateExecutor</span>&lt;&gt;(statementProxy, statementCallback, sqlRecognizer);</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                        <span class="comment">//删除</span></span><br><span class="line">                    <span class="keyword">case</span> DELETE:</span><br><span class="line">                        executor = <span class="keyword">new</span> <span class="title class_">DeleteExecutor</span>&lt;&gt;(statementProxy, statementCallback, sqlRecognizer);</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                        <span class="comment">//加锁</span></span><br><span class="line">                    <span class="keyword">case</span> SELECT_FOR_UPDATE:</span><br><span class="line">                        executor = <span class="keyword">new</span> <span class="title class_">SelectForUpdateExecutor</span>&lt;&gt;(statementProxy, statementCallback, sqlRecognizer);</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                        <span class="comment">//插入加锁</span></span><br><span class="line">                    <span class="keyword">case</span> INSERT_ON_DUPLICATE_UPDATE:</span><br><span class="line">                        <span class="keyword">switch</span> (dbType) &#123;</span><br><span class="line">                            <span class="keyword">case</span> JdbcConstants.MYSQL:</span><br><span class="line">                            <span class="keyword">case</span> JdbcConstants.MARIADB:</span><br><span class="line">                                executor =</span><br><span class="line">                                    <span class="keyword">new</span> <span class="title class_">MySQLInsertOrUpdateExecutor</span>(statementProxy, statementCallback, sqlRecognizer);</span><br><span class="line">                                <span class="keyword">break</span>;</span><br><span class="line">                            <span class="keyword">default</span>:</span><br><span class="line">                                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">NotSupportYetException</span>(dbType + <span class="string">&quot; not support to INSERT_ON_DUPLICATE_UPDATE&quot;</span>);</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                        <span class="comment">//原生</span></span><br><span class="line">                    <span class="keyword">default</span>:</span><br><span class="line">                        executor = <span class="keyword">new</span> <span class="title class_">PlainExecutor</span>&lt;&gt;(statementProxy, statementCallback);</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">//批量处理SQL语句</span></span><br><span class="line">                executor = <span class="keyword">new</span> <span class="title class_">MultiExecutor</span>&lt;&gt;(statementProxy, statementCallback, sqlRecognizers);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        T rs;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//执行</span></span><br><span class="line">            rs = executor.execute(args);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable ex) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!(ex <span class="keyword">instanceof</span> SQLException)) &#123;</span><br><span class="line">                <span class="comment">// Turn other exception into SQLException</span></span><br><span class="line">                ex = <span class="keyword">new</span> <span class="title class_">SQLException</span>(ex);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">throw</span> (SQLException) ex;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> rs;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在  <code>ExecuteTemplate</code>  就一个  <code>execute()</code> ，Seata 将 SQL 执行委托给不同的执行器 (模板)，Seata 提供了 6 种执行器也就是我们代码 case 中（ <code>INSERT</code> ， <code>UPDATE</code> ， <code>DELETE</code> ， <code>SELECT_FOR_UPDATE</code> , <code>INSERT_ON_DUPLICATE_UPDATE</code> ），这些执行器的父类都是 <code>AbstractDMLBaseExecutor</code></p>
<ul>
<li><code>UpdateExecutor</code> : 执行 update 语句</li>
<li><code>InsertExecutor</code> : 执行 insert 语句</li>
<li><code>DeleteExecutor</code> : 执行 delete 语句</li>
<li><code>SelectForUpdateExecutor</code> : 执行 select for update 语句</li>
<li><code>PlainExecutor</code> : 执行普通查询语句</li>
<li><code>MultiExecutor</code> : 复合执行器，在一条 SQL 语句中执行多条语句</li>
</ul>
<p>关系图如下：</p>
<p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/f16af649be708d3642cf86a1c451fcf7.png" alt="img"></p>
<p>然后我们找到 <code> rs = executor.execute(args);</code>  最终执行的方法，找到最顶级的父类 <code>BaseTransactionalExecutor.execute()</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> T <span class="title function_">execute</span><span class="params">(Object... args)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">xid</span> <span class="operator">=</span> RootContext.getXID();</span><br><span class="line">    <span class="keyword">if</span> (xid != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">//获取XID</span></span><br><span class="line">        statementProxy.getConnectionProxy().bind(xid);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//设置全局锁</span></span><br><span class="line">    statementProxy.getConnectionProxy().setGlobalLockRequire(RootContext.requireGlobalLock());</span><br><span class="line">    <span class="keyword">return</span> doExecute(args);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在根据 <code>doExecute(args);</code>  找到其中的重写方法  <code>AbstractDMLBaseExecutor.doExecute()</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> T <span class="title function_">doExecute</span><span class="params">(Object... args)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">    <span class="type">AbstractConnectionProxy</span> <span class="variable">connectionProxy</span> <span class="operator">=</span> statementProxy.getConnectionProxy();</span><br><span class="line">    <span class="comment">//是否自动提交</span></span><br><span class="line">    <span class="keyword">if</span> (connectionProxy.getAutoCommit()) &#123;</span><br><span class="line">        <span class="keyword">return</span> executeAutoCommitTrue(args);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> executeAutoCommitFalse(args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>对于数据库而言，本身都是自动提交的，所以我们进入 <code>executeAutoCommitTrue()</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">    <span class="keyword">protected</span> T <span class="title function_">executeAutoCommitTrue</span><span class="params">(Object[] args)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">        <span class="type">ConnectionProxy</span> <span class="variable">connectionProxy</span> <span class="operator">=</span> statementProxy.getConnectionProxy();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//设置为手动提交</span></span><br><span class="line">            connectionProxy.changeAutoCommit();</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">LockRetryPolicy</span>(connectionProxy).execute(() -&gt; &#123;</span><br><span class="line">                <span class="comment">//调用手动提交方法，得到分支执行的最终结果</span></span><br><span class="line">                <span class="type">T</span> <span class="variable">result</span> <span class="operator">=</span> executeAutoCommitFalse(args);</span><br><span class="line">                <span class="comment">//执行提交</span></span><br><span class="line">                connectionProxy.commit();</span><br><span class="line">                <span class="keyword">return</span> result;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="comment">// when exception occur in finally,this exception will lost, so just print it here</span></span><br><span class="line">            LOGGER.error(<span class="string">&quot;execute executeAutoCommitTrue error:&#123;&#125;&quot;</span>, e.getMessage(), e);</span><br><span class="line">            <span class="keyword">if</span> (!LockRetryPolicy.isLockRetryPolicyBranchRollbackOnConflict()) &#123;</span><br><span class="line">                connectionProxy.getTargetConnection().rollback();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">throw</span> e;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            connectionProxy.getContext().reset();</span><br><span class="line">            connectionProxy.setAutoCommit(<span class="literal">true</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">connectionProxy.changeAutoCommit()`方法，修改为手动提交后，我们看来最关键的代码`executeAutoCommitFalse()</span><br><span class="line">    <span class="keyword">protected</span> T <span class="title function_">executeAutoCommitFalse</span><span class="params">(Object[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="keyword">if</span> (!JdbcConstants.MYSQL.equalsIgnoreCase(getDbType()) &amp;&amp; isMultiPk()) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">NotSupportYetException</span>(<span class="string">&quot;multi pk only support mysql!&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//获取前镜像</span></span><br><span class="line">        <span class="type">TableRecords</span> <span class="variable">beforeImage</span> <span class="operator">=</span> beforeImage();</span><br><span class="line">        <span class="comment">//执行具体业务</span></span><br><span class="line">        <span class="type">T</span> <span class="variable">result</span> <span class="operator">=</span> statementCallback.execute(statementProxy.getTargetStatement(), args);</span><br><span class="line">        <span class="comment">//获取执行数量</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">updateCount</span> <span class="operator">=</span> statementProxy.getUpdateCount();</span><br><span class="line">        <span class="comment">//判断如果执行数量大于0</span></span><br><span class="line">        <span class="keyword">if</span> (updateCount &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">//获取后镜像</span></span><br><span class="line">            <span class="type">TableRecords</span> <span class="variable">afterImage</span> <span class="operator">=</span> afterImage(beforeImage);</span><br><span class="line">            <span class="comment">//暂存到undolog中，在Commit的时候保存到数据库</span></span><br><span class="line">            prepareUndoLog(beforeImage, afterImage);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>我们再回到 <code>executeAutoCommitTrue</code>  中，去看看提交做了哪些操作 <code>connectionProxy.commit();</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">commit</span><span class="params">()</span> <span class="keyword">throws</span> SQLException &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        lockRetryPolicy.execute(() -&gt; &#123;</span><br><span class="line">            <span class="comment">//具体执行</span></span><br><span class="line">            doCommit();</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (SQLException e) &#123;</span><br><span class="line">        <span class="keyword">if</span> (targetConnection != <span class="literal">null</span> &amp;&amp; !getAutoCommit() &amp;&amp; !getContext().isAutoCommitChanged()) &#123;</span><br><span class="line">            rollback();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">throw</span> e;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">SQLException</span>(e);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>进入到 <code>doCommit()</code>  中</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">doCommit</span><span class="params">()</span> <span class="keyword">throws</span> SQLException &#123;</span><br><span class="line">    <span class="comment">//判断是否存在全局事务</span></span><br><span class="line">    <span class="keyword">if</span> (context.inGlobalTransaction()) &#123;</span><br><span class="line">        processGlobalTransactionCommit();</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (context.isGlobalLockRequire()) &#123;</span><br><span class="line">        processLocalCommitWithGlobalLocks();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        targetConnection.commit();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>作为分布式事务，一定是存在全局事务的，所以我们进入  <code>processGlobalTransactionCommit()</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">processGlobalTransactionCommit</span><span class="params">()</span> <span class="keyword">throws</span> SQLException &#123;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">          <span class="comment">//注册分支事务</span></span><br><span class="line">          register();</span><br><span class="line">      &#125; <span class="keyword">catch</span> (TransactionException e) &#123;</span><br><span class="line">          recognizeLockKeyConflictException(e, context.buildLockKeys());</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">          <span class="comment">//写入数据库undolog</span></span><br><span class="line">          UndoLogManagerFactory.getUndoLogManager(<span class="built_in">this</span>.getDbType()).flushUndoLogs(<span class="built_in">this</span>);</span><br><span class="line">          <span class="comment">//执行原生提交 一阶段提交</span></span><br><span class="line">          targetConnection.commit();</span><br><span class="line">      &#125; <span class="keyword">catch</span> (Throwable ex) &#123;</span><br><span class="line">          LOGGER.error(<span class="string">&quot;process connectionProxy commit error: &#123;&#125;&quot;</span>, ex.getMessage(), ex);</span><br><span class="line">          report(<span class="literal">false</span>);</span><br><span class="line">          <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">SQLException</span>(ex);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (IS_REPORT_SUCCESS_ENABLE) &#123;</span><br><span class="line">          report(<span class="literal">true</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      context.reset();</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>其中 <code>register()</code>  方法就是注册分支事务的方法，同时还会将 undoLog 写入数据库和执行提交等操作</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//注册分支事务，生成分支事务ID</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">register</span><span class="params">()</span> <span class="keyword">throws</span> TransactionException &#123;</span><br><span class="line">    <span class="keyword">if</span> (!context.hasUndoLog() || !context.hasLockKey()) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//注册分支事务</span></span><br><span class="line">    <span class="type">Long</span> <span class="variable">branchId</span> <span class="operator">=</span> DefaultResourceManager.get().branchRegister(BranchType.AT, getDataSourceProxy().getResourceId(),</span><br><span class="line">        <span class="literal">null</span>, context.getXid(), context.getApplicationData(), context.buildLockKeys());</span><br><span class="line">    context.setBranchId(branchId);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后我们在回到 <code>processGlobalTransactionCommit</code>  中，看看写入数据库中的 <code>flushUndoLogs()</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">flushUndoLogs</span><span class="params">(ConnectionProxy cp)</span> <span class="keyword">throws</span> SQLException &#123;</span><br><span class="line">       <span class="type">ConnectionContext</span> <span class="variable">connectionContext</span> <span class="operator">=</span> cp.getContext();</span><br><span class="line">       <span class="keyword">if</span> (!connectionContext.hasUndoLog()) &#123;</span><br><span class="line">           <span class="keyword">return</span>;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="comment">//获取XID</span></span><br><span class="line">       <span class="type">String</span> <span class="variable">xid</span> <span class="operator">=</span> connectionContext.getXid();</span><br><span class="line">       <span class="comment">//获取分支ID</span></span><br><span class="line">       <span class="type">long</span> <span class="variable">branchId</span> <span class="operator">=</span> connectionContext.getBranchId();</span><br><span class="line"></span><br><span class="line">       <span class="type">BranchUndoLog</span> <span class="variable">branchUndoLog</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BranchUndoLog</span>();</span><br><span class="line">       branchUndoLog.setXid(xid);</span><br><span class="line">       branchUndoLog.setBranchId(branchId);</span><br><span class="line">       branchUndoLog.setSqlUndoLogs(connectionContext.getUndoItems());</span><br><span class="line"></span><br><span class="line">       <span class="type">UndoLogParser</span> <span class="variable">parser</span> <span class="operator">=</span> UndoLogParserFactory.getInstance();</span><br><span class="line">       <span class="type">byte</span>[] undoLogContent = parser.encode(branchUndoLog);</span><br><span class="line"></span><br><span class="line">       <span class="keyword">if</span> (LOGGER.isDebugEnabled()) &#123;</span><br><span class="line">           LOGGER.debug(<span class="string">&quot;Flushing UNDO LOG: &#123;&#125;&quot;</span>, <span class="keyword">new</span> <span class="title class_">String</span>(undoLogContent, Constants.DEFAULT_CHARSET));</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="type">CompressorType</span> <span class="variable">compressorType</span> <span class="operator">=</span> CompressorType.NONE;</span><br><span class="line">       <span class="keyword">if</span> (needCompress(undoLogContent)) &#123;</span><br><span class="line">           compressorType = ROLLBACK_INFO_COMPRESS_TYPE;</span><br><span class="line">           undoLogContent = CompressorFactory.getCompressor(compressorType.getCode()).compress(undoLogContent);</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="comment">//写入数据库具体位置</span></span><br><span class="line">       insertUndoLogWithNormal(xid, branchId, buildContext(parser.getName(), compressorType), undoLogContent, cp.getTargetConnection());</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>具体写入方法，此时我们使用的是 MySql，所以执行的是 MySql 实现类 <code>MySQLUndoLogManager.insertUndoLogWithNormal()</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">insertUndoLogWithNormal</span><span class="params">(String xid, <span class="type">long</span> branchId, String rollbackCtx, <span class="type">byte</span>[] undoLogContent,</span></span><br><span class="line"><span class="params">                                       Connection conn)</span> <span class="keyword">throws</span> SQLException &#123;</span><br><span class="line">    insertUndoLog(xid, branchId, rollbackCtx, undoLogContent, State.Normal, conn);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//具体写入操作</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">insertUndoLog</span><span class="params">(String xid, <span class="type">long</span> branchId, String rollbackCtx, <span class="type">byte</span>[] undoLogContent,</span></span><br><span class="line"><span class="params">                           State state, Connection conn)</span> <span class="keyword">throws</span> SQLException &#123;</span><br><span class="line">    <span class="keyword">try</span> (<span class="type">PreparedStatement</span> <span class="variable">pst</span> <span class="operator">=</span> conn.prepareStatement(INSERT_UNDO_LOG_SQL)) &#123;</span><br><span class="line">        pst.setLong(<span class="number">1</span>, branchId);</span><br><span class="line">        pst.setString(<span class="number">2</span>, xid);</span><br><span class="line">        pst.setString(<span class="number">3</span>, rollbackCtx);</span><br><span class="line">        pst.setBytes(<span class="number">4</span>, undoLogContent);</span><br><span class="line">        pst.setInt(<span class="number">5</span>, state.getValue());</span><br><span class="line">        pst.executeUpdate();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!(e <span class="keyword">instanceof</span> SQLException)) &#123;</span><br><span class="line">            e = <span class="keyword">new</span> <span class="title class_">SQLException</span>(e);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">throw</span> (SQLException) e;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>具体流程如下所示：</p>
<p><img src="https://img-blog.csdnimg.cn/img_convert/cc94f7cbd5363484c839ed9e69b95c5d.png" alt="img"></p>
<h2 id="seata-服务端"><a class="markdownIt-Anchor" href="#seata-服务端">#</a> Seata 服务端</h2>
<p>我们找到 <code>Server.java</code>  这里就是启动入口，在这个入口中找到协调者，因为 TC 整体的操作就是协调整体的全局事务</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//默认协调者</span></span><br><span class="line"><span class="type">DefaultCoordinator</span> <span class="variable">coordinator</span> <span class="operator">=</span> DefaultCoordinator.getInstance(nettyRemotingServer);</span><br></pre></td></tr></table></figure>
<p>在 <code>DefaultCoordinator</code>  类中我们找到 一个 <code>doGlobalBegin</code>  这个就是处理全局事务开始的方法，以及全局提交  <code>doGlobalCommit</code>  和全局回滚  <code>doGlobalRollback</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">    <span class="comment">//处理全局事务</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">doGlobalBegin</span><span class="params">(GlobalBeginRequest request, GlobalBeginResponse response, RpcContext rpcContext)</span><span class="keyword">throws</span> TransactionException &#123;</span><br><span class="line">        <span class="comment">//响应客户端xid</span></span><br><span class="line">response.setXid(core.begin(rpcContext.getApplicationId(), rpcContext.getTransactionServiceGroup(),</span><br><span class="line">                request.getTransactionName(), request.getTimeout()));</span><br><span class="line"><span class="keyword">if</span> (LOGGER.isInfoEnabled()) &#123;</span><br><span class="line">    LOGGER.info(<span class="string">&quot;Begin new global transaction applicationId: &#123;&#125;,transactionServiceGroup: &#123;&#125;, transactionName: &#123;&#125;,timeout:&#123;&#125;,xid:&#123;&#125;&quot;</span>,</span><br><span class="line">       rpcContext.getApplicationId(), rpcContext.getTransactionServiceGroup(), request.getTransactionName(), request.getTimeout(), response.getXid());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">    </span><br><span class="line">        <span class="comment">//处理全局提交</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">doGlobalCommit</span><span class="params">(GlobalCommitRequest request, GlobalCommitResponse response, RpcContext rpcContext)</span><span class="keyword">throws</span> TransactionException &#123;</span><br><span class="line">     MDC.put(RootContext.MDC_KEY_XID, request.getXid());</span><br><span class="line">     response.setGlobalStatus(core.commit(request.getXid()));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//处理全局回滚</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">doGlobalRollback</span><span class="params">(GlobalRollbackRequest request, GlobalRollbackResponse response,</span></span><br><span class="line"><span class="params">                                    RpcContext rpcContext)</span> <span class="keyword">throws</span> TransactionException &#123;</span><br><span class="line">    MDC.put(RootContext.MDC_KEY_XID, request.getXid());</span><br><span class="line">    response.setGlobalStatus(core.rollback(request.getXid()));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在这里我们首先关注  <code>doGlobalBegin</code>  中  <code>core.begin()</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">begin</span><span class="params">(String applicationId, String transactionServiceGroup, String name, <span class="type">int</span> timeout)</span></span><br><span class="line">    <span class="keyword">throws</span> TransactionException &#123;</span><br><span class="line">    <span class="comment">//创建全局事务Session</span></span><br><span class="line">    <span class="type">GlobalSession</span> <span class="variable">session</span> <span class="operator">=</span> GlobalSession.createGlobalSession(applicationId, transactionServiceGroup, name,</span><br><span class="line">        timeout);</span><br><span class="line">    MDC.put(RootContext.MDC_KEY_XID, session.getXid());</span><br><span class="line"></span><br><span class="line">    <span class="comment">//为Session重添加回调监听，SessionHolder.getRootSessionManager() 获取一个全局Session管理器DataBaseSessionManager</span></span><br><span class="line">    <span class="comment">//观察者设计模式，创建DataBaseSessionManager</span></span><br><span class="line">    session.addSessionLifecycleListener(SessionHolder.getRootSessionManager());</span><br><span class="line"></span><br><span class="line">    <span class="comment">//全局事务开始</span></span><br><span class="line">    session.begin();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// transaction start event</span></span><br><span class="line">    MetricsPublisher.postSessionDoingEvent(session, <span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> session.getXid();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后我们在来看一下 <code>SessionHolder.getRootSessionManager()</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Gets root session manager.</span></span><br><span class="line"><span class="comment"> * 获取一个全局Session管理器</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> the root session manager</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> SessionManager <span class="title function_">getRootSessionManager</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (ROOT_SESSION_MANAGER == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ShouldNeverHappenException</span>(<span class="string">&quot;SessionManager is NOT init!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> ROOT_SESSION_MANAGER;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">(String mode)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (StringUtils.isBlank(mode)) &#123;</span><br><span class="line">        mode = CONFIG.getConfig(ConfigurationKeys.STORE_SESSION_MODE,</span><br><span class="line">                CONFIG.getConfig(ConfigurationKeys.STORE_MODE, SERVER_DEFAULT_STORE_MODE));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">StoreMode</span> <span class="variable">storeMode</span> <span class="operator">=</span> StoreMode.get(mode);</span><br><span class="line">    <span class="comment">//判断Seata模式，当前为DB</span></span><br><span class="line">    <span class="keyword">if</span> (StoreMode.DB.equals(storeMode)) &#123;</span><br><span class="line">        <span class="comment">//通过SPI机制读取SessionManager接口实现类，读取的META-INF.services目录，在通过反射机制创建对象DataBaseSessionManager</span></span><br><span class="line">        ROOT_SESSION_MANAGER = EnhancedServiceLoader.load(SessionManager.class, StoreMode.DB.getName());</span><br><span class="line">        ........</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在这里他其实读取的是 DB 模式下  <code>io.seata.server.session.SessionManager</code>  文件的内容</p>
<p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/4dd908fc36e0128e646e3c8c0b03262a.png" alt="img"></p>
<p>我们在回到 <code>begin</code>  方法中，去查看 <code>session.begin()</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">begin</span><span class="params">()</span> <span class="keyword">throws</span> TransactionException &#123;</span><br><span class="line">    <span class="comment">//声明全局事务开始</span></span><br><span class="line">    <span class="built_in">this</span>.status = GlobalStatus.Begin;</span><br><span class="line">    <span class="comment">//开始时间</span></span><br><span class="line">    <span class="built_in">this</span>.beginTime = System.currentTimeMillis();</span><br><span class="line">    <span class="comment">//激活全局事务</span></span><br><span class="line">    <span class="built_in">this</span>.active = <span class="literal">true</span>;</span><br><span class="line">    <span class="comment">//将SessionManager放入到集合中，调用onBegin方法</span></span><br><span class="line">    <span class="keyword">for</span> (SessionLifecycleListener lifecycleListener : lifecycleListeners) &#123;</span><br><span class="line">        <span class="comment">//调用父级抽象类的方法</span></span><br><span class="line">        lifecycleListener.onBegin(<span class="built_in">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>这里我们来看一下  <code>onBegin()</code>  方法，调用的是父级的方法，在这其中我们要关注  <code>addGlobalSession()</code>  方法，但是要注意，这里我们用的是 db 模式所以调用的是 db 模式的  <code>DateBaseSessionManager</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onBegin</span><span class="params">(GlobalSession globalSession)</span> <span class="keyword">throws</span> TransactionException &#123;</span><br><span class="line">    <span class="comment">//这里调用的是DateBaseSessionManager</span></span><br><span class="line">    addGlobalSession(globalSession);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addGlobalSession</span><span class="params">(GlobalSession session)</span> <span class="keyword">throws</span> TransactionException &#123;</span><br><span class="line">    <span class="keyword">if</span> (StringUtils.isBlank(taskName)) &#123;</span><br><span class="line">        <span class="comment">//写入session</span></span><br><span class="line">        <span class="type">boolean</span> <span class="variable">ret</span> <span class="operator">=</span> transactionStoreManager.writeSession(LogOperation.GLOBAL_ADD, session);</span><br><span class="line">        <span class="keyword">if</span> (!ret) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">StoreException</span>(<span class="string">&quot;addGlobalSession failed.&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">ret</span> <span class="operator">=</span> transactionStoreManager.writeSession(LogOperation.GLOBAL_UPDATE, session);</span><br><span class="line">        <span class="keyword">if</span> (!ret) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">StoreException</span>(<span class="string">&quot;addGlobalSession failed.&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后在看查询其中关键的方法 <code>DataBaseTransactionStoreManager.writeSession()</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">   <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">writeSession</span><span class="params">(LogOperation logOperation, SessionStorable session)</span> &#123;</span><br><span class="line">       <span class="comment">//第一次进入是写入 会进入当前方法</span></span><br><span class="line">       <span class="comment">//全局添加</span></span><br><span class="line">       <span class="keyword">if</span> (LogOperation.GLOBAL_ADD.equals(logOperation)) &#123;</span><br><span class="line">           <span class="keyword">return</span> logStore.insertGlobalTransactionDO(SessionConverter.convertGlobalTransactionDO(session));</span><br><span class="line">           <span class="comment">//全局修改</span></span><br><span class="line">       &#125; <span class="keyword">else</span> <span class="keyword">if</span> (LogOperation.GLOBAL_UPDATE.equals(logOperation)) &#123;</span><br><span class="line">           <span class="keyword">return</span> logStore.updateGlobalTransactionDO(SessionConverter.convertGlobalTransactionDO(session));</span><br><span class="line">           <span class="comment">//全局删除</span></span><br><span class="line">       &#125; <span class="keyword">else</span> <span class="keyword">if</span> (LogOperation.GLOBAL_REMOVE.equals(logOperation)) &#123;</span><br><span class="line">           <span class="keyword">return</span> logStore.deleteGlobalTransactionDO(SessionConverter.convertGlobalTransactionDO(session));</span><br><span class="line">           <span class="comment">//分支添加</span></span><br><span class="line">       &#125; <span class="keyword">else</span> <span class="keyword">if</span> (LogOperation.BRANCH_ADD.equals(logOperation)) &#123;</span><br><span class="line">           <span class="keyword">return</span> logStore.insertBranchTransactionDO(SessionConverter.convertBranchTransactionDO(session));</span><br><span class="line">           <span class="comment">//分支更新</span></span><br><span class="line">       &#125; <span class="keyword">else</span> <span class="keyword">if</span> (LogOperation.BRANCH_UPDATE.equals(logOperation)) &#123;</span><br><span class="line">           <span class="keyword">return</span> logStore.updateBranchTransactionDO(SessionConverter.convertBranchTransactionDO(session));</span><br><span class="line">           <span class="comment">//分支移除</span></span><br><span class="line">       &#125; <span class="keyword">else</span> <span class="keyword">if</span> (LogOperation.BRANCH_REMOVE.equals(logOperation)) &#123;</span><br><span class="line">           <span class="keyword">return</span> logStore.deleteBranchTransactionDO(SessionConverter.convertBranchTransactionDO(session));</span><br><span class="line">       &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">           <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">StoreException</span>(<span class="string">&quot;Unknown LogOperation:&quot;</span> + logOperation.name());</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>我们就看第一次进去的方法 <code>logStore.insertGlobalTransactionDO(SessionConverter.convertGlobalTransactionDO(session));</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"> <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">insertGlobalTransactionDO</span><span class="params">(GlobalTransactionDO globalTransactionDO)</span> &#123;</span><br><span class="line">     <span class="type">String</span> <span class="variable">sql</span> <span class="operator">=</span> LogStoreSqlsFactory.getLogStoreSqls(dbType).getInsertGlobalTransactionSQL(globalTable);</span><br><span class="line">     <span class="type">Connection</span> <span class="variable">conn</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">     <span class="type">PreparedStatement</span> <span class="variable">ps</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">     <span class="keyword">try</span> &#123;</span><br><span class="line">         <span class="type">int</span> <span class="variable">index</span> <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line">         conn = logStoreDataSource.getConnection();</span><br><span class="line">         conn.setAutoCommit(<span class="literal">true</span>);</span><br><span class="line">         ps = conn.prepareStatement(sql);</span><br><span class="line">         ps.setString(index++, globalTransactionDO.getXid());</span><br><span class="line">         ps.setLong(index++, globalTransactionDO.getTransactionId());</span><br><span class="line">         ps.setInt(index++, globalTransactionDO.getStatus());</span><br><span class="line">         ps.setString(index++, globalTransactionDO.getApplicationId());</span><br><span class="line">         ps.setString(index++, globalTransactionDO.getTransactionServiceGroup());</span><br><span class="line">         <span class="type">String</span> <span class="variable">transactionName</span> <span class="operator">=</span> globalTransactionDO.getTransactionName();</span><br><span class="line">         transactionName = transactionName.length() &gt; transactionNameColumnSize ?</span><br><span class="line">             transactionName.substring(<span class="number">0</span>, transactionNameColumnSize) :</span><br><span class="line">             transactionName;</span><br><span class="line">         ps.setString(index++, transactionName);</span><br><span class="line">         ps.setInt(index++, globalTransactionDO.getTimeout());</span><br><span class="line">         ps.setLong(index++, globalTransactionDO.getBeginTime());</span><br><span class="line">         ps.setString(index++, globalTransactionDO.getApplicationData());</span><br><span class="line">         <span class="keyword">return</span> ps.executeUpdate() &gt; <span class="number">0</span>;</span><br><span class="line">     &#125; <span class="keyword">catch</span> (SQLException e) &#123;</span><br><span class="line">         <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">StoreException</span>(e);</span><br><span class="line">     &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">         IOUtil.close(ps, conn);</span><br><span class="line">     &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<p>在这里有一个  <code>GlobalTransactionDO </code> 对象，里面有 <code>xid、transactionId</code>  等等，到这里是不是就很熟悉了、</p>
<p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/5649458fda2717fb7c87a5d8d0df2741.png" alt="img"></p>
<p>还记得我们第一次使用 Seata 的时候会创建三张表</p>
<ol>
<li>branch_table 分支事务表</li>
<li>global_table 全局事务表</li>
<li>lock_table 全局锁表</li>
</ol>
<p>而这里就是对应我们的 <code>global_table</code>  表，其他两个也是差不多，都是一样的操作</p>
<p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/6ef22513cae0ad8f2861cf18ec4cde0c.png" alt="img"><br>
 流程图如下：<br>
<img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/c33801b28bbae2a960f6b14856d4e8cf.png" alt="img"></p>
<h2 id="总结"><a class="markdownIt-Anchor" href="#总结">#</a> 总结</h2>
<p>完整流程图：</p>
<p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/e615279306d5aaf9ad85b8e2f9905a35.png" alt="img"></p>
<p>对于 Seata 源码来说主要是了解从哪里入口以及核心点在哪里，遇到有疑问的，可以 Debug，对于 Seata AT 模式，我们主要掌握的核心点是</p>
<ul>
<li>如何获取全局锁、开启全局事务</li>
<li>解析 SQL 并写入 undolog</li>
</ul>
<h2 id="关于我"><a class="markdownIt-Anchor" href="#关于我">#</a> 关于我</h2>
<p>Brath 是一个热爱技术的 Java 程序猿，公众号「InterviewCoder」定期分享有趣有料的精品原创文章！</p>
<p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/%E4%BA%8C%E7%BB%B4%E7%A0%81plus.png" alt="InterviewCoder"></p>
<p>非常感谢各位人才能看到这里，原创不易，文章如果有帮助可以关注、点赞、分享或评论，这都是对我的莫大支持！</p>
</div><div class="sharethis-inline-share-buttons"></div><script src="https://brath.cn" defer></script></article></div><div class="card"><div class="card-content"><h3 class="menu-label has-text-centered">喜欢这篇文章？打赏一下作者吧</h3><div class="buttons is-centered"><a class="button donate" href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener" data-type="afdian"><span class="icon is-small"><i class="fas fa-charging-station"></i></span><span>爱发电</span></a><a class="button donate" data-type="alipay"><span class="icon is-small"><i class="fab fa-alipay"></i></span><span>支付宝</span><span class="qrcode"><img src="https://brath.cloud/zfb.jpg" alt="支付宝"></span></a><a class="button donate" href="https://brath.cloud/%E5%BE%AE%E4%BF%A1%E6%94%AF%E4%BB%98%E5%AE%9D%E4%BA%8C%E5%90%88%E4%B8%80.png" target="_blank" rel="noopener" data-type="buymeacoffee"><span class="icon is-small"><i class="fas fa-coffee"></i></span><span>送我杯咖啡</span></a><a class="button donate" href="https://brath.cloud/%E5%BE%AE%E4%BF%A1%E6%94%AF%E4%BB%98%E5%AE%9D%E4%BA%8C%E5%90%88%E4%B8%80.png" target="_blank" rel="noopener" data-type="patreon"><span class="icon is-small"><i class="fab fa-patreon"></i></span><span>Patreon</span></a><a class="button donate" data-type="wechat"><span class="icon is-small"><i class="fab fa-weixin"></i></span><span>微信</span><span class="qrcode"><img src="https://brath.cloud/wx.jpg" alt="微信"></span></a></div></div></div><nav class="post-navigation mt-4 level is-mobile"><div class="level-start"><a class="article-nav-prev level level-item link-muted" href="/2023/05/23/%E3%80%90Linux%E3%80%91%E9%98%BF%E9%87%8C%E4%BA%91linux%20%E6%8C%82%E8%BD%BD%E6%95%B0%E6%8D%AE%E7%9B%98%E5%B9%B6docker%E5%B7%A5%E4%BD%9C%E7%9B%AE%E5%BD%95%E8%BF%81%E7%A7%BB%E5%88%B0%E6%95%B0%E6%8D%AE%E7%9B%98/"><i class="level-item fas fa-chevron-left"></i><span class="level-item">【Linux】阿里云linux 挂载数据盘并docker工作目录迁移到数据盘</span></a></div><div class="level-end"><a class="article-nav-next level level-item link-muted" href="/2023/05/17/%E3%80%90Java%E3%80%91%E8%AE%B0%E4%B8%80%E6%AC%A1%E7%BA%BF%E4%B8%8A%E6%95%85%E9%9A%9C%EF%BC%9A%E6%9C%8D%E5%8A%A1%E6%8E%A5%E5%8F%A3%E6%97%A0%E5%93%8D%E5%BA%94/"><span class="level-item">【Java】记一次线上故障：服务接口无响应</span><i class="level-item fas fa-chevron-right"></i></a></div></nav><div class="card"><div class="card-content"><h3 class="title is-5">评论</h3><div id="SOHUCS" sid="2023/05/23/【Seata】来自阿里开源分布式事务框架-Seata的原理/"></div><script charset="utf-8" src="https://changyan.sohu.com/upload/changyan.js"></script><script>window.changyan.api.config({appid: 'cywzQRCbe',conf: '485cd826ef6d780dcea71d0f3b37304a'});</script></div></div></div><div class="column column-left is-4-tablet is-4-desktop is-3-widescreen  order-1"><!--!--><div class="card widget" data-type="recent-posts"><div class="card-content"><h3 class="menu-label">最新文章</h3><article class="media"><div class="media-content"><p class="date"><time dateTime="2023-06-12T04:13:41.000Z">2023-06-12</time></p><p class="title"><a href="/2023/06/12/%E3%80%90%E5%85%AC%E4%BC%97%E5%8F%B7%E5%BC%80%E5%8F%91%E3%80%91%E5%85%AC%E4%BC%97%E5%8F%B7%E6%8A%80%E6%9C%AF%E5%88%86%E4%BA%AB%E7%AC%AC%E4%B8%89%E6%9C%9F-%E5%85%AC%E4%BC%97%E5%8F%B7%E4%BA%8B%E4%BB%B6%E5%A4%84%E7%90%86-%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F%E5%AE%9E%E6%88%98%E5%88%86%E4%BA%AB/">【公众号开发】公众号技术分享第三期-公众号事件处理-设计模式实战分享</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2023-06-06T00:13:41.000Z">2023-06-06</time></p><p class="title"><a href="/2023/06/06/%E3%80%90%E5%85%AC%E4%BC%97%E5%8F%B7%E5%BC%80%E5%8F%91%E3%80%91%E5%85%AC%E4%BC%97%E5%8F%B7%E6%8A%80%E6%9C%AF%E5%88%86%E4%BA%AB%E7%AC%AC%E4%BA%8C%E6%9C%9F-%E5%85%AC%E4%BC%97%E5%8F%B7%E6%A8%A1%E6%9D%BF%E6%B6%88%E6%81%AF-%E6%A8%A1%E6%9D%BF%E6%A8%A1%E5%BC%8F%E5%AE%9E%E6%88%98%E5%88%86%E4%BA%AB/">【公众号开发】公众号技术分享第二期-公众号模板消息-模板模式实战分享</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2023-06-06T00:10:41.000Z">2023-06-06</time></p><p class="title"><a href="/2023/06/06/%E3%80%90%E5%85%AC%E4%BC%97%E5%8F%B7%E5%BC%80%E5%8F%91%E3%80%91%E5%85%AC%E4%BC%97%E5%8F%B7%E6%8A%80%E6%9C%AF%E5%88%86%E4%BA%AB%E7%AC%AC%E4%B8%80%E6%9C%9F-%E5%A6%82%E4%BD%95%E6%B3%A8%E5%86%8C%E5%BE%AE%E4%BF%A1%E5%85%AC%E4%BC%97%E5%B9%B3%E5%8F%B0%E5%B9%B6%E4%BD%BF%E7%94%A8%E5%85%AC%E4%BC%97%E5%8F%B7%E6%A8%A1%E6%9D%BF%E6%B6%88%E6%81%AF/">【公众号开发】公众号技术分享第一期-如何注册微信公众平台并使用公众号模板消息</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2023-06-05T17:10:41.000Z">2023-06-06</time></p><p class="title"><a href="/2023/06/06/%E3%80%90Sentinel%E3%80%91Docker%E6%90%AD%E5%BB%BASentinel/">【Sentinel】Docker搭建Sentinel</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2023-06-05T07:25:21.000Z">2023-06-05</time></p><p class="title"><a href="/2023/06/05/%E3%80%90Git%E3%80%91Github%E6%8F%90%E4%BA%A4%E4%BB%A3%E7%A0%81%E9%81%87%E5%88%B0%E9%94%99%E8%AF%AF%EF%BC%9AERROR%20You%E2%80%98re%20using%20an%20RSA%20key%20with%20SHA-1,%20which%20is%20no%20longer%20allowed/">【Git】Github提交代码遇到错误：ERROR You‘re using an RSA key with SHA-1, which is no longer allowed</a></p></div></article></div></div><div class="card widget" data-type="archives"><div class="card-content"><div class="menu"><h3 class="menu-label">归档</h3><ul class="menu-list"><li><a class="level is-mobile" href="/archives/2023/"><span class="level-start"><span class="level-item">2023</span></span><span class="level-end"><span class="level-item tag">41</span></span></a></li><li><a class="level is-mobile" href="/archives/2022/"><span class="level-start"><span class="level-item">2022</span></span><span class="level-end"><span class="level-item tag">61</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/"><span class="level-start"><span class="level-item">2021</span></span><span class="level-end"><span class="level-item tag">43</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/"><span class="level-start"><span class="level-item">2020</span></span><span class="level-end"><span class="level-item tag">5</span></span></a></li></ul></div></div></div><!--!--><div class="card widget" data-type="profile"><div class="card-content"><nav class="level"><div class="level-item has-text-centered flex-shrink-1"><div><figure class="image is-128x128 mx-auto mb-2"><img class="avatar" src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/%E4%BA%8C%E7%BB%B4%E7%A0%81plus.png" alt="InterviewCoder"></figure><p class="title is-size-4 is-block" style="line-height:inherit;">InterviewCoder</p><p class="is-size-6 is-block">面试记官方公众号</p></div></div></nav><nav class="level is-mobile"><div class="level-item has-text-centered is-marginless"><div><p class="heading">文章</p><a href="/archives"><p class="title">150</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">分类</p><a href="/categories"><p class="title">0</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">标签</p><a href="/tags"><p class="title">0</p></a></div></div></nav><div class="level"><a class="level-item button is-primary is-rounded" href="https://mp.weixin.qq.com/s/jWs6lLHl5L-atXJhHc4YvA" target="_blank" rel="noopener">关注我</a></div></div></div><div class="column-right-shadow is-hidden-widescreen"></div></div><div class="column column-right is-4-tablet is-4-desktop is-3-widescreen is-hidden-touch is-hidden-desktop-only order-3"><div class="card widget" data-type="profile"><div class="card-content"><nav class="level"><div class="level-item has-text-centered flex-shrink-1"><div><figure class="image is-128x128 mx-auto mb-2"><img class="avatar is-rounded" src="https://brath.cloud/me.png" alt="Brath"></figure><p class="title is-size-4 is-block" style="line-height:inherit;">Brath</p><p class="is-size-6 is-block">技能改变人生，知识改变命运。</p><p class="is-size-6 is-flex justify-content-center"><i class="fas fa-map-marker-alt mr-1"></i><span>中国·江苏·无锡</span></p></div></div></nav><nav class="level is-mobile"><div class="level-item has-text-centered is-marginless"><div><p class="heading">文章</p><a href="/archives"><p class="title">150</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">分类</p><a href="/categories"><p class="title">0</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">标签</p><a href="/tags"><p class="title">0</p></a></div></div></nav><div class="level"><a class="level-item button is-primary is-rounded" href="https://github.com/Guoqing815" target="_blank" rel="noopener">关注我</a></div><div class="level is-mobile is-multiline"><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Github" href="https://github.com/Guoqing815"><i class="fab fa-github"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Gitee" href="https://gitee.com/Guoqing-Li"><i class="fab fa-gitee"></i></a></div></div></div><!--!--><div class="card widget" data-type="links"><div class="card-content"><div class="menu"><h3 class="menu-label">链接</h3><ul class="menu-list"><li><a class="level is-mobile" href="https://schokolade.cn/" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">泠灵(特别鸣谢)</span></span><span class="level-right"><span class="level-item tag">schokolade.cn</span></span></a></li><li><a class="level is-mobile" href="https://github.com/Guoqing815/interview" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">面试记Github</span></span><span class="level-right"><span class="level-item tag">github.com</span></span></a></li><li><a class="level is-mobile" href="https://www.pgyer.com/interview_app_release" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">面试记App(Android)</span></span><span class="level-right"><span class="level-item tag">www.pgyer.com</span></span></a></li><li><a class="level is-mobile" href="https://gitee.com/Guoqing-Li" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">Gitee(码云)</span></span><span class="level-right"><span class="level-item tag">gitee.com</span></span></a></li><li><a class="level is-mobile" href="https://blog.csdn.net/Brath?type=blog" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">CSDN</span></span><span class="level-right"><span class="level-item tag">blog.csdn.net</span></span></a></li><li><a class="level is-mobile" href="https://juejin.cn/user/settings/profile" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">掘金</span></span><span class="level-right"><span class="level-item tag">juejin.cn</span></span></a></li><li><a class="level is-mobile" href="https://oss.console.aliyun.com/" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">AliCloud(阿里云)</span></span><span class="level-right"><span class="level-item tag">oss.console.aliyun.com</span></span></a></li><li><a class="level is-mobile" href="https://cloud.tencent.com/" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">TencentCloud(腾讯云)</span></span><span class="level-right"><span class="level-item tag">cloud.tencent.com</span></span></a></li><li><a class="level is-mobile" href="https://www.zhipin.com/web/user/" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">BOSS</span></span><span class="level-right"><span class="level-item tag">www.zhipin.com</span></span></a></li><li><a class="level is-mobile" href="https://www.bilibili.com/" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">Bilibili(B站)</span></span><span class="level-right"><span class="level-item tag">www.bilibili.com</span></span></a></li></ul></div></div></div></div></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/"><img src="https://brath.cloud/avatar.png" alt="Brath-Blog" height="28"></a><p class="is-size-7"><span>&copy; 2023 Brath</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a><br><span id="busuanzi_container_site_uv">共<span id="busuanzi_value_site_uv">0</span>个访客</span></p><p class="is-size-7">© 2030</p></div><div class="level-end"></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script><script>moment.locale("zh-cn");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="/js/column.js"></script><script src="/js/animation.js"></script><a id="back-to-top" title="回到顶端" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><!--!--><!--!--><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.js" defer></script><script>window.addEventListener("load", () => {
      window.cookieconsent.initialise({
        type: "info",
        theme: "edgeless",
        static: false,
        position: "bottom-left",
        content: {
          message: "此网站使用Cookie来改善您的体验。",
          dismiss: "知道了！",
          allow: "允许使用Cookie",
          deny: "拒绝",
          link: "了解更多",
          policy: "Cookie政策",
          href: "https://www.cookiesandyou.com/",
        },
        palette: {
          popup: {
            background: "#edeff5",
            text: "#838391"
          },
          button: {
            background: "#4b81e8"
          },
        },
      });
    });</script><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><!--!--><!--!--><!--!--><script src="/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="想要查找什么..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"想要查找什么...","untitled":"(无标题)","posts":"文章","pages":"页面","categories":"分类","tags":"标签"});
        });</script></body></html>