<!doctype html>
<html lang="zh"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta><title>Brath-Blog</title><link rel="manifest" href="/manifest.json"><meta name="application-name" content="Brath-Blog"><meta name="msapplication-TileImage" content="https://brath.cloud/avatar.png"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="Brath-Blog"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta property="og:type" content="blog"><meta property="og:title" content="Brath-Blog"><meta property="og:url" content="http://example.com/"><meta property="og:site_name" content="Brath-Blog"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="http://example.com/img/og_image.png"><meta property="article:author" content="Brath"><meta property="twitter:card" content="summary"><meta property="twitter:image:src" content="http://example.com/img/og_image.png"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"http://example.com"},"headline":"Brath-Blog","image":["http://example.com/img/og_image.png"],"author":{"@type":"Person","name":"Brath"},"publisher":{"@type":"Organization","name":"Brath-Blog","logo":{"@type":"ImageObject","url":"https://brath.cloud/avatar.png"}},"description":""}</script><link rel="icon" href="https://brath.cloud/avatar.png"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v6.0.0/css/all.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/atom-one-light.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><!--!--><!--!--><script src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" defer></script><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/css/justifiedGallery.min.css"><!--!--><!--!--><style>.pace{-webkit-pointer-events:none;pointer-events:none;-webkit-user-select:none;-moz-user-select:none;user-select:none}.pace-inactive{display:none}.pace .pace-progress{background:#3273dc;position:fixed;z-index:2000;top:0;right:100%;width:100%;height:2px}</style><script src="https://cdn.jsdelivr.net/npm/pace-js@1.2.4/pace.min.js"></script><!--!--><!--!--><!-- hexo injector head_end start --><script>
  (function () {
      function switchTab() {
          if (!location.hash) {
            return;
          }

          const id = '#' + CSS.escape(location.hash.substring(1));
          const $tabMenu = document.querySelector(`.tabs a[href="${id}"]`);
          if (!$tabMenu) {
            return;
          }

          const $tabMenuContainer = $tabMenu.parentElement.parentElement;
          Array.from($tabMenuContainer.children).forEach($menu => $menu.classList.remove('is-active'));
          Array.from($tabMenuContainer.querySelectorAll('a'))
              .map($menu => document.getElementById($menu.getAttribute("href").substring(1)))
              .forEach($content => $content.classList.add('is-hidden'));

          if ($tabMenu) {
              $tabMenu.parentElement.classList.add('is-active');
          }
          const $activeTab = document.querySelector(id);
          if ($activeTab) {
              $activeTab.classList.remove('is-hidden');
          }
      }
      switchTab();
      window.addEventListener('hashchange', switchTab, false);
  })();
  </script><!-- hexo injector head_end end --><meta name="generator" content="Hexo 6.3.0"></head><body class="is-3-column"><nav class="navbar navbar-main"><div class="container navbar-container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="https://brath.cloud/avatar.png" alt="Brath-Blog" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item is-active" href="/">主页</a><a class="navbar-item" href="/archives">文章列表</a><a class="navbar-item" href="/tags">标签</a><a class="navbar-item" href="/about">更多</a></div><div class="navbar-end"><a class="navbar-item" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/Guoqing815"><i class="fab fa-github"></i></a><a class="navbar-item search" title="搜索" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-6-widescreen"><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2023-06-06T00:13:41.000Z" title="2023-6-6 8:13:41">2023-06-06</time>发表</span><span class="level-item"><time dateTime="2023-06-06T06:56:51.685Z" title="2023-6-6 14:56:51">2023-06-06</time>更新</span><span class="level-item">29 分钟读完 (大约4331个字)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2023/06/06/%E3%80%90%E5%85%AC%E4%BC%97%E5%8F%B7%E5%BC%80%E5%8F%91%E3%80%91%E5%85%AC%E4%BC%97%E5%8F%B7%E6%8A%80%E6%9C%AF%E5%88%86%E4%BA%AB%E7%AC%AC%E4%BA%8C%E6%9C%9F-%E5%85%AC%E4%BC%97%E5%8F%B7%E6%A8%A1%E6%9D%BF%E6%B6%88%E6%81%AF-%E6%A8%A1%E6%9D%BF%E6%A8%A1%E5%BC%8F%E5%AE%9E%E6%88%98%E5%88%86%E4%BA%AB/">【公众号开发】公众号技术分享第二期-公众号模板消息-模板模式实战分享</a></p><div class="content"><p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/%E6%89%AB%E7%A0%81_%E6%90%9C%E7%B4%A2%E8%81%94%E5%90%88%E4%BC%A0%E6%92%AD%E6%A0%B7%E5%BC%8F-%E6%A0%87%E5%87%86%E8%89%B2%E7%89%88.png" alt="InterviewCoder"></p>
<h1 id="公众号开发公众号技术分享第二期-公众号模板消息-模板模式实战分享"><a class="markdownIt-Anchor" href="#公众号开发公众号技术分享第二期-公众号模板消息-模板模式实战分享">#</a> 【公众号开发】公众号技术分享第二期 - 公众号模板消息 - 模板模式实战分享</h1>
<h5 id="打一波广告"><a class="markdownIt-Anchor" href="#打一波广告">#</a> 打一波广告…</h5>
<h1 id="面试记app"><a class="markdownIt-Anchor" href="#面试记app">#</a> 面试记 APP</h1>
<p>Github：<a target="_blank" rel="noopener" href="https://github.com/Guoqing815/interview">https://github.com/Guoqing815/interview</a></p>
<p>安卓 APP 下载：<a target="_blank" rel="noopener" href="https://www.pgyer.com/interview_app_release">https://www.pgyer.com/interview_app_release</a></p>
<p>Brath 的个人博客：<a target="_blank" rel="noopener" href="https://brath.top">https://brath.top</a></p>
<p>面试记官方公众号，定期分享有趣的编程知识：<a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/jWs6lLHl5L-atXJhHc4YvA">https://mp.weixin.qq.com/s/jWs6lLHl5L-atXJhHc4YvA</a></p>
<h2 id="前言"><a class="markdownIt-Anchor" href="#前言">#</a> 前言</h2>
<p>​		大家好啊，我是 Brath，一名激进的全栈开发者，从这期专栏开始，我会逐渐分享面试记项目中的部分优质源码给到大家。还希望大家多多关注！</p>
<p>​		上期我们介绍了微信模板消息的配置方式，以及 Java 代码示例，接下来我们要用更优雅的方式来实现发送模板消息！</p>
<h6 id="注意这是实战代码不是demo"><a class="markdownIt-Anchor" href="#注意这是实战代码不是demo">#</a> 注意：这是实战代码，不是 Demo！</h6>
<h4 id="模板模式介绍"><a class="markdownIt-Anchor" href="#模板模式介绍">#</a> 模板模式介绍：</h4>
<p>​		模板模式是一种行为型设计模式，它定义了一个操作中的算法骨架，而将一些步骤延迟到子类中实现。模板方法使得子类可以不改变一个算法的结构即可重新定义该算法的某些特定步骤。</p>
<p>​		在模板模式中，我们定义一个抽象类，其中包含一个模板方法，该方法定义了算法的骨架，以及一些抽象的方法，这些方法需要子类去实现。子类可以继承该抽象类，并实现其中的抽象方法，从而完成具体的业务逻辑。</p>
<h2 id="如何使用模板设计模式优雅的实现发送微信公众号模板消息"><a class="markdownIt-Anchor" href="#如何使用模板设计模式优雅的实现发送微信公众号模板消息">#</a> 如何使用模板设计模式优雅的实现发送微信公众号模板消息？</h2>
<h2 id="一-设计模板架构"><a class="markdownIt-Anchor" href="#一-设计模板架构">#</a> 一、设计模板架构</h2>
<p>​		我们的业务就是发送模板消息，最开始我使用了 switch 分支来判断不同的模板消息，起初它是好用的，但是随着消息类型的增加，慢慢的代码开始冗余了起来，所以我想到了利用模板模式来彻底优化这个业务。</p>
<p>​		这次设计的模板架构分为五个模块：</p>
<h6 id="1模板定义每个模板的规范抽取共性方法凝练重要功能"><a class="markdownIt-Anchor" href="#1模板定义每个模板的规范抽取共性方法凝练重要功能">#</a> 1. 模板：定义每个模板的规范，抽取共性方法，凝练重要功能</h6>
<h6 id="2消息类型分类管理为不同的消息类型赋能"><a class="markdownIt-Anchor" href="#2消息类型分类管理为不同的消息类型赋能">#</a> 2. 消息类型：分类管理，为不同的消息类型赋能</h6>
<h6 id="3类型配置便携管理消息类型摒弃了if与switch判断"><a class="markdownIt-Anchor" href="#3类型配置便携管理消息类型摒弃了if与switch判断">#</a> 3. 类型配置：便携管理消息类型，摒弃了 if 与 switch 判断</h6>
<h6 id="4数据支撑为模板消息提供基础数据支撑例如公众号消息推送业务"><a class="markdownIt-Anchor" href="#4数据支撑为模板消息提供基础数据支撑例如公众号消息推送业务">#</a> 4. 数据支撑：为模板消息提供基础数据支撑，例如公众号消息推送业务</h6>
<h6 id="5统一校验在抽象的层面去校验模板合法性校验通过发送消息"><a class="markdownIt-Anchor" href="#5统一校验在抽象的层面去校验模板合法性校验通过发送消息">#</a> 5. 统一校验：在抽象的层面去校验模板合法性，校验通过发送消息</h6>
<h6 id="6消息注入接口层面通过反射实例化消息并将参数集合注入消息体"><a class="markdownIt-Anchor" href="#6消息注入接口层面通过反射实例化消息并将参数集合注入消息体">#</a> 6. 消息注入：接口层面通过反射实例化消息，并将参数集合注入消息体</h6>
<h2 id="二-结构预览"><a class="markdownIt-Anchor" href="#二-结构预览">#</a> 二、结构预览</h2>
<h4 id="messagedata包定义消息体规范消息格式"><a class="markdownIt-Anchor" href="#messagedata包定义消息体规范消息格式">#</a> messageData 包，定义消息体，规范消息格式</h4>
<p>1.IMessage 为模板通用定义，实现了两个方法，getMessageName 用于获取模板自己的名称，getWxMaTemplateData 用于获取模板的参数配置</p>
<p>2.LoginSuccessTemplateImpl 为登录成功模板消息的实例定义，实现了 IMessage 接口，并且重写 getMessageName 和 getWxMaTemplateData 方法，即能提供自己的名称和参数列表到接口定义中。</p>
<p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/image-20230606141325324.png" alt="image-20230606141325324"></p>
<h4 id="messagemodule包定义模板配置发送流程"><a class="markdownIt-Anchor" href="#messagemodule包定义模板配置发送流程">#</a> messageModule 包，定义模板配置，发送流程</h4>
<p>1.WechatMessageConfig 为模板配置，用于获取所有模板映射的集合，方便我们通过名称获取模板配置实例，摒弃了 ifelse 的判断模式。</p>
<p>2.WechatMessageSupport 为基础数据支撑，用于提供基础的微信模板发送消息的方法，以及模板消息注入方法的实现。</p>
<p>3.IWechatMessageExec 为发送模板的接口，用于实现发送模板消息的规范。</p>
<p>4.AbstractWechatMessageBase 为抽象的微信模板消息，用于抽象化管理所有模板消息，在这里做参数的校验，以及 unionId 的获取。</p>
<p>5.IWechatMessageExecImpl 为发送消息的实现，在抽象层面获取到 fromOpenId 后即可通过抽象层继承的 Support 层的微信模板发送消息的方法来发送微信模板消息。</p>
<p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/image-20230606141135188.png" alt="image-20230606141135188"></p>
<p>预览了结构之后，可以更好的理解下面的代码实现</p>
<h2 id="三-模板消息以及实现类型"><a class="markdownIt-Anchor" href="#三-模板消息以及实现类型">#</a> 三、模板消息以及实现类型</h2>
<p>现在开始实现代码的部分，首先我们来定义一个消息体的抽象接口，用来表示统一的模板</p>
<h5 id="抽象接口"><a class="markdownIt-Anchor" href="#抽象接口">#</a> 抽象接口：</h5>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span>: Brath</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span>: 2023-06-5 18:10</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@github</span>: https://github.com/Guoqing815</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Copyright</span>: 公众号：InterviewCoder | 博客：https://brath.top - 为了更好的你，也为了更好的世界。</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span>: 消息体的抽象接口</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">IMessage</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取消息名称</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    String <span class="title function_">getMessageName</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取模板消息集合</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    List&lt;WxMaTemplateData&gt; <span class="title function_">getWxMaTemplateData</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="实现类"><a class="markdownIt-Anchor" href="#实现类">#</a> 实现类：</h5>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span>: Brath</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span>: 2023-06-5 18:13</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@github</span>: https://github.com/Guoqing815</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Copyright</span>: 公众号：InterviewCoder | 博客：https://brath.top - 为了更好的你，也为了更好的世界。</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span>: 登录成功模板消息</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Component(&quot;loginSuccessTemplateMessage&quot;)</span></span><br><span class="line"><span class="meta">@ApiModel(value = &quot;登录成功模板消息&quot;)</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@Accessors(chain = true)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LoginSuccessTemplateImpl</span> <span class="keyword">implements</span> <span class="title class_">IMessage</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@NotBlank(message = &quot;登录用户不能为空&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String loginUser;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@NotBlank(message = &quot;登录地址不能为空&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String loginAddr;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@NotBlank(message = &quot;登录IP不能为空&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String loginIp;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getMessageName</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> NotifyType.LOGIN_SUCCESS_TEMPLATE_MESSAGE.getType();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> List&lt;WxMaTemplateData&gt; <span class="title function_">getWxMaTemplateData</span><span class="params">()</span> &#123;</span><br><span class="line">        List&lt;WxMaTemplateData&gt; params = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        params.add(<span class="keyword">new</span> <span class="title class_">WxMaTemplateData</span>(<span class="string">&quot;keyword1&quot;</span>, loginUser + <span class="string">&quot;，您的账号刚刚在&quot;</span> + loginAddr + <span class="string">&quot;登录。请关注本次登录时间和地点，若是您本人登录，请忽略本提醒，若非本人登录，请点击修改密码，并检查账号最近登录和操作行为是否有问题。&quot;</span>, <span class="string">&quot;#173177&quot;</span>));</span><br><span class="line">        params.add(<span class="keyword">new</span> <span class="title class_">WxMaTemplateData</span>(<span class="string">&quot;keyword2&quot;</span>, <span class="keyword">new</span> <span class="title class_">SimpleDateFormat</span>(<span class="string">&quot;yyyy-MM-dd HH:mm&quot;</span>).format(<span class="keyword">new</span> <span class="title class_">Date</span>()), <span class="string">&quot;#173177&quot;</span>));</span><br><span class="line">        params.add(<span class="keyword">new</span> <span class="title class_">WxMaTemplateData</span>(<span class="string">&quot;keyword3&quot;</span>, loginIp, <span class="string">&quot;#173177&quot;</span>));</span><br><span class="line">        <span class="keyword">return</span> params;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>注意：NotifyType 表示消息的类型，你可以自己定义常量来代替这段代码</p>
<h6 id="这两段代码实现了一个抽象的消息模板接口并创建了登录成功模板消息类型实现了对应的方法"><a class="markdownIt-Anchor" href="#这两段代码实现了一个抽象的消息模板接口并创建了登录成功模板消息类型实现了对应的方法">#</a> 这两段代码实现了一个抽象的消息模板接口，并创建了登录成功模板消息类型，实现了对应的方法</h6>
<h2 id="四-数据支撑以及数据配置"><a class="markdownIt-Anchor" href="#四-数据支撑以及数据配置">#</a> 四、数据支撑以及数据配置</h2>
<h5 id="数据支撑"><a class="markdownIt-Anchor" href="#数据支撑">#</a> 数据支撑：</h5>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span>: Brath</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span>: 2023-06-5 19:11</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@github</span>: https://github.com/Guoqing815</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Copyright</span>: 公众号：InterviewCoder | 博客：https://brath.top - 为了更好的你，也为了更好的世界。</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span>: WechatMessageSupport</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WechatMessageSupport</span> <span class="keyword">extends</span> <span class="title class_">WechatMessageConfig</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Logger</span> <span class="variable">logger</span> <span class="operator">=</span> LoggerFactory.getLogger(WechatMessageSupport.class);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Information service interface</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">static</span> NotifyService notifyService;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 注入消息服务接口</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> notifyService</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setNotifyService</span><span class="params">(NotifyService notifyService)</span> &#123;</span><br><span class="line">        WechatMessageSupport.notifyService = notifyService;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 注入消息体</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> paramMap</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> iMessage</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> IMessage <span class="title function_">injectMessage</span><span class="params">(HashMap&lt;String, Object&gt; paramMap, IMessage iMessage)</span> &#123;</span><br><span class="line">        <span class="comment">// 获取class模板</span></span><br><span class="line">        Class&lt;?&gt; clazz = iMessage.getClass();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 缓存setter方法</span></span><br><span class="line">        Map&lt;String, Method&gt; setterMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;(<span class="number">16</span>);</span><br><span class="line">        <span class="keyword">for</span> (Method method : clazz.getMethods()) &#123;</span><br><span class="line">            <span class="keyword">if</span> (method.getName().startsWith(Consts.SET)) setterMap.put(method.getName(), method);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 注入参数到字段中</span></span><br><span class="line">        <span class="keyword">for</span> (Map.Entry&lt;String, Object&gt; entry : paramMap.entrySet()) &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">paramName</span> <span class="operator">=</span> entry.getKey();</span><br><span class="line">            <span class="type">Object</span> <span class="variable">paramValue</span> <span class="operator">=</span> entry.getValue();</span><br><span class="line">            <span class="type">String</span> <span class="variable">setterName</span> <span class="operator">=</span> generateSetterName(paramName);</span><br><span class="line">            <span class="type">Method</span> <span class="variable">method</span> <span class="operator">=</span> setterMap.get(setterName);</span><br><span class="line">            <span class="keyword">if</span> (method != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="comment">// 检查参数类型是否匹配</span></span><br><span class="line">                Class&lt;?&gt;[] parameterTypes = method.getParameterTypes();</span><br><span class="line">                <span class="keyword">if</span> (parameterTypes.length != <span class="number">1</span> || !parameterTypes[<span class="number">0</span>].isInstance(paramValue)) &#123;</span><br><span class="line">                    logger.warn(<span class="string">&quot;无法为消息对象设置参数 &#123;&#125; = &#123;&#125;, 参数类型不匹配&quot;</span>, paramName, paramValue);</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 检查方法是否可访问</span></span><br><span class="line">                <span class="keyword">if</span> (!method.isAccessible()) &#123;</span><br><span class="line">                    method.setAccessible(<span class="literal">true</span>);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    method.invoke(iMessage, paramValue);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IllegalAccessException | InvocationTargetException e) &#123;</span><br><span class="line">                    logger.error(<span class="string">&quot;无法为消息对象设置参数 &#123;&#125; = &#123;&#125;&quot;</span>, paramName, paramValue, e);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                logger.warn(<span class="string">&quot;无法为消息对象设置参数 &#123;&#125; = &#123;&#125;&quot;</span>, paramName, paramValue);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> iMessage;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 生成setter方法名称</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> propertyName</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> String <span class="title function_">generateSetterName</span><span class="params">(String propertyName)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> Optional.ofNullable(propertyName).filter(name -&gt; !name.isEmpty()).map(name -&gt; <span class="string">&quot;set&quot;</span> + Character.toUpperCase(name.charAt(<span class="number">0</span>)) + name.substring(<span class="number">1</span>)).orElse(<span class="literal">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="数据配置"><a class="markdownIt-Anchor" href="#数据配置">#</a> 数据配置：</h5>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span>: Brath</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span>: 2023-06-5 19:39</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@github</span>: https://github.com/Guoqing815</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Copyright</span>: 公众号：InterviewCoder | 博客：https://brath.top - 为了更好的你，也为了更好的世界。</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span>: WechatMessageConfig</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WechatMessageConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 消息策略组映射表</span></span><br><span class="line"><span class="comment">     * 疑：为什么初始值会设置成8？而不是6呢？</span></span><br><span class="line"><span class="comment">     * 答：因为 HashMap 的实现可能会自动将 initcp 调整为接近 2 的幂次方的值，以便更好地处理哈希冲突</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Map&lt;String, IMessage&gt; messageStrategyGroup = <span class="keyword">new</span> <span class="title class_">ConcurrentHashMap</span>&lt;&gt;(<span class="number">8</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 初始化消息组</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> properties</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">initService</span><span class="params">(IMessage[] properties)</span> &#123;</span><br><span class="line">        Arrays.stream(properties).forEach(</span><br><span class="line">                property -&gt; messageStrategyGroup.put(property.getMessageName(), property)</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这两段代码我们实现了数据的基础支撑，以及类型模式配置。</p>
<h2 id="五-注入抽象消息到模板并且实现发送流程"><a class="markdownIt-Anchor" href="#五-注入抽象消息到模板并且实现发送流程">#</a> 五、注入抽象消息到模板，并且实现发送流程</h2>
<h5 id="抽象消息接口定义发送模板消息的接口"><a class="markdownIt-Anchor" href="#抽象消息接口定义发送模板消息的接口">#</a> 抽象消息接口：定义发送模板消息的接口</h5>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span>: Brath</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span>: 2023-06-5 20:23</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@github</span>: https://github.com/Guoqing815</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Copyright</span>: 公众号：InterviewCoder | 博客：https://brath.top - 为了更好的你，也为了更好的世界。</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span>: IWechatMessageExec</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">IWechatMessageExec</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 发送模板消息</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    Object <span class="title function_">sendMessage</span><span class="params">(IMessage message, String unionId)</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="抽象消息实现在抽象消息层面去判断消息体的参数合法性并且将unionid转换为fromopenid"><a class="markdownIt-Anchor" href="#抽象消息实现在抽象消息层面去判断消息体的参数合法性并且将unionid转换为fromopenid">#</a> 抽象消息实现：在抽象消息层面去判断消息体的参数合法性，并且将 unionId 转换为 fromOpenId</h5>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span>: Brath</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span>: 2023-06-6 07:12</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@github</span>: https://github.com/Guoqing815</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Copyright</span>: 公众号：InterviewCoder | 博客：https://brath.top - 为了更好的你，也为了更好的世界。</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span>: AbstractWechatMessage</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">AbstractWechatMessageBase</span> <span class="keyword">extends</span> <span class="title class_">WechatMessageSupport</span> <span class="keyword">implements</span> <span class="title class_">IWechatMessageExec</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Logger</span> <span class="variable">logger</span> <span class="operator">=</span> LoggerFactory.getLogger(AbstractWechatMessageBase.class);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 发送抽象消息，准备消息体，转换FromOpenID</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">sendMessage</span><span class="params">(IMessage message, String unionId)</span> &#123;</span><br><span class="line">        ValidatorUtils.validateEntity(message);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (AssertUtil.isEmpty(unionId)) &#123;</span><br><span class="line">            logger.error(DEFALUT_FAIL, ResponseCode.DATA_DOES_NOT_EXIST.desc());</span><br><span class="line">            <span class="keyword">return</span> ResponseUtil.fail(ResponseCode.DATA_DOES_NOT_EXIST.desc());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//这段代码原本在WechatMessageSupport层实现，被我剔除掉了，这个需要大家去自己实现收集公众号关注人的fromOpenId，不是微信的openId，是关注了公众号后，产生的openId。</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">fromOpenId</span> <span class="operator">=</span> wxservFollowService.getFromOpenIdByUnionId(unionId);</span><br><span class="line">        <span class="keyword">if</span> (AssertUtil.isEmpty(fromOpenId)) &#123;</span><br><span class="line">            logger.error(DEFALUT_FAIL, ResponseCode.DATA_DOES_NOT_EXIST.desc());</span><br><span class="line">            <span class="keyword">return</span> ResponseUtil.fail(ResponseCode.DATA_DOES_NOT_EXIST.desc());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//总之fromOpenId就是关注了公众号后产生的唯一ID</span></span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.sendMessage(message, fromOpenId, message.getMessageName());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 发送抽象消息</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> message</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> openId</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> messageType</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">abstract</span> Object <span class="title function_">sendMessage</span><span class="params">(IMessage message, String openId, String messageType)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="具体消息实现在抽象层确保消息体完整性后调用抽象层面的具体实现类调用数据支撑层的notifyservice服务完成发送模板消息"><a class="markdownIt-Anchor" href="#具体消息实现在抽象层确保消息体完整性后调用抽象层面的具体实现类调用数据支撑层的notifyservice服务完成发送模板消息">#</a> 具体消息实现：在抽象层确保消息体完整性后，调用抽象层面的具体实现类，调用数据支撑层的 notifyService 服务完成发送模板消息</h5>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span>: Brath</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span>: 2023-06-6 07:40</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@github</span>: https://github.com/Guoqing815</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Copyright</span>: 公众号：InterviewCoder | 博客：https://brath.top - 为了更好的你，也为了更好的世界。</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span>: 模板消息推送实现</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Component(&quot;wechatMessageExecImpl&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">IWechatMessageExecImpl</span> <span class="keyword">extends</span> <span class="title class_">AbstractWechatMessageBase</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Logger</span> <span class="variable">logger</span> <span class="operator">=</span> LoggerFactory.getLogger(IWechatMessageExecImpl.class);</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> Object <span class="title function_">sendMessage</span><span class="params">(IMessage message, String openId, String messageType)</span> &#123;</span><br><span class="line">        logger.info(<span class="string">&quot;【公众号模板消息推送】：开始 --  messageType：&#123;&#125;,openId：&#123;&#125;&quot;</span>, messageType, openId);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            notifyService.notifyWxTemplate(</span><br><span class="line">                    openId,</span><br><span class="line">                    NotifyType.of(messageType),</span><br><span class="line">                    message.getWxMaTemplateData()</span><br><span class="line">            );</span><br><span class="line">            logger.info(<span class="string">&quot;【公众号模板消息推送】：结束 -- messageType：&#123;&#125;,openId：&#123;&#125;&quot;</span>, messageType, openId);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            logger.error(<span class="string">&quot;【公众号模板消息推送】：异常 -- &#123;&#125;&quot;</span>, e.getMessage());</span><br><span class="line">            <span class="keyword">return</span> ResponseUtil.fail(e.getMessage());</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> ResponseUtil.ok();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="springboot配置文件-消息类型-notifyservice实现"><a class="markdownIt-Anchor" href="#springboot配置文件-消息类型-notifyservice实现">#</a> SpringBoot 配置文件、消息类型、NotifyService 实现：</h4>
<h5 id="pom文件配置依赖这里我们使用大神binarywang的miniapp库来实现微信支持"><a class="markdownIt-Anchor" href="#pom文件配置依赖这里我们使用大神binarywang的miniapp库来实现微信支持">#</a> pom 文件配置依赖：这里我们使用大神 binarywang 的 miniapp 库来实现微信支持</h5>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;com.github.binarywang&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;weixin-java-miniapp&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;<span class="number">3.3</span><span class="number">.0</span>&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;com.github.binarywang&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;weixin-java-pay&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;<span class="number">3.3</span><span class="number">.0</span>&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure>
<h5 id="yaml配置实现自定义配置类配置模板集合以及是否开启"><a class="markdownIt-Anchor" href="#yaml配置实现自定义配置类配置模板集合以及是否开启">#</a> yaml 配置：实现自定义配置类，配置模板集合，以及是否开启</h5>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">system:</span></span><br><span class="line">  <span class="attr">notify:</span></span><br><span class="line">    <span class="attr">wx:</span></span><br><span class="line">      <span class="attr">enable:</span> <span class="literal">true</span> <span class="comment">#启动模板消息</span></span><br><span class="line">      <span class="attr">template:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">loginSuccessTemplateMessage</span> <span class="comment">#登录成功模板消息</span></span><br><span class="line">          <span class="attr">templateId:</span> <span class="string">qDHo-UXXXXXXXXXXXXXXXXXXXXX</span> <span class="comment">#公众平台模板ID</span></span><br></pre></td></tr></table></figure>
<h5 id="配置信息类使用静态内部类实现子配置"><a class="markdownIt-Anchor" href="#配置信息类使用静态内部类实现子配置">#</a> 配置信息类：使用静态内部类实现子配置</h5>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span>: Brath</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span>: 2023-06-6 07:40</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@github</span>: https://github.com/Guoqing815</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Copyright</span>: 公众号：InterviewCoder | 博客：https://brath.top - 为了更好的你，也为了更好的世界。</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span>: NotifyProperties</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@ConfigurationProperties(prefix = &quot;system.notify&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">NotifyProperties</span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> Wx wx;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Data</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Wx</span> &#123;</span><br><span class="line">		<span class="keyword">private</span> <span class="type">boolean</span> enable;</span><br><span class="line">		<span class="keyword">private</span> List&lt;Map&lt;String, String&gt;&gt; template = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="自动配置类使用enableconfigurationproperties注解注入notifyproperties配置并实现notifyservice配置注入"><a class="markdownIt-Anchor" href="#自动配置类使用enableconfigurationproperties注解注入notifyproperties配置并实现notifyservice配置注入">#</a> 自动配置类：使用 EnableConfigurationProperties 注解注入 NotifyProperties 配置并实现 notifyService 配置注入</h5>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span>: Brath</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span>: 2023-06-6 07:40</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@github</span>: https://github.com/Guoqing815</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Copyright</span>: 公众号：InterviewCoder | 博客：https://brath.top - 为了更好的你，也为了更好的世界。</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span>:  挂载NotifyProperties类，获取配置信息并自动加载</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableConfigurationProperties(NotifyProperties.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">NotifyAutoConfiguration</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> NotifyProperties properties;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">NotifyAutoConfiguration</span><span class="params">(NotifyProperties properties)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.properties = properties;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean(name = &quot;NotifyService&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> NotifyService <span class="title function_">notifyService</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">NotifyService</span> <span class="variable">notifyService</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">NotifyService</span>();</span><br><span class="line"></span><br><span class="line">        NotifyProperties.<span class="type">Wx</span> <span class="variable">wxConfig</span> <span class="operator">=</span> properties.getWx();</span><br><span class="line">        <span class="keyword">if</span> (wxConfig.isEnable()) &#123;</span><br><span class="line">            notifyService.setWxTemplateSender(wxTemplateSender());</span><br><span class="line">            NotifyService.wxTemplate = wxConfig.getTemplate();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> notifyService;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> WxTemplateSender <span class="title function_">wxTemplateSender</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">WxTemplateSender</span> <span class="variable">wxTemplateSender</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">WxTemplateSender</span>();</span><br><span class="line">        <span class="keyword">return</span> wxTemplateSender;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="消息类型配置模板消息类型"><a class="markdownIt-Anchor" href="#消息类型配置模板消息类型">#</a> 消息类型：配置模板消息类型</h5>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span>: Brath</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span>: 2023-05-25 08:49</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@github</span>: https://github.com/Guoqing815</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Copyright</span>: 公众号：InterviewCoder | 博客：https://brath.top - 为了更好的你，也为了更好的世界。</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span>: NotifyType</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> <span class="title class_">NotifyType</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//登录成功模板消息</span></span><br><span class="line">    LOGIN_SUCCESS_TEMPLATE_MESSAGE(<span class="string">&quot;loginSuccessTemplateMessage&quot;</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> EnumMap&lt;NotifyType, String&gt; typeMap = <span class="keyword">new</span> <span class="title class_">EnumMap</span>&lt;&gt;(NotifyType.class);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> (NotifyType notifyType : NotifyType.values()) &#123;</span><br><span class="line">            typeMap.put(notifyType, notifyType.type);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String type;</span><br><span class="line"></span><br><span class="line">    NotifyType(String type) &#123;</span><br><span class="line">        <span class="built_in">this</span>.type = type;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> NotifyType <span class="title function_">of</span><span class="params">(String messageType)</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> (NotifyType notifyType : typeMap.keySet()) &#123;</span><br><span class="line">            <span class="keyword">if</span> (typeMap.get(notifyType).equals(messageType)) &#123;</span><br><span class="line">                <span class="keyword">return</span> notifyType;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(<span class="string">&quot;No such enum object for the given messageType&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getType</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.type;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="notifyservice服务实现实现发送消息的服务类"><a class="markdownIt-Anchor" href="#notifyservice服务实现实现发送消息的服务类">#</a> NotifyService 服务实现：实现发送消息的服务类</h5>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span>: Brath</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span>: 2023-06-6 07:40</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@github</span>: https://github.com/Guoqing815</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Copyright</span>: 公众号：InterviewCoder | 博客：https://brath.top - 为了更好的你，也为了更好的世界。</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span>: 公众号模板消息服务</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">NotifyService</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> MailSender mailSender;</span><br><span class="line">    <span class="keyword">private</span> String sendFrom;</span><br><span class="line">    <span class="keyword">private</span> String sendTo;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> WxTemplateSender wxTemplateSender;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> List&lt;Map&lt;String, String&gt;&gt; wxTemplate = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isWxEnable</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> wxTemplateSender != <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 微信模版消息通知,不跳转</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;</span></span><br><span class="line"><span class="comment">     * 该方法会尝试从数据库获取缓存的FormId去发送消息</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> touser     接收者openId</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> notifyType 通知类别，通过该枚举值在配置文件中获取相应的模版ID</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> params     通知模版内容里的参数，类似&quot;您的验证码为&#123;1&#125;&quot;中&#123;1&#125;的值</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Async</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">notifyWxTemplate</span><span class="params">(String touser, NotifyType notifyType, List&lt;WxMaTemplateData&gt; params)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (wxTemplateSender == <span class="literal">null</span>)</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">templateId</span> <span class="operator">=</span> getTemplateId(notifyType, wxTemplate);</span><br><span class="line">        wxTemplateSender.sendWechatMsg(touser, templateId, params);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 微信模版消息通知，带跳转</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;</span></span><br><span class="line"><span class="comment">     * 该方法会尝试从数据库获取缓存的FormId去发送消息</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> touser     接收者openId</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> notifyType 通知类别，通过该枚举值在配置文件中获取相应的模版ID</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> params     通知模版内容里的参数，类似&quot;您的验证码为&#123;1&#125;&quot;中&#123;1&#125;的值</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> page       点击消息跳转的页面</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Async</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">notifyWxTemplate</span><span class="params">(String touser, NotifyType notifyType, List&lt;WxMaTemplateData&gt; params, String page)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (wxTemplateSender == <span class="literal">null</span>)</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">templateId</span> <span class="operator">=</span> getTemplateId(notifyType, wxTemplate);</span><br><span class="line">        wxTemplateSender.sendWechatMsg(touser, templateId, params, page);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取模板ID</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> notifyType</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> values</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String <span class="title function_">getTemplateId</span><span class="params">(NotifyType notifyType, List&lt;Map&lt;String, String&gt;&gt; values)</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> (Map&lt;String, String&gt; item : values) &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">notifyTypeStr</span> <span class="operator">=</span> notifyType.getType();</span><br><span class="line">            <span class="keyword">if</span> (item.get(<span class="string">&quot;name&quot;</span>).equals(notifyTypeStr))</span><br><span class="line">                <span class="keyword">return</span> item.get(<span class="string">&quot;templateId&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="wxtemplatesender发送者实现实现发送消息的基础类使用wxmaservice库发送消息"><a class="markdownIt-Anchor" href="#wxtemplatesender发送者实现实现发送消息的基础类使用wxmaservice库发送消息">#</a> WxTemplateSender 发送者实现：实现发送消息的基础类，使用 WxMaService 库发送消息</h5>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span>: Brath</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span>: 2023-06-6 07:40</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@github</span>: https://github.com/Guoqing815</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Copyright</span>: 公众号：InterviewCoder | 博客：https://brath.top - 为了更好的你，也为了更好的世界。</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span>: 微信模版消息通知</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WxTemplateSender</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">Log</span> <span class="variable">logger</span> <span class="operator">=</span> LogFactory.getLog(WxTemplateSender.class);</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> WxMaService wxMaService;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 发送微信消息(模板消息),不带跳转</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> touser</span></span><br><span class="line"><span class="comment">     *            用户 OpenID</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> templatId</span></span><br><span class="line"><span class="comment">     *            模板消息ID</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> parms</span></span><br><span class="line"><span class="comment">     *            详细内容</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">sendWechatMsg</span><span class="params">(String touser, String templatId, String[] parms)</span> &#123;</span><br><span class="line">        sendMsg(touser, templatId, parms, <span class="string">&quot;&quot;</span>, <span class="string">&quot;&quot;</span>, <span class="string">&quot;&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 发送微信消息(模板消息),不带跳转</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> touser</span></span><br><span class="line"><span class="comment">     *            用户 OpenID</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> templatId</span></span><br><span class="line"><span class="comment">     *            模板消息ID</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> parms</span></span><br><span class="line"><span class="comment">     *            详细内容</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">sendWechatMsg</span><span class="params">(String touser, String templatId, List&lt;WxMaTemplateData&gt; parms)</span> &#123;</span><br><span class="line">        sendMsg(touser, templatId, parms, <span class="string">&quot;&quot;</span>, <span class="string">&quot;&quot;</span>, <span class="string">&quot;&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 发送微信消息(模板消息),带跳转</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> touser</span></span><br><span class="line"><span class="comment">     *            用户 OpenID</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> templatId</span></span><br><span class="line"><span class="comment">     *            模板消息ID</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> parms</span></span><br><span class="line"><span class="comment">     *            详细内容</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> page</span></span><br><span class="line"><span class="comment">     *            跳转页面</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">sendWechatMsg</span><span class="params">(String touser, String templatId, List&lt;WxMaTemplateData&gt; parms, String page)</span> &#123;</span><br><span class="line">        sendMsg(touser, templatId, parms, page, <span class="string">&quot;&quot;</span>, <span class="string">&quot;&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 发送消息基类</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> touser</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> templatId</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> parms</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> page</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> color</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> emphasisKeyword</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">sendMsg</span><span class="params">(String touser, String templatId, String[] parms, String page, String color,</span></span><br><span class="line"><span class="params">                         String emphasisKeyword)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (touser == <span class="literal">null</span>)</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">        <span class="type">WxMaTemplateMessage</span> <span class="variable">msg</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">WxMaTemplateMessage</span>();</span><br><span class="line">        msg.setTemplateId(templatId);</span><br><span class="line">        msg.setToUser(touser);</span><br><span class="line">        msg.setFormId(touser);</span><br><span class="line">        msg.setPage(page);</span><br><span class="line">        msg.setColor(color);</span><br><span class="line">        msg.setEmphasisKeyword(emphasisKeyword);</span><br><span class="line">        msg.setData(createMsgData(parms));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            wxMaService.getMsgService().sendTemplateMsg(msg);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">JsonParser</span> <span class="variable">JSON_PARSER</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JsonParser</span>();</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">SEND_MSG_API</span> <span class="operator">=</span> <span class="string">&quot;https://api.weixin.qq.com/cgi-bin/message/template/send&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">sendMsg</span><span class="params">(String touser, String templatId, List&lt;WxMaTemplateData&gt; parms, String page, String color,</span></span><br><span class="line"><span class="params">                         String emphasisKeyword)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (touser == <span class="literal">null</span>)</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">        <span class="type">WxMaTemplateMessage</span> <span class="variable">msg</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">WxMaTemplateMessage</span>();</span><br><span class="line">        msg.setTemplateId(templatId);</span><br><span class="line">        msg.setToUser(touser);</span><br><span class="line">        msg.setFormId(touser);</span><br><span class="line">        msg.setPage(page);</span><br><span class="line">        msg.setColor(color);</span><br><span class="line">        msg.setEmphasisKeyword(emphasisKeyword);</span><br><span class="line">        msg.setData(parms);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">responseContent</span> <span class="operator">=</span> <span class="built_in">this</span>.wxMaService.post(SEND_MSG_API, msg.toJson());</span><br><span class="line">            <span class="type">JsonObject</span> <span class="variable">jsonObject</span> <span class="operator">=</span> JSON_PARSER.parse(responseContent).getAsJsonObject();</span><br><span class="line">            <span class="keyword">if</span> (jsonObject.get(WxMaConstants.ERRCODE).getAsInt() != <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">WxErrorException</span>(WxError.fromJson(responseContent));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (WxErrorException e) &#123;</span><br><span class="line">            logger.error(<span class="string">&quot;【微信消息模板】：服务端异常，原因可能是：&#123;&#125;&quot;</span>, e);</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> List&lt;WxMaTemplateData&gt; <span class="title function_">createMsgData</span><span class="params">(String[] parms)</span> &#123;</span><br><span class="line">        List&lt;WxMaTemplateData&gt; dataList = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;WxMaTemplateData&gt;();</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">1</span>; i &lt;= parms.length; i++) &#123;</span><br><span class="line">            dataList.add(<span class="keyword">new</span> <span class="title class_">WxMaTemplateData</span>(<span class="string">&quot;keyword&quot;</span> + i, parms[i - <span class="number">1</span>]));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> dataList;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h6 id="在配置完如上代码后我们的代码就完成了接下来即可通过单元测试来测试模板消息"><a class="markdownIt-Anchor" href="#在配置完如上代码后我们的代码就完成了接下来即可通过单元测试来测试模板消息">#</a> 在配置完如上代码后，我们的代码就完成了，接下来即可通过单元测试来测试模板消息！</h6>
<h2 id="六-使用抽象模板发送消息"><a class="markdownIt-Anchor" href="#六-使用抽象模板发送消息">#</a> 六、使用抽象模板发送消息</h2>
<p>单元测试发送消息：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span>: Brath</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span>: 2023-06-6 08:21</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@github</span>: https://github.com/Guoqing815</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Copyright</span>: 公众号：InterviewCoder | 博客：https://brath.top - 为了更好的你，也为了更好的世界。</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span>: 单测</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RunWith(SpringRunner.class)</span></span><br><span class="line"><span class="meta">@SpringBootTest(webEnvironment = SpringBootTest.WebEnvironment.RANDOM_PORT)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SpringRunnerTest</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">Logger</span> <span class="variable">logger</span> <span class="operator">=</span> LoggerFactory.getLogger(SpringRunnerTest.class);</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> IWechatMessageExec messageExec;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test_sendMessage</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">//产品提测消息</span></span><br><span class="line">        <span class="type">ProductTestTemplateImpl</span> <span class="variable">productTestTemplate</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ProductTestTemplateImpl</span>()</span><br><span class="line">                .setCompanyName(<span class="string">&quot;测试公司&quot;</span>)</span><br><span class="line">                .setUserName(<span class="string">&quot;Brath&quot;</span>)</span><br><span class="line">                .setVersion(<span class="string">&quot;2.0.6&quot;</span>);</span><br><span class="line">        <span class="comment">//注册成功消息</span></span><br><span class="line">        <span class="type">RegistTemplateImpl</span> <span class="variable">registTemplate</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RegistTemplateImpl</span>();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//登录成功消息</span></span><br><span class="line">        <span class="type">LoginSuccessTemplateImpl</span> <span class="variable">loginSuccessTemplate</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">LoginSuccessTemplateImpl</span>()</span><br><span class="line">                .setLoginUser(<span class="string">&quot;Brath&quot;</span>)</span><br><span class="line">                .setLoginAddr(<span class="string">&quot;JVM&quot;</span>)</span><br><span class="line">                .setLoginIp(<span class="string">&quot;0.0.0.0&quot;</span>);</span><br><span class="line">        messageExec.sendMessage(loginSuccessTemplate, <span class="string">&quot;o-KKr6Qwsxxxxxxxxxxxxxxx&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="测试成功~"><a class="markdownIt-Anchor" href="#测试成功~">#</a> 测试成功～</h5>
<p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/image-20230606143429408.png" alt="image-20230606143429408"></p>
<h6 id="tips如果你觉得brath分享的代码还可以的话请将我分享给更多需要帮助的人~"><a class="markdownIt-Anchor" href="#tips如果你觉得brath分享的代码还可以的话请将我分享给更多需要帮助的人~">#</a> tips：如果你觉得 Brath 分享的代码还可以的话，请将我分享给更多需要帮助的人～</h6>
<h6 id="到此为止公众号发送模板消息的知识分享就结束啦还请同学们多多关注interviewcoder做一个激进的开发者为了更好的你也为了更好的世界"><a class="markdownIt-Anchor" href="#到此为止公众号发送模板消息的知识分享就结束啦还请同学们多多关注interviewcoder做一个激进的开发者为了更好的你也为了更好的世界">#</a> 到此为止，公众号发送模板消息的知识分享就结束啦，还请同学们多多关注 InterviewCoder，做一个激进的开发者，为了更好的你，也为了更好的世界！</h6>
<h1 id="完结撒花"><a class="markdownIt-Anchor" href="#完结撒花">#</a> 完结撒花❀</h1>
<h2 id="关于我"><a class="markdownIt-Anchor" href="#关于我">#</a> 关于我</h2>
<p>Brath 是一个热爱技术的 Java 程序猿，公众号「InterviewCoder」定期分享有趣有料的精品原创文章！</p>
<p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/%E4%BA%8C%E7%BB%B4%E7%A0%81plus.png" alt="InterviewCoder"></p>
<p>非常感谢各位人才能看到这里，原创不易，文章如果有帮助可以关注、点赞、分享或评论，这都是对我的莫大支持！</p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2023-06-06T00:10:41.000Z" title="2023-6-6 8:10:41">2023-06-06</time>发表</span><span class="level-item"><time dateTime="2023-06-06T05:13:21.519Z" title="2023-6-6 13:13:21">2023-06-06</time>更新</span><span class="level-item">13 分钟读完 (大约1887个字)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2023/06/06/%E3%80%90%E5%85%AC%E4%BC%97%E5%8F%B7%E5%BC%80%E5%8F%91%E3%80%91%E5%85%AC%E4%BC%97%E5%8F%B7%E6%8A%80%E6%9C%AF%E5%88%86%E4%BA%AB%E7%AC%AC%E4%B8%80%E6%9C%9F-%E5%A6%82%E4%BD%95%E6%B3%A8%E5%86%8C%E5%BE%AE%E4%BF%A1%E5%85%AC%E4%BC%97%E5%B9%B3%E5%8F%B0%E5%B9%B6%E4%BD%BF%E7%94%A8%E5%85%AC%E4%BC%97%E5%8F%B7%E6%A8%A1%E6%9D%BF%E6%B6%88%E6%81%AF/">【公众号开发】公众号技术分享第一期-如何注册微信公众平台并使用公众号模板消息</a></p><div class="content"><p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/%E6%89%AB%E7%A0%81_%E6%90%9C%E7%B4%A2%E8%81%94%E5%90%88%E4%BC%A0%E6%92%AD%E6%A0%B7%E5%BC%8F-%E6%A0%87%E5%87%86%E8%89%B2%E7%89%88.png" alt="InterviewCoder"></p>
<h1 id="公众号开发公众号技术分享第一期-如何注册微信公众平台并使用公众号模板消息"><a class="markdownIt-Anchor" href="#公众号开发公众号技术分享第一期-如何注册微信公众平台并使用公众号模板消息">#</a> 【公众号开发】公众号技术分享第一期 - 如何注册微信公众平台并使用公众号模板消息</h1>
<h5 id="打一波广告"><a class="markdownIt-Anchor" href="#打一波广告">#</a> 打一波广告…</h5>
<h1 id="面试记app"><a class="markdownIt-Anchor" href="#面试记app">#</a> 面试记 APP</h1>
<p>Github：<a target="_blank" rel="noopener" href="https://github.com/Guoqing815/interview">https://github.com/Guoqing815/interview</a></p>
<p>安卓 APP 下载：<a target="_blank" rel="noopener" href="https://www.pgyer.com/interview_app_release">https://www.pgyer.com/interview_app_release</a></p>
<p>Brath 的个人博客：<a target="_blank" rel="noopener" href="https://brath.top">https://brath.top</a></p>
<p>面试记官方公众号，定期分享有趣的编程知识：<a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/jWs6lLHl5L-atXJhHc4YvA">https://mp.weixin.qq.com/s/jWs6lLHl5L-atXJhHc4YvA</a></p>
<h2 id="前言"><a class="markdownIt-Anchor" href="#前言">#</a> 前言</h2>
<p>​		大家好啊，我是 Brath，一名激进的全栈开发者，从这期专栏开始，我会逐渐分享面试记项目中的部分优质源码给到大家。还希望大家多多关注！</p>
<h5 id="使用公众号模板消息有几个前提"><a class="markdownIt-Anchor" href="#使用公众号模板消息有几个前提">#</a> 使用公众号模板消息有几个前提：</h5>
<h6 id="1需要拥有一个已经认证过的公众号认证费用300元"><a class="markdownIt-Anchor" href="#1需要拥有一个已经认证过的公众号认证费用300元">#</a> 1. 需要拥有一个已经认证过的公众号，认证费用 300 元。</h6>
<h6 id="2至少有基础的java开发经验"><a class="markdownIt-Anchor" href="#2至少有基础的java开发经验">#</a> 2. 至少有基础的 Java 开发经验。</h6>
<h6 id="3了解xml和json格式的数据"><a class="markdownIt-Anchor" href="#3了解xml和json格式的数据">#</a> 3. 了解 XML 和 JSON 格式的数据</h6>
<h6 id="4微信公众平台httpsmpweixinqqcom"><a class="markdownIt-Anchor" href="#4微信公众平台httpsmpweixinqqcom">#</a> 4. 微信公众平台：<a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/">https://mp.weixin.qq.com/</a></h6>
<h2 id="一-开通模板消息"><a class="markdownIt-Anchor" href="#一-开通模板消息">#</a> 一、开通模板消息</h2>
<p>​	登录微信公众号 Web 端，开通模板消息功能，选择使用的模板消息或者申请新的模板消息，只有通过企业认证才能使用模板消息</p>
<p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/image-20230606094513227.png" alt="image-20230606094513227"></p>
<p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/image-20230606094408873.png" alt="image-20230606094408873"></p>
<h2 id="二-开启接口权限"><a class="markdownIt-Anchor" href="#二-开启接口权限">#</a> 二、开启接口权限</h2>
<p>接口权限 =&gt; 网页服务 =&gt; 网页授权 =&gt; 申请 / 修改</p>
<p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/image-20230606094447163.png" alt="image-20230606094447163"></p>
<h2 id="三-配置域名"><a class="markdownIt-Anchor" href="#三-配置域名">#</a> 三、配置域名</h2>
<p>​		三项都要配置。注意前面不要加 http 或 https，后面不可带端口号。还需要下载一个校验文件，把下载下来的校验文件放到所配置<a target="_blank" rel="noopener" href="https://so.csdn.net/so/search?q=%E5%9F%9F%E5%90%8D%E8%A7%A3%E6%9E%90&amp;spm=1001.2101.3001.7020">域名解析</a>的服务器上，需要域名 + 检验文件名可以访问到这个文件才算校验通过，后面不能有端口（例如：<a target="_blank" rel="noopener" href="http://wx.qq.com/MP_verify_FF1peUkHP0MrdJqN.txt%EF%BC%9B%EF%BC%89%E3%80%82">wx.qq.com/MP_verify_FF1peUkHP0MrdJqN.txt；）。</a></p>
<p>ps：放校验文件的时候需要注意，http 默认端口是 80，https 默认端口是 443</p>
<p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/image-20230606094747344.png" alt="image-20230606094747344"></p>
<p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/image-20230606094814359.png" alt="image-20230606094814359"></p>
<h2 id="四-配置ip白名单"><a class="markdownIt-Anchor" href="#四-配置ip白名单">#</a> 四、配置 IP 白名单。</h2>
<p>​		后续获取<a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/wiki/?t=resource/res_main&amp;id=mp1421140183&amp;token=&amp;lang=zh_CN"> access_token</a> 访问接口时，需要设置访问来源 IP 为白名单，如不配置就拿不到 token，每台机器上请求返回的 ip 都会不一样，把开发机器和服务器拿到的 ip 都配置一样就好，配置多个 ip 时每个 ip 用回车隔开就行。怎么获取来源 ip：如果没有配置 ip 白名单，请求获取<a target="_blank" rel="noopener" href="https://so.csdn.net/so/search?q=access_token&amp;spm=1001.2101.3001.7020"> access_token</a> 时会返回一个 ip，把这个 ip 配上去就行了。另外顺便保存一下 appId 和 AppSecret，方便后续使用。</p>
<p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/image-20230606105545467.png" alt="image-20230606105545467"></p>
<h2 id="五-发送模板消息流程"><a class="markdownIt-Anchor" href="#五-发送模板消息流程">#</a> 五、发送模板消息流程</h2>
<p><strong>1. 获取 code</strong>：需要更换的参数是 appid、redirect_uri，其他参数不变，其中 scope 有两个参数，以 snsapi_base 为 scope 发起的网页授权，是用来获取进入页面的用户的 openid 的，并且是静默授权并自动跳转到回调页的。用户感知的就是直接进入了回调页（往往是业务页面）；<br>
以 snsapi_userinfo 为 scope 发起的网页授权，是用来获取用户的基本信息的。但这种授权需要用户手动同意，并且由于用户同意过，所以无须关注，就可在授权后获取该用户的基本信息。我这里用的是静默授权然后跳转到相关页面。另外还要注意的是这个地址只能在微信客户端请求才有用，可以用微信开发者工具切换成公众号调试模式测试，请求后会自动重定向，在跳转的地址后面拼上一个 code，这个就是我们需要的参数。<br>
<a target="_blank" rel="noopener" href="https://open.weixin.qq.com/connect/oauth2/authorize?appid=%E4%BD%A0%E7%9A%84appid&amp;redirect_uri=%E8%A6%81%E8%B7%B3%E8%BD%AC%E7%9A%84%E5%9C%B0%E5%9D%80/%E9%A1%B5%E9%9D%A2&amp;response_type=code&amp;scope=snsapi_base&amp;state=STATE#wechat_redirect">https://open.weixin.qq.com/connect/oauth2/authorize?appid = 你的 appid&amp;redirect_uri = 要跳转的地址 / 页面 &amp; response_type=code&amp;scope=snsapi_base&amp;state=STATE#wechat_redirect</a></p>
<p><strong>2. 通过 code 换取网页授权 access_token，拿到 openId</strong></p>
<p>注意上面拿到的 code 只能使用一次，并且有效时长为 5 分钟，失效必须重新获取</p>
<p><a target="_blank" rel="noopener" href="https://api.weixin.qq.com/sns/oauth2/access_token?appid=%E4%BD%A0%E7%9A%84appid&amp;secret=%E4%BD%A0%E7%9A%84secret&amp;code=%E4%B8%8A%E9%9D%A2%E5%9C%B0%E5%9D%80%E6%A0%8F%E6%8B%BF%E5%88%B0%E7%9A%84code&amp;grant_type=authorization_code">https://api.weixin.qq.com/sns/oauth2/access_token?appid = 你的 appid&amp;secret = 你的 secret&amp;code = 上面地址栏拿到的 code&amp;grant_type=authorization_code</a></p>
<p><strong>3. 获取 token (此 token 与上面的 access_token 不一样)，此 token 用于发送模板消息用以及其他 api 接口的调用</strong><br>
<a target="_blank" rel="noopener" href="https://api.weixin.qq.com/cgi-bin/token?grant_type=client_credential&amp;appid=%E4%BD%A0%E7%9A%84appid&amp;secret=%E4%BD%A0%E7%9A%84secret"> https://api.weixin.qq.com/cgi-bin/token?grant_type=client_credential&amp;appid = 你的 appid&amp;secret = 你的 secret</a></p>
<p><strong>4. 发送模板消息</strong><br>
<a target="_blank" rel="noopener" href="https://api.weixin.qq.com/cgi-bin/message/template/send?access_token=%E4%B8%8A%E9%9D%A2%E8%8E%B7%E5%8F%96%E5%88%B0%E7%9A%84token"> https://api.weixin.qq.com/cgi-bin/message/template/send?access_token = 上面获取到的 token</a></p>
<h4 id="json示例"><a class="markdownIt-Anchor" href="#json示例">#</a> JSON 示例：</h4>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;touser&quot;</span><span class="punctuation">:</span><span class="string">&quot;OPENID&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;template_id&quot;</span><span class="punctuation">:</span><span class="string">&quot;xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;url&quot;</span><span class="punctuation">:</span><span class="string">&quot;http://weixin.qq.com/download&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;miniprogram&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;appid&quot;</span><span class="punctuation">:</span><span class="string">&quot;xxxxxxxxxxxxxxx&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;pagepath&quot;</span><span class="punctuation">:</span><span class="string">&quot;xxxxxx&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;client_msg_id&quot;</span><span class="punctuation">:</span><span class="string">&quot;MSG_000001&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;data&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;keyword1&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;value&quot;</span><span class="punctuation">:</span><span class="string">&quot;test&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;color&quot;</span><span class="punctuation">:</span><span class="string">&quot;#173177&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;keyword2&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;value&quot;</span><span class="punctuation">:</span><span class="string">&quot;test&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;color&quot;</span><span class="punctuation">:</span><span class="string">&quot;#173177&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<h4 id="参数说明"><a class="markdownIt-Anchor" href="#参数说明">#</a> 参数说明：</h4>
<p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/image-20230606095123398.png" alt="image-20230606095123398"></p>
<h1 id=""><a class="markdownIt-Anchor" href="#">#</a> </h1>
<h1 id="简单的java代码"><a class="markdownIt-Anchor" href="#简单的java代码">#</a> 简单的 Java 代码：</h1>
<p><strong>1. 获取用户 openid，参数为 code</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 微信公众号获取获取用户openid</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> code</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@GetMapping(&quot;/getOpenId&quot;)</span></span><br><span class="line"><span class="meta">@ApiOperation(value = &quot;微信公众号获取用户openid&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">getOpenId</span><span class="params">(<span class="meta">@RequestParam</span> String code)</span>&#123;</span><br><span class="line">    String url= <span class="string">&quot;https://api.weixin.qq.com/sns/oauth2/access_token&quot;</span> + <span class="string">&quot;?appid=&quot;</span> + appId     + <span class="string">&quot;&amp;secret=&quot;</span> + appSecret + <span class="string">&quot;&amp;code=&quot;</span>+ code+<span class="string">&quot;&amp;grant_type=authorization_code&quot;</span>;</span><br><span class="line">    RestTemplate restTemplate=<span class="keyword">new</span> <span class="title class_">RestTemplate</span>();</span><br><span class="line">    String response=restTemplate.getForObject(url,String.class);</span><br><span class="line">    <span class="type">JSONObject</span> <span class="variable">jsonObj</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JSONObject</span>(response);</span><br><span class="line">    <span class="type">String</span> <span class="variable">openid</span> <span class="operator">=</span> jsonObj.get(<span class="string">&quot;openid&quot;</span>).toString();</span><br><span class="line">    <span class="keyword">return</span> openid;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>2. 获取 token</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 微信公众号获取获取token</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">getWeiXinToken</span><span class="params">()</span>&#123;</span><br><span class="line">    String url=<span class="string">&quot;https://api.weixin.qq.com/cgi-bin/token?grant_type=client_credential&amp;appid=&quot;</span>+ appId + <span class="string">&quot;&amp;secret=&quot;</span> + appSecret;</span><br><span class="line">    <span class="type">RestTemplate</span> <span class="variable">restTemplate</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RestTemplate</span>();</span><br><span class="line">    <span class="type">String</span> <span class="variable">forObject</span> <span class="operator">=</span> restTemplate.getForObject(url, String.class);</span><br><span class="line">    <span class="type">JSONObject</span> <span class="variable">jsonObj</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JSONObject</span>(forObject);</span><br><span class="line">    <span class="keyword">return</span> jsonObj.get(<span class="string">&quot;access_token&quot;</span>).toString();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>3. 准备一个模板消息实体类</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WxTemplateMsg</span> &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 接收者openId</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String touser;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 模板ID</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String template_id;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 模板跳转链接</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String url;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * data数据</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> TreeMap&lt;String, TreeMap&lt;String, String&gt;&gt; data;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 参数</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> value 值</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> color 颜色 可不填</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> params</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> TreeMap&lt;String, String&gt; <span class="title function_">item</span><span class="params">(String value, String color)</span> &#123;</span><br><span class="line">        TreeMap&lt;String, String&gt; params = <span class="keyword">new</span> <span class="title class_">TreeMap</span>&lt;String, String&gt;();</span><br><span class="line">        params.put(<span class="string">&quot;value&quot;</span>, value);</span><br><span class="line">        params.put(<span class="string">&quot;color&quot;</span>, color);</span><br><span class="line">        <span class="keyword">return</span> params;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>4. 模板消息封装，消息参数根据自己选择的模板消息来</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 模板消息封装</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">noticeTemplate</span><span class="params">(String openIdd,String siteName,String airIndex,String value1,String value2,String airIndexTime)</span> &#123;</span><br><span class="line">        String templateId=<span class="string">&quot;你的模板消息id&quot;</span>;</span><br><span class="line">        TreeMap&lt;String, TreeMap&lt;String, String&gt;&gt; params = <span class="keyword">new</span> <span class="title class_">TreeMap</span>&lt;&gt;();</span><br><span class="line">        params.put(<span class="string">&quot;keyword1&quot;</span>, WxTemplateMsg.item(<span class="string">&quot;test1&quot;</span>, <span class="string">&quot;#000000&quot;</span>));</span><br><span class="line">        params.put(<span class="string">&quot;keyword2&quot;</span>, WxTemplateMsg.item(<span class="string">&quot;test2&quot;</span>, <span class="string">&quot;#000000&quot;</span>));</span><br><span class="line">        </span><br><span class="line">        <span class="type">WxTemplateMsg</span> <span class="variable">wxTemplateMsg</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">WxTemplateMsg</span>();</span><br><span class="line">        wxTemplateMsg.setTemplate_id(templateId);</span><br><span class="line">        wxTemplateMsg.setTouser(openIdd);</span><br><span class="line">        wxTemplateMsg.setData(params);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> JSONUtil.toJsonStr(wxTemplateMsg);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p><strong>5. 发送模板消息</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 发送模板消息</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">sendTemplateMsg</span><span class="params">(String openId, String siteName, String airIndex, String value1, String value2, String airIndexTime)</span> &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">weiXinToken</span> <span class="operator">=</span> getWeiXinToken();</span><br><span class="line">    <span class="type">String</span> <span class="variable">data</span> <span class="operator">=</span> noticeTemplate(openId, siteName, airIndex, value1, value2, airIndexTime);</span><br><span class="line">    okhttp3.<span class="type">RequestBody</span> <span class="variable">requestBody</span> <span class="operator">=</span> okhttp3.RequestBody.create(MediaType.parse(<span class="string">&quot;application/json&quot;</span>), data);</span><br><span class="line">    <span class="type">Request</span> <span class="variable">request</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Request</span>.Builder().url(<span class="string">&quot;https://api.weixin.qq.com/cgi-bin/message/template/send?access_token=&quot;</span> + weiXinToken).post(requestBody).build();</span><br><span class="line">    <span class="type">OkHttpClient</span> <span class="variable">okHttpClient</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">OkHttpClient</span>();</span><br><span class="line">    <span class="type">Response</span> <span class="variable">execute</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        execute = okHttpClient.newCall(request).execute();</span><br><span class="line">        <span class="type">String</span> <span class="variable">body</span> <span class="operator">=</span> execute.body().string();</span><br><span class="line">        <span class="keyword">if</span> (execute.code() == <span class="number">200</span>) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;模板消息发送成功==========&quot;</span> + body);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;模板消息发送失败==========&quot;</span> + body);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h1 id="完结撒花"><a class="markdownIt-Anchor" href="#完结撒花">#</a> 完结撒花❀</h1>
<h2 id="关于我"><a class="markdownIt-Anchor" href="#关于我">#</a> 关于我</h2>
<p>Brath 是一个热爱技术的 Java 程序猿，公众号「InterviewCoder」定期分享有趣有料的精品原创文章！</p>
<p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/%E4%BA%8C%E7%BB%B4%E7%A0%81plus.png" alt="InterviewCoder"></p>
<p>非常感谢各位人才能看到这里，原创不易，文章如果有帮助可以关注、点赞、分享或评论，这都是对我的莫大支持！</p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2023-06-05T17:10:41.000Z" title="2023-6-6 1:10:41">2023-06-06</time>发表</span><span class="level-item"><time dateTime="2023-06-06T05:13:39.917Z" title="2023-6-6 13:13:39">2023-06-06</time>更新</span><span class="level-item">11 分钟读完 (大约1578个字)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2023/06/06/%E3%80%90Sentinel%E3%80%91Docker%E6%90%AD%E5%BB%BASentinel/">【Sentinel】Docker搭建Sentinel</a></p><div class="content"><p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/%E6%89%AB%E7%A0%81_%E6%90%9C%E7%B4%A2%E8%81%94%E5%90%88%E4%BC%A0%E6%92%AD%E6%A0%B7%E5%BC%8F-%E6%A0%87%E5%87%86%E8%89%B2%E7%89%88.png" alt="InterviewCoder"></p>
<h1 id="sentineldocker搭建sentinel"><a class="markdownIt-Anchor" href="#sentineldocker搭建sentinel">#</a> 【Sentinel】Docker 搭建 Sentinel</h1>
<h1 id="1-概述"><a class="markdownIt-Anchor" href="#1-概述">#</a> 1、概述</h1>
<p><a target="_blank" rel="noopener" href="https://so.csdn.net/so/search?q=Sentinel&amp;spm=1001.2101.3001.7020">Sentinel</a> 提供一个轻量级的开源控制台，它提供机器发现以及健康情况管理、监控（单机和集群），规则管理和推送的功能。</p>
<p>Sentinel 控制台包含如下功能:</p>
<p><strong>查看机器列表以及健康情况：</strong> 收集 Sentinel 客户端发送的<a target="_blank" rel="noopener" href="https://so.csdn.net/so/search?q=%E5%BF%83%E8%B7%B3%E5%8C%85&amp;spm=1001.2101.3001.7020">心跳包</a>，用于判断机器是否在线。<br>
<strong>监控 (单机和集群聚合)：</strong> 通过 Sentinel 客户端暴露的监控 API，定期拉取并且聚合应用监控信息，最终可以实现秒级的实时监控。<br>
<strong>规则管理和推送：</strong> 统一管理推送规则。<br>
<strong>鉴权：</strong> 生产环境中<a target="_blank" rel="noopener" href="https://so.csdn.net/so/search?q=%E9%89%B4%E6%9D%83&amp;spm=1001.2101.3001.7020">鉴权</a>非常重要。这里每个开发者需要根据自己的实际情况进行定制。</p>
<h1 id="2-制作镜像"><a class="markdownIt-Anchor" href="#2-制作镜像">#</a> 2、制作镜像</h1>
<p>sentinel-dashboard 就是一个 SpringBoot 项目，直接使用命令启动即可，所有自定义配置 docker 启动。</p>
<p>如果没有特殊需要可以直接下载 jar，需要修改源码则下载源码包即可，下载地址：<a target="_blank" rel="noopener" href="https://github.com/alibaba/Sentinel/releases%EF%BC%8C%E4%B8%8B%E8%BD%BD%E7%9B%B8%E5%BA%94%E7%89%88%E6%9C%AC%E7%9A%84jar%E5%8C%85%EF%BC%8C%E6%AF%94%E5%A6%82sentinel-dashboard-1.8.1.jar">https://github.com/alibaba/Sentinel/releases，下载相应版本的 jar 包，比如 sentinel-dashboard-1.8.1.jar</a></p>
<p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/image-20230606131018352.png" alt="image-20230606131018352"></p>
<p><strong>1、创建工作目录：</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkdir /home/soft/sentinel -p</span><br></pre></td></tr></table></figure>
<p><strong>2、拷贝文件：</strong></p>
<p>将从官网下载的或者是自定义编译好的 <code>jar</code>  包，拷贝到 <code>/home/soft/sentinel</code>  目录下</p>
<p><strong>3、Dockerfile：</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim /home/soft/sentinel/Dockerfile</span><br></pre></td></tr></table></figure>
<p>内容如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">#java 版本</span><br><span class="line">FROM openkbs/jdk11-mvn-py3</span><br><span class="line">#root用户</span><br><span class="line">USER root</span><br><span class="line">#设置时区</span><br><span class="line">ENV TZ=Asia/Shanghai</span><br><span class="line">RUN ln -snf /usr/share/zoneinfo/$TZ /etc/localtime &amp;&amp; echo $TZ &gt; /etc/timezone</span><br><span class="line">#设置工作目录集</span><br><span class="line">WORKDIR /root/sentinel</span><br><span class="line">#复制jars和命令</span><br><span class="line">ADD *.jar /root/sentinel/</span><br><span class="line">EXPOSE 8858</span><br></pre></td></tr></table></figure>
<p><strong>4、制作镜像：</strong></p>
<p>保证 <code>jar</code>  和 <code>Dockerfile</code>  在同一个目录下，执行命令：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker build -t sentinel-server .</span><br></pre></td></tr></table></figure>
<p>启动容器：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -dit -p 8858:8858 --privileged=true -P --name sentinel sentinel /bin/bash -c &#x27;tail -f /dev/null&#x27; -g &#x27;daemon off;&#x27;</span><br></pre></td></tr></table></figure>
<p>进入容器启动：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -Dserver.port=8858 -Dsentinel.dashboard.auth.username=sentinel -Dsentinel.dashboard.auth.password=sentinel -jar  sentinel-dashboard-1.8.0.jar</span><br></pre></td></tr></table></figure>
<p><strong>3、启动测试</strong></p>
<p><a target="_blank" rel="noopener" href="http://192.168.31.128:8858/">http://127.0.0.1:8858/</a> ；默认账户密码：sentinel/sentinel</p>
<p><strong>鉴权：</strong><br>
从 Sentinel 1.6.0 起，Sentinel 控制台引入基本的登录功能，默认用户名和密码都是 sentinel。该鉴权能力非常基础，生产环境使用建议根据安全需要自行改造。</p>
<p>可以在 Dockerfile 文件中，通过如下 JVM 参数进行配置：</p>
<p>-Dsentinel.dashboard.auth.username=sentinel 用于指定控制台的登录用户名为 sentinel；<br>
–Dsentinel.dashboard.auth.password=123456 用于指定控制台的登录密码为 123456；如果省    略这两个参数，默认用户和密码均为 sentinel；<br>
-Dserver.servlet.session.timeout=7200 用于指定 Spring Boot 服务端 session 的过期时间，如    7200 表示 7200 秒；60m 表示 60 分钟，默认为 30 分钟；<br>
除了修改 JVM 启动参数的形式，还是源码中通过 application.properties 文件进行配置.</p>
<h1 id="4-配置项目说明"><a class="markdownIt-Anchor" href="#4-配置项目说明">#</a> 4、配置项目说明</h1>
<p>控制台的一些特性可以通过配置项来进行配置</p>
<p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/image-20230606112448778.png" alt="image-20230606112448778"></p>
<p>通过 JVM 方式为：在 <code>配置Dockerfiel</code>  的 <code>ENTRYPOINT</code>  中加入相应配置就行。<br>
比如： <code>ENTRYPOINT [ &quot;java&quot; ,&quot;-jar&quot;,&quot;-Dsentinel.dashboard.app.hideAppNoMachineMillis=60000&quot;</code></p>
<h1 id="5-镜像保存与加载"><a class="markdownIt-Anchor" href="#5-镜像保存与加载">#</a> 5、镜像保存与加载</h1>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 保存iamge到home目录下</span></span><br><span class="line">docker save -o /home/sentinel-server.tar iamgeName</span><br><span class="line"> </span><br><span class="line"><span class="comment"># 仓home目录下导入image</span></span><br><span class="line">docker load --input /home/sentinel-server.tar</span><br><span class="line"> </span><br><span class="line"><span class="comment"># 测试：</span></span><br><span class="line"><span class="comment"># 1、save成功以后，删除原有images中的sentinel-server</span></span><br><span class="line"><span class="comment"># 2、导入成功后，重新启动容器，并且成功访问</span></span><br></pre></td></tr></table></figure>
<h1 id="6-控制台介绍"><a class="markdownIt-Anchor" href="#6-控制台介绍">#</a> 6、控制台介绍</h1>
<p><strong>查看机器列表以及健康情况：</strong></p>
<p>在机器列表中看到的连接到 <code>sentinel</code>  的机器，并且展示监控状况</p>
<p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/image-20230606131048872.png" alt="image-20230606131048872"></p>
<p><strong>簇点链路：</strong><br>
簇点链路（单机调用链路）页面实时的去拉取指定客户端资源的运行情况。它一共提供两种展示模式：一种用树状结构展示资源的调用链路，另外一种则不区分调用链路展示资源的实时情况。</p>
<p><strong>注意:</strong> 簇点链路监控是内存态的信息，它仅展示启动后调用过的资源。</p>
<p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/image-20230606131057100.png" alt="image-20230606131057100"></p>
<p><strong>实时监控：</strong><br>
同一个服务下的所有机器的簇点信息会被汇总，并且秒级地展示在 &quot;实时监控&quot; 下。需要确保 Sentinel 控制台所在的机器时间与自己应用的机器时间保持一致，否则会导致拉不到实时的监控数据。</p>
<p>注意：实时监控仅存储 5 分钟以内的数据，如果需要持久化，需要通过调用实时监控接口来定制。</p>
<p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/image-20230606131105294.png" alt="image-20230606131105294"></p>
<p><strong>规则管理：</strong><br>
Sentinel 规则分为：流控、降级、热点、 系统、授权，通过控制台可以对各个 <code>资源</code> 配置相应的规则</p>
<p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/image-20230606131111772.png" alt="image-20230606131111772"></p>
<p><strong>7、整合 SpringCloud 使用</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">spring:</span><br><span class="line"> cloud:</span><br><span class="line">  sentinel:</span><br><span class="line">   transport:</span><br><span class="line">     port: 9999 <span class="comment">#跟控制台交流的端口,随意指定一个未使用的端口即可</span></span><br><span class="line">	 dashboard: 127.0.0.1:8858 <span class="comment"># 指定控制台服务的地址</span></span><br><span class="line">   <span class="built_in">log</span>:</span><br><span class="line">     <span class="built_in">dir</span>: logs/sentinel <span class="comment">#日志输出地址</span></span><br></pre></td></tr></table></figure>
<p><strong>验证：</strong><br>
Sentinel 会在客户端首次调用的时候进行初始化，开始向控制台发送心跳包，我们启动服务后，请求任意一个接口后，即可成功注册。</p>
<p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/image-20230606131122702.png" alt="image-20230606131122702"></p>
<h2 id="关于我"><a class="markdownIt-Anchor" href="#关于我">#</a> 关于我</h2>
<p>Brath 是一个热爱技术的 Java 程序猿，公众号「InterviewCoder」定期分享有趣有料的精品原创文章！</p>
<p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/%E4%BA%8C%E7%BB%B4%E7%A0%81plus.png" alt="InterviewCoder"></p>
<p>非常感谢各位人才能看到这里，原创不易，文章如果有帮助可以关注、点赞、分享或评论，这都是对我的莫大支持！</p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2023-06-05T07:25:21.000Z" title="2023-6-5 15:25:21">2023-06-05</time>发表</span><span class="level-item"><time dateTime="2023-06-05T07:51:38.684Z" title="2023-6-5 15:51:38">2023-06-05</time>更新</span><span class="level-item">3 分钟读完 (大约436个字)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2023/06/05/%E3%80%90Git%E3%80%91Github%E6%8F%90%E4%BA%A4%E4%BB%A3%E7%A0%81%E9%81%87%E5%88%B0%E9%94%99%E8%AF%AF%EF%BC%9AERROR%20You%E2%80%98re%20using%20an%20RSA%20key%20with%20SHA-1,%20which%20is%20no%20longer%20allowed/">【Git】Github提交代码遇到错误：ERROR You‘re using an RSA key with SHA-1, which is no longer allowed</a></p><div class="content"><p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/%E6%89%AB%E7%A0%81_%E6%90%9C%E7%B4%A2%E8%81%94%E5%90%88%E4%BC%A0%E6%92%AD%E6%A0%B7%E5%BC%8F-%E6%A0%87%E5%87%86%E8%89%B2%E7%89%88.png" alt="InterviewCoder"></p>
<h1 id="gitgithub提交代码遇到错误error-youre-using-an-rsa-key-with-sha-1-which-is-no-longer-allowed"><a class="markdownIt-Anchor" href="#gitgithub提交代码遇到错误error-youre-using-an-rsa-key-with-sha-1-which-is-no-longer-allowed">#</a> 【Git】Github 提交代码遇到错误：ERROR You‘re using an RSA key with SHA-1, which is no longer allowed</h1>
<p>ERROR: You’re using an RSA key with SHA-1, which is no longer allowed.<br>
<img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/efa1ce926ae34dfb99dfdd3516ec6fab.png" alt="在这里插入图片描述"><br>
通过 baidu，从错误下面给出的官方文档 <a target="_blank" rel="noopener" href="https://github.blog/2021-09-01-improving-git-protocol-security-github/">https://github.blog/2021-09-01-improving-git-protocol-security-github/</a> 可以看到，github 对 SSH 密钥做了升级，原来的 SHA-1，rsa 等一些已经不支持了，由于我使用的是 rsa，可能和大部分用户一样，所以今天在 push 代码时候遇到了这个问题，记录以下。<br>
生成新的 Ed25519 密钥对：<br>
 <code>ssh-keygen -t ed25519 -C &quot;your-email&quot;</code> <br>
 一路回车。<br>
会在.ssh 目录下生成两个文件</p>
<blockquote>
<p>id_ed25519<br>
id_ed25519.pub</p>
</blockquote>
<p>将 id_ed25519.pub 文件中的内容 copy，拿出来到 github 上<br>
这里：</p>
<p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/image-20230605155058169.png" alt="image-20230605155058169"><br>
 添加一个新的 ssh keys 即可<br>
验证 key 是否可用：使用  <code>ssh -T git@github.com </code> 对 ssh key 进行验证<br>
<img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/88a5bd8e286b4cc28319d49e6c0d0972.png" alt="img"><br>
 之后就可以正常使用 push 命令上传了。</p>
<h2 id="关于我"><a class="markdownIt-Anchor" href="#关于我">#</a> 关于我</h2>
<p>Brath 是一个热爱技术的 Java 程序猿，公众号「InterviewCoder」定期分享有趣有料的精品原创文章！</p>
<p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/%E4%BA%8C%E7%BB%B4%E7%A0%81plus.png" alt="InterviewCoder"></p>
<p>非常感谢各位人才能看到这里，原创不易，文章如果有帮助可以关注、点赞、分享或评论，这都是对我的莫大支持！</p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2023-05-23T02:04:23.000Z" title="2023-5-23 10:04:23">2023-05-23</time>发表</span><span class="level-item"><time dateTime="2023-06-05T07:22:15.429Z" title="2023-6-5 15:22:15">2023-06-05</time>更新</span><span class="level-item">9 分钟读完 (大约1318个字)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2023/05/23/%E3%80%90Linux%E3%80%91%E9%98%BF%E9%87%8C%E4%BA%91linux%20%E6%8C%82%E8%BD%BD%E6%95%B0%E6%8D%AE%E7%9B%98%E5%B9%B6docker%E5%B7%A5%E4%BD%9C%E7%9B%AE%E5%BD%95%E8%BF%81%E7%A7%BB%E5%88%B0%E6%95%B0%E6%8D%AE%E7%9B%98/">【Linux】阿里云linux 挂载数据盘并docker工作目录迁移到数据盘</a></p><div class="content"><p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/%E6%89%AB%E7%A0%81_%E6%90%9C%E7%B4%A2%E8%81%94%E5%90%88%E4%BC%A0%E6%92%AD%E6%A0%B7%E5%BC%8F-%E6%A0%87%E5%87%86%E8%89%B2%E7%89%88.png" alt="InterviewCoder"></p>
<h1 id="linux阿里云linux-挂载数据盘并docker工作目录迁移到数据盘"><a class="markdownIt-Anchor" href="#linux阿里云linux-挂载数据盘并docker工作目录迁移到数据盘">#</a> 【Linux】阿里云 linux 挂载数据盘并 docker 工作目录迁移到数据盘</h1>
<p><strong>一、挂载数据盘，分区 - 格式化 - 挂载</strong></p>
<p>1、fdisk -l 查看磁盘情况</p>
<p>执行命令 fdisk -l 发现 2 个磁盘，但是磁盘 nvme1n1 没有分区，nvme0n1 是有 2 个分区了。</p>
<p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/cceb22f4006cbef75fcd0469ee6f66b4.png" alt="img"></p>
<p>2、fdisk /dev/nvme1n1 执行创建分区</p>
<p>执行命令 fdisk /dev/nvme1n1</p>
<p>输入 n 再回车创建新分区：</p>
<p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/549659e940ec22bb06edfaaff24fbcb9.png" alt="img"></p>
<p>输入 p 再回车创建主分区：</p>
<p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/b74a9ade7fe427394a9fd29c1341185d.png" alt="img"></p>
<p>输入 1 设置分区号：</p>
<p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/65ef7ff6d5b47dda182b008d7a76bf7a.png" alt="img"></p>
<p>起始扇区设置，直接回车就可以：</p>
<p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/49ba78c89a3adc99c197d3f86b1bfa0d.png" alt="img"></p>
<p>扇区结束位置，直接回车就可以：</p>
<p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/f90577aa65369904459b9d92c6812f42.png" alt="img"></p>
<p>最后输入 w 再回车保存设置：</p>
<p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/14aff319e909413dd137a79ecdaa5f5c.png" alt="img"></p>
<p>3、格式化分区</p>
<p>运行 fdisk -lu /dev/nvme1n1 查看分区情况</p>
<p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/e66c56ebcc4ff70a98e0d896e6c79a48.png" alt="img"></p>
<p>格式化分区，并建立文件系统 ext4。 执行命令：sudo mkfs.ext4 /dev/nvme1n1p1</p>
<p>注意：也有人说硬盘应该是买来就已经格式化过了的，说的好像也有那么些道理。但是我现在是 nvme1n1 这个硬盘根本看不到分区的情况下创建了一个新的分区 nvme1n1p1 ，格式化一下这个分区我个人认为也没错。</p>
<p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/0bac4af4597d43a13aa40c2c6bd37287.png" alt="img"></p>
<p>4、挂载分区</p>
<p>执行命令：sudo mount /dev/nvme1n1p1 /mnt 将分区 /dev/nvme1n1p1 挂载到 mnt 目录下。</p>
<p>然后执行 df 查看是否挂载成功 ，执行 df -Th 查看新挂载的磁盘文件系统和其他磁盘是否一致。</p>
<p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/06cef34afe1a743950a164cd40fe272f.png" alt="img"></p>
<p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/924b718ee9c86531e0221e614998cf05.png" alt="img"></p>
<p>5、设置开机自动挂载</p>
<p>sudo vim /etc/fstab 使用这个命令进入 配置文件，然后按 i 键进入插入编辑模式</p>
<p>在文件末尾增加下面的一行</p>
<p>/dev/nvme1n1p1 /mnt ext4 defaults 0 0</p>
<p>按 esc 退出编辑，输入 :wq 保存退出。</p>
<p><strong>二、docker 目录从系统盘迁移到数据盘</strong></p>
<p>1、确认已经将 /dev/nvme1n1 这个数据硬盘的 /dev/nvme1n1p1 分区挂载到了 mnt 目录</p>
<p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/06cef34afe1a743950a164cd40fe272f.png" alt="img"></p>
<p>2、执行 docker info 命令，得到 docker 基本信息，其中可以看到 Docker Root Dir: /var/lib/docker 和 Storage Driver: overlay2 这两个信息，说明了 docker 程序文件安装在 /var/lib/docker，其中 overlay2 为数据存储位置。</p>
<p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/a2885575e1d6701f9d340f19e6ef7b2f.png" alt="img"></p>
<p>3、先停止 Docker ，保证移动的时候数据完整，执行 service docker stop 命令停止 Docker daemon。 命令：systemctl stop docker</p>
<p>可以用 ps 命令进一步检查：ps faux | grep -i docker</p>
<p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/dd32ff8fb25e4b37f053b51533f4f896.png" alt="img"></p>
<p>4、将 Docker 默认数据目录下的数据移动到一个备份的目录，例如 /mnt/Docker_data，执行命令:</p>
<p>mv /var/lib/docker /mnt/Docker_data</p>
<p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/7080e757f909be46d25c0402119f9b70.png" alt="img"></p>
<p>5、把 Docker 的工作目录切换到 /mnt/Docker_data/docker</p>
<p>（1）更改 Docker 服务的 service 文件： vi /lib/systemd/system/docker.service</p>
<p>（2）使用输入 /<em>ExecSt</em>art 搜索关键字 ， 找到这一行：ExecStart=/usr/bin/dockerd -H fd://--containerd=/run/containerd/containerd.sock</p>
<p>改为：<em>ExecSt</em>art=/usr/bin/dockerd -g /mnt/Docker_data/docker -H fd:// --containerd=/run/containerd/containerd.sock</p>
<p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/3132eaca23c769fef0fc97685485249b.png" alt="img"></p>
<p>(3) 刷新 docker 服务 ：<em>sudo s</em>ystemctl daemon-reload</p>
<p>重启 docker 服务：<em>system</em>ctl start docker</p>
<p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/455d262fec86518eda5c68c77bc3464e.png" alt="img"></p>
<p>(4) 查看 docker 状态：systemctl status docker</p>
<p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/e4859b458ec4262825ca347decd46183.png" alt="img"></p>
<p>注意 ：如果查看状态出现了失败的红色的提示，那么就要返回第 3 步停止服务开始，再走一遍步骤，重新修改 Docker 服务的 service 文件，比如我开始的时候 - H 前面少了一个空格，就报红色错误了。</p>
<p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/b50944f9ba4c5ee837e8ab64113b002a.png" alt="img"></p>
<h2 id="关于我"><a class="markdownIt-Anchor" href="#关于我">#</a> 关于我</h2>
<p>Brath 是一个热爱技术的 Java 程序猿，公众号「InterviewCoder」定期分享有趣有料的精品原创文章！</p>
<p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/%E4%BA%8C%E7%BB%B4%E7%A0%81plus.png" alt="InterviewCoder"></p>
<p>非常感谢各位人才能看到这里，原创不易，文章如果有帮助可以关注、点赞、分享或评论，这都是对我的莫大支持！</p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2023-05-23T02:04:23.000Z" title="2023-5-23 10:04:23">2023-05-23</time>发表</span><span class="level-item"><time dateTime="2023-06-05T07:31:10.671Z" title="2023-6-5 15:31:10">2023-06-05</time>更新</span><span class="level-item">1 小时读完 (大约8834个字)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2023/05/23/%E3%80%90Seata%E3%80%91%E6%9D%A5%E8%87%AA%E9%98%BF%E9%87%8C%E5%BC%80%E6%BA%90%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1%E6%A1%86%E6%9E%B6-Seata%E7%9A%84%E5%8E%9F%E7%90%86/">【Seata】来自阿里开源分布式事务框架-Seata的原理</a></p><div class="content"><p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/%E6%89%AB%E7%A0%81_%E6%90%9C%E7%B4%A2%E8%81%94%E5%90%88%E4%BC%A0%E6%92%AD%E6%A0%B7%E5%BC%8F-%E6%A0%87%E5%87%86%E8%89%B2%E7%89%88.png" alt="InterviewCoder"></p>
<h1 id="seata来自阿里开源分布式事务框架-seata的原理"><a class="markdownIt-Anchor" href="#seata来自阿里开源分布式事务框架-seata的原理">#</a> 【Seata】来自阿里开源分布式事务框架 - Seata 的原理</h1>
<p>首先  <code>Seata</code>  客户端启动一般分为以下几个流程：</p>
<ol>
<li>自动加载 Bean 属性和配置信息</li>
<li>初始化 TM</li>
<li>初始化 RM</li>
<li>初始化分布式事务客户端完成，完成代理数据库配置</li>
<li>连接 TC (Seata 服务端)，注册 RM 和 TM</li>
<li>开启全局事务</li>
</ol>
<p>在这篇源码的讲解中，我们主要以 AT 模式为主导，官网也是主推 AT 模式，我们在上篇的文章中也讲解过，感兴趣的小伙伴可以去看一看<a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s?__biz=MzA4MjM0MTQ1Mg==&amp;mid=2458786001&amp;idx=1&amp;sn=98f3b3c5d211f60a803446913fbb12e3&amp;chksm=88fd83f2bf8a0ae4b2682af7b15f9493c33d7771a066d1eb1c73583cfc67da891cffa1c9f55c&amp;token=1008440856&amp;lang=zh_CN#rd">分布式事务 (Seata) 四大模式详解</a>，在官网中也提供了对应的流程地址：<a target="_blank" rel="noopener" href="https://seata.io/zh-cn/docs/dev/mode/at-mode.html">https://seata.io/zh-cn/docs/dev/mode/at-mode.html</a> ，在这里我们只是做一些简单的介绍，AT 模式主要分为两个阶段：</p>
<p><strong>一阶段：</strong></p>
<ul>
<li>解析 SQL，获取 SQL 类型（CRUD）、表信息、条件 (where) 等相关信息</li>
<li>查询前镜像 (改变之前的数据)，根据解析得到的条件信息，生成查询语句，定位数据</li>
<li>执行业务 SQL，更新数据</li>
<li>查询后镜像（改变后的数据），根据前镜像的结果，通过主键都给你为数据</li>
<li>插入回滚日志，将前后镜像数据以及业务 SQL 等信息，组织成一条回滚日志记录，插入到 undo Log 表中</li>
<li>提交前，向 TC 注册分支，申请全局锁</li>
<li>本地事务提交，业务数据的更细腻和生成的 undoLog 一起提交</li>
<li>将本地事务提交的结果通知给 TC</li>
</ul>
<p><strong>二阶段：</strong></p>
<p>如果 TC 收到的是回滚请求</p>
<ul>
<li>开启本地事务，通过 XID 和 BranchID 查找到对应的 undo Log 记录</li>
<li>根据 undoLog 中的前镜像和业务 SQL 的相关信息生成并执行回滚语句</li>
<li>提交本地事务，将本地事务的执行结果（分支事务回滚的信息）通知给 TC</li>
</ul>
<p>如果没问题，执行提交操作</p>
<ul>
<li>收到 TC 分支提交请求，将请求放入到一个异步任务的队列中，马上返回提交成功的结果给 TC</li>
<li>异步任务阶段的分支提交请求删除 undoLog 中记录</li>
</ul>
<p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/6b4a6708a964d51d954cec9fb660b72f.png" alt="img"></p>
<h2 id="源码入口"><a class="markdownIt-Anchor" href="#源码入口">#</a> 源码入口</h2>
<p>接下来，我们就需要从官网中去下载源码，下载地址：<a target="_blank" rel="noopener" href="https://seata.io/zh-cn/blog/download.html%EF%BC%8C%E9%80%89%E6%8B%A9">https://seata.io/zh-cn/blog/download.html，选择</a>  <code>source</code>  即可，下载完成之后，通过 IDEA 打开项目。</p>
<p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/bdca1226de54c44b76fbcb81ad5203ec.png" alt="img"></p>
<p>源码下载下来之后，我们应该如何去找入口呢？首先我们需要找到对应引入的  <code>Seata</code>  包  <code>spring-alibaba-seata</code> ，我们在回想一下，我们开启事务的时候，是不是添加过一个 <code>@GlobalTransactional</code>  的注解，这个注解就是我们入手的一个点，我们在  <code>spring.factories</code>  中看到有一个  <code>GlobalTransactionAutoConfiguration</code> ，这个就是我们需要关注的点，也就是我们源码的入口</p>
<p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/23af43bca4492008ae3b80c10bd77c4f.png" alt="img"></p>
<p>在  <code>GlobalTransactionAutoConfiguration</code>  中我们找到一个用 Bean 注入的方法  <code>globalTransactionScanner</code> ，这个就是全局事务扫描器，这个类型主要负责加载配置，注入相关的 Bean</p>
<p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/0f9703310464018bedfecc661d4c4e91.png" alt="img"></p>
<p>这里给大家展示了当前 GlobalTransactionScanner 的类关系图，其中我们现在继承了 Aop 的 AbstractAutoProxyCreator 类型，在这其中有一个重点方法，这个方法就是判断 Bean 对象是否需要代理，是否需要增强。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableConfigurationProperties(SeataProperties.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GlobalTransactionAutoConfiguration</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//全局事务扫描器</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> GlobalTransactionScanner <span class="title function_">globalTransactionScanner</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">      <span class="type">String</span> <span class="variable">applicationName</span> <span class="operator">=</span> applicationContext.getEnvironment()</span><br><span class="line">          .getProperty(<span class="string">&quot;spring.application.name&quot;</span>);</span><br><span class="line"></span><br><span class="line">      <span class="type">String</span> <span class="variable">txServiceGroup</span> <span class="operator">=</span> seataProperties.getTxServiceGroup();</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (StringUtils.isEmpty(txServiceGroup)) &#123;</span><br><span class="line">        txServiceGroup = applicationName + <span class="string">&quot;-fescar-service-group&quot;</span>;</span><br><span class="line">        seataProperties.setTxServiceGroup(txServiceGroup);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// 构建全局扫描器，传入参数：应用名、事务分组名，失败处理器</span></span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">GlobalTransactionScanner</span>(applicationName, txServiceGroup);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在这其中我们要关心的是  <code>GlobalTransactionScanner</code>  这个类型，这个类型扫描  <code>@GlobalTransactional</code>  注解，并对代理方法进行拦截增强事务的功能。我们就从源码中搜索这个 <code>GlobalTransactionScanner</code>  类，看看里面具体是做了什么</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * The type Global transaction scanner.</span></span><br><span class="line"><span class="comment"> * 全局事务扫描器</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> slievrly</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GlobalTransactionScanner</span></span><br><span class="line">        <span class="comment">//AbstractAutoProxyCreator AOP动态代理 增强Bean</span></span><br><span class="line">        <span class="keyword">extends</span> <span class="title class_">AbstractAutoProxyCreator</span></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * ConfigurationChangeListener: 监听器基准接口</span></span><br><span class="line"><span class="comment">         * InitializingBean： Bean初始化</span></span><br><span class="line"><span class="comment">         * ApplicationContextAware： Spring容器</span></span><br><span class="line"><span class="comment">         * DisposableBean： Spring 容器销毁</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">implements</span> <span class="title class_">ConfigurationChangeListener</span>, InitializingBean, ApplicationContextAware, DisposableBean &#123;</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String applicationId;<span class="comment">//服务名</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String txServiceGroup;<span class="comment">//事务分组        </span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">initClient</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">//启动日志</span></span><br><span class="line">        <span class="keyword">if</span> (LOGGER.isInfoEnabled()) &#123;</span><br><span class="line">            LOGGER.info(<span class="string">&quot;Initializing Global Transaction Clients ... &quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//检查应用名以及事务分组名，为空抛出异常IllegalArgumentException</span></span><br><span class="line">        <span class="keyword">if</span> (DEFAULT_TX_GROUP_OLD.equals(txServiceGroup)) &#123;</span><br><span class="line">            LOGGER.warn(<span class="string">&quot;the default value of seata.tx-service-group: &#123;&#125; has already changed to &#123;&#125; since Seata 1.5, &quot;</span> +</span><br><span class="line">                    <span class="string">&quot;please change your default configuration as soon as possible &quot;</span> +</span><br><span class="line">                    <span class="string">&quot;and we don&#x27;t recommend you to use default tx-service-group&#x27;s value provided by seata&quot;</span>,</span><br><span class="line">                    DEFAULT_TX_GROUP_OLD, DEFAULT_TX_GROUP);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isNullOrEmpty(applicationId) || StringUtils.isNullOrEmpty(txServiceGroup)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(String.format(<span class="string">&quot;applicationId: %s, txServiceGroup: %s&quot;</span>, applicationId, txServiceGroup));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//init TM</span></span><br><span class="line">        <span class="comment">//初始化TM</span></span><br><span class="line">        TMClient.init(applicationId, txServiceGroup, accessKey, secretKey);</span><br><span class="line">        <span class="keyword">if</span> (LOGGER.isInfoEnabled()) &#123;</span><br><span class="line">            LOGGER.info(<span class="string">&quot;Transaction Manager Client is initialized. applicationId[&#123;&#125;] txServiceGroup[&#123;&#125;]&quot;</span>, applicationId, txServiceGroup);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//init RM</span></span><br><span class="line">        <span class="comment">//初始化RM</span></span><br><span class="line">        RMClient.init(applicationId, txServiceGroup);</span><br><span class="line">        <span class="keyword">if</span> (LOGGER.isInfoEnabled()) &#123;</span><br><span class="line">            LOGGER.info(<span class="string">&quot;Resource Manager is initialized. applicationId[&#123;&#125;] txServiceGroup[&#123;&#125;]&quot;</span>, applicationId, txServiceGroup);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (LOGGER.isInfoEnabled()) &#123;</span><br><span class="line">            LOGGER.info(<span class="string">&quot;Global Transaction Clients are initialized. &quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        registerSpringShutdownHook();</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">afterPropertiesSet</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (disableGlobalTransaction) &#123;</span><br><span class="line">            <span class="keyword">if</span> (LOGGER.isInfoEnabled()) &#123;</span><br><span class="line">                LOGGER.info(<span class="string">&quot;Global transaction is disabled.&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            ConfigurationCache.addConfigListener(ConfigurationKeys.DISABLE_GLOBAL_TRANSACTION,</span><br><span class="line">                    (ConfigurationChangeListener)<span class="built_in">this</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (initialized.compareAndSet(<span class="literal">false</span>, <span class="literal">true</span>)) &#123;</span><br><span class="line">            initClient();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">initClient</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">//启动日志</span></span><br><span class="line">        <span class="keyword">if</span> (LOGGER.isInfoEnabled()) &#123;</span><br><span class="line">            LOGGER.info(<span class="string">&quot;Initializing Global Transaction Clients ... &quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//检查应用名以及事务分组名，为空抛出异常IllegalArgumentException</span></span><br><span class="line">        <span class="keyword">if</span> (DEFAULT_TX_GROUP_OLD.equals(txServiceGroup)) &#123;</span><br><span class="line">            LOGGER.warn(<span class="string">&quot;the default value of seata.tx-service-group: &#123;&#125; has already changed to &#123;&#125; since Seata 1.5, &quot;</span> +</span><br><span class="line">                    <span class="string">&quot;please change your default configuration as soon as possible &quot;</span> +</span><br><span class="line">                    <span class="string">&quot;and we don&#x27;t recommend you to use default tx-service-group&#x27;s value provided by seata&quot;</span>,</span><br><span class="line">                    DEFAULT_TX_GROUP_OLD, DEFAULT_TX_GROUP);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//检查应用名以及事务分组名，为空抛出异常IllegalArgumentException</span></span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isNullOrEmpty(applicationId) || StringUtils.isNullOrEmpty(txServiceGroup)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(String.format(<span class="string">&quot;applicationId: %s, txServiceGroup: %s&quot;</span>, applicationId, txServiceGroup));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//init TM</span></span><br><span class="line">        <span class="comment">//初始化TM</span></span><br><span class="line">        TMClient.init(applicationId, txServiceGroup, accessKey, secretKey);</span><br><span class="line">        <span class="keyword">if</span> (LOGGER.isInfoEnabled()) &#123;</span><br><span class="line">            LOGGER.info(<span class="string">&quot;Transaction Manager Client is initialized. applicationId[&#123;&#125;] txServiceGroup[&#123;&#125;]&quot;</span>, applicationId, txServiceGroup);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//init RM</span></span><br><span class="line">        <span class="comment">//初始化RM</span></span><br><span class="line">        RMClient.init(applicationId, txServiceGroup);</span><br><span class="line">        <span class="keyword">if</span> (LOGGER.isInfoEnabled()) &#123;</span><br><span class="line">            LOGGER.info(<span class="string">&quot;Resource Manager is initialized. applicationId[&#123;&#125;] txServiceGroup[&#123;&#125;]&quot;</span>, applicationId, txServiceGroup);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (LOGGER.isInfoEnabled()) &#123;</span><br><span class="line">            LOGGER.info(<span class="string">&quot;Global Transaction Clients are initialized. &quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        registerSpringShutdownHook();</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//代理增强，Spring 所有的Bean都会经过这个方法</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> Object <span class="title function_">wrapIfNecessary</span><span class="params">(Object bean, String beanName, Object cacheKey)</span> &#123;</span><br><span class="line">        <span class="comment">// do checkers</span></span><br><span class="line">        <span class="comment">//检查bean和beanName</span></span><br><span class="line">        <span class="keyword">if</span> (!doCheckers(bean, beanName)) &#123;</span><br><span class="line">            <span class="keyword">return</span> bean;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//加锁防止并发</span></span><br><span class="line">            <span class="keyword">synchronized</span> (PROXYED_SET) &#123;</span><br><span class="line">                <span class="keyword">if</span> (PROXYED_SET.contains(beanName)) &#123;</span><br><span class="line">                    <span class="keyword">return</span> bean;</span><br><span class="line">                &#125;</span><br><span class="line">                interceptor = <span class="literal">null</span>;</span><br><span class="line">                <span class="comment">//check TCC proxy</span></span><br><span class="line">                <span class="comment">//检查是否为TCC模式</span></span><br><span class="line">                <span class="keyword">if</span> (TCCBeanParserUtils.isTccAutoProxy(bean, beanName, applicationContext)) &#123;</span><br><span class="line">                    <span class="comment">// init tcc fence clean task if enable useTccFence</span></span><br><span class="line">                    <span class="comment">//如果启用useTccFence 失败 ，则初始化TCC清理任务</span></span><br><span class="line">                    TCCBeanParserUtils.initTccFenceCleanTask(TCCBeanParserUtils.getRemotingDesc(beanName), applicationContext);</span><br><span class="line">                    <span class="comment">//TCC interceptor, proxy bean of sofa:reference/dubbo:reference, and LocalTCC</span></span><br><span class="line">                    <span class="comment">//如果是，添加TCC拦截器</span></span><br><span class="line">                    interceptor = <span class="keyword">new</span> <span class="title class_">TccActionInterceptor</span>(TCCBeanParserUtils.getRemotingDesc(beanName));</span><br><span class="line">                    ConfigurationCache.addConfigListener(ConfigurationKeys.DISABLE_GLOBAL_TRANSACTION,</span><br><span class="line">                            (ConfigurationChangeListener)interceptor);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="comment">//不是TCC</span></span><br><span class="line">                    Class&lt;?&gt; serviceInterface = SpringProxyUtils.findTargetClass(bean);</span><br><span class="line">                    Class&lt;?&gt;[] interfacesIfJdk = SpringProxyUtils.findInterfaces(bean);</span><br><span class="line"></span><br><span class="line">                    <span class="comment">//判断是否有相关事务注解，如果没有不进行代理</span></span><br><span class="line">                    <span class="keyword">if</span> (!existsAnnotation(<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;serviceInterface&#125;)</span><br><span class="line">                        &amp;&amp; !existsAnnotation(interfacesIfJdk)) &#123;</span><br><span class="line">                        <span class="keyword">return</span> bean;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="comment">//发现存在全局事务注解标注的Bean对象，添加拦截器</span></span><br><span class="line">                    <span class="keyword">if</span> (globalTransactionalInterceptor == <span class="literal">null</span>) &#123;</span><br><span class="line">                        <span class="comment">//添加拦截器</span></span><br><span class="line">                        globalTransactionalInterceptor = <span class="keyword">new</span> <span class="title class_">GlobalTransactionalInterceptor</span>(failureHandlerHook);</span><br><span class="line">                        ConfigurationCache.addConfigListener(</span><br><span class="line">                                ConfigurationKeys.DISABLE_GLOBAL_TRANSACTION,</span><br><span class="line">                                (ConfigurationChangeListener)globalTransactionalInterceptor);</span><br><span class="line">                    &#125;</span><br><span class="line">                    interceptor = globalTransactionalInterceptor;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                LOGGER.info(<span class="string">&quot;Bean[&#123;&#125;] with name [&#123;&#125;] would use interceptor [&#123;&#125;]&quot;</span>, bean.getClass().getName(), beanName, interceptor.getClass().getName());</span><br><span class="line">                <span class="comment">//检查是否为代理对象</span></span><br><span class="line">                <span class="keyword">if</span> (!AopUtils.isAopProxy(bean)) &#123;</span><br><span class="line">                    <span class="comment">//不是代理对象，调用父级</span></span><br><span class="line">                    bean = <span class="built_in">super</span>.wrapIfNecessary(bean, beanName, cacheKey);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="comment">//是代理对象，反射获取代理类中已经存在的拦截器组合，然后添加到这个集合中</span></span><br><span class="line">                    <span class="type">AdvisedSupport</span> <span class="variable">advised</span> <span class="operator">=</span> SpringProxyUtils.getAdvisedSupport(bean);</span><br><span class="line">                    Advisor[] advisor = buildAdvisors(beanName, getAdvicesAndAdvisorsForBean(<span class="literal">null</span>, <span class="literal">null</span>, <span class="literal">null</span>));</span><br><span class="line">                    <span class="type">int</span> pos;</span><br><span class="line">                    <span class="keyword">for</span> (Advisor avr : advisor) &#123;</span><br><span class="line">                        <span class="comment">// Find the position based on the advisor&#x27;s order, and add to advisors by pos</span></span><br><span class="line">                        pos = findAddSeataAdvisorPosition(advised, avr);</span><br><span class="line">                        advised.addAdvisor(pos, avr);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                PROXYED_SET.add(beanName);</span><br><span class="line">                <span class="keyword">return</span> bean;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception exx) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(exx);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">InitializingBean`：中实现了一个 `afterPropertiesSet()`方法，在这个方法中，调用了`initClient()</span><br></pre></td></tr></table></figure>
<p><code>AbstractAutoProxyCreator</code> ：APO 动态代理，在之前的的 Nacos 和 Sentiel 中都有这个代理类，AOP 在我们越往深入学习，在学习源码的会见到的越来越多，越来越重要，很多相关代理，都是通过 AOP 进行增强，在这个类中，我们需要关注有一个 <code>wrapIfNecessary()</code>  方法， 这个方法主要是判断被代理的 bean 或者类是否需要代理增强，在这个方法中会调用 <code>GlobalTransactionalInterceptor.invoke()</code>  进行带来增强。</p>
<p>具体代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GlobalTransactionalInterceptor</span> <span class="keyword">implements</span> <span class="title class_">ConfigurationChangeListener</span>, MethodInterceptor, SeataInterceptor &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">GlobalTransactionalInterceptor</span><span class="params">(FailureHandler failureHandler)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.failureHandler = failureHandler == <span class="literal">null</span> ? DEFAULT_FAIL_HANDLER : failureHandler;</span><br><span class="line">        <span class="built_in">this</span>.disable = ConfigurationFactory.getInstance().getBoolean(ConfigurationKeys.DISABLE_GLOBAL_TRANSACTION,</span><br><span class="line">            DEFAULT_DISABLE_GLOBAL_TRANSACTION);</span><br><span class="line">        <span class="built_in">this</span>.order =</span><br><span class="line">            ConfigurationFactory.getInstance().getInt(ConfigurationKeys.TM_INTERCEPTOR_ORDER, TM_INTERCEPTOR_ORDER);</span><br><span class="line">        degradeCheck = ConfigurationFactory.getInstance().getBoolean(ConfigurationKeys.CLIENT_DEGRADE_CHECK,</span><br><span class="line">            DEFAULT_TM_DEGRADE_CHECK);</span><br><span class="line">        <span class="keyword">if</span> (degradeCheck) &#123;</span><br><span class="line">            ConfigurationCache.addConfigListener(ConfigurationKeys.CLIENT_DEGRADE_CHECK, <span class="built_in">this</span>);</span><br><span class="line">            degradeCheckPeriod = ConfigurationFactory.getInstance()</span><br><span class="line">                .getInt(ConfigurationKeys.CLIENT_DEGRADE_CHECK_PERIOD, DEFAULT_TM_DEGRADE_CHECK_PERIOD);</span><br><span class="line">            degradeCheckAllowTimes = ConfigurationFactory.getInstance()</span><br><span class="line">                .getInt(ConfigurationKeys.CLIENT_DEGRADE_CHECK_ALLOW_TIMES, DEFAULT_TM_DEGRADE_CHECK_ALLOW_TIMES);</span><br><span class="line">            EVENT_BUS.register(<span class="built_in">this</span>);</span><br><span class="line">            <span class="keyword">if</span> (degradeCheckPeriod &gt; <span class="number">0</span> &amp;&amp; degradeCheckAllowTimes &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                startDegradeCheck();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">this</span>.initDefaultGlobalTransactionTimeout();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">invoke</span><span class="params">(<span class="keyword">final</span> MethodInvocation methodInvocation)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">        <span class="comment">//获取执行的方法</span></span><br><span class="line">        Class&lt;?&gt; targetClass =</span><br><span class="line">            methodInvocation.getThis() != <span class="literal">null</span> ? AopUtils.getTargetClass(methodInvocation.getThis()) : <span class="literal">null</span>;</span><br><span class="line">        <span class="type">Method</span> <span class="variable">specificMethod</span> <span class="operator">=</span> ClassUtils.getMostSpecificMethod(methodInvocation.getMethod(), targetClass);</span><br><span class="line">        <span class="keyword">if</span> (specificMethod != <span class="literal">null</span> &amp;&amp; !specificMethod.getDeclaringClass().equals(Object.class)) &#123;</span><br><span class="line">            <span class="keyword">final</span> <span class="type">Method</span> <span class="variable">method</span> <span class="operator">=</span> BridgeMethodResolver.findBridgedMethod(specificMethod);</span><br><span class="line">            <span class="comment">//获取GlobalTransactional（全局事务）、GlobalLock(全局锁)元数据</span></span><br><span class="line">            <span class="keyword">final</span> <span class="type">GlobalTransactional</span> <span class="variable">globalTransactionalAnnotation</span> <span class="operator">=</span></span><br><span class="line">                getAnnotation(method, targetClass, GlobalTransactional.class);</span><br><span class="line">            <span class="comment">//GlobalLock会将本地事务的执行纳入Seata分布式事务的管理，共同竞争全局锁</span></span><br><span class="line">            <span class="comment">//保证全局事务在执行的时候，本地事务不可以操作全局事务的记录</span></span><br><span class="line">            <span class="keyword">final</span> <span class="type">GlobalLock</span> <span class="variable">globalLockAnnotation</span> <span class="operator">=</span> getAnnotation(method, targetClass, GlobalLock.class);<span class="comment">//获取全局锁</span></span><br><span class="line">            <span class="type">boolean</span> <span class="variable">localDisable</span> <span class="operator">=</span> disable || (degradeCheck &amp;&amp; degradeNum &gt;= degradeCheckAllowTimes);</span><br><span class="line">            <span class="keyword">if</span> (!localDisable) &#123;</span><br><span class="line">                <span class="keyword">if</span> (globalTransactionalAnnotation != <span class="literal">null</span> || <span class="built_in">this</span>.aspectTransactional != <span class="literal">null</span>) &#123;</span><br><span class="line">                    AspectTransactional transactional;</span><br><span class="line">                    <span class="keyword">if</span> (globalTransactionalAnnotation != <span class="literal">null</span>) &#123;</span><br><span class="line">                        transactional = <span class="keyword">new</span> <span class="title class_">AspectTransactional</span>(globalTransactionalAnnotation.timeoutMills(),</span><br><span class="line">                            globalTransactionalAnnotation.name(), globalTransactionalAnnotation.rollbackFor(),</span><br><span class="line">                            globalTransactionalAnnotation.noRollbackForClassName(),</span><br><span class="line">                            globalTransactionalAnnotation.noRollbackFor(),</span><br><span class="line">                            globalTransactionalAnnotation.noRollbackForClassName(),</span><br><span class="line">                            globalTransactionalAnnotation.propagation(),</span><br><span class="line">                            globalTransactionalAnnotation.lockRetryInterval(),</span><br><span class="line">                            globalTransactionalAnnotation.lockRetryTimes());</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        transactional = <span class="built_in">this</span>.aspectTransactional;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="comment">//执行全局事务</span></span><br><span class="line">                    <span class="keyword">return</span> handleGlobalTransaction(methodInvocation, transactional);</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (globalLockAnnotation != <span class="literal">null</span>) &#123;</span><br><span class="line">                    <span class="comment">//执行全局锁</span></span><br><span class="line">                    <span class="keyword">return</span> handleGlobalLock(methodInvocation, globalLockAnnotation);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> methodInvocation.proceed();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>具体流程图如下所示：</p>
<p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/45838801f4caeefec5623a955be68146.png" alt="img"></p>
<h2 id="核心源码"><a class="markdownIt-Anchor" href="#核心源码">#</a> 核心源码</h2>
<p>在上面我们讲解到  <code>GlobalTransactionalInterceptor</code>  作为全局事务拦截器，一旦执行拦截，就会进入 invoke 方法，其中，我们会做  <code>@GlobalTransactional</code>  注解的判断，如果有这个注解的存在，会执行全局事务和全局锁，再执行全局事务的时候会调用  <code>handleGlobalTransaction</code>  全局事务处理器，获取事务信息，那我们接下来就来看一下  <code>GlobalTransactionalInterceptor.handleGlobalTransaction</code>  到底是如何执行全局事务的</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line">Object <span class="title function_">handleGlobalTransaction</span><span class="params">(<span class="keyword">final</span> MethodInvocation methodInvocation,</span></span><br><span class="line"><span class="params">        <span class="keyword">final</span> AspectTransactional aspectTransactional)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">succeed</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> transactionalTemplate.execute(<span class="keyword">new</span> <span class="title class_">TransactionalExecutor</span>() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="keyword">public</span> Object <span class="title function_">execute</span><span class="params">()</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">                    <span class="keyword">return</span> methodInvocation.proceed();</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">//获取事务名称，默认获取方法名</span></span><br><span class="line">                <span class="keyword">public</span> String <span class="title function_">name</span><span class="params">()</span> &#123;</span><br><span class="line">                    <span class="type">String</span> <span class="variable">name</span> <span class="operator">=</span> aspectTransactional.getName();</span><br><span class="line">                    <span class="keyword">if</span> (!StringUtils.isNullOrEmpty(name)) &#123;</span><br><span class="line">                        <span class="keyword">return</span> name;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">return</span> formatMethod(methodInvocation.getMethod());</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">/**</span></span><br><span class="line"><span class="comment">                 * 解析GlobalTransation注解属性，封装对对象</span></span><br><span class="line"><span class="comment">                 * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">                 */</span></span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="keyword">public</span> TransactionInfo <span class="title function_">getTransactionInfo</span><span class="params">()</span> &#123;</span><br><span class="line">                    <span class="comment">// reset the value of timeout</span></span><br><span class="line">                    <span class="comment">//获取超时时间，默认60秒</span></span><br><span class="line">                    <span class="type">int</span> <span class="variable">timeout</span> <span class="operator">=</span> aspectTransactional.getTimeoutMills();</span><br><span class="line">                    <span class="keyword">if</span> (timeout &lt;= <span class="number">0</span> || timeout == DEFAULT_GLOBAL_TRANSACTION_TIMEOUT) &#123;</span><br><span class="line">                        timeout = defaultGlobalTransactionTimeout;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="comment">//构建事务信息对象</span></span><br><span class="line">                    <span class="type">TransactionInfo</span> <span class="variable">transactionInfo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TransactionInfo</span>();</span><br><span class="line">                    transactionInfo.setTimeOut(timeout);<span class="comment">//超时时间</span></span><br><span class="line">                    transactionInfo.setName(name());<span class="comment">//事务名称</span></span><br><span class="line">                    transactionInfo.setPropagation(aspectTransactional.getPropagation());<span class="comment">//事务传播</span></span><br><span class="line">                    transactionInfo.setLockRetryInterval(aspectTransactional.getLockRetryInterval());<span class="comment">//校验或占用全局锁重试间隔</span></span><br><span class="line">                    transactionInfo.setLockRetryTimes(aspectTransactional.getLockRetryTimes());<span class="comment">//校验或占用全局锁重试次数</span></span><br><span class="line">                    Set&lt;RollbackRule&gt; rollbackRules = <span class="keyword">new</span> <span class="title class_">LinkedHashSet</span>&lt;&gt;();</span><br><span class="line">                    <span class="comment">//其他构建信息</span></span><br><span class="line">                    <span class="keyword">for</span> (Class&lt;?&gt; rbRule : aspectTransactional.getRollbackFor()) &#123;</span><br><span class="line">                        rollbackRules.add(<span class="keyword">new</span> <span class="title class_">RollbackRule</span>(rbRule));</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">for</span> (String rbRule : aspectTransactional.getRollbackForClassName()) &#123;</span><br><span class="line">                        rollbackRules.add(<span class="keyword">new</span> <span class="title class_">RollbackRule</span>(rbRule));</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">for</span> (Class&lt;?&gt; rbRule : aspectTransactional.getNoRollbackFor()) &#123;</span><br><span class="line">                        rollbackRules.add(<span class="keyword">new</span> <span class="title class_">NoRollbackRule</span>(rbRule));</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">for</span> (String rbRule : aspectTransactional.getNoRollbackForClassName()) &#123;</span><br><span class="line">                        rollbackRules.add(<span class="keyword">new</span> <span class="title class_">NoRollbackRule</span>(rbRule));</span><br><span class="line">                    &#125;</span><br><span class="line">                    transactionInfo.setRollbackRules(rollbackRules);</span><br><span class="line">                    <span class="keyword">return</span> transactionInfo;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (TransactionalExecutor.ExecutionException e) &#123;</span><br><span class="line">            <span class="comment">//执行异常</span></span><br><span class="line">            TransactionalExecutor.<span class="type">Code</span> <span class="variable">code</span> <span class="operator">=</span> e.getCode();</span><br><span class="line">            <span class="keyword">switch</span> (code) &#123;</span><br><span class="line">                <span class="keyword">case</span> RollbackDone:</span><br><span class="line">                    <span class="keyword">throw</span> e.getOriginalException();</span><br><span class="line">                <span class="keyword">case</span> BeginFailure:</span><br><span class="line">                    succeed = <span class="literal">false</span>;</span><br><span class="line">                    failureHandler.onBeginFailure(e.getTransaction(), e.getCause());</span><br><span class="line">                    <span class="keyword">throw</span> e.getCause();</span><br><span class="line">                <span class="keyword">case</span> CommitFailure:</span><br><span class="line">                    succeed = <span class="literal">false</span>;</span><br><span class="line">                    failureHandler.onCommitFailure(e.getTransaction(), e.getCause());</span><br><span class="line">                    <span class="keyword">throw</span> e.getCause();</span><br><span class="line">                <span class="keyword">case</span> RollbackFailure:</span><br><span class="line">                    failureHandler.onRollbackFailure(e.getTransaction(), e.getOriginalException());</span><br><span class="line">                    <span class="keyword">throw</span> e.getOriginalException();</span><br><span class="line">                <span class="keyword">case</span> RollbackRetrying:</span><br><span class="line">                    failureHandler.onRollbackRetrying(e.getTransaction(), e.getOriginalException());</span><br><span class="line">                    <span class="keyword">throw</span> e.getOriginalException();</span><br><span class="line">                <span class="keyword">default</span>:</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ShouldNeverHappenException</span>(String.format(<span class="string">&quot;Unknown TransactionalExecutor.Code: %s&quot;</span>, code));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (degradeCheck) &#123;</span><br><span class="line">                EVENT_BUS.post(<span class="keyword">new</span> <span class="title class_">DegradeCheckEvent</span>(succeed));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>在这里我们，主要关注一个重点方法  <code>execute()</code> ，这个方法主要用来执行事务的具体流程：</p>
<ul>
<li>获取事务信息</li>
<li>执行全局事务</li>
<li>发生异常全局回滚，各个数据通过 UndoLog 进行事务补偿</li>
<li>全局事务提交</li>
<li>清除所有资源</li>
</ul>
<p>这个位置也是一个非常核心的一个位置，因为我们所有的业务进来以后都会去走这个位置，具体源码如下所示：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Object <span class="title function_">execute</span><span class="params">(TransactionalExecutor business)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">    <span class="comment">// 1. Get transactionInfo</span></span><br><span class="line">    <span class="comment">//获取事务信息</span></span><br><span class="line">    <span class="type">TransactionInfo</span> <span class="variable">txInfo</span> <span class="operator">=</span> business.getTransactionInfo();</span><br><span class="line">    <span class="keyword">if</span> (txInfo == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ShouldNeverHappenException</span>(<span class="string">&quot;transactionInfo does not exist&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 1.1 Get current transaction, if not null, the tx role is &#x27;GlobalTransactionRole.Participant&#x27;.</span></span><br><span class="line">    <span class="comment">//获取当前事务，主要获取XID</span></span><br><span class="line">    <span class="type">GlobalTransaction</span> <span class="variable">tx</span> <span class="operator">=</span> GlobalTransactionContext.getCurrent();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 1.2 Handle the transaction propagation.</span></span><br><span class="line">    <span class="comment">//根据配置的不同事务传播行为，执行不同的逻辑</span></span><br><span class="line">    <span class="type">Propagation</span> <span class="variable">propagation</span> <span class="operator">=</span> txInfo.getPropagation();</span><br><span class="line">    <span class="type">SuspendedResourcesHolder</span> <span class="variable">suspendedResourcesHolder</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">switch</span> (propagation) &#123;</span><br><span class="line">            <span class="keyword">case</span> NOT_SUPPORTED:</span><br><span class="line">                <span class="comment">// If transaction is existing, suspend it.</span></span><br><span class="line">                <span class="keyword">if</span> (existingTransaction(tx)) &#123;</span><br><span class="line">                    suspendedResourcesHolder = tx.suspend();</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// Execute without transaction and return.</span></span><br><span class="line">                <span class="keyword">return</span> business.execute();</span><br><span class="line">            <span class="keyword">case</span> REQUIRES_NEW:</span><br><span class="line">                <span class="comment">// If transaction is existing, suspend it, and then begin new transaction.</span></span><br><span class="line">                <span class="keyword">if</span> (existingTransaction(tx)) &#123;</span><br><span class="line">                    suspendedResourcesHolder = tx.suspend();</span><br><span class="line">                    tx = GlobalTransactionContext.createNew();</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// Continue and execute with new transaction</span></span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> SUPPORTS:</span><br><span class="line">                <span class="comment">// If transaction is not existing, execute without transaction.</span></span><br><span class="line">                <span class="keyword">if</span> (notExistingTransaction(tx)) &#123;</span><br><span class="line">                    <span class="keyword">return</span> business.execute();</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// Continue and execute with new transaction</span></span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> REQUIRED:</span><br><span class="line">                <span class="comment">// If current transaction is existing, execute with current transaction,</span></span><br><span class="line">                <span class="comment">// else continue and execute with new transaction.</span></span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> NEVER:</span><br><span class="line">                <span class="comment">// If transaction is existing, throw exception.</span></span><br><span class="line">                <span class="keyword">if</span> (existingTransaction(tx)) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">TransactionException</span>(</span><br><span class="line">                        String.format(<span class="string">&quot;Existing transaction found for transaction marked with propagation &#x27;never&#x27;, xid = %s&quot;</span></span><br><span class="line">                                , tx.getXid()));</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="comment">// Execute without transaction and return.</span></span><br><span class="line">                    <span class="keyword">return</span> business.execute();</span><br><span class="line">                &#125;</span><br><span class="line">            <span class="keyword">case</span> MANDATORY:</span><br><span class="line">                <span class="comment">// If transaction is not existing, throw exception.</span></span><br><span class="line">                <span class="keyword">if</span> (notExistingTransaction(tx)) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">TransactionException</span>(<span class="string">&quot;No existing transaction found for transaction marked with propagation &#x27;mandatory&#x27;&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// Continue and execute with current transaction.</span></span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">TransactionException</span>(<span class="string">&quot;Not Supported Propagation:&quot;</span> + propagation);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 1.3 If null, create new transaction with role &#x27;GlobalTransactionRole.Launcher&#x27;.</span></span><br><span class="line">        <span class="comment">//如果当前事务为空，创建一个新的事务</span></span><br><span class="line">        <span class="keyword">if</span> (tx == <span class="literal">null</span>) &#123;</span><br><span class="line">            tx = GlobalTransactionContext.createNew();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// set current tx config to holder</span></span><br><span class="line">        <span class="type">GlobalLockConfig</span> <span class="variable">previousConfig</span> <span class="operator">=</span> replaceGlobalLockConfig(txInfo);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 2. If the tx role is &#x27;GlobalTransactionRole.Launcher&#x27;, send the request of beginTransaction to TC,</span></span><br><span class="line">            <span class="comment">//    else do nothing. Of course, the hooks will still be triggered.</span></span><br><span class="line">            <span class="comment">//开始执行全局事务</span></span><br><span class="line">            beginTransaction(txInfo, tx);</span><br><span class="line"></span><br><span class="line">            Object rs;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// Do Your Business</span></span><br><span class="line">                <span class="comment">// 执行当前业务逻辑</span></span><br><span class="line">                <span class="comment">//1、在TC注册当前分支事务，TC会在branch_table中插入一条分支事务数据</span></span><br><span class="line">                <span class="comment">//2、执行本地update语句，并在执行前后查询数据状态，并把数据前后镜像存入到undo_log中</span></span><br><span class="line">                <span class="comment">//3、远程调用其他应用，远程应用接收到XID，也会注册分支事务，写入branch_table以及本地undo_log表</span></span><br><span class="line">                <span class="comment">//4、会在lock_table表中插入全局锁数据（一个分支一条）</span></span><br><span class="line">                rs = business.execute();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Throwable ex) &#123;</span><br><span class="line">                <span class="comment">// 3. The needed business exception to rollback.</span></span><br><span class="line">                <span class="comment">//发生异常全局回滚，每个事务通过undo_log表进行事务补偿</span></span><br><span class="line">                completeTransactionAfterThrowing(txInfo, tx, ex);</span><br><span class="line">                <span class="keyword">throw</span> ex;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 4. everything is fine, commit.</span></span><br><span class="line">            <span class="comment">//全局提交</span></span><br><span class="line">            commitTransaction(tx);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> rs;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="comment">//5. clear</span></span><br><span class="line">            <span class="comment">//清理所有资源</span></span><br><span class="line">            resumeGlobalLockConfig(previousConfig);</span><br><span class="line">            triggerAfterCompletion();</span><br><span class="line">            cleanUp();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="comment">// If the transaction is suspended, resume it.</span></span><br><span class="line">        <span class="keyword">if</span> (suspendedResourcesHolder != <span class="literal">null</span>) &#123;</span><br><span class="line">            tx.resume(suspendedResourcesHolder);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这其中的第三步和第四步其实在向 TC（Seata-Server）发起全局事务的提交或者回滚，在这里我们首先关注执行全局事务的  <code>beginTransaction()</code>  方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 向TC发起请求，采用模板模式</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">beginTransaction</span><span class="params">(TransactionInfo txInfo, GlobalTransaction tx)</span> <span class="keyword">throws</span> TransactionalExecutor.ExecutionException &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        triggerBeforeBegin();</span><br><span class="line">        <span class="comment">//对TC发起请求</span></span><br><span class="line">        tx.begin(txInfo.getTimeOut(), txInfo.getName());</span><br><span class="line">        triggerAfterBegin();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (TransactionException txe) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">TransactionalExecutor</span>.ExecutionException(tx, txe,</span><br><span class="line">            TransactionalExecutor.Code.BeginFailure);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在来关注其中，向 TC 发起请求的  <code>tx.begin()</code>  方法，而调用 <code>begin()</code>  方法的类为： <code>DefaultGlobalTransaction</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">begin</span><span class="params">(<span class="type">int</span> timeout, String name)</span> <span class="keyword">throws</span> TransactionException &#123;</span><br><span class="line">       <span class="comment">//判断调用者是否为TM</span></span><br><span class="line">       <span class="keyword">if</span> (role != GlobalTransactionRole.Launcher) &#123;</span><br><span class="line">           assertXIDNotNull();</span><br><span class="line">           <span class="keyword">if</span> (LOGGER.isDebugEnabled()) &#123;</span><br><span class="line">               LOGGER.debug(<span class="string">&quot;Ignore Begin(): just involved in global transaction [&#123;&#125;]&quot;</span>, xid);</span><br><span class="line">           &#125;</span><br><span class="line">           <span class="keyword">return</span>;</span><br><span class="line">       &#125;</span><br><span class="line">       assertXIDNull();</span><br><span class="line">       <span class="type">String</span> <span class="variable">currentXid</span> <span class="operator">=</span> RootContext.getXID();</span><br><span class="line">       <span class="keyword">if</span> (currentXid != <span class="literal">null</span>) &#123;</span><br><span class="line">           <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(<span class="string">&quot;Global transaction already exists,&quot;</span> +</span><br><span class="line">               <span class="string">&quot; can&#x27;t begin a new global transaction, currentXid = &quot;</span> + currentXid);</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="comment">//获取XID</span></span><br><span class="line">       xid = transactionManager.begin(<span class="literal">null</span>, <span class="literal">null</span>, name, timeout);</span><br><span class="line">       status = GlobalStatus.Begin;</span><br><span class="line">       <span class="comment">//绑定XID</span></span><br><span class="line">       RootContext.bind(xid);</span><br><span class="line">       <span class="keyword">if</span> (LOGGER.isInfoEnabled()) &#123;</span><br><span class="line">           LOGGER.info(<span class="string">&quot;Begin new global transaction [&#123;&#125;]&quot;</span>, xid);</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>再来看一下  <code>transactionManager.begin()</code>  方法，这个时候使用的是  <code>DefaultTransactionManager.begin</code>  默认的事务管理者，来获取 XID，传入事务相关的信息 ，最好 TC 返回对应的全局事务 XID，它调用的是 <code>DefaultTransactionManager.begin()</code>  方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> String <span class="title function_">begin</span><span class="params">(String applicationId, String transactionServiceGroup, String name, <span class="type">int</span> timeout)</span></span><br><span class="line">    <span class="keyword">throws</span> TransactionException &#123;</span><br><span class="line">    <span class="type">GlobalBeginRequest</span> <span class="variable">request</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">GlobalBeginRequest</span>();</span><br><span class="line">    request.setTransactionName(name);</span><br><span class="line">    request.setTimeout(timeout);</span><br><span class="line">    <span class="comment">//发送请求得到响应</span></span><br><span class="line">    <span class="type">GlobalBeginResponse</span> <span class="variable">response</span> <span class="operator">=</span> (GlobalBeginResponse) syncCall(request);</span><br><span class="line">    <span class="keyword">if</span> (response.getResultCode() == ResultCode.Failed) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">TmTransactionException</span>(TransactionExceptionCode.BeginFailed, response.getMsg());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//返回XID</span></span><br><span class="line">    <span class="keyword">return</span> response.getXid();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在这里我们需要关注一个 <code>syncCall</code> ，在这里采用的是 Netty 通讯方式</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> AbstractTransactionResponse <span class="title function_">syncCall</span><span class="params">(AbstractTransactionRequest request)</span> <span class="keyword">throws</span> TransactionException &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// 通过Netty发送请求</span></span><br><span class="line">        <span class="keyword">return</span> (AbstractTransactionResponse) TmNettyRemotingClient.getInstance().sendSyncRequest(request);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (TimeoutException toe) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">TmTransactionException</span>(TransactionExceptionCode.IO, <span class="string">&quot;RPC timeout&quot;</span>, toe);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>具体图解如下：</p>
<p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/58f1038f3648c3d95be79c183eb151b6.png" alt="img"></p>
<p>在这里我们需要重点了解  <code>GlobalTransactionScanner</code>  这个类型，在这个类型中继承了一些接口和抽象类，这个类主要作用就是扫描有注解的 Bean，并做 AOP 增强。</p>
<ul>
<li><code>ApplicationContextAware</code> ：继承这个类型以后，需要实现其方法  <code>setApplicationContext()</code> ，当 Spring 启动完成以后，会自动调用这个类型，将  <code>ApplicationContext</code>  给  <code>bean</code> ，也就是说，  <code>GlobalTransactionScanner</code>  能够很自然的使用 Spring 环境</li>
<li><code>InitializingBean</code> ： 继承这个接口，需要实现  <code>afterPropertiesSet()</code>  ，但凡是继承这个接口的类，在初始化的时候，当所有的  <code>properties</code>  设置完成以后，会执行这个方法</li>
<li><code>DisposableBean</code>  ： 这个类，实现了一个  <code>destroy()</code>  这个方法是在销毁的时候去调用</li>
<li><code>AbstractAutoProxyCreator</code> ： 这个类是 Spring 实现 AOP 的一种方式，本质上是一个  <code>BeanPostProcessor</code>  ，在 Bean 初始化至去年，调用内部  <code>createProxy()</code>  ，创建一个 Bean 的 AOP 代理 Bean 并返回，对 Bean 进行增强。</li>
</ul>
<h2 id="seata数据源代理"><a class="markdownIt-Anchor" href="#seata数据源代理">#</a> Seata 数据源代理</h2>
<p>在上面的环节中，我们讲解了 Seata AT 模式 2PC 的执行流程，那么现在我们就来带大家了解一下关于 AT 数据源代理的信息，这也是 AT 模式中非常关键的一个重要知识点，大家可以拿起小本子，记下来。</p>
<p>首先 AT 模式的核心主要分为一下两个</p>
<ul>
<li>开启全局事务，获取全局锁。</li>
<li>解析 SQL 并写入 undoLog 中。</li>
</ul>
<p>关于第一点我们已经分析清楚了，第二点就是关于 AT 模式如何解析 SQL 并写入 undoLog 中，但是在这之前，我们需要知道 Seata 是如何选择数据源，并进行数据源代理的。虽然全局事务拦截成功后最终还是执行了业务方法进行 SQL 提交和操作，但是由于 Seata 对数据源进行了代理，所以 SQL 的解析和 undoLog 的操作，是在数据源代理中进行完成的。</p>
<p>数据源代理是 Seata 中一个非常重要的知识点，在<a target="_blank" rel="noopener" href="https://so.csdn.net/so/search?q=%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1&amp;spm=1001.2101.3001.7020">分布式事务</a>运行过程中，undoLog 的记录、资源的锁定，用户都是无感知的，因为这些操作都是数据源的代理中完成了，恰恰是这样，我们才要去了解，这样不仅有利于我们了解 Seata 的核心操作，还能对以后源码阅读有所帮助，因为其实很多底层代码都会去使用这样用户无感知的方式 (代理) 去实现。</p>
<p>同样，我们在之前的寻找源码入口的时候，通过我们项目中引入的 jar 找到一个  <code>SeataAutoConfiguration</code>  类，我们在里面找到一个 <code>SeataDataSourceBeanPostProcessor()</code> ，这个就是我们数据源代理的入口方法</p>
<p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/78c4564099e2c372a310458314d545e9.png" alt="img"></p>
<p>我们进入 <code>SeataDataSourceBeanPostProcessor</code>  类里面，发现继承了一个  <code>BeanPostProcessor</code>  , 这个接口我们应该很熟悉，这个是 Sprng 的拓展接口，所有的 Bean 对象，都有进入两个方法  <code>postProcessAfterInitialization()</code>  和  <code>postProcessBeforeInitialization()</code>  这两个方法都是由  <code>BeanPostProcessor</code>  提供的，这两个方法，一个是初始化之前执行 <code>Before</code> 。一个是在初始化之后执行 <code>After</code> ，主要用来对比我们的的 Bean 是否为数据源代理对象。</p>
<p>在这里我们需要关注到一个 <code>postProcessAfterInitialization.proxyDataSource()</code>  方法，这个里面</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> Object <span class="title function_">proxyDataSource</span><span class="params">(Object originBean)</span> &#123;</span><br><span class="line">    <span class="type">DataSourceProxy</span> <span class="variable">dataSourceProxy</span> <span class="operator">=</span> DataSourceProxyHolder.get().putDataSource((DataSource) originBean);</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">this</span>.useJdkProxy) &#123;</span><br><span class="line">        <span class="keyword">return</span> Proxy.newProxyInstance(Thread.currentThread().getContextClassLoader(), SpringProxyUtils.getAllInterfaces(originBean), (proxy, method, args) -&gt; handleMethodProxy(dataSourceProxy, method, args, originBean));</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> Enhancer.create(originBean.getClass(), (MethodInterceptor) (proxy, method, args, methodProxy) -&gt; handleMethodProxy(dataSourceProxy, method, args, originBean));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里有一个 <code>DataSourceProxy</code>  代理对象，我们需要看的就是这个类，这个就是我们数据库代理的对象，我们从我们下载的源码项目中，搜索这个代理对象，当我们打开这个类的目录时发现，除了这个，还有 <code>ConnectionProxy</code>  连接对象、 <code>StatementProxy</code> 、 <code>PreparedStatementProxy</code>  SQL 执行对象，这些都被 Seata 进行了代理，为什么要对这些都进行代理，代理的目的其实为了执行 Seata 的业务逻辑，生成 undoLog，全局事务的开启，事务的提交回滚等操作</p>
<p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/ef54a9c5142d96cf230b7938f60a9145.png" alt="img"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">DataSourceProxy` 具体做了什么，主要功能有哪些，我们来看一下。他在源码中是如何体现的，我们需要关注的是`init()</span><br><span class="line">public class DataSourceProxy extends AbstractDataSourceProxy implements Resource &#123;</span><br><span class="line"></span><br><span class="line">    private String resourceGroupId;</span><br><span class="line"></span><br><span class="line">    private void init(DataSource dataSource, String resourceGroupId) &#123;</span><br><span class="line">        //资源组ID，默认是“default”这个默认值</span><br><span class="line">        this.resourceGroupId = resourceGroupId;</span><br><span class="line">        try (Connection connection = dataSource.getConnection()) &#123;</span><br><span class="line">            //根据原始数据源得到JDBC连接和数据库类型</span><br><span class="line">            jdbcUrl = connection.getMetaData().getURL();</span><br><span class="line">            dbType = JdbcUtils.getDbType(jdbcUrl);</span><br><span class="line">            if (JdbcConstants.ORACLE.equals(dbType)) &#123;</span><br><span class="line">                userName = connection.getMetaData().getUserName();</span><br><span class="line">            &#125; else if (JdbcConstants.MARIADB.equals(dbType)) &#123;</span><br><span class="line">                dbType = JdbcConstants.MYSQL;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; catch (SQLException e) &#123;</span><br><span class="line">            throw new IllegalStateException(&quot;can not init dataSource&quot;, e);</span><br><span class="line">        &#125;</span><br><span class="line">        initResourceId();</span><br><span class="line">        DefaultResourceManager.get().registerResource(this);</span><br><span class="line">        if (ENABLE_TABLE_META_CHECKER_ENABLE) &#123;</span><br><span class="line">            //如果配置开关打开，会定时在线程池不断更新表的元数据缓存信息</span><br><span class="line">            tableMetaExecutor.scheduleAtFixedRate(() -&gt; &#123;</span><br><span class="line">                try (Connection connection = dataSource.getConnection()) &#123;</span><br><span class="line">                    TableMetaCacheFactory.getTableMetaCache(DataSourceProxy.this.getDbType())</span><br><span class="line">                        .refresh(connection, DataSourceProxy.this.getResourceId());</span><br><span class="line">                &#125; catch (Exception ignore) &#123;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;, 0, TABLE_META_CHECKER_INTERVAL, TimeUnit.MILLISECONDS);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        //Set the default branch type to &#x27;AT&#x27; in the RootContext.</span><br><span class="line">        RootContext.setDefaultBranchType(this.getBranchType());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>从上面我们可以看出，他主要做了以下几点的增强：</p>
<ol>
<li>给每个数据源标识资源组 ID</li>
<li>如果打开配置，会有一个定时线程池定时更新表的元数据信息并缓存到本地</li>
<li>生成代理连接  <code>ConnectionProxy</code>  对象</li>
</ol>
<p>在这三个增强功能里面，第三个是最重要的，在 AT 模式里面，会自动记录 undoLog，资源锁定，都是通过 <code>ConnectionProxy</code>  完成的，除此之外  <code>DataSrouceProxy</code>  重写了一个方法  <code>getConnection</code> ，因为这里返回的是一个  <code>ConnectionProxy</code> ，而不是原生的 <code>Connection</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> ConnectionProxy <span class="title function_">getConnection</span><span class="params">()</span> <span class="keyword">throws</span> SQLException &#123;</span><br><span class="line">    <span class="type">Connection</span> <span class="variable">targetConnection</span> <span class="operator">=</span> targetDataSource.getConnection();</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ConnectionProxy</span>(<span class="built_in">this</span>, targetConnection);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> ConnectionProxy <span class="title function_">getConnection</span><span class="params">(String username, String password)</span> <span class="keyword">throws</span> SQLException &#123;</span><br><span class="line">    <span class="type">Connection</span> <span class="variable">targetConnection</span> <span class="operator">=</span> targetDataSource.getConnection(username, password);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ConnectionProxy</span>(<span class="built_in">this</span>, targetConnection);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="connectionproxy"><a class="markdownIt-Anchor" href="#connectionproxy">#</a> ConnectionProxy</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ConnectionProxy` 继承 `AbstractConnectionProxy` ，在这个父类中有很多公用的方法，在这个父类有 `PreparedStatementProxy` 、`StatementProxy` 、`DataSourceProxy</span><br></pre></td></tr></table></figure>
<p><img src="https://img-blog.csdnimg.cn/img_convert/f16ce360addfb4ffbc43b040f0493fc5.png" alt="img"></p>
<p>所以我们需要先来看一下 <code>AbstractConnectionProxy</code> ，因为这里封装了需要我们用到的通用方法和逻辑，在其中我们需要关注的主要在于  <code>PreparedStatementProxy</code>  和  <code>StatementProxy</code>  ，在这里的逻辑主要是数据源连接的步骤，连接获取，创建执行对象等等</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Statement <span class="title function_">createStatement</span><span class="params">()</span> <span class="keyword">throws</span> SQLException &#123;</span><br><span class="line">    <span class="comment">//调用真实连接对象获取Statement对象</span></span><br><span class="line">    <span class="type">Statement</span> <span class="variable">targetStatement</span> <span class="operator">=</span> getTargetConnection().createStatement();</span><br><span class="line">    <span class="comment">//创建Statement的代理</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">StatementProxy</span>(<span class="built_in">this</span>, targetStatement);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> PreparedStatement <span class="title function_">prepareStatement</span><span class="params">(String sql)</span> <span class="keyword">throws</span> SQLException &#123;</span><br><span class="line">    <span class="comment">//获取数据库类型 mysql/oracle</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">dbType</span> <span class="operator">=</span> getDbType();</span><br><span class="line">    <span class="comment">// support oracle 10.2+</span></span><br><span class="line">    <span class="type">PreparedStatement</span> <span class="variable">targetPreparedStatement</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="comment">//如果是AT模式且开启全局事务</span></span><br><span class="line">    <span class="keyword">if</span> (BranchType.AT == RootContext.getBranchType()) &#123;</span><br><span class="line">        List&lt;SQLRecognizer&gt; sqlRecognizers = SQLVisitorFactory.get(sql, dbType);</span><br><span class="line">        <span class="keyword">if</span> (sqlRecognizers != <span class="literal">null</span> &amp;&amp; sqlRecognizers.size() == <span class="number">1</span>) &#123;</span><br><span class="line">            <span class="type">SQLRecognizer</span> <span class="variable">sqlRecognizer</span> <span class="operator">=</span> sqlRecognizers.get(<span class="number">0</span>);</span><br><span class="line">            <span class="keyword">if</span> (sqlRecognizer != <span class="literal">null</span> &amp;&amp; sqlRecognizer.getSQLType() == SQLType.INSERT) &#123;</span><br><span class="line">                <span class="comment">//获取表的元数据</span></span><br><span class="line">                <span class="type">TableMeta</span> <span class="variable">tableMeta</span> <span class="operator">=</span> TableMetaCacheFactory.getTableMetaCache(dbType).getTableMeta(getTargetConnection(),</span><br><span class="line">                        sqlRecognizer.getTableName(), getDataSourceProxy().getResourceId());</span><br><span class="line">                <span class="comment">//得到表的主键列名</span></span><br><span class="line">                String[] pkNameArray = <span class="keyword">new</span> <span class="title class_">String</span>[tableMeta.getPrimaryKeyOnlyName().size()];</span><br><span class="line">                tableMeta.getPrimaryKeyOnlyName().toArray(pkNameArray);</span><br><span class="line">                targetPreparedStatement = getTargetConnection().prepareStatement(sql,pkNameArray);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (targetPreparedStatement == <span class="literal">null</span>) &#123;</span><br><span class="line">        targetPreparedStatement = getTargetConnection().prepareStatement(sql);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//创建PreparedStatementProxy代理</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">PreparedStatementProxy</span>(<span class="built_in">this</span>, targetPreparedStatement, sql);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在这两个代理对象中，都用到了以下几个方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> ResultSet <span class="title function_">executeQuery</span><span class="params">(String sql)</span> <span class="keyword">throws</span> SQLException &#123;</span><br><span class="line">    <span class="built_in">this</span>.targetSQL = sql;</span><br><span class="line">    <span class="keyword">return</span> ExecuteTemplate.execute(<span class="built_in">this</span>, (statement, args) -&gt; statement.executeQuery((String) args[<span class="number">0</span>]), sql);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">executeUpdate</span><span class="params">(String sql)</span> <span class="keyword">throws</span> SQLException &#123;</span><br><span class="line">    <span class="built_in">this</span>.targetSQL = sql;</span><br><span class="line">    <span class="keyword">return</span> ExecuteTemplate.execute(<span class="built_in">this</span>, (statement, args) -&gt; statement.executeUpdate((String) args[<span class="number">0</span>]), sql);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">execute</span><span class="params">(String sql)</span> <span class="keyword">throws</span> SQLException &#123;</span><br><span class="line">    <span class="built_in">this</span>.targetSQL = sql;</span><br><span class="line">    <span class="keyword">return</span> ExecuteTemplate.execute(<span class="built_in">this</span>, (statement, args) -&gt; statement.execute((String) args[<span class="number">0</span>]), sql);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>在这些方法中都调用了  <code>ExecuteTemplate.execute()</code> ，所以我们就看一下在  <code>ExecuteTemplate</code>  类中具体是做了什么操作：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ExecuteTemplate</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T, S <span class="keyword">extends</span> <span class="title class_">Statement</span>&gt; T <span class="title function_">execute</span><span class="params">(List&lt;SQLRecognizer&gt; sqlRecognizers,</span></span><br><span class="line"><span class="params">                                                     StatementProxy&lt;S&gt; statementProxy,</span></span><br><span class="line"><span class="params">                                                     StatementCallback&lt;T, S&gt; statementCallback,</span></span><br><span class="line"><span class="params">                                                     Object... args)</span> <span class="keyword">throws</span> SQLException &#123;</span><br><span class="line">        <span class="comment">//如果没有全局锁，并且不是AT模式，直接执行SQL</span></span><br><span class="line">        <span class="keyword">if</span> (!RootContext.requireGlobalLock() &amp;&amp; BranchType.AT != RootContext.getBranchType()) &#123;</span><br><span class="line">            <span class="comment">// Just work as original statement</span></span><br><span class="line">            <span class="keyword">return</span> statementCallback.execute(statementProxy.getTargetStatement(), args);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//得到数据库类型- mysql/oracle</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">dbType</span> <span class="operator">=</span> statementProxy.getConnectionProxy().getDbType();</span><br><span class="line">        <span class="keyword">if</span> (CollectionUtils.isEmpty(sqlRecognizers)) &#123;</span><br><span class="line">            <span class="comment">//sqlRecognizers 为SQL语句的解析器，获取执行的SQL，通过它可以获得SQL语句表名、相关的列名、类型等信息，最后解析出对应的SQL表达式</span></span><br><span class="line">            sqlRecognizers = SQLVisitorFactory.get(</span><br><span class="line">                    statementProxy.getTargetSQL(),</span><br><span class="line">                    dbType);</span><br><span class="line">        &#125;</span><br><span class="line">        Executor&lt;T&gt; executor;</span><br><span class="line">        <span class="keyword">if</span> (CollectionUtils.isEmpty(sqlRecognizers)) &#123;</span><br><span class="line">            <span class="comment">//如果seata没有找到合适的SQL语句解析器，那么便创建简单执行器PlainExecutor</span></span><br><span class="line">            <span class="comment">//PlainExecutor直接使用原生的Statment对象执行SQL</span></span><br><span class="line">            executor = <span class="keyword">new</span> <span class="title class_">PlainExecutor</span>&lt;&gt;(statementProxy, statementCallback);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (sqlRecognizers.size() == <span class="number">1</span>) &#123;</span><br><span class="line">                <span class="type">SQLRecognizer</span> <span class="variable">sqlRecognizer</span> <span class="operator">=</span> sqlRecognizers.get(<span class="number">0</span>);</span><br><span class="line">                <span class="keyword">switch</span> (sqlRecognizer.getSQLType()) &#123;</span><br><span class="line">                    <span class="comment">//新增</span></span><br><span class="line">                    <span class="keyword">case</span> INSERT:</span><br><span class="line">                        executor = EnhancedServiceLoader.load(InsertExecutor.class, dbType,</span><br><span class="line">                                    <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;StatementProxy.class, StatementCallback.class, SQLRecognizer.class&#125;,</span><br><span class="line">                                    <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;statementProxy, statementCallback, sqlRecognizer&#125;);</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                        <span class="comment">//修改</span></span><br><span class="line">                    <span class="keyword">case</span> UPDATE:</span><br><span class="line">                        executor = <span class="keyword">new</span> <span class="title class_">UpdateExecutor</span>&lt;&gt;(statementProxy, statementCallback, sqlRecognizer);</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                        <span class="comment">//删除</span></span><br><span class="line">                    <span class="keyword">case</span> DELETE:</span><br><span class="line">                        executor = <span class="keyword">new</span> <span class="title class_">DeleteExecutor</span>&lt;&gt;(statementProxy, statementCallback, sqlRecognizer);</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                        <span class="comment">//加锁</span></span><br><span class="line">                    <span class="keyword">case</span> SELECT_FOR_UPDATE:</span><br><span class="line">                        executor = <span class="keyword">new</span> <span class="title class_">SelectForUpdateExecutor</span>&lt;&gt;(statementProxy, statementCallback, sqlRecognizer);</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                        <span class="comment">//插入加锁</span></span><br><span class="line">                    <span class="keyword">case</span> INSERT_ON_DUPLICATE_UPDATE:</span><br><span class="line">                        <span class="keyword">switch</span> (dbType) &#123;</span><br><span class="line">                            <span class="keyword">case</span> JdbcConstants.MYSQL:</span><br><span class="line">                            <span class="keyword">case</span> JdbcConstants.MARIADB:</span><br><span class="line">                                executor =</span><br><span class="line">                                    <span class="keyword">new</span> <span class="title class_">MySQLInsertOrUpdateExecutor</span>(statementProxy, statementCallback, sqlRecognizer);</span><br><span class="line">                                <span class="keyword">break</span>;</span><br><span class="line">                            <span class="keyword">default</span>:</span><br><span class="line">                                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">NotSupportYetException</span>(dbType + <span class="string">&quot; not support to INSERT_ON_DUPLICATE_UPDATE&quot;</span>);</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                        <span class="comment">//原生</span></span><br><span class="line">                    <span class="keyword">default</span>:</span><br><span class="line">                        executor = <span class="keyword">new</span> <span class="title class_">PlainExecutor</span>&lt;&gt;(statementProxy, statementCallback);</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">//批量处理SQL语句</span></span><br><span class="line">                executor = <span class="keyword">new</span> <span class="title class_">MultiExecutor</span>&lt;&gt;(statementProxy, statementCallback, sqlRecognizers);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        T rs;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//执行</span></span><br><span class="line">            rs = executor.execute(args);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable ex) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!(ex <span class="keyword">instanceof</span> SQLException)) &#123;</span><br><span class="line">                <span class="comment">// Turn other exception into SQLException</span></span><br><span class="line">                ex = <span class="keyword">new</span> <span class="title class_">SQLException</span>(ex);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">throw</span> (SQLException) ex;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> rs;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在  <code>ExecuteTemplate</code>  就一个  <code>execute()</code> ，Seata 将 SQL 执行委托给不同的执行器 (模板)，Seata 提供了 6 种执行器也就是我们代码 case 中（ <code>INSERT</code> ， <code>UPDATE</code> ， <code>DELETE</code> ， <code>SELECT_FOR_UPDATE</code> , <code>INSERT_ON_DUPLICATE_UPDATE</code> ），这些执行器的父类都是 <code>AbstractDMLBaseExecutor</code></p>
<ul>
<li><code>UpdateExecutor</code> : 执行 update 语句</li>
<li><code>InsertExecutor</code> : 执行 insert 语句</li>
<li><code>DeleteExecutor</code> : 执行 delete 语句</li>
<li><code>SelectForUpdateExecutor</code> : 执行 select for update 语句</li>
<li><code>PlainExecutor</code> : 执行普通查询语句</li>
<li><code>MultiExecutor</code> : 复合执行器，在一条 SQL 语句中执行多条语句</li>
</ul>
<p>关系图如下：</p>
<p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/f16af649be708d3642cf86a1c451fcf7.png" alt="img"></p>
<p>然后我们找到 <code> rs = executor.execute(args);</code>  最终执行的方法，找到最顶级的父类 <code>BaseTransactionalExecutor.execute()</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> T <span class="title function_">execute</span><span class="params">(Object... args)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">xid</span> <span class="operator">=</span> RootContext.getXID();</span><br><span class="line">    <span class="keyword">if</span> (xid != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">//获取XID</span></span><br><span class="line">        statementProxy.getConnectionProxy().bind(xid);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//设置全局锁</span></span><br><span class="line">    statementProxy.getConnectionProxy().setGlobalLockRequire(RootContext.requireGlobalLock());</span><br><span class="line">    <span class="keyword">return</span> doExecute(args);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在根据 <code>doExecute(args);</code>  找到其中的重写方法  <code>AbstractDMLBaseExecutor.doExecute()</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> T <span class="title function_">doExecute</span><span class="params">(Object... args)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">    <span class="type">AbstractConnectionProxy</span> <span class="variable">connectionProxy</span> <span class="operator">=</span> statementProxy.getConnectionProxy();</span><br><span class="line">    <span class="comment">//是否自动提交</span></span><br><span class="line">    <span class="keyword">if</span> (connectionProxy.getAutoCommit()) &#123;</span><br><span class="line">        <span class="keyword">return</span> executeAutoCommitTrue(args);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> executeAutoCommitFalse(args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>对于数据库而言，本身都是自动提交的，所以我们进入 <code>executeAutoCommitTrue()</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">    <span class="keyword">protected</span> T <span class="title function_">executeAutoCommitTrue</span><span class="params">(Object[] args)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">        <span class="type">ConnectionProxy</span> <span class="variable">connectionProxy</span> <span class="operator">=</span> statementProxy.getConnectionProxy();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//设置为手动提交</span></span><br><span class="line">            connectionProxy.changeAutoCommit();</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">LockRetryPolicy</span>(connectionProxy).execute(() -&gt; &#123;</span><br><span class="line">                <span class="comment">//调用手动提交方法，得到分支执行的最终结果</span></span><br><span class="line">                <span class="type">T</span> <span class="variable">result</span> <span class="operator">=</span> executeAutoCommitFalse(args);</span><br><span class="line">                <span class="comment">//执行提交</span></span><br><span class="line">                connectionProxy.commit();</span><br><span class="line">                <span class="keyword">return</span> result;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="comment">// when exception occur in finally,this exception will lost, so just print it here</span></span><br><span class="line">            LOGGER.error(<span class="string">&quot;execute executeAutoCommitTrue error:&#123;&#125;&quot;</span>, e.getMessage(), e);</span><br><span class="line">            <span class="keyword">if</span> (!LockRetryPolicy.isLockRetryPolicyBranchRollbackOnConflict()) &#123;</span><br><span class="line">                connectionProxy.getTargetConnection().rollback();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">throw</span> e;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            connectionProxy.getContext().reset();</span><br><span class="line">            connectionProxy.setAutoCommit(<span class="literal">true</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">connectionProxy.changeAutoCommit()`方法，修改为手动提交后，我们看来最关键的代码`executeAutoCommitFalse()</span><br><span class="line">    <span class="keyword">protected</span> T <span class="title function_">executeAutoCommitFalse</span><span class="params">(Object[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="keyword">if</span> (!JdbcConstants.MYSQL.equalsIgnoreCase(getDbType()) &amp;&amp; isMultiPk()) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">NotSupportYetException</span>(<span class="string">&quot;multi pk only support mysql!&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//获取前镜像</span></span><br><span class="line">        <span class="type">TableRecords</span> <span class="variable">beforeImage</span> <span class="operator">=</span> beforeImage();</span><br><span class="line">        <span class="comment">//执行具体业务</span></span><br><span class="line">        <span class="type">T</span> <span class="variable">result</span> <span class="operator">=</span> statementCallback.execute(statementProxy.getTargetStatement(), args);</span><br><span class="line">        <span class="comment">//获取执行数量</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">updateCount</span> <span class="operator">=</span> statementProxy.getUpdateCount();</span><br><span class="line">        <span class="comment">//判断如果执行数量大于0</span></span><br><span class="line">        <span class="keyword">if</span> (updateCount &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">//获取后镜像</span></span><br><span class="line">            <span class="type">TableRecords</span> <span class="variable">afterImage</span> <span class="operator">=</span> afterImage(beforeImage);</span><br><span class="line">            <span class="comment">//暂存到undolog中，在Commit的时候保存到数据库</span></span><br><span class="line">            prepareUndoLog(beforeImage, afterImage);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>我们再回到 <code>executeAutoCommitTrue</code>  中，去看看提交做了哪些操作 <code>connectionProxy.commit();</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">commit</span><span class="params">()</span> <span class="keyword">throws</span> SQLException &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        lockRetryPolicy.execute(() -&gt; &#123;</span><br><span class="line">            <span class="comment">//具体执行</span></span><br><span class="line">            doCommit();</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (SQLException e) &#123;</span><br><span class="line">        <span class="keyword">if</span> (targetConnection != <span class="literal">null</span> &amp;&amp; !getAutoCommit() &amp;&amp; !getContext().isAutoCommitChanged()) &#123;</span><br><span class="line">            rollback();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">throw</span> e;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">SQLException</span>(e);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>进入到 <code>doCommit()</code>  中</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">doCommit</span><span class="params">()</span> <span class="keyword">throws</span> SQLException &#123;</span><br><span class="line">    <span class="comment">//判断是否存在全局事务</span></span><br><span class="line">    <span class="keyword">if</span> (context.inGlobalTransaction()) &#123;</span><br><span class="line">        processGlobalTransactionCommit();</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (context.isGlobalLockRequire()) &#123;</span><br><span class="line">        processLocalCommitWithGlobalLocks();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        targetConnection.commit();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>作为分布式事务，一定是存在全局事务的，所以我们进入  <code>processGlobalTransactionCommit()</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">processGlobalTransactionCommit</span><span class="params">()</span> <span class="keyword">throws</span> SQLException &#123;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">          <span class="comment">//注册分支事务</span></span><br><span class="line">          register();</span><br><span class="line">      &#125; <span class="keyword">catch</span> (TransactionException e) &#123;</span><br><span class="line">          recognizeLockKeyConflictException(e, context.buildLockKeys());</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">          <span class="comment">//写入数据库undolog</span></span><br><span class="line">          UndoLogManagerFactory.getUndoLogManager(<span class="built_in">this</span>.getDbType()).flushUndoLogs(<span class="built_in">this</span>);</span><br><span class="line">          <span class="comment">//执行原生提交 一阶段提交</span></span><br><span class="line">          targetConnection.commit();</span><br><span class="line">      &#125; <span class="keyword">catch</span> (Throwable ex) &#123;</span><br><span class="line">          LOGGER.error(<span class="string">&quot;process connectionProxy commit error: &#123;&#125;&quot;</span>, ex.getMessage(), ex);</span><br><span class="line">          report(<span class="literal">false</span>);</span><br><span class="line">          <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">SQLException</span>(ex);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (IS_REPORT_SUCCESS_ENABLE) &#123;</span><br><span class="line">          report(<span class="literal">true</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      context.reset();</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>其中 <code>register()</code>  方法就是注册分支事务的方法，同时还会将 undoLog 写入数据库和执行提交等操作</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//注册分支事务，生成分支事务ID</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">register</span><span class="params">()</span> <span class="keyword">throws</span> TransactionException &#123;</span><br><span class="line">    <span class="keyword">if</span> (!context.hasUndoLog() || !context.hasLockKey()) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//注册分支事务</span></span><br><span class="line">    <span class="type">Long</span> <span class="variable">branchId</span> <span class="operator">=</span> DefaultResourceManager.get().branchRegister(BranchType.AT, getDataSourceProxy().getResourceId(),</span><br><span class="line">        <span class="literal">null</span>, context.getXid(), context.getApplicationData(), context.buildLockKeys());</span><br><span class="line">    context.setBranchId(branchId);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后我们在回到 <code>processGlobalTransactionCommit</code>  中，看看写入数据库中的 <code>flushUndoLogs()</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">flushUndoLogs</span><span class="params">(ConnectionProxy cp)</span> <span class="keyword">throws</span> SQLException &#123;</span><br><span class="line">       <span class="type">ConnectionContext</span> <span class="variable">connectionContext</span> <span class="operator">=</span> cp.getContext();</span><br><span class="line">       <span class="keyword">if</span> (!connectionContext.hasUndoLog()) &#123;</span><br><span class="line">           <span class="keyword">return</span>;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="comment">//获取XID</span></span><br><span class="line">       <span class="type">String</span> <span class="variable">xid</span> <span class="operator">=</span> connectionContext.getXid();</span><br><span class="line">       <span class="comment">//获取分支ID</span></span><br><span class="line">       <span class="type">long</span> <span class="variable">branchId</span> <span class="operator">=</span> connectionContext.getBranchId();</span><br><span class="line"></span><br><span class="line">       <span class="type">BranchUndoLog</span> <span class="variable">branchUndoLog</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BranchUndoLog</span>();</span><br><span class="line">       branchUndoLog.setXid(xid);</span><br><span class="line">       branchUndoLog.setBranchId(branchId);</span><br><span class="line">       branchUndoLog.setSqlUndoLogs(connectionContext.getUndoItems());</span><br><span class="line"></span><br><span class="line">       <span class="type">UndoLogParser</span> <span class="variable">parser</span> <span class="operator">=</span> UndoLogParserFactory.getInstance();</span><br><span class="line">       <span class="type">byte</span>[] undoLogContent = parser.encode(branchUndoLog);</span><br><span class="line"></span><br><span class="line">       <span class="keyword">if</span> (LOGGER.isDebugEnabled()) &#123;</span><br><span class="line">           LOGGER.debug(<span class="string">&quot;Flushing UNDO LOG: &#123;&#125;&quot;</span>, <span class="keyword">new</span> <span class="title class_">String</span>(undoLogContent, Constants.DEFAULT_CHARSET));</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="type">CompressorType</span> <span class="variable">compressorType</span> <span class="operator">=</span> CompressorType.NONE;</span><br><span class="line">       <span class="keyword">if</span> (needCompress(undoLogContent)) &#123;</span><br><span class="line">           compressorType = ROLLBACK_INFO_COMPRESS_TYPE;</span><br><span class="line">           undoLogContent = CompressorFactory.getCompressor(compressorType.getCode()).compress(undoLogContent);</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="comment">//写入数据库具体位置</span></span><br><span class="line">       insertUndoLogWithNormal(xid, branchId, buildContext(parser.getName(), compressorType), undoLogContent, cp.getTargetConnection());</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>具体写入方法，此时我们使用的是 MySql，所以执行的是 MySql 实现类 <code>MySQLUndoLogManager.insertUndoLogWithNormal()</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">insertUndoLogWithNormal</span><span class="params">(String xid, <span class="type">long</span> branchId, String rollbackCtx, <span class="type">byte</span>[] undoLogContent,</span></span><br><span class="line"><span class="params">                                       Connection conn)</span> <span class="keyword">throws</span> SQLException &#123;</span><br><span class="line">    insertUndoLog(xid, branchId, rollbackCtx, undoLogContent, State.Normal, conn);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//具体写入操作</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">insertUndoLog</span><span class="params">(String xid, <span class="type">long</span> branchId, String rollbackCtx, <span class="type">byte</span>[] undoLogContent,</span></span><br><span class="line"><span class="params">                           State state, Connection conn)</span> <span class="keyword">throws</span> SQLException &#123;</span><br><span class="line">    <span class="keyword">try</span> (<span class="type">PreparedStatement</span> <span class="variable">pst</span> <span class="operator">=</span> conn.prepareStatement(INSERT_UNDO_LOG_SQL)) &#123;</span><br><span class="line">        pst.setLong(<span class="number">1</span>, branchId);</span><br><span class="line">        pst.setString(<span class="number">2</span>, xid);</span><br><span class="line">        pst.setString(<span class="number">3</span>, rollbackCtx);</span><br><span class="line">        pst.setBytes(<span class="number">4</span>, undoLogContent);</span><br><span class="line">        pst.setInt(<span class="number">5</span>, state.getValue());</span><br><span class="line">        pst.executeUpdate();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!(e <span class="keyword">instanceof</span> SQLException)) &#123;</span><br><span class="line">            e = <span class="keyword">new</span> <span class="title class_">SQLException</span>(e);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">throw</span> (SQLException) e;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>具体流程如下所示：</p>
<p><img src="https://img-blog.csdnimg.cn/img_convert/cc94f7cbd5363484c839ed9e69b95c5d.png" alt="img"></p>
<h2 id="seata-服务端"><a class="markdownIt-Anchor" href="#seata-服务端">#</a> Seata 服务端</h2>
<p>我们找到 <code>Server.java</code>  这里就是启动入口，在这个入口中找到协调者，因为 TC 整体的操作就是协调整体的全局事务</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//默认协调者</span></span><br><span class="line"><span class="type">DefaultCoordinator</span> <span class="variable">coordinator</span> <span class="operator">=</span> DefaultCoordinator.getInstance(nettyRemotingServer);</span><br></pre></td></tr></table></figure>
<p>在 <code>DefaultCoordinator</code>  类中我们找到 一个 <code>doGlobalBegin</code>  这个就是处理全局事务开始的方法，以及全局提交  <code>doGlobalCommit</code>  和全局回滚  <code>doGlobalRollback</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">    <span class="comment">//处理全局事务</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">doGlobalBegin</span><span class="params">(GlobalBeginRequest request, GlobalBeginResponse response, RpcContext rpcContext)</span><span class="keyword">throws</span> TransactionException &#123;</span><br><span class="line">        <span class="comment">//响应客户端xid</span></span><br><span class="line">response.setXid(core.begin(rpcContext.getApplicationId(), rpcContext.getTransactionServiceGroup(),</span><br><span class="line">                request.getTransactionName(), request.getTimeout()));</span><br><span class="line"><span class="keyword">if</span> (LOGGER.isInfoEnabled()) &#123;</span><br><span class="line">    LOGGER.info(<span class="string">&quot;Begin new global transaction applicationId: &#123;&#125;,transactionServiceGroup: &#123;&#125;, transactionName: &#123;&#125;,timeout:&#123;&#125;,xid:&#123;&#125;&quot;</span>,</span><br><span class="line">       rpcContext.getApplicationId(), rpcContext.getTransactionServiceGroup(), request.getTransactionName(), request.getTimeout(), response.getXid());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">    </span><br><span class="line">        <span class="comment">//处理全局提交</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">doGlobalCommit</span><span class="params">(GlobalCommitRequest request, GlobalCommitResponse response, RpcContext rpcContext)</span><span class="keyword">throws</span> TransactionException &#123;</span><br><span class="line">     MDC.put(RootContext.MDC_KEY_XID, request.getXid());</span><br><span class="line">     response.setGlobalStatus(core.commit(request.getXid()));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//处理全局回滚</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">doGlobalRollback</span><span class="params">(GlobalRollbackRequest request, GlobalRollbackResponse response,</span></span><br><span class="line"><span class="params">                                    RpcContext rpcContext)</span> <span class="keyword">throws</span> TransactionException &#123;</span><br><span class="line">    MDC.put(RootContext.MDC_KEY_XID, request.getXid());</span><br><span class="line">    response.setGlobalStatus(core.rollback(request.getXid()));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在这里我们首先关注  <code>doGlobalBegin</code>  中  <code>core.begin()</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">begin</span><span class="params">(String applicationId, String transactionServiceGroup, String name, <span class="type">int</span> timeout)</span></span><br><span class="line">    <span class="keyword">throws</span> TransactionException &#123;</span><br><span class="line">    <span class="comment">//创建全局事务Session</span></span><br><span class="line">    <span class="type">GlobalSession</span> <span class="variable">session</span> <span class="operator">=</span> GlobalSession.createGlobalSession(applicationId, transactionServiceGroup, name,</span><br><span class="line">        timeout);</span><br><span class="line">    MDC.put(RootContext.MDC_KEY_XID, session.getXid());</span><br><span class="line"></span><br><span class="line">    <span class="comment">//为Session重添加回调监听，SessionHolder.getRootSessionManager() 获取一个全局Session管理器DataBaseSessionManager</span></span><br><span class="line">    <span class="comment">//观察者设计模式，创建DataBaseSessionManager</span></span><br><span class="line">    session.addSessionLifecycleListener(SessionHolder.getRootSessionManager());</span><br><span class="line"></span><br><span class="line">    <span class="comment">//全局事务开始</span></span><br><span class="line">    session.begin();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// transaction start event</span></span><br><span class="line">    MetricsPublisher.postSessionDoingEvent(session, <span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> session.getXid();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后我们在来看一下 <code>SessionHolder.getRootSessionManager()</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Gets root session manager.</span></span><br><span class="line"><span class="comment"> * 获取一个全局Session管理器</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> the root session manager</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> SessionManager <span class="title function_">getRootSessionManager</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (ROOT_SESSION_MANAGER == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ShouldNeverHappenException</span>(<span class="string">&quot;SessionManager is NOT init!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> ROOT_SESSION_MANAGER;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">(String mode)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (StringUtils.isBlank(mode)) &#123;</span><br><span class="line">        mode = CONFIG.getConfig(ConfigurationKeys.STORE_SESSION_MODE,</span><br><span class="line">                CONFIG.getConfig(ConfigurationKeys.STORE_MODE, SERVER_DEFAULT_STORE_MODE));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">StoreMode</span> <span class="variable">storeMode</span> <span class="operator">=</span> StoreMode.get(mode);</span><br><span class="line">    <span class="comment">//判断Seata模式，当前为DB</span></span><br><span class="line">    <span class="keyword">if</span> (StoreMode.DB.equals(storeMode)) &#123;</span><br><span class="line">        <span class="comment">//通过SPI机制读取SessionManager接口实现类，读取的META-INF.services目录，在通过反射机制创建对象DataBaseSessionManager</span></span><br><span class="line">        ROOT_SESSION_MANAGER = EnhancedServiceLoader.load(SessionManager.class, StoreMode.DB.getName());</span><br><span class="line">        ........</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在这里他其实读取的是 DB 模式下  <code>io.seata.server.session.SessionManager</code>  文件的内容</p>
<p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/4dd908fc36e0128e646e3c8c0b03262a.png" alt="img"></p>
<p>我们在回到 <code>begin</code>  方法中，去查看 <code>session.begin()</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">begin</span><span class="params">()</span> <span class="keyword">throws</span> TransactionException &#123;</span><br><span class="line">    <span class="comment">//声明全局事务开始</span></span><br><span class="line">    <span class="built_in">this</span>.status = GlobalStatus.Begin;</span><br><span class="line">    <span class="comment">//开始时间</span></span><br><span class="line">    <span class="built_in">this</span>.beginTime = System.currentTimeMillis();</span><br><span class="line">    <span class="comment">//激活全局事务</span></span><br><span class="line">    <span class="built_in">this</span>.active = <span class="literal">true</span>;</span><br><span class="line">    <span class="comment">//将SessionManager放入到集合中，调用onBegin方法</span></span><br><span class="line">    <span class="keyword">for</span> (SessionLifecycleListener lifecycleListener : lifecycleListeners) &#123;</span><br><span class="line">        <span class="comment">//调用父级抽象类的方法</span></span><br><span class="line">        lifecycleListener.onBegin(<span class="built_in">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>这里我们来看一下  <code>onBegin()</code>  方法，调用的是父级的方法，在这其中我们要关注  <code>addGlobalSession()</code>  方法，但是要注意，这里我们用的是 db 模式所以调用的是 db 模式的  <code>DateBaseSessionManager</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onBegin</span><span class="params">(GlobalSession globalSession)</span> <span class="keyword">throws</span> TransactionException &#123;</span><br><span class="line">    <span class="comment">//这里调用的是DateBaseSessionManager</span></span><br><span class="line">    addGlobalSession(globalSession);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addGlobalSession</span><span class="params">(GlobalSession session)</span> <span class="keyword">throws</span> TransactionException &#123;</span><br><span class="line">    <span class="keyword">if</span> (StringUtils.isBlank(taskName)) &#123;</span><br><span class="line">        <span class="comment">//写入session</span></span><br><span class="line">        <span class="type">boolean</span> <span class="variable">ret</span> <span class="operator">=</span> transactionStoreManager.writeSession(LogOperation.GLOBAL_ADD, session);</span><br><span class="line">        <span class="keyword">if</span> (!ret) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">StoreException</span>(<span class="string">&quot;addGlobalSession failed.&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">ret</span> <span class="operator">=</span> transactionStoreManager.writeSession(LogOperation.GLOBAL_UPDATE, session);</span><br><span class="line">        <span class="keyword">if</span> (!ret) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">StoreException</span>(<span class="string">&quot;addGlobalSession failed.&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后在看查询其中关键的方法 <code>DataBaseTransactionStoreManager.writeSession()</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">   <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">writeSession</span><span class="params">(LogOperation logOperation, SessionStorable session)</span> &#123;</span><br><span class="line">       <span class="comment">//第一次进入是写入 会进入当前方法</span></span><br><span class="line">       <span class="comment">//全局添加</span></span><br><span class="line">       <span class="keyword">if</span> (LogOperation.GLOBAL_ADD.equals(logOperation)) &#123;</span><br><span class="line">           <span class="keyword">return</span> logStore.insertGlobalTransactionDO(SessionConverter.convertGlobalTransactionDO(session));</span><br><span class="line">           <span class="comment">//全局修改</span></span><br><span class="line">       &#125; <span class="keyword">else</span> <span class="keyword">if</span> (LogOperation.GLOBAL_UPDATE.equals(logOperation)) &#123;</span><br><span class="line">           <span class="keyword">return</span> logStore.updateGlobalTransactionDO(SessionConverter.convertGlobalTransactionDO(session));</span><br><span class="line">           <span class="comment">//全局删除</span></span><br><span class="line">       &#125; <span class="keyword">else</span> <span class="keyword">if</span> (LogOperation.GLOBAL_REMOVE.equals(logOperation)) &#123;</span><br><span class="line">           <span class="keyword">return</span> logStore.deleteGlobalTransactionDO(SessionConverter.convertGlobalTransactionDO(session));</span><br><span class="line">           <span class="comment">//分支添加</span></span><br><span class="line">       &#125; <span class="keyword">else</span> <span class="keyword">if</span> (LogOperation.BRANCH_ADD.equals(logOperation)) &#123;</span><br><span class="line">           <span class="keyword">return</span> logStore.insertBranchTransactionDO(SessionConverter.convertBranchTransactionDO(session));</span><br><span class="line">           <span class="comment">//分支更新</span></span><br><span class="line">       &#125; <span class="keyword">else</span> <span class="keyword">if</span> (LogOperation.BRANCH_UPDATE.equals(logOperation)) &#123;</span><br><span class="line">           <span class="keyword">return</span> logStore.updateBranchTransactionDO(SessionConverter.convertBranchTransactionDO(session));</span><br><span class="line">           <span class="comment">//分支移除</span></span><br><span class="line">       &#125; <span class="keyword">else</span> <span class="keyword">if</span> (LogOperation.BRANCH_REMOVE.equals(logOperation)) &#123;</span><br><span class="line">           <span class="keyword">return</span> logStore.deleteBranchTransactionDO(SessionConverter.convertBranchTransactionDO(session));</span><br><span class="line">       &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">           <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">StoreException</span>(<span class="string">&quot;Unknown LogOperation:&quot;</span> + logOperation.name());</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>我们就看第一次进去的方法 <code>logStore.insertGlobalTransactionDO(SessionConverter.convertGlobalTransactionDO(session));</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"> <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">insertGlobalTransactionDO</span><span class="params">(GlobalTransactionDO globalTransactionDO)</span> &#123;</span><br><span class="line">     <span class="type">String</span> <span class="variable">sql</span> <span class="operator">=</span> LogStoreSqlsFactory.getLogStoreSqls(dbType).getInsertGlobalTransactionSQL(globalTable);</span><br><span class="line">     <span class="type">Connection</span> <span class="variable">conn</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">     <span class="type">PreparedStatement</span> <span class="variable">ps</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">     <span class="keyword">try</span> &#123;</span><br><span class="line">         <span class="type">int</span> <span class="variable">index</span> <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line">         conn = logStoreDataSource.getConnection();</span><br><span class="line">         conn.setAutoCommit(<span class="literal">true</span>);</span><br><span class="line">         ps = conn.prepareStatement(sql);</span><br><span class="line">         ps.setString(index++, globalTransactionDO.getXid());</span><br><span class="line">         ps.setLong(index++, globalTransactionDO.getTransactionId());</span><br><span class="line">         ps.setInt(index++, globalTransactionDO.getStatus());</span><br><span class="line">         ps.setString(index++, globalTransactionDO.getApplicationId());</span><br><span class="line">         ps.setString(index++, globalTransactionDO.getTransactionServiceGroup());</span><br><span class="line">         <span class="type">String</span> <span class="variable">transactionName</span> <span class="operator">=</span> globalTransactionDO.getTransactionName();</span><br><span class="line">         transactionName = transactionName.length() &gt; transactionNameColumnSize ?</span><br><span class="line">             transactionName.substring(<span class="number">0</span>, transactionNameColumnSize) :</span><br><span class="line">             transactionName;</span><br><span class="line">         ps.setString(index++, transactionName);</span><br><span class="line">         ps.setInt(index++, globalTransactionDO.getTimeout());</span><br><span class="line">         ps.setLong(index++, globalTransactionDO.getBeginTime());</span><br><span class="line">         ps.setString(index++, globalTransactionDO.getApplicationData());</span><br><span class="line">         <span class="keyword">return</span> ps.executeUpdate() &gt; <span class="number">0</span>;</span><br><span class="line">     &#125; <span class="keyword">catch</span> (SQLException e) &#123;</span><br><span class="line">         <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">StoreException</span>(e);</span><br><span class="line">     &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">         IOUtil.close(ps, conn);</span><br><span class="line">     &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<p>在这里有一个  <code>GlobalTransactionDO </code> 对象，里面有 <code>xid、transactionId</code>  等等，到这里是不是就很熟悉了、</p>
<p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/5649458fda2717fb7c87a5d8d0df2741.png" alt="img"></p>
<p>还记得我们第一次使用 Seata 的时候会创建三张表</p>
<ol>
<li>branch_table 分支事务表</li>
<li>global_table 全局事务表</li>
<li>lock_table 全局锁表</li>
</ol>
<p>而这里就是对应我们的 <code>global_table</code>  表，其他两个也是差不多，都是一样的操作</p>
<p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/6ef22513cae0ad8f2861cf18ec4cde0c.png" alt="img"><br>
 流程图如下：<br>
<img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/c33801b28bbae2a960f6b14856d4e8cf.png" alt="img"></p>
<h2 id="总结"><a class="markdownIt-Anchor" href="#总结">#</a> 总结</h2>
<p>完整流程图：</p>
<p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/e615279306d5aaf9ad85b8e2f9905a35.png" alt="img"></p>
<p>对于 Seata 源码来说主要是了解从哪里入口以及核心点在哪里，遇到有疑问的，可以 Debug，对于 Seata AT 模式，我们主要掌握的核心点是</p>
<ul>
<li>如何获取全局锁、开启全局事务</li>
<li>解析 SQL 并写入 undolog</li>
</ul>
<h2 id="关于我"><a class="markdownIt-Anchor" href="#关于我">#</a> 关于我</h2>
<p>Brath 是一个热爱技术的 Java 程序猿，公众号「InterviewCoder」定期分享有趣有料的精品原创文章！</p>
<p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/%E4%BA%8C%E7%BB%B4%E7%A0%81plus.png" alt="InterviewCoder"></p>
<p>非常感谢各位人才能看到这里，原创不易，文章如果有帮助可以关注、点赞、分享或评论，这都是对我的莫大支持！</p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2023-05-17T08:20:40.000Z" title="2023-5-17 16:20:40">2023-05-17</time>发表</span><span class="level-item"><time dateTime="2023-05-17T08:28:47.563Z" title="2023-5-17 16:28:47">2023-05-17</time>更新</span><span class="level-item">2 分钟读完 (大约298个字)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2023/05/17/%E3%80%90Java%E3%80%91%E8%AE%B0%E4%B8%80%E6%AC%A1%E7%BA%BF%E4%B8%8A%E6%95%85%E9%9A%9C%EF%BC%9A%E6%9C%8D%E5%8A%A1%E6%8E%A5%E5%8F%A3%E6%97%A0%E5%93%8D%E5%BA%94/">【Java】记一次线上故障：服务接口无响应</a></p><div class="content"><p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/%E6%89%AB%E7%A0%81_%E6%90%9C%E7%B4%A2%E8%81%94%E5%90%88%E4%BC%A0%E6%92%AD%E6%A0%B7%E5%BC%8F-%E6%A0%87%E5%87%86%E8%89%B2%E7%89%88.png" alt="InterviewCoder"></p>
<h2 id="事故起因"><a class="markdownIt-Anchor" href="#事故起因">#</a> 事故起因</h2>
<h5 id="中午公众号突然收到消息很多用户说chatgpt不回复询问我是不是程序坏掉了"><a class="markdownIt-Anchor" href="#中午公众号突然收到消息很多用户说chatgpt不回复询问我是不是程序坏掉了">#</a> 中午公众号突然收到消息，很多用户说 chatGPT 不回复，询问我是不是程序坏掉了</h5>
<h2 id="排查流程"><a class="markdownIt-Anchor" href="#排查流程">#</a> 排查流程</h2>
<h4 id="1进入docker查看服务日志发现日志都正常输出没有报错"><a class="markdownIt-Anchor" href="#1进入docker查看服务日志发现日志都正常输出没有报错">#</a> 1. 进入 docker 查看服务日志，发现日志都正常输出，没有报错</h4>
<h4 id="2在本地启动程序排查发现无异常"><a class="markdownIt-Anchor" href="#2在本地启动程序排查发现无异常">#</a> 2. 在本地启动程序排查，发现无异常</h4>
<h4 id="3使用接口工具调用其他接口和网关心跳接口尝试无响应"><a class="markdownIt-Anchor" href="#3使用接口工具调用其他接口和网关心跳接口尝试无响应">#</a> 3. 使用接口工具调用其他接口和网关心跳接口尝试，无响应</h4>
<h4 id="4查看线上cpu和内存使用率结果正常"><a class="markdownIt-Anchor" href="#4查看线上cpu和内存使用率结果正常">#</a> 4. 查看线上 CPU 和内存使用率，结果正常</h4>
<h4 id="5查看线上磁盘占用100"><a class="markdownIt-Anchor" href="#5查看线上磁盘占用100">#</a> 5. 查看线上磁盘：占用 100%</h4>
<h2 id="结果"><a class="markdownIt-Anchor" href="#结果">#</a> 结果</h2>
<p>​	清理掉 Nacos 的大量日志后，服务恢复正常。</p>
<h2 id="关于我"><a class="markdownIt-Anchor" href="#关于我">#</a> 关于我</h2>
<p>Brath 是一个热爱技术的 Java 程序猿，公众号「InterviewCoder」定期分享有趣有料的精品原创文章！</p>
<p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/%E4%BA%8C%E7%BB%B4%E7%A0%81plus.png" alt="InterviewCoder"></p>
<p>非常感谢各位人才能看到这里，原创不易，文章如果有帮助可以关注、点赞、分享或评论，这都是对我的莫大支持！</p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2023-05-08T14:04:55.000Z" title="2023-5-8 22:04:55">2023-05-08</time>发表</span><span class="level-item"><time dateTime="2023-05-09T00:27:14.814Z" title="2023-5-9 8:27:14">2023-05-09</time>更新</span><span class="level-item">1 小时读完 (大约9856个字)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2023/05/08/%E3%80%90Java%E3%80%91HashMap%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E8%A7%A3%E8%AF%BB/">【Java】HashMap核心原理解读</a></p><div class="content"><p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/%E6%89%AB%E7%A0%81_%E6%90%9C%E7%B4%A2%E8%81%94%E5%90%88%E4%BC%A0%E6%92%AD%E6%A0%B7%E5%BC%8F-%E6%A0%87%E5%87%86%E8%89%B2%E7%89%88.png" alt="InterviewCoder"></p>
<h1 id="javahashmap核心原理解读"><a class="markdownIt-Anchor" href="#javahashmap核心原理解读">#</a> 【Java】HashMap 核心原理解读</h1>
<h2 id="一-前言"><a class="markdownIt-Anchor" href="#一-前言">#</a> 一、前言</h2>
<p>得益于 <code>Doug Lea</code>  老爷子的操刀，让 <code>HashMap</code>  成为使用和面试最频繁的 API，没办法设计的太优秀了！</p>
<p>HashMap 最早出现在 JDK 1.2 中，底层基于散列算法实现。HashMap 允许 null 键和 null 值，在计算哈键的哈希值时，null 键哈希值为 0。HashMap 并不保证键值对的顺序，这意味着在进行某些操作后，键值对的顺序可能会发生变化。另外，需要注意的是，HashMap 是非线程安全类，在多线程环境下可能会存在问题。</p>
<h2 id="二-源码分析"><a class="markdownIt-Anchor" href="#二-源码分析">#</a> 二、源码分析</h2>
<h3 id="1-写一个最简单的hashmap"><a class="markdownIt-Anchor" href="#1-写一个最简单的hashmap">#</a> 1. 写一个最简单的 HashMap</h3>
<p>学习 HashMap 前，最好的方式是先了解这是一种怎么样的数据结构来存放数据。而 HashMap 经过多个版本的迭代后，乍一看代码还是很复杂的。就像你原来只穿个裤衩，现在还有秋裤和风衣。所以我们先来看看最根本的 HashMap 是什么样，也就是只穿裤衩是什么效果，之后再去分析它的源码。</p>
<p><strong>问题：</strong> 假设我们有一组 7 个字符串，需要存放到数组中，但要求在获取每个元素的时候时间复杂度是 O (1)。也就是说你不能通过循环遍历的方式进行获取，而是要定位到数组 ID 直接获取相应的元素。</p>
<p><strong>方案：</strong> 如果说我们需要通过 ID 从数组中获取元素，那么就需要把每个字符串都计算出一个在数组中的位置 ID。<em>字符串获取 ID 你能想到什么方式？</em> 一个字符串最直接的获取跟数字相关的信息就是 HashCode，可 HashCode 的取值范围太大了 <code>[-2147483648, 2147483647]</code> ，不可能直接使用。那么就需要使用 HashCode 与数组长度做与运算，得到一个可以在数组中出现的位置。如果说有两个元素得到同样的 ID，那么这个数组 ID 下就存放两个字符串。</p>
<p>以上呢其实就是我们要把字符串散列到数组中的一个基本思路，接下来我们就把这个思路用代码实现出来。</p>
<h4 id="11-代码实现"><a class="markdownIt-Anchor" href="#11-代码实现">#</a> 1.1 代码实现</h4>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 初始化一组字符串</span></span><br><span class="line">List&lt;String&gt; list = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">list.add(<span class="string">&quot;jlkk&quot;</span>);</span><br><span class="line">list.add(<span class="string">&quot;lopi&quot;</span>);</span><br><span class="line">list.add(<span class="string">&quot;小傅哥&quot;</span>);</span><br><span class="line">list.add(<span class="string">&quot;e4we&quot;</span>);</span><br><span class="line">list.add(<span class="string">&quot;alpo&quot;</span>);</span><br><span class="line">list.add(<span class="string">&quot;yhjk&quot;</span>);</span><br><span class="line">list.add(<span class="string">&quot;plop&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 定义要存放的数组</span></span><br><span class="line">String[] tab = <span class="keyword">new</span> <span class="title class_">String</span>[<span class="number">8</span>];</span><br><span class="line"></span><br><span class="line"><span class="comment">// 循环存放</span></span><br><span class="line"><span class="keyword">for</span> (String key : list) &#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">idx</span> <span class="operator">=</span> key.hashCode() &amp; (tab.length - <span class="number">1</span>);  <span class="comment">// 计算索引位置</span></span><br><span class="line">    System.out.println(String.format(<span class="string">&quot;key值=%s Idx=%d&quot;</span>, key, idx));</span><br><span class="line">    <span class="keyword">if</span> (<span class="literal">null</span> == tab[idx]) &#123;</span><br><span class="line">        tab[idx] = key;</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    tab[idx] = tab[idx] + <span class="string">&quot;-&gt;&quot;</span> + key;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 输出测试结果</span></span><br><span class="line">System.out.println(JSON.toJSONString(tab));</span><br></pre></td></tr></table></figure>
<p>这段代码整体看起来也是非常简单，并没有什么复杂度，主要包括以下内容；</p>
<ol>
<li>初始化一组字符串集合，这里初始化了 7 个。</li>
<li>定义一个数组用于存放字符串，注意这里的长度是 8，也就是 2 的 3 次幂。这样的数组长度才会出现一个  <code>0111</code>  除高位以外都是 1 的特征，也是为了散列。</li>
<li>接下来就是循环存放数据，计算出每个字符串在数组中的位置。 <code>key.hashCode() &amp; (tab.length - 1)</code> 。</li>
<li>在字符串存放到数组的过程，如果遇到相同的元素，进行连接操作 <code>模拟链表的过程</code> 。</li>
<li>最后输出存放结果。</li>
</ol>
<p><strong>测试结果</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">key值=jlkk Idx=<span class="number">2</span></span><br><span class="line">key值=lopi Idx=<span class="number">4</span></span><br><span class="line">key值=小傅哥 Idx=<span class="number">7</span></span><br><span class="line">key值=e4we Idx=<span class="number">5</span></span><br><span class="line">key值=alpo Idx=<span class="number">2</span></span><br><span class="line">key值=yhjk Idx=<span class="number">0</span></span><br><span class="line">key值=plop Idx=<span class="number">5</span></span><br><span class="line">测试结果：[<span class="string">&quot;yhjk&quot;</span>,<span class="literal">null</span>,<span class="string">&quot;jlkk-&gt;alpo&quot;</span>,<span class="literal">null</span>,<span class="string">&quot;lopi&quot;</span>,<span class="string">&quot;e4we-&gt;plop&quot;</span>,<span class="literal">null</span>,<span class="string">&quot;小傅哥&quot;</span>]</span><br></pre></td></tr></table></figure>
<ul>
<li>在测试结果首先是计算出每个元素在数组的 Idx，也有出现重复的位置。</li>
<li>最后是测试结果的输出，1、3、6，位置是空的，2、5，位置有两个元素被链接起来 <code>e4we-&gt;plop</code> 。</li>
<li>这就达到了我们一个最基本的要求，将串元素散列存放到数组中，最后通过字符串元素的索引 ID 进行获取对应字符串。这样是 HashMap 的一个最基本原理，有了这个基础后面就会更容易理解 HashMap 的源码实现。</li>
</ul>
<h4 id="12-hash散列示意图"><a class="markdownIt-Anchor" href="#12-hash散列示意图">#</a> 1.2 Hash 散列示意图</h4>
<p>如果上面的测试结果不能在你的头脑中很好的建立出一个数据结构，那么可以看以下这张散列示意图，方便理解；</p>
<p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/interview-4-01.png" alt="bugstack.cn Hash散列示意图"></p>
<ul>
<li>这张图就是上面代码实现的全过程，将每一个字符串元素通过 Hash 计算索引位置，存放到数组中。</li>
<li>黄色的索引 ID 是没有元素存放、绿色的索引 ID 存放了一个元素、红色的索引 ID 存放了两个元素。</li>
</ul>
<h4 id="httpsbugstackcnmdjavainterview2020-08-07-面经手册-第3篇hashmap核心知识扰动函数-负载因子-扩容链表拆分深度学习html_1-3-这个简单的hashmap有哪些问题13-这个简单的hashmap有哪些问题"><a class="markdownIt-Anchor" href="#httpsbugstackcnmdjavainterview2020-08-07-面经手册-第3篇hashmap核心知识扰动函数-负载因子-扩容链表拆分深度学习html_1-3-这个简单的hashmap有哪些问题13-这个简单的hashmap有哪些问题">#</a> [#](<a target="_blank" rel="noopener" href="https://bugstack.cn/md/java/interview/2020-08-07-%E9%9D%A2%E7%BB%8F%E6%89%8B%E5%86%8C">https://bugstack.cn/md/java/interview/2020-08-07 - 面经手册</a>・第 3 篇《HashMap 核心知识，扰动函数、负载因子、扩容链表拆分，深度学习》.html#_1-3 - 这个简单的 hashmap 有哪些问题) 1.3 这个简单的 HashMap 有哪些问题</h4>
<p>以上我们实现了一个简单的 HashMap，或者说还算不上 HashMap，只能算做一个散列数据存放的雏形。但这样的一个数据结构放在实际使用中，会有哪些问题呢？</p>
<ol>
<li>这里所有的元素存放都需要获取一个索引位置，而如果元素的位置不够散列碰撞严重，那么就失去了散列表存放的意义，没有达到预期的性能。</li>
<li>在获取索引 ID 的计算公式中，需要数组长度是 2 的幂次方，那么怎么进行初始化这个数组大小。</li>
<li>数组越小碰撞的越大，数组越大碰撞的越小，时间与空间如何取舍。</li>
<li>目前存放 7 个元素，已经有两个位置都存放了 2 个字符串，那么链表越来越长怎么优化。</li>
<li>随着元素的不断添加，数组长度不足扩容时，怎么把原有的元素，拆分到新的位置上去。</li>
</ol>
<p>以上这些问题可以归纳为； <code>扰动函数</code> 、 <code>初始化容量</code> 、 <code>负载因子</code> 、 <code>扩容方法</code> 以及 <code>链表和红黑树</code> 转换的使用等。接下来我们会逐个问题进行分析。</p>
<h3 id="2-扰动函数"><a class="markdownIt-Anchor" href="#2-扰动函数">#</a> 2. 扰动函数</h3>
<p>在 HashMap 存放元素时候有这样一段代码来处理哈希值，这是 <code>java 8</code>  的散列值扰动函数，用于优化散列效果；</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="title function_">hash</span><span class="params">(Object key)</span> &#123;</span><br><span class="line">    <span class="type">int</span> h;</span><br><span class="line">    <span class="keyword">return</span> (key == <span class="literal">null</span>) ? <span class="number">0</span> : (h = key.hashCode()) ^ (h &gt;&gt;&gt; <span class="number">16</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="21-为什么使用扰动函数"><a class="markdownIt-Anchor" href="#21-为什么使用扰动函数">#</a> 2.1 为什么使用扰动函数</h4>
<p>理论上来说字符串的 <code>hashCode</code>  是一个 int 类型值，那可以直接作为数组下标了，且不会出现碰撞。但是这个 <code>hashCode</code>  的取值范围是 [-2147483648, 2147483647]，有将近 40 亿的长度，谁也不能把数组初始化的这么大，内存也是放不下的。</p>
<p>我们默认初始化的 Map 大小是 16 个长度  <code>DEFAULT_INITIAL_CAPACITY = 1 &lt;&lt; 4</code> ，所以获取的 Hash 值并不能直接作为下标使用，需要与数组长度进行取模运算得到一个下标值，也就是我们上面做的散列列子。</p>
<p>那么，hashMap 源码这里不只是直接获取哈希值，还进行了一次扰动计算， <code>(h = key.hashCode()) ^ (h &gt;&gt;&gt; 16)</code> 。把哈希值右移 16 位，也就正好是自己长度的一半，之后与原哈希值做异或运算，这样就混合了原哈希值中的高位和低位，增大了<strong>随机性</strong>。计算方式如下图；</p>
<p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/interview-4-02.png" alt="bugstack.cn 扰动函数"></p>
<ul>
<li>说白了，使用扰动函数就是为了增加随机性，让数据元素更加均衡的散列，减少碰撞。</li>
</ul>
<h4 id="22-实验验证扰动函数"><a class="markdownIt-Anchor" href="#22-实验验证扰动函数">#</a> 2.2 实验验证扰动函数</h4>
<p>从上面的分析可以看出，扰动函数使用了哈希值的高半区和低半区做异或，混合原始哈希码的高位和低位，以此来加大低位区的随机性。</p>
<p>但看不到实验数据的话，这终究是一段理论，具体这段哈希值真的被增加了随机性没有，并不知道。所以这里我们要做一个实验，这个实验是这样做；</p>
<ol>
<li>选取 10 万个单词词库</li>
<li>定义 128 位长度的数组格子</li>
<li>分别计算在扰动和不扰动下，10 万单词的下标分配到 128 个格子的数量</li>
<li>统计各个格子数量，生成波动曲线。如果扰动函数下的波动曲线相对更平稳，那么证明扰动函数有效果。</li>
</ol>
<h5 id="221-扰动代码测试"><a class="markdownIt-Anchor" href="#221-扰动代码测试">#</a> 2.2.1 扰动代码测试</h5>
<p><strong>扰动函数对比方法</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Disturb</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">disturbHashIdx</span><span class="params">(String key, <span class="type">int</span> size)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> (size - <span class="number">1</span>) &amp; (key.hashCode() ^ (key.hashCode() &gt;&gt;&gt; <span class="number">16</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">hashIdx</span><span class="params">(String key, <span class="type">int</span> size)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> (size - <span class="number">1</span>) &amp; key.hashCode();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><code>disturbHashIdx</code>  扰动函数下，下标值计算</li>
<li><code>hashIdx</code>  非扰动函数下，下标值计算</li>
</ul>
<p><strong>单元测试</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 10万单词已经初始化到words中</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test_disturb</span><span class="params">()</span> &#123;</span><br><span class="line">    Map&lt;Integer, Integer&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;(<span class="number">16</span>);</span><br><span class="line">    <span class="keyword">for</span> (String word : words) &#123;</span><br><span class="line">        <span class="comment">// 使用扰动函数</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">idx</span> <span class="operator">=</span> Disturb.disturbHashIdx(word, <span class="number">128</span>);</span><br><span class="line">        <span class="comment">// 不使用扰动函数</span></span><br><span class="line">        <span class="comment">// int idx = Disturb.hashIdx(word, 128);</span></span><br><span class="line">        <span class="keyword">if</span> (map.containsKey(idx)) &#123;</span><br><span class="line">            <span class="type">Integer</span> <span class="variable">integer</span> <span class="operator">=</span> map.get(idx);</span><br><span class="line">            map.put(idx, ++integer);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            map.put(idx, <span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    System.out.println(map.values());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>以上分别统计两种函数下的下标值分配，最终将统计结果放到 excel 中生成图表。</p>
<h5 id="httpsbugstackcnmdjavainterview2020-08-07-面经手册-第3篇hashmap核心知识扰动函数-负载因子-扩容链表拆分深度学习html_2-2-2-扰动函数散列图表222-扰动函数散列图表"><a class="markdownIt-Anchor" href="#httpsbugstackcnmdjavainterview2020-08-07-面经手册-第3篇hashmap核心知识扰动函数-负载因子-扩容链表拆分深度学习html_2-2-2-扰动函数散列图表222-扰动函数散列图表">#</a> [#](<a target="_blank" rel="noopener" href="https://bugstack.cn/md/java/interview/2020-08-07-%E9%9D%A2%E7%BB%8F%E6%89%8B%E5%86%8C">https://bugstack.cn/md/java/interview/2020-08-07 - 面经手册</a>・第 3 篇《HashMap 核心知识，扰动函数、负载因子、扩容链表拆分，深度学习》.html#_2-2-2 - 扰动函数散列图表) 2.2.2 扰动函数散列图表</h5>
<p>以上的两张图，分别是没有使用扰动函数和使用扰动函数的，下标分配。实验数据；</p>
<ol>
<li>10 万个不重复的单词</li>
<li>128 个格子，相当于 128 长度的数组</li>
</ol>
<p><strong>未使用扰动函数</strong></p>
<p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/interview-4-03.png" alt="bugstack.cn 未使用扰动函数"></p>
<p><strong>使用扰动函数</strong></p>
<p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/interview-4-04.png" alt="bugstack.cn 使用扰动函数"></p>
<ul>
<li>从这两种的对比图可以看出来，在使用了扰动函数后，数据分配的更加均匀了。</li>
<li>数据分配均匀，也就是散列的效果更好，减少了 hash 的碰撞，让数据存放和获取的效率更佳。</li>
</ul>
<h3 id="3-初始化容量和负载因子"><a class="markdownIt-Anchor" href="#3-初始化容量和负载因子">#</a> 3. 初始化容量和负载因子</h3>
<p>接下来我们讨论下一个问题，从我们模仿 HashMap 的例子中以及 HashMap 默认的初始化大小里，都可以知道，散列数组需要一个 2 的幂次方的长度，因为只有 2 的幂次方在减 1 的时候，才会出现 <code>01111</code>  这样的值。</p>
<p>那么这里就有一个问题，我们在初始化 HashMap 的时候，如果传一个 17 个的值 <code>new HashMap&lt;&gt;(17);</code> ，它会怎么处理呢？</p>
<h4 id="31-寻找2的幂次方最小值"><a class="markdownIt-Anchor" href="#31-寻找2的幂次方最小值">#</a> 3.1 寻找 2 的幂次方最小值</h4>
<p>在 HashMap 的初始化中，有这样一段方法；</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">HashMap</span><span class="params">(<span class="type">int</span> initialCapacity, <span class="type">float</span> loadFactor)</span> &#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="built_in">this</span>.loadFactor = loadFactor;</span><br><span class="line">    <span class="built_in">this</span>.threshold = tableSizeFor(initialCapacity);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>阈值 <code>threshold</code> ，通过方法 <code>tableSizeFor</code>  进行计算，是根据初始化来计算的。</li>
<li>这个方法也就是要寻找比初始值大的，最小的那个 2 进制数值。比如传了 17，我应该找到的是 32（2 的 4 次幂是 16&lt;17, 所以找到 2 的 5 次幂 32）。</li>
</ul>
<p>计算阈值大小的方法；</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="title function_">tableSizeFor</span><span class="params">(<span class="type">int</span> cap)</span> &#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">n</span> <span class="operator">=</span> cap - <span class="number">1</span>;</span><br><span class="line">    n |= n &gt;&gt;&gt; <span class="number">1</span>;</span><br><span class="line">    n |= n &gt;&gt;&gt; <span class="number">2</span>;</span><br><span class="line">    n |= n &gt;&gt;&gt; <span class="number">4</span>;</span><br><span class="line">    n |= n &gt;&gt;&gt; <span class="number">8</span>;</span><br><span class="line">    n |= n &gt;&gt;&gt; <span class="number">16</span>;</span><br><span class="line">    <span class="keyword">return</span> (n &lt; <span class="number">0</span>) ? <span class="number">1</span> : (n &gt;= MAXIMUM_CAPACITY) ? MAXIMUM_CAPACITY : n + <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>MAXIMUM_CAPACITY = 1 &lt;&lt; 30，这个是临界范围，也就是最大的 Map 集合。</li>
<li>乍一看可能有点晕😵怎么都在向右移位 1、2、4、8、16，这主要是为了把二进制的各个位置都填上 1，当二进制的各个位置都是 1 以后，就是一个标准的 2 的幂次方减 1 了，最后把结果加 1 再返回即可。</li>
</ul>
<p>那这里我们把 17 这样一个初始化计算阈值的过程，用图展示出来，方便理解；</p>
<p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/interview-4-05.png" alt="bugstack.cn 计算阈值"></p>
<h4 id="32-负载因子"><a class="markdownIt-Anchor" href="#32-负载因子">#</a> 3.2 负载因子</h4>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="type">float</span> <span class="variable">DEFAULT_LOAD_FACTOR</span> <span class="operator">=</span> <span class="number">0.75f</span>;  </span><br></pre></td></tr></table></figure>
<p><strong>负载因子是做什么的？</strong></p>
<p>负载因子，可以理解成一辆车可承重重量超过某个阈值时，把货放到新的车上。</p>
<p>那么在 HashMap 中，负载因子决定了数据量多少了以后进行扩容。<em>这里要提到上面做的 HashMap 例子，我们准备了 7 个元素，但是最后还有 3 个位置空余，2 个位置存放了 2 个元素。</em> 所以可能即使你数据比数组容量大时也是不一定能正正好好的把数组占满的，而是在某些小标位置出现了大量的碰撞，只能在同一个位置用链表存放，那么这样就失去了 Map 数组的性能。</p>
<p>所以，要选择一个合理的大小下进行扩容，默认值 0.75 就是说当阈值容量占了 3/4 时赶紧扩容，减少 Hash 碰撞。</p>
<p>同时 0.75 是一个默认构造值，在创建 HashMap 也可以调整，比如你希望用更多的空间换取时间，可以把负载因子调的更小一些，减少碰撞。</p>
<h3 id="4-扩容元素拆分"><a class="markdownIt-Anchor" href="#4-扩容元素拆分">#</a> 4. 扩容元素拆分</h3>
<p>为什么扩容，因为数组长度不足了。那扩容最直接的问题，就是需要把元素拆分到新的数组中。拆分元素的过程中，原 jdk1.7 中会需要重新计算哈希值，但是到 jdk1.8 中已经进行优化，不再需要重新计算，提升了拆分的性能，设计的还是非常巧妙的。</p>
<h4 id="41-测试数据"><a class="markdownIt-Anchor" href="#41-测试数据">#</a> 4.1 测试数据</h4>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test_hashMap</span><span class="params">()</span> &#123;</span><br><span class="line">    List&lt;String&gt; list = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">    list.add(<span class="string">&quot;jlkk&quot;</span>);</span><br><span class="line">    list.add(<span class="string">&quot;lopi&quot;</span>);</span><br><span class="line">    list.add(<span class="string">&quot;jmdw&quot;</span>);</span><br><span class="line">    list.add(<span class="string">&quot;e4we&quot;</span>);</span><br><span class="line">    list.add(<span class="string">&quot;io98&quot;</span>);</span><br><span class="line">    list.add(<span class="string">&quot;nmhg&quot;</span>);</span><br><span class="line">    list.add(<span class="string">&quot;vfg6&quot;</span>);</span><br><span class="line">    list.add(<span class="string">&quot;gfrt&quot;</span>);</span><br><span class="line">    list.add(<span class="string">&quot;alpo&quot;</span>);</span><br><span class="line">    list.add(<span class="string">&quot;vfbh&quot;</span>);</span><br><span class="line">    list.add(<span class="string">&quot;bnhj&quot;</span>);</span><br><span class="line">    list.add(<span class="string">&quot;zuio&quot;</span>);</span><br><span class="line">    list.add(<span class="string">&quot;iu8e&quot;</span>);</span><br><span class="line">    list.add(<span class="string">&quot;yhjk&quot;</span>);</span><br><span class="line">    list.add(<span class="string">&quot;plop&quot;</span>);</span><br><span class="line">    list.add(<span class="string">&quot;dd0p&quot;</span>);</span><br><span class="line">    <span class="keyword">for</span> (String key : list) &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">hash</span> <span class="operator">=</span> key.hashCode() ^ (key.hashCode() &gt;&gt;&gt; <span class="number">16</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;字符串：&quot;</span> + key + <span class="string">&quot; \tIdx(16)：&quot;</span> + ((<span class="number">16</span> - <span class="number">1</span>) &amp; hash) + <span class="string">&quot; \tBit值：&quot;</span> + Integer.toBinaryString(hash) + <span class="string">&quot; - &quot;</span> + Integer.toBinaryString(hash &amp; <span class="number">16</span>) + <span class="string">&quot; \t\tIdx(32)：&quot;</span> + ((</span><br><span class="line">        System.out.println(Integer.toBinaryString(key.hashCode()) +<span class="string">&quot; &quot;</span>+ Integer.toBinaryString(hash) + <span class="string">&quot; &quot;</span> + Integer.toBinaryString((<span class="number">32</span> - <span class="number">1</span>) &amp; hash));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;   </span><br></pre></td></tr></table></figure>
<p><strong>测试结果</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">字符串：jlkk 	<span class="title function_">Idx</span><span class="params">(<span class="number">16</span>)</span>：<span class="number">3</span> 	Bit值：<span class="number">1100011101001000010011</span> - <span class="number">10000</span> 		Idx(<span class="number">32</span>)：<span class="number">19</span></span><br><span class="line"><span class="number">1100011101001000100010</span> <span class="number">1100011101001000010011</span> <span class="number">10011</span></span><br><span class="line">字符串：lopi 	<span class="title function_">Idx</span><span class="params">(<span class="number">16</span>)</span>：<span class="number">14</span> 	Bit值：<span class="number">1100101100011010001110</span> - <span class="number">0</span> 		Idx(<span class="number">32</span>)：<span class="number">14</span></span><br><span class="line"><span class="number">1100101100011010111100</span> <span class="number">1100101100011010001110</span> <span class="number">1110</span></span><br><span class="line">字符串：jmdw 	<span class="title function_">Idx</span><span class="params">(<span class="number">16</span>)</span>：<span class="number">7</span> 	Bit值：<span class="number">1100011101010100100111</span> - <span class="number">0</span> 		Idx(<span class="number">32</span>)：<span class="number">7</span></span><br><span class="line"><span class="number">1100011101010100010110</span> <span class="number">1100011101010100100111</span> <span class="number">111</span></span><br><span class="line">字符串：e4we 	<span class="title function_">Idx</span><span class="params">(<span class="number">16</span>)</span>：<span class="number">3</span> 	Bit值：<span class="number">1011101011101101010011</span> - <span class="number">10000</span> 		Idx(<span class="number">32</span>)：<span class="number">19</span></span><br><span class="line"><span class="number">1011101011101101111101</span> <span class="number">1011101011101101010011</span> <span class="number">10011</span></span><br><span class="line">字符串：io98 	<span class="title function_">Idx</span><span class="params">(<span class="number">16</span>)</span>：<span class="number">4</span> 	Bit值：<span class="number">1100010110001011110100</span> - <span class="number">10000</span> 		Idx(<span class="number">32</span>)：<span class="number">20</span></span><br><span class="line"><span class="number">1100010110001011000101</span> <span class="number">1100010110001011110100</span> <span class="number">10100</span></span><br><span class="line">字符串：nmhg 	<span class="title function_">Idx</span><span class="params">(<span class="number">16</span>)</span>：<span class="number">13</span> 	Bit值：<span class="number">1100111010011011001101</span> - <span class="number">0</span> 		Idx(<span class="number">32</span>)：<span class="number">13</span></span><br><span class="line"><span class="number">1100111010011011111110</span> <span class="number">1100111010011011001101</span> <span class="number">1101</span></span><br><span class="line">字符串：vfg6 	<span class="title function_">Idx</span><span class="params">(<span class="number">16</span>)</span>：<span class="number">8</span> 	Bit值：<span class="number">1101110010111101101000</span> - <span class="number">0</span> 		Idx(<span class="number">32</span>)：<span class="number">8</span></span><br><span class="line"><span class="number">1101110010111101011111</span> <span class="number">1101110010111101101000</span> <span class="number">1000</span></span><br><span class="line">字符串：gfrt 	<span class="title function_">Idx</span><span class="params">(<span class="number">16</span>)</span>：<span class="number">1</span> 	Bit值：<span class="number">1100000101111101010001</span> - <span class="number">10000</span> 		Idx(<span class="number">32</span>)：<span class="number">17</span></span><br><span class="line"><span class="number">1100000101111101100001</span> <span class="number">1100000101111101010001</span> <span class="number">10001</span></span><br><span class="line">字符串：alpo 	<span class="title function_">Idx</span><span class="params">(<span class="number">16</span>)</span>：<span class="number">7</span> 	Bit值：<span class="number">1011011011101101000111</span> - <span class="number">0</span> 		Idx(<span class="number">32</span>)：<span class="number">7</span></span><br><span class="line"><span class="number">1011011011101101101010</span> <span class="number">1011011011101101000111</span> <span class="number">111</span></span><br><span class="line">字符串：vfbh 	<span class="title function_">Idx</span><span class="params">(<span class="number">16</span>)</span>：<span class="number">1</span> 	Bit值：<span class="number">1101110010111011000001</span> - <span class="number">0</span> 		Idx(<span class="number">32</span>)：<span class="number">1</span></span><br><span class="line"><span class="number">1101110010111011110110</span> <span class="number">1101110010111011000001</span> <span class="number">1</span></span><br><span class="line">字符串：bnhj 	<span class="title function_">Idx</span><span class="params">(<span class="number">16</span>)</span>：<span class="number">0</span> 	Bit值：<span class="number">1011100011011001100000</span> - <span class="number">0</span> 		Idx(<span class="number">32</span>)：<span class="number">0</span></span><br><span class="line"><span class="number">1011100011011001001110</span> <span class="number">1011100011011001100000</span> <span class="number">0</span></span><br><span class="line">字符串：zuio 	<span class="title function_">Idx</span><span class="params">(<span class="number">16</span>)</span>：<span class="number">8</span> 	Bit值：<span class="number">1110010011100110011000</span> - <span class="number">10000</span> 		Idx(<span class="number">32</span>)：<span class="number">24</span></span><br><span class="line"><span class="number">1110010011100110100001</span> <span class="number">1110010011100110011000</span> <span class="number">11000</span></span><br><span class="line">字符串：iu8e 	<span class="title function_">Idx</span><span class="params">(<span class="number">16</span>)</span>：<span class="number">8</span> 	Bit值：<span class="number">1100010111100101101000</span> - <span class="number">0</span> 		Idx(<span class="number">32</span>)：<span class="number">8</span></span><br><span class="line"><span class="number">1100010111100101011001</span> <span class="number">1100010111100101101000</span> <span class="number">1000</span></span><br><span class="line">字符串：yhjk 	<span class="title function_">Idx</span><span class="params">(<span class="number">16</span>)</span>：<span class="number">8</span> 	Bit值：<span class="number">1110001001010010101000</span> - <span class="number">0</span> 		Idx(<span class="number">32</span>)：<span class="number">8</span></span><br><span class="line"><span class="number">1110001001010010010000</span> <span class="number">1110001001010010101000</span> <span class="number">1000</span></span><br><span class="line">字符串：plop 	<span class="title function_">Idx</span><span class="params">(<span class="number">16</span>)</span>：<span class="number">9</span> 	Bit值：<span class="number">1101001000110011101001</span> - <span class="number">0</span> 		Idx(<span class="number">32</span>)：<span class="number">9</span></span><br><span class="line"><span class="number">1101001000110011011101</span> <span class="number">1101001000110011101001</span> <span class="number">1001</span></span><br><span class="line">字符串：dd0p 	<span class="title function_">Idx</span><span class="params">(<span class="number">16</span>)</span>：<span class="number">14</span> 	Bit值：<span class="number">1011101111001011101110</span> - <span class="number">0</span> 		Idx(<span class="number">32</span>)：<span class="number">14</span></span><br><span class="line"><span class="number">1011101111001011000000</span> <span class="number">1011101111001011101110</span> <span class="number">1110</span></span><br></pre></td></tr></table></figure>
<ul>
<li>这里我们随机使用一些字符串计算他们分别在 16 位长度和 32 位长度数组下的索引分配情况，看哪些数据被重新路由到了新的地址。</li>
<li>同时，这里还可以观察🕵出一个非常重要的信息，原哈希值与扩容新增出来的长度 16，进行 &amp; 运算，如果值等于 0，则下标位置不变。如果不为 0，那么新的位置则是原来位置上加 16。｛这个地方需要好好理解下，并看实验数据｝</li>
<li>这样一来，就不需要在重新计算每一个数组中元素的哈希值了。</li>
</ul>
<p>4.2 数据迁移</p>
<p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/interview-4-06.png" alt="bugstack.cn 数据迁移"></p>
<ul>
<li>这张图就是原 16 位长度数组元素，向 32 位扩容后数组转移的过程。</li>
<li>对 31 取模保留低 5 位，对 15 取模保留低 4 位，两者的差异就在于第 5 位是否为 1，是的话则需要加上增量，为 0 的话则不需要改变</li>
<li>其中黄色区域元素 <code>zuio</code>  因计算结果  <code>hash &amp; oldCap</code>  低位第 5 位为 1，则被迁移到下标位置 24。</li>
<li>同时还是用重新计算哈希值的方式验证了，确实分配到 24 的位置，因为这是在二进制计算中补 1 的过程，所以可以通过上面简化的方式确定哈希值的位置。</li>
</ul>
<p>那么为什么 e.hash &amp; oldCap == 0 为什么可以判断当前节点是否需要移位，而不是再次计算 hash;</p>
<p>仍然是原始长度为 16 举例:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">old:</span><br><span class="line"><span class="number">10</span>: <span class="number">0000</span> <span class="number">1010</span></span><br><span class="line"><span class="number">15</span>: <span class="number">0000</span> <span class="number">1111</span></span><br><span class="line">&amp;: <span class="number">0000</span> <span class="number">1010</span> </span><br><span class="line"></span><br><span class="line"><span class="keyword">new</span>:</span><br><span class="line"><span class="number">10</span>: <span class="number">0000</span> <span class="number">1010</span></span><br><span class="line"><span class="number">31</span>: <span class="number">0001</span> <span class="number">1111</span></span><br><span class="line">&amp;: <span class="number">0000</span> <span class="number">1010</span> </span><br></pre></td></tr></table></figure>
<p>从上面的示例可以很轻易的看出，两次 indexFor () 的差别只是第二次参与位于比第一次左边有一位从 0 变为 1, 而这个变化的 1 刚好是 oldCap, 那么只需要判断原 key 的 hash 这个位上是否为 1: 若是 1, 则需要移动至 oldCap + i 的槽位，若为 0, 则不需要移动；</p>
<p>这也是 HashMap 的长度必须保证是 2 的幂次方的原因，正因为这种环环相扣的设计，HashMap.loadFactor 的选值是 3/4 就能理解了，table.length * 3/4 可以被优化为 ((table.length&gt;&gt; 2) &lt;&lt; 2) - (table.length &gt;&gt; 2) == table.length - (table.length &gt;&gt; 2), JAVA 的位运算比乘除的效率更高，所以取 3/4 在保证 hash 冲突小的情况下兼顾了效率；</p>
<h1 id="面试题总结"><a class="markdownIt-Anchor" href="#面试题总结">#</a> 面试题总结</h1>
<h1 id="question"><a class="markdownIt-Anchor" href="#question">#</a> Question</h1>
<h4 id="1为什么hashmap哈希表中数组长度总是取-2-的幂次方"><a class="markdownIt-Anchor" href="#1为什么hashmap哈希表中数组长度总是取-2-的幂次方">#</a> 1. 为什么 HashMap 哈希表中数组长度总是取 2 的幂次方？</h4>
<h6 id="散列数组需要一个2的幂次方的长度因为只有2的幂次方在减1的时候才会出现01111这样的值"><a class="markdownIt-Anchor" href="#散列数组需要一个2的幂次方的长度因为只有2的幂次方在减1的时候才会出现01111这样的值">#</a> 散列数组需要一个 2 的幂次方的长度，因为只有 2 的幂次方在减 1 的时候，才会出现 01111 这样的值。</h6>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//通过获取存储内容的hashcode，并且对长度是 2 的幂次方的数组长度-1进行与运算得到一个可以在数组中出现的位置</span></span><br><span class="line"><span class="type">int</span> <span class="variable">idx</span> <span class="operator">=</span> key.hashCode() &amp; (tab.length - <span class="number">1</span>);</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">哈希表中数组长度总是取 <span class="number">2</span> 的幂次方，这是因为对于大多数的质数来说，它们的二进制表示中只有少数位是为 <span class="number">1</span>。如果使用一个不是 <span class="number">2</span> 的幂次方的数组长度，那么当元素的哈希映射到索引时，就会出现某些索引永远无法被访问到的情况，这就浪费了哈希表的空间。</span><br><span class="line"></span><br><span class="line">举个例子，比如我们要在一个大小为 <span class="number">5</span> 的数组中插入 <span class="number">10</span> 个元素 &#123;a,b,c,d,e,f,g,h,i,j&#125;，而哈希函数将他们依次映射到下标位置：[<span class="number">0</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">2</span>,<span class="number">4</span>,<span class="number">1</span>,<span class="number">3</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>]，可以看到，有三个下标（<span class="number">5</span>、<span class="number">6</span>、<span class="number">7</span>）始终没有被映射到，完全浪费了这几个下标的存储空间。但如果数组长度为 <span class="number">8</span>，那么上述元素的哈希值按照上面的映射规则可以得到的下标分别是 [<span class="number">0</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">2</span>, <span class="number">4</span>, <span class="number">1</span>, <span class="number">3</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>] % <span class="number">8</span> = [<span class="number">0</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">2</span>, <span class="number">4</span>, <span class="number">1</span>, <span class="number">3</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>]，不会出现任何下标被浪费的情况。</span><br><span class="line"></span><br><span class="line">这种情况下，如果将数组长度改为 <span class="number">7</span>，那么上述元素的哈希值按照上面的映射规则可以得到的下标分别是 [<span class="number">0</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">2</span>, <span class="number">4</span>, <span class="number">1</span>, <span class="number">3</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>] % <span class="number">7</span> = [<span class="number">0</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">2</span>, <span class="number">4</span>, <span class="number">1</span>, <span class="number">3</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">1</span>]，可以看到，索引为 <span class="number">5</span>、<span class="number">6</span> 的空间仍然被浪费了。</span><br><span class="line"></span><br><span class="line">因此，为了避免在哈希表中浪费存储空间，我们一般都会选择使用 <span class="number">2</span> 的幂次方作为哈希表的大小。这样，在计算元素的位置时，只需要对哈希码进行位运算即可，不需要进行除法等复杂的计算。同时，由于 <span class="number">2</span> 的幂次方满足 <span class="number">2</span>^n2*n*，所以用位运算来代替除法或取模操作也能够提高运行效率。</span><br></pre></td></tr></table></figure>
<h4 id="2hashmap怎么保证哈希表长度是-2-的幂次方"><a class="markdownIt-Anchor" href="#2hashmap怎么保证哈希表长度是-2-的幂次方">#</a> 2.HashMap 怎么保证哈希表长度是 2 的幂次方？</h4>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">在 Java 中，哈希表的长度总是 <span class="number">2</span> 的幂次方。这是通过 HashMap 类中的一个名为 `tableSizeFor(<span class="type">int</span> cap)` 的静态方法来实现的。</span><br><span class="line"></span><br><span class="line">这个方法会首先将传入的参数减去 <span class="number">1</span>，然后将结果右移一位，在这个值上加 <span class="number">1</span>，最终得到的结果就是大于等于原始参数且最接近原始参数的 <span class="number">2</span> 的幂次方。例如，如果传入的参数是 <span class="number">7</span>，则按照上述算法可以得到 <span class="number">8</span>：(((<span class="number">7</span> - <span class="number">1</span>) &gt;&gt;&gt; <span class="number">1</span>) + <span class="number">1</span>) = ((<span class="number">0110</span>)_2 &gt;&gt;&gt; <span class="number">1</span> + <span class="number">1</span>) = (<span class="number">0011</span>)_2 + (<span class="number">0001</span>)_2 = (<span class="number">0100</span>)_2 = <span class="number">8</span>(((<span class="number">7</span>−<span class="number">1</span>)&gt;&gt;&gt;<span class="number">1</span>)+<span class="number">1</span>)=((<span class="number">0110</span>)<span class="number">2</span>&gt;&gt;&gt;<span class="number">1</span>+<span class="number">1</span>)=(<span class="number">0011</span>)<span class="number">2</span>+(<span class="number">0001</span>)<span class="number">2</span>=(<span class="number">0100</span>)<span class="number">2</span>=<span class="number">8</span>。</span><br><span class="line"></span><br><span class="line">因此，当我们创建一个新的哈希表时，只需要将初始容量设置为需要存储的元素数目除以负载因子（load factor），然后调用 `tableSizeFor` 方法进行处理即可。这样就能够保证哈希表的长度始终是 <span class="number">2</span> 的幂次方，并达到较好的性能和空间利用率。</span><br><span class="line"></span><br><span class="line">需要注意的是，虽然这种方式确实可以保证哈希表的长度是 <span class="number">2</span> 的幂次方，但有时候也可能会出现哈希冲突的情况。因此，在实际应用中，还需要根据具体情况选择合适的哈希函数、负载因子等参数来避免哈希冲突，并提高哈希表的性能。</span><br></pre></td></tr></table></figure>
<h4 id="3在hashmap存放元素时候有这样一段代码来处理哈希值这是java-8的散列值扰动函数用于优化散列效果"><a class="markdownIt-Anchor" href="#3在hashmap存放元素时候有这样一段代码来处理哈希值这是java-8的散列值扰动函数用于优化散列效果">#</a> 3. 在 HashMap 存放元素时候有这样一段代码来处理哈希值，这是 java 8 的散列值扰动函数，用于优化散列效果</h4>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="title function_">hash</span><span class="params">(Object key)</span>&#123;</span><br><span class="line">	<span class="type">int</span> h;</span><br><span class="line">	<span class="keyword">return</span> (key == <span class="literal">null</span>) ? <span class="number">0</span> : (h = key.hashcode()) ^ (h &gt;&gt;&gt; <span class="number">16</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="4hash为什么用31计算"><a class="markdownIt-Anchor" href="#4hash为什么用31计算">#</a> 4.Hash 为什么用 31 计算？</h4>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">	使用 <span class="number">31</span> 这个系数的原因是因为它既是一个质数，又可以通过移位和减法等简单的运算来实现乘法。同时，由于 <span class="number">31</span> 在二进制中只有一个非零的比特位，因此用 <span class="number">31</span> 进行乘法相当于进行了位运算和加法的组合，这样不仅能够保证高效运算，还能够避免哈希冲突。</span><br><span class="line">	</span><br><span class="line"><span class="number">31</span>具有两个优点：</span><br><span class="line">	<span class="number">1.</span>小质数：<span class="number">31</span> 是一个较小的质数，在哈希表中被用来乘以键的哈希码，使得结果不会太大，从而提高性能。相对于其他的质数，<span class="number">31</span> 更易于被 CPU 缓存，这也有助于提升哈希表的查询速度。</span><br><span class="line">	<span class="number">2.</span>可逆性：因为 <span class="number">31</span> 是质数且比较小，所以只要哈希表的大小足够大，在乘法过程中产生的数据溢出是不会影响哈希结果的。而且，<span class="number">31</span> 的逆元 <span class="number">0x9e3779b1</span> 是一个固定的常量，也很容易计算，这有助于在需要恢复哈希码时进行逆运算。</span><br><span class="line"></span><br><span class="line">	在实现哈希函数时，使用系数 <span class="number">31</span> 可以保证高效性、可逆性和低冲突率，因此在 Java 中被广泛使用。</span><br></pre></td></tr></table></figure>
<h4 id="5hashmap扰动函数的作用是什么以及它可以被应用在哪些地方"><a class="markdownIt-Anchor" href="#5hashmap扰动函数的作用是什么以及它可以被应用在哪些地方">#</a> 5.HashMap 扰动函数的作用是什么，以及它可以被应用在哪些地方？</h4>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">扰动函数是一种用于增强哈希函数的技术。它通常被用来对原始哈希值进行混淆和扰动，从而减小哈希冲突的发生率。</span><br><span class="line">	</span><br><span class="line">	具体来说，扰动函数会将原始哈希值与另一个数值进行混合，并再次运用哈希函数产生最终的哈希值。这个额外的数值可以是任意的固定值或随机数，目的是使得不同的哈希值在进行混淆之后，仍然能够保持一定的分散性，从而减小哈希冲突的概率。</span><br><span class="line"></span><br><span class="line">扰动函数可以被应用在许多地方，例如：</span><br><span class="line"></span><br><span class="line"><span class="number">1.</span>哈希表：在哈希表中，扰动函数可以用来增加键的随机性，减少哈希冲突的发生率，从而提高哈希表的性能。Java 中的 HashMap 就使用了扰动函数对键的哈希码进行混淆。</span><br><span class="line"></span><br><span class="line"><span class="number">2.</span>加密算法：在一些加密算法中，也会使用扰动函数来增加密码熵，并提高加密强度。例如，MD5 算法就采用了一系列扰动函数对数据进行混淆。</span><br><span class="line"></span><br><span class="line"><span class="number">3.</span>图像处理：在图像处理中，扰动函数可以用来对像素值随机化，增加图像的噪声，从而实现一些特殊效果，如毛玻璃效果、雨滴效果等。</span><br><span class="line"></span><br><span class="line">总之，扰动函数是一种通用的技术，可以在许多场景下使用。通过引入随机数和混淆操作，扰动函数可以增强数据的随机性和复杂性，从而提高系统的安全性和性能。</span><br></pre></td></tr></table></figure>
<h4 id="6hashmap负载因子"><a class="markdownIt-Anchor" href="#6hashmap负载因子">#</a> 6.HashMap 负载因子？</h4>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">负载因子，可以理解成一辆车可承重重量超过某个阈值时，把货放到新的车上。</span><br><span class="line"></span><br><span class="line">	那么在HashMap中，负载因子决定了数据量多少了以后进行扩容。这里要提到上面做的HashMap例子，我们准备了<span class="number">7</span>个元素，但是最后还有<span class="number">3</span>个位置空余，<span class="number">2</span>个位置存放了<span class="number">2</span>个元素。 所以可能即使你数据比数组容量大时也是不一定能正正好好的把数组占满的，而是在某些小标位置出现了大量的碰撞，只能在同一个位置用链表存放，那么这样就失去了Map数组的性能。</span><br><span class="line"></span><br><span class="line">	所以，要选择一个合理的大小下进行扩容，默认值<span class="number">0.75</span>就是说当阈值容量占了<span class="number">3</span>/<span class="number">4</span>时赶紧扩容，减少Hash碰撞。</span><br><span class="line"></span><br><span class="line">	同时<span class="number">0.75</span>是一个默认构造值，在创建HashMap也可以调整，比如你希望用更多的空间换取时间，可以把负载因子调的更小一些，减少碰撞。</span><br></pre></td></tr></table></figure>
<h4 id="7hashmap是开放寻址还是拉链寻址"><a class="markdownIt-Anchor" href="#7hashmap是开放寻址还是拉链寻址">#</a> 7.HashMap 是开放寻址还是拉链寻址？</h4>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">HashMap 是一种拉链式哈希表，也就是说，它使用了链表来解决哈希冲突。</span><br><span class="line"></span><br><span class="line">	具体来说，当多个不同的键映射到同一个桶时，HashMap 会将它们存储在同一个桶中，并通过链表或红黑树等数据结构组织起来。这样，在进行查找、插入、删除等操作时，就可以遍历对应桶中的链表，找到所需的元素。</span><br><span class="line"></span><br><span class="line">	相对于开放寻址法，拉链法能够更好地处理哈希冲突，并且支持动态扩容。因为在拉链法中，哈希表的每个桶都可以存储多个元素，而在开放寻址法中，每个位置只能存储一个元素，这使得动态扩容变得更加困难和低效。</span><br><span class="line"></span><br><span class="line">	但是，由于链表的空间和时间开销，当哈希冲突较为频繁时，拉链法可能会导致性能下降。为了解决这个问题，Java8 引入了基于红黑树的优化机制，即当链表长度超过一定阈值时，将链表转换为红黑树，以提高查询效率。</span><br><span class="line"></span><br><span class="line">总之，HashMap 是一种基于拉链法实现的哈希表，能够高效处理哈希冲突，并且支持动态扩容和基于红黑树的优化。</span><br></pre></td></tr></table></figure>
<h4 id="8hashmap链表什么时候树化以及迁移数据算法是什么"><a class="markdownIt-Anchor" href="#8hashmap链表什么时候树化以及迁移数据算法是什么">#</a> 8.HashMap 链表什么时候树化以及迁移数据算法是什么？</h4>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">在JDK1<span class="number">.8</span>中，HashMap是以数组+链表+红黑树构成的。</span><br><span class="line"></span><br><span class="line">	具体来说，当某个桶中的链表长度超过了阈值时，HashMap 会将这个链表转换成一棵红黑树，以便支持更快的查找、插入和删除等操作。这个过程中，需要进行以下步骤：</span><br><span class="line"></span><br><span class="line">	<span class="number">1.</span>创建一棵空的红黑树，并将原始链表中的所有元素插入到这棵树中。</span><br><span class="line">	<span class="number">2.</span>删除原始链表中的所有元素，并设置哈希表的结构类型为 TREEBIN。</span><br><span class="line">	<span class="number">3.</span>在进行插入、删除等操作时，先判断当前桶的数据结构类型，如果是链表，则采用链表的方法进行操作；否则，采用红黑树的方法进行操作。</span><br><span class="line"></span><br><span class="line">	总之，在 JDK8 及以后版本中，HashMap 在树化和迁移数据方面做了一些优化，使得它能够更好地支持大规模并发和高效内存使用。</span><br></pre></td></tr></table></figure>
<h4 id="9hashmap-中的-key若为-object类型-则需实现哪些方法"><a class="markdownIt-Anchor" href="#9hashmap-中的-key若为-object类型-则需实现哪些方法">#</a> 9.HashMap 中的 key 若为 Object 类型， 则需实现哪些方法？</h4>
<p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/12e5dce6bacfa7d4db320d87936b45db.jpeg" alt="HashMap 在 JDK1.7 和 JDK1.8 中有哪些区别？_数组_07"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">如果 HashMap 中的 key 是 Object 类型，则该对象需要正确地实现 equals() 和 hashCode() 方法。这两个方法用于确定两个对象是否相等，并计算对象的哈希码。</span><br><span class="line"></span><br><span class="line">具体来说，equals() 方法用于比较两个对象是否相等。在 HashMap 中，当两个 key 的哈希值相同时，会调用它们的 equals() 方法进行比较，以确定它们是否真正相等。因此，正确实现 equals() 方法可以防止哈希冲突和键值对重复的问题。</span><br><span class="line">       </span><br><span class="line">hashCode() 方法用于计算对象的哈希码，它将一个对象映射到一个整数值，用于确定该对象在哈希表中的位置。在 HashMap 中，当插入或查找键值对时，会首先计算 key 的哈希码，并根据哈希码查找对应的桶。因此，正确实现 hashCode() 方法可以提高哈希表的性能和效率。</span><br><span class="line"></span><br><span class="line">需要注意的是，如果在 HashMap 中使用自定义的对象作为 key，默认情况下，它们的 equals() 方法和 hashCode() 方法是通过继承 Object 类而来的，这可能导致 key 的比较和哈希码计算不准确。因此，我们通常需要自己重写 equals() 和 hashCode() 方法，以满足我们的具体需求。同时，还需要遵循一些规则，例如：如果两个对象相等，那么它们的哈希码必须相等；反之亦然。</span><br></pre></td></tr></table></figure>
<h4 id="10hashmap中的扰动函数是如何计算的"><a class="markdownIt-Anchor" href="#10hashmap中的扰动函数是如何计算的">#</a> 10.HashMap 中的扰动函数是如何计算的？</h4>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 使用扰动函数就是为了增加随机性，让数据元素更加均衡的散列，减少碰撞</span></span><br><span class="line"><span class="comment"> * 把哈希值右移16位，也就正好是自己长度的一半，之后与原哈希值做异或运算</span></span><br><span class="line"><span class="comment"> * 这样就混合了原哈希值中的高位和低位，增大了随机性</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">int</span> <span class="variable">hashIndex</span> <span class="operator">=</span> (size - <span class="number">1</span>) &amp; (key.hashCode() ^ (key.hashCode() &gt;&gt;&gt; <span class="number">16</span>));</span><br></pre></td></tr></table></figure>
<h4 id="11为什么hashmap中要使用-1-30-来作为最大限制"><a class="markdownIt-Anchor" href="#11为什么hashmap中要使用-1-30-来作为最大限制">#</a> 11. 为什么 hashMap 中要使用 （1 &lt;&lt; 30） 来作为最大限制</h4>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">在 HashMap 中，使用 <span class="number">1</span> &lt;&lt; <span class="number">30</span> 来作为容量的最大限制是因为 Java 中的数组长度不能超过 Integer.MAX_VALUE（即 <span class="number">2</span>^<span class="number">31</span>-<span class="number">1</span>）。而 HashMap 内部的实现需要使用一个数组来保存数据，因此其容量也必须受到这个限制。</span><br><span class="line"></span><br><span class="line">为了保证 HashMap 的最大容量不超过 Integer.MAX_VALUE，同时又要尽可能地提高 HashMap 的容量，Java 开发团队选择了 <span class="number">1</span> &lt;&lt; <span class="number">30</span> 作为 HashMap 的最大容量。这个值是一个 <span class="number">2</span> 的幂次方，可以充分利用位运算的优势，同时又不会超过数组长度的最大限制。</span><br><span class="line"></span><br><span class="line">需要注意的是，HashMap 实际上并不会直接使用 <span class="number">1</span> &lt;&lt; <span class="number">30</span> 作为容量的最大限制。在初始化 HashMap 时，如果传入的初始容量大于等于 <span class="number">1</span> &lt;&lt; <span class="number">30</span>，则会将容量设置为 Integer.MAX_VALUE；如果传入的初始容量小于 <span class="number">1</span> &lt;&lt; <span class="number">30</span>，则会将容量调整为大于等于传入值且最接近 <span class="number">2</span> 的幂次方的数。这样可以确保 HashMap 容量的合理性，同时避免出现数组长度超过 Integer.MAX_VALUE 的情况。</span><br></pre></td></tr></table></figure>
<h4 id="12hashmap如何寻找2的幂次方最小值"><a class="markdownIt-Anchor" href="#12hashmap如何寻找2的幂次方最小值">#</a> 12.HashMap 如何寻找 2 的幂次方最小值？</h4>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//JDK1.8中：把二进制的各个位置都填上1，当二进制的各个位置都是1以后，就是一个标准的2的幂次方减1了，最后把结果加1再返回即可。</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="title function_">tableSizeFor</span><span class="params">(<span class="type">int</span> cap)</span> &#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">n</span> <span class="operator">=</span> cap - <span class="number">1</span>;</span><br><span class="line">    n |= n &gt;&gt;&gt; <span class="number">1</span>;</span><br><span class="line">    n |= n &gt;&gt;&gt; <span class="number">2</span>;</span><br><span class="line">    n |= n &gt;&gt;&gt; <span class="number">4</span>;</span><br><span class="line">    n |= n &gt;&gt;&gt; <span class="number">8</span>;</span><br><span class="line">    n |= n &gt;&gt;&gt; <span class="number">16</span>;</span><br><span class="line">    <span class="keyword">return</span> (n &lt; <span class="number">0</span>) ? <span class="number">1</span> : (n &gt;= MAXIMUM_CAPACITY) ? MAXIMUM_CAPACITY : n + <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//JDK1.8之后：（二分法）通过多次右移和减小位宽的方式来逐步缩小搜索范围，最终得到最高位 0 的个数</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="title function_">tableSizeFor</span><span class="params">(<span class="type">int</span> cap)</span> &#123;</span><br><span class="line">     <span class="type">int</span> <span class="variable">n</span> <span class="operator">=</span> -<span class="number">1</span> &gt;&gt;&gt; Integer.numberOfLeadingZeros(cap - <span class="number">1</span>);</span><br><span class="line">     <span class="keyword">return</span> (n &lt; <span class="number">0</span>) ? <span class="number">1</span> : (n &gt;= MAXIMUM_CAPACITY) ? MAXIMUM_CAPACITY : n + <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="12为什么重写equals一定要重写hashcode"><a class="markdownIt-Anchor" href="#12为什么重写equals一定要重写hashcode">#</a> 12. 为什么重写 equals 一定要重写 hashcode</h4>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">在 Java 中，每个类都继承了 Object 类，Object 类提供了两个有关哈希值的方法，一个是 equals() 方法，另一个是 hashCode() 方法。其中，equals() 方法用于判断两个对象是否相等，而 hashCode() 方法则返回该对象的哈希码。</span><br><span class="line"></span><br><span class="line">如果在一个类中重写了 equals() 方法，但没有重写 hashCode() 方法，则可能会导致出现以下情况：</span><br><span class="line"></span><br><span class="line">	在使用 HashMap、HashSet 等哈希数据结构时，由于不同的对象可以返回相同的哈希值，因此可能会将这些对象误认为是同一个对象，从而引发程序错误。</span><br><span class="line">	在使用自定义对象作为键来进行 Map 操作时，由于不同的键可以返回相同的哈希值，因此可能无法正确地定位到对应的键值对，从而导致数据丢失或查找失败。</span><br><span class="line">因此，如果要重写 equals() 方法，则必须同时重写 hashCode() 方法，以确保它们的行为一致并满足一些约定：</span><br><span class="line"></span><br><span class="line">	如果两个对象使用 equals() 方法比较返回相等，则它们的 hashCode() 值必须相等。</span><br><span class="line">	如果两个对象的 hashCode() 值相等，则它们不一定相等（即可能存在哈希冲突），因此需要再次使用 equals() 方法进行比较。</span><br><span class="line">通过遵循这些约定，可以保证在使用哈希数据结构或自定义对象作为键值对时不会出现问题。</span><br></pre></td></tr></table></figure>
<h4 id="13为什么在-java-的-hashmap-实现中数组的大小即容量必须始终保持为-2-的幂次方"><a class="markdownIt-Anchor" href="#13为什么在-java-的-hashmap-实现中数组的大小即容量必须始终保持为-2-的幂次方">#</a> 13. 为什么在 Java 的 HashMap 实现中，数组的大小（即容量）必须始终保持为 2 的幂次方？</h4>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">HashMap的长度必须保证是<span class="number">2</span>的幂次方，是为了避免出现HashMap为空或者HashMap中存储的元素个数不足<span class="number">2</span>的幂次方的情况。</span><br><span class="line"></span><br><span class="line">如果HashMap的长度不是<span class="number">2</span>的幂次方，可能会导致以下问题：</span><br><span class="line"></span><br><span class="line">	如果HashMap的长度为<span class="number">1</span>，那么它的哈希冲突解决方式只能是链地址法（即将冲突的键值对插入到链表中），这种方式不能处理哈希冲突。</span><br><span class="line">	如果HashMap的长度为<span class="number">0</span>，那么它的哈希冲突解决方式只能是开放地址法（即将冲突的键值对直接放在HashMap中），这种方式不能处理哈希冲突。</span><br><span class="line"></span><br><span class="line">因此，为了保证HashMap的正确性和性能，我们需要确保它的长度是<span class="number">2</span>的幂次方，或者为一个固定的最大值。如果需要动态地调整HashMap的长度，可以使用链表法或者开放地址法。</span><br></pre></td></tr></table></figure>
<h4 id="14为什么hashmaploadfactor的选值是34而不是24"><a class="markdownIt-Anchor" href="#14为什么hashmaploadfactor的选值是34而不是24">#</a> 14. 为什么 HashMap.loadFactor 的选值是 3/4，而不是 2/4?</h4>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">首先，当loadFactor的值比较小的时候，虽然能够减少空间的浪费，但是会导致哈希表更加频繁地进行扩容操作，这会影响到HashMap的性能。</span><br><span class="line">其次，当loadFactor的值比较大的时候，虽然能够减少扩容操作的次数，但是会导致哈希链表长度过长，查找效率会变得较低。</span><br><span class="line">因此，为了平衡空间利用率和时间效率，选择一个适当的loadFactor值非常重要。经过实验和分析，发现loadFactor取<span class="number">0.75</span>时，可以在保证哈希表查找效率的同时，稍微减少空间的浪费。另外，这个值也是比较常见的一个取值，很多编程语言中也采用了类似的值。</span><br></pre></td></tr></table></figure>
<h4 id="15hashmap什么时候会触发扩容机制如何扩容"><a class="markdownIt-Anchor" href="#15hashmap什么时候会触发扩容机制如何扩容">#</a> 15.HashMap 什么时候会触发扩容机制？如何扩容？</h4>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">HashMap在存储键值对时，会将键通过哈希函数映射到桶里面，每个桶是一个链表或红黑树。当HashMap中的元素数量增加到超过了负载因子（默认为0.75），就会触发扩容机制。</span><br><span class="line"></span><br><span class="line">具体地说，在添加元素时，如果当前的元素数量达到了阈值（即容量乘以负载因子），就会启动扩容机制。这个阈值通过如下公式计算：</span><br><span class="line"></span><br><span class="line">threshold = capacity * loadFactor</span><br><span class="line"></span><br><span class="line">其中capacity是当前HashMap的容量，loadFactor是负载因子，默认值为0.75。当HashMap中元素个数达到了threshold值时，就会触发扩容机制。</span><br><span class="line"></span><br><span class="line">扩容操作包括以下几个步骤：</span><br><span class="line"></span><br><span class="line">	1.创建一个新的Entry数组，长度为原数组的两倍。</span><br><span class="line">	2.将原来数组中所有的元素重新分配到新的数组中，这一步需要重新计算每个元素的hash值，并且根据新的数组长度求出它们在新数组中的位置。</span><br><span class="line">	3.在重新分配元素的过程中，如果某个位置上有多个元素，则会形成一个链表或红黑树，这取决于链表长度是否大于等于8，并且桶容量大于64。如果链表长度大于等于8并且桶容量大于64的话，则会将其转换为红黑树，否则仍然使用链表。这一步是为了提高查询效率，因为红黑树的查询时间复杂度是O(log n)，而链表的查询时间复杂度是O(n)。</span><br><span class="line">	4.更新HashMap的容量和阈值。</span><br><span class="line">	</span><br><span class="line">扩容操作会比较耗时，因为需要重新计算hash值、重新分配元素等，所以应该尽可能避免频繁触发扩容。可以通过调整负载因子的大小来控制HashMap的性能和空间占用</span><br></pre></td></tr></table></figure>
<h2 id="关于我"><a class="markdownIt-Anchor" href="#关于我">#</a> 关于我</h2>
<p>Brath 是一个热爱技术的 Java 程序猿，公众号「InterviewCoder」定期分享有趣有料的精品原创文章！</p>
<p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/%E4%BA%8C%E7%BB%B4%E7%A0%81plus.png" alt="InterviewCoder"></p>
<p>非常感谢各位人才能看到这里，原创不易，文章如果有帮助可以关注、点赞、分享或评论，这都是对我的莫大支持！</p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2023-05-05T01:57:09.000Z" title="2023-5-5 9:57:09">2023-05-05</time>发表</span><span class="level-item"><time dateTime="2023-05-05T02:04:28.525Z" title="2023-5-5 10:04:28">2023-05-05</time>更新</span><span class="level-item">14 分钟读完 (大约2151个字)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2023/05/05/%E3%80%90IDEA%E3%80%91IDEA%E7%9A%84debug%E8%B0%83%E8%AF%95%E6%8A%80%E5%B7%A7%E8%AF%A6%E8%A7%A3/">【IDEA】IDEA的debug调试技巧详解</a></p><div class="content"><p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/%E6%89%AB%E7%A0%81_%E6%90%9C%E7%B4%A2%E8%81%94%E5%90%88%E4%BC%A0%E6%92%AD%E6%A0%B7%E5%BC%8F-%E6%A0%87%E5%87%86%E8%89%B2%E7%89%88.png" alt="InterviewCoder"></p>
<h1 id="ideaidea的debug调试技巧详解转自csdn"><a class="markdownIt-Anchor" href="#ideaidea的debug调试技巧详解转自csdn">#</a> 【IDEA】IDEA 的 debug 调试技巧详解（转自 CSDN）</h1>
<p>目录</p>
<p><a href="#%E4%B8%80%E3%80%81%E6%A6%82%E8%BF%B0">一、概述</a></p>
<p><a href="#%E4%BA%8C%E3%80%81debug%E6%93%8D%E4%BD%9C%E5%88%86%E6%9E%90">二、debug 操作分析</a></p>
<p><a href="#1%E3%80%81%E6%89%93%E6%96%AD%E7%82%B9">1、打断点</a></p>
<p><a href="#2%E3%80%81%E8%BF%90%E8%A1%8Cdebug%E6%A8%A1%E5%BC%8F">2、运行 debug 模式</a></p>
<p><a href="#3%E3%80%81%E9%87%8D%E6%96%B0%E6%89%A7%E8%A1%8Cdebug">3、重新执行 debug</a></p>
<p><a href="#4%E3%80%81%E8%AE%A9%E7%A8%8B%E5%BA%8F%E6%89%A7%E8%A1%8C%E5%88%B0%E4%B8%8B%E4%B8%80%E6%AC%A1%E6%96%AD%E7%82%B9%E5%90%8E%E6%9A%82%E5%81%9C">4、让程序执行到下一次断点后暂停</a></p>
<p><a href="#5%E3%80%81%E8%AE%A9%E6%96%AD%E7%82%B9%E5%A4%84%E7%9A%84%E4%BB%A3%E7%A0%81%E5%86%8D%E5%8A%A0%E4%B8%80%E8%A1%8C%E4%BB%A3%E7%A0%81">5、让断点处的代码再加一行代码</a></p>
<p><a href="#6%E3%80%81%E5%81%9C%E6%AD%A2debug%E7%A8%8B%E5%BA%8F">6、停止 debug 程序</a></p>
<p><a href="#7%E3%80%81%E6%98%BE%E7%A4%BA%E6%89%80%E6%9C%89%E6%96%AD%E7%82%B9">7、显示所有断点</a></p>
<p><a href="#8%E3%80%81%E6%B7%BB%E5%8A%A0%E6%96%AD%E7%82%B9%E8%BF%90%E8%A1%8C%E7%9A%84%E6%9D%A1%E4%BB%B6">8、添加断点运行的条件</a></p>
<p><a href="#9%E3%80%81%E5%B1%8F%E8%94%BD%E6%89%80%E6%9C%89%E6%96%AD%E7%82%B9">9、屏蔽所有断点</a></p>
<p><a href="#10%E3%80%81%E6%8A%8A%E5%85%89%E6%A0%87%E7%A7%BB%E5%88%B0%E5%BD%93%E5%89%8D%E7%A8%8B%E5%BA%8F%E8%BF%90%E8%A1%8C%E4%BD%8D%E7%BD%AE">10、把光标移到当前程序运行位置</a></p>
<p><a href="#11%E3%80%81%E5%8D%95%E6%AD%A5%E8%B7%B3%E8%BF%87">11、单步跳过</a></p>
<p><a href="#12%E3%80%81%E5%8F%AF%E4%BB%A5%E8%B7%B3%E5%85%A5%E6%96%B9%E6%B3%95%E5%86%85%E9%83%A8%E7%9A%84%E6%89%A7%E8%A1%8C%E4%B8%80%E8%A1%8C%E4%BB%A3%E7%A0%81%E6%93%8D%E4%BD%9C">12、可以跳入方法内部的执行一行代码操作</a></p>
<p><a href="#13%E3%80%81%E8%B7%B3%E5%87%BA%E6%96%B9%E6%B3%95">13、跳出方法</a></p>
<p><a href="#14%E3%80%81%E7%9B%B4%E6%8E%A5%E6%89%A7%E8%A1%8C%E5%88%B0%E5%85%89%E6%A0%87%E6%89%80%E5%9C%A8%E4%BD%8D%E7%BD%AE">14、直接执行到光标所在位置</a></p>
<p><a href="#15%E3%80%81%E5%9C%A8%E6%8E%A7%E5%88%B6%E5%8F%B0%E6%94%B9%E5%8F%98%E6%AD%A3%E5%9C%A8debug%E7%9A%84%E6%95%B0%E6%8D%AE">15、在控制台改变正在 debug 的数据</a></p>
<hr>
<h1 id="一-概述"><a class="markdownIt-Anchor" href="#一-概述">#</a> 一、概述</h1>
<ul>
<li>debug 调试也叫断点调试</li>
<li>在程序的某一行打上断点，则在 debug 模式下运行到断点位置时会暂停，便于程序员观察代码的执行情况</li>
<li>学会 debug，有助于在程序运行未达到理想情况时，对程序的各个流程进行分析</li>
<li>本文只详细描述了 debug 的一些基本的常用操作，如果有缺漏欢迎评论区留言～</li>
</ul>
<h1 id="二-debug操作分析"><a class="markdownIt-Anchor" href="#二-debug操作分析">#</a> 二、debug 操作分析</h1>
<h2 id="1-打断点"><a class="markdownIt-Anchor" href="#1-打断点">#</a> 1、打断点</h2>
<ul>
<li>在程序的某一行位置，数字右边的空白部分使用鼠标左键点击一下，出现红点即为打上了一个断点</li>
</ul>
<img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/9e3026905fcd4c7a9a7b0dce93f324e9.png" width="422" height="362" />
<h2 id="2-运行debug模式"><a class="markdownIt-Anchor" href="#2-运行debug模式">#</a> 2、运行 debug 模式</h2>
<ul>
<li>方式一
<ul>
<li>选中要进行 debug 的程序，点击右上角的 debug 按钮</li>
</ul>
</li>
</ul>
<img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/f52559e407cf4dd9af9438fc616abca5.png" width="288" height="82" />
<ul>
<li>方式二
<ul>
<li>在要进行 debug 的程序处右键，选中下图选项</li>
</ul>
</li>
</ul>
<img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/a703e498d8dc4e91be40b3ba06a7a5be.png" width="386" height="449" />
<h2 id="3-重新执行debug"><a class="markdownIt-Anchor" href="#3-重新执行debug">#</a> 3、重新执行 debug</h2>
<ul>
<li>点击下图按钮，会关闭当前 debug 的程序并重新启动 debug</li>
</ul>
<img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/6a18ce960271427892dbc4a8df8e568d.png" width="832" height="308" />
<h2 id="4-让程序执行到下一次断点后暂停"><a class="markdownIt-Anchor" href="#4-让程序执行到下一次断点后暂停">#</a> 4、让程序执行到下一次断点后暂停</h2>
<ul>
<li>点击下图的按钮，debug 会继续运行程序，直到遇到下一次断点后暂停</li>
</ul>
<img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/5347586e6a414e7fbacc2863e4e7f44d.png" width="851" height="301" />
<ul>
<li>举例
<ul>
<li>下图是一个循环操作，在打断点的位置点击上面说的按钮，相当于再循环一次，到代码第 9 行时停止</li>
</ul>
</li>
</ul>
<img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/4653841c52c54a3183914354054609dd.png" width="818" height="336" />
<h2 id="5-让断点处的代码再加一行代码"><a class="markdownIt-Anchor" href="#5-让断点处的代码再加一行代码">#</a> 5、让断点处的代码再加一行代码</h2>
<ul>
<li>点击下图的加号，可以在断点处加一行代码，比如下图中的 count++ 即为新添加的代码
<ul>
<li>选中 count++，右键点击 Edit 可以编辑该代码</li>
<li>选中该行代码（count++），点击加号下面的减号，可以删除该行代码</li>
</ul>
</li>
</ul>
<img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/b7843e76b1b64b488e93c9cd8b6e72a6.png" width="865" height="266" />
<ul>
<li>选中下图的眼镜，变为分屏操作</li>
</ul>
<img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/ac95d9ee4ebb4c2c8e573e623e34f779.png" width="1200" height="324" />
<img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/18ec87566c3340689daa95295557fa12.png" width="1200" height="302" />
<hr>
<p><strong>举例</strong></p>
<ul>
<li>下图是没添加额外代码之前的截图</li>
</ul>
<img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/155c34d01574452f9924b608cb26a642.png" width="1163" height="567" />
<ul>
<li>添加一句 count++，并点击左边红色框中的按钮，执行到下一次断点，即循环了一次</li>
</ul>
<img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/33ebf61346304b9c9679c6f836ed99b7.png" width="1139" height="659" />
<ul>
<li>效果和运行步骤见下图</li>
</ul>
<img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/0994f7950ff1421ca6cf4116e1fafe23.png" width="1200" height="666" />
<h2 id="6-停止debug程序"><a class="markdownIt-Anchor" href="#6-停止debug程序">#</a> 6、停止 debug 程序</h2>
<ul>
<li>点击下图按钮停止 debug 程序</li>
<li>注意
<ul>
<li>运行的如果是 javaSE 项目，点一下就停止</li>
<li>运行的如果是 javaWeb 项目，需要点两下
<ul>
<li>第一下停止代码的当前线程</li>
<li>第二下停止服务器</li>
</ul>
</li>
</ul>
</li>
</ul>
<img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/7ce1d0c26f4a45ec9050155f0f653557.png" width="882" height="304" />
<h2 id="7-显示所有断点"><a class="markdownIt-Anchor" href="#7-显示所有断点">#</a> 7、显示所有断点</h2>
<ul>
<li>点击下图按钮，会显示所有断点</li>
</ul>
<img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/5651d84b51cf45d1bab9072c4c7d1ccc.png" width="830" height="272" />
<ul>
<li>点击后出现下图所示界面，可以添加断点运行的条件，见下一条功能解释</li>
</ul>
<img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/93a8e0b13c4d45e3a4adf260d9ca24b6.png" width="1108" height="670" />
<h2 id="8-添加断点运行的条件"><a class="markdownIt-Anchor" href="#8-添加断点运行的条件">#</a> 8、添加断点运行的条件</h2>
<ul>
<li>选中断点，右键后即可编辑断点运行的条件
<ul>
<li>满足条件时程序才会在该断点处停下</li>
</ul>
</li>
</ul>
<img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/e6b57eeaa0294cdf9364c2b0f6a6cb25.png" width="1006" height="513" />
<ul>
<li>比如添加 i&gt;=5，重新 debug 后的效果如下图所示</li>
</ul>
<img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/82a7ffe03cd54958a8801e21eceb704a.png" width="918" height="645" />
<ul>
<li>此时会发现第 7 条显示所有断点信息处，可以看到下图效果</li>
</ul>
<img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/daab0ee1bfe94a329aa68db1c95f2080.png" width="1022" height="281" />
<h2 id="9-屏蔽所有断点"><a class="markdownIt-Anchor" href="#9-屏蔽所有断点">#</a> 9、屏蔽所有断点</h2>
<ul>
<li>点击下图按钮，可以屏蔽所有断点</li>
</ul>
<img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/f7e06ed221044991be85af4fca6748f9.png" width="583" height="361" />
<ul>
<li>屏蔽前<br>
<img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/677a8547e65844eebac684de9f46bc71.png" width="102" height="73" /></li>
<li>屏蔽后<br>
<img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/46bb93d283a640df802eec5d8fd1bbab.png" width="81" height="56" /></li>
<li>屏蔽的断点在 debug 的时候不会运行
<ul>
<li>如果程序调试后觉得没问题了，可以屏蔽掉所有断点继续运行程序查看效果</li>
</ul>
</li>
</ul>
<h2 id="10-把光标移到当前程序运行位置"><a class="markdownIt-Anchor" href="#10-把光标移到当前程序运行位置">#</a> 10、把光标移到当前程序运行位置</h2>
<ul>
<li>点击下图按钮后，会把鼠标光标移动到当前程序运行位置
<ul>
<li>当程序代码量很大的时候，可以通过该按钮快速定位到程序运行位置</li>
</ul>
</li>
</ul>
<img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/a44a214ccd894d52884cd8cd20e9665c.png" width="617" height="245" />
<ul>
<li>如下图所示
<ul>
<li>假设程序运行到第 9 行断点处，鼠标光标在第 11 行，点击该按钮后光标就会移动到第 9 行</li>
</ul>
</li>
</ul>
<img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/15566342c22e47b390f7922e06c080e9.png" width="648" height="129" />
<h2 id="11-单步跳过"><a class="markdownIt-Anchor" href="#11-单步跳过">#</a> 11、单步跳过</h2>
<ul>
<li>点击下图按钮，会一行一行执行自己编写的代码
<ul>
<li>如果碰到方法，该按钮不会进入到该方法内部</li>
<li>快捷键 F8</li>
</ul>
</li>
</ul>
<img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/1c54b8240f6e4d719f8aae936a925fb2.png" width="544" height="201" />
<h2 id="12-可以跳入方法内部的执行一行代码操作"><a class="markdownIt-Anchor" href="#12-可以跳入方法内部的执行一行代码操作">#</a> 12、可以跳入方法内部的执行一行代码操作</h2>
<ul>
<li>下图中的蓝色箭头和红色箭头都可以执行一行代码，如果遇到方法时会进入方法内部，区别在于
<ul>
<li>蓝色箭头只会跳进自己写的方法，如果是系统已经写好的方法，蓝色箭头无法跳入该方法</li>
<li>红色箭头不管是自己写的方法，还是系统已经定义好的方法，都可以跳入方法内部</li>
</ul>
</li>
</ul>
<img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/23a065624b024b29ba358d96c1e827eb.png" width="852" height="271" />
<ul>
<li>如下图所示
<ul>
<li>ArrayList 的 add 方法是系统已经写好的，蓝色箭头无法跳入方法内部，但是红色箭头可以跳入方法内部</li>
<li>printMessage（）是自定义方法，红色和蓝色箭头都可以跳入该方法内部</li>
</ul>
</li>
</ul>
<img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/f24471618ac74e69842c047606635c13.png" width="811" height="762" />
<h2 id="13-跳出方法"><a class="markdownIt-Anchor" href="#13-跳出方法">#</a> 13、跳出方法</h2>
<ul>
<li>下图的两个按钮都可以跳出方法
<ul>
<li>第二个按钮是关闭窗口的意思，同样可以起到跳出方法的作用</li>
<li>在进入方法内部的时候使用这两个按钮</li>
</ul>
</li>
</ul>
<img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/0deedd480bd94b0f9d93aab8bc5d33d1.png" width="514" height="238" />
<h2 id="14-直接执行到光标所在位置"><a class="markdownIt-Anchor" href="#14-直接执行到光标所在位置">#</a> 14、直接执行到光标所在位置</h2>
<ul>
<li>点击下图的按钮，程序会执行到光标所在的位置
<ul>
<li>前提是光标前面没有断点，否则程序还是会在光标前面的断点处暂停</li>
</ul>
</li>
</ul>
<img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/75d500280cad4a7497a31bb49c1a73a4.png" width="616" height="247" />
<h2 id="15-在控制台改变正在debug的数据"><a class="markdownIt-Anchor" href="#15-在控制台改变正在debug的数据">#</a> 15、在控制台改变正在 debug 的数据</h2>
<ul>
<li>在控制台选中某个变量，右键点击 Set Value 可以改变该变量的值
<ul>
<li>如果想测试某个地方的数据如果是正确的会是什么效果，可以手动更改该处变量的值</li>
</ul>
</li>
</ul>
<img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/9fcd3a72eebf47a9be694fabec9549cd.png" width="1003" height="304" />
<p>补充：debug 调试看代码时，一般用 F9 跳到下一个断点，打断点的目的是你想看程序执行到这个位置时会有什么效果，或者是到达断点的位置后再继续往下看实现的过程；用 F7 去跳进方法内部，看具体的实现细节；用 F8 去看当前位置代码往下的执行情况（不跳入具体方法的内部）</p>
<h4 id="原文链接httpsblogcsdnnetfuture_god_qrarticledetails121250865"><a class="markdownIt-Anchor" href="#原文链接httpsblogcsdnnetfuture_god_qrarticledetails121250865">#</a> 原文链接：<a target="_blank" rel="noopener" href="https://blog.csdn.net/future_god_qr/article/details/121250865">https://blog.csdn.net/future_god_qr/article/details/121250865</a></h4>
<h2 id="关于我"><a class="markdownIt-Anchor" href="#关于我">#</a> 关于我</h2>
<p>Brath 是一个热爱技术的 Java 程序猿，公众号「InterviewCoder」定期分享有趣有料的精品原创文章！</p>
<p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/%E4%BA%8C%E7%BB%B4%E7%A0%81plus.png" alt="InterviewCoder"></p>
<p>非常感谢各位人才能看到这里，原创不易，文章如果有帮助可以关注、点赞、分享或评论，这都是对我的莫大支持！</p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2023-05-05T01:57:09.000Z" title="2023-5-5 9:57:09">2023-05-05</time>发表</span><span class="level-item"><time dateTime="2023-05-05T02:03:30.951Z" title="2023-5-5 10:03:30">2023-05-05</time>更新</span><span class="level-item">11 分钟读完 (大约1580个字)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2023/05/05/%E3%80%90%E6%96%87%E5%BF%83%E4%B8%80%E8%A8%80%E3%80%91%E7%99%BE%E5%BA%A6%E6%96%87%E5%BF%83%E4%B8%80%E8%A8%80%E5%A4%A7%E5%9E%8B%E8%AF%AD%E8%A8%80%E6%A8%A1%E5%9E%8B%E6%8E%A5%E5%85%A5%E6%95%99%E7%A8%8B/">【文心一言】百度文心一言大型语言模型接入教程</a></p><div class="content"><p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/%E6%89%AB%E7%A0%81_%E6%90%9C%E7%B4%A2%E8%81%94%E5%90%88%E4%BC%A0%E6%92%AD%E6%A0%B7%E5%BC%8F-%E6%A0%87%E5%87%86%E8%89%B2%E7%89%88.png" alt="InterviewCoder"></p>
<h1 id="文心一言百度文心一言大型语言模型接入教程"><a class="markdownIt-Anchor" href="#文心一言百度文心一言大型语言模型接入教程">#</a> 【文心一言】百度文心一言大型语言模型接入教程</h1>
<h5 id="文心一言是百度的智能对话产品它可以与用户进行流畅-自然-有趣的多轮对话涵盖了生活-娱乐-教育-商务等多个领域和场景-文心一言不仅可以作为一个独立的应用供用户使用也可以通过百度智能云的api调用接口为各行各业的企业客户提供强大而灵活的ai能力赋能更多行业伙伴"><a class="markdownIt-Anchor" href="#文心一言是百度的智能对话产品它可以与用户进行流畅-自然-有趣的多轮对话涵盖了生活-娱乐-教育-商务等多个领域和场景-文心一言不仅可以作为一个独立的应用供用户使用也可以通过百度智能云的api调用接口为各行各业的企业客户提供强大而灵活的ai能力赋能更多行业伙伴">#</a> 文心一言是百度的智能对话产品，它可以与用户进行流畅、自然、有趣的多轮对话，涵盖了生活、娱乐、教育、商务等多个领域和场景。文心一言不仅可以作为一个独立的应用供用户使用，也可以通过百度智能云的 API 调用接口，为各行各业的企业客户提供强大而灵活的 AI 能力，赋能更多行业伙伴。</h5>
<h5 id="那么作为一个企业客户如何接入文心一言呢本文将为您介绍百度智能云提供的全面的ai解决方案帮助您快速实现与文心一言的对接和集成"><a class="markdownIt-Anchor" href="#那么作为一个企业客户如何接入文心一言呢本文将为您介绍百度智能云提供的全面的ai解决方案帮助您快速实现与文心一言的对接和集成">#</a> 那么，作为一个企业客户，如何接入文心一言呢？本文将为您介绍百度智能云提供的全面的 AI 解决方案，帮助您快速实现与文心一言的对接和集成。</h5>
<h2 id="01第一步注册百度智能云账号"><a class="markdownIt-Anchor" href="#01第一步注册百度智能云账号">#</a> <strong>01</strong> 第一步：注册百度智能云账号</h2>
<p>要使用百度智能云提供的服务和产品，您首先需要注册一个百度智能云账号。您可以通过以下方式进行注册：</p>
<ul>
<li>访问百度智能云官网 (<a target="_blank" rel="noopener" href="https://cloud.baidu.com/">https://cloud.baidu.com/</a>)，点击右上角 “免费注册” 按钮。</li>
<li>输入您的手机号码，并获取验证码。</li>
<li>设置您的登录密码，并同意服务协议。</li>
<li>完成实名认证，并选择账号类型 (个人或企业)。</li>
<li>完成以上步骤后，您就成功注册了一个百度智能云账号。</li>
</ul>
<h2 id="02第二步申请文心一言api调用权限"><a class="markdownIt-Anchor" href="#02第二步申请文心一言api调用权限">#</a> <strong>02</strong> 第二步：申请文心一言 API 调用权限</h2>
<p>​		要使用文心一言 API 调用接口，您需要申请相应的权限。您可以通过以下方式进行申请：</p>
<ul>
<li><strong>登录百度智能云控制台 (<a target="_blank" rel="noopener" href="https://console.bce.baidu.com/">https://console.bce.baidu.com/</a>)，点击左侧导航栏 “人工智能” 下拉菜单中的 “自然语言处理” 选项。</strong></li>
<li><strong>在自然语言处理页面中，找到 “文心一言” 产品，并点击 “立即使用” 按钮。</strong></li>
<li><strong>在弹出窗口中填写相关信息，并提交申请。</strong></li>
<li><strong>等待审核结果。审核通过后，您就可以在控制台中查看并管理您的文心一言 API 调用权限。</strong></li>
</ul>
<h2 id="03第三步配置并测试文心一言api调用接口"><a class="markdownIt-Anchor" href="#03第三步配置并测试文心一言api调用接口">#</a> <strong>03</strong> 第三步：配置并测试文心一言 API 调用接口</h2>
<p>​		进入：<a target="_blank" rel="noopener" href="https://wenxin.baidu.com/user/key">https://wenxin.baidu.com/user/key</a></p>
<p>​		使用文心一言 API 调用接口，您需要配置相关参数，并进行测试。您可以通过以下方式进行配置和测试：</p>
<ul>
<li>在控制台中进入 “自然语言处理” 页面，并点击 “文心一言” 产品下方的 “管理” 按钮，进入文心一言 API 调用接口的配置页面。</li>
<li>在配置页面中，您可以查看并修改您的文心一言 API 调用接口的基本信息，如应用名称、应用描述、应用类型等。</li>
<li>您还可以在配置页面中设置您的文心一言 API 调用接口的安全认证方式，如 Access Key ID 和 Secret Access Key。这些是您调用文心一言 API 时需要提供的身份凭证，建议您妥善保管，并定期更换。</li>
<li>您还可以在配置页面中设置您的文心一言 API 调用接口的配额和限流策略，如每日请求次数、每秒请求次数等。这些是为了保障您和其他用户的服务质量和安全性，建议您根据自己的业务需求合理分配，并避免超出限制。</li>
<li>在完成以上配置后，您就可以在配置页面中点击 “在线测试” 按钮，进行文心一言 API 调用接口的测试。测试时，您需要输入一个对话语句，并选择一个对话领域和场景。然后点击 “发送” 按钮，即可查看文心一言 API 返回的对话回复。</li>
</ul>
<h2 id="04第四步集成并使用文心一言api调用接口"><a class="markdownIt-Anchor" href="#04第四步集成并使用文心一言api调用接口">#</a> <strong>04</strong> 第四步：集成并使用文心一言 API 调用接口</h2>
<p>​		要集成并使用文心一言 API 调用接口，您需要根据自己的开发环境和语言选择合适的 SDK 或工具，并编写相应的代码。百度智能云提供了多种语言和平台支持的 SDK 或工具，如 Java、Python、PHP、Node.js、Android、iOS 等。您可以通过以下方式进行集成和使用：</p>
<ul>
<li>在控制台中进入 “自然语言处理” 页面，并点击 “文心一言” 产品下方的 “文档” 按钮，进入文心一言 API 调用接口的文档页面。</li>
<li>在文档页面中，您可以查看并下载您所需要的 SDK 或工具，并参考相关的示例代码和说明进行集成和使用。</li>
<li>在完成集成和使用后，您就可以在您的应用中调用文心一言 API，实现与用户的智能对话功能。</li>
</ul>
<h1 id="结语"><a class="markdownIt-Anchor" href="#结语">#</a> 结语：</h1>
<p>​		文心一言是百度智能云推出的一款基于大规模自然语言生成模型 (ChatGPT) 的智能对话产品，它可以与用户进行流畅、自然、有趣的多轮对话，涵盖了生活、娱乐、教育、商务等多个领域和场景。本文介绍了作为一个企业客户，如何通过百度智能云提供的全面的 AI 解决方案，快速实现与文心一言的对接和集成。</p>
<h2 id="关于我"><a class="markdownIt-Anchor" href="#关于我">#</a> 关于我</h2>
<p>Brath 是一个热爱技术的 Java 程序猿，公众号「InterviewCoder」定期分享有趣有料的精品原创文章！</p>
<p><img src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/%E4%BA%8C%E7%BB%B4%E7%A0%81plus.png" alt="InterviewCoder"></p>
<p>非常感谢各位人才能看到这里，原创不易，文章如果有帮助可以关注、点赞、分享或评论，这都是对我的莫大支持！</p>
</div></article></div><nav class="pagination" role="navigation" aria-label="pagination"><div class="pagination-previous is-invisible is-hidden-mobile"><a href="/page/0/">上一页</a></div><div class="pagination-next"><a href="/page/2/">下一页</a></div><ul class="pagination-list is-hidden-mobile"><li><a class="pagination-link is-current" href="/">1</a></li><li><a class="pagination-link" href="/page/2/">2</a></li><li><span class="pagination-ellipsis">&hellip;</span></li><li><a class="pagination-link" href="/page/15/">15</a></li></ul></nav></div><div class="column column-left is-4-tablet is-4-desktop is-3-widescreen  order-1"><!--!--><div class="card widget" data-type="recent-posts"><div class="card-content"><h3 class="menu-label">最新文章</h3><article class="media"><div class="media-content"><p class="date"><time dateTime="2023-06-06T00:13:41.000Z">2023-06-06</time></p><p class="title"><a href="/2023/06/06/%E3%80%90%E5%85%AC%E4%BC%97%E5%8F%B7%E5%BC%80%E5%8F%91%E3%80%91%E5%85%AC%E4%BC%97%E5%8F%B7%E6%8A%80%E6%9C%AF%E5%88%86%E4%BA%AB%E7%AC%AC%E4%BA%8C%E6%9C%9F-%E5%85%AC%E4%BC%97%E5%8F%B7%E6%A8%A1%E6%9D%BF%E6%B6%88%E6%81%AF-%E6%A8%A1%E6%9D%BF%E6%A8%A1%E5%BC%8F%E5%AE%9E%E6%88%98%E5%88%86%E4%BA%AB/">【公众号开发】公众号技术分享第二期-公众号模板消息-模板模式实战分享</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2023-06-06T00:10:41.000Z">2023-06-06</time></p><p class="title"><a href="/2023/06/06/%E3%80%90%E5%85%AC%E4%BC%97%E5%8F%B7%E5%BC%80%E5%8F%91%E3%80%91%E5%85%AC%E4%BC%97%E5%8F%B7%E6%8A%80%E6%9C%AF%E5%88%86%E4%BA%AB%E7%AC%AC%E4%B8%80%E6%9C%9F-%E5%A6%82%E4%BD%95%E6%B3%A8%E5%86%8C%E5%BE%AE%E4%BF%A1%E5%85%AC%E4%BC%97%E5%B9%B3%E5%8F%B0%E5%B9%B6%E4%BD%BF%E7%94%A8%E5%85%AC%E4%BC%97%E5%8F%B7%E6%A8%A1%E6%9D%BF%E6%B6%88%E6%81%AF/">【公众号开发】公众号技术分享第一期-如何注册微信公众平台并使用公众号模板消息</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2023-06-05T17:10:41.000Z">2023-06-06</time></p><p class="title"><a href="/2023/06/06/%E3%80%90Sentinel%E3%80%91Docker%E6%90%AD%E5%BB%BASentinel/">【Sentinel】Docker搭建Sentinel</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2023-06-05T07:25:21.000Z">2023-06-05</time></p><p class="title"><a href="/2023/06/05/%E3%80%90Git%E3%80%91Github%E6%8F%90%E4%BA%A4%E4%BB%A3%E7%A0%81%E9%81%87%E5%88%B0%E9%94%99%E8%AF%AF%EF%BC%9AERROR%20You%E2%80%98re%20using%20an%20RSA%20key%20with%20SHA-1,%20which%20is%20no%20longer%20allowed/">【Git】Github提交代码遇到错误：ERROR You‘re using an RSA key with SHA-1, which is no longer allowed</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2023-05-23T02:04:23.000Z">2023-05-23</time></p><p class="title"><a href="/2023/05/23/%E3%80%90Linux%E3%80%91%E9%98%BF%E9%87%8C%E4%BA%91linux%20%E6%8C%82%E8%BD%BD%E6%95%B0%E6%8D%AE%E7%9B%98%E5%B9%B6docker%E5%B7%A5%E4%BD%9C%E7%9B%AE%E5%BD%95%E8%BF%81%E7%A7%BB%E5%88%B0%E6%95%B0%E6%8D%AE%E7%9B%98/">【Linux】阿里云linux 挂载数据盘并docker工作目录迁移到数据盘</a></p></div></article></div></div><div class="card widget" data-type="archives"><div class="card-content"><div class="menu"><h3 class="menu-label">归档</h3><ul class="menu-list"><li><a class="level is-mobile" href="/archives/2023/"><span class="level-start"><span class="level-item">2023</span></span><span class="level-end"><span class="level-item tag">40</span></span></a></li><li><a class="level is-mobile" href="/archives/2022/"><span class="level-start"><span class="level-item">2022</span></span><span class="level-end"><span class="level-item tag">61</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/"><span class="level-start"><span class="level-item">2021</span></span><span class="level-end"><span class="level-item tag">43</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/"><span class="level-start"><span class="level-item">2020</span></span><span class="level-end"><span class="level-item tag">5</span></span></a></li></ul></div></div></div><!--!--><div class="card widget" data-type="profile"><div class="card-content"><nav class="level"><div class="level-item has-text-centered flex-shrink-1"><div><figure class="image is-128x128 mx-auto mb-2"><img class="avatar" src="https://brath4.oss-cn-shenzhen.aliyuncs.com/picgo/%E4%BA%8C%E7%BB%B4%E7%A0%81plus.png" alt="InterviewCoder"></figure><p class="title is-size-4 is-block" style="line-height:inherit;">InterviewCoder</p><p class="is-size-6 is-block">面试记官方公众号</p></div></div></nav><nav class="level is-mobile"><div class="level-item has-text-centered is-marginless"><div><p class="heading">文章</p><a href="/archives"><p class="title">149</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">分类</p><a href="/categories"><p class="title">0</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">标签</p><a href="/tags"><p class="title">0</p></a></div></div></nav><div class="level"><a class="level-item button is-primary is-rounded" href="https://mp.weixin.qq.com/s/jWs6lLHl5L-atXJhHc4YvA" target="_blank" rel="noopener">关注我</a></div></div></div><div class="column-right-shadow is-hidden-widescreen"></div></div><div class="column column-right is-4-tablet is-4-desktop is-3-widescreen is-hidden-touch is-hidden-desktop-only order-3"><div class="card widget" data-type="profile"><div class="card-content"><nav class="level"><div class="level-item has-text-centered flex-shrink-1"><div><figure class="image is-128x128 mx-auto mb-2"><img class="avatar is-rounded" src="https://brath.cloud/me.png" alt="Brath"></figure><p class="title is-size-4 is-block" style="line-height:inherit;">Brath</p><p class="is-size-6 is-block">技能改变人生，知识改变命运。</p><p class="is-size-6 is-flex justify-content-center"><i class="fas fa-map-marker-alt mr-1"></i><span>中国·江苏·无锡</span></p></div></div></nav><nav class="level is-mobile"><div class="level-item has-text-centered is-marginless"><div><p class="heading">文章</p><a href="/archives"><p class="title">149</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">分类</p><a href="/categories"><p class="title">0</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">标签</p><a href="/tags"><p class="title">0</p></a></div></div></nav><div class="level"><a class="level-item button is-primary is-rounded" href="https://github.com/Guoqing815" target="_blank" rel="noopener">关注我</a></div><div class="level is-mobile is-multiline"><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Github" href="https://github.com/Guoqing815"><i class="fab fa-github"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Gitee" href="https://gitee.com/Guoqing-Li"><i class="fab fa-gitee"></i></a></div></div></div><!--!--><div class="card widget" data-type="links"><div class="card-content"><div class="menu"><h3 class="menu-label">链接</h3><ul class="menu-list"><li><a class="level is-mobile" href="https://schokolade.cn/" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">泠灵(特别呜谢)</span></span><span class="level-right"><span class="level-item tag">schokolade.cn</span></span></a></li><li><a class="level is-mobile" href="https://gitee.com/Guoqing-Li" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">Gitee(码云)</span></span><span class="level-right"><span class="level-item tag">gitee.com</span></span></a></li><li><a class="level is-mobile" href="https://blog.csdn.net/Brath?type=blog" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">CSDN</span></span><span class="level-right"><span class="level-item tag">blog.csdn.net</span></span></a></li><li><a class="level is-mobile" href="https://juejin.cn/user/settings/profile" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">掘金</span></span><span class="level-right"><span class="level-item tag">juejin.cn</span></span></a></li><li><a class="level is-mobile" href="https://oss.console.aliyun.com/" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">AliCloud(阿里云)</span></span><span class="level-right"><span class="level-item tag">oss.console.aliyun.com</span></span></a></li><li><a class="level is-mobile" href="https://cloud.tencent.com/" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">TencentCloud(腾讯云)</span></span><span class="level-right"><span class="level-item tag">cloud.tencent.com</span></span></a></li><li><a class="level is-mobile" href="https://www.zhipin.com/web/user/" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">BOSS</span></span><span class="level-right"><span class="level-item tag">www.zhipin.com</span></span></a></li><li><a class="level is-mobile" href="https://www.bilibili.com/" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">Bilibili(B站)</span></span><span class="level-right"><span class="level-item tag">www.bilibili.com</span></span></a></li></ul></div></div></div></div></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/"><img src="https://brath.cloud/avatar.png" alt="Brath-Blog" height="28"></a><p class="is-size-7"><span>&copy; 2023 Brath</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a><br><span id="busuanzi_container_site_uv">共<span id="busuanzi_value_site_uv">0</span>个访客</span></p><p class="is-size-7">© 2029</p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Attribution 4.0 International" href="https://creativecommons.org/licenses/by/4.0/"><i class="fab fa-creative-commons-by"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/ppoffice/hexo-theme-icarus"><i class="fab fa-github"></i></a></p></div></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script><script>moment.locale("zh-cn");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="/js/column.js"></script><script src="/js/animation.js"></script><a id="back-to-top" title="回到顶端" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><!--!--><!--!--><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.js" defer></script><script>window.addEventListener("load", () => {
      window.cookieconsent.initialise({
        type: "info",
        theme: "edgeless",
        static: false,
        position: "bottom-left",
        content: {
          message: "此网站使用Cookie来改善您的体验。",
          dismiss: "知道了！",
          allow: "允许使用Cookie",
          deny: "拒绝",
          link: "了解更多",
          policy: "Cookie政策",
          href: "https://www.cookiesandyou.com/",
        },
        palette: {
          popup: {
            background: "#edeff5",
            text: "#838391"
          },
          button: {
            background: "#4b81e8"
          },
        },
      });
    });</script><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><!--!--><!--!--><!--!--><script src="/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="想要查找什么..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"想要查找什么...","untitled":"(无标题)","posts":"文章","pages":"页面","categories":"分类","tags":"标签"});
        });</script></body></html>